diff --git a/Makefile b/Makefile
index 57ada02..c444554 100644
--- a/Makefile
+++ b/Makefile
@@ -1,68 +1,644 @@
+# Makefile.in generated by automake 1.10.1 from Makefile.am.
+# Makefile.  Generated from Makefile.in by configure.
 
-DESTDIR = /usr/local/xrdp
-CFGDIR = /etc/xrdp
-PIDDIR = /var/run
-MANDIR = /usr/local/man
-DOCDIR = /usr/doc/xrdp
-
-all: world
-
-world: base
-	make -C sesman
-
-base:
-	make -C vnc
-	make -C libxrdp
-	make -C xrdp
-	make -C rdp
-	make -C xup
-
-nopam: base
-	make -C sesman nopam
-	make -C sesman tools
-
-kerberos: base
-	make -C sesman kerberos
-	make -C sesman tools
-
-clean:
-	make -C vnc clean
-	make -C libxrdp clean
-	make -C xrdp clean
-	make -C rdp clean
-	make -C sesman clean
-	make -C xup clean
-
-install:
-	mkdir -p $(DESTDIR)
-	mkdir -p $(CFGDIR)
-	mkdir -p $(PIDDIR)
-	mkdir -p $(MANDIR)
-	mkdir -p $(DOCDIR)
-	make -C vnc install
-	make -C libxrdp install
-	make -C xrdp install
-	make -C rdp install
-	make -C sesman install
-	make -C xup install
-	make -C docs install
-	if [ -d /etc/pam.d ]; then install instfiles/pam.d/sesman /etc/pam.d/sesman; fi
-	install instfiles/xrdp_control.sh $(DESTDIR)/xrdp_control.sh
-
-installdeb:
-	mkdir -p $(DESTDIRDEB)/usr/lib/xrdp
-	mkdir -p $(DESTDIRDEB)/etc/xrdp
-	mkdir -p $(DESTDIRDEB)/etc/pam.d
-	mkdir -p $(DESTDIRDEB)/etc/init.d
-	mkdir -p $(DESTDIRDEB)/usr/man
-	mkdir -p $(DESTDIRDEB)/usr/man/man5
-	mkdir -p $(DESTDIRDEB)/usr/man/man8
-	make -C vnc installdeb DESTDIRDEB=$(DESTDIRDEB)
-	make -C libxrdp installdeb DESTDIRDEB=$(DESTDIRDEB)
-	make -C xrdp installdeb DESTDIRDEB=$(DESTDIRDEB)
-	make -C rdp installdeb DESTDIRDEB=$(DESTDIRDEB)
-	make -C sesman installdeb DESTDIRDEB=$(DESTDIRDEB)
-	make -C xup installdeb DESTDIRDEB=$(DESTDIRDEB)
-	make -C docs installdeb DESTDIRDEB=$(DESTDIRDEB)
-	install instfiles/pam.d/sesman $(DESTDIRDEB)/etc/pam.d/sesman
-	install instfiles/xrdp_control1.sh $(DESTDIRDEB)/etc/init.d/xrdp_control.sh
+# Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
+# 2003, 2004, 2005, 2006, 2007, 2008  Free Software Foundation, Inc.
+# This Makefile.in is free software; the Free Software Foundation
+# gives unlimited permission to copy and/or distribute it,
+# with or without modifications, as long as this notice is preserved.
+
+# This program is distributed in the hope that it will be useful,
+# but WITHOUT ANY WARRANTY, to the extent permitted by law; without
+# even the implied warranty of MERCHANTABILITY or FITNESS FOR A
+# PARTICULAR PURPOSE.
+
+
+
+pkgdatadir = $(datadir)/xrdp
+pkglibdir = $(libdir)/xrdp
+pkgincludedir = $(includedir)/xrdp
+am__cd = CDPATH="$${ZSH_VERSION+.}$(PATH_SEPARATOR)" && cd
+install_sh_DATA = $(install_sh) -c -m 644
+install_sh_PROGRAM = $(install_sh) -c
+install_sh_SCRIPT = $(install_sh) -c
+INSTALL_HEADER = $(INSTALL_DATA)
+transform = $(program_transform_name)
+NORMAL_INSTALL = :
+PRE_INSTALL = :
+POST_INSTALL = :
+NORMAL_UNINSTALL = :
+PRE_UNINSTALL = :
+POST_UNINSTALL = :
+build_triplet = i686-suse-linux-gnu
+host_triplet = i686-suse-linux-gnu
+subdir = .
+DIST_COMMON = $(am__configure_deps) $(srcdir)/Makefile.am \
+	$(srcdir)/Makefile.in $(srcdir)/config_ac-h.in \
+	$(top_srcdir)/configure COPYING config.guess config.sub \
+	depcomp install-sh ltmain.sh missing
+ACLOCAL_M4 = $(top_srcdir)/aclocal.m4
+am__aclocal_m4_deps = $(top_srcdir)/configure.ac
+am__configure_deps = $(am__aclocal_m4_deps) $(CONFIGURE_DEPENDENCIES) \
+	$(ACLOCAL_M4)
+am__CONFIG_DISTCLEAN_FILES = config.status config.cache config.log \
+ configure.lineno config.status.lineno
+mkinstalldirs = $(install_sh) -d
+CONFIG_HEADER = config_ac.h
+CONFIG_CLEAN_FILES =
+SOURCES =
+DIST_SOURCES =
+RECURSIVE_TARGETS = all-recursive check-recursive dvi-recursive \
+	html-recursive info-recursive install-data-recursive \
+	install-dvi-recursive install-exec-recursive \
+	install-html-recursive install-info-recursive \
+	install-pdf-recursive install-ps-recursive install-recursive \
+	installcheck-recursive installdirs-recursive pdf-recursive \
+	ps-recursive uninstall-recursive
+RECURSIVE_CLEAN_TARGETS = mostlyclean-recursive clean-recursive	\
+  distclean-recursive maintainer-clean-recursive
+ETAGS = etags
+CTAGS = ctags
+DIST_SUBDIRS = $(SUBDIRS)
+DISTFILES = $(DIST_COMMON) $(DIST_SOURCES) $(TEXINFOS) $(EXTRA_DIST)
+distdir = $(PACKAGE)-$(VERSION)
+top_distdir = $(distdir)
+am__remove_distdir = \
+  { test ! -d $(distdir) \
+    || { find $(distdir) -type d ! -perm -200 -exec chmod u+w {} ';' \
+         && rm -fr $(distdir); }; }
+DIST_ARCHIVES = $(distdir).tar.gz
+GZIP_ENV = --best
+distuninstallcheck_listfiles = find . -type f -print
+distcleancheck_listfiles = find . -type f -print
+ACLOCAL = ${SHELL} /home/david/git/xrdp/missing --run aclocal-1.10
+AMTAR = ${SHELL} /home/david/git/xrdp/missing --run tar
+AR = ar
+AUTOCONF = ${SHELL} /home/david/git/xrdp/missing --run autoconf
+AUTOHEADER = ${SHELL} /home/david/git/xrdp/missing --run autoheader
+AUTOMAKE = ${SHELL} /home/david/git/xrdp/missing --run automake-1.10
+AWK = gawk
+CC = gcc
+CCDEPMODE = depmode=gcc3
+CFLAGS = -g -O2
+CPP = gcc -E
+CPPFLAGS = 
+CXX = g++
+CXXCPP = g++ -E
+CXXDEPMODE = depmode=gcc3
+CXXFLAGS = -g -O2
+CYGPATH_W = echo
+DEFS = -DHAVE_CONFIG_H
+DEPDIR = .deps
+DSYMUTIL = 
+ECHO = echo
+ECHO_C = 
+ECHO_N = -n
+ECHO_T = 
+EGREP = /usr/bin/grep -E
+EXEEXT = 
+F77 = 
+FFLAGS = 
+GREP = /usr/bin/grep
+INSTALL = /usr/bin/install -c
+INSTALL_DATA = ${INSTALL} -m 644
+INSTALL_PROGRAM = ${INSTALL}
+INSTALL_SCRIPT = ${INSTALL}
+INSTALL_STRIP_PROGRAM = $(install_sh) -c -s
+LDFLAGS = 
+LIBOBJS = 
+LIBS = 
+LIBTOOL = $(SHELL) $(top_builddir)/libtool
+LN_S = ln -s
+LTLIBOBJS = 
+MAKEINFO = ${SHELL} /home/david/git/xrdp/missing --run makeinfo
+MKDIR_P = /bin/mkdir -p
+NMEDIT = 
+OBJEXT = o
+PACKAGE = xrdp
+PACKAGE_BUGREPORT = xrdp-devel@lists.sourceforge.net
+PACKAGE_NAME = xrdp
+PACKAGE_STRING = xrdp 0.5.0
+PACKAGE_TARNAME = xrdp
+PACKAGE_VERSION = 0.5.0
+PATH_SEPARATOR = :
+RANLIB = ranlib
+SED = /usr/bin/sed
+SET_MAKE = 
+SHELL = /bin/sh
+STRIP = strip
+VERSION = 0.5.0
+abs_builddir = /home/david/git/xrdp
+abs_srcdir = /home/david/git/xrdp
+abs_top_builddir = /home/david/git/xrdp
+abs_top_srcdir = /home/david/git/xrdp
+ac_ct_CC = gcc
+ac_ct_CXX = g++
+ac_ct_F77 = 
+am__include = include
+am__leading_dot = .
+am__quote = 
+am__tar = ${AMTAR} chof - "$$tardir"
+am__untar = ${AMTAR} xf -
+bindir = ${exec_prefix}/bin
+build = i686-suse-linux-gnu
+build_alias = 
+build_cpu = i686
+build_os = linux-gnu
+build_vendor = suse
+builddir = .
+datadir = ${datarootdir}
+datarootdir = ${prefix}/share
+docdir = ${datarootdir}/doc/${PACKAGE_TARNAME}
+dvidir = ${docdir}
+exec_prefix = ${prefix}
+host = i686-suse-linux-gnu
+host_alias = 
+host_cpu = i686
+host_os = linux-gnu
+host_vendor = suse
+htmldir = ${docdir}
+includedir = ${prefix}/include
+infodir = ${datarootdir}/info
+install_sh = $(SHELL) /home/david/git/xrdp/install-sh
+libdir = ${exec_prefix}/lib/xrdp/
+libexecdir = ${exec_prefix}/libexec
+localedir = ${datarootdir}/locale
+localstatedir = ${prefix}/var
+mandir = ${datarootdir}/man
+mkdir_p = /bin/mkdir -p
+oldincludedir = /usr/include
+pdfdir = ${docdir}
+prefix = /usr
+program_transform_name = s,x,x,
+psdir = ${docdir}
+sbindir = ${exec_prefix}/sbin
+sharedstatedir = ${prefix}/com
+srcdir = .
+sysconfdir = ${prefix}/etc
+target_alias = 
+top_builddir = .
+top_srcdir = .
+SUBDIRS = \
+  common \
+  vnc \
+  rdp \
+  xup \
+  mc \
+  libxrdp \
+  xrdp \
+  sesman \
+  keygen \
+  docs \
+  instfiles
+
+all: config_ac.h
+	$(MAKE) $(AM_MAKEFLAGS) all-recursive
+
+.SUFFIXES:
+am--refresh:
+	@:
+$(srcdir)/Makefile.in:  $(srcdir)/Makefile.am  $(am__configure_deps)
+	@for dep in $?; do \
+	  case '$(am__configure_deps)' in \
+	    *$$dep*) \
+	      echo ' cd $(srcdir) && $(AUTOMAKE) --foreign '; \
+	      cd $(srcdir) && $(AUTOMAKE) --foreign  \
+		&& exit 0; \
+	      exit 1;; \
+	  esac; \
+	done; \
+	echo ' cd $(top_srcdir) && $(AUTOMAKE) --foreign  Makefile'; \
+	cd $(top_srcdir) && \
+	  $(AUTOMAKE) --foreign  Makefile
+.PRECIOUS: Makefile
+Makefile: $(srcdir)/Makefile.in $(top_builddir)/config.status
+	@case '$?' in \
+	  *config.status*) \
+	    echo ' $(SHELL) ./config.status'; \
+	    $(SHELL) ./config.status;; \
+	  *) \
+	    echo ' cd $(top_builddir) && $(SHELL) ./config.status $@ $(am__depfiles_maybe)'; \
+	    cd $(top_builddir) && $(SHELL) ./config.status $@ $(am__depfiles_maybe);; \
+	esac;
+
+$(top_builddir)/config.status: $(top_srcdir)/configure $(CONFIG_STATUS_DEPENDENCIES)
+	$(SHELL) ./config.status --recheck
+
+$(top_srcdir)/configure:  $(am__configure_deps)
+	cd $(srcdir) && $(AUTOCONF)
+$(ACLOCAL_M4):  $(am__aclocal_m4_deps)
+	cd $(srcdir) && $(ACLOCAL) $(ACLOCAL_AMFLAGS)
+
+config_ac.h: stamp-h1
+	@if test ! -f $@; then \
+	  rm -f stamp-h1; \
+	  $(MAKE) $(AM_MAKEFLAGS) stamp-h1; \
+	else :; fi
+
+stamp-h1: $(srcdir)/config_ac-h.in $(top_builddir)/config.status
+	@rm -f stamp-h1
+	cd $(top_builddir) && $(SHELL) ./config.status config_ac.h
+$(srcdir)/config_ac-h.in:  $(am__configure_deps) 
+	cd $(top_srcdir) && $(AUTOHEADER)
+	rm -f stamp-h1
+	touch $@
+
+distclean-hdr:
+	-rm -f config_ac.h stamp-h1
+
+mostlyclean-libtool:
+	-rm -f *.lo
+
+clean-libtool:
+	-rm -rf .libs _libs
+
+distclean-libtool:
+	-rm -f libtool
+
+# This directory's subdirectories are mostly independent; you can cd
+# into them and run `make' without going through this Makefile.
+# To change the values of `make' variables: instead of editing Makefiles,
+# (1) if the variable is set in `config.status', edit `config.status'
+#     (which will cause the Makefiles to be regenerated when you run `make');
+# (2) otherwise, pass the desired values on the `make' command line.
+$(RECURSIVE_TARGETS):
+	@failcom='exit 1'; \
+	for f in x $$MAKEFLAGS; do \
+	  case $$f in \
+	    *=* | --[!k]*);; \
+	    *k*) failcom='fail=yes';; \
+	  esac; \
+	done; \
+	dot_seen=no; \
+	target=`echo $@ | sed s/-recursive//`; \
+	list='$(SUBDIRS)'; for subdir in $$list; do \
+	  echo "Making $$target in $$subdir"; \
+	  if test "$$subdir" = "."; then \
+	    dot_seen=yes; \
+	    local_target="$$target-am"; \
+	  else \
+	    local_target="$$target"; \
+	  fi; \
+	  (cd $$subdir && $(MAKE) $(AM_MAKEFLAGS) $$local_target) \
+	  || eval $$failcom; \
+	done; \
+	if test "$$dot_seen" = "no"; then \
+	  $(MAKE) $(AM_MAKEFLAGS) "$$target-am" || exit 1; \
+	fi; test -z "$$fail"
+
+$(RECURSIVE_CLEAN_TARGETS):
+	@failcom='exit 1'; \
+	for f in x $$MAKEFLAGS; do \
+	  case $$f in \
+	    *=* | --[!k]*);; \
+	    *k*) failcom='fail=yes';; \
+	  esac; \
+	done; \
+	dot_seen=no; \
+	case "$@" in \
+	  distclean-* | maintainer-clean-*) list='$(DIST_SUBDIRS)' ;; \
+	  *) list='$(SUBDIRS)' ;; \
+	esac; \
+	rev=''; for subdir in $$list; do \
+	  if test "$$subdir" = "."; then :; else \
+	    rev="$$subdir $$rev"; \
+	  fi; \
+	done; \
+	rev="$$rev ."; \
+	target=`echo $@ | sed s/-recursive//`; \
+	for subdir in $$rev; do \
+	  echo "Making $$target in $$subdir"; \
+	  if test "$$subdir" = "."; then \
+	    local_target="$$target-am"; \
+	  else \
+	    local_target="$$target"; \
+	  fi; \
+	  (cd $$subdir && $(MAKE) $(AM_MAKEFLAGS) $$local_target) \
+	  || eval $$failcom; \
+	done && test -z "$$fail"
+tags-recursive:
+	list='$(SUBDIRS)'; for subdir in $$list; do \
+	  test "$$subdir" = . || (cd $$subdir && $(MAKE) $(AM_MAKEFLAGS) tags); \
+	done
+ctags-recursive:
+	list='$(SUBDIRS)'; for subdir in $$list; do \
+	  test "$$subdir" = . || (cd $$subdir && $(MAKE) $(AM_MAKEFLAGS) ctags); \
+	done
+
+ID: $(HEADERS) $(SOURCES) $(LISP) $(TAGS_FILES)
+	list='$(SOURCES) $(HEADERS) $(LISP) $(TAGS_FILES)'; \
+	unique=`for i in $$list; do \
+	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
+	  done | \
+	  $(AWK) '{ files[$$0] = 1; nonemtpy = 1; } \
+	      END { if (nonempty) { for (i in files) print i; }; }'`; \
+	mkid -fID $$unique
+tags: TAGS
+
+TAGS: tags-recursive $(HEADERS) $(SOURCES) config_ac-h.in $(TAGS_DEPENDENCIES) \
+		$(TAGS_FILES) $(LISP)
+	tags=; \
+	here=`pwd`; \
+	if ($(ETAGS) --etags-include --version) >/dev/null 2>&1; then \
+	  include_option=--etags-include; \
+	  empty_fix=.; \
+	else \
+	  include_option=--include; \
+	  empty_fix=; \
+	fi; \
+	list='$(SUBDIRS)'; for subdir in $$list; do \
+	  if test "$$subdir" = .; then :; else \
+	    test ! -f $$subdir/TAGS || \
+	      tags="$$tags $$include_option=$$here/$$subdir/TAGS"; \
+	  fi; \
+	done; \
+	list='$(SOURCES) $(HEADERS) config_ac-h.in $(LISP) $(TAGS_FILES)'; \
+	unique=`for i in $$list; do \
+	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
+	  done | \
+	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
+	      END { if (nonempty) { for (i in files) print i; }; }'`; \
+	if test -z "$(ETAGS_ARGS)$$tags$$unique"; then :; else \
+	  test -n "$$unique" || unique=$$empty_fix; \
+	  $(ETAGS) $(ETAGSFLAGS) $(AM_ETAGSFLAGS) $(ETAGS_ARGS) \
+	    $$tags $$unique; \
+	fi
+ctags: CTAGS
+CTAGS: ctags-recursive $(HEADERS) $(SOURCES) config_ac-h.in $(TAGS_DEPENDENCIES) \
+		$(TAGS_FILES) $(LISP)
+	tags=; \
+	list='$(SOURCES) $(HEADERS) config_ac-h.in $(LISP) $(TAGS_FILES)'; \
+	unique=`for i in $$list; do \
+	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
+	  done | \
+	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
+	      END { if (nonempty) { for (i in files) print i; }; }'`; \
+	test -z "$(CTAGS_ARGS)$$tags$$unique" \
+	  || $(CTAGS) $(CTAGSFLAGS) $(AM_CTAGSFLAGS) $(CTAGS_ARGS) \
+	     $$tags $$unique
+
+GTAGS:
+	here=`$(am__cd) $(top_builddir) && pwd` \
+	  && cd $(top_srcdir) \
+	  && gtags -i $(GTAGS_ARGS) $$here
+
+distclean-tags:
+	-rm -f TAGS ID GTAGS GRTAGS GSYMS GPATH tags
+
+distdir: $(DISTFILES)
+	$(am__remove_distdir)
+	test -d $(distdir) || mkdir $(distdir)
+	@srcdirstrip=`echo "$(srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
+	topsrcdirstrip=`echo "$(top_srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
+	list='$(DISTFILES)'; \
+	  dist_files=`for file in $$list; do echo $$file; done | \
+	  sed -e "s|^$$srcdirstrip/||;t" \
+	      -e "s|^$$topsrcdirstrip/|$(top_builddir)/|;t"`; \
+	case $$dist_files in \
+	  */*) $(MKDIR_P) `echo "$$dist_files" | \
+			   sed '/\//!d;s|^|$(distdir)/|;s,/[^/]*$$,,' | \
+			   sort -u` ;; \
+	esac; \
+	for file in $$dist_files; do \
+	  if test -f $$file || test -d $$file; then d=.; else d=$(srcdir); fi; \
+	  if test -d $$d/$$file; then \
+	    dir=`echo "/$$file" | sed -e 's,/[^/]*$$,,'`; \
+	    if test -d $(srcdir)/$$file && test $$d != $(srcdir); then \
+	      cp -pR $(srcdir)/$$file $(distdir)$$dir || exit 1; \
+	    fi; \
+	    cp -pR $$d/$$file $(distdir)$$dir || exit 1; \
+	  else \
+	    test -f $(distdir)/$$file \
+	    || cp -p $$d/$$file $(distdir)/$$file \
+	    || exit 1; \
+	  fi; \
+	done
+	list='$(DIST_SUBDIRS)'; for subdir in $$list; do \
+	  if test "$$subdir" = .; then :; else \
+	    test -d "$(distdir)/$$subdir" \
+	    || $(MKDIR_P) "$(distdir)/$$subdir" \
+	    || exit 1; \
+	    distdir=`$(am__cd) $(distdir) && pwd`; \
+	    top_distdir=`$(am__cd) $(top_distdir) && pwd`; \
+	    (cd $$subdir && \
+	      $(MAKE) $(AM_MAKEFLAGS) \
+	        top_distdir="$$top_distdir" \
+	        distdir="$$distdir/$$subdir" \
+		am__remove_distdir=: \
+		am__skip_length_check=: \
+	        distdir) \
+	      || exit 1; \
+	  fi; \
+	done
+	-find $(distdir) -type d ! -perm -777 -exec chmod a+rwx {} \; -o \
+	  ! -type d ! -perm -444 -links 1 -exec chmod a+r {} \; -o \
+	  ! -type d ! -perm -400 -exec chmod a+r {} \; -o \
+	  ! -type d ! -perm -444 -exec $(install_sh) -c -m a+r {} {} \; \
+	|| chmod -R a+r $(distdir)
+dist-gzip: distdir
+	tardir=$(distdir) && $(am__tar) | GZIP=$(GZIP_ENV) gzip -c >$(distdir).tar.gz
+	$(am__remove_distdir)
+
+dist-bzip2: distdir
+	tardir=$(distdir) && $(am__tar) | bzip2 -9 -c >$(distdir).tar.bz2
+	$(am__remove_distdir)
+
+dist-lzma: distdir
+	tardir=$(distdir) && $(am__tar) | lzma -9 -c >$(distdir).tar.lzma
+	$(am__remove_distdir)
+
+dist-tarZ: distdir
+	tardir=$(distdir) && $(am__tar) | compress -c >$(distdir).tar.Z
+	$(am__remove_distdir)
+
+dist-shar: distdir
+	shar $(distdir) | GZIP=$(GZIP_ENV) gzip -c >$(distdir).shar.gz
+	$(am__remove_distdir)
+
+dist-zip: distdir
+	-rm -f $(distdir).zip
+	zip -rq $(distdir).zip $(distdir)
+	$(am__remove_distdir)
+
+dist dist-all: distdir
+	tardir=$(distdir) && $(am__tar) | GZIP=$(GZIP_ENV) gzip -c >$(distdir).tar.gz
+	$(am__remove_distdir)
+
+# This target untars the dist file and tries a VPATH configuration.  Then
+# it guarantees that the distribution is self-contained by making another
+# tarfile.
+distcheck: dist
+	case '$(DIST_ARCHIVES)' in \
+	*.tar.gz*) \
+	  GZIP=$(GZIP_ENV) gunzip -c $(distdir).tar.gz | $(am__untar) ;;\
+	*.tar.bz2*) \
+	  bunzip2 -c $(distdir).tar.bz2 | $(am__untar) ;;\
+	*.tar.lzma*) \
+	  unlzma -c $(distdir).tar.lzma | $(am__untar) ;;\
+	*.tar.Z*) \
+	  uncompress -c $(distdir).tar.Z | $(am__untar) ;;\
+	*.shar.gz*) \
+	  GZIP=$(GZIP_ENV) gunzip -c $(distdir).shar.gz | unshar ;;\
+	*.zip*) \
+	  unzip $(distdir).zip ;;\
+	esac
+	chmod -R a-w $(distdir); chmod a+w $(distdir)
+	mkdir $(distdir)/_build
+	mkdir $(distdir)/_inst
+	chmod a-w $(distdir)
+	dc_install_base=`$(am__cd) $(distdir)/_inst && pwd | sed -e 's,^[^:\\/]:[\\/],/,'` \
+	  && dc_destdir="$${TMPDIR-/tmp}/am-dc-$$$$/" \
+	  && cd $(distdir)/_build \
+	  && ../configure --srcdir=.. --prefix="$$dc_install_base" \
+	    $(DISTCHECK_CONFIGURE_FLAGS) \
+	  && $(MAKE) $(AM_MAKEFLAGS) \
+	  && $(MAKE) $(AM_MAKEFLAGS) dvi \
+	  && $(MAKE) $(AM_MAKEFLAGS) check \
+	  && $(MAKE) $(AM_MAKEFLAGS) install \
+	  && $(MAKE) $(AM_MAKEFLAGS) installcheck \
+	  && $(MAKE) $(AM_MAKEFLAGS) uninstall \
+	  && $(MAKE) $(AM_MAKEFLAGS) distuninstallcheck_dir="$$dc_install_base" \
+	        distuninstallcheck \
+	  && chmod -R a-w "$$dc_install_base" \
+	  && ({ \
+	       (cd ../.. && umask 077 && mkdir "$$dc_destdir") \
+	       && $(MAKE) $(AM_MAKEFLAGS) DESTDIR="$$dc_destdir" install \
+	       && $(MAKE) $(AM_MAKEFLAGS) DESTDIR="$$dc_destdir" uninstall \
+	       && $(MAKE) $(AM_MAKEFLAGS) DESTDIR="$$dc_destdir" \
+	            distuninstallcheck_dir="$$dc_destdir" distuninstallcheck; \
+	      } || { rm -rf "$$dc_destdir"; exit 1; }) \
+	  && rm -rf "$$dc_destdir" \
+	  && $(MAKE) $(AM_MAKEFLAGS) dist \
+	  && rm -rf $(DIST_ARCHIVES) \
+	  && $(MAKE) $(AM_MAKEFLAGS) distcleancheck
+	$(am__remove_distdir)
+	@(echo "$(distdir) archives ready for distribution: "; \
+	  list='$(DIST_ARCHIVES)'; for i in $$list; do echo $$i; done) | \
+	  sed -e 1h -e 1s/./=/g -e 1p -e 1x -e '$$p' -e '$$x'
+distuninstallcheck:
+	@cd $(distuninstallcheck_dir) \
+	&& test `$(distuninstallcheck_listfiles) | wc -l` -le 1 \
+	   || { echo "ERROR: files left after uninstall:" ; \
+	        if test -n "$(DESTDIR)"; then \
+	          echo "  (check DESTDIR support)"; \
+	        fi ; \
+	        $(distuninstallcheck_listfiles) ; \
+	        exit 1; } >&2
+distcleancheck: distclean
+	@if test '$(srcdir)' = . ; then \
+	  echo "ERROR: distcleancheck can only run from a VPATH build" ; \
+	  exit 1 ; \
+	fi
+	@test `$(distcleancheck_listfiles) | wc -l` -eq 0 \
+	  || { echo "ERROR: files left in build directory after distclean:" ; \
+	       $(distcleancheck_listfiles) ; \
+	       exit 1; } >&2
+check-am: all-am
+check: check-recursive
+all-am: Makefile config_ac.h
+installdirs: installdirs-recursive
+installdirs-am:
+install: install-recursive
+install-exec: install-exec-recursive
+install-data: install-data-recursive
+uninstall: uninstall-recursive
+
+install-am: all-am
+	@$(MAKE) $(AM_MAKEFLAGS) install-exec-am install-data-am
+
+installcheck: installcheck-recursive
+install-strip:
+	$(MAKE) $(AM_MAKEFLAGS) INSTALL_PROGRAM="$(INSTALL_STRIP_PROGRAM)" \
+	  install_sh_PROGRAM="$(INSTALL_STRIP_PROGRAM)" INSTALL_STRIP_FLAG=-s \
+	  `test -z '$(STRIP)' || \
+	    echo "INSTALL_PROGRAM_ENV=STRIPPROG='$(STRIP)'"` install
+mostlyclean-generic:
+
+clean-generic:
+
+distclean-generic:
+	-test -z "$(CONFIG_CLEAN_FILES)" || rm -f $(CONFIG_CLEAN_FILES)
+
+maintainer-clean-generic:
+	@echo "This command is intended for maintainers to use"
+	@echo "it deletes files that may require special tools to rebuild."
+clean: clean-recursive
+
+clean-am: clean-generic clean-libtool mostlyclean-am
+
+distclean: distclean-recursive
+	-rm -f $(am__CONFIG_DISTCLEAN_FILES)
+	-rm -f Makefile
+distclean-am: clean-am distclean-generic distclean-hdr \
+	distclean-libtool distclean-tags
+
+dvi: dvi-recursive
+
+dvi-am:
+
+html: html-recursive
+
+info: info-recursive
+
+info-am:
+
+install-data-am:
+
+install-dvi: install-dvi-recursive
+
+install-exec-am:
+
+install-html: install-html-recursive
+
+install-info: install-info-recursive
+
+install-man:
+
+install-pdf: install-pdf-recursive
+
+install-ps: install-ps-recursive
+
+installcheck-am:
+
+maintainer-clean: maintainer-clean-recursive
+	-rm -f $(am__CONFIG_DISTCLEAN_FILES)
+	-rm -rf $(top_srcdir)/autom4te.cache
+	-rm -f Makefile
+maintainer-clean-am: distclean-am maintainer-clean-generic
+
+mostlyclean: mostlyclean-recursive
+
+mostlyclean-am: mostlyclean-generic mostlyclean-libtool
+
+pdf: pdf-recursive
+
+pdf-am:
+
+ps: ps-recursive
+
+ps-am:
+
+uninstall-am:
+
+.MAKE: $(RECURSIVE_CLEAN_TARGETS) $(RECURSIVE_TARGETS) install-am \
+	install-strip
+
+.PHONY: $(RECURSIVE_CLEAN_TARGETS) $(RECURSIVE_TARGETS) CTAGS GTAGS \
+	all all-am am--refresh check check-am clean clean-generic \
+	clean-libtool ctags ctags-recursive dist dist-all dist-bzip2 \
+	dist-gzip dist-lzma dist-shar dist-tarZ dist-zip distcheck \
+	distclean distclean-generic distclean-hdr distclean-libtool \
+	distclean-tags distcleancheck distdir distuninstallcheck dvi \
+	dvi-am html html-am info info-am install install-am \
+	install-data install-data-am install-dvi install-dvi-am \
+	install-exec install-exec-am install-html install-html-am \
+	install-info install-info-am install-man install-pdf \
+	install-pdf-am install-ps install-ps-am install-strip \
+	installcheck installcheck-am installdirs installdirs-am \
+	maintainer-clean maintainer-clean-generic mostlyclean \
+	mostlyclean-generic mostlyclean-libtool pdf pdf-am ps ps-am \
+	tags tags-recursive uninstall uninstall-am
+
+# Tell versions [3.59,3.63) of GNU make to not export all variables.
+# Otherwise a system limit (for SysV at least) may be exceeded.
+.NOEXPORT:
diff --git a/Makefile.am b/Makefile.am
new file mode 100644
index 0000000..1b6a513
--- /dev/null
+++ b/Makefile.am
@@ -0,0 +1,13 @@
+
+SUBDIRS = \
+  common \
+  vnc \
+  rdp \
+  xup \
+  mc \
+  libxrdp \
+  xrdp \
+  sesman \
+  keygen \
+  docs \
+  instfiles
diff --git a/Makefile.osx b/Makefile.osx
new file mode 100644
index 0000000..fab3898
--- /dev/null
+++ b/Makefile.osx
@@ -0,0 +1,50 @@
+
+DESTDIR = /usr/local/xrdp
+CFGDIR = /etc/xrdp
+PIDDIR = /var/run
+MANDIR = /usr/local/man
+DOCDIR = /usr/doc/xrdp
+
+all: kerberos
+
+world: base
+	$(MAKE) -C sesman
+
+base:
+	$(MAKE) -C vnc -f Makefile.osx
+	$(MAKE) -C libxrdp -f Makefile.osx
+	$(MAKE) -C xrdp -f Makefile.osx
+	$(MAKE) -C rdp -f Makefile.osx
+	$(MAKE) -C xup -f Makefile.osx
+
+nopam: base
+	$(MAKE) -C sesman nopam
+	$(MAKE) -C sesman tools
+
+kerberos: base
+	$(MAKE) -C sesman -f Makefile.osx kerberos
+	$(MAKE) -C sesman -f Makefile.osx tools
+
+clean:
+	$(MAKE) -C vnc -f Makefile.osx clean
+	$(MAKE) -C libxrdp -f Makefile.osx clean
+	$(MAKE) -C xrdp -f Makefile.osx clean
+	$(MAKE) -C rdp -f Makefile.osx clean
+	$(MAKE) -C sesman -f Makefile.osx clean
+	$(MAKE) -C xup -f Makefile.osx clean
+
+install:
+	mkdir -p $(DESTDIR)
+	mkdir -p $(CFGDIR)
+	mkdir -p $(PIDDIR)
+	mkdir -p $(MANDIR)
+	mkdir -p $(DOCDIR)
+	$(MAKE) -C vnc install
+	$(MAKE) -C libxrdp install
+	$(MAKE) -C xrdp install
+	$(MAKE) -C rdp install
+	$(MAKE) -C sesman install
+	$(MAKE) -C xup install
+	$(MAKE) -C docs install
+	if [ -d /etc/pam.d ]; then install instfiles/pam.d/sesman/etc/pam.d/sesman; fi
+	install instfiles/xrdp_control.sh $(DESTDIR)/xrdp_control.sh
diff --git a/Xserver/hw/rdp/gcops.h b/Xserver/hw/rdp/gcops.h
index c700201..abb7a4c 100644
--- a/Xserver/hw/rdp/gcops.h
+++ b/Xserver/hw/rdp/gcops.h
@@ -1,5 +1,5 @@
 /*
-Copyright 2005-2007 Jay Sorg
+Copyright 2005-2008 Jay Sorg
 
 Permission to use, copy, modify, distribute, and sell this software and its
 documentation for any purpose is hereby granted without fee, provided that
diff --git a/Xserver/hw/rdp/rdp.h b/Xserver/hw/rdp/rdp.h
index 0ead82e..5816ad9 100644
--- a/Xserver/hw/rdp/rdp.h
+++ b/Xserver/hw/rdp/rdp.h
@@ -1,5 +1,5 @@
 /*
-Copyright 2005-2007 Jay Sorg
+Copyright 2005-2008 Jay Sorg
 
 Permission to use, copy, modify, distribute, and sell this software and its
 documentation for any purpose is hereby granted without fee, provided that
diff --git a/Xserver/hw/rdp/rdpdraw.c b/Xserver/hw/rdp/rdpdraw.c
index 52b6039..bb4c7c2 100644
--- a/Xserver/hw/rdp/rdpdraw.c
+++ b/Xserver/hw/rdp/rdpdraw.c
@@ -1,5 +1,5 @@
 /*
-Copyright 2005-2007 Jay Sorg
+Copyright 2005-2008 Jay Sorg
 
 Permission to use, copy, modify, distribute, and sell this software and its
 documentation for any purpose is hereby granted without fee, provided that
diff --git a/Xserver/hw/rdp/rdpinput.c b/Xserver/hw/rdp/rdpinput.c
index 9ddd81c..a20ad7a 100644
--- a/Xserver/hw/rdp/rdpinput.c
+++ b/Xserver/hw/rdp/rdpinput.c
@@ -1,5 +1,5 @@
 /*
-Copyright 2005-2007 Jay Sorg
+Copyright 2005-2008 Jay Sorg
 
 Permission to use, copy, modify, distribute, and sell this software and its
 documentation for any purpose is hereby granted without fee, provided that
@@ -771,8 +771,8 @@ KbdAddEvent(int down, int param1, int param2, int param3, int param4)
     case 42: /* left shift */
       ch = 10;
       break;
-    case 43: /* / */
-      ch = 36;
+    case 43: /* \ or | */
+      ch = 37;
       break;
     case 44: /* z */
       ch = 63;
diff --git a/Xserver/hw/rdp/rdpmain.c b/Xserver/hw/rdp/rdpmain.c
index 032a0b7..0360552 100644
--- a/Xserver/hw/rdp/rdpmain.c
+++ b/Xserver/hw/rdp/rdpmain.c
@@ -1,5 +1,5 @@
 /*
-Copyright 2005-2007 Jay Sorg
+Copyright 2005-2008 Jay Sorg
 
 Permission to use, copy, modify, distribute, and sell this software and its
 documentation for any purpose is hereby granted without fee, provided that
diff --git a/Xserver/hw/rdp/rdpmisc.c b/Xserver/hw/rdp/rdpmisc.c
index 58c9a58..a906aae 100644
--- a/Xserver/hw/rdp/rdpmisc.c
+++ b/Xserver/hw/rdp/rdpmisc.c
@@ -1,5 +1,5 @@
 /*
-Copyright 2005-2007 Jay Sorg
+Copyright 2005-2008 Jay Sorg
 
 Permission to use, copy, modify, distribute, and sell this software and its
 documentation for any purpose is hereby granted without fee, provided that
diff --git a/Xserver/hw/rdp/rdpup.c b/Xserver/hw/rdp/rdpup.c
index f0238fc..dd4b14a 100644
--- a/Xserver/hw/rdp/rdpup.c
+++ b/Xserver/hw/rdp/rdpup.c
@@ -1,5 +1,5 @@
 /*
-Copyright 2005-2007 Jay Sorg
+Copyright 2005-2008 Jay Sorg
 
 Permission to use, copy, modify, distribute, and sell this software and its
 documentation for any purpose is hereby granted without fee, provided that
diff --git a/Xserver/makefile_rdp b/Xserver/makefile_rdp
deleted file mode 100644
index 224d87e..0000000
--- a/Xserver/makefile_rdp
+++ /dev/null
@@ -1,1497 +0,0 @@
-# Makefile generated by imake - do not edit!
-# $Xorg: imake.c,v 1.6 2001/02/09 02:03:15 xorgcvs Exp $
-
-# ----------------------------------------------------------------------
-# Makefile generated from "Imake.tmpl" and <Imakefile>
-# $Xorg: Imake.tmpl,v 1.4 2000/08/17 19:41:46 cpqbld Exp $
-#
-#
-#
-#
-# $XFree86: xc/config/cf/Imake.tmpl,v 3.154 2003/11/04 01:59:31 dawes Exp $
-# ----------------------------------------------------------------------
-
-all::
-
-.SUFFIXES: .i
-
-# $Xorg: Imake.cf,v 1.4 2000/08/17 19:41:45 cpqbld Exp $
-
-# $XFree86: xc/config/cf/Imake.cf,v 3.88 2003/12/16 21:30:21 herrb Exp $
-
-# Keep cpp from replacing path elements containing i486/i586/i686
-
-# -----------------------------------------------------------------------
-# site-specific configuration parameters that need to come before
-# the platform-specific parameters - edit site.def to change
-
-# site:  $TOG: site.sample /main/r64_final/1 1998/02/05 16:28:49 kaleb $
-
-# site:  $XFree86: xc/config/cf/site.def,v 3.25 2002/02/27 00:51:12 dawes Exp $
-
-# $XFree86: xc/config/cf/xf86site.def,v 3.187 2003/09/06 23:38:04 dawes Exp $
-
-# ----------------------------------------------------------------------
-# platform-specific configuration parameters - edit linux.cf to change
-
-# platform:  $Xorg: linux.cf,v 1.3 2000/08/17 19:41:47 cpqbld Exp $
-
-# platform:  $XFree86: xc/config/cf/linux.cf,v 3.219 2003/12/19 01:47:26 dawes Exp $
-
-# operating system:  Linux 2.6.13-15.8-default i686 [ELF] (2.6.13)
-# libc:	(6.3.5)
-# binutils:	(216)
-
-# $Xorg: lnxLib.rules,v 1.3 2000/08/17 19:41:47 cpqbld Exp $
-# $XFree86: xc/config/cf/lnxLib.rules,v 3.52 2003/10/31 20:49:03 herrb Exp $
-
-# $XFree86: xc/config/cf/xfree86.cf,v 3.465 2003/11/07 23:57:43 dawes Exp $
-
-# $Xorg: xfree86.cf,v 1.4 2000/08/17 19:41:49 cpqbld Exp $
-
-AFB_DEFS = -DUSE_AFB
-
-DRIVERSDKDIR = $(USRLIBDIR)/Server
-DRIVERSDKMODULEDIR = $(USRLIBDIR)/Server/modules
-DRIVERSDKINCLUDEDIR = $(USRLIBDIR)/Server/include
-
-       XF86SRC = $(SERVERSRC)/hw/xfree86
-    XF86COMSRC = $(XF86SRC)/common
- XF86PARSERSRC = $(XF86SRC)/parser
-     XF86OSSRC = $(XF86SRC)/os-support
- XF86DRIVERSRC = $(XF86SRC)/drivers
-     DRIVERSRC = $(XF86DRIVERSRC)
-
-        XFREE86DOCDIR = $(DOCDIR)
-      XFREE86PSDOCDIR = $(DOCPSDIR)
-     XFREE86PDFDOCDIR = $(DOCPDFDIR)
-    XFREE86HTMLDOCDIR = $(DOCHTMLDIR)
-XFREE86JAPANESEDOCDIR = $(DOCDIR)/Japanese
-
-# $Xorg: xf86.rules,v 1.3 2000/08/17 19:41:48 cpqbld Exp $
-
-# $XFree86: xc/config/cf/xf86.rules,v 3.35 2003/09/01 21:20:01 tsi Exp $
-
-# ----------------------------------------------------------------------
-# site-specific configuration parameters that go after
-# the platform-specific parameters - edit site.def to change
-
-# site:  $TOG: site.sample /main/r64_final/1 1998/02/05 16:28:49 kaleb $
-
-# site:  $XFree86: xc/config/cf/site.def,v 3.25 2002/02/27 00:51:12 dawes Exp $
-
-# ---------------------------------------------------------------------
-# Imake rules for building libraries, programs, scripts, and data files
-# rules:  $Xorg: Imake.rules,v 1.3 2000/08/17 19:41:46 cpqbld Exp $
-#
-#
-#
-#
-# rules:  $XFree86: xc/config/cf/Imake.rules,v 3.128 2003/11/15 03:25:17 dawes Exp $
-
- _NULLCMD_ = @ echo -n
-
-X_BYTE_ORDER = X_LITTLE_ENDIAN
-
-GLIDE2INCDIR =
-
-GLIDE3INCDIR =
-
-GLIDE3LIBNAME =
-
-TKLIBNAME =
-
-TKLIBDIR =
-
-TCLLIBNAME =
-
-TCLIBDIR =
-
-          PATHSEP = /
-            SHELL = /bin/sh -e
-
-              TOP = ../..
-      CURRENT_DIR = programs/Xserver
-
-            IMAKE = $(IMAKESRC)/imake
-           DEPEND = $(DEPENDSRC)/makedepend
-        MKDIRHIER = mkdir -p
-          REVPATH = $(CONFIGSRC)/util/revpath
-    EXPORTLISTGEN =
-             RMAN = $(TOP)/config/util/rman
-     RMANBASENAME = rman
-      RMANOPTIONS = -f HTML
-        CONFIGSRC = $(TOP)/config
-         IMAKESRC = $(CONFIGSRC)/imake
-        DEPENDSRC = $(CONFIGSRC)/makedepend
-
-          INCROOT = /usr/X11R6/include
-        USRLIBDIR = /usr/X11R6/lib
-           VARDIR = /var
-        VARLIBDIR = $(VARDIR)/lib
-  SYSTEMUSRLIBDIR = /usr/lib
-  SYSTEMUSRINCDIR = /usr/include
-         SHLIBDIR = /usr/X11R6/lib
-       LINTLIBDIR = $(USRLIBDIR)/lint
-          MANPATH = /usr/X11R6/man
-    MANSOURCEPATH = $(MANPATH)/man
-           MANDIR = $(MANSOURCEPATH)1
-        LIBMANDIR = $(MANSOURCEPATH)3
-       FILEMANDIR = $(MANSOURCEPATH)5
-       MISCMANDIR = $(MANSOURCEPATH)$(MISCMANSUFFIX)
-     DRIVERMANDIR = $(MANSOURCEPATH)$(DRIVERMANSUFFIX)
-     LOGDIRECTORY = $(VARDIR)/log
-
-        VARRUNDIR = $(VARDIR)/run
-
-         VARDBDIR = $(VARDIR)/lib
-
-               AR = ar clq
-
-# Nice try but useless: make will inherit BOOTSTRAPCFLAGS
-# from  top Makefile
-  BOOTSTRAPCFLAGS =
-
-               CC = gcc -m32
-               AS = gcc -m32 -c -x assembler
-
-.SUFFIXES: .cc
-
-              CXX = c++ -m32
-
-          CXXFILT = c++filt
-
-           CXXLIB = -lstdc++
-
-    CXXDEBUGFLAGS = -O2 -fno-strength-reduce
-CXXDEPENDINCLUDES =
- CXXEXTRA_DEFINES =
-CXXEXTRA_INCLUDES =
-   CXXSTD_DEFINES = -Dlinux -D__i386__ -D_POSIX_C_SOURCE=199309L 				-D_POSIX_SOURCE -D_XOPEN_SOURCE 				-D_BSD_SOURCE -D_SVID_SOURCE 				 -D_GNU_SOURCE 				 $(CXXPROJECT_DEFINES)
-       CXXOPTIONS =
-      CXXINCLUDES = $(INCLUDES) $(TOP_INCLUDES) $(CXXEXTRA_INCLUDES)
-       CXXDEFINES = $(CXXINCLUDES) $(CXXSTD_DEFINES) $(THREADS_CXXDEFINES) $(DEFINES) $(CXXEXTRA_DEFINES)
-         CXXFLAGS = $(CXXDEBUGFLAGS) $(CXXOPTIONS) $(THREADS_CXXFLAGS) $(CXXDEFINES)
-
-         COMPRESS = compress
-          GZIPCMD = gzip
-
-              CPP = cpp $(STD_CPP_DEFINES)
-           RAWCPP = cpp -undef $(STD_CPP_OPTIONS)
-    PREPROCESSCMD = gcc -m32 -E $(STD_CPP_DEFINES)
-
-          INSTALL = install
-     INSTALLFLAGS = -c
-
-               LD = gcc -m32 -nostdlib
-
-              LEX = flex -l
-               M4 = m4
-          M4FLAGS =
-           LEXLIB = -lfl
-             YACC = bison -y
-           CCYACC = bison -y
-
-             LINT = lint
-
-      LINTLIBFLAG = -C
-         LINTOPTS = -axz
-               LN = ln -s
-             MAKE = make
-               MV = mv -f
-               CP = cp
-
-           RANLIB = ranlib
-
-  RANLIBINSTFLAGS =
-
-               RM = rm -f
-             PERL = perl
-         PERLOPTS =
-     PERLENVSETUP = env LC_ALL=C
-        MANSUFFIX = 1x
-     LIBMANSUFFIX = 3x
-    FILEMANSUFFIX = 5x
-    MISCMANSUFFIX = 7
-  DRIVERMANSUFFIX = 4
-     MANSRCSUFFIX = man
-     MANNEWSUFFIX = _man
-          MANDEFS = -D__apploaddir__=$(XAPPLOADDIR) -D__filemansuffix__=$(FILEMANSUFFIX) -D__libmansuffix__=$(LIBMANSUFFIX) -D__miscmansuffix__=$(MISCMANSUFFIX) -D__drivermansuffix__=$(DRIVERMANSUFFIX) -D__projectroot__=$(PROJECTROOT) $(XORGMANDEFS) $(VENDORMANDEFS)
-
-   COMPRESSMANCMD = gzip -n
-
-            TROFF = groff -Tps
-            NROFF = nroff
-
-         MSMACROS = -ms
-        MANMACROS = -man
-              TBL = tbl
-              EQN = eqn
-             NEQN = neqn
-              COL = col
-         COLFLAGS = -b
-
-            MODCC = gcc -m32
-
-           MODCPP = cpp
-        MODCFLAGS = $(CFLAGS)
-            MODAS = gcc -m32 -c -x assembler
-       MODASFLAGS =
-
-            MODLD = gcc -m32 -nostdlib
-
-       MODLDFLAGS =
-MODLDCOMBINEFLAGS = -r
-            MODAR = ar clq
-
-        MODRANLIB = ranlib
-
-     STD_INCLUDES =
-  STD_CPP_OPTIONS = -traditional
-  STD_CPP_DEFINES = -traditional -Dlinux -D__i386__ -D_POSIX_C_SOURCE=199309L 				-D_POSIX_SOURCE -D_XOPEN_SOURCE 				-D_BSD_SOURCE -D_SVID_SOURCE 				 -D_GNU_SOURCE 				 $(PROJECT_DEFINES)
-      STD_DEFINES = -Dlinux -D__i386__ -D_POSIX_C_SOURCE=199309L 				-D_POSIX_SOURCE -D_XOPEN_SOURCE 				-D_BSD_SOURCE -D_SVID_SOURCE 				 -D_GNU_SOURCE 				 $(PROJECT_DEFINES)
- EXTRA_LOAD_FLAGS = -Wl,-rpath-link,$(BUILDLIBDIR)
-  EXTRA_LDOPTIONS =
-  EXTRA_LIBRARIES =
-             TAGS = ctags
-
-   PARALLELMFLAGS =
-
-    SHAREDCODEDEF =
-         SHLIBDEF =
-
-     SHLIBLDFLAGS = -shared $(SHLIBGLOBALSFLAGS)
-
-         PICFLAGS = -fPIC
-
-      CXXPICFLAGS = -fPIC
-
-    PROTO_DEFINES = -DFUNCPROTO=15 -DNARROWPROTO
-
-     INSTPGMFLAGS =
-
-     INSTBINFLAGS = -m 0755
-     INSTUIDFLAGS = -m 4711
-     INSTLIBFLAGS = -m 0644
-     INSTINCFLAGS = -m 0444
-     INSTMANFLAGS = -m 0444
-     INSTDATFLAGS = -m 0444
-    INSTKMEMFLAGS = -m 4711
-
-      PROJECTROOT = /usr/X11R6
-
-      CDEBUGFLAGS = -O2 -fno-strength-reduce
-        CCOPTIONS = -ansi -pedantic -Wall -Wpointer-arith -Wstrict-prototypes 			  -Wmissing-prototypes -Wmissing-declarations 			  -Wredundant-decls -Wnested-externs -Wundef
-
-      ALLINCLUDES = $(INCLUDES) $(EXTRA_INCLUDES) $(TOP_INCLUDES) $(INSTALLED_INCLUDES) $(STD_INCLUDES)
-       ALLDEFINES = $(ALLINCLUDES) $(STD_DEFINES) $(PROTO_DEFINES) $(THREADS_DEFINES) $(MODULE_DEFINES) $(DEFINES) $(EXTRA_DEFINES)
-           CFLAGS = $(CDEBUGFLAGS) $(CCOPTIONS) $(THREADS_CFLAGS) $(MODULE_CFLAGS) $(ALLDEFINES)
-        LINTFLAGS = $(LINTOPTS) -DLINT $(ALLDEFINES) $(DEPEND_DEFINES)
-         LDPRELIB = -L$(BUILDLIBDIR) $(INSTALLED_LIBS)
-        LDPOSTLIB =
-        LDOPTIONS = $(CDEBUGFLAGS) $(CCOPTIONS)  $(EXTRA_LDOPTIONS) $(THREADS_LDFLAGS) $(LOCAL_LDFLAGS) $(LDPRELIBS)
-     CXXLDOPTIONS = $(CXXDEBUGFLAGS) $(CXXOPTIONS) $(EXTRA_LDOPTIONS) $(THREADS_CXXLDFLAGS) $(LOCAL_LDFLAGS) $(LDPRELIBS)
-
-           LDLIBS = $(LDPOSTLIBS) $(THREADS_LIBS) $(SYS_LIBRARIES) $(EXTRA_LIBRARIES)
-
-           CCLINK = $(CC)
-
-          CXXLINK = $(CXX)
-
-     LDSTRIPFLAGS = -x
-   LDCOMBINEFLAGS = -r
-      DEPENDFLAGS =
-   DEPEND_DEFINES = -DUSE_MAKEDEPEND
-
-# Not sure this belongs here
-         TKLIBDIR =
-         TKINCDIR =
-        TKLIBNAME =
-        TKLIBRARY = -L$(TKLIBDIR) -l$(TKLIBNAME)
-        TCLLIBDIR =
-        TCLINCDIR =
-       TCLLIBNAME =
-       TCLLIBRARY = -L$(TCLLIBDIR) -l$(TCLLIBNAME)
-
-        MACROFILE = linux.cf
-           RM_CMD = $(RM)
-
-    IMAKE_DEFINES =
-   IMAKE_WARNINGS = -Wundef
-
-         IRULESRC = $(CONFIGSRC)/cf
-        IMAKE_CMD = $(IMAKE) -I$(IRULESRC) $(IMAKE_DEFINES) $(IMAKE_WARNINGS)
-
-     ICONFIGFILES = $(IRULESRC)/Imake.tmpl $(IRULESRC)/X11.tmpl 			$(IRULESRC)/site.def $(IRULESRC)/$(MACROFILE) 			$(IRULESRC)/xfree86.cf $(IRULESRC)/xf86.rules $(IRULESRC)/xf86site.def $(IRULESRC)/host.def $(EXTRA_ICONFIGFILES)
-
-# $Xorg: X11.rules,v 1.4 2000/08/17 19:41:46 cpqbld Exp $
-
-# $XFree86: xc/config/cf/X11.rules,v 1.7 2003/11/05 18:15:51 dawes Exp $
-
-# ----------------------------------------------------------------------
-# X Window System Build Parameters and Rules
-# $Xorg: X11.tmpl,v 1.6 2000/08/17 19:41:46 cpqbld Exp $
-#
-#
-#
-#
-# $XFree86: xc/config/cf/X11.tmpl,v 1.239 2003/12/12 03:20:32 dawes Exp $
-
-XORGRELSTRING = Release 6.6
-XORGMANNAME = X Version 11
-
-VENDORMANNAME = XFree86
-VENDORMANVERSION = `echo 4 3 99 902 | sed -e 's/ /./g' -e 's/^/Version\\\ /'`
-
-STICKY_DEFINES = -DHAS_STICKY_DIR_BIT
-
-FCHOWN_DEFINES = -DHAS_FCHOWN
-
-# -----------------------------------------------------------------------
-# X Window System make variables; these need to be coordinated with rules
-
-             XTOP = $(TOP)
-           BINDIR = /usr/X11R6/bin
-     BUILDINCROOT = $(TOP)/exports
-      BUILDINCDIR = $(BUILDINCROOT)/include
-      BUILDINCTOP = ../..
-      BUILDLIBDIR = $(TOP)/exports/lib
-      BUILDLIBTOP = ../..
-      BUILDBINDIR = $(TOP)/exports/bin
-      BUILDBINTOP = ../..
-   BUILDMODULEDIR = $(BUILDLIBDIR)/modules
-   BUILDMODULETOP = $(BUILDLIBTOP)/..
-    XBUILDINCROOT = $(XTOP)/exports
-     XBUILDINCDIR = $(XBUILDINCROOT)/include/X11
-     XBUILDINCTOP = ../../..
-     XBUILDBINDIR = $(XBUILDINCROOT)/bin
-           INCDIR = $(INCROOT)
-           ADMDIR = /usr/adm
-           LIBDIR = /usr/X11R6/lib/X11
-       LIBEXECDIR = /usr/X11R6/libexec
-        MODULEDIR = $(USRLIBDIR)/modules
-   TOP_X_INCLUDES = -I$(TOP)/exports/include
-
-       INSTSRCDIR = /usr/X11R6/src
-
-        ETCX11DIR = /etc/X11
-
-          CONFDIR = $(ETCX11DIR)
-
-           DOCDIR = $(LIBDIR)/doc
-       DOCHTMLDIR = $(DOCDIR)/html
-         DOCPSDIR = $(DOCDIR)/PostScript
-        DOCPDFDIR = $(DOCDIR)/PDF
-          FONTDIR = $(LIBDIR)/fonts
-     ENCODINGSDIR = $(FONTDIR)/encodings
-         XINITDIR = $(LIBDIR)/xinit
-           XDMDIR = $(LIBDIR)/xdm
-        XDMVARDIR = $(VARLIBDIR)/xdm
-           TWMDIR = $(LIBDIR)/twm
-           XSMDIR = $(LIBDIR)/xsm
-           NLSDIR = $(LIBDIR)/nls
-       XLOCALEDIR = $(LIBDIR)/locale
-      LBXPROXYDIR = $(LIBDIR)/lbxproxy
-  PROXYMANAGERDIR = $(LIBDIR)/proxymngr
-        XPRINTDIR = $(LIBDIR)/xserver
-      XAPPLOADDIR = $(LIBDIR)/app-defaults
-       FONTCFLAGS = -t
-
-     INSTAPPFLAGS = $(INSTDATFLAGS)
-
-              RGB = $(CLIENTENVSETUP) $(XBUILDBINDIR)/rgb
-
-            FONTC = $(CLIENTENVSETUP) $(PRELOADFONTSETUP) $(XBUILDBINDIR)/bdftopcf
-  MKFONTSCALE_DIR = $(PRELOADFREETYPESETUP) $(XBUILDBINDIR)/mkfontscale -b -s -l
-        MKFONTDIR = $(CLIENTENVSETUP) $(MKFONTSCALE_DIR)
-       XCURSORGEN = $(CLIENTENVSETUP) $(PRELOADSETUP) $(XBUILDBINDIR)/xcursorgen
-
-      MKHTMLINDEX = $(PERLENVSETUP) $(PERL) $(PERLOPTS) $(CONFIGSRC)/util/mkhtmlindex.pl
-
-          UCS2ANY = $(XBUILDBINDIR)/ucs2any
-      BDFTRUNCATE = $(FONTSRC)/util/bdftruncate.pl
-     UCSMAPPREFIX = $(FONTSRC)/util/map-
-
-     HTMLINDEXCMD = $(MKHTMLINDEX)
-
-       DOCUTILSRC = $(XTOP)/doc/util
-        CLIENTSRC = $(TOP)/clients
-          DEMOSRC = $(TOP)/demos
-       XDOCMACROS = $(DOCUTILSRC)/macros.t
-       XIDXMACROS = $(DOCUTILSRC)/indexmacros.t
-       PROGRAMSRC = $(TOP)/programs
-           LIBSRC = $(XTOP)/lib
-          FONTSRC = $(XTOP)/fonts
-     ENCODINGSSRC = $(FONTSRC)/encodings
-       INCLUDESRC = $(BUILDINCROOT)/include
-      XINCLUDESRC = $(INCLUDESRC)/X11
-        SERVERSRC = $(XTOP)/programs/Xserver
-       CONTRIBSRC = $(XTOP)/../contrib
-   UNSUPPORTEDSRC = $(XTOP)/unsupported
-           DOCSRC = $(XTOP)/doc
-           RGBSRC = $(XTOP)/programs/rgb
-      BDFTOPCFSRC = $(PROGRAMSRC)/bdftopcf
-     MKFONTDIRSRC = $(PROGRAMSRC)/mkfontdir
-    FONTSERVERSRC = $(PROGRAMSRC)/xfs
-       FONTINCSRC = $(XTOP)/include/fonts
-        EXTINCSRC = $(XTOP)/include/extensions
-      FTSOURCEDIR = $(TOP)/extras/FreeType
-     XTTSOURCEDIR = $(TOP)/extras/X-TrueType
-       MESASRCDIR = $(TOP)/extras/Mesa
-  OGLSAMPLESRCDIR = $(TOP)/extras/ogl-sample
-        PSWRAPSRC = $(XTOP)/config/pswrap
-     TRANSCOMMSRC = $(LIBSRC)/xtrans
-   TRANS_INCLUDES = -I$(TRANSCOMMSRC)
- CONNECTION_FLAGS = -DUNIXCONN -DTCPCONN $(STICKY_DEFINES) $(FCHOWN_DEFINES) -DIPv6
-
-      XORGMANDEFS = -D__xorgversion__='"$(XORGRELSTRING)" "$(XORGMANNAME)"'
-    VENDORMANDEFS = -D__vendorversion__="$(VENDORMANVERSION) $(VENDORMANNAME)"
-
-       XENVLIBDIR = $(TOP)/exports/lib
-   CLIENTENVSETUP = LD_LIBRARY_PATH=$(XENVLIBDIR)
-
-# $Xorg: lnxLib.tmpl,v 1.3 2000/08/17 19:41:47 cpqbld Exp $
-# $XFree86: xc/config/cf/lnxLib.tmpl,v 3.20 2003/11/04 01:59:31 dawes Exp $
-
-          XLIBSRC = $(LIBSRC)/X11
-
-SOXLIBREV = 6.2
-DEPXONLYLIB =
-XONLYLIB =  -lX11
-
-LINTXONLY = $(XLIBSRC)/llib-X11.ln
-
-      DEPXLIBONLY = $(DEPXONLYLIB)
-         XLIBONLY = $(XONLYLIB)
-
-      RDPEXTLIBSRC = $(LIBSRC)/RdpExt
-
-SORDPEXTREV = 2.0
-DEPRDPEXTLIB =
-RDPEXTLIB =  -lRdpExt
-
-LINTRDPEXT = $(RDPEXTLIBSRC)/llib-RdpExt.ln
-
-      XEXTLIBSRC = $(LIBSRC)/Xext
-
-SOXEXTREV = 6.4
-DEPEXTENSIONLIB =
-EXTENSIONLIB =  -lXext
-
-LINTEXTENSION = $(XEXTLIBSRC)/llib-Xext.ln
-
-LINTEXTENSIONLIB = $(LINTEXTENSION)
-          DEPXLIB = $(DEPEXTENSIONLIB) $(DEPXONLYLIB)
-             XLIB = $(EXTENSIONLIB) $(XONLYLIB)
-         LINTXLIB = $(LINTXONLYLIB)
-
-    XSSLIBSRC = $(LIBSRC)/Xss
-
-DEPXSSLIB = $(TOP)/exports/lib/libXss.a
-XSSLIB =  -lXss
-
-LINTXSS = $(XSSLIBSRC)/llib-Xss.ln
-
-    XXF86MISCLIBSRC = $(LIBSRC)/Xxf86misc
-
-DEPXXF86MISCLIB = $(TOP)/exports/lib/libXxf86misc.a
-XXF86MISCLIB =  -lXxf86misc
-
-LINTXXF86MISC = $(XXF86MISCLIBSRC)/llib-Xxf86misc.ln
-
-    XXF86VMLIBSRC = $(LIBSRC)/Xxf86vm
-
-DEPXXF86VMLIB = $(TOP)/exports/lib/libXxf86vm.a
-XXF86VMLIB =  -lXxf86vm
-
-LINTXXF86VM = $(XXF86VMLIBSRC)/llib-Xxf86vm.ln
-
-    XXF86DGALIBSRC = $(LIBSRC)/Xxf86dga
-
-DEPXXF86DGALIB = $(TOP)/exports/lib/libXxf86dga.a
-XXF86DGALIB =  -lXxf86dga
-
-LINTXXF86DGA = $(XXF86DGALIBSRC)/llib-Xxf86dga.ln
-
-    XXF86RUSHLIBSRC = $(LIBSRC)/Xxf86rush
-
-DEPXXF86RUSHLIB = $(TOP)/exports/lib/libXxf86rush.a
-XXF86RUSHLIB =  -lXxf86rush
-
-LINTXXF86RUSH = $(XXF86RUSHLIBSRC)/llib-Xxf86rush.ln
-
-    XVLIBSRC = $(LIBSRC)/Xv
-
-DEPXVLIB = $(TOP)/exports/lib/libXv.a
-XVLIB =  -lXv
-
-LINTXV = $(XVLIBSRC)/llib-Xv.ln
-
-    XVMCLIBSRC = $(LIBSRC)/XvMC
-
-DEPXVMCLIB = $(TOP)/exports/lib/libXvMC.a
-XVMCLIB =  -lXvMC
-
-LINTXVMC = $(XVMCLIBSRC)/llib-XvMC.ln
-
-    XINERAMALIBSRC = $(LIBSRC)/Xinerama
-
-DEPXINERAMALIB = $(TOP)/exports/lib/libXinerama.a
-XINERAMALIB =  -lXinerama
-
-LINTXINERAMA = $(XINERAMALIBSRC)/llib-Xinerama.ln
-
-    XRESLIBSRC = $(LIBSRC)/XRes
-
-DEPXRESLIB = $(TOP)/exports/lib/libXRes.a
-XRESLIB =  -lXRes
-
-LINTXRES = $(XRESLIBSRC)/llib-XRes.ln
-
-    DPSLIBSRC = $(LIBSRC)/dps
-
-DEPDPSLIB = $(TOP)/exports/lib/libdps.a
-DPSLIB =  -ldps
-
-LINTDPS = $(DPSLIBSRC)/llib-dps.ln
-
-    DPSTKLIBSRC = $(LIBSRC)/dpstk
-
-DEPDPSTKLIB = $(TOP)/exports/lib/libdpstk.a
-DPSTKLIB =  -ldpstk
-
-LINTDPSTK = $(DPSTKLIBSRC)/llib-dpstk.ln
-
-    PSRESLIBSRC = $(LIBSRC)/psres
-
-DEPPSRESLIB = $(TOP)/exports/lib/libpsres.a
-PSRESLIB =  -lpsres
-
-LINTPSRES = $(PSRESLIBSRC)/llib-psres.ln
-
-    GLULIBSRC = $(LIBSRC)/GLU
-
-DEPGLULIB = $(TOP)/exports/lib/libGLU.a
-GLULIB =  -lGLU
-
-LINTGLU = $(GLULIBSRC)/llib-GLU.ln
-
-    GLXLIBSRC = $(LIBSRC)/GL
-
-DEPGLXLIB = $(TOP)/exports/lib/libGL.a
-GLXLIB =  -lGL
-
-LINTGLX = $(GLXLIBSRC)/llib-GL.ln
-
-    GLWIDGETSRC = $(LIBSRC)/GLw
-
-DEPGLWLIB = $(TOP)/exports/lib/libGLw.a
-GLWLIB =  -lGLw
-
-LINTGLW = $(GLWIDGETSRC)/llib-GLw.ln
-
-    XRENDERLIBSRC = $(LIBSRC)/Xrender
-
-DEPXRENDERLIB = $(TOP)/exports/lib/libXrender.a
-XRENDERLIB =  -lXrender
-
-LINTXRENDER = $(XRENDERLIBSRC)/llib-Xrender.ln
-
-    XRANDRRLIBSRC = $(LIBSRC)/Xrandr
-
-DEPXRANDRLIB = $(TOP)/exports/lib/libXrandr.a
-XRANDRLIB =  -lXrandr
-
-LINTXRANDR = $(XRANDRLIBSRC)/llib-Xrandr.ln
-
-   XCURSORRLIBSRC = $(LIBSRC)/Xcursor
-
-DEPXCURSORLIB = $(TOP)/exports/lib/libXcursor.a
-XCURSORLIB =  -lXcursor
-
-LINTXCURSOR = $(XCURSORLIBSRC)/llib-Xcursor.ln
-
-   APPLEWMLIBSRC = $(LIBSRC)/apple
-
-DEPAPPLEWMLIB = $(TOP)/exports/lib/libAppleWM.a
-APPLEWMLIB =  -lAppleWM
-
-LINTAPPLEWM = $(APPLEWMLIBSRC)/llib-AppleWM.ln
-
-    XFONTCACHELIBSRC = $(LIBSRC)/Xfontcache
-
-SOXFONTCACHEREV = 1.2
-DEPXFONTCACHELIB =
-XFONTCACHELIB =  -lXfontcache
-
-LINTXFONTCACHE = $(XFONTCACHELIBSRC)/llib-Xfontcache.ln
-
-         XAUTHSRC = $(LIBSRC)/Xau
-
-DEPXAUTHLIB = $(TOP)/exports/lib/libXau.a
-XAUTHLIB =  -lXau
-
-LINTXAUTH = $(XAUTHSRC)/llib-Xau.ln
-
-      XDMCPLIBSRC = $(LIBSRC)/Xdmcp
-
-DEPXDMCPLIB = $(TOP)/exports/lib/libXdmcp.a
-XDMCPLIB =  -lXdmcp
-
-LINTXDMCP = $(XDMCPLIBSRC)/llib-Xdmcp.ln
-
-           XMUSRC = $(LIBSRC)/Xmu
-
-SOXMUREV = 6.2
-DEPXMULIB =
-XMULIB =  -lXmu
-
-LINTXMU = $(XMUSRC)/llib-Xmu.ln
-
-           XMUUSRC = $(LIBSRC)/Xmuu
-
-SOXMUUREV = 1.0
-DEPXMUULIB =
-XMUULIB =  -lXmuu
-
-LINTXMUU = $(XMUUSRC)/llib-Xmuu.ln
-
-       OLDXLIBSRC = $(LIBSRC)/oldX
-
-DEPOLDXLIB = $(TOP)/exports/lib/liboldX.a
-OLDXLIB =  -loldX
-
-LINTOLDX = $(OLDXLIBSRC)/llib-oldX.ln
-
-         XPLIBSRC = $(LIBSRC)/Xp
-
-SOXPREV = 6.2
-DEPXPLIB =
-XPLIB =  -lXp
-
-LINTXP = $(XPLIBSRC)/llib-Xp.ln
-
-       TOOLKITSRC = $(LIBSRC)/Xt
-
-SOXTREV = 6.0
-DEPXTOOLONLYLIB =
-XTOOLONLYLIB =  -lXt
-
-LINTXTOOLONLY = $(TOOLKITSRC)/llib-Xt.ln
-
-      DEPXTOOLLIB = $(DEPXTOOLONLYLIB) $(DEPSMLIB) $(DEPICELIB)
-         XTOOLLIB = $(XTOOLONLYLIB) $(SMLIB) $(ICELIB)
-     LINTXTOOLLIB = $(LINTXTOOLONLYLIB)
-
-       XALIBSRC = $(LIBSRC)/Xa
-
-SOXAREV = 1.0
-DEPXALIB =
-XALIB =  -lXa
-
-LINTXA = $(XALIBSRC)/llib-Xa.ln
-
-       AWIDGETSRC = $(LIBSRC)/Xaw
-
-SOXAWREV = 7.0
-DEPXAWLIB =
-XAWLIB =  -lXaw
-
-LINTXAW = $(AWIDGETSRC)/llib-Xaw.ln
-
-       AWIDGET6SRC = $(LIBSRC)/Xaw6
-
-SOXAW6REV = 6.1
-DEPXAW6LIB =
-XAW6LIB =  -lXaw
-
-LINTXAW6 = $(AWIDGET6SRC)/llib-Xaw.ln
-
-         XILIBSRC = $(LIBSRC)/Xi
-
-SOXINPUTREV = 6.0
-DEPXILIB =
-XILIB =  -lXi
-
-LINTXI = $(XILIBSRC)/llib-Xi.ln
-
-      XTESTLIBSRC = $(LIBSRC)/Xtst
-
-SOXTESTREV = 6.1
-DEPXTESTLIB =
-XTESTLIB =  -lXtst
-
-LINTXTEST = $(XTESTLIBSRC)/llib-Xtst.ln
-
-DEPXBSDLIB = $(TOP)/exports/lib/libXbsd.a
-XBSDLIB =  -lXbsd
-
-LINTXBSD = $(LIBSRC)/Xbsd/llib-Xbsd.ln
-
-           ICESRC = $(LIBSRC)/ICE
-
-SOICEREV = 6.3
-DEPICELIB =
-ICELIB =  -lICE
-
-LINTICE = $(ICESRC)/llib-ICE.ln
-
-            SMSRC = $(LIBSRC)/SM
-
-SOSMREV = 6.0
-DEPSMLIB =
-SMLIB =  -lSM
-
-LINTSM = $(SMSRC)/llib-SM.ln
-
-           XKEYSRC = $(LIBSRC)/Xkey
-
-SOXKEYREV = 6.0
-DEPXKEYLIB =
-XKEYLIB =  -lXkey
-
-LINTXKEY = $(XKEYSRC)/llib-Xkey.ln
-
-         FSLIBSRC = $(LIBSRC)/FS
-
-SOFSREV = 6.0
-DEPFSLIB =
-FSLIB =  -lFS
-
-LINTFS = $(FSLIBSRC)/llib-FS.ln
-
-         FONTLIBSRC = $(LIBSRC)/font
-
-SOFONTREV = 1.5
-DEPFONTLIB =
-FONTLIB = -L$(FREETYPELIBDIR) -L$(FONTLIBSRC)  -lXfont
-
-LINTXFONT = $(FONTLIBSRC)/llib-Xfont.ln
-#
-SOFONTREV = 1.5
-DEPXFONTLIB =
-XFONTLIB =  -lXfont
-
-LINTXFONT = $(FONTLIBSRC)/llib-Xfont.ln
-
-     FONTSTUBLIBSRC = $(FONTLIBSRC)/stubs
-
-DEPFONTSTUBLIB = $(TOP)/exports/lib/libfntstubs.a
-FONTSTUBLIB =  -lfntstubs
-
-LINTFONTSTUB = $(FONTSUBLIBSRC)/llib-fntstubs.ln
-         DEPFONTLIB = $(DEPXFONTLIB) $(DEPFONTSTUBLIB)
-            FONTLIB = $(XFONTLIB) $(FONTSTUBLIB) $(FREETYPE2LIB)
-
-         FONTENCLIBSRC = $(LIBSRC)/fontenc
-
-SOFONTENCREV = 1.0
-DEPXFONTENCLIB =
-XFONTENCLIB =  -lfontenc
-
-LINTXFONTENC = $(FONTENCLIBSRC)/llib-fontenc.ln
-
-          XPMLIBSRC = $(LIBSRC)/Xpm
-
-SOXPMREV = 4.11
-DEPXPMLIB =
-XPMLIB =  -lXpm
-
-LINTXPM = $(XPMLIBSRC)/llib-Xpm.ln
-
-          FREETYPE2LIBSRC = $(LIBSRC)/freetype2
-
-SOFREETYPE2REV = 6.3
-DEPFREETYPE2LIB =
-FREETYPE2LIB =  -lfreetype
-
-LINTFREETYPE2 = $(FREETYPE2LIBSRC)/llib-freetype.ln
-
-FREETYPE2INCDIR=$(BUILDINCDIR)
-
-FREETYPE2INCLUDES = -I$(FREETYPE2INCDIR) -I$(FREETYPE2INCDIR)/freetype2
-
-FREETYPE2DEFINES = -DFREETYPE2
-
-          EXPATLIBSRC = $(LIBSRC)/expat
-
-SOEXPATREV = 0.4
-DEPEXPATLIB =
-EXPATLIB =  -lexpat
-
-LINTEXPAT = $(EXPATLIBSRC)/llib-expat.ln
-
-          XFT1LIBSRC = $(LIBSRC)/Xft1
-
-SOXFT1REV = 1.1
-DEPXFT1LIB =
-XFT1LIB =  -lXft
-
-LINTXFT1 = $(XFT1LIBSRC)/llib-Xft.ln
-
-          XFTLIBSRC = $(LIBSRC)/Xft
-
-SOXFTREV = 2.1
-DEPXFTLIB =
-XFTLIB =  -lXft
-
-LINTXFT = $(XFTLIBSRC)/llib-Xft.ln
-
-XFTINCLUDES=$(FONTCONFIGINCLUDES) $(FREETYPE2INCLUDES)
-
-LIBPNGINCDIR = /usr/include
-
-LIBPNGINC=
-
-LIBPNGDIR = /usr
-LIBPNGLIBDIR = /usr/lib
-LIBPNGINCDIR = /usr/include
-
-LIBPNGLIB = -lpng
-
-    XKBFILELIBSRC = $(LIBSRC)/xkbfile
-
-SOXKBFILEREV =  1.0
-DEPXKBFILELIB =
-XKBFILELIB =  -lxkbfile
-
-LINTXKBFILE = $(XKBFILESRC)/llib-xkbfile.ln
-
-     XKBCOMPSRC = $(PROGRAMSRC)/xkbcomp
-
-     XKBCOMPCMD = $(CLIENTENVSETUP) $(PRELOADSETUP) $(XBUILDBINDIR)/xkbcomp
-
-    XKBUILIBSRC = $(LIBSRC)/xkbui
-
-SOXKBUIREV =  1.0
-DEPXKBUILIB =
-XKBUILIB =  -lxkbui
-
-LINTXKBUI = $(XKBUISRC)/llib-xkbui.ln
-
-        XTRAPLIBSRC = $(LIBSRC)/XTrap
-
-SOXTRAPREV = 6.4
-DEPXTRAPLIB =
-XTRAPLIB =  -lXTrap
-
-LINTXTRAP = $(XTRAPLIBSRC)/llib-XTrap.ln
-
-          DEPLIBS = $(DEPXAWLIB) $(DEPXMULIB) $(DEPXTOOLLIB) $(DEPXLIB)
-
-         DEPLIBS1 = $(DEPLIBS)
-         DEPLIBS2 = $(DEPLIBS)
-         DEPLIBS3 = $(DEPLIBS)
-         DEPLIBS4 = $(DEPLIBS)
-         DEPLIBS5 = $(DEPLIBS)
-         DEPLIBS6 = $(DEPLIBS)
-         DEPLIBS7 = $(DEPLIBS)
-         DEPLIBS8 = $(DEPLIBS)
-         DEPLIBS9 = $(DEPLIBS)
-         DEPLIBS10 = $(DEPLIBS)
-
-      FT2PRELOADPATTERN = libfreetype.so.?
-
-       FCPRELOADPATTERN = libfontconfig.so.?
-
-      XFTPRELOADPATTERN = libXft.so.?
-  XRENDERPRELOADPATTERN = libXrender.so.?
-    XFONTPRELOADPATTERN = libXfont*.so.?
-
-INSTALLED_INCLUDES = -I$(INCROOT)
-
-INSTALLED_LIBS = -L$(USRLIBDIR)
-
-XMULIBONLY = -lXmu
-XMULIB = $(XMULIBONLY) $(XTOOLLIB) $(XLIB)
-
-        CONFIGDIR = $(LIBDIR)/config
-
-    USRLIBDIRPATH = $(USRLIBDIR)
-        LDPRELIBS = -L$(BUILDLIBDIR)  $(INSTALLED_LIBS)
-       LDPOSTLIBS =
-     TOP_INCLUDES = -I$(TOP) $(TOP_X_INCLUDES)
-  PROJECT_DEFINES =
-
-CXXPROJECT_DEFINES =
-
-# ----------------------------------------------------------------------
-# start of Imakefile
-
-# $Xorg: Imakefile,v 1.4 2001/03/14 18:42:02 pookie Exp $
-
-# $XFree86: xc/programs/Xserver/Imakefile,v 3.296 2003/11/23 06:47:00 torrey Exp $
-
-# $XFree86: xc/config/cf/Server.tmpl,v 3.21 2003/04/15 03:59:03 dawes Exp $
-
-# $Xorg: Server.tmpl,v 1.3 2000/08/17 19:41:46 cpqbld Exp $
-
-         CC = gcc -m32
-
-  CCOPTIONS = -ansi -pedantic -Wall -Wpointer-arith -Wstrict-prototypes 			  -Wmissing-prototypes -Wmissing-declarations 			  -Wredundant-decls -Wnested-externs -Wundef
-
-STD_DEFINES = -Dlinux -D__i386__ -D_POSIX_C_SOURCE=199309L 				-D_POSIX_SOURCE -D_XOPEN_SOURCE 				-D_BSD_SOURCE -D_SVID_SOURCE 				 -D_GNU_SOURCE 				 -DSHAPE -DXINPUT -DXKB -DLBX -DXAPPGROUP 	-DXCSECURITY -DTOGCUP  	-DXF86BIGFONT -DDPMSExtension 	  -DPANORAMIX 	 -DRENDER -DRANDR -DGCCUSESGAS -DAVOID_GLYPHBLT -DPIXPRIV -DSINGLEDEPTH 				-DXFreeXDGA -DXvExtension 				-DXFree86LOADER  -DXFree86Server 				-DXF86VIDMODE 				-DXvMCExtension 				-DSMART_SCHEDULE 				-DBUILDDEBUG -DXResExtension 				-DX_BYTE_ORDER=$(X_BYTE_ORDER) -DNDEBUG  $(SERVER_THREAD_DEFINES)
-CDEBUGFLAGS = -O2 -fno-strength-reduce
-EXT_DEFINES =  -DMITMISC -DXTEST -DXTRAP 	-DXSYNC -DXCMISC -DXRECORD 	-DMITSHM -DBIGREQS -DXF86VIDMODE 	-DXF86MISC -DDBE -DDPMSExtension -DEVI 	-DSCREENSAVER -DXV -DXVMC 	-DGLXEXT  -DGLX_USE_MESA  -DFONTCACHE          -DRES
-OS_DEFINES  = -DDDXOSINIT -DSERVER_LOCK -DDDXOSFATALERROR 				-DDDXOSVERRORF -DDDXTIME -DPART_NET
-
-GLX_DEFINES = -DGLXEXT  -DGLX_USE_MESA
-
-# $Xorg: xf86.tmpl,v 1.3 2000/08/17 19:41:48 cpqbld Exp $
-
-# $XFree86: xc/config/cf/xf86.tmpl,v 3.33 2002/12/16 23:01:43 herrb Exp $
-
-BUILDERADDR = "xfree86@xfree86.org"
-
-BUGMSG = -DBUILDERADDR='$(BUILDERADDR)'
-
-MODULE_GCC_FLAGS2 = -fno-merge-constants
-
-MODULE_GCC_FLAGS = $(MODULE_GCC_FLAGS1) $(MODULE_GCC_FLAGS2)
-
-MODULE_CFLAGS = $(MODULE_PIC_FLAGS) $(MODULE_GCC_FLAGS)
-
-INSTPGMFLAGS =
-
-      DRILIB =
-
-      GLXLIB = GL/glx/libglx.a                GL/mesa/GLcore/libGLcore.a
-
-      GLXDIR = GL
-      GLXEXT = $(GLXLIB)
-
-      XINPUTEXT = Xi/libxinput.a
-          XIDIR = Xi
-
-         XKBEXT = xkb/libxkb.a
-         XKBDIR = xkb
-
-    XF86XKBOBJS = xkb/xf86KillSrv.o xkb/xf86VT.o xkb/xf86Private.o
-
-         LBXEXT = lbx/liblbx.a                   $(TOP)/lib/lbxutil/liblbxutil.a
-
-        LBXDIRS = lbx
-
-         DBEEXT = dbe/libdbe.a
-
-         DBEDIR = dbe
-
-      RECORDEXT = record/librecord.a
-
-      RECORDDIR = record
-
-       XTRAPEXT = XTrap/libxtrap.a
-       XTRAPDIR = XTrap
-
-          LIBDL = -rdynamic -ldl
-
-       LIBREGEX =
-
-    LIBCWRAPPER = os/libcwrapper.o
-
-#       XPFBLIBS = dix/libxpstubs.a
-       XPFBLIBS =
-
-      RENDERDIR = render
-      RENDERLIB = $(RENDERDIR)/librender.a
-
-      RANDRDIR = randr
-      RANDRLIB = $(RANDRDIR)/librandr.a
-
-     EXTENSIONS = $(OTHEREXTS) $(RANDRLIB) $(RENDERLIB)
-   LOADABLEEXTS = $(MISCEXT) $(DBEEXT) $(RECORDEXT) $(GLXEXT) $(XTRAPEXT)
-        MISCEXT = Xext/libext.a
-      OTHEREXTS = Xext/libexts.a $(XKBEXT) $(XINPUTEXT)                   $(LBXEXT) $(SITEEXTS)
-
-        EXTDIRS = Xext $(XKBDIR) $(XIDIR) $(GLXDIR)                   $(LBXDIRS) $(DBEDIR) $(RECORDDIR) $(SITEEXTDIRS)                   $(RANDRDIR) $(RENDERDIR) $(XTRAPDIR)
-
-           ZLIB = -lz
-
-             OS = os/libos.a
-        BSDEMUL = $(DEPXBSDLIB)
-
-            MFB = mfb/libmfb.a
-             FB = fb/libfb.a
-            CFB = cfb/libcfb.a 		  cfb16/libcfb16.a 		  cfb24/libcfb24.a 		  cfb32/libcfb32.a
-
-           CFB8 = cfb/libcfb.a
-           CFB4 = cfb/libcfb.a 		  cfb4/libcfb4.a
-
-          CFB16 = cfb/libcfb.a 		  cfb16/libcfb16.a
-
-          CFB24 = cfb/libcfb.a 		  cfb24/libcfb24.a
-
-          CFB32 = cfb/libcfb.a 		  cfb32/libcfb32.a
-
-         SHADOW = miext/shadow/libshadow.a
-          LAYER = miext/layer/liblayer.a
-
-             MI = mi/libmi.a
-   MIINITEXTOBJ = mi/miinitext.o
-            DIX = dix/libdix.a
-       FONTBASE = $(FONTLIBSRC)/fontbase.o 		  $(FONTLIBSRC)/libfontbase.a
-
-           FONT = $(FONTLIBSRC)/libXfont.a $(FREETYPE2LIB)
-
-       FONTLIBS = $(FONT) $(XPFBLIBS)
-
-   EXTRASYSLIBS =
-
-        SYSLIBS = $(ZLIB) -lm  $(DBMLIBS) $(USB) 		  $(PAMLIBS)  $(XAUTHLIB) $(XDMCPLIB) $(EXTRASYSLIBS)
-
-        STDDIRS = include dix os mi $(XPDDXDIR) $(EXTDIRS)
-          FBDIR = fb
-         MFBDIR = mfb
-        CFB4DIR = cfb4
-        CFB8DIR = cfb
-       CFB16DIR = cfb16
-       CFB24DIR = cfb24
-       CFB32DIR = cfb32
-         AFBDIR = afb
-
-#
-# This turns off the default rule for compiling .c files because
-# this makefile does not really know how to build it.  This is really
-# just a hack because of the Sun version of make and nfs.
-#
-.c.o:
-
-.s.o:
-
-#
-# XFree86 Server
-#
-FBSUBDIR = fb
-MFBSUBDIR  = mfb
-CFB8SUBDIR = cfb
-CFB16SUBDIR = cfb16
-CFB24SUBDIR = cfb24
-CFB32SUBDIR = cfb32
-SHADOWDIR = miext/shadow
-LAYERDIR = miext/layer
-
-AFBSUBDIR = afb
-
-XFREE86DDXDIR  = hw/xfree86
-XF86SERVERSUBDIRS = $(STDDIRS) $(MFBDIR) $(FBDIR) $(AFBDIR) 		    $(CFB8DIR) $(CFB16DIR) $(CFB24DIR) $(CFB32DIR) 		    $(SHADOWDIR) $(LAYERDIR) $(XFREE86DDXDIR) $(DEPDIRS)
-
-XF86INIT   = $(XF86COMSRC)/xf86Init.o $(XF86COMSRC)/xf86IniExt.o
-XF86COMLIB = $(XF86COMSRC)/libxf86.a
-XF86PARSLIB= $(XF86PARSERSRC)/libxf86config.a
-XF86OSLIB  = $(XF86OSSRC)/libxf86_os.a
-
-XF86XAALIB = $(XF86SRC)/xaa/libxaa.a
-
-XF86VGAHWLIB = $(XF86SRC)/vgahw/libvgahw.a
-
-XF86FBDEVHWLIB = $(XF86SRC)/fbdevhw/libfbdevhw.a
-
-XF1BPPLIB = $(XF86SRC)/xf1bpp/libxf1bpp.a
-
-XF4BPPLIB = $(XF86SRC)/xf4bpp/libxf4bpp.a
-
-XF8_32BPPLIB = $(XF86SRC)/xf8_32bpp/libxf8_32bpp.a
-
-XF8_16BPPLIB = $(XF86SRC)/xf8_16bpp/libxf8_16bpp.a
-
-XF24_32BPPLIB = $(XF86SRC)/xf24_32bpp/libxf24_32bpp.a
-
-XFSHADOWFBLIB = $(XF86SRC)/shadowfb/libshadowfb.a
-
-AFBLIB = afb/libafb.a
-
-XF86DRIVERLIB = $(XF86SRC)/drivers/libdriver.a
-
-XF86RAMDACLIB = $(XF86SRC)/ramdac/libramdac.a
-
-XF86I2CLIB = $(XF86SRC)/i2c/libi2c.a
-
-XF86DDCLIB = $(XF86SRC)/ddc/libddc.a
-
-XF86VBELIB = $(XF86SRC)/vbe/libvbe.a
-
-XF86RACLIB = $(XF86SRC)/rac/librac.a
-
-XF86INT10LIB = $(XF86OSSRC)/libint10.a
-
-XF86RDPLIBS=$(XF86SRC)/rdp/librdp.a -L/usr/local/lib
-
-XF86IDRIVERLIB = $(XF86SRC)/input/libidriver.a
-
-XF86LIBS  = $(MEMDEBUGLIB) $(XF86INIT) $(XF86COMLIB) 	    $(XF86PARSLIB) $(XF86OSLIB)
-
-XF86LOADERLIB = $(XF86SRC)/loader/libloader.a
-XF86MAINLIBS = $(DIX) $(OS) 	       $(FONTBASE) $(OTHEREXTS) $(XF86COMLIB) 	       $(EXTENSIONS) $(XPFBLIBS) $(MI) $(EXTENSIONS)
-
-XF86SERVERSYSLIBS = $(SYSLIBS) $(LIBDL) $(LIBREGEX)
-XF86SERVERLIBS = $(XF86DRVLIBS) $(XF86IDRVLIBS) $(XF86LIBS) $(XF86LOADERLIB) 		 $(XF86COMLIB) $(XF86MAINLIBS) $(XF86SCANLIB) $(XF86OSLIB)
-
-XF86SERVEROBJS = $(XF86XKBOBJS) $(XF86DRVOBJS) $(XF86IDRVOBJS)
-
-$(XF86SERVERLIBS) $(XF86SERVERSYSLIBS):: $(XF86SERVERSUBDIRS)
-	@if [ -f $@ ]; then touch $@ >/dev/null 2>&1 || exit 0; fi
-
-all:: XFree86
-XFree86: $(XF86SERVERSUBDIRS) $(XF86SERVEROBJS) $(SERVERDEFFILE)  	$(XF86SERVERLIBS)
-	-@if [ -f $@ ]; then set -x; \
-	$(MV) $@ $@.bak; else exit 0; fi
-	$(CCLINK) -o $@ $(LDOPTIONS) $(XF86SERVEROBJS) $(SERVERDEFFILE)  	$(XF86SERVERLIBS) $(LDLIBS) $(XF86SERVERSYSLIBS) $(EXTRA_LOAD_FLAGS)
-
-loadXFree86:
-	-@if [ -f XFree86 ]; then set -x; \
-	$(MV) XFree86 XFree86.bak; else exit 0; fi
-	$(CCLINK) -o XFree86 $(LDOPTIONS) $(XF86SERVEROBJS) $(SERVERDEFFILE)  	$(XF86SERVERLIBS) $(LDLIBS) $(XF86SERVERSYSLIBS) $(EXTRA_LOAD_FLAGS)
-
-loadX:: loadXFree86
-
-install:: XFree86
-	@if [ -d $(DESTDIR)$(BINDIR) ]; then \
-		set +x; \
-	else \
-		if [ -h $(DESTDIR)$(BINDIR) ]; then \
-			(set -x; rm -f $(DESTDIR)$(BINDIR)); \
-		fi; \
-		(set -x; $(MKDIRHIER) $(DESTDIR)$(BINDIR)); \
-	fi
-	$(INSTALL) $(INSTALLFLAGS) $(INSTPGMFLAGS) $(INSTUIDFLAGS) XFree86 $(DESTDIR)$(BINDIR)/XFree86
-
-cleandir::
-	$(RM) XFree86
-
-install.sdk:: XFree86
-	@if [ -d $(DESTDIR)$(DRIVERSDKDIR) ]; then \
-		set +x; \
-	else \
-		if [ -h $(DESTDIR)$(DRIVERSDKDIR) ]; then \
-			(set -x; rm -f $(DESTDIR)$(DRIVERSDKDIR)); \
-		fi; \
-		(set -x; $(MKDIRHIER) $(DESTDIR)$(DRIVERSDKDIR)); \
-	fi
-	$(INSTALL) $(INSTALLFLAGS) $(INSTPGMFLAGS) $(_NOOP_) XFree86 $(DESTDIR)$(DRIVERSDKDIR)/XFree86
-
-#
-# RDP X server
-#
-MFBSUBDIR = mfb
-FBSUBDIR  = fb
-RDPDDXDIR = hw/rdp
-XRDPDIRS = $(STDDIRS) $(MFBDIR) $(FBDIR) $(RDPDDXDIR) $(DEPDIRS)
-XRDPOBJS =
-RDPLIBS =
-XRDP = $(OTHEREXTS) hw/rdp/librdp.a $(RDPLIBS) $(OTHEREXTS)
-#XRDPLIBS = $(LIBCWRAPPER) $(DIX) $(OS) $(XPDDX) $(XRDP) $(MFB) $(FB) $(MFB) $(XPFBLIBS) $(MI) $(EXTENSIONS)
-XRDPLIBS = $(DIX) $(OS) $(XPDDX) $(XRDP) $(MFB) $(FB) $(MFB) $(XPFBLIBS) $(MI) $(EXTENSIONS)
-XRDPSYSLIBS = $(FONTLIBS) $(SYSLIBS) $(RDPSYSLIBS) $(LOADABLEEXTS)
-
-all:: X11rdp
-X11rdp: $(XRDPDIRS) $(XRDPOBJS)  	$(XRDPLIBS)
-	-@if [ -f $@ ]; then set -x; \
-	$(MV) $@ $@.bak; else exit 0; fi
-	$(CCLINK) -o $@ $(LDOPTIONS) $(XRDPOBJS)  	$(XRDPLIBS) $(LDLIBS) $(XRDPSYSLIBS) $(FONTLIBS) -L/usr/local/lib $(EXTRA_LOAD_FLAGS)
-
-loadXrdp:
-	-@if [ -f X11rdp ]; then set -x; \
-	$(MV) X11rdp X11rdp.bak; else exit 0; fi
-	$(CCLINK) -o X11rdp $(LDOPTIONS) $(XRDPOBJS)  	$(XRDPLIBS) $(LDLIBS) $(XRDPSYSLIBS) $(FONTLIBS) -L/usr/local/lib $(EXTRA_LOAD_FLAGS)
-
-loadX:: loadXrdp
-
-install:: X11rdp
-	@if [ -d $(DESTDIR)$(BINDIR) ]; then \
-		set +x; \
-	else \
-		if [ -h $(DESTDIR)$(BINDIR) ]; then \
-			(set -x; rm -f $(DESTDIR)$(BINDIR)); \
-		fi; \
-		(set -x; $(MKDIRHIER) $(DESTDIR)$(BINDIR)); \
-	fi
-	$(INSTALL) $(INSTALLFLAGS) $(INSTPGMFLAGS) $(_NOOP_) X11rdp $(DESTDIR)$(BINDIR)/X11rdp
-
-cleandir::
-	$(RM) X11rdp
-
-CFBSUBDIRS = $(CFB8SUBDIR) $(CFB16SUBDIR) $(CFB24SUBDIR) $(CFB32SUBDIR)
-MIEXTDIRS = $(SHADOWDIR) $(LAYERDIR) $(ROOTLESSDIR)
-IPLANDIRS = $(IPLAN2P2DIR) $(IPLAN2P4DIR) $(IPLAN2P8DIR)
-DDXDIRS = $(DECWSDDXDIR) $(SUNDDXDIR) $(LYNXDDXDIR) 	  $(HPDDXDIR) $(XFREE86DDXDIR) $(XWINDDXDIR) $(DARWINDDXDIR) 	  $(XVFBDDXDIR) $(XNESTDDXDIR) $(RDPDDXDIR)
-
-SUBDIRS = $(STDDIRS) $(MFBSUBDIR) $(CFBSUBDIRS) 	  $(IPLANDIRS) $(ILBMDIR) $(AFBSUBDIR)           $(LMFCFBDIR) $(DDXDIRS) $(FBSUBDIR) $(KDRIVEDIRS) $(MIEXTDIRS) 	  $(XWINPARSERDIR)
-
-install::
-	-(cd $(DESTDIR)$(BINDIR); $(RM) X; $(LN) XFree86 X)
-
-depend::
-	@for flag in ${MAKEFLAGS} ''; do \
-	  case "$$flag" in *=*) ;; --*) ;; *[ik]*) set +e;; esac; done; \
-	for i in $(SUBDIRS) ;\
-	do \
-		echo "depending" "in $(CURRENT_DIR)/$$i..."; \
-		$(MAKE) -C $$i $(MFLAGS) $(PARALLELMFLAGS)  depend; \
-	done
-
-lintlib::
-	@for flag in ${MAKEFLAGS} ''; do \
-	  case "$$flag" in *=*) ;; --*) ;; *[ik]*) set +e;; esac; done; \
-	for i in $(SUBDIRS) ;\
-	do \
-		echo "linting" for lintlib and lintlib "in $(CURRENT_DIR)/$$i..."; \
-		$(MAKE) -C $$i $(MFLAGS) $(PARALLELMFLAGS) DESTDIR=$(DESTDIR) LINTOPTS='$(LINTOPTS)' lintlib; \
-	done
-
-lint::
-	@for flag in ${MAKEFLAGS} ''; do \
-	  case "$$flag" in *=*) ;; --*) ;; *[ik]*) set +e;; esac; done; \
-	for i in $(SUBDIRS) ;\
-	do \
-		echo "linting" for lint and lint "in $(CURRENT_DIR)/$$i..."; \
-		$(MAKE) -C $$i $(MFLAGS) $(PARALLELMFLAGS) DESTDIR=$(DESTDIR) LINTOPTS='$(LINTOPTS)' lint; \
-	done
-
-$(DEPDIRS) $(SUBDIRS): FRC
-	@echo "making all in $(CURRENT_DIR)/$@..."
-	@$(MAKE) -C $@ $(MFLAGS) $(PARALLELMFLAGS) CDEBUGFLAGS="$(CDEBUGFLAGS)" LDSTRIPFLAGS="$(LDSTRIPFLAGS)" all
-
-FRC:
-
-all:: Xserver.$(MANSUFFIX).html
-
-Xserver.$(MANSUFFIX).html: Xserver.$(MANNEWSUFFIX) $(RMAN)
-	$(RM) Xserver.$(MANSUFFIX).html Xserver.$(MANSUFFIX)-html
-	$(RMAN) $(RMANOPTIONS) < Xserver.$(MANNEWSUFFIX) \
-	  > Xserver.$(MANSUFFIX)-html && $(MV) Xserver.$(MANSUFFIX)-html $@
-
-install.man:: Xserver.$(MANSUFFIX).html
-	@if [ -d $(DESTDIR)$(DOCHTMLDIR) ]; then \
-		set +x; \
-	else \
-		if [ -h $(DESTDIR)$(DOCHTMLDIR) ]; then \
-			(set -x; rm -f $(DESTDIR)$(DOCHTMLDIR)); \
-		fi; \
-		(set -x; $(MKDIRHIER) $(DESTDIR)$(DOCHTMLDIR)); \
-	fi
-	@(SUF=`expr $(MANSUFFIX) \: '\(.\)'`; \
-	 set -x; \
-	 $(INSTALL) $(INSTALLFLAGS) $(INSTMANFLAGS) Xserver.$(MANSUFFIX).html $(DESTDIR)$(DOCHTMLDIR)/Xserver.$$SUF.html)
-
-cleandir::
-	$(RM) Xserver.$(MANSUFFIX).html Xserver.$(MANSUFFIX)-html
-
-all:: Xserver.$(MANNEWSUFFIX)
-
-Xserver.$(MANNEWSUFFIX)::  Xserver.$(MANSRCSUFFIX)
-	$(RM) $@
-	 	$(RAWCPP)  $(MANDEFS) $(EXTRAMANDEFS) <Xserver.$(MANSRCSUFFIX) | sed -e '/^#  *[0-9][0-9]*  *.*$$/d' 			-e '/^#line  *[0-9][0-9]*  *.*$$/d' 			-e '/^[ 	]*XCOMM$$/s/XCOMM/#/' 			-e '/^[ 	]*XCOMM[^a-zA-Z0-9_]/s/XCOMM/#/' 			-e '/^[ 	]*XHASH/s/XHASH/#/' 			-e '/\@\@$$/s/\@\@$$/\\/' >$@
-
-cleandir::
-	$(RM) Xserver.$(MANNEWSUFFIX)
-
-install.man:: Xserver.$(MANNEWSUFFIX)
-	@if [ -d $(DESTDIR)$(MANDIR) ]; then \
-		set +x; \
-	else \
-		if [ -h $(DESTDIR)$(MANDIR) ]; then \
-			(set -x; rm -f $(DESTDIR)$(MANDIR)); \
-		fi; \
-		(set -x; $(MKDIRHIER) $(DESTDIR)$(MANDIR)); \
-	fi
-	$(INSTALL) $(INSTALLFLAGS) $(INSTMANFLAGS) Xserver.$(MANNEWSUFFIX) $(DESTDIR)$(MANDIR)/Xserver.$(MANSUFFIX)
-
-# ----------------------------------------------------------------------
-# common rules for all Makefiles - do not edit
-
-.c.i:
-	$(RM) $@
-	 	$(CC) -E $(CFLAGS) $(_NOOP_) $*.c > $@
-
-.SUFFIXES: .ii
-
-.cc.ii:
-	$(RM) $@
-	 	$(CC) -E $(CFLAGS) $(_NOOP_) $*.cc > $@
-
-.SUFFIXES: .s
-
-.c.s:
-	$(RM) $@
-	 	$(CC) -S $(CFLAGS) $(_NOOP_) $*.c
-
-.cc.s:
-	$(RM) $@
-	 	$(CC) -S $(CFLAGS) $(_NOOP_) $*.cc
-
-emptyrule::
-
-cleandir::
-	$(RM) *.CKP *.ln *.BAK *.bak *.o core errs ,* *~ *.a .emacs_* tags TAGS make.log MakeOut   "#"*
-
-Makefile:: $(IMAKE)
-
-$(IMAKE) $(IMAKE).o:
-	-@(cd $(IMAKESRC) && if [ -f Makefile ]; then \
-	echo "checking $@ in $(IMAKESRC) first..."; $(MAKE) imakeonly; else \
-	echo "bootstrapping $@ from Makefile.ini in $(IMAKESRC) first..."; \
-	$(MAKE) -f Makefile.ini BOOTSTRAPCFLAGS="$(BOOTSTRAPCFLAGS)"; fi; \
-	echo "okay, continuing in $(CURRENT_DIR)")
-
-Makefile::
-	-@if [ -f Makefile ]; then set -x; \
-	$(RM) Makefile.bak; $(MV) Makefile Makefile.bak; \
-	else exit 0; fi
-	$(IMAKE_CMD) -DTOPDIR=$(TOP) -DCURDIR=$(CURRENT_DIR)
-
-$(RMAN):
-	@echo "checking $(RMANBASENAME) over in $(TOP)/config/util first..."; \
-	cd $(TOP)/config/util && $(MAKE) rmanonly; \
-	echo "okay, continuing in $(CURRENT_DIR)"
-
-tags::
-	$(TAGS) -w *.[ch]
-	$(TAGS) -xw *.[ch] > TAGS
-
-man_keywords::
-
-html_index::
-	$(HTMLINDEXCMD) $(DESTDIR)$(DOCHTMLDIR)
-
-clean:: cleandir
-
-distclean:: cleandir
-
-# ----------------------------------------------------------------------
-# rules for building in SUBDIRS - do not edit
-
-install::
-	@for flag in ${MAKEFLAGS} ''; do \
-	  case "$$flag" in *=*) ;; --*) ;; *[ik]*) set +e;; esac; done; \
-	for i in $(SUBDIRS) ;\
-	do \
-		echo "installing" "in $(CURRENT_DIR)/$$i..."; \
-		$(MAKE) -C $$i $(MFLAGS) $(PARALLELMFLAGS) DESTDIR=$(DESTDIR) install; \
-	done
-
-install.man::
-	@for flag in ${MAKEFLAGS} ''; do \
-	  case "$$flag" in *=*) ;; --*) ;; *[ik]*) set +e;; esac; done; \
-	for i in $(SUBDIRS) ;\
-	do \
-		echo "installing man pages" "in $(CURRENT_DIR)/$$i..."; \
-		$(MAKE) -C $$i $(MFLAGS) $(PARALLELMFLAGS) DESTDIR=$(DESTDIR) install.man; \
-	done
-
-install.sdk::
-	@for flag in ${MAKEFLAGS} ''; do \
-	  case "$$flag" in *=*) ;; --*) ;; *[ik]*) set +e;; esac; done; \
-	for i in $(SUBDIRS) ;\
-	do \
-		echo "installing driver SDK" "in $(CURRENT_DIR)/$$i..."; \
-		$(MAKE) -C $$i $(MFLAGS) $(PARALLELMFLAGS) DESTDIR='$(DESTDIR)' install.sdk; \
-	done
-
-clean::
-	@for flag in ${MAKEFLAGS} ''; do \
-	  case "$$flag" in *=*) ;; --*) ;; *[ik]*) set +e;; esac; done; \
-	for i in $(SUBDIRS) ;\
-	do \
-		echo "cleaning" "in $(CURRENT_DIR)/$$i..."; \
-		$(MAKE) -C $$i $(MFLAGS) $(PARALLELMFLAGS)  clean; \
-	done
-
-tags::
-	@for flag in ${MAKEFLAGS} ''; do \
-	  case "$$flag" in *=*) ;; --*) ;; *[ik]*) set +e;; esac; done; \
-	for i in $(SUBDIRS) ;\
-	do \
-		echo "tagging" "in $(CURRENT_DIR)/$$i..."; \
-		$(MAKE) -C $$i $(MFLAGS) $(PARALLELMFLAGS) TAGS='$(TAGS)' tags; \
-	done
-
-$(ONESUBDIR)/Makefile:
-	@for flag in ${MAKEFLAGS} ''; do \
-	  case "$$flag" in *=*) ;; --*) ;; *[n]*) executeit="no";; esac; done; \
-	cd $(ONESUBDIR) && \
-	if [ "$$executeit" != "no" ]; then \
-		$(IMAKEPREFIX)$(IMAKE) -I$(IMAKEPREFIX)$(IRULESRC) 			  $(IMAKE_DEFINES) $(IMAKE_WARNINGS) -DTOPDIR=$(IMAKETOP) -DCURDIR=$(ONECURDIR)$(ONESUBDIR); \
-	fi;
-
-Makefiles::
-	-@for flag in ${MAKEFLAGS} ''; do \
-	  case "$$flag" in *=*) ;; --*) ;; *[ik]*) set +e;; esac; done; \
-	for flag in ${MAKEFLAGS} ''; do \
-	  case "$$flag" in *=*) ;; --*) ;; *[n]*) executeit="no";; esac; done; \
-	for i in $(SUBDIRS) ;\
-	do \
-		case "$(CURRENT_DIR)" in \
-		.) curdir= ;; \
-		*) curdir=$(CURRENT_DIR)/ ;; \
-		esac; \
-		echo "making Makefiles in $$curdir$$i..."; \
-		itmp=`echo $$i | sed -e 's;^\./;;g' -e 's;/\./;/;g'`; \
-		curtmp="$(CURRENT_DIR)" \
-		toptmp=""; \
-		case "$$itmp" in \
-		    ../?*) \
-			while echo "$$itmp" | grep '^\.\./' > /dev/null;\
-			  do \
-			     toptmp="/`basename $$curtmp`$$toptmp"; \
-			     curtmp="`dirname $$curtmp`"; \
-			     itmp="`echo $$itmp | sed 's;\.\./;;'`"; \
-			  done \
-		    ;; \
-		esac; \
-		case "$$itmp" in \
-		*/?*/?*/?*/?*)	newtop=../../../../..;; \
-		*/?*/?*/?*)	newtop=../../../..;; \
-		*/?*/?*)	newtop=../../..;; \
-		*/?*)		newtop=../..;; \
-		*)		newtop=..;; \
-		esac; \
-		newtop="$$newtop$$toptmp"; \
-		case "$(TOP)" in \
-		/?*) imaketop=$(TOP) \
-		     imakeprefix= ;; \
-		.) imaketop=$$newtop \
-		   imakeprefix=$$newtop/ ;; \
-		*) imaketop=$$newtop/$(TOP) \
-		   imakeprefix=$$newtop/ ;; \
-		esac; \
-		$(RM) $$i/Makefile.bak; \
-		if [ -f $$i/Makefile ]; then \
-			echo "	$(MV) Makefile Makefile.bak"; \
-			if [ "$$executeit" != "no" ]; then \
-				$(MV) $$i/Makefile $$i/Makefile.bak; \
-			fi; \
-		fi; \
-		$(MAKE) $(MFLAGS) $(MAKE_OPTS) ONESUBDIR=$$i ONECURDIR=$$curdir IMAKETOP=$$imaketop IMAKEPREFIX=$$imakeprefix $$i/Makefile; \
-		if [ -d $$i ] ; then \
-			cd $$i; \
-			$(MAKE) $(MFLAGS) Makefiles; \
-			cd $$newtop; \
-		else \
-			exit 1; \
-		fi; \
-	done
-
-includes::
-	@for flag in ${MAKEFLAGS} ''; do \
-	  case "$$flag" in *=*) ;; --*) ;; *[ik]*) set +e;; esac; done; \
-	for i in $(SUBDIRS) ;\
-	do \
-		echo including "in $(CURRENT_DIR)/$$i..."; \
-		$(MAKE) -C $$i $(MFLAGS) $(PARALLELMFLAGS)  includes; \
-	done
-
-distclean::
-	@for flag in ${MAKEFLAGS} ''; do \
-	  case "$$flag" in *=*) ;; --*) ;; *[ik]*) set +e;; esac; done; \
-	for i in $(SUBDIRS) ;\
-	do \
-		echo "cleaning" "in $(CURRENT_DIR)/$$i..."; \
-		$(MAKE) -C $$i $(MFLAGS) $(PARALLELMFLAGS)  distclean; \
-	done
-
-distclean::
-	$(RM) Makefile Makefile.dep
-
-# ----------------------------------------------------------------------
-# dependencies generated by makedepend
-
diff --git a/bootstrap b/bootstrap
new file mode 100755
index 0000000..f8fbd29
--- /dev/null
+++ b/bootstrap
@@ -0,0 +1,25 @@
+#!/bin/sh
+
+which autoconf
+if ! test $? -eq 0
+then
+  echo "error, install autoconf"
+  exit 1
+fi
+
+which automake
+if ! test $? -eq 0
+then
+  echo "error, install automake"
+  exit 1
+fi
+
+which libtool
+if ! test $? -eq 0
+then
+  echo "error, install libtool"
+  exit 1
+fi
+
+touch configure.ac
+autoreconf -fvi
diff --git a/common/Makefile.am b/common/Makefile.am
new file mode 100644
index 0000000..8107e97
--- /dev/null
+++ b/common/Makefile.am
@@ -0,0 +1,16 @@
+lib_LTLIBRARIES = \
+  libcommon.la
+
+libcommon_la_SOURCES = \
+  d3des.c \
+  file.c \
+  list.c \
+  log.c \
+  os_calls.c \
+  ssl_calls.c \
+  thread_calls.c \
+  trans.c
+
+libcommon_la_LIBADD = \
+  -lcrypto \
+  -lpthread
diff --git a/common/arch.h b/common/arch.h
index 331b352..ec16bd7 100644
--- a/common/arch.h
+++ b/common/arch.h
@@ -1,5 +1,5 @@
 /*
-   Copyright (c) 2004-2007 Jay Sorg
+   Copyright (c) 2004-2008 Jay Sorg
 
    Permission is hereby granted, free of charge, to any person obtaining a
    copy of this software and associated documentation files (the "Software"),
@@ -27,11 +27,16 @@
 /* check endianess */
 #if defined(__sparc__) || defined(__PPC__) || defined(__ppc__)
 #define B_ENDIAN
-#elif __BYTE_ORDER == __LITTLE_ENDIAN
+#elif defined(__BYTE_ORDER)
+#if __BYTE_ORDER == __LITTLE_ENDIAN
 #define L_ENDIAN
 #elif __BYTE_ORDER == __BIG_ENDIAN
 #define B_ENDIAN
 #endif
+#else
+#define L_ENDIAN
+#endif
+
 /* check if we need to align data */
 #if defined(__sparc__) || defined(__alpha__) || defined(__hppa__) || \
     defined(__AIX__) || defined(__PPC__) || defined(__mips__) || \
@@ -48,7 +53,7 @@
 #define THREAD_CC
 #endif
 
-#if defined(__BORLANDC__)
+#if defined(__BORLANDC__) || defined(_WIN32)
 #define APP_CC __fastcall
 #define DEFAULT_CC __cdecl
 #else
@@ -57,10 +62,14 @@
 #endif
 
 #if defined(_WIN32)
+#if defined(__BORLANDC__)
 #define EXPORT_CC _export __cdecl
 #else
 #define EXPORT_CC
 #endif
+#else
+#define EXPORT_CC
+#endif
 
 typedef char ti8;
 typedef unsigned char tui8;
@@ -71,6 +80,23 @@ typedef signed short tsi16;
 typedef int ti32;
 typedef unsigned int tui32;
 typedef signed int tsi32;
+#if defined(_WIN64)
+/* Microsoft's VC++ compiler uses the more backwards-compatible LLP64 model.
+   Most other 64 bit compilers(Solaris, AIX, HP, Linux, Mac OS X) use
+   the LP64 model.
+   long is 32 bits in LLP64 model, 64 bits in LP64 model. */
+typedef __int64 tbus;
+#else
 typedef long tbus;
+#endif
+typedef tbus thandle;
+/* wide char, socket */
+#if defined(_WIN32)
+typedef unsigned short twchar;
+typedef unsigned int tsock;
+#else
+typedef int twchar;
+typedef int tsock;
+#endif
 
 #endif
diff --git a/common/defines.h b/common/defines.h
index f5e2e7d..050eb5a 100644
--- a/common/defines.h
+++ b/common/defines.h
@@ -14,7 +14,7 @@
    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
 
    xrdp: A Remote Desktop Protocol server.
-   Copyright (C) Jay Sorg 2004-2007
+   Copyright (C) Jay Sorg 2004-2008
 
    main define/macro file
 
diff --git a/common/file.c b/common/file.c
index 6d69d87..cf6f1e6 100644
--- a/common/file.c
+++ b/common/file.c
@@ -1,5 +1,5 @@
 /*
-   Copyright (c) 2004-2007 Jay Sorg
+   Copyright (c) 2004-2008 Jay Sorg
 
    Permission is hereby granted, free of charge, to any person obtaining a
    copy of this software and associated documentation files (the "Software"),
@@ -32,8 +32,8 @@
 /* returns error
    returns 0 if everything is ok
    returns 1 if problem reading file */
-int APP_CC
-file_read_sections(int fd, struct list* names)
+static int APP_CC
+l_file_read_sections(int fd, int max_file_size, struct list* names)
 {
   struct stream* s;
   char text[256];
@@ -51,8 +51,8 @@ file_read_sections(int fd, struct list* names)
   g_memset(text, 0, 256);
   list_clear(names);
   make_stream(s);
-  init_stream(s, 8192);
-  len = g_file_read(fd, s->data, 8192);
+  init_stream(s, max_file_size);
+  len = g_file_read(fd, s->data, max_file_size);
   if (len > 0)
   {
     s->end = s->p + len;
@@ -65,7 +65,7 @@ file_read_sections(int fd, struct list* names)
       }
       else if (c == ']')
       {
-        list_add_item(names, (long)g_strdup(text));
+        list_add_item(names, (tbus)g_strdup(text));
         in_it = 0;
         in_it_index = 0;
         g_memset(text, 0, 256);
@@ -154,6 +154,7 @@ file_read_line(struct stream* s, char* text)
 }
 
 /*****************************************************************************/
+/* returns error */
 static int APP_CC
 file_split_name_value(char* text, char* name, char* value)
 {
@@ -188,14 +189,16 @@ file_split_name_value(char* text, char* name, char* value)
       name[name_index] = 0;
     }
   }
+  g_strtrim(name, 3); /* trim both right and left */
+  g_strtrim(value, 3); /* trim both right and left */
   return 0;
 }
 
 /*****************************************************************************/
 /* return error */
-int APP_CC
-file_read_section(int fd, const char* section, struct list* names,
-                  struct list* values)
+static int APP_CC
+l_file_read_section(int fd, int max_file_size, const char* section,
+                    struct list* names, struct list* values)
 {
   struct stream* s;
   char text[512];
@@ -206,7 +209,9 @@ file_read_section(int fd, const char* section, struct list* names,
   int in_it_index;
   int len;
   int index;
+  int file_size;
 
+  file_size = 32 * 1024; /* 32 K file size limit */
   g_file_seek(fd, 0);
   in_it_index = 0;
   in_it = 0;
@@ -214,8 +219,8 @@ file_read_section(int fd, const char* section, struct list* names,
   list_clear(names);
   list_clear(values);
   make_stream(s);
-  init_stream(s, 8192);
-  len = g_file_read(fd, s->data, 8192);
+  init_stream(s, file_size);
+  len = g_file_read(fd, s->data, file_size);
   if (len > 0)
   {
     s->end = s->p + len;
@@ -236,8 +241,8 @@ file_read_section(int fd, const char* section, struct list* names,
             if (g_strlen(text) > 0)
             {
               file_split_name_value(text, name, value);
-              list_add_item(names, (long)g_strdup(name));
-              list_add_item(values, (long)g_strdup(value));
+              list_add_item(names, (tbus)g_strdup(name));
+              list_add_item(values, (tbus)g_strdup(value));
             }
           }
           free_stream(s);
@@ -257,3 +262,77 @@ file_read_section(int fd, const char* section, struct list* names,
   free_stream(s);
   return 1;
 }
+
+/*****************************************************************************/
+/* returns error
+   returns 0 if everything is ok
+   returns 1 if problem reading file */
+/* 32 K file size limit */
+int APP_CC
+file_read_sections(int fd, struct list* names)
+{
+  return l_file_read_sections(fd, 32 * 1024, names);
+}
+
+/*****************************************************************************/
+/* return error */
+/* this function should be prefered over file_read_sections because it can
+   read any file size */
+int APP_CC
+file_by_name_read_sections(const char* file_name, struct list* names)
+{
+  int fd;
+  int file_size;
+  int rv;
+
+  file_size = g_file_get_size(file_name);
+  if (file_size < 1)
+  {
+    return 1;
+  }
+  fd = g_file_open(file_name);
+  if (fd < 1)
+  {
+    return 1;
+  }
+  rv = l_file_read_sections(fd, file_size, names);
+  g_file_close(fd);
+  return rv;
+}
+
+/*****************************************************************************/
+/* return error */
+/* 32 K file size limit */
+int APP_CC
+file_read_section(int fd, const char* section,
+                  struct list* names, struct list* values)
+{
+  return l_file_read_section(fd, 32 * 1024, section, names, values);
+}
+
+/*****************************************************************************/
+/* return error */
+/* this function should be prefered over file_read_section because it can
+   read any file size */
+int APP_CC
+file_by_name_read_section(const char* file_name, const char* section,
+                          struct list* names, struct list* values)
+{
+  int fd;
+  int file_size;
+  int rv;
+
+  file_size = g_file_get_size(file_name);
+  if (file_size < 1)
+  {
+    return 1;
+  }
+  fd = g_file_open(file_name);
+  if (fd < 1)
+  {
+    return 1;
+  }
+  rv = l_file_read_section(fd, file_size, section, names, values);
+  g_file_close(fd);
+  return rv;
+}
diff --git a/common/file.h b/common/file.h
index 6f0dfc8..9482a79 100644
--- a/common/file.h
+++ b/common/file.h
@@ -1,5 +1,5 @@
 /*
-   Copyright (c) 2004-2007 Jay Sorg
+   Copyright (c) 2004-2008 Jay Sorg
 
    Permission is hereby granted, free of charge, to any person obtaining a
    copy of this software and associated documentation files (the "Software"),
@@ -30,7 +30,12 @@
 int APP_CC
 file_read_sections(int fd, struct list* names);
 int APP_CC
-file_read_section(int fd, const char* section, struct list* names,
-                  struct list* values);
+file_by_name_read_sections(const char* file_name, struct list* names);
+int APP_CC
+file_read_section(int fd, const char* section,
+                  struct list* names, struct list* values);
+int APP_CC
+file_by_name_read_section(const char* file_name, const char* section,
+                          struct list* names, struct list* values);
 
 #endif
diff --git a/common/file_loc.h b/common/file_loc.h
index 08a905b..6d0fce4 100644
--- a/common/file_loc.h
+++ b/common/file_loc.h
@@ -14,7 +14,7 @@
    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
 
    xrdp: A Remote Desktop Protocol server.
-   Copyright (C) Jay Sorg 2004-2007
+   Copyright (C) Jay Sorg 2004-2008
 
    default file locations for log, config, etc
 
@@ -23,16 +23,40 @@
 #if !defined(FILE_LOC_H)
 #define FILE_LOC_H
 
+#if !defined(XRDP_CFG_PATH)
+#define XRDP_CFG_PATH "/etc/xrdp"
+#endif
+
 #if !defined(XRDP_CFG_FILE)
-#define XRDP_CFG_FILE "xrdp.ini"
+#define XRDP_CFG_FILE "/etc/xrdp/xrdp.ini"
 #endif
 
 #if !defined(XRDP_KEY_FILE)
-#define XRDP_KEY_FILE "rsakeys.ini"
+#define XRDP_KEY_FILE "/etc/xrdp/rsakeys.ini"
+#endif
+
+#if !defined(XRDP_KEYMAP_FILE)
+#define XRDP_KEYMAP_FILE "/etc/xrdp/km-%4.4x.ini"
 #endif
 
 #if !defined(XRDP_PID_FILE)
-#define XRDP_PID_FILE "xrdp.pid"
+#define XRDP_PID_FILE "/var/run/xrdp.pid"
+#endif
+
+#if !defined(XRDP_SBIN_PATH)
+#define XRDP_SBIN_PATH "/usr/local/sbin"
+#endif
+
+#if !defined(XRDP_SHARE_PATH)
+#define XRDP_SHARE_PATH "/usr/local/share/xrdp"
+#endif
+
+#if !defined(SESMAN_PID_FILE)
+#define SESMAN_PID_FILE "/var/run/sesman.pid"
+#endif
+
+#if !defined(SESMAN_CFG_FILE)
+#define SESMAN_CFG_FILE "/etc/xrdp/sesman.ini"
 #endif
 
 #endif
diff --git a/common/list.c b/common/list.c
index 0ba759f..65d7a65 100644
--- a/common/list.c
+++ b/common/list.c
@@ -1,5 +1,5 @@
 /*
-   Copyright (c) 2004-2007 Jay Sorg
+   Copyright (c) 2004-2008 Jay Sorg
 
    Permission is hereby granted, free of charge, to any person obtaining a
    copy of this software and associated documentation files (the "Software"),
@@ -35,7 +35,7 @@ list_create(void)
   self = (struct list*)g_malloc(sizeof(struct list), 1);
   self->grow_by = 10;
   self->alloc_size = 10;
-  self->items = (long*)g_malloc(sizeof(long) * 10, 1);
+  self->items = (tbus*)g_malloc(sizeof(tbus) * 10, 1);
   return self;
 }
 
@@ -63,17 +63,17 @@ list_delete(struct list* self)
 
 /*****************************************************************************/
 void APP_CC
-list_add_item(struct list* self, long item)
+list_add_item(struct list* self, tbus item)
 {
-  long* p;
+  tbus* p;
   int i;
 
   if (self->count >= self->alloc_size)
   {
     i = self->alloc_size;
     self->alloc_size += self->grow_by;
-    p = (long*)g_malloc(sizeof(long) * self->alloc_size, 1);
-    g_memcpy(p, self->items, sizeof(long) * i);
+    p = (tbus*)g_malloc(sizeof(tbus) * self->alloc_size, 1);
+    g_memcpy(p, self->items, sizeof(tbus) * i);
     g_free(self->items);
     self->items = p;
   }
@@ -82,7 +82,7 @@ list_add_item(struct list* self, long item)
 }
 
 /*****************************************************************************/
-long APP_CC
+tbus APP_CC
 list_get_item(struct list* self, int index)
 {
   if (index < 0 || index >= self->count)
@@ -110,12 +110,12 @@ list_clear(struct list* self)
   self->count = 0;
   self->grow_by = 10;
   self->alloc_size = 10;
-  self->items = (long*)g_malloc(sizeof(long) * 10, 1);
+  self->items = (tbus*)g_malloc(sizeof(tbus) * 10, 1);
 }
 
 /*****************************************************************************/
 int APP_CC
-list_index_of(struct list* self, long item)
+list_index_of(struct list* self, tbus item)
 {
   int i;
 
@@ -152,9 +152,9 @@ list_remove_item(struct list* self, int index)
 
 /*****************************************************************************/
 void APP_CC
-list_insert_item(struct list* self, int index, long item)
+list_insert_item(struct list* self, int index, tbus item)
 {
-  long* p;
+  tbus* p;
   int i;
 
   if (index == self->count)
@@ -169,8 +169,8 @@ list_insert_item(struct list* self, int index, long item)
     {
       i = self->alloc_size;
       self->alloc_size += self->grow_by;
-      p = (long*)g_malloc(sizeof(long) * self->alloc_size, 1);
-      g_memcpy(p, self->items, sizeof(long) * i);
+      p = (tbus*)g_malloc(sizeof(tbus) * self->alloc_size, 1);
+      g_memcpy(p, self->items, sizeof(tbus) * i);
       g_free(self->items);
       self->items = p;
     }
@@ -189,13 +189,13 @@ void APP_CC
 list_append_list_strdup(struct list* self, struct list* dest, int start_index)
 {
   int index;
-  long item;
+  tbus item;
   char* dup;
 
   for (index = start_index; index < self->count; index++)
   {
     item = list_get_item(self, index);
     dup = g_strdup((char*)item);
-    list_add_item(dest, (long)dup);
+    list_add_item(dest, (tbus)dup);
   }
 }
diff --git a/common/list.h b/common/list.h
index f839711..8d80f87 100644
--- a/common/list.h
+++ b/common/list.h
@@ -1,5 +1,5 @@
 /*
-   Copyright (c) 2004-2007 Jay Sorg
+   Copyright (c) 2004-2008 Jay Sorg
 
    Permission is hereby granted, free of charge, to any person obtaining a
    copy of this software and associated documentation files (the "Software"),
@@ -30,7 +30,7 @@
 /* list */
 struct list
 {
-  long* items;
+  tbus* items;
   int count;
   int alloc_size;
   int grow_by;
@@ -42,17 +42,17 @@ list_create(void);
 void APP_CC
 list_delete(struct list* self);
 void APP_CC
-list_add_item(struct list* self, long item);
-long APP_CC
+list_add_item(struct list* self, tbus item);
+tbus APP_CC
 list_get_item(struct list* self, int index);
 void APP_CC
 list_clear(struct list* self);
 int APP_CC
-list_index_of(struct list* self, long item);
+list_index_of(struct list* self, tbus item);
 void APP_CC
 list_remove_item(struct list* self, int index);
 void APP_CC
-list_insert_item(struct list* self, int index, long item);
+list_insert_item(struct list* self, int index, tbus item);
 void APP_CC
 list_append_list_strdup(struct list* self, struct list* dest, int start_index);
 
diff --git a/common/log.c b/common/log.c
index 3373282..d492390 100644
--- a/common/log.c
+++ b/common/log.c
@@ -14,7 +14,7 @@
    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
 
    xrdp: A Remote Desktop Protocol server.
-   Copyright (C) Jay Sorg 2005-2007
+   Copyright (C) Jay Sorg 2005-2008
 */
 
 #include <sys/types.h>
@@ -29,18 +29,6 @@
 
 #include "log.h"
 
-/* this gets created in log_start and freed in log_end */
-static struct log_config* l_cfg;
-
-/* threading additions */
-#ifdef LOG_ENABLE_THREAD
-#include "pthread.h"
-/* these get initalized in log_start, they don't need
-   to get freed */
-static pthread_mutex_t log_lock;
-static pthread_mutexattr_t log_lock_attr;
-#endif
-
 /**
  *
  * @brief Opens log file
@@ -115,7 +103,7 @@ log_lvl2str(int lvl, char* str)
 
 /******************************************************************************/
 int DEFAULT_CC
-log_message(const unsigned int lvl, const char* msg, ...)
+log_message(struct log_config* l_cfg, const unsigned int lvl, const char* msg, ...)
 {
   char buff[LOG_BUFFER_SIZE + 31]; /* 19 (datetime) 4 (space+cr+lf+\0) */
   va_list ap;
@@ -151,7 +139,7 @@ log_message(const unsigned int lvl, const char* msg, ...)
   /* checking for truncated messages */ 
   if (len > LOG_BUFFER_SIZE)
   {
-    log_message(LOG_LEVEL_WARNING, "next message will be truncated");
+    log_message(l_cfg, LOG_LEVEL_WARNING, "next message will be truncated");
   }
 
   /* forcing the end of message string */
@@ -182,11 +170,11 @@ log_message(const unsigned int lvl, const char* msg, ...)
 
     /* log to application logfile */
 #ifdef LOG_ENABLE_THREAD
-    pthread_mutex_lock(&log_lock);
+    pthread_mutex_lock(&(l_cfg->log_lock));
 #endif
     rv = g_file_write(l_cfg->fd, (char*)buff, g_strlen((char*)buff));
 #ifdef LOG_ENABLE_THREAD
-    pthread_mutex_unlock(&log_lock);
+    pthread_mutex_unlock(&(l_cfg->log_lock));
 #endif
   }
   return rv;
@@ -194,44 +182,24 @@ log_message(const unsigned int lvl, const char* msg, ...)
 
 /******************************************************************************/
 int DEFAULT_CC
-log_start(const char* progname, const char* logfile, const unsigned int loglvl,
-          const int syslog, const unsigned int syslvl)
+log_start(struct log_config* l_cfg)
 {
-  /* setup log struct */
-  l_cfg = (struct log_config*)g_malloc(sizeof(struct log_config), 1);
-
   if (0 == l_cfg)
   {
     return LOG_ERROR_MALLOC;
   }
 
   /* if logfile is NULL, we use a default logfile */
-  if (0 == logfile)
+  if (0 == l_cfg->log_file)
   {
     l_cfg->log_file = g_strdup("./myprogram.log");
   }
-  else
-  {
-    l_cfg->log_file = g_strdup(logfile);
-  }
 
   /* if progname is NULL, we use a default name */
-  if (0 == progname)
+  if (0 == l_cfg->program_name)
   {
     l_cfg->program_name = g_strdup("myprogram");
   }
-  else
-  {
-    l_cfg->program_name = g_strdup(progname);
-  }
-
-  /* setting log level */
-  l_cfg->log_level = loglvl;
-
-  /* 0 disables syslog, everything else enables it */
-  l_cfg->enable_syslog = (syslog ? 1 : 0);
-  /* forcing syslog_level to be always <= app logging level */
-  l_cfg->syslog_level = (syslvl>loglvl ? loglvl : syslvl);
 
   /* open file */
   l_cfg->fd = log_file_open(l_cfg->log_file);
@@ -248,8 +216,8 @@ log_start(const char* progname, const char* logfile, const unsigned int loglvl,
   }
 
 #ifdef LOG_ENABLE_THREAD
-  pthread_mutexattr_init(&log_lock_attr);
-  pthread_mutex_init(&log_lock, &log_lock_attr);
+  pthread_mutexattr_init(&(l_cfg->log_lock_attr));
+  pthread_mutex_init(&(l_cfg->log_lock), &(l_cfg->log_lock_attr));
 #endif
 
   return LOG_STARTUP_OK;
@@ -257,7 +225,7 @@ log_start(const char* progname, const char* logfile, const unsigned int loglvl,
 
 /******************************************************************************/
 void DEFAULT_CC
-log_end(void)
+log_end(struct log_config* l_cfg)
 {
   /* if log is closed, quit silently */
   if (0 == l_cfg)
@@ -266,7 +234,7 @@ log_end(void)
   }
 
   /* closing log file */
-  log_message(LOG_LEVEL_ALWAYS, "shutting down log subsystem...");
+  log_message(l_cfg, LOG_LEVEL_ALWAYS, "shutting down log subsystem...");
 
   if (0 > l_cfg->fd)
   {
@@ -287,11 +255,16 @@ log_end(void)
   }
 
   /* freeing allocated memory */
-  g_free(l_cfg->log_file);
-  g_free(l_cfg->program_name);
-  g_free(l_cfg);
-
-  l_cfg = 0;
+  if (0 != l_cfg->log_file)
+  {
+    g_free(l_cfg->log_file);
+    l_cfg->log_file = 0;
+  }
+  if (0 != l_cfg->program_name)
+  {
+    g_free(l_cfg->program_name);
+    l_cfg->program_name = 0;
+  }
 }
 
 /******************************************************************************/
diff --git a/common/log.h b/common/log.h
index 446b6f2..18bdd62 100644
--- a/common/log.h
+++ b/common/log.h
@@ -14,12 +14,14 @@
    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
 
    xrdp: A Remote Desktop Protocol server.
-   Copyright (C) Jay Sorg 2005-2007
+   Copyright (C) Jay Sorg 2005-2008
 */
 
 #ifndef LOG_H
 #define LOG_H
 
+#include <pthread.h>
+
 #include "arch.h"
 
 /* logging buffer size */
@@ -44,9 +46,9 @@
 /*#define LOG_ENABLE_THREAD*/
 
 #ifdef DEBUG
-  #define LOG_DBG(s,args...) log_message(LOG_LEVEL_DEBUG,s,args);
+  #define LOG_DBG(lcfg,args...) log_message((lcfg), LOG_LEVEL_DEBUG, args);
 #else
-  #define LOG_DBG(s,args...)
+  #define LOG_DBG(lcfg,args...)
 #endif
 
 struct log_config
@@ -57,6 +59,8 @@ struct log_config
   unsigned int log_level;
   int enable_syslog;
   unsigned int syslog_level;
+  pthread_mutex_t log_lock;
+  pthread_mutexattr_t log_lock_attr;
 };
 
 /**
@@ -68,30 +72,26 @@ struct log_config
  *
  */
 int DEFAULT_CC
-log_message(const unsigned int lvl, const char* msg, ...);
+log_message(struct log_config* l_cfg, const unsigned int lvl, const char* msg, ...);
 
 /**
  *
  * @brief Starts the logging subsystem
- * @param progname string to prepend to syslog messages
- * @param logfile log file path
- * @param loglvl level of messages to log
- * @param syslog if set to 0, disables the use of syslog
- * @param syslvl level of messages to log to syslog
+ * @param l_cfg loggging system configuration
  * @return
  *
  */
 int DEFAULT_CC
-log_start(const char* progname, const char* logfile, const unsigned int loglvl,
-          const int syslog, const unsigned int syslvl);
+log_start(struct log_config* l_cfg);
 
 /**
  *
  * @brief Shuts down the logging subsystem
+ * @param l_cfg pointer to the logging subsystem to stop
  *
  */
 void DEFAULT_CC
-log_end(void);
+log_end(struct log_config* l_cfg);
 
 /**
  *
diff --git a/common/os_calls.c b/common/os_calls.c
index 9bb5ef1..b3a8043 100644
--- a/common/os_calls.c
+++ b/common/os_calls.c
@@ -1,5 +1,5 @@
 /*
-   Copyright (c) 2004-2007 Jay Sorg
+   Copyright (c) 2004-2008 Jay Sorg
 
    Permission is hereby granted, free of charge, to any person obtaining a
    copy of this software and associated documentation files (the "Software"),
@@ -24,6 +24,9 @@
    put all the os / arch define in here you want
 */
 
+#if defined(HAVE_CONFIG_H)
+#include "config_ac.h"
+#endif
 #if defined(_WIN32)
 #include <windows.h>
 #include <winsock.h>
@@ -39,6 +42,7 @@
 #include <sys/socket.h>
 #include <sys/un.h>
 #include <sys/time.h>
+#include <sys/times.h>
 #include <sys/types.h>
 #include <sys/wait.h>
 #include <sys/stat.h>
@@ -56,6 +60,7 @@
 #include <string.h>
 #include <stdarg.h>
 #include <stdio.h>
+#include <locale.h>
 
 #include "os_calls.h"
 #include "arch.h"
@@ -75,6 +80,27 @@ extern char** environ;
 #endif
 
 /*****************************************************************************/
+void APP_CC
+g_init(void)
+{
+#if defined(_WIN32)
+  WSADATA wsadata;
+
+  WSAStartup(2, &wsadata);
+#endif
+  setlocale(LC_CTYPE, "");
+}
+
+/*****************************************************************************/
+void APP_CC
+g_deinit(void)
+{
+#if defined(_WIN32)
+  WSACleanup();
+#endif
+}
+
+/*****************************************************************************/
 /* allocate memory, returns a pointer to it, size bytes are allocated,
    if zero is non zero, each byte will be set to zero */
 void* APP_CC
@@ -85,7 +111,10 @@ g_malloc(int size, int zero)
   rv = (char*)malloc(size);
   if (zero)
   {
-    memset(rv, 0, size);
+    if (rv != 0)
+    {
+      memset(rv, 0, size);
+    }
   }
   return rv;
 }
@@ -226,40 +255,75 @@ g_getchar(void)
 int APP_CC
 g_tcp_set_no_delay(int sck)
 {
-  int i;
-
-  i = 1;
 #if defined(_WIN32)
-  setsockopt(sck, IPPROTO_TCP, TCP_NODELAY, (char*)&i, sizeof(i));
+  int option_value;
+  int option_len;
 #else
-  setsockopt(sck, IPPROTO_TCP, TCP_NODELAY, (void*)&i, sizeof(i));
+  int option_value;
+  unsigned int option_len;
 #endif
+
+  option_len = sizeof(option_value);
+  /* SOL_TCP IPPROTO_TCP */
+  if (getsockopt(sck, IPPROTO_TCP, TCP_NODELAY, (char*)&option_value,
+                 &option_len) == 0)
+  {
+    if (option_value == 0)
+    {
+      option_value = 1;
+      option_len = sizeof(option_value);
+      setsockopt(sck, IPPROTO_TCP, TCP_NODELAY, (char*)&option_value,
+                 option_len);
+    }
+  }
   return 0;
 }
 
 /*****************************************************************************/
+/* returns a newly created socket or -1 on error */
 int APP_CC
 g_tcp_socket(void)
 {
-  int rv;
-  int i;
-
-  rv = socket(PF_INET, SOCK_STREAM, 0);
 #if defined(_WIN32)
-  i = 1;
-  setsockopt(rv, IPPROTO_TCP, TCP_NODELAY, (char*)&i, sizeof(i));
-  i = 1;
-  setsockopt(rv, SOL_SOCKET, SO_REUSEADDR, (char*)&i, sizeof(i));
-  i = 8192 * 2;
-  setsockopt(rv, SOL_SOCKET, SO_SNDBUF, (char*)&i, sizeof(i));
+  int rv;
+  int option_value;
+  int option_len;
 #else
-  i = 1;
-  setsockopt(rv, IPPROTO_TCP, TCP_NODELAY, (void*)&i, sizeof(i));
-  i = 1;
-  setsockopt(rv, SOL_SOCKET, SO_REUSEADDR, (void*)&i, sizeof(i));
-  i = 8192 * 2;
-  setsockopt(rv, SOL_SOCKET, SO_SNDBUF, (void*)&i, sizeof(i));
+  int rv;
+  int option_value;
+  unsigned int option_len;
 #endif
+
+  /* in win32 a socket is an unsigned int, in linux, its an int */
+  rv = (int)socket(PF_INET, SOCK_STREAM, 0);
+  if (rv < 0)
+  {
+    return -1;
+  }
+  option_len = sizeof(option_value);
+  if (getsockopt(rv, SOL_SOCKET, SO_REUSEADDR, (char*)&option_value,
+                 &option_len) == 0)
+  {
+    if (option_value == 0)
+    {
+      option_value = 1;
+      option_len = sizeof(option_value);
+      setsockopt(rv, SOL_SOCKET, SO_REUSEADDR, (char*)&option_value,
+                 option_len);
+    }
+  }
+  option_len = sizeof(option_value);
+  if (getsockopt(rv, SOL_SOCKET, SO_SNDBUF, (char*)&option_value,
+                 &option_len) == 0)
+  {
+    if (option_value < (1024 * 32))
+    {
+      option_value = 1024 * 32;
+      option_len = sizeof(option_value);
+      setsockopt(rv, SOL_SOCKET, SO_SNDBUF, (char*)&option_value,
+                 option_len);
+    }
+  }
   return rv;
 }
 
@@ -291,6 +355,7 @@ g_tcp_close(int sck)
 }
 
 /*****************************************************************************/
+/* returns error, zero is good */
 int APP_CC
 g_tcp_connect(int sck, const char* address, const char* port)
 {
@@ -299,7 +364,7 @@ g_tcp_connect(int sck, const char* address, const char* port)
 
   g_memset(&s, 0, sizeof(struct sockaddr_in));
   s.sin_family = AF_INET;
-  s.sin_port = htons(atoi(port));
+  s.sin_port = htons((tui16)atoi(port));
   s.sin_addr.s_addr = inet_addr(address);
   if (s.sin_addr.s_addr == INADDR_NONE)
   {
@@ -339,6 +404,7 @@ g_tcp_set_non_blocking(int sck)
 }
 
 /*****************************************************************************/
+/* returns error, zero is good */
 int APP_CC
 g_tcp_bind(int sck, char* port)
 {
@@ -346,7 +412,7 @@ g_tcp_bind(int sck, char* port)
 
   memset(&s, 0, sizeof(struct sockaddr_in));
   s.sin_family = AF_INET;
-  s.sin_port = htons(atoi(port));
+  s.sin_port = htons((tui16)atoi(port));
   s.sin_addr.s_addr = INADDR_ANY;
   return bind(sck, (struct sockaddr*)&s, sizeof(struct sockaddr_in));
 }
@@ -368,6 +434,7 @@ g_tcp_local_bind(int sck, char* port)
 }
 
 /*****************************************************************************/
+/* returns error, zero is good */
 int APP_CC
 g_tcp_listen(int sck)
 {
@@ -554,11 +621,314 @@ g_tcp_select(int sck1, int sck2)
 }
 
 /*****************************************************************************/
+/* returns 0 on error */
+tbus APP_CC
+g_create_wait_obj(char* name)
+{
+#ifdef _WIN32
+  tbus obj;
+
+  obj = (tbus)CreateEvent(0, 1, 0, name);
+  return obj;
+#else
+  tbus obj;
+  struct sockaddr_un sa;
+  int len;
+  int sck;
+  int i;
+
+  sck = socket(PF_UNIX, SOCK_DGRAM, 0);
+  if (sck < 0)
+  {
+    return 0;
+  }
+  memset(&sa, 0, sizeof(sa));
+  sa.sun_family = AF_UNIX;
+  if ((name == 0) || (strlen(name) == 0))
+  {
+    g_random((char*)&i, sizeof(i));
+    sprintf(sa.sun_path, "/tmp/auto%8.8x", i);
+    while (g_file_exist(sa.sun_path))
+    {
+      g_random((char*)&i, sizeof(i));
+      sprintf(sa.sun_path, "/tmp/auto%8.8x", i);
+    }
+  }
+  else
+  {
+    sprintf(sa.sun_path, "/tmp/%s", name);
+  }
+  unlink(sa.sun_path);
+  len = sizeof(sa);
+  if (bind(sck, (struct sockaddr*)&sa, len) < 0)
+  {
+    close(sck);
+    return 0;
+  }
+  obj = (tbus)sck;
+  return obj;
+#endif
+}
+
+/*****************************************************************************/
+/* returns 0 on error */
+tbus APP_CC
+g_create_wait_obj_from_socket(tbus socket, int write)
+{
+#ifdef _WIN32
+  /* Create and return corresponding event handle for WaitForMultipleObjets */
+  WSAEVENT event;
+  long lnetevent;
+
+  event = WSACreateEvent();
+  lnetevent = (write ? FD_WRITE : FD_READ) | FD_CLOSE;
+  if (WSAEventSelect(socket, event, lnetevent) == 0)
+  {
+    return (tbus)event;
+  }
+  else
+  {
+    return 0;
+  }
+#else
+  return socket;
+#endif
+}
+
+/*****************************************************************************/
+void APP_CC
+g_delete_wait_obj_from_socket(tbus wait_obj)
+{
+#ifdef _WIN32
+  if (wait_obj == 0)
+  {
+    return;
+  }
+  WSACloseEvent((HANDLE)wait_obj);
+#else
+#endif
+}
+
+/*****************************************************************************/
+/* returns error */
+int APP_CC
+g_set_wait_obj(tbus obj)
+{
+#ifdef _WIN32
+  if (obj == 0)
+  {
+    return 0;
+  }
+  SetEvent((HANDLE)obj);
+  return 0;
+#else
+  socklen_t sa_size;
+  int s;
+  struct sockaddr_un sa;
+
+  if (obj == 0)
+  {
+    return 0;
+  }
+  if (g_tcp_can_recv((int)obj, 0))
+  {
+    /* already signalled */
+    return 0;
+  }
+  sa_size = sizeof(sa);
+  if (getsockname((int)obj, (struct sockaddr*)&sa, &sa_size) < 0)
+  {
+    return 1;
+  }
+  s = socket(PF_UNIX, SOCK_DGRAM, 0);
+  if (s < 0)
+  {
+    return 1;
+  }
+  sendto(s, "sig", 4, 0, (struct sockaddr*)&sa, sa_size);
+  close(s);
+  return 0;
+#endif
+}
+
+/*****************************************************************************/
+/* returns error */
+int APP_CC
+g_reset_wait_obj(tbus obj)
+{
+#ifdef _WIN32
+  if (obj == 0)
+  {
+    return 0;
+  }
+  ResetEvent((HANDLE)obj);
+  return 0;
+#else
+  char buf[64];
+
+  if (obj == 0)
+  {
+    return 0;
+  }
+  while (g_tcp_can_recv((int)obj, 0))
+  {
+    recvfrom((int)obj, &buf, 64, 0, 0, 0);
+  }
+  return 0;
+#endif
+}
+
+/*****************************************************************************/
+/* returns boolean */
+int APP_CC
+g_is_wait_obj_set(tbus obj)
+{
+#ifdef _WIN32
+  if (obj == 0)
+  {
+    return 0;
+  }
+  if (WaitForSingleObject((HANDLE)obj, 0) == WAIT_OBJECT_0)
+  {
+    return 1;
+  }
+  return 0;
+#else
+  if (obj == 0)
+  {
+    return 0;
+  }
+  return g_tcp_can_recv((int)obj, 0);
+#endif
+}
+
+/*****************************************************************************/
+/* returns error */
+int APP_CC
+g_delete_wait_obj(tbus obj)
+{
+#ifdef _WIN32
+  if (obj == 0)
+  {
+    return 0;
+  }
+  /* Close event handle */
+  CloseHandle((HANDLE)obj);
+  return 0;
+#else
+  socklen_t sa_size;
+  struct sockaddr_un sa;
+
+  if (obj == 0)
+  {
+    return 0;
+  }
+  sa_size = sizeof(sa);
+  if (getsockname((int)obj, (struct sockaddr*)&sa, &sa_size) < 0)
+  {
+    return 1;
+  }
+  close((int)obj);
+  unlink(sa.sun_path);
+  return 0;
+#endif
+}
+
+/*****************************************************************************/
+/* returns error */
+int APP_CC
+g_obj_wait(tbus* read_objs, int rcount, tbus* write_objs, int wcount,
+           int mstimeout)
+{
+#ifdef _WIN32
+  HANDLE handles[256];
+  DWORD count;
+  DWORD error;
+  int j;
+  int i;
+
+  j = 0;
+  count = rcount + wcount;
+  for (i = 0; i < rcount; i++)
+  {
+    handles[j++] = (HANDLE)(read_objs[i]);
+  }
+  for (i = 0; i < wcount; i++)
+  {
+    handles[j++] = (HANDLE)(write_objs[i]);
+  }
+  if (mstimeout < 1)
+  {
+    mstimeout = INFINITE;
+  }
+  error = WaitForMultipleObjects(count, handles, FALSE, mstimeout);
+  if (error == WAIT_FAILED)
+  {
+    return 1;
+  }
+  return 0;
+#else
+  fd_set rfds;
+  fd_set wfds;
+  struct timeval time;
+  struct timeval* ptime;
+  int i;
+  int max;
+  int sck;
+
+  max = 0;
+  if (mstimeout < 1)
+  {
+    ptime = 0;
+  }
+  else
+  {
+    time.tv_sec = mstimeout / 1000;
+    time.tv_usec = (mstimeout % 1000) * 1000;
+    ptime = &time;
+  }
+  FD_ZERO(&rfds);
+  FD_ZERO(&wfds);
+  for (i = 0; i < rcount; i++)
+  {
+    sck = (int)(read_objs[i]);
+    FD_SET(sck, &rfds);
+    if (sck > max)
+    {
+      max = sck;
+    }
+  }
+  for (i = 0; i < wcount; i++)
+  {
+    sck = (int)(write_objs[i]);
+    FD_SET(sck, &wfds);
+    if (sck > max)
+    {
+      max = sck;
+    }
+  }
+  i = select(max + 1, &rfds, &wfds, 0, ptime);
+  if (i < 0)
+  {
+    return 1;
+  }
+  return 0;
+#endif
+}
+
+/*****************************************************************************/
 void APP_CC
 g_random(char* data, int len)
 {
 #if defined(_WIN32)
-  memset(data, 0x44, len);
+  int index;
+
+  srand(g_time1());
+  for (index = 0; index < len; index++)
+  {
+    data[index] = (char)rand(); /* rand returns a number between 0 and
+                                   RAND_MAX */
+  }
 #else
   int fd;
 
@@ -596,9 +966,9 @@ int APP_CC
 g_file_open(const char* file_name)
 {
 #if defined(_WIN32)
-  return (int)CreateFile(file_name, GENERIC_READ | GENERIC_WRITE,
-                         FILE_SHARE_READ | FILE_SHARE_WRITE,
-                         0, OPEN_ALWAYS, FILE_ATTRIBUTE_NORMAL, 0);
+  return (int)CreateFileA(file_name, GENERIC_READ | GENERIC_WRITE,
+                          FILE_SHARE_READ | FILE_SHARE_WRITE,
+                          0, OPEN_ALWAYS, FILE_ATTRIBUTE_NORMAL, 0);
 #else
   int rv;
 
@@ -773,7 +1143,7 @@ char* APP_CC
 g_get_current_dir(char* dirname, int maxlen)
 {
 #if defined(_WIN32)
-  GetCurrentDirectory(maxlen, dirname);
+  GetCurrentDirectoryA(maxlen, dirname);
   return 0;
 #else
   getcwd(dirname, maxlen);
@@ -787,7 +1157,7 @@ int APP_CC
 g_set_current_dir(char* dirname)
 {
 #if defined(_WIN32)
-  if (SetCurrentDirectory(dirname))
+  if (SetCurrentDirectoryA(dirname))
   {
     return 0;
   }
@@ -840,7 +1210,7 @@ int APP_CC
 g_create_dir(const char* dirname)
 {
 #if defined(_WIN32)
-  return CreateDirectory(dirname, 0); // test this
+  return CreateDirectoryA(dirname, 0); // test this
 #else
   return mkdir(dirname, (mode_t)-1) == 0;
 #endif
@@ -852,7 +1222,7 @@ int APP_CC
 g_remove_dir(const char* dirname)
 {
 #if defined(_WIN32)
-  return RemoveDirectory(dirname); // test this
+  return RemoveDirectoryA(dirname); // test this
 #else
   return rmdir(dirname) == 0;
 #endif
@@ -864,13 +1234,34 @@ int APP_CC
 g_file_delete(const char* filename)
 {
 #if defined(_WIN32)
-  return DeleteFile(filename);
+  return DeleteFileA(filename);
 #else
   return unlink(filename) != -1;
 #endif
 }
 
 /*****************************************************************************/
+/* returns file size, -1 on error */
+int APP_CC
+g_file_get_size(const char* filename)
+{
+#if defined(_WIN32)
+  return -1;
+#else
+  struct stat st;
+
+  if (stat(filename, &st) == 0)
+  {
+    return (int)(st.st_size);
+  }
+  else
+  {
+    return -1;
+  }
+#endif
+}
+
+/*****************************************************************************/
 /* returns length of text */
 int APP_CC
 g_strlen(const char* text)
@@ -995,6 +1386,84 @@ g_atoi(char* str)
 
 /*****************************************************************************/
 int APP_CC
+g_htoi(char* str)
+{
+  int len;
+  int index;
+  int rv;
+  int val;
+  int shift;
+
+  rv = 0;
+  len = strlen(str);
+  index = len - 1;
+  shift = 0;
+  while (index >= 0)
+  {
+    val = 0;
+    switch (str[index])
+    {
+      case '1':
+        val = 1;
+        break;
+      case '2':
+        val = 2;
+        break;
+      case '3':
+        val = 3;
+        break;
+      case '4':
+        val = 4;
+        break;
+      case '5':
+        val = 5;
+        break;
+      case '6':
+        val = 6;
+        break;
+      case '7':
+        val = 7;
+        break;
+      case '8':
+        val = 8;
+        break;
+      case '9':
+        val = 9;
+        break;
+      case 'a':
+      case 'A':
+        val = 10;
+        break;
+      case 'b':
+      case 'B':
+        val = 11;
+        break;
+      case 'c':
+      case 'C':
+        val = 12;
+        break;
+      case 'd':
+      case 'D':
+        val = 13;
+        break;
+      case 'e':
+      case 'E':
+        val = 14;
+        break;
+      case 'f':
+      case 'F':
+        val = 15;
+        break;
+    }
+    rv = rv | (val << shift);
+    index--;
+    shift += 4;
+  }
+  return rv;
+}
+
+/*****************************************************************************/
+int APP_CC
 g_pos(char* str, const char* to_find)
 {
   char* pp;
@@ -1008,11 +1477,154 @@ g_pos(char* str, const char* to_find)
 }
 
 /*****************************************************************************/
+int APP_CC
+g_mbstowcs(twchar* dest, const char* src, int n)
+{
+  wchar_t* ldest;
+  int rv;
+
+  ldest = (wchar_t*)dest;
+  rv = mbstowcs(ldest, src, n);
+  return rv;
+}
+
+/*****************************************************************************/
+int APP_CC
+g_wcstombs(char* dest, const twchar* src, int n)
+{
+  const wchar_t* lsrc;
+  int rv;
+
+  lsrc = (const wchar_t*)src;
+  rv = wcstombs(dest, lsrc, n);
+  return rv;
+}
+
+/*****************************************************************************/
+/* returns error */
+/* trim spaces and tabs, anything <= space */
+/* trim_flags 1 trim left, 2 trim right, 3 trim both, 4 trim through */
+/* this will always shorten the string or not change it */
+int APP_CC
+g_strtrim(char* str, int trim_flags)
+{
+  int index;
+  int len;
+  int text1_index;
+  int got_char;
+  wchar_t* text;
+  wchar_t* text1;
+
+  len = mbstowcs(0, str, 0);
+  if (len < 1)
+  {
+    return 0;
+  }
+  if ((trim_flags < 1) || (trim_flags > 4))
+  {
+    return 1;
+  }
+  text = (wchar_t*)malloc(len * sizeof(wchar_t) + 8);
+  text1 = (wchar_t*)malloc(len * sizeof(wchar_t) + 8);
+  text1_index = 0;
+  mbstowcs(text, str, len + 1);
+  switch (trim_flags)
+  {
+    case 4: /* trim through */
+      for (index = 0; index < len; index++)
+      {
+        if (text[index] > 32)
+        {
+          text1[text1_index] = text[index];
+          text1_index++;
+        }
+      }
+      text1[text1_index] = 0;
+      break;
+    case 3: /* trim both */
+      got_char = 0;
+      for (index = 0; index < len; index++)
+      {
+        if (got_char)
+        {
+          text1[text1_index] = text[index];
+          text1_index++;
+        }
+        else
+        {
+          if (text[index] > 32)
+          {
+            text1[text1_index] = text[index];
+            text1_index++;
+            got_char = 1;
+          }
+        }
+      }
+      text1[text1_index] = 0;
+      len = text1_index;
+      /* trim right */
+      for (index = len - 1; index >= 0; index--)
+      {
+        if (text1[index] > 32)
+        {
+          break;
+        }
+      }
+      text1_index = index + 1;
+      text1[text1_index] = 0;
+      break;
+    case 2: /* trim right */
+      /* copy it */
+      for (index = 0; index < len; index++)
+      {
+        text1[text1_index] = text[index];
+        text1_index++;
+      }
+      /* trim right */
+      for (index = len - 1; index >= 0; index--)
+      {
+        if (text1[index] > 32)
+        {
+          break;
+        }
+      }
+      text1_index = index + 1;
+      text1[text1_index] = 0;
+      break;
+    case 1: /* trim left */
+      got_char = 0;
+      for (index = 0; index < len; index++)
+      {
+        if (got_char)
+        {
+          text1[text1_index] = text[index];
+          text1_index++;
+        }
+        else
+        {
+          if (text[index] > 32)
+          {
+            text1[text1_index] = text[index];
+            text1_index++;
+            got_char = 1;
+          }
+        }
+      }
+      text1[text1_index] = 0;
+      break;
+  }
+  wcstombs(str, text1, text1_index + 1);
+  free(text);
+  free(text1);
+  return 0;
+}
+
+/*****************************************************************************/
 long APP_CC
 g_load_library(char* in)
 {
 #if defined(_WIN32)
-  return (long)LoadLibrary(in);
+  return (long)LoadLibraryA(in);
 #else
   return (long)dlopen(in, RTLD_LOCAL | RTLD_LAZY);
 #endif
@@ -1050,6 +1662,7 @@ g_get_proc_address(long lib, const char* name)
 }
 
 /*****************************************************************************/
+/* does not work in win32 */
 int APP_CC
 g_system(char* aexec)
 {
@@ -1061,6 +1674,7 @@ g_system(char* aexec)
 }
 
 /*****************************************************************************/
+/* does not work in win32 */
 char* APP_CC
 g_get_strerror(void)
 {
@@ -1072,6 +1686,7 @@ g_get_strerror(void)
 }
 
 /*****************************************************************************/
+/* does not work in win32 */
 int APP_CC
 g_execvp(const char* p1, char* args[])
 {
@@ -1083,6 +1698,7 @@ g_execvp(const char* p1, char* args[])
 }
 
 /*****************************************************************************/
+/* does not work in win32 */
 int APP_CC
 g_execlp3(const char* a1, const char* a2, const char* a3)
 {
@@ -1094,6 +1710,7 @@ g_execlp3(const char* a1, const char* a2, const char* a3)
 }
 
 /*****************************************************************************/
+/* does not work in win32 */
 void APP_CC
 g_signal(int sig_num, void (*func)(int))
 {
@@ -1104,6 +1721,7 @@ g_signal(int sig_num, void (*func)(int))
 }
 
 /*****************************************************************************/
+/* does not work in win32 */
 void APP_CC
 g_signal_child_stop(void (*func)(int))
 {
@@ -1114,6 +1732,7 @@ g_signal_child_stop(void (*func)(int))
 }
 
 /*****************************************************************************/
+/* does not work in win32 */
 void APP_CC
 g_unset_signals(void)
 {
@@ -1127,6 +1746,7 @@ g_unset_signals(void)
 }
 
 /*****************************************************************************/
+/* does not work in win32 */
 int APP_CC
 g_fork(void)
 {
@@ -1138,6 +1758,7 @@ g_fork(void)
 }
 
 /*****************************************************************************/
+/* does not work in win32 */
 int APP_CC
 g_setgid(int pid)
 {
@@ -1150,17 +1771,33 @@ g_setgid(int pid)
 
 /*****************************************************************************/
 /* returns error, zero is success, non zero is error */
+/* does not work in win32 */
 int APP_CC
 g_initgroups(const char* user, int gid)
 {
 #if defined(_WIN32)
   return 0;
 #else
-  return initgroups(user ,gid);
+  return initgroups(user, gid);
 #endif
 }
-  
+
 /*****************************************************************************/
+/* does not work in win32 */
+/* returns user id */
+int APP_CC
+g_getuid(void)
+{
+#if defined(_WIN32)
+  return 0;
+#else
+  return getuid();
+#endif
+}
+
+/*****************************************************************************/
+/* does not work in win32 */
+/* On success, zero is returned. On error, -1 is returned */
 int APP_CC
 g_setuid(int pid)
 {
@@ -1172,6 +1809,7 @@ g_setuid(int pid)
 }
 
 /*****************************************************************************/
+/* does not work in win32 */
 int APP_CC
 g_waitchild(void)
 {
@@ -1185,6 +1823,7 @@ g_waitchild(void)
 }
 
 /*****************************************************************************/
+/* does not work in win32 */
 int APP_CC
 g_waitpid(int pid)
 {
@@ -1196,6 +1835,7 @@ g_waitpid(int pid)
 }
 
 /*****************************************************************************/
+/* does not work in win32 */
 void APP_CC
 g_clearenv(void)
 {
@@ -1206,6 +1846,7 @@ g_clearenv(void)
 }
 
 /*****************************************************************************/
+/* does not work in win32 */
 int APP_CC
 g_setenv(const char* name, const char* value, int rewrite)
 {
@@ -1217,6 +1858,7 @@ g_setenv(const char* name, const char* value, int rewrite)
 }
 
 /*****************************************************************************/
+/* does not work in win32 */
 char* APP_CC
 g_getenv(const char* name)
 {
@@ -1236,6 +1878,7 @@ g_exit(int exit_code)
 }
 
 /*****************************************************************************/
+/* does not work in win32 */
 int APP_CC
 g_getpid(void)
 {
@@ -1247,6 +1890,7 @@ g_getpid(void)
 }
 
 /*****************************************************************************/
+/* does not work in win32 */
 int APP_CC
 g_sigterm(int pid)
 {
@@ -1259,6 +1903,7 @@ g_sigterm(int pid)
 
 /*****************************************************************************/
 /* returns 0 if ok */
+/* does not work in win32 */
 int APP_CC
 g_getuser_info(const char* username, int* gid, int* uid, char* shell,
                char* dir, char* gecos)
@@ -1299,6 +1944,7 @@ g_getuser_info(const char* username, int* gid, int* uid, char* shell,
 
 /*****************************************************************************/
 /* returns 0 if ok */
+/* does not work in win32 */
 int APP_CC
 g_getgroup_info(const char* groupname, int* gid)
 {
@@ -1323,6 +1969,7 @@ g_getgroup_info(const char* groupname, int* gid)
 /*****************************************************************************/
 /* returns error */
 /* if zero is returned, then ok is set */
+/* does not work in win32 */
 int APP_CC
 g_check_user_in_group(const char* username, int gid, int* ok)
 {
@@ -1354,7 +2001,9 @@ g_check_user_in_group(const char* username, int gid, int* ok)
 
 /*****************************************************************************/
 /* returns the time since the Epoch (00:00:00 UTC, January 1, 1970),
-   measured in seconds. */
+   measured in seconds.
+   for windows, returns the number of seconds since the machine was
+   started. */
 int APP_CC
 g_time1(void)
 {
@@ -1364,3 +2013,20 @@ g_time1(void)
   return time(0);
 #endif
 }
+
+/*****************************************************************************/
+/* returns the number of milliseconds since the machine was
+   started. */
+int APP_CC
+g_time2(void)
+{
+#if defined(_WIN32)
+  return (int)GetTickCount();
+#else
+  struct tms tm;
+  clock_t num_ticks;
+
+  num_ticks = times(&tm);
+  return (int)(num_ticks * 10);
+#endif
+}
diff --git a/common/os_calls.h b/common/os_calls.h
index 845c255..c9707ca 100644
--- a/common/os_calls.h
+++ b/common/os_calls.h
@@ -1,5 +1,5 @@
 /*
-   Copyright (c) 2004-2007 Jay Sorg
+   Copyright (c) 2004-2008 Jay Sorg
 
    Permission is hereby granted, free of charge, to any person obtaining a
    copy of this software and associated documentation files (the "Software"),
@@ -27,6 +27,10 @@
 
 #include "arch.h"
 
+void APP_CC
+g_init(void);
+void APP_CC
+g_deinit(void);
 void* APP_CC
 g_malloc(int size, int zero);
 void APP_CC
@@ -89,6 +93,23 @@ int APP_CC
 g_tcp_select(int sck1, int sck2);
 void APP_CC
 g_sleep(int msecs);
+tbus APP_CC
+g_create_wait_obj(char* name);
+tbus APP_CC
+g_create_wait_obj_from_socket(tbus socket, int write);
+void APP_CC
+g_delete_wait_obj_from_socket(tbus wait_obj);
+int APP_CC
+g_set_wait_obj(tbus obj);
+int APP_CC
+g_reset_wait_obj(tbus obj);
+int APP_CC
+g_is_wait_obj_set(tbus obj);
+int APP_CC
+g_delete_wait_obj(tbus obj);
+int APP_CC
+g_obj_wait(tbus* read_objs, int rcount, tbus* write_objs, int wcount,
+           int mstimeout);
 void APP_CC
 g_random(char* data, int len);
 int APP_CC
@@ -128,6 +149,8 @@ g_remove_dir(const char* dirname);
 int APP_CC
 g_file_delete(const char* filename);
 int APP_CC
+g_file_get_size(const char* filename);
+int APP_CC
 g_strlen(const char* text);
 char* APP_CC
 g_strcpy(char* dest, const char* src);
@@ -148,7 +171,15 @@ g_strncasecmp(const char* c1, const char* c2, int len);
 int APP_CC
 g_atoi(char* str);
 int APP_CC
+g_htoi(char* str);
+int APP_CC
 g_pos(char* str, const char* to_find);
+int APP_CC
+g_mbstowcs(twchar* dest, const char* src, int n);
+int APP_CC
+g_wcstombs(char* dest, const twchar* src, int n);
+int APP_CC
+g_strtrim(char* str, int trim_flags);
 long APP_CC
 g_load_library(char* in);
 int APP_CC
@@ -176,6 +207,8 @@ g_setgid(int pid);
 int APP_CC
 g_initgroups(const char* user, int gid);
 int APP_CC
+g_getuid(void);
+int APP_CC
 g_setuid(int pid);
 int APP_CC
 g_waitchild(void);
@@ -202,5 +235,7 @@ int APP_CC
 g_check_user_in_group(const char* username, int gid, int* ok);
 int APP_CC
 g_time1(void);
+int APP_CC
+g_time2(void);
 
 #endif
diff --git a/common/parse.h b/common/parse.h
index a9d7a19..bd2733a 100644
--- a/common/parse.h
+++ b/common/parse.h
@@ -1,5 +1,5 @@
 /*
-   Copyright (c) 2004-2007 Jay Sorg
+   Copyright (c) 2004-2008 Jay Sorg
 
    Permission is hereby granted, free of charge, to any person obtaining a
    copy of this software and associated documentation files (the "Software"),
diff --git a/common/ssl_calls.c b/common/ssl_calls.c
index 5a2e016..960c056 100644
--- a/common/ssl_calls.c
+++ b/common/ssl_calls.c
@@ -14,7 +14,7 @@
    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
 
    xrdp: A Remote Desktop Protocol server.
-   Copyright (C) Jay Sorg 2004-2007
+   Copyright (C) Jay Sorg 2004-2008
 
    ssl calls
 
@@ -25,18 +25,25 @@
 #include <openssl/md5.h>
 #include <openssl/sha.h>
 #include <openssl/bn.h>
+#include <openssl/rsa.h>
 
 #include "os_calls.h"
 #include "arch.h"
 #include "ssl_calls.h"
 
+#if defined(OPENSSL_VERSION_NUMBER) && (OPENSSL_VERSION_NUMBER >= 0x0090800f)
+#undef OLD_RSA_GEN1
+#else
+#define OLD_RSA_GEN1
+#endif
+
 /* rc4 stuff */
 
 /*****************************************************************************/
 void* APP_CC
 ssl_rc4_info_create(void)
 {
-  return g_malloc(sizeof(RC4_KEY), 1);;
+  return g_malloc(sizeof(RC4_KEY), 1);
 }
 
 /*****************************************************************************/
@@ -50,14 +57,14 @@ ssl_rc4_info_delete(void* rc4_info)
 void APP_CC
 ssl_rc4_set_key(void* rc4_info, char* key, int len)
 {
-  RC4_set_key((RC4_KEY*)rc4_info, len, (unsigned char*)key);
+  RC4_set_key((RC4_KEY*)rc4_info, len, (tui8*)key);
 }
 
 /*****************************************************************************/
 void APP_CC
 ssl_rc4_crypt(void* rc4_info, char* data, int len)
 {
-  RC4((RC4_KEY*)rc4_info, len, (unsigned char*)data, (unsigned char*)data);
+  RC4((RC4_KEY*)rc4_info, len, (tui8*)data, (tui8*)data);
 }
 
 /* sha1 stuff */
@@ -94,7 +101,7 @@ ssl_sha1_transform(void* sha1_info, char* data, int len)
 void APP_CC
 ssl_sha1_complete(void* sha1_info, char* data)
 {
-  SHA1_Final((unsigned char*)data, (SHA_CTX*)sha1_info);
+  SHA1_Final((tui8*)data, (SHA_CTX*)sha1_info);
 }
 
 /* md5 stuff */
@@ -131,7 +138,7 @@ ssl_md5_transform(void* md5_info, char* data, int len)
 void APP_CC
 ssl_md5_complete(void* md5_info, char* data)
 {
-  MD5_Final((unsigned char*)data, (MD5_CTX*)md5_info);
+  MD5_Final((tui8*)data, (MD5_CTX*)md5_info);
 }
 
 /*****************************************************************************/
@@ -157,7 +164,7 @@ ssl_reverse_it(char* p, int len)
 /*****************************************************************************/
 int APP_CC
 ssl_mod_exp(char* out, int out_len, char* in, int in_len,
-          char* mod, int mod_len, char* exp, int exp_len)
+            char* mod, int mod_len, char* exp, int exp_len)
 {
   BN_CTX* ctx;
   BIGNUM lmod;
@@ -185,11 +192,11 @@ ssl_mod_exp(char* out, int out_len, char* in, int in_len,
   BN_init(&lexp);
   BN_init(&lin);
   BN_init(&lout);
-  BN_bin2bn((unsigned char*)l_mod, mod_len, &lmod);
-  BN_bin2bn((unsigned char*)l_exp, exp_len, &lexp);
-  BN_bin2bn((unsigned char*)l_in, in_len, &lin);
+  BN_bin2bn((tui8*)l_mod, mod_len, &lmod);
+  BN_bin2bn((tui8*)l_exp, exp_len, &lexp);
+  BN_bin2bn((tui8*)l_in, in_len, &lin);
   BN_mod_exp(&lout, &lin, &lexp, &lmod, ctx);
-  rv = BN_bn2bin(&lout, (unsigned char*)l_out);
+  rv = BN_bn2bin(&lout, (tui8*)l_out);
   if (rv <= out_len)
   {
     ssl_reverse_it(l_out, rv);
@@ -210,3 +217,129 @@ ssl_mod_exp(char* out, int out_len, char* in, int in_len,
   g_free(l_exp);
   return rv;
 }
+
+#if defined(OLD_RSA_GEN1)
+/*****************************************************************************/
+/* returns error
+   generates a new rsa key
+   exp is passed in and mod and pri are passed out */
+int APP_CC
+ssl_gen_key_xrdp1(int key_size_in_bits, char* exp, int exp_len,
+                  char* mod, int mod_len, char* pri, int pri_len)
+{
+  int my_e;
+  RSA* my_key;
+  char* lmod;
+  char* lpri;
+  tui8* lexp;
+  int error;
+  int len;
+
+  if ((exp_len != 4) || (mod_len != 64) || (pri_len != 64))
+  {
+    return 1;
+  }
+  lmod = (char*)g_malloc(mod_len, 0);
+  lpri = (char*)g_malloc(pri_len, 0);
+  lexp = (tui8*)exp;
+  my_e = lexp[0];
+  my_e |= lexp[1] << 8;
+  my_e |= lexp[2] << 16;
+  my_e |= lexp[3] << 24;
+  /* srand is in stdlib.h */
+  srand(g_time1());
+  my_key = RSA_generate_key(key_size_in_bits, my_e, 0, 0);
+  error = my_key == 0;
+  if (error == 0)
+  {
+    len = BN_num_bytes(my_key->n);
+    error = len != mod_len;
+  }
+  if (error == 0)
+  {
+    BN_bn2bin(my_key->n, (tui8*)lmod);
+    ssl_reverse_it(lmod, mod_len);
+  }
+  if (error == 0)
+  {
+    len = BN_num_bytes(my_key->d);
+    error = len != pri_len;
+  }
+  if (error == 0)
+  {
+    BN_bn2bin(my_key->d, (tui8*)lpri);
+    ssl_reverse_it(lpri, pri_len);
+  }
+  if (error == 0)
+  {
+    g_memcpy(mod, lmod, mod_len);
+    g_memcpy(pri, lpri, pri_len);
+  }
+  RSA_free(my_key);
+  g_free(lmod);
+  g_free(lpri);
+  return error;
+}
+#else
+/*****************************************************************************/
+/* returns error
+   generates a new rsa key
+   exp is passed in and mod and pri are passed out */
+int APP_CC
+ssl_gen_key_xrdp1(int key_size_in_bits, char* exp, int exp_len,
+                  char* mod, int mod_len, char* pri, int pri_len)
+{
+  BIGNUM* my_e;
+  RSA* my_key;
+  char* lexp;
+  char* lmod;
+  char* lpri;
+  int error;
+  int len;
+
+  if ((exp_len != 4) || (mod_len != 64) || (pri_len != 64))
+  {
+    return 1;
+  }
+  lexp = (char*)g_malloc(exp_len, 0);
+  lmod = (char*)g_malloc(mod_len, 0);
+  lpri = (char*)g_malloc(pri_len, 0);
+  g_memcpy(lexp, exp, exp_len);
+  ssl_reverse_it(lexp, exp_len);
+  my_e = BN_new();
+  BN_bin2bn((tui8*)lexp, exp_len, my_e);
+  my_key = RSA_new();
+  error = RSA_generate_key_ex(my_key, key_size_in_bits, my_e, 0) == 0;
+  if (error == 0)
+  {
+    len = BN_num_bytes(my_key->n);
+    error = len != mod_len;
+  }
+  if (error == 0)
+  {
+    BN_bn2bin(my_key->n, (tui8*)lmod);
+    ssl_reverse_it(lmod, mod_len);
+  }
+  if (error == 0)
+  {
+    len = BN_num_bytes(my_key->d);
+    error = len != pri_len;
+  }
+  if (error == 0)
+  {
+    BN_bn2bin(my_key->d, (tui8*)lpri);
+    ssl_reverse_it(lpri, pri_len);
+  }
+  if (error == 0)
+  {
+    g_memcpy(mod, lmod, mod_len);
+    g_memcpy(pri, lpri, pri_len);
+  }
+  BN_free(my_e);
+  RSA_free(my_key);
+  g_free(lexp);
+  g_free(lmod);
+  g_free(lpri);
+  return error;
+}
+#endif
diff --git a/common/ssl_calls.h b/common/ssl_calls.h
index a51044e..f0f0f91 100644
--- a/common/ssl_calls.h
+++ b/common/ssl_calls.h
@@ -14,7 +14,7 @@
    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
 
    xrdp: A Remote Desktop Protocol server.
-   Copyright (C) Jay Sorg 2004-2007
+   Copyright (C) Jay Sorg 2004-2008
 
 */
 
@@ -54,5 +54,8 @@ ssl_md5_complete(void* md5_info, char* data);
 int APP_CC
 ssl_mod_exp(char* out, int out_len, char* in, int in_len,
             char* mod, int mod_len, char* exp, int exp_len);
+int APP_CC
+ssl_gen_key_xrdp1(int key_size_in_bits, char* exp, int exp_len,
+                  char* mod, int mod_len, char* pri, int pri_len);
 
 #endif
diff --git a/common/thread_calls.c b/common/thread_calls.c
index d068b26..6e40faa 100644
--- a/common/thread_calls.c
+++ b/common/thread_calls.c
@@ -1,5 +1,5 @@
 /*
-   Copyright (c) 2004-2007 Jay Sorg
+   Copyright (c) 2004-2008 Jay Sorg
 
    Permission is hereby granted, free of charge, to any person obtaining a
    copy of this software and associated documentation files (the "Software"),
@@ -64,34 +64,46 @@ tc_thread_create(void* (* start_routine)(void*), void* arg)
 #endif
 
 /*****************************************************************************/
-long APP_CC
+tbus APP_CC
 tc_get_threadid(void)
 {
 #if defined(_WIN32)
-  return (long)GetCurrentThreadId();
+  return (tbus)GetCurrentThreadId();
 #else
-  return (long)pthread_self();
+  return (tbus)pthread_self();
 #endif
 }
 
 /*****************************************************************************/
-long APP_CC
+/* returns boolean */
+int APP_CC
+tc_threadid_equal(tbus tid1, tbus tid2)
+{
+#if defined(_WIN32)
+  return tid1 == tid2;
+#else
+  return pthread_equal((pthread_t)tid1, (pthread_t)tid2);
+#endif
+}
+
+/*****************************************************************************/
+tbus APP_CC
 tc_mutex_create(void)
 {
 #if defined(_WIN32)
-  return (long)CreateMutex(0, 0, 0);
+  return (tbus)CreateMutex(0, 0, 0);
 #else
   pthread_mutex_t* lmutex;
 
   lmutex = (pthread_mutex_t*)g_malloc(sizeof(pthread_mutex_t), 0);
   pthread_mutex_init(lmutex, 0);
-  return (long)lmutex;
+  return (tbus)lmutex;
 #endif
 }
 
 /*****************************************************************************/
 void APP_CC
-tc_mutex_delete(long mutex)
+tc_mutex_delete(tbus mutex)
 {
 #if defined(_WIN32)
   CloseHandle((HANDLE)mutex);
@@ -106,7 +118,7 @@ tc_mutex_delete(long mutex)
 
 /*****************************************************************************/
 int APP_CC
-tc_mutex_lock(long mutex)
+tc_mutex_lock(tbus mutex)
 {
 #if defined(_WIN32)
   WaitForSingleObject((HANDLE)mutex, INFINITE);
@@ -119,7 +131,7 @@ tc_mutex_lock(long mutex)
 
 /*****************************************************************************/
 int APP_CC
-tc_mutex_unlock(long mutex)
+tc_mutex_unlock(tbus mutex)
 {
 #if defined(_WIN32)
   ReleaseMutex((HANDLE)mutex);
@@ -131,26 +143,26 @@ tc_mutex_unlock(long mutex)
 }
 
 /*****************************************************************************/
-long APP_CC
+tbus APP_CC
 tc_sem_create(int init_count)
 {
 #if defined(_WIN32)
   HANDLE sem;
 
   sem = CreateSemaphore(0, init_count, init_count + 10, 0);
-  return (long)sem;
+  return (tbus)sem;
 #else
   sem_t* sem;
 
   sem = g_malloc(sizeof(sem_t), 0);
   sem_init(sem, 0, init_count);
-  return (long)sem;
+  return (tbus)sem;
 #endif
 }
 
 /*****************************************************************************/
 void APP_CC
-tc_sem_delete(long sem)
+tc_sem_delete(tbus sem)
 {
 #if defined(_WIN32)
   CloseHandle((HANDLE)sem);
@@ -165,7 +177,7 @@ tc_sem_delete(long sem)
 
 /*****************************************************************************/
 int APP_CC
-tc_sem_dec(long sem)
+tc_sem_dec(tbus sem)
 {
 #if defined(_WIN32)
   WaitForSingleObject((HANDLE)sem, INFINITE);
@@ -178,7 +190,7 @@ tc_sem_dec(long sem)
 
 /*****************************************************************************/
 int APP_CC
-tc_sem_inc(long sem)
+tc_sem_inc(tbus sem)
 {
 #if defined(_WIN32)
   ReleaseSemaphore((HANDLE)sem, 1, 0);
diff --git a/common/thread_calls.h b/common/thread_calls.h
index 0658363..d680544 100644
--- a/common/thread_calls.h
+++ b/common/thread_calls.h
@@ -1,5 +1,5 @@
 /*
-   Copyright (c) 2004-2007 Jay Sorg
+   Copyright (c) 2004-2008 Jay Sorg
 
    Permission is hereby granted, free of charge, to any person obtaining a
    copy of this software and associated documentation files (the "Software"),
@@ -30,23 +30,25 @@
 
 int APP_CC
 tc_thread_create(THREAD_RV (THREAD_CC * start_routine)(void*), void* arg);
-long APP_CC
+tbus APP_CC
 tc_get_threadid(void);
-long APP_CC
+int APP_CC
+tc_threadid_equal(tbus tid1, tbus tid2);
+tbus APP_CC
 tc_mutex_create(void);
 void APP_CC
-tc_mutex_delete(long mutex);
+tc_mutex_delete(tbus mutex);
 int APP_CC
-tc_mutex_lock(long mutex);
+tc_mutex_lock(tbus mutex);
 int APP_CC
-tc_mutex_unlock(long mutex);
-long APP_CC
+tc_mutex_unlock(tbus mutex);
+tbus APP_CC
 tc_sem_create(int init_count);
 void APP_CC
-tc_sem_delete(long sem);
+tc_sem_delete(tbus sem);
 int APP_CC
-tc_sem_dec(long sem);
+tc_sem_dec(tbus sem);
 int APP_CC
-tc_sem_inc(long sem);
+tc_sem_inc(tbus sem);
 
 #endif
diff --git a/common/trans.c b/common/trans.c
new file mode 100644
index 0000000..bbb0194
--- /dev/null
+++ b/common/trans.c
@@ -0,0 +1,342 @@
+/*
+   Copyright (c) 2008 Jay Sorg
+
+   Permission is hereby granted, free of charge, to any person obtaining a
+   copy of this software and associated documentation files (the "Software"),
+   to deal in the Software without restriction, including without limitation
+   the rights to use, copy, modify, merge, publish, distribute, sublicense,
+   and/or sell copies of the Software, and to permit persons to whom the
+   Software is furnished to do so, subject to the following conditions:
+
+   The above copyright notice and this permission notice shall be included
+   in all copies or substantial portions of the Software.
+
+   THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS
+   OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
+   FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
+   AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
+   LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
+   FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER
+   DEALINGS IN THE SOFTWARE.
+
+   generic transport
+
+*/
+
+#include "os_calls.h"
+#include "trans.h"
+#include "arch.h"
+#include "parse.h"
+
+/*****************************************************************************/
+struct trans* APP_CC
+trans_create(int mode, int in_size, int out_size)
+{
+  struct trans* self;
+
+  self = (struct trans*)g_malloc(sizeof(struct trans), 1);
+  make_stream(self->in_s);
+  init_stream(self->in_s, in_size);
+  make_stream(self->out_s);
+  init_stream(self->out_s, out_size);
+  self->mode = mode;
+  return self;
+}
+
+/*****************************************************************************/
+void APP_CC
+trans_delete(struct trans* self)
+{
+  if (self == 0)
+  {
+    return;
+  }
+  free_stream(self->in_s);
+  free_stream(self->out_s);
+  g_tcp_close(self->sck);
+  g_free(self);
+}
+
+/*****************************************************************************/
+int APP_CC
+trans_get_wait_objs(struct trans* self, tbus* objs, int* count, int* timeout)
+{
+  if (self == 0)
+  {
+    return 1;
+  }
+  if (self->status != 1)
+  {
+    return 1;
+  }
+  objs[*count] = self->sck;
+  (*count)++;
+  return 0;
+}
+
+/*****************************************************************************/
+int APP_CC
+trans_check_wait_objs(struct trans* self)
+{
+  tbus in_sck;
+  struct trans* in_trans;
+  int read_bytes;
+  int to_read;
+  int read_so_far;
+  int rv;
+
+  if (self == 0)
+  {
+    return 1;
+  }
+  if (self->status != 1)
+  {
+    return 1;
+  }
+  rv = 0;
+  if (self->type1 == 1) /* listening */
+  {
+    if (g_tcp_can_recv(self->sck, 0))
+    {
+      in_sck = g_tcp_accept(self->sck);
+      if (in_sck == -1)
+      {
+        if (g_tcp_last_error_would_block(self->sck))
+        {
+          /* ok, but shouldn't happen */
+        }
+        else
+        {
+          /* error */
+          self->status = 0;
+          rv = 1;
+        }
+      }
+      if (in_sck != -1)
+      {
+        if (self->trans_conn_in != 0) /* is function assigned */
+        {
+          in_trans = trans_create(self->mode, self->in_s->size,
+                                  self->out_s->size);
+          in_trans->sck = in_sck;
+          in_trans->type1 = 2;
+          in_trans->status = 1;
+          if (self->trans_conn_in(self, in_trans) != 0)
+          {
+            trans_delete(in_trans);
+          }
+        }
+        else
+        {
+          g_tcp_close(in_sck);
+        }
+      }
+    }
+  }
+  else /* connected server or client (2 or 3) */
+  {
+    if (g_tcp_can_recv(self->sck, 0))
+    {
+      read_so_far = (int)(self->in_s->end - self->in_s->data);
+      to_read = self->header_size - read_so_far;
+      read_bytes = g_tcp_recv(self->sck, self->in_s->end, to_read, 0);
+      if (read_bytes == -1)
+      {
+        if (g_tcp_last_error_would_block(self->sck))
+        {
+          /* ok, but shouldn't happen */
+        }
+        else
+        {
+          /* error */
+          self->status = 0;
+          rv = 1;
+        }
+      }
+      else if (read_bytes == 0)
+      {
+        /* error */
+        self->status = 0;
+        rv = 1;
+      }
+      else
+      {
+        self->in_s->end += read_bytes;
+      }
+      read_so_far = (int)(self->in_s->end - self->in_s->data);
+      if (read_so_far == self->header_size)
+      {
+        if (self->trans_data_in != 0)
+        {
+          rv = self->trans_data_in(self);
+          init_stream(self->in_s, 0);
+        }
+      }
+    }
+  }
+  return rv;
+}
+
+/*****************************************************************************/
+int APP_CC
+trans_force_read(struct trans* self, int size)
+{
+  int rv;
+  int rcvd;
+
+  if (self->status != 1)
+  {
+    return 1;
+  }
+  rv = 0;
+  while (size > 0)
+  {
+    rcvd = g_tcp_recv(self->sck, self->in_s->end, size, 0);
+    if (rcvd == -1)
+    {
+      if (g_tcp_last_error_would_block(self->sck))
+      {
+        if (!g_tcp_can_recv(self->sck, 10))
+        {
+          /* check for term here */
+        }
+      }
+      else
+      {
+        /* error */
+        self->status = 0;
+        rv = 1;
+      }
+    }
+    else if (rcvd == 0)
+    {
+      /* error */
+      self->status = 0;
+      rv = 1;
+    }
+    else
+    {
+      self->in_s->end += rcvd;
+      size -= rcvd;
+    }
+  }
+  return rv;
+}
+
+/*****************************************************************************/
+int APP_CC
+trans_force_write(struct trans* self)
+{
+  int size;
+  int total;
+  int rv;
+  int sent;
+
+  if (self->status != 1)
+  {
+    return 1;
+  }
+  rv = 0;
+  size = (int)(self->out_s->end - self->out_s->data);
+  total = 0;
+  while (total < size)
+  {
+    sent = g_tcp_send(self->sck, self->out_s->data + total, size - total, 0);
+    if (sent == -1)
+    {
+      if (g_tcp_last_error_would_block(self->sck))
+      {
+        if (!g_tcp_can_send(self->sck, 10))
+        {
+          /* check for term here */
+        }
+      }
+      else
+      {
+        /* error */
+        self->status = 0;
+        rv = 1;
+      }
+    }
+    else if (sent == 0)
+    {
+      /* error */
+      self->status = 0;
+      rv = 1;
+    }
+    else
+    {
+      total = total + sent;
+    }
+  }
+  return rv;
+}
+
+/*****************************************************************************/
+int APP_CC
+trans_connect(struct trans* self, const char* server, const char* port,
+              int timeout)
+{
+  int error;
+
+  if (self->sck != 0)
+  {
+    g_tcp_close(self->sck);
+  }
+  self->sck = g_tcp_socket();
+  g_tcp_set_non_blocking(self->sck);
+  error = g_tcp_connect(self->sck, server, port);
+  if (error == -1)
+  {
+    if (g_tcp_last_error_would_block(self->sck))
+    {
+      if (g_tcp_can_send(self->sck, timeout))
+      {
+        self->status = 1; /* ok */
+        self->type1 = 3; /* client */
+        return 0;
+      }
+    }
+    return 1;
+  }
+  self->status = 1; /* ok */
+  self->type1 = 3; /* client */
+  return 0;
+}
+
+/*****************************************************************************/
+int APP_CC
+trans_listen(struct trans* self, char* port)
+{
+  if (self->sck != 0)
+  {
+    g_tcp_close(self->sck);
+  }
+  self->sck = g_tcp_socket();
+  g_tcp_set_non_blocking(self->sck);
+  if (g_tcp_bind(self->sck, port) == 0)
+  {
+    if (g_tcp_listen(self->sck) == 0)
+    {
+      self->status = 1; /* ok */
+      self->type1 = 1; /* listener */
+      return 0;
+    }
+  }
+  return 1;
+}
+
+/*****************************************************************************/
+struct stream* APP_CC
+trans_get_in_s(struct trans* self)
+{
+  return self->in_s;
+}
+
+/*****************************************************************************/
+struct stream* APP_CC
+trans_get_out_s(struct trans* self, int size)
+{
+  init_stream(self->out_s, size);
+  return self->out_s;
+}
diff --git a/common/trans.h b/common/trans.h
new file mode 100644
index 0000000..b915ab9
--- /dev/null
+++ b/common/trans.h
@@ -0,0 +1,73 @@
+/*
+   Copyright (c) 2004-2008 Jay Sorg
+
+   Permission is hereby granted, free of charge, to any person obtaining a
+   copy of this software and associated documentation files (the "Software"),
+   to deal in the Software without restriction, including without limitation
+   the rights to use, copy, modify, merge, publish, distribute, sublicense,
+   and/or sell copies of the Software, and to permit persons to whom the
+   Software is furnished to do so, subject to the following conditions:
+
+   The above copyright notice and this permission notice shall be included
+   in all copies or substantial portions of the Software.
+
+   THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS
+   OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
+   FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
+   AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
+   LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
+   FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER
+   DEALINGS IN THE SOFTWARE.
+
+   generic transport
+
+*/
+
+#if !defined(TRANS_H)
+#define TRANS_H
+
+#include "arch.h"
+#include "parse.h"
+
+struct trans; /* forward declaration */
+
+typedef int (*ttrans_data_in)(struct trans* self);
+typedef int (*ttrans_conn_in)(struct trans* self, struct trans* new_self);
+
+struct trans
+{
+  tbus sck;
+  int mode; /* tcp, shared memory, pipes */
+  int status;
+  int type1; /* 1 listener 2 server 3 client */
+  ttrans_data_in trans_data_in;
+  ttrans_conn_in trans_conn_in;
+  void* callback_data;
+  int header_size;
+  struct stream* in_s;
+  struct stream* out_s;
+};
+
+struct trans* APP_CC
+trans_create(int mode, int in_size, int out_size);
+void APP_CC
+trans_delete(struct trans* self);
+int APP_CC
+trans_get_wait_objs(struct trans* self, tbus* objs, int* count, int* timeout);
+int APP_CC
+trans_check_wait_objs(struct trans* self);
+int APP_CC
+trans_force_read(struct trans* self, int size);
+int APP_CC
+trans_force_write(struct trans* self);
+int APP_CC
+trans_connect(struct trans* self, const char* server, const char* port,
+              int timeout);
+int APP_CC
+trans_listen(struct trans* self, char* port);
+struct stream* APP_CC
+trans_get_in_s(struct trans* self);
+struct stream* APP_CC
+trans_get_out_s(struct trans* self, int size);
+
+#endif
diff --git a/common/xrdp_constants.h b/common/xrdp_constants.h
index 30ffeff..f61c320 100644
--- a/common/xrdp_constants.h
+++ b/common/xrdp_constants.h
@@ -1,7 +1,7 @@
 /*
    rdesktop: A Remote Desktop Protocol client.
    Miscellaneous protocol constants
-   Copyright (C) Matthew Chapman 1999-2007
+   Copyright (C) Matthew Chapman 1999-2008
 
    This program is free software; you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
@@ -221,10 +221,25 @@
 #define RDP_CAPSET_COLCACHE            10
 #define RDP_CAPLEN_COLCACHE            0x08
 
+#define RDP_CAPSET_INPUT               13
+#define RDP_CAPLEN_INPUT               0x58
+
+#define RDP_CAPSET_FONT                14
+#define RDP_CAPLEN_FONT                0x04
+
+#define RDP_CAPSET_BRUSHCACHE          15
+#define RDP_CAPLEN_BRUSHCACHE          0x08
+
+#define RDP_CAPSET_BITMAP_OFFSCREEN    18
+#define RDP_CAPLEN_BITMAP_OFFSCREEN    0x08
+
 #define RDP_CAPSET_BMPCACHE2           19
 #define RDP_CAPLEN_BMPCACHE2           0x28
 #define BMPCACHE2_FLAG_PERSIST         ((long)1<<31)
 
+#define RDP_CAPSET_VIRCHAN             20
+#define RDP_CAPLEN_VIRCHAN             0x08
+
 #define RDP_SOURCE                     "MSTSC"
 
 /* Logon flags */
@@ -402,6 +417,7 @@
 #define RDP_ORDER_FONTCACHE     3
 #define RDP_ORDER_RAW_BMPCACHE2 4
 #define RDP_ORDER_BMPCACHE2     5
+#define RDP_ORDER_BRUSHCACHE    7
 
 /* drawable types */
 #define WND_TYPE_BITMAP  0
@@ -413,6 +429,7 @@
 #define WND_TYPE_LABEL   6
 #define WND_TYPE_COMBO   7
 #define WND_TYPE_SPECIAL 8
+#define WND_TYPE_LISTBOX 9
 
 /* button states */
 #define BUTTON_STATE_UP   0
diff --git a/configure.ac b/configure.ac
new file mode 100644
index 0000000..788c8a0
--- /dev/null
+++ b/configure.ac
@@ -0,0 +1,62 @@
+# Process this file with autoconf to produce a configure script
+
+AC_PREREQ(2.59)
+AC_INIT([xrdp], [0.5.0], [xrdp-devel@lists.sourceforge.net])
+AC_CONFIG_HEADERS([config_ac.h:config_ac-h.in])
+AM_INIT_AUTOMAKE([1.6 foreign])
+AC_PROG_CC
+AC_C_CONST
+AC_PROG_LIBTOOL
+AC_ARG_ENABLE(nopam, AS_HELP_STRING([--enable-nopam],
+              [Build no PAM support (default: no)]),
+              [nopam=true], [nopam=false])
+AM_CONDITIONAL(SESMAN_NOPAM, [test x$nopam = xtrue])
+AC_ARG_ENABLE(kerberos, AS_HELP_STRING([--enable-kerberos],
+              [Build kerberos support (default: no)]),
+              [kerberos=true], [kerberos=false])
+AM_CONDITIONAL(SESMAN_KERBEROS, [test x$kerberos = xtrue])
+AC_ARG_ENABLE(pamuserpass, AS_HELP_STRING([--enable-pamuserpass],
+              [Build pam userpass support (default: no)]),
+              [pamuserpass=true], [pamuserpass=false])
+AM_CONDITIONAL(SESMAN_PAMUSERPASS, [test x$pamuserpass = xtrue])
+libdir="${libdir}/xrdp/";
+if test "x${prefix}" = "xNONE" ; then
+sysconfdir="/etc/";
+else
+AC_DEFINE_UNQUOTED([XRDP_CFG_PATH], ["${prefix}/etc/xrdp"], [xrdp config dir])
+AC_DEFINE_UNQUOTED([XRDP_CFG_FILE], ["${prefix}/etc/xrdp/xrdp.ini"], [xrdp config file])
+AC_DEFINE_UNQUOTED([XRDP_KEY_FILE], ["${prefix}/etc/xrdp/rsakeys.ini"], [xrdp key file])
+AC_DEFINE_UNQUOTED([XRDP_KEYMAP_FILE], ["${prefix}/etc/xrdp/km-%4.4x.ini"], [xrdp keymap file])
+AC_DEFINE_UNQUOTED([XRDP_PID_FILE], ["${prefix}/var/run/xrdp.pid"], [xrdp pid file])
+AC_DEFINE_UNQUOTED([XRDP_SBIN_PATH], ["${prefix}/sbin"], [xrdp sbin dir])
+AC_DEFINE_UNQUOTED([XRDP_SHARE_PATH], ["${prefix}/share/xrdp"], [xrdp share dir])
+AC_DEFINE_UNQUOTED([SESMAN_PID_FILE], ["${prefix}/var/run/sesman.pid"], [sesman pid file])
+AC_DEFINE_UNQUOTED([SESMAN_CFG_FILE], ["${prefix}/etc/xrdp/sesman.ini"], [sesman config file])
+fi
+AC_CONFIG_FILES([Makefile
+                 common/Makefile
+                 vnc/Makefile
+                 rdp/Makefile
+                 libxrdp/Makefile
+                 xup/Makefile
+                 mc/Makefile
+                 xrdp/Makefile
+                 sesman/Makefile
+                 sesman/libscp/Makefile
+                 sesman/tools/Makefile
+                 keygen/Makefile
+                 docs/Makefile
+                 docs/man/Makefile
+                 instfiles/Makefile
+                 instfiles/pam.d/Makefile
+])
+#                 fontdump/Makefile
+#                 xrdp/cursors/Makefile
+#                 Xserver/hw/rdp/Makefile
+AC_OUTPUT
+
+# example of how to check for a struct in a header
+#AC_CHECK_MEMBER([struct in6_addr.s6_addr],
+#                [],
+#                [AC_DEFINE(NO_ARPA_INET_H_IP6, 1, [for IPv6])],
+#                [#include <arpa/inet.h>])
diff --git a/debian/changelog b/debian/changelog
deleted file mode 100644
index cd6afae..0000000
--- a/debian/changelog
+++ /dev/null
@@ -1,9 +0,0 @@
-xrdp (0.3.1) unstable; urgency=low
-
-  * Initial Release.
-
- -- Jay Sorg <jay.sorg@gmail.com>  Sat, 6 August 2006 13:58:29 -0600
-
-Local variables:
-mode: debian-changelog
-End:
diff --git a/debian/compat b/debian/compat
deleted file mode 100644
index b8626c4..0000000
--- a/debian/compat
+++ /dev/null
@@ -1 +0,0 @@
-4
diff --git a/debian/control b/debian/control
deleted file mode 100644
index baed8a4..0000000
--- a/debian/control
+++ /dev/null
@@ -1,13 +0,0 @@
-Source: xrdp
-Section: net
-Priority: optional
-Maintainer: Jay Sorg <jay.sorg@gmail.com>, Per Hansen <spamhans@yahoo.de>
-Build-Depends: debhelper (>= 4.0.0) libssl-dev, libpam0g-dev
-Standards-Version: 3.6.0
-
-Package: xrdp
-Architecture: i386
-Depends: ${shlibs:Depends}, ${misc:Depends}
-Description: <An open source remote desktop protocol(rdp) server.>
- Based on the work of rdesktop, xrdp uses the remote desktop
- protocol to present a GUI to the user.
diff --git a/debian/copyright b/debian/copyright
deleted file mode 100644
index 7adb8c5..0000000
--- a/debian/copyright
+++ /dev/null
@@ -1,25 +0,0 @@
-This is xrdp, written and maintained by Jay Sorg <jay.sorg@gmail.com>
-on Sat, 06 August 2006 13:58:29 -0600.
-
-The original source can always be found at:
-	ftp://ftp.debian.org/dists/unstable/main/source/
-
-Copyright (C) 2003-2007  Jay Sorg
-
-  This program is free software; you can redistribute it and/or modify
-  it under the terms of the GNU General Public License as published by
-  the Free Software Foundation; either version 2 of the License, or
-  (at your option) any later version.
-
-  This program is distributed in the hope that it will be useful,
-  but WITHOUT ANY WARRANTY; without even the implied warranty of
-  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-  GNU General Public License for more details.
-
-  You should have received a copy of the GNU General Public License
-  along with this package; if not, write to the Free Software
-  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
-  02111-1307, USA.
-
-On Debian systems, the complete text of the GNU General
-Public License can be found in `/usr/share/common-licenses/GPL'.
diff --git a/debian/dirs b/debian/dirs
deleted file mode 100644
index 2752281..0000000
--- a/debian/dirs
+++ /dev/null
@@ -1,2 +0,0 @@
-usr/lib/xrdp
-etc/xrdp
diff --git a/debian/docs b/debian/docs
deleted file mode 100644
index e69de29..0000000
diff --git a/debian/postinst b/debian/postinst
deleted file mode 100644
index 7a4a5b7..0000000
--- a/debian/postinst
+++ /dev/null
@@ -1,2 +0,0 @@
-#!/bin/sh
-update-rc.d xrdp_control.sh defaults > /dev/null
diff --git a/debian/postrm b/debian/postrm
deleted file mode 100644
index deca14b..0000000
--- a/debian/postrm
+++ /dev/null
@@ -1,2 +0,0 @@
-#!/bin/sh
-update-rc.d -f xrdp_control.sh remove > /dev/null
diff --git a/debian/preinst b/debian/preinst
deleted file mode 100644
index 4db03d1..0000000
--- a/debian/preinst
+++ /dev/null
@@ -1,6 +0,0 @@
-#!/bin/sh
-if [ -e /usr/lib/xrdp/xrdp ]; then
-  if [ -e /etc/init.d/xrdp_control.sh ]; then
-    /etc/init.d/xrdp_control.sh stop
-  fi
-fi
diff --git a/debian/prerm b/debian/prerm
deleted file mode 100644
index 060c2d4..0000000
--- a/debian/prerm
+++ /dev/null
@@ -1,6 +0,0 @@
-#!/bin/sh
-if [ -e /usr/lib/xrdp ]; then
-  if [ -e /etc/init.d/xrdp_control.sh ]; then
-    /etc/init.d/xrdp_control.sh stop
-  fi
-fi
diff --git a/debian/readme.txt b/debian/readme.txt
deleted file mode 100644
index 867843c..0000000
--- a/debian/readme.txt
+++ /dev/null
@@ -1,8 +0,0 @@
-This is the debian directory used to make a .deb file to install
-xrdp.  It installs to /usr/lib/xrdp.
-
-To make a new deb type
-remember, debian/rules must be executable
-fakeroot dpkg-buildpackage -b -uc -us -d
-
-Jay
diff --git a/debian/rules b/debian/rules
deleted file mode 100644
index 48ff9b6..0000000
--- a/debian/rules
+++ /dev/null
@@ -1,98 +0,0 @@
-#!/usr/bin/make -f
-# -*- makefile -*-
-# Sample debian/rules that uses debhelper.
-# GNU copyright 1997 to 1999 by Joey Hess.
-
-# Uncomment this to turn on verbose mode.
-#export DH_VERBOSE=1
-
-
-
-
-CFLAGS = -Wall -g
-
-ifneq (,$(findstring noopt,$(DEB_BUILD_OPTIONS)))
-	CFLAGS += -O0
-else
-	CFLAGS += -O2
-endif
-ifeq (,$(findstring nostrip,$(DEB_BUILD_OPTIONS)))
-	INSTALL_PROGRAM += -s
-endif
-
-configure: configure-stamp
-configure-stamp:
-	dh_testdir
-	# Add here commands to configure the package.
-
-	touch configure-stamp
-
-
-build: build-stamp
-
-build-stamp: configure-stamp
-	dh_testdir
-
-	# Add here commands to compile the package.
-	$(MAKE)
-	#/usr/bin/docbook-to-man debian/xrdp.sgml > xrdp.1
-
-	touch build-stamp
-
-clean:
-	dh_testdir
-	dh_testroot
-	rm -f build-stamp configure-stamp
-
-	# Add here commands to clean up after the build process.
-	-$(MAKE) clean
-
-	dh_clean
-
-install: build
-	dh_testdir
-	dh_testroot
-	dh_clean -k
-	dh_installdirs
-
-	# Add here commands to install the package into debian/xrdp.
-	$(MAKE) installdeb DESTDIRDEB=$(CURDIR)/debian/xrdp
-
-
-# Build architecture-independent files here.
-binary-indep: build install
-# We have nothing to do by default.
-
-# Build architecture-dependent files here.
-binary-arch: build install
-	dh_testdir
-	dh_testroot
-	dh_installchangelogs
-	dh_installdocs
-	dh_installexamples
-#	dh_install
-#	dh_installmenu
-#	dh_installdebconf
-#	dh_installlogrotate
-#	dh_installemacsen
-#	dh_installpam
-#	dh_installmime
-#	dh_installinit
-#	dh_installcron
-#	dh_installinfo
-	dh_installman
-	dh_link
-	dh_strip
-	dh_compress
-	dh_fixperms
-#	dh_perl
-#	dh_python
-#	dh_makeshlibs
-	dh_installdeb
-	dh_shlibdeps
-	dh_gencontrol
-	dh_md5sums
-	dh_builddeb
-
-binary: binary-indep binary-arch
-.PHONY: build clean binary-indep binary-arch binary install configure
diff --git a/docs/Makefile b/docs/Makefile
index a7caf55..0efc227 100644
--- a/docs/Makefile
+++ b/docs/Makefile
@@ -1,19 +1,483 @@
+# Makefile.in generated by automake 1.10.1 from Makefile.am.
+# docs/Makefile.  Generated from Makefile.in by configure.
 
-DESTDIR = /usr/local/xrdp
-CFGDIR = /etc/xrdp
-PIDDIR = /var/run
-MANDIR = /usr/local/man
-DOCDIR = /usr/doc/xrdp
+# Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
+# 2003, 2004, 2005, 2006, 2007, 2008  Free Software Foundation, Inc.
+# This Makefile.in is free software; the Free Software Foundation
+# gives unlimited permission to copy and/or distribute it,
+# with or without modifications, as long as this notice is preserved.
 
-all: world
+# This program is distributed in the hope that it will be useful,
+# but WITHOUT ANY WARRANTY, to the extent permitted by law; without
+# even the implied warranty of MERCHANTABILITY or FITNESS FOR A
+# PARTICULAR PURPOSE.
 
-world:
 
-install:
 
-installdeb:
-	install man/sesman.8 $(DESTDIRDEB)/usr/man/man8/sesman.8
-	install man/sesrun.8 $(DESTDIRDEB)/usr/man/man8/sesrun.8
-	install man/xrdp.8 $(DESTDIRDEB)/usr/man/man8/xrdp.8
-	install man/sesman.ini.5 $(DESTDIRDEB)/usr/man/man5/sesman.ini.5
-	install man/xrdp.ini.5 $(DESTDIRDEB)/usr/man/man5/xrdp.ini.5
+pkgdatadir = $(datadir)/xrdp
+pkglibdir = $(libdir)/xrdp
+pkgincludedir = $(includedir)/xrdp
+am__cd = CDPATH="$${ZSH_VERSION+.}$(PATH_SEPARATOR)" && cd
+install_sh_DATA = $(install_sh) -c -m 644
+install_sh_PROGRAM = $(install_sh) -c
+install_sh_SCRIPT = $(install_sh) -c
+INSTALL_HEADER = $(INSTALL_DATA)
+transform = $(program_transform_name)
+NORMAL_INSTALL = :
+PRE_INSTALL = :
+POST_INSTALL = :
+NORMAL_UNINSTALL = :
+PRE_UNINSTALL = :
+POST_UNINSTALL = :
+build_triplet = i686-suse-linux-gnu
+host_triplet = i686-suse-linux-gnu
+subdir = docs
+DIST_COMMON = $(srcdir)/Makefile.am $(srcdir)/Makefile.in
+ACLOCAL_M4 = $(top_srcdir)/aclocal.m4
+am__aclocal_m4_deps = $(top_srcdir)/configure.ac
+am__configure_deps = $(am__aclocal_m4_deps) $(CONFIGURE_DEPENDENCIES) \
+	$(ACLOCAL_M4)
+mkinstalldirs = $(install_sh) -d
+CONFIG_HEADER = $(top_builddir)/config_ac.h
+CONFIG_CLEAN_FILES =
+SOURCES =
+DIST_SOURCES =
+RECURSIVE_TARGETS = all-recursive check-recursive dvi-recursive \
+	html-recursive info-recursive install-data-recursive \
+	install-dvi-recursive install-exec-recursive \
+	install-html-recursive install-info-recursive \
+	install-pdf-recursive install-ps-recursive install-recursive \
+	installcheck-recursive installdirs-recursive pdf-recursive \
+	ps-recursive uninstall-recursive
+RECURSIVE_CLEAN_TARGETS = mostlyclean-recursive clean-recursive	\
+  distclean-recursive maintainer-clean-recursive
+ETAGS = etags
+CTAGS = ctags
+DIST_SUBDIRS = $(SUBDIRS)
+DISTFILES = $(DIST_COMMON) $(DIST_SOURCES) $(TEXINFOS) $(EXTRA_DIST)
+ACLOCAL = ${SHELL} /home/david/git/xrdp/missing --run aclocal-1.10
+AMTAR = ${SHELL} /home/david/git/xrdp/missing --run tar
+AR = ar
+AUTOCONF = ${SHELL} /home/david/git/xrdp/missing --run autoconf
+AUTOHEADER = ${SHELL} /home/david/git/xrdp/missing --run autoheader
+AUTOMAKE = ${SHELL} /home/david/git/xrdp/missing --run automake-1.10
+AWK = gawk
+CC = gcc
+CCDEPMODE = depmode=gcc3
+CFLAGS = -g -O2
+CPP = gcc -E
+CPPFLAGS = 
+CXX = g++
+CXXCPP = g++ -E
+CXXDEPMODE = depmode=gcc3
+CXXFLAGS = -g -O2
+CYGPATH_W = echo
+DEFS = -DHAVE_CONFIG_H
+DEPDIR = .deps
+DSYMUTIL = 
+ECHO = echo
+ECHO_C = 
+ECHO_N = -n
+ECHO_T = 
+EGREP = /usr/bin/grep -E
+EXEEXT = 
+F77 = 
+FFLAGS = 
+GREP = /usr/bin/grep
+INSTALL = /usr/bin/install -c
+INSTALL_DATA = ${INSTALL} -m 644
+INSTALL_PROGRAM = ${INSTALL}
+INSTALL_SCRIPT = ${INSTALL}
+INSTALL_STRIP_PROGRAM = $(install_sh) -c -s
+LDFLAGS = 
+LIBOBJS = 
+LIBS = 
+LIBTOOL = $(SHELL) $(top_builddir)/libtool
+LN_S = ln -s
+LTLIBOBJS = 
+MAKEINFO = ${SHELL} /home/david/git/xrdp/missing --run makeinfo
+MKDIR_P = /bin/mkdir -p
+NMEDIT = 
+OBJEXT = o
+PACKAGE = xrdp
+PACKAGE_BUGREPORT = xrdp-devel@lists.sourceforge.net
+PACKAGE_NAME = xrdp
+PACKAGE_STRING = xrdp 0.5.0
+PACKAGE_TARNAME = xrdp
+PACKAGE_VERSION = 0.5.0
+PATH_SEPARATOR = :
+RANLIB = ranlib
+SED = /usr/bin/sed
+SET_MAKE = 
+SHELL = /bin/sh
+STRIP = strip
+VERSION = 0.5.0
+abs_builddir = /home/david/git/xrdp/docs
+abs_srcdir = /home/david/git/xrdp/docs
+abs_top_builddir = /home/david/git/xrdp
+abs_top_srcdir = /home/david/git/xrdp
+ac_ct_CC = gcc
+ac_ct_CXX = g++
+ac_ct_F77 = 
+am__include = include
+am__leading_dot = .
+am__quote = 
+am__tar = ${AMTAR} chof - "$$tardir"
+am__untar = ${AMTAR} xf -
+bindir = ${exec_prefix}/bin
+build = i686-suse-linux-gnu
+build_alias = 
+build_cpu = i686
+build_os = linux-gnu
+build_vendor = suse
+builddir = .
+datadir = ${datarootdir}
+datarootdir = ${prefix}/share
+docdir = ${datarootdir}/doc/${PACKAGE_TARNAME}
+dvidir = ${docdir}
+exec_prefix = ${prefix}
+host = i686-suse-linux-gnu
+host_alias = 
+host_cpu = i686
+host_os = linux-gnu
+host_vendor = suse
+htmldir = ${docdir}
+includedir = ${prefix}/include
+infodir = ${datarootdir}/info
+install_sh = $(SHELL) /home/david/git/xrdp/install-sh
+libdir = ${exec_prefix}/lib/xrdp/
+libexecdir = ${exec_prefix}/libexec
+localedir = ${datarootdir}/locale
+localstatedir = ${prefix}/var
+mandir = ${datarootdir}/man
+mkdir_p = /bin/mkdir -p
+oldincludedir = /usr/include
+pdfdir = ${docdir}
+prefix = /usr
+program_transform_name = s,x,x,
+psdir = ${docdir}
+sbindir = ${exec_prefix}/sbin
+sharedstatedir = ${prefix}/com
+srcdir = .
+sysconfdir = ${prefix}/etc
+target_alias = 
+top_builddir = ..
+top_srcdir = ..
+SUBDIRS = \
+  man
+
+all: all-recursive
+
+.SUFFIXES:
+$(srcdir)/Makefile.in:  $(srcdir)/Makefile.am  $(am__configure_deps)
+	@for dep in $?; do \
+	  case '$(am__configure_deps)' in \
+	    *$$dep*) \
+	      cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh \
+		&& exit 0; \
+	      exit 1;; \
+	  esac; \
+	done; \
+	echo ' cd $(top_srcdir) && $(AUTOMAKE) --foreign  docs/Makefile'; \
+	cd $(top_srcdir) && \
+	  $(AUTOMAKE) --foreign  docs/Makefile
+.PRECIOUS: Makefile
+Makefile: $(srcdir)/Makefile.in $(top_builddir)/config.status
+	@case '$?' in \
+	  *config.status*) \
+	    cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh;; \
+	  *) \
+	    echo ' cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe)'; \
+	    cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe);; \
+	esac;
+
+$(top_builddir)/config.status: $(top_srcdir)/configure $(CONFIG_STATUS_DEPENDENCIES)
+	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
+
+$(top_srcdir)/configure:  $(am__configure_deps)
+	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
+$(ACLOCAL_M4):  $(am__aclocal_m4_deps)
+	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
+
+mostlyclean-libtool:
+	-rm -f *.lo
+
+clean-libtool:
+	-rm -rf .libs _libs
+
+# This directory's subdirectories are mostly independent; you can cd
+# into them and run `make' without going through this Makefile.
+# To change the values of `make' variables: instead of editing Makefiles,
+# (1) if the variable is set in `config.status', edit `config.status'
+#     (which will cause the Makefiles to be regenerated when you run `make');
+# (2) otherwise, pass the desired values on the `make' command line.
+$(RECURSIVE_TARGETS):
+	@failcom='exit 1'; \
+	for f in x $$MAKEFLAGS; do \
+	  case $$f in \
+	    *=* | --[!k]*);; \
+	    *k*) failcom='fail=yes';; \
+	  esac; \
+	done; \
+	dot_seen=no; \
+	target=`echo $@ | sed s/-recursive//`; \
+	list='$(SUBDIRS)'; for subdir in $$list; do \
+	  echo "Making $$target in $$subdir"; \
+	  if test "$$subdir" = "."; then \
+	    dot_seen=yes; \
+	    local_target="$$target-am"; \
+	  else \
+	    local_target="$$target"; \
+	  fi; \
+	  (cd $$subdir && $(MAKE) $(AM_MAKEFLAGS) $$local_target) \
+	  || eval $$failcom; \
+	done; \
+	if test "$$dot_seen" = "no"; then \
+	  $(MAKE) $(AM_MAKEFLAGS) "$$target-am" || exit 1; \
+	fi; test -z "$$fail"
+
+$(RECURSIVE_CLEAN_TARGETS):
+	@failcom='exit 1'; \
+	for f in x $$MAKEFLAGS; do \
+	  case $$f in \
+	    *=* | --[!k]*);; \
+	    *k*) failcom='fail=yes';; \
+	  esac; \
+	done; \
+	dot_seen=no; \
+	case "$@" in \
+	  distclean-* | maintainer-clean-*) list='$(DIST_SUBDIRS)' ;; \
+	  *) list='$(SUBDIRS)' ;; \
+	esac; \
+	rev=''; for subdir in $$list; do \
+	  if test "$$subdir" = "."; then :; else \
+	    rev="$$subdir $$rev"; \
+	  fi; \
+	done; \
+	rev="$$rev ."; \
+	target=`echo $@ | sed s/-recursive//`; \
+	for subdir in $$rev; do \
+	  echo "Making $$target in $$subdir"; \
+	  if test "$$subdir" = "."; then \
+	    local_target="$$target-am"; \
+	  else \
+	    local_target="$$target"; \
+	  fi; \
+	  (cd $$subdir && $(MAKE) $(AM_MAKEFLAGS) $$local_target) \
+	  || eval $$failcom; \
+	done && test -z "$$fail"
+tags-recursive:
+	list='$(SUBDIRS)'; for subdir in $$list; do \
+	  test "$$subdir" = . || (cd $$subdir && $(MAKE) $(AM_MAKEFLAGS) tags); \
+	done
+ctags-recursive:
+	list='$(SUBDIRS)'; for subdir in $$list; do \
+	  test "$$subdir" = . || (cd $$subdir && $(MAKE) $(AM_MAKEFLAGS) ctags); \
+	done
+
+ID: $(HEADERS) $(SOURCES) $(LISP) $(TAGS_FILES)
+	list='$(SOURCES) $(HEADERS) $(LISP) $(TAGS_FILES)'; \
+	unique=`for i in $$list; do \
+	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
+	  done | \
+	  $(AWK) '{ files[$$0] = 1; nonemtpy = 1; } \
+	      END { if (nonempty) { for (i in files) print i; }; }'`; \
+	mkid -fID $$unique
+tags: TAGS
+
+TAGS: tags-recursive $(HEADERS) $(SOURCES)  $(TAGS_DEPENDENCIES) \
+		$(TAGS_FILES) $(LISP)
+	tags=; \
+	here=`pwd`; \
+	if ($(ETAGS) --etags-include --version) >/dev/null 2>&1; then \
+	  include_option=--etags-include; \
+	  empty_fix=.; \
+	else \
+	  include_option=--include; \
+	  empty_fix=; \
+	fi; \
+	list='$(SUBDIRS)'; for subdir in $$list; do \
+	  if test "$$subdir" = .; then :; else \
+	    test ! -f $$subdir/TAGS || \
+	      tags="$$tags $$include_option=$$here/$$subdir/TAGS"; \
+	  fi; \
+	done; \
+	list='$(SOURCES) $(HEADERS)  $(LISP) $(TAGS_FILES)'; \
+	unique=`for i in $$list; do \
+	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
+	  done | \
+	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
+	      END { if (nonempty) { for (i in files) print i; }; }'`; \
+	if test -z "$(ETAGS_ARGS)$$tags$$unique"; then :; else \
+	  test -n "$$unique" || unique=$$empty_fix; \
+	  $(ETAGS) $(ETAGSFLAGS) $(AM_ETAGSFLAGS) $(ETAGS_ARGS) \
+	    $$tags $$unique; \
+	fi
+ctags: CTAGS
+CTAGS: ctags-recursive $(HEADERS) $(SOURCES)  $(TAGS_DEPENDENCIES) \
+		$(TAGS_FILES) $(LISP)
+	tags=; \
+	list='$(SOURCES) $(HEADERS)  $(LISP) $(TAGS_FILES)'; \
+	unique=`for i in $$list; do \
+	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
+	  done | \
+	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
+	      END { if (nonempty) { for (i in files) print i; }; }'`; \
+	test -z "$(CTAGS_ARGS)$$tags$$unique" \
+	  || $(CTAGS) $(CTAGSFLAGS) $(AM_CTAGSFLAGS) $(CTAGS_ARGS) \
+	     $$tags $$unique
+
+GTAGS:
+	here=`$(am__cd) $(top_builddir) && pwd` \
+	  && cd $(top_srcdir) \
+	  && gtags -i $(GTAGS_ARGS) $$here
+
+distclean-tags:
+	-rm -f TAGS ID GTAGS GRTAGS GSYMS GPATH tags
+
+distdir: $(DISTFILES)
+	@srcdirstrip=`echo "$(srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
+	topsrcdirstrip=`echo "$(top_srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
+	list='$(DISTFILES)'; \
+	  dist_files=`for file in $$list; do echo $$file; done | \
+	  sed -e "s|^$$srcdirstrip/||;t" \
+	      -e "s|^$$topsrcdirstrip/|$(top_builddir)/|;t"`; \
+	case $$dist_files in \
+	  */*) $(MKDIR_P) `echo "$$dist_files" | \
+			   sed '/\//!d;s|^|$(distdir)/|;s,/[^/]*$$,,' | \
+			   sort -u` ;; \
+	esac; \
+	for file in $$dist_files; do \
+	  if test -f $$file || test -d $$file; then d=.; else d=$(srcdir); fi; \
+	  if test -d $$d/$$file; then \
+	    dir=`echo "/$$file" | sed -e 's,/[^/]*$$,,'`; \
+	    if test -d $(srcdir)/$$file && test $$d != $(srcdir); then \
+	      cp -pR $(srcdir)/$$file $(distdir)$$dir || exit 1; \
+	    fi; \
+	    cp -pR $$d/$$file $(distdir)$$dir || exit 1; \
+	  else \
+	    test -f $(distdir)/$$file \
+	    || cp -p $$d/$$file $(distdir)/$$file \
+	    || exit 1; \
+	  fi; \
+	done
+	list='$(DIST_SUBDIRS)'; for subdir in $$list; do \
+	  if test "$$subdir" = .; then :; else \
+	    test -d "$(distdir)/$$subdir" \
+	    || $(MKDIR_P) "$(distdir)/$$subdir" \
+	    || exit 1; \
+	    distdir=`$(am__cd) $(distdir) && pwd`; \
+	    top_distdir=`$(am__cd) $(top_distdir) && pwd`; \
+	    (cd $$subdir && \
+	      $(MAKE) $(AM_MAKEFLAGS) \
+	        top_distdir="$$top_distdir" \
+	        distdir="$$distdir/$$subdir" \
+		am__remove_distdir=: \
+		am__skip_length_check=: \
+	        distdir) \
+	      || exit 1; \
+	  fi; \
+	done
+check-am: all-am
+check: check-recursive
+all-am: Makefile
+installdirs: installdirs-recursive
+installdirs-am:
+install: install-recursive
+install-exec: install-exec-recursive
+install-data: install-data-recursive
+uninstall: uninstall-recursive
+
+install-am: all-am
+	@$(MAKE) $(AM_MAKEFLAGS) install-exec-am install-data-am
+
+installcheck: installcheck-recursive
+install-strip:
+	$(MAKE) $(AM_MAKEFLAGS) INSTALL_PROGRAM="$(INSTALL_STRIP_PROGRAM)" \
+	  install_sh_PROGRAM="$(INSTALL_STRIP_PROGRAM)" INSTALL_STRIP_FLAG=-s \
+	  `test -z '$(STRIP)' || \
+	    echo "INSTALL_PROGRAM_ENV=STRIPPROG='$(STRIP)'"` install
+mostlyclean-generic:
+
+clean-generic:
+
+distclean-generic:
+	-test -z "$(CONFIG_CLEAN_FILES)" || rm -f $(CONFIG_CLEAN_FILES)
+
+maintainer-clean-generic:
+	@echo "This command is intended for maintainers to use"
+	@echo "it deletes files that may require special tools to rebuild."
+clean: clean-recursive
+
+clean-am: clean-generic clean-libtool mostlyclean-am
+
+distclean: distclean-recursive
+	-rm -f Makefile
+distclean-am: clean-am distclean-generic distclean-tags
+
+dvi: dvi-recursive
+
+dvi-am:
+
+html: html-recursive
+
+info: info-recursive
+
+info-am:
+
+install-data-am:
+
+install-dvi: install-dvi-recursive
+
+install-exec-am:
+
+install-html: install-html-recursive
+
+install-info: install-info-recursive
+
+install-man:
+
+install-pdf: install-pdf-recursive
+
+install-ps: install-ps-recursive
+
+installcheck-am:
+
+maintainer-clean: maintainer-clean-recursive
+	-rm -f Makefile
+maintainer-clean-am: distclean-am maintainer-clean-generic
+
+mostlyclean: mostlyclean-recursive
+
+mostlyclean-am: mostlyclean-generic mostlyclean-libtool
+
+pdf: pdf-recursive
+
+pdf-am:
+
+ps: ps-recursive
+
+ps-am:
+
+uninstall-am:
+
+.MAKE: $(RECURSIVE_CLEAN_TARGETS) $(RECURSIVE_TARGETS) install-am \
+	install-strip
+
+.PHONY: $(RECURSIVE_CLEAN_TARGETS) $(RECURSIVE_TARGETS) CTAGS GTAGS \
+	all all-am check check-am clean clean-generic clean-libtool \
+	ctags ctags-recursive distclean distclean-generic \
+	distclean-libtool distclean-tags distdir dvi dvi-am html \
+	html-am info info-am install install-am install-data \
+	install-data-am install-dvi install-dvi-am install-exec \
+	install-exec-am install-html install-html-am install-info \
+	install-info-am install-man install-pdf install-pdf-am \
+	install-ps install-ps-am install-strip installcheck \
+	installcheck-am installdirs installdirs-am maintainer-clean \
+	maintainer-clean-generic mostlyclean mostlyclean-generic \
+	mostlyclean-libtool pdf pdf-am ps ps-am tags tags-recursive \
+	uninstall uninstall-am
+
+# Tell versions [3.59,3.63) of GNU make to not export all variables.
+# Otherwise a system limit (for SysV at least) may be exceeded.
+.NOEXPORT:
diff --git a/docs/Makefile.am b/docs/Makefile.am
new file mode 100644
index 0000000..7754064
--- /dev/null
+++ b/docs/Makefile.am
@@ -0,0 +1,3 @@
+
+SUBDIRS = \
+  man
diff --git a/docs/man/Makefile.am b/docs/man/Makefile.am
new file mode 100644
index 0000000..a8aef78
--- /dev/null
+++ b/docs/man/Makefile.am
@@ -0,0 +1,13 @@
+
+xrdpman5dir=$(mandir)/man5
+
+xrdpman5_DATA = \
+  sesman.ini.5 \
+  xrdp.ini.5
+
+xrdpman8dir=$(mandir)/man8
+
+xrdpman8_DATA = \
+  xrdp.8 \
+  xrdp-sesman.8 \
+  xrdp-sesrun.8
diff --git a/docs/man/sesman.8 b/docs/man/sesman.8
deleted file mode 100644
index a224c63..0000000
--- a/docs/man/sesman.8
+++ /dev/null
@@ -1,44 +0,0 @@
-.TH "sesman" "8" "0.1.0" "xrdp team" ""
-.SH "NAME"
-.LP 
-\fBsesman\fR \- \fBxrdp\fR(8) session manager
-.SH "SYNTAX"
-.LP 
-sesman [ \-\-nodaemon | \-\-kill | \-\-help ]
-.SH "DESCRIPTION"
-.LP 
-\fBsesman\fR is \fBxrdp\fR(8) session manager. 
-.br 
-It manages user sessions by authenticating the user and starting the appropriate Xserver
-.SH "OPTIONS"
-.LP 
-.TP 
-\fB\-n\fR, \fB\-\-nodaemon\fR 
-Starts \fBsesman\fR in foreground instead of starting it as a daemon.
-.TP 
-\fB\-k\fR, \fB\-\-kill\fR
-Kills running \fBsesman\fR daemon.
-.TP 
-\fB\-h\fR, \fB\-\-help\fR
-Output help information and exit.
-.SH "FILES"
-.LP 
-${SESMAN_BIN_DIR}/sesman
-.br 
-${SESMAN_BIN_DIR}/sesrun
-.br 
-${SESMAN_CFG_DIR}/sesman.ini
-.br 
-${SESMAN_LOG_DIR}/sesman.log
-.br 
-${SESMAN_PID_DIR}/sesman.pid
-.SH "AUTHORS"
-.LP 
-Jay Sorg <jsorg71@users.sourceforge.net>
-.br 
-Simone Fedele <ilsimo@users.sourceforge.net>
-.SH "SEE ALSO"
-.LP 
-sesman.ini(5) sesrun(8) xrdp(8) xrdp.ini(5)
-
-for more info on \fBxrdp\fR see http://xrdp.sf.net
diff --git a/docs/man/sesrun.8 b/docs/man/sesrun.8
deleted file mode 100644
index 5a1b2bd..0000000
--- a/docs/man/sesrun.8
+++ /dev/null
@@ -1,47 +0,0 @@
-.TH "sesrun" "8" "0.1.0" "xrdp team" ""
-.SH "NAME"
-.LP 
-\fBsesrun\fR \- \fBsesman\fR(8) session launcher
-.SH "SYNTAX"
-.LP 
-sesrun <server> <username> <password> <width> <height> <bpp>
-.SH "DESCRIPTION"
-.LP 
-\fBsesrun\fR starts a session using \fBsesman\fR(8). 
-.br 
-This is a tool useful for testing, it simply behaves like xrdp when some user logs in a new session and authenticates, thus starting a new session.
-.SH "OPTIONS"
-.LP 
-.TP 
-<server> 
-Server on which sesman is running
-.TP 
-<username> 
-user name of the session being started
-.TP 
-<password> 
-user password
-.TP 
-<width>
-Screen width
-.TP  
-<height> 
-Screen height
-.TP 
-<bpp>
-Session color depth
-.SH "FILES"
-.LP 
-${SESMAN_BIN_DIR}/sesman
-.br 
-${SESMAN_BIN_DIR}/sesrun
-.SH "AUTHORS"
-.LP 
-Jay Sorg <jsorg71@users.sourceforge.net>
-.br 
-Simone Fedele <ilsimo@users.sourceforge.net>
-.SH "SEE ALSO"
-.LP 
-sesman(8) sesman.ini(5) xrdp(8) xrdp.ini(5)
-
-for more info on \fBxrdp\fR see http://xrdp.sf.net
diff --git a/docs/man/xrdp-sesman.8 b/docs/man/xrdp-sesman.8
new file mode 100644
index 0000000..a224c63
--- /dev/null
+++ b/docs/man/xrdp-sesman.8
@@ -0,0 +1,44 @@
+.TH "sesman" "8" "0.1.0" "xrdp team" ""
+.SH "NAME"
+.LP 
+\fBsesman\fR \- \fBxrdp\fR(8) session manager
+.SH "SYNTAX"
+.LP 
+sesman [ \-\-nodaemon | \-\-kill | \-\-help ]
+.SH "DESCRIPTION"
+.LP 
+\fBsesman\fR is \fBxrdp\fR(8) session manager. 
+.br 
+It manages user sessions by authenticating the user and starting the appropriate Xserver
+.SH "OPTIONS"
+.LP 
+.TP 
+\fB\-n\fR, \fB\-\-nodaemon\fR 
+Starts \fBsesman\fR in foreground instead of starting it as a daemon.
+.TP 
+\fB\-k\fR, \fB\-\-kill\fR
+Kills running \fBsesman\fR daemon.
+.TP 
+\fB\-h\fR, \fB\-\-help\fR
+Output help information and exit.
+.SH "FILES"
+.LP 
+${SESMAN_BIN_DIR}/sesman
+.br 
+${SESMAN_BIN_DIR}/sesrun
+.br 
+${SESMAN_CFG_DIR}/sesman.ini
+.br 
+${SESMAN_LOG_DIR}/sesman.log
+.br 
+${SESMAN_PID_DIR}/sesman.pid
+.SH "AUTHORS"
+.LP 
+Jay Sorg <jsorg71@users.sourceforge.net>
+.br 
+Simone Fedele <ilsimo@users.sourceforge.net>
+.SH "SEE ALSO"
+.LP 
+sesman.ini(5) sesrun(8) xrdp(8) xrdp.ini(5)
+
+for more info on \fBxrdp\fR see http://xrdp.sf.net
diff --git a/docs/man/xrdp-sesrun.8 b/docs/man/xrdp-sesrun.8
new file mode 100644
index 0000000..5a1b2bd
--- /dev/null
+++ b/docs/man/xrdp-sesrun.8
@@ -0,0 +1,47 @@
+.TH "sesrun" "8" "0.1.0" "xrdp team" ""
+.SH "NAME"
+.LP 
+\fBsesrun\fR \- \fBsesman\fR(8) session launcher
+.SH "SYNTAX"
+.LP 
+sesrun <server> <username> <password> <width> <height> <bpp>
+.SH "DESCRIPTION"
+.LP 
+\fBsesrun\fR starts a session using \fBsesman\fR(8). 
+.br 
+This is a tool useful for testing, it simply behaves like xrdp when some user logs in a new session and authenticates, thus starting a new session.
+.SH "OPTIONS"
+.LP 
+.TP 
+<server> 
+Server on which sesman is running
+.TP 
+<username> 
+user name of the session being started
+.TP 
+<password> 
+user password
+.TP 
+<width>
+Screen width
+.TP  
+<height> 
+Screen height
+.TP 
+<bpp>
+Session color depth
+.SH "FILES"
+.LP 
+${SESMAN_BIN_DIR}/sesman
+.br 
+${SESMAN_BIN_DIR}/sesrun
+.SH "AUTHORS"
+.LP 
+Jay Sorg <jsorg71@users.sourceforge.net>
+.br 
+Simone Fedele <ilsimo@users.sourceforge.net>
+.SH "SEE ALSO"
+.LP 
+sesman(8) sesman.ini(5) xrdp(8) xrdp.ini(5)
+
+for more info on \fBxrdp\fR see http://xrdp.sf.net
diff --git a/faq-compile.txt b/faq-compile.txt
new file mode 100644
index 0000000..f9a7bb7
--- /dev/null
+++ b/faq-compile.txt
@@ -0,0 +1,8 @@
+Compile FAQ
+
+Q.  I get error: security/pam_appl.h: File or directory doesn't exist
+    What is wrong?
+
+A.  You need to install pam development package.
+    For Ubuntu 7.04 this package is called libpam0g-dev.
+    For Suse 10.1 this package is call pam-devel.
\ No newline at end of file
diff --git a/faq-general.txt b/faq-general.txt
new file mode 100644
index 0000000..e1905cb
--- /dev/null
+++ b/faq-general.txt
@@ -0,0 +1,16 @@
+General FAQ
+
+Q.  What is RDP?
+
+A.  RDP stands for Remote Desktop Protocol.  Its the protocol used by Windows
+    terminal servers to talk to the terminal server clients.
+
+Q.  What is xrdp?
+
+A.  xrdp, usually spell lower case, is as open source implementation of the RDP
+    protocol.
+
+Q.  I can't get it to compile in Ubuntu.  What can I do?
+
+A.  See faq-compile.txt.
+
diff --git a/fontdump/Makefile b/fontdump/Makefile
new file mode 100755
index 0000000..0a74258
--- /dev/null
+++ b/fontdump/Makefile
@@ -0,0 +1,17 @@
+
+OBJS = fontdump.obj os_calls.obj
+
+#CFLAGS = -O2 -I../common
+CFLAGS = -O2 -I../common -DUNICODE -D_UNICODE
+LDFLAGS = -W -efontdump.exe
+
+all: fontdump1
+
+fontdump1: $(OBJS)
+	$(CC) $(LDFLAGS) $(OBJS)
+
+clean:
+	del $(OBJS) fontdump.exe *.tds
+
+os_calls.obj: ../common/os_calls.c
+	$(CC) $(CFLAGS) -c ../common/os_calls.c
diff --git a/fontdump/fontdump.c b/fontdump/fontdump.c
new file mode 100755
index 0000000..34bdffd
--- /dev/null
+++ b/fontdump/fontdump.c
@@ -0,0 +1,458 @@
+
+#include <windows.h>
+#include <tchar.h>
+#include <stdarg.h>
+#include <stdlib.h>
+#include <stdio.h>
+#include <string.h>
+#include "os_calls.h"
+#include "arch.h"
+
+static HINSTANCE g_instance = 0;
+static HWND g_wnd = 0;
+static HWND g_lb = 0;
+static HWND g_exit_button = 0;
+static HWND g_go_button = 0;
+static HWND g_font_list = 0;
+static char g_font_name[512] = "";
+static int g_font_size = 10;
+static HFONT g_font = 0;
+static int g_running = 0;
+
+#define FONT_DATASIZE(_w, _h) (((_h * ((_w + 7) / 8)) + 3) & ~3)
+
+/*****************************************************************************/
+int
+check_messages(void)
+{
+  MSG msg;
+
+  while (PeekMessage(&msg, 0, 0, 0, PM_NOREMOVE))
+  {
+    GetMessage(&msg, NULL, 0, 0);
+    TranslateMessage(&msg);
+    DispatchMessage(&msg);  
+  }
+  return 0;
+}
+
+/*****************************************************************************/
+static int
+msg(char* msg1, ...)
+{
+  va_list ap;
+  char text1[512];
+
+  va_start(ap, msg1);
+  vsnprintf(text1, 511, msg1, ap);
+  SendMessageA(g_lb, LB_ADDSTRING, 0, (LPARAM)text1);
+  va_end(ap);
+  return 0;
+}
+
+/*****************************************************************************/
+static int
+show_last_error(void)
+{
+  LPVOID lpMsgBuf;
+ 
+  FormatMessageA(FORMAT_MESSAGE_ALLOCATE_BUFFER | FORMAT_MESSAGE_FROM_SYSTEM,
+                 NULL, GetLastError(),
+                 MAKELANGID(LANG_NEUTRAL, SUBLANG_DEFAULT),
+                 (LPSTR)&lpMsgBuf, 0, NULL);
+  msg("GetLastError - %s", lpMsgBuf);
+  LocalFree(lpMsgBuf);
+  return 0;
+}
+
+/*****************************************************************************/
+static int
+font_dump(void)
+{
+  HDC dc;
+  HDC dc1;
+  RECT rect;
+  HBRUSH brush;
+  HGDIOBJ saved;
+  HBITMAP bitmap;
+  BITMAPINFO bi;
+  char* bits;
+  ABC abc;
+  SIZE sz;
+  char filename[256];
+  TCHAR text[256];
+  char zero1;
+  char* bmtext;
+  int bmtextindex;
+  int fd;
+  int x1;
+  int strlen1;
+  int index1;
+  int index2;
+  int len;
+  int pixel;
+  int red;
+  int green;
+  int blue;
+  int width;
+  int height;
+  int roller;
+  int outlen;
+  tui8 b1;
+  short x2;
+
+  if (g_running)
+  {
+    return 0;
+  }
+  g_running = 1;
+  msg("starting");
+  g_font_name[0] = 0;
+  SendMessageA(g_font_list, WM_GETTEXT, 255, (LPARAM)g_font_name);
+  if (g_strlen(g_font_name) == 0)
+  {
+    msg("error font not set");
+    g_running = 0;
+    return 1;
+  }
+  dc = GetDC(g_wnd);
+  height = -MulDiv(g_font_size, GetDeviceCaps(dc, LOGPIXELSY), 72);
+  g_font = CreateFontA(height, 0, 0, 0, FW_DONTCARE, 0, 0, 0, 0, 0, 0,
+                       0, 0, g_font_name);
+  ReleaseDC(g_wnd, dc);
+  if (g_font == 0)
+  {
+    msg("error - Font creation failed");
+  }
+  zero1 = 0;
+  g_snprintf(filename, 255, "%s-%d.fv1", g_font_name, g_font_size);
+  msg("creating file %s", filename);
+  g_file_delete(filename);
+  fd = g_file_open(filename);
+  g_file_write(fd, "FNT1", 4);
+  strlen1 = g_strlen(g_font_name);
+  g_file_write(fd, g_font_name, strlen1);
+  x1 = strlen1;
+  while (x1 < 32)
+  {
+    g_file_write(fd, &zero1, 1);
+    x1++;
+  }
+  x2 = g_font_size; /* font size */
+  g_file_write(fd, (char*)&x2, 2);
+  x2 = 1; /* style */
+  g_file_write(fd, (char*)&x2, 2);
+  /* pad */
+  index1 = 0;
+  while (index1 < 8)
+  {
+    g_file_write(fd, &zero1, 1);
+    index1++;
+  }
+  for (x1 = 32; x1 < 0x4e00; x1++)
+  {
+    check_messages();
+    dc = GetWindowDC(g_wnd);
+    saved = SelectObject(dc, g_font);
+    if (!GetCharABCWidths(dc, x1, x1, &abc))
+    {
+      show_last_error();
+    }
+    text[0] = (TCHAR)x1;
+    text[1] = 0;
+    if (!GetTextExtentPoint32(dc, text, 1, &sz))
+    {
+      show_last_error();
+    }
+    SelectObject(dc, saved);
+    ReleaseDC(g_wnd, dc);
+    if ((sz.cx > 0) && (sz.cy > 0))
+    {
+      dc = GetWindowDC(g_wnd);
+      saved = SelectObject(dc, g_font);
+      SetBkColor(dc, RGB(255, 255, 255));
+      if (!ExtTextOut(dc, 50, 50, ETO_OPAQUE, 0, text, 1, 0))
+      {
+        show_last_error();
+      }
+      SelectObject(dc, saved);
+      ReleaseDC(g_wnd, dc);
+      Sleep(10);
+      /* width */
+      x2 = abc.abcB;
+      g_file_write(fd, (char*)&x2, 2);
+      /* height */
+      x2 = sz.cy;
+      g_file_write(fd, (char*)&x2, 2);
+      /* baseline */
+      x2 = -sz.cy;
+      g_file_write(fd, (char*)&x2, 2);
+      /* offset */
+      x2 = abc.abcA;
+      g_file_write(fd, (char*)&x2, 2);
+      /* incby */
+      x2 = sz.cx;
+      g_file_write(fd, (char*)&x2, 2);
+      /* pad */
+      index1 = 0;
+      while (index1 < 6)
+      {
+        g_file_write(fd, &zero1, 1);
+        index1++;
+      }
+      dc = GetWindowDC(g_wnd);
+      rect.left = 50 + abc.abcA;
+      rect.top = 50;
+      rect.right = rect.left + abc.abcB;
+      rect.bottom = rect.top + sz.cy;
+      memset(&bi, 0, sizeof(bi));
+      width = (abc.abcB + 7) & (~7);
+      height = sz.cy;
+      bi.bmiHeader.biSize = sizeof(bi.bmiHeader);
+      bi.bmiHeader.biWidth = width;
+      bi.bmiHeader.biHeight = height;
+      bi.bmiHeader.biPlanes = 1;
+      bi.bmiHeader.biBitCount = 32;
+      bitmap = CreateDIBSection(dc, &bi, DIB_RGB_COLORS, (void*)&bits, 0, 0);
+      if (bitmap == 0)
+      {
+        msg("error - CreateDIBSection failed");
+      }
+      else
+      {
+        memset(bits, 0, width * height * 4);
+        dc1 = CreateCompatibleDC(dc);
+        SelectObject(dc1, bitmap);
+        if (!BitBlt(dc1, 0, 0, width, height, dc, rect.left, rect.top, SRCCOPY))
+        {
+          show_last_error();
+        }
+        bmtext = (char*)g_malloc(width * height + 16, 1);
+        bmtextindex = 0;
+        for (index1 = (height - 1); index1 >= 0; index1--)
+        {
+          for (index2 = 0; index2 < width; index2++)
+          {
+            pixel = ((int*)bits)[index1 * width + index2];
+            red = (pixel >> 16) & 0xff;
+            green = (pixel >> 8) & 0xff;
+            blue = (pixel >> 0) & 0xff;
+            if (red == 0 && green == 0 && blue == 0)
+            {
+              bmtext[bmtextindex] = '1';
+              bmtextindex++;
+            }
+            else
+            {
+              bmtext[bmtextindex] = '0';
+              bmtextindex++;
+            }
+          }
+        }
+        outlen = 0;
+        b1 = 0;
+        roller = 0;
+        len = g_strlen(bmtext);
+        for (index2 = 0; index2 < len; index2++)
+        {
+          if (bmtext[index2] == '1')
+          {
+            switch (roller)
+            {
+              case 0: b1 = b1 | 0x80; break;
+              case 1: b1 = b1 | 0x40; break;
+              case 2: b1 = b1 | 0x20; break;
+              case 3: b1 = b1 | 0x10; break;
+              case 4: b1 = b1 | 0x08; break;
+              case 5: b1 = b1 | 0x04; break;
+              case 6: b1 = b1 | 0x02; break;
+              case 7: b1 = b1 | 0x01; break;
+            }
+          }
+          roller++;
+          if (roller == 8)
+          {
+            roller = 0;
+            g_file_write(fd, &b1, 1);
+            outlen++;
+            b1 = 0;
+          }
+        }
+        while ((outlen % 4) != 0)
+        {
+          g_file_write(fd, &zero1, 1);
+          outlen++;
+        }
+        free(bmtext);
+        DeleteDC(dc1);
+        DeleteObject(bitmap);
+      }
+      if (sz.cx != (long)(abc.abcA + abc.abcB + abc.abcC))
+      {
+        msg("error - width not right 1");
+      }
+      brush = CreateSolidBrush(RGB(255, 255, 255));
+      FillRect(dc, &rect, brush);
+      DeleteObject(brush);
+      ReleaseDC(g_wnd, dc);
+    }
+    else
+    {
+      /* write out a blank glyph here */
+      /* width */
+      x2 = 1;
+      g_file_write(fd, (char*)&x2, 2);
+      /* height */
+      x2 = 1;
+      g_file_write(fd, (char*)&x2, 2);
+      /* baseline */
+      x2 = 0;
+      g_file_write(fd, (char*)&x2, 2);
+      /* offset */
+      x2 = 0;
+      g_file_write(fd, (char*)&x2, 2);
+      /* incby */
+      x2 = 1;
+      g_file_write(fd, (char*)&x2, 2);
+      /* pad */
+      index1 = 0;
+      while (index1 < 6)
+      {
+        g_file_write(fd, &zero1, 1);
+        index1++;
+      }
+      /* blank bitmap */
+      index1 = 0;
+      while (index1 < 4)
+      {
+        g_file_write(fd, &zero1, 1);
+        index1++;
+      }
+    }
+  }
+  g_file_close(fd);
+  msg("done");
+  g_running = 0;
+  return 0;
+}
+
+/*****************************************************************************/
+static LRESULT CALLBACK
+wnd_proc(HWND hWnd, UINT message, WPARAM wParam, LPARAM lParam)
+{
+  PAINTSTRUCT ps;
+  HBRUSH brush;
+  RECT rect;
+
+  switch (message)
+  {
+    case WM_PAINT:
+      BeginPaint(hWnd, &ps);
+      brush = CreateSolidBrush(RGB(255, 255, 255));
+      rect = ps.rcPaint;
+      FillRect(ps.hdc, &rect, brush);
+      DeleteObject(brush);
+      EndPaint(hWnd, &ps);
+      break;
+    case WM_CLOSE:
+      DestroyWindow(g_wnd);
+      g_wnd = 0;
+      break;
+    case WM_DESTROY:
+      PostQuitMessage(0);
+      break;
+    case WM_TIMER:
+      KillTimer(g_wnd, 1);
+      font_dump();
+      break;
+    case WM_COMMAND:
+      if ((HWND)lParam == g_exit_button)
+      {
+        PostMessage(g_wnd, WM_CLOSE, 0, 0);
+      }
+      else if ((HWND)lParam == g_go_button)
+      {
+        while (SendMessage(g_lb, LB_GETCOUNT, 0, 0) > 0)
+        {
+          SendMessage(g_lb, LB_DELETESTRING, 0, 0);
+        }
+        SetTimer(g_wnd, 1, 1000, 0);
+      }
+      break;
+  }
+  return DefWindowProc(hWnd, message, wParam, lParam);
+}
+
+/*****************************************************************************/
+static int
+create_window(void)
+{
+  WNDCLASS wc;
+  DWORD style;
+  HDC dc;
+  int height;
+  int left;
+  int top;
+
+  ZeroMemory(&wc, sizeof(wc));
+  wc.lpfnWndProc = wnd_proc; /* points to window procedure */
+  /* name of window class */
+  wc.lpszClassName = _T("fontdump");
+  wc.hCursor = LoadCursor(0, IDC_ARROW);
+  /* Register the window class. */
+  if (!RegisterClass(&wc))
+  {
+    return 0; /* Failed to register window class */
+  }
+  style = WS_OVERLAPPED | WS_CAPTION | WS_POPUP | WS_MINIMIZEBOX |
+          WS_SYSMENU | WS_SIZEBOX | WS_MAXIMIZEBOX;
+  left = GetSystemMetrics(SM_CXSCREEN) / 2 - 640 / 2;
+  top = GetSystemMetrics(SM_CYSCREEN) / 2 - 480 / 2;
+  g_wnd = CreateWindow(wc.lpszClassName, _T("fontdump"),
+                       style, left, top, 640, 480,
+                       (HWND) NULL, (HMENU) NULL, g_instance,
+                       (LPVOID) NULL);
+  style = WS_CHILD | WS_VISIBLE | WS_BORDER;
+  g_lb = CreateWindow(_T("LISTBOX"), _T("LISTBOX1"), style,
+                      200, 10, 400, 400, g_wnd, 0, g_instance, 0);
+  style = WS_CHILD | WS_VISIBLE;
+  g_exit_button = CreateWindow(_T("BUTTON"), _T("Exit"), style,
+                               540, 410, 75, 25, g_wnd, 0, g_instance, 0);
+  g_go_button = CreateWindow(_T("BUTTON"), _T("Go"), style,
+                             440, 410, 75, 25, g_wnd, 0, g_instance, 0);
+  style = WS_CHILD | WS_VISIBLE | CBS_DROPDOWN;
+  g_font_list = CreateWindow(_T("COMBOBOX"), _T("COMBOBOX1"), style,
+                             50, 250, 125, 125, g_wnd, 0, g_instance, 0);
+  ShowWindow(g_wnd, SW_SHOWNORMAL);
+  PostMessage(g_wnd, WM_SETFONT, (WPARAM)g_font, 0);
+  SendMessageA(g_font_list, CB_ADDSTRING, 0, (LPARAM)"Tahoma");
+  SendMessageA(g_font_list, CB_ADDSTRING, 0, (LPARAM)"DejaVu Serif");
+  SendMessageA(g_font_list, CB_ADDSTRING, 0, (LPARAM)"DejaVu Sans");
+  SendMessageA(g_font_list, CB_ADDSTRING, 0, (LPARAM)"Arial");
+  SendMessageA(g_font_list, CB_ADDSTRING, 0, (LPARAM)"Comic Sans MS");
+  return 0;
+}
+
+/*****************************************************************************/
+static int
+main_loop(void)
+{
+  MSG msg;
+
+  while (GetMessage(&msg, NULL, 0, 0))
+  {
+    TranslateMessage(&msg);
+    DispatchMessage(&msg);
+  }
+  return (int)(msg.wParam);
+}
+
+/*****************************************************************************/
+int WINAPI
+WinMain(HINSTANCE hInstance, HINSTANCE hPrevInstance,
+        LPSTR lpCmdLine, int nCmdShow)
+{
+  g_instance = hInstance;
+  create_window();
+  return main_loop();
+}
diff --git a/instfiles/Makefile.am b/instfiles/Makefile.am
new file mode 100644
index 0000000..8f8616c
--- /dev/null
+++ b/instfiles/Makefile.am
@@ -0,0 +1,15 @@
+
+SUBDIRS = \
+  pam.d
+
+startscriptdir=$(sysconfdir)/xrdp
+
+startscript_DATA = \
+  xrdp.sh
+
+# must be tab below
+install-data-hook:
+	chmod 755 $(DESTDIR)$(sysconfdir)/xrdp/xrdp.sh
+	if [ -w /etc/init.d ]; then rm -f /etc/init.d/xrdp.sh; fi
+	if [ -w /etc/init.d ]; then $(LN_S) $(DESTDIR)$(sysconfdir)/xrdp/xrdp.sh /etc/init.d/xrdp.sh; fi
+	$(DESTDIR)$(bindir)/xrdp-keygen xrdp $(DESTDIR)$(sysconfdir)/xrdp/rsakeys.ini
diff --git a/instfiles/pam.d/Makefile.am b/instfiles/pam.d/Makefile.am
new file mode 100644
index 0000000..fb1c455
--- /dev/null
+++ b/instfiles/pam.d/Makefile.am
@@ -0,0 +1,19 @@
+
+if SESMAN_NOPAM
+PAMFILE =
+else
+if SESMAN_PAMUSERPASS
+PAMFILE =
+else
+if SESMAN_KERBEROS
+PAMFILE =
+else
+PAMFILE = xrdp-sesman
+endif
+endif
+endif
+
+pamddir=$(sysconfdir)/pam.d
+
+pamd_DATA = \
+  $(PAMFILE)
diff --git a/instfiles/pam.d/sesman b/instfiles/pam.d/sesman
deleted file mode 100644
index 1a7a249..0000000
--- a/instfiles/pam.d/sesman
+++ /dev/null
@@ -1,3 +0,0 @@
-#%PAM-1.0
-auth       required	pam_unix.so shadow nullok
-account    required	pam_unix.so
diff --git a/instfiles/pam.d/xrdp-sesman b/instfiles/pam.d/xrdp-sesman
new file mode 100644
index 0000000..1a7a249
--- /dev/null
+++ b/instfiles/pam.d/xrdp-sesman
@@ -0,0 +1,3 @@
+#%PAM-1.0
+auth       required	pam_unix.so shadow nullok
+account    required	pam_unix.so
diff --git a/instfiles/xrdp.sh b/instfiles/xrdp.sh
new file mode 100755
index 0000000..3671004
--- /dev/null
+++ b/instfiles/xrdp.sh
@@ -0,0 +1,141 @@
+#!/bin/sh
+# xrdp control script
+# Written : 1-13-2006 - Mark Balliet - posicat@pobox.com
+# maintaned by Jay Sorg
+# chkconfig: 2345 11 89
+# description: starts xrdp
+
+SBINDIR=/usr/local/sbin
+LOG=/dev/null
+CFGDIR=/etc/xrdp
+
+if ! test -x $SBINDIR/xrdp
+then
+  echo "xrdp is not executable"
+  exit 0
+fi
+if ! test -x $SBINDIR/xrdp-sesman
+then
+  echo "xrdp-sesman is not executable"
+  exit 0
+fi
+if ! test -x $CFGDIR/startwm.sh
+then
+  echo "startwm.sh is not executable"
+  exit 0
+fi
+
+xrdp_start()
+{
+  echo -n "Starting: xrdp and sesman . . "
+  $SBINDIR/xrdp >> $LOG
+  $SBINDIR/xrdp-sesman >> $LOG
+  echo "."
+  sleep 1
+  return 0;
+}
+
+xrdp_stop()
+{
+  echo -n "Stopping: xrdp and sesman . . "
+  $SBINDIR/xrdp-sesman --kill >> $LOG
+  $SBINDIR/xrdp --kill >> $LOG
+  echo "."
+  return 0;
+}
+
+is_xrdp_running()
+{
+  ps u --noheading -C xrdp | grep -q -i xrdp
+  if test $? -eq 0
+  then
+    return 1;
+  else
+    return 0;
+  fi
+}
+
+is_sesman_running()
+{
+  ps u --noheading -C xrdp-sesman | grep -q -i xrdp-sesman
+  if test $? -eq 0
+  then
+    return 1;
+  else
+    return 0;
+  fi
+}
+
+check_up()
+{
+  # Cleanup : If sesman isn't running, but the pid exists, erase it.
+  is_sesman_running
+  if test $? -eq 0
+  then
+    if test -e /var/run/xrdp-sesman.pid
+    then
+      rm /var/run/xrdp-sesman.pid
+    fi
+  fi
+  # Cleanup : If xrdp isn't running, but the pid exists, erase it.
+  is_xrdp_running
+  if test $? -eq 0
+  then
+    if test -e /var/run/xrdp.pid
+    then
+      rm /var/run/xrdp.pid
+    fi
+  fi
+  return 0;
+}
+
+case "$1" in
+  start)
+    check_up
+    is_xrdp_running
+    if ! test $? -eq 0
+    then
+      echo "xrdp is already loaded"
+      exit 1
+    fi
+    is_sesman_running
+    if ! test $? -eq 0
+    then
+      echo "sesman is already loaded"
+      exit 1
+    fi
+    xrdp_start
+    ;;
+  stop)
+    check_up
+    is_xrdp_running
+    if test $? -eq 0
+    then
+      echo "xrdp is not loaded."
+    fi
+    is_sesman_running
+    if test $? -eq 0
+    then
+      echo "sesman is not loaded."
+    fi
+    xrdp_stop
+    ;;
+  force-reload|restart)
+    check_up
+    echo "Restarting xrdp ..."
+    xrdp_stop
+    is_xrdp_running
+    while ! test $? -eq 0
+    do
+      check_up
+      sleep 1
+      is_xrdp_running
+    done
+    xrdp_start
+    ;;
+  *)
+    echo "Usage: xrdp.sh {start|stop|restart|force-reload}"
+    exit 1
+esac
+
+exit 0
diff --git a/instfiles/xrdp_control.sh b/instfiles/xrdp_control.sh
deleted file mode 100755
index d517315..0000000
--- a/instfiles/xrdp_control.sh
+++ /dev/null
@@ -1,145 +0,0 @@
-#!/bin/sh
-# xrdp control script
-# Written : 1-13-2006 - Mark Balliet - posicat@pobox.com
-# maintaned by Jay Sorg
-# chkconfig: 2345 11 89
-# description: starts xrdp
-
-XRDP=xrdp
-SESMAN=sesman
-STARTWM=startwm.sh
-XRDP_DIR=/usr/local/xrdp/
-LOG=/dev/null
-
-cd $XRDP_DIR
-
-if ! test -x $XRDP
-then
-  echo "$XRDP is not executable"
-  exit 0
-fi
-if ! test -x $SESMAN
-then
-  echo "$SESMAN is not executable"
-  exit 0
-fi
-if ! test -x $STARTWM
-then
-  echo "$STARTWM is not executable"
-  exit 0
-fi
-
-xrdp_start()
-{
-  echo -n "Starting: xrdp and sesman . . "
-  ./$XRDP >> $LOG
-  ./$SESMAN >> $LOG
-  echo "."
-  sleep 1
-  return 0;
-}
-
-xrdp_stop()
-{
-  echo -n "Stopping: xrdp and sesman . . "
-  ./$SESMAN --kill >> $LOG
-  ./$XRDP --kill >> $LOG
-  echo "."
-  return 0;
-}
-
-is_xrdp_running()
-{
-  ps u --noheading -C $XRDP | grep -q -i $XRDP
-  if test $? -eq 0
-  then
-    return 1;
-  else
-    return 0;
-  fi
-}
-
-is_sesman_running()
-{
-  ps u --noheading -C $SESMAN | grep -q -i $SESMAN
-  if test $? -eq 0
-  then
-    return 1;
-  else
-    return 0;
-  fi
-}
-
-check_up()
-{
-  # Cleanup : If sesman isn't running, but the pid exists, erase it.
-  is_sesman_running
-  if test $? -eq 0
-  then
-    if test -e /var/run/sesman.pid
-    then
-      rm /var/run/sesman.pid
-    fi
-  fi
-  # Cleanup : If xrdp isn't running, but the pid exists, erase it.
-  is_xrdp_running
-  if test $? -eq 0
-  then
-    if test -e /var/run/xrdp.pid
-    then
-      rm /var/run/xrdp.pid
-    fi
-  fi
-  return 0;
-}
-
-case "$1" in
-  start)
-    check_up
-    is_xrdp_running
-    if ! test $? -eq 0
-    then
-      echo "xrdp is already loaded"
-      exit 1
-    fi
-    is_sesman_running
-    if ! test $? -eq 0
-    then
-      echo "sesman is already loaded"
-      exit 1
-    fi
-    xrdp_start
-    ;;
-  stop)
-    check_up
-    is_xrdp_running
-    if test $? -eq 0
-    then
-      echo "xrdp is not loaded."
-    fi
-    is_sesman_running
-    if test $? -eq 0
-    then
-      echo "sesman is not loaded."
-    fi
-    xrdp_stop
-    ;;
-  force-reload|restart)
-    check_up
-    echo "Restarting xrdp ..."
-    xrdp_stop
-    is_xrdp_running
-    while ! test $? -eq 0
-    do
-      check_up
-      sleep 1
-      is_xrdp_running
-    done
-    xrdp_start
-    ;;
-  *)
-    echo "Usage: xrdp_control.sh {start|stop|restart|force-reload}"
-    exit 1
-esac
-
-exit 0
diff --git a/instfiles/xrdp_control1.sh b/instfiles/xrdp_control1.sh
deleted file mode 100644
index 92805f9..0000000
--- a/instfiles/xrdp_control1.sh
+++ /dev/null
@@ -1,146 +0,0 @@
-#!/bin/sh
-# xrdp control script
-# same as xrdp_control.sh except the XRDP_DIR is /usr/lib/xrdp
-# Written : 1-13-2006 - Mark Balliet - posicat@pobox.com
-# maintaned by Jay Sorg
-# chkconfig: 2345 11 89
-# description: starts xrdp
-
-XRDP=xrdp
-SESMAN=sesman
-STARTWM=startwm.sh
-XRDP_DIR=/usr/lib/xrdp/
-LOG=/dev/null
-
-cd $XRDP_DIR
-
-if ! test -x $XRDP
-then
-  echo "$XRDP is not executable"
-  exit 0
-fi
-if ! test -x $SESMAN
-then
-  echo "$SESMAN is not executable"
-  exit 0
-fi
-if ! test -x $STARTWM
-then
-  echo "$STARTWM is not executable"
-  exit 0
-fi
-
-xrdp_start()
-{
-  echo -n "Starting: xrdp and sesman . . "
-  ./$XRDP >> $LOG
-  ./$SESMAN >> $LOG
-  echo "."
-  sleep 1
-  return 0;
-}
-
-xrdp_stop()
-{
-  echo -n "Stopping: xrdp and sesman . . "
-  ./$SESMAN --kill >> $LOG
-  ./$XRDP --kill >> $LOG
-  echo "."
-  return 0;
-}
-
-is_xrdp_running()
-{
-  ps u --noheading -C $XRDP | grep -q -i $XRDP
-  if test $? -eq 0
-  then
-    return 1;
-  else
-    return 0;
-  fi
-}
-
-is_sesman_running()
-{
-  ps u --noheading -C $SESMAN | grep -q -i $SESMAN
-  if test $? -eq 0
-  then
-    return 1;
-  else
-    return 0;
-  fi
-}
-
-check_up()
-{
-  # Cleanup : If sesman isn't running, but the pid exists, erase it.
-  is_sesman_running
-  if test $? -eq 0
-  then
-    if test -e /var/run/sesman.pid
-    then
-      rm /var/run/sesman.pid
-    fi
-  fi
-  # Cleanup : If xrdp isn't running, but the pid exists, erase it.
-  is_xrdp_running
-  if test $? -eq 0
-  then
-    if test -e /var/run/xrdp.pid
-    then
-      rm /var/run/xrdp.pid
-    fi
-  fi
-  return 0;
-}
-
-case "$1" in
-  start)
-    check_up
-    is_xrdp_running
-    if ! test $? -eq 0
-    then
-      echo "xrdp is already loaded"
-      exit 1
-    fi
-    is_sesman_running
-    if ! test $? -eq 0
-    then
-      echo "sesman is already loaded"
-      exit 1
-    fi
-    xrdp_start
-    ;;
-  stop)
-    check_up
-    is_xrdp_running
-    if test $? -eq 0
-    then
-      echo "xrdp is not loaded."
-    fi
-    is_sesman_running
-    if test $? -eq 0
-    then
-      echo "sesman is not loaded."
-    fi
-    xrdp_stop
-    ;;
-  force-reload|restart)
-    check_up
-    echo "Restarting xrdp ..."
-    xrdp_stop
-    is_xrdp_running
-    while ! test $? -eq 0
-    do
-      check_up
-      sleep 1
-      is_xrdp_running
-    done
-    xrdp_start
-    ;;
-  *)
-    echo "Usage: xrdp_control.sh {start|stop|restart|force-reload}"
-    exit 1
-esac
-
-exit 0
diff --git a/keygen/Makefile b/keygen/Makefile
new file mode 100644
index 0000000..618e60b
--- /dev/null
+++ b/keygen/Makefile
@@ -0,0 +1,463 @@
+# Makefile.in generated by automake 1.10.1 from Makefile.am.
+# keygen/Makefile.  Generated from Makefile.in by configure.
+
+# Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
+# 2003, 2004, 2005, 2006, 2007, 2008  Free Software Foundation, Inc.
+# This Makefile.in is free software; the Free Software Foundation
+# gives unlimited permission to copy and/or distribute it,
+# with or without modifications, as long as this notice is preserved.
+
+# This program is distributed in the hope that it will be useful,
+# but WITHOUT ANY WARRANTY, to the extent permitted by law; without
+# even the implied warranty of MERCHANTABILITY or FITNESS FOR A
+# PARTICULAR PURPOSE.
+
+
+
+
+pkgdatadir = $(datadir)/xrdp
+pkglibdir = $(libdir)/xrdp
+pkgincludedir = $(includedir)/xrdp
+am__cd = CDPATH="$${ZSH_VERSION+.}$(PATH_SEPARATOR)" && cd
+install_sh_DATA = $(install_sh) -c -m 644
+install_sh_PROGRAM = $(install_sh) -c
+install_sh_SCRIPT = $(install_sh) -c
+INSTALL_HEADER = $(INSTALL_DATA)
+transform = $(program_transform_name)
+NORMAL_INSTALL = :
+PRE_INSTALL = :
+POST_INSTALL = :
+NORMAL_UNINSTALL = :
+PRE_UNINSTALL = :
+POST_UNINSTALL = :
+build_triplet = i686-suse-linux-gnu
+host_triplet = i686-suse-linux-gnu
+bin_PROGRAMS = xrdp-keygen$(EXEEXT)
+subdir = keygen
+DIST_COMMON = $(srcdir)/Makefile.am $(srcdir)/Makefile.in
+ACLOCAL_M4 = $(top_srcdir)/aclocal.m4
+am__aclocal_m4_deps = $(top_srcdir)/configure.ac
+am__configure_deps = $(am__aclocal_m4_deps) $(CONFIGURE_DEPENDENCIES) \
+	$(ACLOCAL_M4)
+mkinstalldirs = $(install_sh) -d
+CONFIG_HEADER = $(top_builddir)/config_ac.h
+CONFIG_CLEAN_FILES =
+am__installdirs = "$(DESTDIR)$(bindir)"
+binPROGRAMS_INSTALL = $(INSTALL_PROGRAM)
+PROGRAMS = $(bin_PROGRAMS)
+am_xrdp_keygen_OBJECTS = keygen.$(OBJEXT)
+xrdp_keygen_OBJECTS = $(am_xrdp_keygen_OBJECTS)
+xrdp_keygen_DEPENDENCIES = $(top_srcdir)/common/libcommon.la
+DEFAULT_INCLUDES = -I. -I$(top_builddir)
+depcomp = $(SHELL) $(top_srcdir)/depcomp
+am__depfiles_maybe = depfiles
+COMPILE = $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) \
+	$(CPPFLAGS) $(AM_CFLAGS) $(CFLAGS)
+LTCOMPILE = $(LIBTOOL) --tag=CC $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) \
+	--mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) \
+	$(AM_CPPFLAGS) $(CPPFLAGS) $(AM_CFLAGS) $(CFLAGS)
+CCLD = $(CC)
+LINK = $(LIBTOOL) --tag=CC $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) \
+	--mode=link $(CCLD) $(AM_CFLAGS) $(CFLAGS) $(AM_LDFLAGS) \
+	$(LDFLAGS) -o $@
+SOURCES = $(xrdp_keygen_SOURCES)
+DIST_SOURCES = $(xrdp_keygen_SOURCES)
+ETAGS = etags
+CTAGS = ctags
+DISTFILES = $(DIST_COMMON) $(DIST_SOURCES) $(TEXINFOS) $(EXTRA_DIST)
+ACLOCAL = ${SHELL} /home/david/git/xrdp/missing --run aclocal-1.10
+AMTAR = ${SHELL} /home/david/git/xrdp/missing --run tar
+AR = ar
+AUTOCONF = ${SHELL} /home/david/git/xrdp/missing --run autoconf
+AUTOHEADER = ${SHELL} /home/david/git/xrdp/missing --run autoheader
+AUTOMAKE = ${SHELL} /home/david/git/xrdp/missing --run automake-1.10
+AWK = gawk
+CC = gcc
+CCDEPMODE = depmode=gcc3
+CFLAGS = -g -O2
+CPP = gcc -E
+CPPFLAGS = 
+CXX = g++
+CXXCPP = g++ -E
+CXXDEPMODE = depmode=gcc3
+CXXFLAGS = -g -O2
+CYGPATH_W = echo
+DEFS = -DHAVE_CONFIG_H
+DEPDIR = .deps
+DSYMUTIL = 
+ECHO = echo
+ECHO_C = 
+ECHO_N = -n
+ECHO_T = 
+EGREP = /usr/bin/grep -E
+EXEEXT = 
+F77 = 
+FFLAGS = 
+GREP = /usr/bin/grep
+INSTALL = /usr/bin/install -c
+INSTALL_DATA = ${INSTALL} -m 644
+INSTALL_PROGRAM = ${INSTALL}
+INSTALL_SCRIPT = ${INSTALL}
+INSTALL_STRIP_PROGRAM = $(install_sh) -c -s
+LDFLAGS = 
+LIBOBJS = 
+LIBS = 
+LIBTOOL = $(SHELL) $(top_builddir)/libtool
+LN_S = ln -s
+LTLIBOBJS = 
+MAKEINFO = ${SHELL} /home/david/git/xrdp/missing --run makeinfo
+MKDIR_P = /bin/mkdir -p
+NMEDIT = 
+OBJEXT = o
+PACKAGE = xrdp
+PACKAGE_BUGREPORT = xrdp-devel@lists.sourceforge.net
+PACKAGE_NAME = xrdp
+PACKAGE_STRING = xrdp 0.5.0
+PACKAGE_TARNAME = xrdp
+PACKAGE_VERSION = 0.5.0
+PATH_SEPARATOR = :
+RANLIB = ranlib
+SED = /usr/bin/sed
+SET_MAKE = 
+SHELL = /bin/sh
+STRIP = strip
+VERSION = 0.5.0
+abs_builddir = /home/david/git/xrdp/keygen
+abs_srcdir = /home/david/git/xrdp/keygen
+abs_top_builddir = /home/david/git/xrdp
+abs_top_srcdir = /home/david/git/xrdp
+ac_ct_CC = gcc
+ac_ct_CXX = g++
+ac_ct_F77 = 
+am__include = include
+am__leading_dot = .
+am__quote = 
+am__tar = ${AMTAR} chof - "$$tardir"
+am__untar = ${AMTAR} xf -
+bindir = ${exec_prefix}/bin
+build = i686-suse-linux-gnu
+build_alias = 
+build_cpu = i686
+build_os = linux-gnu
+build_vendor = suse
+builddir = .
+datadir = ${datarootdir}
+datarootdir = ${prefix}/share
+docdir = ${datarootdir}/doc/${PACKAGE_TARNAME}
+dvidir = ${docdir}
+exec_prefix = ${prefix}
+host = i686-suse-linux-gnu
+host_alias = 
+host_cpu = i686
+host_os = linux-gnu
+host_vendor = suse
+htmldir = ${docdir}
+includedir = ${prefix}/include
+infodir = ${datarootdir}/info
+install_sh = $(SHELL) /home/david/git/xrdp/install-sh
+libdir = ${exec_prefix}/lib/xrdp/
+libexecdir = ${exec_prefix}/libexec
+localedir = ${datarootdir}/locale
+localstatedir = ${prefix}/var
+mandir = ${datarootdir}/man
+mkdir_p = /bin/mkdir -p
+oldincludedir = /usr/include
+pdfdir = ${docdir}
+prefix = /usr
+program_transform_name = s,x,x,
+psdir = ${docdir}
+sbindir = ${exec_prefix}/sbin
+sharedstatedir = ${prefix}/com
+srcdir = .
+sysconfdir = ${prefix}/etc
+target_alias = 
+top_builddir = ..
+top_srcdir = ..
+INCLUDES = \
+  -I$(top_srcdir)/common
+
+xrdp_keygen_SOURCES = keygen.c
+xrdp_keygen_LDADD = \
+  $(top_srcdir)/common/libcommon.la
+
+all: all-am
+
+.SUFFIXES:
+.SUFFIXES: .c .lo .o .obj
+$(srcdir)/Makefile.in:  $(srcdir)/Makefile.am  $(am__configure_deps)
+	@for dep in $?; do \
+	  case '$(am__configure_deps)' in \
+	    *$$dep*) \
+	      cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh \
+		&& exit 0; \
+	      exit 1;; \
+	  esac; \
+	done; \
+	echo ' cd $(top_srcdir) && $(AUTOMAKE) --foreign  keygen/Makefile'; \
+	cd $(top_srcdir) && \
+	  $(AUTOMAKE) --foreign  keygen/Makefile
+.PRECIOUS: Makefile
+Makefile: $(srcdir)/Makefile.in $(top_builddir)/config.status
+	@case '$?' in \
+	  *config.status*) \
+	    cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh;; \
+	  *) \
+	    echo ' cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe)'; \
+	    cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe);; \
+	esac;
+
+$(top_builddir)/config.status: $(top_srcdir)/configure $(CONFIG_STATUS_DEPENDENCIES)
+	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
+
+$(top_srcdir)/configure:  $(am__configure_deps)
+	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
+$(ACLOCAL_M4):  $(am__aclocal_m4_deps)
+	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
+install-binPROGRAMS: $(bin_PROGRAMS)
+	@$(NORMAL_INSTALL)
+	test -z "$(bindir)" || $(MKDIR_P) "$(DESTDIR)$(bindir)"
+	@list='$(bin_PROGRAMS)'; for p in $$list; do \
+	  p1=`echo $$p|sed 's/$(EXEEXT)$$//'`; \
+	  if test -f $$p \
+	     || test -f $$p1 \
+	  ; then \
+	    f=`echo "$$p1" | sed 's,^.*/,,;$(transform);s/$$/$(EXEEXT)/'`; \
+	   echo " $(INSTALL_PROGRAM_ENV) $(LIBTOOL) $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=install $(binPROGRAMS_INSTALL) '$$p' '$(DESTDIR)$(bindir)/$$f'"; \
+	   $(INSTALL_PROGRAM_ENV) $(LIBTOOL) $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=install $(binPROGRAMS_INSTALL) "$$p" "$(DESTDIR)$(bindir)/$$f" || exit 1; \
+	  else :; fi; \
+	done
+
+uninstall-binPROGRAMS:
+	@$(NORMAL_UNINSTALL)
+	@list='$(bin_PROGRAMS)'; for p in $$list; do \
+	  f=`echo "$$p" | sed 's,^.*/,,;s/$(EXEEXT)$$//;$(transform);s/$$/$(EXEEXT)/'`; \
+	  echo " rm -f '$(DESTDIR)$(bindir)/$$f'"; \
+	  rm -f "$(DESTDIR)$(bindir)/$$f"; \
+	done
+
+clean-binPROGRAMS:
+	@list='$(bin_PROGRAMS)'; for p in $$list; do \
+	  f=`echo $$p|sed 's/$(EXEEXT)$$//'`; \
+	  echo " rm -f $$p $$f"; \
+	  rm -f $$p $$f ; \
+	done
+xrdp-keygen$(EXEEXT): $(xrdp_keygen_OBJECTS) $(xrdp_keygen_DEPENDENCIES) 
+	@rm -f xrdp-keygen$(EXEEXT)
+	$(LINK) $(xrdp_keygen_OBJECTS) $(xrdp_keygen_LDADD) $(LIBS)
+
+mostlyclean-compile:
+	-rm -f *.$(OBJEXT)
+
+distclean-compile:
+	-rm -f *.tab.c
+
+include ./$(DEPDIR)/keygen.Po
+
+.c.o:
+	$(COMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ $<
+	mv -f $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Po
+#	source='$<' object='$@' libtool=no \
+#	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) \
+#	$(COMPILE) -c $<
+
+.c.obj:
+	$(COMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ `$(CYGPATH_W) '$<'`
+	mv -f $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Po
+#	source='$<' object='$@' libtool=no \
+#	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) \
+#	$(COMPILE) -c `$(CYGPATH_W) '$<'`
+
+.c.lo:
+	$(LTCOMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ $<
+	mv -f $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Plo
+#	source='$<' object='$@' libtool=yes \
+#	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) \
+#	$(LTCOMPILE) -c -o $@ $<
+
+mostlyclean-libtool:
+	-rm -f *.lo
+
+clean-libtool:
+	-rm -rf .libs _libs
+
+ID: $(HEADERS) $(SOURCES) $(LISP) $(TAGS_FILES)
+	list='$(SOURCES) $(HEADERS) $(LISP) $(TAGS_FILES)'; \
+	unique=`for i in $$list; do \
+	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
+	  done | \
+	  $(AWK) '{ files[$$0] = 1; nonemtpy = 1; } \
+	      END { if (nonempty) { for (i in files) print i; }; }'`; \
+	mkid -fID $$unique
+tags: TAGS
+
+TAGS:  $(HEADERS) $(SOURCES)  $(TAGS_DEPENDENCIES) \
+		$(TAGS_FILES) $(LISP)
+	tags=; \
+	here=`pwd`; \
+	list='$(SOURCES) $(HEADERS)  $(LISP) $(TAGS_FILES)'; \
+	unique=`for i in $$list; do \
+	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
+	  done | \
+	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
+	      END { if (nonempty) { for (i in files) print i; }; }'`; \
+	if test -z "$(ETAGS_ARGS)$$tags$$unique"; then :; else \
+	  test -n "$$unique" || unique=$$empty_fix; \
+	  $(ETAGS) $(ETAGSFLAGS) $(AM_ETAGSFLAGS) $(ETAGS_ARGS) \
+	    $$tags $$unique; \
+	fi
+ctags: CTAGS
+CTAGS:  $(HEADERS) $(SOURCES)  $(TAGS_DEPENDENCIES) \
+		$(TAGS_FILES) $(LISP)
+	tags=; \
+	list='$(SOURCES) $(HEADERS)  $(LISP) $(TAGS_FILES)'; \
+	unique=`for i in $$list; do \
+	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
+	  done | \
+	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
+	      END { if (nonempty) { for (i in files) print i; }; }'`; \
+	test -z "$(CTAGS_ARGS)$$tags$$unique" \
+	  || $(CTAGS) $(CTAGSFLAGS) $(AM_CTAGSFLAGS) $(CTAGS_ARGS) \
+	     $$tags $$unique
+
+GTAGS:
+	here=`$(am__cd) $(top_builddir) && pwd` \
+	  && cd $(top_srcdir) \
+	  && gtags -i $(GTAGS_ARGS) $$here
+
+distclean-tags:
+	-rm -f TAGS ID GTAGS GRTAGS GSYMS GPATH tags
+
+distdir: $(DISTFILES)
+	@srcdirstrip=`echo "$(srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
+	topsrcdirstrip=`echo "$(top_srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
+	list='$(DISTFILES)'; \
+	  dist_files=`for file in $$list; do echo $$file; done | \
+	  sed -e "s|^$$srcdirstrip/||;t" \
+	      -e "s|^$$topsrcdirstrip/|$(top_builddir)/|;t"`; \
+	case $$dist_files in \
+	  */*) $(MKDIR_P) `echo "$$dist_files" | \
+			   sed '/\//!d;s|^|$(distdir)/|;s,/[^/]*$$,,' | \
+			   sort -u` ;; \
+	esac; \
+	for file in $$dist_files; do \
+	  if test -f $$file || test -d $$file; then d=.; else d=$(srcdir); fi; \
+	  if test -d $$d/$$file; then \
+	    dir=`echo "/$$file" | sed -e 's,/[^/]*$$,,'`; \
+	    if test -d $(srcdir)/$$file && test $$d != $(srcdir); then \
+	      cp -pR $(srcdir)/$$file $(distdir)$$dir || exit 1; \
+	    fi; \
+	    cp -pR $$d/$$file $(distdir)$$dir || exit 1; \
+	  else \
+	    test -f $(distdir)/$$file \
+	    || cp -p $$d/$$file $(distdir)/$$file \
+	    || exit 1; \
+	  fi; \
+	done
+check-am: all-am
+check: check-am
+all-am: Makefile $(PROGRAMS)
+installdirs:
+	for dir in "$(DESTDIR)$(bindir)"; do \
+	  test -z "$$dir" || $(MKDIR_P) "$$dir"; \
+	done
+install: install-am
+install-exec: install-exec-am
+install-data: install-data-am
+uninstall: uninstall-am
+
+install-am: all-am
+	@$(MAKE) $(AM_MAKEFLAGS) install-exec-am install-data-am
+
+installcheck: installcheck-am
+install-strip:
+	$(MAKE) $(AM_MAKEFLAGS) INSTALL_PROGRAM="$(INSTALL_STRIP_PROGRAM)" \
+	  install_sh_PROGRAM="$(INSTALL_STRIP_PROGRAM)" INSTALL_STRIP_FLAG=-s \
+	  `test -z '$(STRIP)' || \
+	    echo "INSTALL_PROGRAM_ENV=STRIPPROG='$(STRIP)'"` install
+mostlyclean-generic:
+
+clean-generic:
+
+distclean-generic:
+	-test -z "$(CONFIG_CLEAN_FILES)" || rm -f $(CONFIG_CLEAN_FILES)
+
+maintainer-clean-generic:
+	@echo "This command is intended for maintainers to use"
+	@echo "it deletes files that may require special tools to rebuild."
+clean: clean-am
+
+clean-am: clean-binPROGRAMS clean-generic clean-libtool mostlyclean-am
+
+distclean: distclean-am
+	-rm -rf ./$(DEPDIR)
+	-rm -f Makefile
+distclean-am: clean-am distclean-compile distclean-generic \
+	distclean-tags
+
+dvi: dvi-am
+
+dvi-am:
+
+html: html-am
+
+info: info-am
+
+info-am:
+
+install-data-am:
+
+install-dvi: install-dvi-am
+
+install-exec-am: install-binPROGRAMS
+
+install-html: install-html-am
+
+install-info: install-info-am
+
+install-man:
+
+install-pdf: install-pdf-am
+
+install-ps: install-ps-am
+
+installcheck-am:
+
+maintainer-clean: maintainer-clean-am
+	-rm -rf ./$(DEPDIR)
+	-rm -f Makefile
+maintainer-clean-am: distclean-am maintainer-clean-generic
+
+mostlyclean: mostlyclean-am
+
+mostlyclean-am: mostlyclean-compile mostlyclean-generic \
+	mostlyclean-libtool
+
+pdf: pdf-am
+
+pdf-am:
+
+ps: ps-am
+
+ps-am:
+
+uninstall-am: uninstall-binPROGRAMS
+
+.MAKE: install-am install-strip
+
+.PHONY: CTAGS GTAGS all all-am check check-am clean clean-binPROGRAMS \
+	clean-generic clean-libtool ctags distclean distclean-compile \
+	distclean-generic distclean-libtool distclean-tags distdir dvi \
+	dvi-am html html-am info info-am install install-am \
+	install-binPROGRAMS install-data install-data-am install-dvi \
+	install-dvi-am install-exec install-exec-am install-html \
+	install-html-am install-info install-info-am install-man \
+	install-pdf install-pdf-am install-ps install-ps-am \
+	install-strip installcheck installcheck-am installdirs \
+	maintainer-clean maintainer-clean-generic mostlyclean \
+	mostlyclean-compile mostlyclean-generic mostlyclean-libtool \
+	pdf pdf-am ps ps-am tags uninstall uninstall-am \
+	uninstall-binPROGRAMS
+
+# Tell versions [3.59,3.63) of GNU make to not export all variables.
+# Otherwise a system limit (for SysV at least) may be exceeded.
+.NOEXPORT:
diff --git a/keygen/Makefile.am b/keygen/Makefile.am
new file mode 100644
index 0000000..8a65a0b
--- /dev/null
+++ b/keygen/Makefile.am
@@ -0,0 +1,10 @@
+INCLUDES = \
+  -I$(top_srcdir)/common
+
+bin_PROGRAMS = \
+  xrdp-keygen
+
+xrdp_keygen_SOURCES = keygen.c
+
+xrdp_keygen_LDADD = \
+  $(top_srcdir)/common/libcommon.la
diff --git a/keygen/keygen.c b/keygen/keygen.c
new file mode 100755
index 0000000..ec7b661
--- /dev/null
+++ b/keygen/keygen.c
@@ -0,0 +1,473 @@
+/*
+   This program is free software; you can redistribute it and/or modify
+   it under the terms of the GNU General Public License as published by
+   the Free Software Foundation; either version 2 of the License, or
+   (at your option) any later version.
+
+   This program is distributed in the hope that it will be useful,
+   but WITHOUT ANY WARRANTY; without even the implied warranty of
+   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+   GNU General Public License for more details.
+
+   You should have received a copy of the GNU General Public License
+   along with this program; if not, write to the Free Software
+   Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
+
+   xrdp: A Remote Desktop Protocol server.
+   Copyright (C) Jay Sorg 2007-2008
+
+   rsa key generator for xrdp
+
+*/
+
+/*
+   references:
+
+   http://www.securiteam.com/windowsntfocus/5EP010KG0G.html
+
+*/
+
+#include "os_calls.h"
+#include "ssl_calls.h"
+#include "arch.h"
+#include "list.h"
+#include "file.h"
+
+#define MY_KEY_SIZE 512
+
+static tui8 g_exponent[4] =
+{
+  0x01, 0x00, 0x01, 0x00
+};
+
+static tui8 g_ppk_e[4] =
+{
+  0x5B, 0x7B, 0x88, 0xC0
+};
+
+static tui8 g_ppk_n[72] =
+{
+  0x3D, 0x3A, 0x5E, 0xBD, 0x72, 0x43, 0x3E, 0xC9,
+  0x4D, 0xBB, 0xC1, 0x1E, 0x4A, 0xBA, 0x5F, 0xCB,
+  0x3E, 0x88, 0x20, 0x87, 0xEF, 0xF5, 0xC1, 0xE2,
+  0xD7, 0xB7, 0x6B, 0x9A, 0xF2, 0x52, 0x45, 0x95,
+  0xCE, 0x63, 0x65, 0x6B, 0x58, 0x3A, 0xFE, 0xEF,
+  0x7C, 0xE7, 0xBF, 0xFE, 0x3D, 0xF6, 0x5C, 0x7D,
+  0x6C, 0x5E, 0x06, 0x09, 0x1A, 0xF5, 0x61, 0xBB,
+  0x20, 0x93, 0x09, 0x5F, 0x05, 0x6D, 0xEA, 0x87,
+  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
+};
+
+static tui8 g_ppk_d[108] =
+{
+  0x87, 0xA7, 0x19, 0x32, 0xDA, 0x11, 0x87, 0x55,
+  0x58, 0x00, 0x16, 0x16, 0x25, 0x65, 0x68, 0xF8,
+  0x24, 0x3E, 0xE6, 0xFA, 0xE9, 0x67, 0x49, 0x94,
+  0xCF, 0x92, 0xCC, 0x33, 0x99, 0xE8, 0x08, 0x60,
+  0x17, 0x9A, 0x12, 0x9F, 0x24, 0xDD, 0xB1, 0x24,
+  0x99, 0xC7, 0x3A, 0xB8, 0x0A, 0x7B, 0x0D, 0xDD,
+  0x35, 0x07, 0x79, 0x17, 0x0B, 0x51, 0x9B, 0xB3,
+  0xC7, 0x10, 0x01, 0x13, 0xE7, 0x3F, 0xF3, 0x5F,
+  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
+  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
+  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
+  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
+  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
+  0x00, 0x00, 0x00, 0x00
+};
+
+static tui8 g_testkey[176] =
+{
+  0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
+  0x01, 0x00, 0x00, 0x00, 0x06, 0x00, 0x5c, 0x00,
+  0x52, 0x53, 0x41, 0x31, 0x48, 0x00, 0x00, 0x00,
+  0x00, 0x02, 0x00, 0x00, 0x3f, 0x00, 0x00, 0x00,
+  0x01, 0x00, 0x01, 0x00, 0x79, 0x6f, 0xb4, 0xdf,
+  0xa6, 0x95, 0xb9, 0xa9, 0x61, 0xe3, 0xc4, 0x5e,
+  0xff, 0x6b, 0xd8, 0x81, 0x8a, 0x12, 0x4a, 0x93,
+  0x42, 0x97, 0x18, 0x93, 0xac, 0xd1, 0x3a, 0x38,
+  0x3c, 0x68, 0x50, 0x19, 0x31, 0xb6, 0x84, 0x51,
+  0x79, 0xfb, 0x1c, 0xe7, 0xe3, 0x99, 0x20, 0xc7,
+  0x84, 0xdf, 0xd1, 0xaa, 0xb5, 0x15, 0xef, 0x47,
+  0x7e, 0xfc, 0x88, 0xeb, 0x29, 0xc3, 0x27, 0x5a,
+  0x35, 0xf8, 0xfd, 0xaa, 0x00, 0x00, 0x00, 0x00,
+  0x00, 0x00, 0x00, 0x00,
+                          0x08, 0x00, 0x48, 0x00,
+  0x32, 0x3b, 0xde, 0x6f, 0x18, 0x97, 0x1e, 0xc3,
+  0x6b, 0x2b, 0x2d, 0xe4, 0xfc, 0x2d, 0xa2, 0x8e,
+  0x32, 0x3c, 0xf3, 0x1b, 0x24, 0x90, 0x57, 0x4d,
+  0x8e, 0xe4, 0x69, 0xfc, 0x16, 0x8d, 0x41, 0x92,
+  0x78, 0xc7, 0x9c, 0xb4, 0x26, 0xff, 0xe8, 0x3e,
+  0xa1, 0x8a, 0xf5, 0x57, 0xc0, 0x7f, 0x3e, 0x21,
+  0x17, 0x32, 0x30, 0x6f, 0x79, 0xe1, 0x36, 0xcd,
+  0xb6, 0x8e, 0xbe, 0x57, 0x57, 0xd2, 0xa9, 0x36
+};
+
+/* this is the installed signature */
+char inst_pub_sig[]="0x6a,0x41,0xb1,0x43,0xcf,0x47,0x6f,0xf1,0xe6,0xcc,0xa1,\
+0x72,0x97,0xd9,0xe1,0x85,0x15,0xb3,0xc2,0x39,0xa0,0xa6,0x26,0x1a,0xb6,\
+0x49,0x01,0xfa,0xa6,0xda,0x60,0xd7,0x45,0xf7,0x2c,0xee,0xe4,0x8e,0x64,\
+0x2e,0x37,0x49,0xf0,0x4c,0x94,0x6f,0x08,0xf5,0x63,0x4c,0x56,0x29,0x55,\
+0x5a,0x63,0x41,0x2c,0x20,0x65,0x95,0x99,0xb1,0x15,0x7c";
+
+
+/*****************************************************************************/
+static int APP_CC
+out_params(void)
+{
+  g_writeln("");
+  g_writeln("xrdp rsa key gen utility examples");
+  g_writeln("  xrdp-keygen xrdp ['path and file name' | auto]");
+  g_writeln("  xrdp-keygen test");
+  g_writeln("");
+  return 0;
+}
+
+/*****************************************************************************/
+/* this is the special key signing algorithm */
+static int APP_CC
+sign_key(char* e_data, int e_len, char* n_data, int n_len,
+         char* sign_data, int sign_len)
+{
+  char* key;
+  char* md5_final;
+  void* md5;
+
+  if ((e_len != 4) || (n_len != 64) || (sign_len != 64))
+  {
+    return 1;
+  }
+  key = (char*)g_malloc(176, 0);
+  md5_final = (char*)g_malloc(64, 0);
+  md5 = ssl_md5_info_create();
+  /* copy the test key */
+  g_memcpy(key, g_testkey, 176);
+  /* replace e and n */
+  g_memcpy(key + 32, e_data, 4);
+  g_memcpy(key + 36, n_data, 64);
+  ssl_md5_clear(md5);
+  /* the first 108 bytes */
+  ssl_md5_transform(md5, key, 108);
+  /* set the whole thing with 0xff */
+  g_memset(md5_final, 0xff, 64);
+  /* digest 16 bytes */
+  ssl_md5_complete(md5, md5_final);
+  /* set non 0xff array items */
+  md5_final[16] = 0;
+  md5_final[62] = 1;
+  md5_final[63] = 0;
+  /* encrypt */
+  ssl_mod_exp(sign_data, 64, md5_final, 64, (char*)g_ppk_n, 64,
+              (char*)g_ppk_d, 64);
+  /* cleanup */
+  ssl_md5_info_delete(md5);
+  g_free(key);
+  g_free(md5_final);
+  return 0;
+}
+
+/*****************************************************************************/
+static int APP_CC
+write_out_line(int fd, char* name, char* data, int len)
+{
+  int max;
+  int error;
+  int index;
+  int data_item;
+  int buf_pos;
+  char* buf;
+  char* text;
+
+  text = (char*)g_malloc(256, 0);
+  max = len;
+  max = max * 10;
+  buf_pos = g_strlen(name);
+  max = max + buf_pos + 16;
+  buf = (char*)g_malloc(max, 0);
+  g_strncpy(buf, name, max - 1);
+  buf[buf_pos] = '=';
+  buf_pos++;
+  for (index = 0; index < len; index++)
+  {
+    data_item = (tui8)(data[index]);
+    g_snprintf(text, 255, "0x%2.2x", data_item);
+    if (index != 0)
+    {
+      buf[buf_pos] = ',';
+      buf_pos++;
+    }
+    buf[buf_pos] = text[0];
+    buf_pos++;
+    buf[buf_pos] = text[1];
+    buf_pos++;
+    buf[buf_pos] = text[2];
+    buf_pos++;
+    buf[buf_pos] = text[3];
+    buf_pos++;
+  }
+  buf[buf_pos] = '\n';
+  buf_pos++;
+  buf[buf_pos] = 0;
+  error = g_file_write(fd, buf, buf_pos) == -1;
+  g_free(buf);
+  g_free(text);
+  return error;
+}
+
+/*****************************************************************************/
+static int APP_CC
+save_all(char* e_data, int e_len, char* n_data, int n_len,
+         char* d_data, int d_len, char* sign_data, int sign_len,
+         const char* path_and_file_name)
+{
+  int fd;
+  char filename[256];
+
+  if (path_and_file_name == 0)
+  {
+    g_strncpy(filename, "rsakeys.ini", 255);
+  }
+  else
+  {
+    g_strncpy(filename, path_and_file_name, 255);
+  }
+  g_writeln("saving to %s", filename);
+  g_writeln("");
+  if (g_file_exist(filename))
+  {
+    if (g_file_delete(filename) == 0)
+    {
+      g_writeln("problem deleting %s, maybe no rights", filename);
+      return 1;
+    }
+  }
+  fd = g_file_open(filename);
+  if (fd > 0)
+  {
+    if (g_file_write(fd, "[keys]\n", 7) == -1)
+    {
+      g_writeln("problem writing to %s, maybe no rights", filename);
+      return 1;
+    }
+    write_out_line(fd, "pub_exp", e_data, e_len);
+    write_out_line(fd, "pub_mod", n_data, n_len);
+    write_out_line(fd, "pub_sig", sign_data, sign_len);
+    write_out_line(fd, "pri_exp", d_data, d_len);
+  }
+  else
+  {
+    g_writeln("problem opening %s, maybe no rights", filename);
+    return 1;
+  }
+  g_file_close(fd);  
+  return 0;
+}
+
+/*****************************************************************************/
+static int APP_CC
+key_gen(const char* path_and_file_name)
+{
+  char* e_data;
+  char* n_data;
+  char* d_data;
+  char* sign_data;
+  int e_len;
+  int n_len;
+  int d_len;
+  int sign_len;
+  int error;
+
+  e_data = (char*)g_exponent;
+  n_data = (char*)g_malloc(64, 0);
+  d_data = (char*)g_malloc(64, 0);
+  sign_data = (char*)g_malloc(64, 0);
+  e_len = 4;
+  n_len = 64;
+  d_len = 64;
+  sign_len = 64;
+  error = 0;
+  g_writeln("");
+  g_writeln("Generating %d bit rsa key...", MY_KEY_SIZE);
+  g_writeln("");
+  if (error == 0)
+  {
+    error = ssl_gen_key_xrdp1(MY_KEY_SIZE, e_data, e_len, n_data, n_len,
+                              d_data, d_len);
+    if (error != 0)
+    {
+      g_writeln("error %d in key_gen, ssl_gen_key_xrdp1", error);
+    }
+  }
+  if (error == 0)
+  {
+    g_writeln("ssl_gen_key_xrdp1 ok");
+    g_writeln("");
+    error = sign_key(e_data, e_len, n_data, n_len, sign_data, sign_len);
+    if (error != 0)
+    {
+      g_writeln("error %d in key_gen, sign_key", error);
+    }
+  }
+  if (error == 0)
+  {
+    error = save_all(e_data, e_len, n_data, n_len, d_data, d_len,
+                     sign_data, sign_len, path_and_file_name);
+    if (error != 0)
+    {
+      g_writeln("error %d in key_gen, save_all", error);
+    }
+  }
+  g_free(n_data);
+  g_free(d_data);
+  g_free(sign_data);
+  return error;
+}
+
+/*****************************************************************************/
+/* returns boolean */
+static int APP_CC
+key_gen_run_it(void)
+{
+  int fd;
+  int index;
+  int rv;
+  struct list* names;
+  struct list* values;
+  char* name;
+  char* value;
+
+  if (!g_file_exist("/etc/xrdp/rsakeys.ini"))
+  {
+    return 1;
+  }
+  if (g_file_get_size("/etc/xrdp/rsakeys.ini") < 10)
+  {
+    return 1;
+  }
+  fd = g_file_open("/etc/xrdp/rsakeys.ini");
+  if (fd < 0)
+  {
+    return 1;
+  }
+  rv = 0;
+  names = list_create();
+  names->auto_free = 1;
+  values = list_create();
+  values->auto_free = 1;
+  if (file_read_section(fd, "keys", names, values) == 0)
+  {
+    for (index = 0; index < names->count; index++)
+    {
+      name = (char*)list_get_item(names, index);
+      value = (char*)list_get_item(values, index);
+      if (g_strcasecmp(name, "pub_sig") == 0)
+      {
+        if (g_strcasecmp(value, inst_pub_sig) == 0)
+        {
+          rv = 1;
+        }
+      }
+    }
+  }
+  else
+  {
+    g_writeln("error reading keys section of rsakeys.ini");
+  }
+  list_delete(names);
+  list_delete(values);
+  g_file_close(fd);
+  return rv;
+}
+
+/*****************************************************************************/
+static int APP_CC
+key_gen_auto(void)
+{
+  if (key_gen_run_it())
+  {
+    return key_gen("/etc/xrdp/rsakeys.ini");
+  }
+  g_writeln("xrdp-keygen does not need to run");
+  return 0;
+}
+
+/*****************************************************************************/
+static int APP_CC
+key_test(void)
+{
+  char* md5_final;
+  char* sig;
+  void* md5;
+
+  md5_final = (char*)g_malloc(64, 0);
+  sig = (char*)g_malloc(64, 0);
+  md5 = ssl_md5_info_create();
+  g_writeln("original key is:");
+  g_hexdump((char*)g_testkey, 176);
+  g_writeln("original exponent is:");
+  g_hexdump((char*)g_testkey + 32, 4);
+  g_writeln("original modulus is:");
+  g_hexdump((char*)g_testkey + 36, 64);
+  g_writeln("original signature is:");
+  g_hexdump((char*)g_testkey + 112, 64);
+  ssl_md5_clear(md5);
+  ssl_md5_transform(md5, (char*)g_testkey, 108);
+  g_memset(md5_final, 0xff, 64);
+  ssl_md5_complete(md5, md5_final);
+  g_writeln("md5 hash of first 108 bytes of this key is:");
+  g_hexdump(md5_final, 16);
+  md5_final[16] = 0;
+  md5_final[62] = 1;
+  md5_final[63] = 0;
+  ssl_mod_exp(sig, 64, md5_final, 64, (char*)g_ppk_n, 64, (char*)g_ppk_d, 64);
+  g_writeln("produced signature(this should match original \
+signature above) is:");
+  g_hexdump(sig, 64);
+  g_memset(md5_final, 0, 64);
+  ssl_mod_exp(md5_final, 64, (char*)g_testkey + 112, 64, (char*)g_ppk_n, 64,
+              (char*)g_ppk_e, 4);
+  g_writeln("decrypted hash of first 108 bytes of this key is:");
+  g_hexdump(md5_final, 64);
+  ssl_md5_info_delete(md5);
+  g_free(md5_final);
+  g_free(sig);
+  return 0;
+}
+
+/*****************************************************************************/
+int DEFAULT_CC
+main(int argc, char** argv)
+{
+  if (argc > 1)
+  {
+    if (g_strcasecmp(argv[1], "xrdp") == 0)
+    {
+      if (argc > 2)
+      {
+        if (g_strcasecmp(argv[2], "auto") == 0)
+        {
+          if (g_getuid() != 0)
+          {
+            g_writeln("must run as root");
+            return 0;
+          }
+          return key_gen_auto();
+        }
+        else
+        {
+          return key_gen(argv[2]);
+        }
+      }
+      else
+      {
+        return key_gen(0);
+      }
+    }
+    else if (g_strcasecmp(argv[1], "test") == 0)
+    {
+      return key_test();
+    }
+  }
+  out_params();
+  return 0;
+}
diff --git a/libxrdp/Makefile b/libxrdp/Makefile
index 28c9cd1..9202226 100644
--- a/libxrdp/Makefile
+++ b/libxrdp/Makefile
@@ -1,50 +1,490 @@
-# libxrdp makefile
-LIBXRDPOBJ = libxrdp.o xrdp_tcp.o xrdp_iso.o xrdp_mcs.o \
-             xrdp_sec.o xrdp_rdp.o xrdp_orders.o \
-             xrdp_bitmap_compress.o xrdp_channel.o \
-             os_calls.o ssl_calls.o file.o
-
-DESTDIR = /usr/local/xrdp
-CFGDIR = /etc/xrdp
-PIDDIR = /var/run
-MANDIR = /usr/local/man
-DOCDIR = /usr/doc/xrdp
-
-DEFINES = -DXRDP_CFG_FILE=\"$(CFGDIR)/xrdp.ini\" \
-          -DXRDP_KEY_FILE=\"$(CFGDIR)/rsakeys.ini\"
-
-CFLAGS = -Wall -O2 -I../common -fPIC $(DEFINES)
-#CFLAGS += -DXRDP_DEBUG
-C_OS_FLAGS = $(CFLAGS) -c
-LDFLAGS = -shared
-LIBS = -ldl
-LIBS += -lcrypto
+# Makefile.in generated by automake 1.10.1 from Makefile.am.
+# libxrdp/Makefile.  Generated from Makefile.in by configure.
+
+# Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
+# 2003, 2004, 2005, 2006, 2007, 2008  Free Software Foundation, Inc.
+# This Makefile.in is free software; the Free Software Foundation
+# gives unlimited permission to copy and/or distribute it,
+# with or without modifications, as long as this notice is preserved.
+
+# This program is distributed in the hope that it will be useful,
+# but WITHOUT ANY WARRANTY, to the extent permitted by law; without
+# even the implied warranty of MERCHANTABILITY or FITNESS FOR A
+# PARTICULAR PURPOSE.
+
+
+
+
+pkgdatadir = $(datadir)/xrdp
+pkglibdir = $(libdir)/xrdp
+pkgincludedir = $(includedir)/xrdp
+am__cd = CDPATH="$${ZSH_VERSION+.}$(PATH_SEPARATOR)" && cd
+install_sh_DATA = $(install_sh) -c -m 644
+install_sh_PROGRAM = $(install_sh) -c
+install_sh_SCRIPT = $(install_sh) -c
+INSTALL_HEADER = $(INSTALL_DATA)
+transform = $(program_transform_name)
+NORMAL_INSTALL = :
+PRE_INSTALL = :
+POST_INSTALL = :
+NORMAL_UNINSTALL = :
+PRE_UNINSTALL = :
+POST_UNINSTALL = :
+build_triplet = i686-suse-linux-gnu
+host_triplet = i686-suse-linux-gnu
+subdir = libxrdp
+DIST_COMMON = $(srcdir)/Makefile.am $(srcdir)/Makefile.in
+ACLOCAL_M4 = $(top_srcdir)/aclocal.m4
+am__aclocal_m4_deps = $(top_srcdir)/configure.ac
+am__configure_deps = $(am__aclocal_m4_deps) $(CONFIGURE_DEPENDENCIES) \
+	$(ACLOCAL_M4)
+mkinstalldirs = $(install_sh) -d
+CONFIG_HEADER = $(top_builddir)/config_ac.h
+CONFIG_CLEAN_FILES =
+am__vpath_adj_setup = srcdirstrip=`echo "$(srcdir)" | sed 's|.|.|g'`;
+am__vpath_adj = case $$p in \
+    $(srcdir)/*) f=`echo "$$p" | sed "s|^$$srcdirstrip/||"`;; \
+    *) f=$$p;; \
+  esac;
+am__strip_dir = `echo $$p | sed -e 's|^.*/||'`;
+am__installdirs = "$(DESTDIR)$(libdir)"
+libLTLIBRARIES_INSTALL = $(INSTALL)
+LTLIBRARIES = $(lib_LTLIBRARIES)
+libxrdp_la_DEPENDENCIES = $(top_srcdir)/common/libcommon.la
+am_libxrdp_la_OBJECTS = libxrdp.lo xrdp_channel.lo xrdp_iso.lo \
+	xrdp_mcs.lo xrdp_orders.lo xrdp_rdp.lo xrdp_sec.lo xrdp_tcp.lo \
+	xrdp_bitmap_compress.lo
+libxrdp_la_OBJECTS = $(am_libxrdp_la_OBJECTS)
+DEFAULT_INCLUDES = -I. -I$(top_builddir)
+depcomp = $(SHELL) $(top_srcdir)/depcomp
+am__depfiles_maybe = depfiles
+COMPILE = $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) \
+	$(CPPFLAGS) $(AM_CFLAGS) $(CFLAGS)
+LTCOMPILE = $(LIBTOOL) --tag=CC $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) \
+	--mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) \
+	$(AM_CPPFLAGS) $(CPPFLAGS) $(AM_CFLAGS) $(CFLAGS)
+CCLD = $(CC)
+LINK = $(LIBTOOL) --tag=CC $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) \
+	--mode=link $(CCLD) $(AM_CFLAGS) $(CFLAGS) $(AM_LDFLAGS) \
+	$(LDFLAGS) -o $@
+SOURCES = $(libxrdp_la_SOURCES)
+DIST_SOURCES = $(libxrdp_la_SOURCES)
+ETAGS = etags
+CTAGS = ctags
+DISTFILES = $(DIST_COMMON) $(DIST_SOURCES) $(TEXINFOS) $(EXTRA_DIST)
+ACLOCAL = ${SHELL} /home/david/git/xrdp/missing --run aclocal-1.10
+AMTAR = ${SHELL} /home/david/git/xrdp/missing --run tar
+AR = ar
+AUTOCONF = ${SHELL} /home/david/git/xrdp/missing --run autoconf
+AUTOHEADER = ${SHELL} /home/david/git/xrdp/missing --run autoheader
+AUTOMAKE = ${SHELL} /home/david/git/xrdp/missing --run automake-1.10
+AWK = gawk
 CC = gcc
+CCDEPMODE = depmode=gcc3
+CFLAGS = -g -O2
+CPP = gcc -E
+CPPFLAGS = 
+CXX = g++
+CXXCPP = g++ -E
+CXXDEPMODE = depmode=gcc3
+CXXFLAGS = -g -O2
+CYGPATH_W = echo
+DEFS = -DHAVE_CONFIG_H
+DEPDIR = .deps
+DSYMUTIL = 
+ECHO = echo
+ECHO_C = 
+ECHO_N = -n
+ECHO_T = 
+EGREP = /usr/bin/grep -E
+EXEEXT = 
+F77 = 
+FFLAGS = 
+GREP = /usr/bin/grep
+INSTALL = /usr/bin/install -c
+INSTALL_DATA = ${INSTALL} -m 644
+INSTALL_PROGRAM = ${INSTALL}
+INSTALL_SCRIPT = ${INSTALL}
+INSTALL_STRIP_PROGRAM = $(install_sh) -c -s
+LDFLAGS = 
+LIBOBJS = 
+LIBS = 
+LIBTOOL = $(SHELL) $(top_builddir)/libtool
+LN_S = ln -s
+LTLIBOBJS = 
+MAKEINFO = ${SHELL} /home/david/git/xrdp/missing --run makeinfo
+MKDIR_P = /bin/mkdir -p
+NMEDIT = 
+OBJEXT = o
+PACKAGE = xrdp
+PACKAGE_BUGREPORT = xrdp-devel@lists.sourceforge.net
+PACKAGE_NAME = xrdp
+PACKAGE_STRING = xrdp 0.5.0
+PACKAGE_TARNAME = xrdp
+PACKAGE_VERSION = 0.5.0
+PATH_SEPARATOR = :
+RANLIB = ranlib
+SED = /usr/bin/sed
+SET_MAKE = 
+SHELL = /bin/sh
+STRIP = strip
+VERSION = 0.5.0
+abs_builddir = /home/david/git/xrdp/libxrdp
+abs_srcdir = /home/david/git/xrdp/libxrdp
+abs_top_builddir = /home/david/git/xrdp
+abs_top_srcdir = /home/david/git/xrdp
+ac_ct_CC = gcc
+ac_ct_CXX = g++
+ac_ct_F77 = 
+am__include = include
+am__leading_dot = .
+am__quote = 
+am__tar = ${AMTAR} chof - "$$tardir"
+am__untar = ${AMTAR} xf -
+bindir = ${exec_prefix}/bin
+build = i686-suse-linux-gnu
+build_alias = 
+build_cpu = i686
+build_os = linux-gnu
+build_vendor = suse
+builddir = .
+datadir = ${datarootdir}
+datarootdir = ${prefix}/share
+docdir = ${datarootdir}/doc/${PACKAGE_TARNAME}
+dvidir = ${docdir}
+exec_prefix = ${prefix}
+host = i686-suse-linux-gnu
+host_alias = 
+host_cpu = i686
+host_os = linux-gnu
+host_vendor = suse
+htmldir = ${docdir}
+includedir = ${prefix}/include
+infodir = ${datarootdir}/info
+install_sh = $(SHELL) /home/david/git/xrdp/install-sh
+libdir = ${exec_prefix}/lib/xrdp/
+libexecdir = ${exec_prefix}/libexec
+localedir = ${datarootdir}/locale
+localstatedir = ${prefix}/var
+mandir = ${datarootdir}/man
+mkdir_p = /bin/mkdir -p
+oldincludedir = /usr/include
+pdfdir = ${docdir}
+prefix = /usr
+program_transform_name = s,x,x,
+psdir = ${docdir}
+sbindir = ${exec_prefix}/sbin
+sharedstatedir = ${prefix}/com
+srcdir = .
+sysconfdir = ${prefix}/etc
+target_alias = 
+top_builddir = ..
+top_srcdir = ..
+INCLUDES = \
+  -I$(top_srcdir)/common
+
+lib_LTLIBRARIES = \
+  libxrdp.la
+
+libxrdp_la_SOURCES = \
+  libxrdp.c \
+  xrdp_channel.c \
+  xrdp_iso.c \
+  xrdp_mcs.c \
+  xrdp_orders.c \
+  xrdp_rdp.c \
+  xrdp_sec.c \
+  xrdp_tcp.c \
+  xrdp_bitmap_compress.c
+
+libxrdp_la_LIBADD = \
+  $(top_srcdir)/common/libcommon.la
+
+all: all-am
+
+.SUFFIXES:
+.SUFFIXES: .c .lo .o .obj
+$(srcdir)/Makefile.in:  $(srcdir)/Makefile.am  $(am__configure_deps)
+	@for dep in $?; do \
+	  case '$(am__configure_deps)' in \
+	    *$$dep*) \
+	      cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh \
+		&& exit 0; \
+	      exit 1;; \
+	  esac; \
+	done; \
+	echo ' cd $(top_srcdir) && $(AUTOMAKE) --foreign  libxrdp/Makefile'; \
+	cd $(top_srcdir) && \
+	  $(AUTOMAKE) --foreign  libxrdp/Makefile
+.PRECIOUS: Makefile
+Makefile: $(srcdir)/Makefile.in $(top_builddir)/config.status
+	@case '$?' in \
+	  *config.status*) \
+	    cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh;; \
+	  *) \
+	    echo ' cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe)'; \
+	    cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe);; \
+	esac;
+
+$(top_builddir)/config.status: $(top_srcdir)/configure $(CONFIG_STATUS_DEPENDENCIES)
+	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
+
+$(top_srcdir)/configure:  $(am__configure_deps)
+	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
+$(ACLOCAL_M4):  $(am__aclocal_m4_deps)
+	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
+install-libLTLIBRARIES: $(lib_LTLIBRARIES)
+	@$(NORMAL_INSTALL)
+	test -z "$(libdir)" || $(MKDIR_P) "$(DESTDIR)$(libdir)"
+	@list='$(lib_LTLIBRARIES)'; for p in $$list; do \
+	  if test -f $$p; then \
+	    f=$(am__strip_dir) \
+	    echo " $(LIBTOOL) $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=install $(libLTLIBRARIES_INSTALL) $(INSTALL_STRIP_FLAG) '$$p' '$(DESTDIR)$(libdir)/$$f'"; \
+	    $(LIBTOOL) $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=install $(libLTLIBRARIES_INSTALL) $(INSTALL_STRIP_FLAG) "$$p" "$(DESTDIR)$(libdir)/$$f"; \
+	  else :; fi; \
+	done
+
+uninstall-libLTLIBRARIES:
+	@$(NORMAL_UNINSTALL)
+	@list='$(lib_LTLIBRARIES)'; for p in $$list; do \
+	  p=$(am__strip_dir) \
+	  echo " $(LIBTOOL) $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=uninstall rm -f '$(DESTDIR)$(libdir)/$$p'"; \
+	  $(LIBTOOL) $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=uninstall rm -f "$(DESTDIR)$(libdir)/$$p"; \
+	done
+
+clean-libLTLIBRARIES:
+	-test -z "$(lib_LTLIBRARIES)" || rm -f $(lib_LTLIBRARIES)
+	@list='$(lib_LTLIBRARIES)'; for p in $$list; do \
+	  dir="`echo $$p | sed -e 's|/[^/]*$$||'`"; \
+	  test "$$dir" != "$$p" || dir=.; \
+	  echo "rm -f \"$${dir}/so_locations\""; \
+	  rm -f "$${dir}/so_locations"; \
+	done
+libxrdp.la: $(libxrdp_la_OBJECTS) $(libxrdp_la_DEPENDENCIES) 
+	$(LINK) -rpath $(libdir) $(libxrdp_la_OBJECTS) $(libxrdp_la_LIBADD) $(LIBS)
+
+mostlyclean-compile:
+	-rm -f *.$(OBJEXT)
+
+distclean-compile:
+	-rm -f *.tab.c
+
+include ./$(DEPDIR)/libxrdp.Plo
+include ./$(DEPDIR)/xrdp_bitmap_compress.Plo
+include ./$(DEPDIR)/xrdp_channel.Plo
+include ./$(DEPDIR)/xrdp_iso.Plo
+include ./$(DEPDIR)/xrdp_mcs.Plo
+include ./$(DEPDIR)/xrdp_orders.Plo
+include ./$(DEPDIR)/xrdp_rdp.Plo
+include ./$(DEPDIR)/xrdp_sec.Plo
+include ./$(DEPDIR)/xrdp_tcp.Plo
+
+.c.o:
+	$(COMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ $<
+	mv -f $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Po
+#	source='$<' object='$@' libtool=no \
+#	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) \
+#	$(COMPILE) -c $<
+
+.c.obj:
+	$(COMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ `$(CYGPATH_W) '$<'`
+	mv -f $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Po
+#	source='$<' object='$@' libtool=no \
+#	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) \
+#	$(COMPILE) -c `$(CYGPATH_W) '$<'`
+
+.c.lo:
+	$(LTCOMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ $<
+	mv -f $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Plo
+#	source='$<' object='$@' libtool=yes \
+#	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) \
+#	$(LTCOMPILE) -c -o $@ $<
+
+mostlyclean-libtool:
+	-rm -f *.lo
+
+clean-libtool:
+	-rm -rf .libs _libs
+
+ID: $(HEADERS) $(SOURCES) $(LISP) $(TAGS_FILES)
+	list='$(SOURCES) $(HEADERS) $(LISP) $(TAGS_FILES)'; \
+	unique=`for i in $$list; do \
+	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
+	  done | \
+	  $(AWK) '{ files[$$0] = 1; nonemtpy = 1; } \
+	      END { if (nonempty) { for (i in files) print i; }; }'`; \
+	mkid -fID $$unique
+tags: TAGS
+
+TAGS:  $(HEADERS) $(SOURCES)  $(TAGS_DEPENDENCIES) \
+		$(TAGS_FILES) $(LISP)
+	tags=; \
+	here=`pwd`; \
+	list='$(SOURCES) $(HEADERS)  $(LISP) $(TAGS_FILES)'; \
+	unique=`for i in $$list; do \
+	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
+	  done | \
+	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
+	      END { if (nonempty) { for (i in files) print i; }; }'`; \
+	if test -z "$(ETAGS_ARGS)$$tags$$unique"; then :; else \
+	  test -n "$$unique" || unique=$$empty_fix; \
+	  $(ETAGS) $(ETAGSFLAGS) $(AM_ETAGSFLAGS) $(ETAGS_ARGS) \
+	    $$tags $$unique; \
+	fi
+ctags: CTAGS
+CTAGS:  $(HEADERS) $(SOURCES)  $(TAGS_DEPENDENCIES) \
+		$(TAGS_FILES) $(LISP)
+	tags=; \
+	list='$(SOURCES) $(HEADERS)  $(LISP) $(TAGS_FILES)'; \
+	unique=`for i in $$list; do \
+	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
+	  done | \
+	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
+	      END { if (nonempty) { for (i in files) print i; }; }'`; \
+	test -z "$(CTAGS_ARGS)$$tags$$unique" \
+	  || $(CTAGS) $(CTAGSFLAGS) $(AM_CTAGSFLAGS) $(CTAGS_ARGS) \
+	     $$tags $$unique
+
+GTAGS:
+	here=`$(am__cd) $(top_builddir) && pwd` \
+	  && cd $(top_srcdir) \
+	  && gtags -i $(GTAGS_ARGS) $$here
+
+distclean-tags:
+	-rm -f TAGS ID GTAGS GRTAGS GSYMS GPATH tags
+
+distdir: $(DISTFILES)
+	@srcdirstrip=`echo "$(srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
+	topsrcdirstrip=`echo "$(top_srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
+	list='$(DISTFILES)'; \
+	  dist_files=`for file in $$list; do echo $$file; done | \
+	  sed -e "s|^$$srcdirstrip/||;t" \
+	      -e "s|^$$topsrcdirstrip/|$(top_builddir)/|;t"`; \
+	case $$dist_files in \
+	  */*) $(MKDIR_P) `echo "$$dist_files" | \
+			   sed '/\//!d;s|^|$(distdir)/|;s,/[^/]*$$,,' | \
+			   sort -u` ;; \
+	esac; \
+	for file in $$dist_files; do \
+	  if test -f $$file || test -d $$file; then d=.; else d=$(srcdir); fi; \
+	  if test -d $$d/$$file; then \
+	    dir=`echo "/$$file" | sed -e 's,/[^/]*$$,,'`; \
+	    if test -d $(srcdir)/$$file && test $$d != $(srcdir); then \
+	      cp -pR $(srcdir)/$$file $(distdir)$$dir || exit 1; \
+	    fi; \
+	    cp -pR $$d/$$file $(distdir)$$dir || exit 1; \
+	  else \
+	    test -f $(distdir)/$$file \
+	    || cp -p $$d/$$file $(distdir)/$$file \
+	    || exit 1; \
+	  fi; \
+	done
+check-am: all-am
+check: check-am
+all-am: Makefile $(LTLIBRARIES)
+installdirs:
+	for dir in "$(DESTDIR)$(libdir)"; do \
+	  test -z "$$dir" || $(MKDIR_P) "$$dir"; \
+	done
+install: install-am
+install-exec: install-exec-am
+install-data: install-data-am
+uninstall: uninstall-am
+
+install-am: all-am
+	@$(MAKE) $(AM_MAKEFLAGS) install-exec-am install-data-am
+
+installcheck: installcheck-am
+install-strip:
+	$(MAKE) $(AM_MAKEFLAGS) INSTALL_PROGRAM="$(INSTALL_STRIP_PROGRAM)" \
+	  install_sh_PROGRAM="$(INSTALL_STRIP_PROGRAM)" INSTALL_STRIP_FLAG=-s \
+	  `test -z '$(STRIP)' || \
+	    echo "INSTALL_PROGRAM_ENV=STRIPPROG='$(STRIP)'"` install
+mostlyclean-generic:
+
+clean-generic:
+
+distclean-generic:
+	-test -z "$(CONFIG_CLEAN_FILES)" || rm -f $(CONFIG_CLEAN_FILES)
+
+maintainer-clean-generic:
+	@echo "This command is intended for maintainers to use"
+	@echo "it deletes files that may require special tools to rebuild."
+clean: clean-am
+
+clean-am: clean-generic clean-libLTLIBRARIES clean-libtool \
+	mostlyclean-am
+
+distclean: distclean-am
+	-rm -rf ./$(DEPDIR)
+	-rm -f Makefile
+distclean-am: clean-am distclean-compile distclean-generic \
+	distclean-tags
+
+dvi: dvi-am
+
+dvi-am:
+
+html: html-am
+
+info: info-am
+
+info-am:
+
+install-data-am:
+
+install-dvi: install-dvi-am
+
+install-exec-am: install-libLTLIBRARIES
+
+install-html: install-html-am
+
+install-info: install-info-am
+
+install-man:
+
+install-pdf: install-pdf-am
+
+install-ps: install-ps-am
+
+installcheck-am:
+
+maintainer-clean: maintainer-clean-am
+	-rm -rf ./$(DEPDIR)
+	-rm -f Makefile
+maintainer-clean-am: distclean-am maintainer-clean-generic
 
-all: libxrdp
+mostlyclean: mostlyclean-am
 
-static: $(LIBXRDPOBJ)
-	$(AR) rvu libxrdp.a $(LIBXRDPOBJ)
-	ranlib libxrdp.a
+mostlyclean-am: mostlyclean-compile mostlyclean-generic \
+	mostlyclean-libtool
 
-libxrdp: $(LIBXRDPOBJ)
-	$(CC) $(LDFLAGS) -o libxrdp.so $(LIBXRDPOBJ) $(LIBS)
+pdf: pdf-am
 
-clean:
-	rm -f $(LIBXRDPOBJ) libxrdp.a libxrdp.so
+pdf-am:
 
-install:
-	install libxrdp.so $(DESTDIR)/libxrdp.so
+ps: ps-am
 
-installdeb:
-	install libxrdp.so $(DESTDIRDEB)/usr/lib/xrdp/libxrdp.so
+ps-am:
 
-file.o: ../common/file.c
-	$(CC) $(C_OS_FLAGS) ../common/file.c
+uninstall-am: uninstall-libLTLIBRARIES
 
-os_calls.o: ../common/os_calls.c
-	$(CC) $(C_OS_FLAGS) ../common/os_calls.c
+.MAKE: install-am install-strip
 
+.PHONY: CTAGS GTAGS all all-am check check-am clean clean-generic \
+	clean-libLTLIBRARIES clean-libtool ctags distclean \
+	distclean-compile distclean-generic distclean-libtool \
+	distclean-tags distdir dvi dvi-am html html-am info info-am \
+	install install-am install-data install-data-am install-dvi \
+	install-dvi-am install-exec install-exec-am install-html \
+	install-html-am install-info install-info-am \
+	install-libLTLIBRARIES install-man install-pdf install-pdf-am \
+	install-ps install-ps-am install-strip installcheck \
+	installcheck-am installdirs maintainer-clean \
+	maintainer-clean-generic mostlyclean mostlyclean-compile \
+	mostlyclean-generic mostlyclean-libtool pdf pdf-am ps ps-am \
+	tags uninstall uninstall-am uninstall-libLTLIBRARIES
 
-ssl_calls.o: ../common/ssl_calls.c
-	$(CC) $(C_OS_FLAGS) ../common/ssl_calls.c
+# Tell versions [3.59,3.63) of GNU make to not export all variables.
+# Otherwise a system limit (for SysV at least) may be exceeded.
+.NOEXPORT:
diff --git a/libxrdp/Makefile.am b/libxrdp/Makefile.am
new file mode 100644
index 0000000..9d140d8
--- /dev/null
+++ b/libxrdp/Makefile.am
@@ -0,0 +1,19 @@
+INCLUDES = \
+  -I$(top_srcdir)/common
+
+lib_LTLIBRARIES = \
+  libxrdp.la
+
+libxrdp_la_SOURCES = \
+  libxrdp.c \
+  xrdp_channel.c \
+  xrdp_iso.c \
+  xrdp_mcs.c \
+  xrdp_orders.c \
+  xrdp_rdp.c \
+  xrdp_sec.c \
+  xrdp_tcp.c \
+  xrdp_bitmap_compress.c
+
+libxrdp_la_LIBADD = \
+  $(top_srcdir)/common/libcommon.la
diff --git a/libxrdp/Makefile.osx b/libxrdp/Makefile.osx
new file mode 100644
index 0000000..68691ba
--- /dev/null
+++ b/libxrdp/Makefile.osx
@@ -0,0 +1,48 @@
+# libxrdp makefile
+LIBXRDPOBJ = libxrdp.o xrdp_tcp.o xrdp_iso.o xrdp_mcs.o \
+             xrdp_sec.o xrdp_rdp.o xrdp_orders.o \
+             xrdp_bitmap_compress.o xrdp_channel.o \
+             os_calls.o ssl_calls.o file.o
+
+DESTDIR = /usr/local/xrdp
+CFGDIR = /etc/xrdp
+PIDDIR = /var/run
+MANDIR = /usr/local/man
+DOCDIR = /usr/doc/xrdp
+
+DEFINES = -DXRDP_CFG_FILE=\"$(CFGDIR)/xrdp.ini\" \
+          -DXRDP_KEY_FILE=\"$(CFGDIR)/rsakeys.ini\"
+
+LIBXRDP = libxrdp.dylib
+
+CFLAGS = -Wall -O2 -I../common -fPIC $(DEFINES)
+#CFLAGS += -DXRDP_DEBUG
+C_OS_FLAGS = $(CFLAGS) -c
+LDFLAGS = -dynamiclib -Wl,-flat_namespace -Wl,-undefined -Wl,suppress
+LIBS = -lcrypto
+CC = gcc
+
+all: $(LIBXRDP)
+
+static: $(LIBXRDPOBJ)
+	$(AR) rvu libxrdp.a $(LIBXRDPOBJ)
+	ranlib libxrdp.a
+
+$(LIBXRDP): $(LIBXRDPOBJ)
+	$(CC) $(LDFLAGS) -o $(LIBXRDP) $(LIBXRDPOBJ) $(LIBS)
+
+clean:
+	rm -f $(LIBXRDPOBJ) libxrdp.a $(LIBXRDP)
+
+install:
+	install $(LIBXRDP) $(DESTDIR)/$(LIBXRDP)
+
+file.o: ../common/file.c
+	$(CC) $(C_OS_FLAGS) ../common/file.c
+
+os_calls.o: ../common/os_calls.c
+	$(CC) $(C_OS_FLAGS) ../common/os_calls.c
+
+
+ssl_calls.o: ../common/ssl_calls.c
+	$(CC) $(C_OS_FLAGS) ../common/ssl_calls.c
diff --git a/libxrdp/libxrdp.c b/libxrdp/libxrdp.c
index 6b655c1..d46b0a0 100644
--- a/libxrdp/libxrdp.c
+++ b/libxrdp/libxrdp.c
@@ -14,7 +14,7 @@
    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
 
    xrdp: A Remote Desktop Protocol server.
-   Copyright (C) Jay Sorg 2004-2007
+   Copyright (C) Jay Sorg 2004-2008
 
    this is the interface to libxrdp
 
@@ -716,3 +716,14 @@ libxrdp_send_to_channel(struct xrdp_session* session, int channel_id,
   free_stream(s);
   return 0;
 }
+
+/*****************************************************************************/
+int EXPORT_CC
+libxrdp_orders_send_brush(struct xrdp_session* session,
+                          int width, int height, int bpp, int type,
+                          int size, char* data, int cache_id)
+{
+  return xrdp_orders_send_brush((struct xrdp_orders*)session->orders,
+                                width, height, bpp, type, size, data,
+                                cache_id);
+}
diff --git a/libxrdp/libxrdp.h b/libxrdp/libxrdp.h
index d8bcae1..d4aff1b 100644
--- a/libxrdp/libxrdp.h
+++ b/libxrdp/libxrdp.h
@@ -14,7 +14,7 @@
    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
 
    xrdp: A Remote Desktop Protocol server.
-   Copyright (C) Jay Sorg 2004-2007
+   Copyright (C) Jay Sorg 2004-2008
 
    libxrdp header
 
@@ -23,6 +23,9 @@
 #if !defined(LIBXRDP_H)
 #define LIBXRDP_H
 
+#if defined(HAVE_CONFIG_H)
+#include "config_ac.h"
+#endif
 #include "arch.h"
 #include "parse.h"
 #include "xrdp_constants.h"
@@ -32,6 +35,7 @@
 #include "list.h"
 #include "file.h"
 #include "libxrdpinc.h"
+#include "file_loc.h"
 
 /* tcp */
 struct xrdp_tcp
@@ -379,6 +383,9 @@ int APP_CC
 xrdp_orders_send_bitmap2(struct xrdp_orders* self,
                          int width, int height, int bpp, char* data,
                          int cache_id, int cache_idx);
+int APP_CC
+xrdp_orders_send_brush(struct xrdp_orders* self, int width, int height,
+                       int bpp, int type, int size, char* data, int cache_id);
 
 /* xrdp_bitmap_compress.c */
 int APP_CC
diff --git a/libxrdp/libxrdpinc.h b/libxrdp/libxrdpinc.h
index b3c15c4..8e12642 100644
--- a/libxrdp/libxrdpinc.h
+++ b/libxrdp/libxrdpinc.h
@@ -14,7 +14,7 @@
    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
 
    xrdp: A Remote Desktop Protocol server.
-   Copyright (C) Jay Sorg 2004-2007
+   Copyright (C) Jay Sorg 2004-2008
 
    header file for use with libxrdp.so / xrdp.dll
 
@@ -60,6 +60,9 @@ struct xrdp_client_info
   int channel_code; /* 0 = no channels 1 = channels */
   int sound_code; /* 1 = leave sound at server */
   int is_mce;
+  int rdp5_performanceflags;
+  int brush_cache_code; /* 0 = no cache 1 = 8x8 standard cache
+                           2 = arbitrary dimensions */
 };
 
 struct xrdp_brush
@@ -206,5 +209,9 @@ libxrdp_get_channel_id(struct xrdp_session* session, char* name);
 int DEFAULT_CC
 libxrdp_send_to_channel(struct xrdp_session* session, int channel_id,
                         char* data, int data_len);
+int DEFAULT_CC
+libxrdp_orders_send_brush(struct xrdp_session* session,
+                          int width, int height, int bpp, int type,
+                          int size, char* data, int cache_id);
 
 #endif
diff --git a/libxrdp/xrdp_bitmap_compress.c b/libxrdp/xrdp_bitmap_compress.c
index be10165..0a05b87 100644
--- a/libxrdp/xrdp_bitmap_compress.c
+++ b/libxrdp/xrdp_bitmap_compress.c
@@ -14,7 +14,7 @@
    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
 
    xrdp: A Remote Desktop Protocol server.
-   Copyright (C) Jay Sorg 2004-2007
+   Copyright (C) Jay Sorg 2004-2008
 
    bitmap compressor
 
diff --git a/libxrdp/xrdp_channel.c b/libxrdp/xrdp_channel.c
index b7b5ece..cfe8a4d 100644
--- a/libxrdp/xrdp_channel.c
+++ b/libxrdp/xrdp_channel.c
@@ -14,7 +14,7 @@
    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
 
    xrdp: A Remote Desktop Protocol server.
-   Copyright (C) Jay Sorg 2006-2007
+   Copyright (C) Jay Sorg 2006-2008
 
    channel layer
 
diff --git a/libxrdp/xrdp_iso.c b/libxrdp/xrdp_iso.c
index 1ee2c4c..01e9eba 100644
--- a/libxrdp/xrdp_iso.c
+++ b/libxrdp/xrdp_iso.c
@@ -14,7 +14,7 @@
    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
 
    xrdp: A Remote Desktop Protocol server.
-   Copyright (C) Jay Sorg 2004-2007
+   Copyright (C) Jay Sorg 2004-2008
 
    iso layer
 
diff --git a/libxrdp/xrdp_mcs.c b/libxrdp/xrdp_mcs.c
index b22c666..d8fb180 100644
--- a/libxrdp/xrdp_mcs.c
+++ b/libxrdp/xrdp_mcs.c
@@ -14,7 +14,7 @@
    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
 
    xrdp: A Remote Desktop Protocol server.
-   Copyright (C) Jay Sorg 2004-2007
+   Copyright (C) Jay Sorg 2004-2008
 
    mcs layer
 
@@ -664,6 +664,7 @@ int APP_CC
 xrdp_mcs_send(struct xrdp_mcs* self, struct stream* s, int chan)
 {
   int len;
+  char* lp;
   //static int max_len = 0;
 
   DEBUG(("  in xrdp_mcs_send"));
@@ -680,12 +681,27 @@ xrdp_mcs_send(struct xrdp_mcs* self, struct stream* s, int chan)
   //}
   //g_printf("mcs length %d max length is %d\r\n", len, max_len);
   //g_printf("mcs length %d\r\n", len);
-  len = len | 0x8000;
   out_uint8(s, MCS_SDIN << 2);
   out_uint16_be(s, self->userid);
   out_uint16_be(s, chan);
   out_uint8(s, 0x70);
-  out_uint16_be(s, len);
+  if (len >= 128)
+  {
+    len = len | 0x8000;
+    out_uint16_be(s, len);
+  }
+  else
+  {
+    out_uint8(s, len);
+    /* move everything up one byte */
+    lp = s->p;
+    while (lp < s->end)
+    {
+      lp[0] = lp[1];
+      lp++;
+    }
+    s->end--;
+  }
   if (xrdp_iso_send(self->iso_layer, s) != 0)
   {
     DEBUG(("  out xrdp_mcs_send error"));
diff --git a/libxrdp/xrdp_orders.c b/libxrdp/xrdp_orders.c
index f8c2cd2..9c9ec9d 100644
--- a/libxrdp/xrdp_orders.c
+++ b/libxrdp/xrdp_orders.c
@@ -14,7 +14,7 @@
    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
 
    xrdp: A Remote Desktop Protocol server.
-   Copyright (C) Jay Sorg 2004-2007
+   Copyright (C) Jay Sorg 2004-2008
 
    orders
 
@@ -173,7 +173,7 @@ xrdp_orders_check(struct xrdp_orders* self, int max_size)
       return 0;
     }
   }
-  size = self->out_s->p - self->order_count_ptr;
+  size = (int)(self->out_s->p - self->order_count_ptr);
   if ((size < 0) || (size > max_packet_size))
   {
     return 1;
@@ -196,10 +196,10 @@ xrdp_orders_last_bounds(struct xrdp_orders* self, struct xrdp_rect* rect)
   {
     return 0;
   }
-  if (rect->left == self->orders_state.clip_left &&
-      rect->top == self->orders_state.clip_top &&
-      rect->right == self->orders_state.clip_right &&
-      rect->bottom == self->orders_state.clip_bottom)
+  if ((rect->left == self->orders_state.clip_left) &&
+      (rect->top == self->orders_state.clip_top) &&
+      (rect->right == self->orders_state.clip_right) &&
+      (rect->bottom == self->orders_state.clip_bottom))
   {
     return 1;
   }
@@ -330,6 +330,55 @@ xrdp_orders_out_bounds(struct xrdp_orders* self, struct xrdp_rect* rect)
 
 /*****************************************************************************/
 /* returns error */
+static int APP_CC
+xrdp_order_pack_small_or_tiny(struct xrdp_orders* self,
+                              char* order_flags_ptr, int orders_flags,
+                              char* present_ptr, int present,
+                              int present_size)
+{
+  int move_up_count;
+  int index;
+  int size;
+  int keep_looking;
+
+  move_up_count = 0;
+  keep_looking = 1;
+  for (index = present_size - 1; index >= 0; index--)
+  {
+    if (keep_looking)
+    {
+      if (((present >> (index * 8)) & 0xff) == 0)
+      {
+        move_up_count++;
+      }
+      else
+      {
+        keep_looking = 0;
+      }
+    }
+    present_ptr[index] = present >> (index * 8);
+  }
+  if (move_up_count > 0)
+  {
+    /* move_up_count should be 0, 1, 2, or 3
+       shifting it 6 will make it RDP_ORDER_TINY(0x80) or
+       RDP_ORDER_SMALL(0x40) or both */
+    orders_flags |= move_up_count << 6;
+    size = (int)(self->out_s->p - present_ptr);
+    size -= present_size;
+    for (index = 0; index < size; index++)
+    {
+      present_ptr[index + (present_size - move_up_count)] =
+        present_ptr[index + present_size];
+    }
+    self->out_s->p -= move_up_count;
+  }
+  order_flags_ptr[0] = orders_flags;
+  return 0;
+}
+
+/*****************************************************************************/
+/* returns error */
 /* send a solid rect to client */
 /* max size 23 */
 int APP_CC
@@ -340,6 +389,7 @@ xrdp_orders_rect(struct xrdp_orders* self, int x, int y, int cx, int cy,
   int vals[8];
   int present;
   char* present_ptr;
+  char* order_flags_ptr;
 
   xrdp_orders_check(self, 23);
   self->order_count++;
@@ -374,14 +424,17 @@ xrdp_orders_rect(struct xrdp_orders* self, int x, int y, int cx, int cy,
   {
     order_flags |= RDP_ORDER_DELTA;
   }
-  out_uint8(self->out_s, order_flags)
+  /* order_flags, set later, 1 byte */
+  order_flags_ptr = self->out_s->p;
+  out_uint8s(self->out_s, 1);
   if (order_flags & RDP_ORDER_CHANGE)
   {
     out_uint8(self->out_s, self->orders_state.last_order);
   }
   present = 0;
-  present_ptr = self->out_s->p; /* hold 1 byte present pointer */
-  out_uint8s(self->out_s, 1)
+  /* present, set later, 1 byte */
+  present_ptr = self->out_s->p;
+  out_uint8s(self->out_s, 1);
   if ((order_flags & RDP_ORDER_BOUNDS) &&
       !(order_flags & RDP_ORDER_LASTBOUNDS))
   {
@@ -460,7 +513,8 @@ xrdp_orders_rect(struct xrdp_orders* self, int x, int y, int cx, int cy,
                  (self->orders_state.rect_color & 0x00ffff) | (color & 0xff0000);
     out_uint8(self->out_s, color >> 16);
   }
-  present_ptr[0] = present;
+  xrdp_order_pack_small_or_tiny(self, order_flags_ptr, order_flags,
+                                present_ptr, present, 1);
   return 0;
 }
 
@@ -477,6 +531,7 @@ xrdp_orders_screen_blt(struct xrdp_orders* self, int x, int y,
   int vals[12];
   int present;
   char* present_ptr;
+  char* order_flags_ptr;
 
   xrdp_orders_check(self, 25);
   self->order_count++;
@@ -515,14 +570,17 @@ xrdp_orders_screen_blt(struct xrdp_orders* self, int x, int y,
   {
     order_flags |= RDP_ORDER_DELTA;
   }
-  out_uint8(self->out_s, order_flags);
+  /* order_flags, set later, 1 byte */
+  order_flags_ptr = self->out_s->p;
+  out_uint8s(self->out_s, 1);
   if (order_flags & RDP_ORDER_CHANGE)
   {
     out_uint8(self->out_s, self->orders_state.last_order);
   }
   present = 0;
-  present_ptr = self->out_s->p; /* hold 1 byte present pointer */
-  out_uint8s(self->out_s, 1)
+  /* present, set later, 1 byte */
+  present_ptr = self->out_s->p;
+  out_uint8s(self->out_s, 1);
   if ((order_flags & RDP_ORDER_BOUNDS) &&
       !(order_flags & RDP_ORDER_LASTBOUNDS))
   {
@@ -612,7 +670,8 @@ xrdp_orders_screen_blt(struct xrdp_orders* self, int x, int y,
     }
     self->orders_state.scr_blt_srcy = srcy;
   }
-  present_ptr[0] = present;
+  xrdp_order_pack_small_or_tiny(self, order_flags_ptr, order_flags,
+                                present_ptr, present, 1);
   return 0;
 }
 
@@ -627,9 +686,10 @@ xrdp_orders_pat_blt(struct xrdp_orders* self, int x, int y,
                     struct xrdp_rect* rect)
 {
   int order_flags;
-  int vals[8];
   int present;
+  int vals[8];
   char* present_ptr;
+  char* order_flags_ptr;
   struct xrdp_brush blank_brush;
 
   xrdp_orders_check(self, 39);
@@ -665,15 +725,17 @@ xrdp_orders_pat_blt(struct xrdp_orders* self, int x, int y,
   {
     order_flags |= RDP_ORDER_DELTA;
   }
-  out_uint8(self->out_s, order_flags);
+  /* order_flags, set later, 1 byte */
+  order_flags_ptr = self->out_s->p;
+  out_uint8s(self->out_s, 1);
   if (order_flags & RDP_ORDER_CHANGE)
   {
     out_uint8(self->out_s, self->orders_state.last_order);
   }
   present = 0;
-  present_ptr = self->out_s->p; /* hold 2 byte present pointer, todo */
-  out_uint8s(self->out_s, 2)    /* this can be smaller, */
-                                /* see RDP_ORDER_SMALL and RDP_ORDER_TINY */
+  /* present, set later, 2 bytes */
+  present_ptr = self->out_s->p;
+  out_uint8s(self->out_s, 2);
   if ((order_flags & RDP_ORDER_BOUNDS) &&
       !(order_flags & RDP_ORDER_LASTBOUNDS))
   {
@@ -791,8 +853,8 @@ xrdp_orders_pat_blt(struct xrdp_orders* self, int x, int y,
     g_memcpy(self->orders_state.pat_blt_brush.pattern + 1,
              brush->pattern + 1, 7);
   }
-  present_ptr[0] = present;
-  present_ptr[1] = present >> 8;
+  xrdp_order_pack_small_or_tiny(self, order_flags_ptr, order_flags,
+                                present_ptr, present, 2);
   return 0;
 }
 
@@ -809,6 +871,7 @@ xrdp_orders_dest_blt(struct xrdp_orders* self, int x, int y,
   int vals[8];
   int present;
   char* present_ptr;
+  char* order_flags_ptr;
 
   xrdp_orders_check(self, 21);
   self->order_count++;
@@ -843,14 +906,17 @@ xrdp_orders_dest_blt(struct xrdp_orders* self, int x, int y,
   {
     order_flags |= RDP_ORDER_DELTA;
   }
-  out_uint8(self->out_s, order_flags);
+  /* order_flags, set later, 1 byte */
+  order_flags_ptr = self->out_s->p;
+  out_uint8s(self->out_s, 1);
   if (order_flags & RDP_ORDER_CHANGE)
   {
     out_uint8(self->out_s, self->orders_state.last_order)
   }
   present = 0;
-  present_ptr = self->out_s->p; /* hold 1 byte present pointer */
-  out_uint8s(self->out_s, 1)
+  /* present, set later, 1 byte */
+  present_ptr = self->out_s->p;
+  out_uint8s(self->out_s, 1);
   if ((order_flags & RDP_ORDER_BOUNDS) &&
       !(order_flags & RDP_ORDER_LASTBOUNDS))
   {
@@ -914,7 +980,8 @@ xrdp_orders_dest_blt(struct xrdp_orders* self, int x, int y,
     out_uint8(self->out_s, rop);
     self->orders_state.dest_blt_rop = rop;
   }
-  present_ptr[0] = present;
+  xrdp_order_pack_small_or_tiny(self, order_flags_ptr, order_flags,
+                                present_ptr, present, 1);
   return 0;
 }
 
@@ -933,8 +1000,19 @@ xrdp_orders_line(struct xrdp_orders* self, int mix_mode,
   int vals[8];
   int present;
   char* present_ptr;
+  char* order_flags_ptr;
   struct xrdp_pen blank_pen;
 
+  /* if mix mode or rop are out of range, mstsc build 6000+ will parse the orders
+     wrong */
+  if ((mix_mode < 1) || (mix_mode > 2)) /* TRANSPARENT(1) or OPAQUE(2) */
+  {
+    mix_mode = 1;
+  }
+  if ((rop < 1) || (rop > 0x10))
+  {
+    rop = 0x0d; /* R2_COPYPEN */
+  }
   xrdp_orders_check(self, 32);
   self->order_count++;
   order_flags = RDP_ORDER_STANDARD;
@@ -970,14 +1048,17 @@ xrdp_orders_line(struct xrdp_orders* self, int mix_mode,
   {
     order_flags |= RDP_ORDER_DELTA;
   }
-  out_uint8(self->out_s, order_flags);
+  /* order_flags, set later, 1 byte */
+  order_flags_ptr = self->out_s->p;
+  out_uint8s(self->out_s, 1);
   if (order_flags & RDP_ORDER_CHANGE)
   {
     out_uint8(self->out_s, self->orders_state.last_order);
   }
   present = 0;
-  present_ptr = self->out_s->p; /* hold 2 byte present pointer */
-  out_uint8s(self->out_s, 2)
+  /* present, set later, 2 bytes */
+  present_ptr = self->out_s->p;
+  out_uint8s(self->out_s, 2);
   if ((order_flags & RDP_ORDER_BOUNDS) &&
       !(order_flags & RDP_ORDER_LASTBOUNDS))
   {
@@ -1080,8 +1161,8 @@ xrdp_orders_line(struct xrdp_orders* self, int mix_mode,
     out_uint8(self->out_s, pen->color >> 16)
     self->orders_state.line_pen.color = pen->color;
   }
-  present_ptr[0] = present;
-  present_ptr[1] = present >> 8;
+  xrdp_order_pack_small_or_tiny(self, order_flags_ptr, order_flags,
+                                present_ptr, present, 2);
   return 0;
 }
 
@@ -1099,6 +1180,7 @@ xrdp_orders_mem_blt(struct xrdp_orders* self, int cache_id,
   int vals[12];
   int present;
   char* present_ptr;
+  char* order_flags_ptr;
 
   xrdp_orders_check(self, 30);
   self->order_count++;
@@ -1137,15 +1219,17 @@ xrdp_orders_mem_blt(struct xrdp_orders* self, int cache_id,
   {
     order_flags |= RDP_ORDER_DELTA;
   }
-  out_uint8(self->out_s, order_flags);
+  /* order_flags, set later, 1 byte */
+  order_flags_ptr = self->out_s->p;
+  out_uint8s(self->out_s, 1);
   if (order_flags & RDP_ORDER_CHANGE)
   {
     out_uint8(self->out_s, self->orders_state.last_order)
   }
   present = 0;
-  present_ptr = self->out_s->p; /* hold 2 byte present pointer, todo */
-  out_uint8s(self->out_s, 2)    /* this can be smaller, */
-                                /* see RDP_ORDER_SMALL and RDP_ORDER_TINY */
+  /* present, set later, 2 bytes */
+  present_ptr = self->out_s->p;
+  out_uint8s(self->out_s, 2);
   if ((order_flags & RDP_ORDER_BOUNDS) &&
       !(order_flags & RDP_ORDER_LASTBOUNDS))
   {
@@ -1250,8 +1334,8 @@ xrdp_orders_mem_blt(struct xrdp_orders* self, int cache_id,
     out_uint16_le(self->out_s, cache_idx);
     self->orders_state.mem_blt_cache_idx = cache_idx;
   }
-  present_ptr[0] = present;
-  present_ptr[1] = present >> 8;
+  xrdp_order_pack_small_or_tiny(self, order_flags_ptr, order_flags,
+                                present_ptr, present, 2);
   return 0;
 }
 
@@ -1271,6 +1355,7 @@ xrdp_orders_text(struct xrdp_orders* self,
   int order_flags;
   int present;
   char* present_ptr;
+  char* order_flags_ptr;
 
   xrdp_orders_check(self, 100);
   self->order_count++;
@@ -1300,15 +1385,17 @@ xrdp_orders_text(struct xrdp_orders* self,
       }
     }
   }
-  out_uint8(self->out_s, order_flags);
+  /* order_flags, set later, 1 byte */
+  order_flags_ptr = self->out_s->p;
+  out_uint8s(self->out_s, 1);
   if (order_flags & RDP_ORDER_CHANGE)
   {
     out_uint8(self->out_s, self->orders_state.last_order);
   }
   present = 0;
-  present_ptr = self->out_s->p; /* hold 3 byte present pointer, todo */
-  out_uint8s(self->out_s, 3)    /* this can be smaller, */
-                                /* see RDP_ORDER_SMALL and RDP_ORDER_TINY */
+  /* present, set later, 3 bytes */
+  present_ptr = self->out_s->p;
+  out_uint8s(self->out_s, 3);
   if ((order_flags & RDP_ORDER_BOUNDS) &&
       !(order_flags & RDP_ORDER_LASTBOUNDS))
   {
@@ -1415,10 +1502,8 @@ xrdp_orders_text(struct xrdp_orders* self,
     out_uint8(self->out_s, data_len);
     out_uint8a(self->out_s, data, data_len);
   }
-  /* send 3 byte present */
-  present_ptr[0] = present;
-  present_ptr[1] = present >> 8;
-  present_ptr[2] = present >> 16;
+  xrdp_order_pack_small_or_tiny(self, order_flags_ptr, order_flags,
+                                present_ptr, present, 3);
   return 0;
 }
 
@@ -1583,7 +1668,7 @@ xrdp_orders_send_bitmap(struct xrdp_orders* self,
 height(%d)", lines_sending, height);
     return 1;
   }
-  bufsize = s->p - p;
+  bufsize = (int)(s->p - p);
   Bpp = (bpp + 7) / 8;
   xrdp_orders_check(self, bufsize + 16);
   self->order_count++;
@@ -1787,7 +1872,7 @@ xrdp_orders_send_bitmap2(struct xrdp_orders* self,
 height(%d)", lines_sending, height);
     return 1;
   }
-  bufsize = s->p - p;
+  bufsize = (int)(s->p - p);
   Bpp = (bpp + 7) / 8;
   xrdp_orders_check(self, bufsize + 14);
   self->order_count++;
@@ -1811,3 +1896,31 @@ height(%d)", lines_sending, height);
   free_stream(temp_s);
   return 0;
 }
+
+/*****************************************************************************/
+/* returns error */
+/* send a brush cache entry */
+int APP_CC
+xrdp_orders_send_brush(struct xrdp_orders* self, int width, int height,
+                       int bpp, int type, int size, char* data, int cache_id)
+{
+  int order_flags;
+  int len;
+
+  xrdp_orders_check(self, size + 12);
+  self->order_count++;
+  order_flags = RDP_ORDER_STANDARD | RDP_ORDER_SECONDARY;
+  out_uint8(self->out_s, order_flags);
+  len = (size + 6) - 7; /* length after type minus 7 */
+  out_uint16_le(self->out_s, len);
+  out_uint16_le(self->out_s, 0); /* flags */
+  out_uint8(self->out_s, RDP_ORDER_BRUSHCACHE); /* type */
+  out_uint8(self->out_s, cache_id);
+  out_uint8(self->out_s, bpp);
+  out_uint8(self->out_s, width);
+  out_uint8(self->out_s, height);
+  out_uint8(self->out_s, type);
+  out_uint8(self->out_s, size);
+  out_uint8a(self->out_s, data, size);
+  return 0;
+}
diff --git a/libxrdp/xrdp_rdp.c b/libxrdp/xrdp_rdp.c
index 2010b1e..bb9a6fc 100644
--- a/libxrdp/xrdp_rdp.c
+++ b/libxrdp/xrdp_rdp.c
@@ -14,7 +14,7 @@
    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
 
    xrdp: A Remote Desktop Protocol server.
-   Copyright (C) Jay Sorg 2004-2007
+   Copyright (C) Jay Sorg 2004-2008
 
    rdp layer
 
@@ -22,7 +22,8 @@
 
 #include "libxrdp.h"
 
-static char g_unknown1[172] =
+/* some compilers need unsigned char to avoid warnings */
+static tui8 g_unknown1[172] =
 { 0xff, 0x02, 0xb6, 0x00, 0x28, 0x00, 0x00, 0x00,
   0x27, 0x00, 0x27, 0x00, 0x03, 0x00, 0x04, 0x00,
   0x00, 0x00, 0x26, 0x00, 0x01, 0x00, 0x1e, 0x00,
@@ -46,8 +47,9 @@ static char g_unknown1[172] =
   0x29, 0x00, 0x01, 0x00, 0x2a, 0x00, 0x05, 0x00,
   0x2b, 0x00, 0x2a, 0x00 };
 
+/* some compilers need unsigned char to avoid warnings */
 /*
-static char g_unknown2[8] =
+static tui8 g_unknown2[8] =
 { 0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0x04, 0x00 };
 */
 
@@ -55,70 +57,64 @@ static char g_unknown2[8] =
 static int APP_CC
 xrdp_rdp_read_config(struct xrdp_client_info* client_info)
 {
-  int fd;
   int index;
   struct list* items;
   struct list* values;
   char* item;
   char* value;
 
-  fd = g_file_open(XRDP_CFG_FILE); /* xrdp.ini */
-  if (fd > 0)
+  items = list_create();
+  items->auto_free = 1;
+  values = list_create();
+  values->auto_free = 1;
+  file_by_name_read_section(XRDP_CFG_FILE, "globals", items, values);
+  for (index = 0; index < items->count; index++)
   {
-    items = list_create();
-    items->auto_free = 1;
-    values = list_create();
-    values->auto_free = 1;
-    file_read_section(fd, "globals", items, values);
-    for (index = 0; index < items->count; index++)
+    item = (char*)list_get_item(items, index);
+    value = (char*)list_get_item(values, index);
+    if (g_strcasecmp(item, "bitmap_cache") == 0)
     {
-      item = (char*)list_get_item(items, index);
-      value = (char*)list_get_item(values, index);
-      if (g_strncasecmp(item, "bitmap_cache", 255) == 0)
+      if ((g_strcasecmp(value, "yes") == 0) ||
+          (g_strcasecmp(value, "true") == 0) ||
+          (g_strcasecmp(value, "1") == 0))
       {
-        if (g_strncasecmp(value, "yes", 255) == 0 ||
-            g_strncasecmp(value, "true", 255) == 0 ||
-            g_strncasecmp(value, "1", 255) == 0)
-        {
-          client_info->use_bitmap_cache = 1;
-        }
+        client_info->use_bitmap_cache = 1;
       }
-      else if (g_strncasecmp(item, "bitmap_compression", 255) == 0)
+    }
+    else if (g_strcasecmp(item, "bitmap_compression") == 0)
+    {
+      if (g_strcasecmp(value, "yes") == 0 ||
+          g_strcasecmp(value, "true") == 0 ||
+          g_strcasecmp(value, "1") == 0)
       {
-        if (g_strncasecmp(value, "yes", 255) == 0 ||
-            g_strncasecmp(value, "true", 255) == 0 ||
-            g_strncasecmp(value, "1", 255) == 0)
-        {
-          client_info->use_bitmap_comp = 1;
-        }
+        client_info->use_bitmap_comp = 1;
       }
-      else if (g_strncasecmp(item, "crypt_level", 255) == 0)
+    }
+    else if (g_strcasecmp(item, "crypt_level") == 0)
+    {
+      if (g_strcasecmp(value, "low") == 0)
       {
-        if (g_strncasecmp(value, "low", 255) == 0)
-        {
-          client_info->crypt_level = 1;
-        }
-        else if (g_strncasecmp(value, "medium", 255) == 0)
-        {
-          client_info->crypt_level = 2;
-        }
-        else if (g_strncasecmp(value, "high", 255) == 0)
-        {
-          client_info->crypt_level = 3;
-        }
+        client_info->crypt_level = 1;
       }
-      else if (g_strcasecmp(item, "channel_code") == 0)
+      else if (g_strcasecmp(value, "medium") == 0)
       {
-        if (g_strcasecmp(value, "1") == 0)
-        {
-          client_info->channel_code = 1;
-        }
+        client_info->crypt_level = 2;
+      }
+      else if (g_strcasecmp(value, "high") == 0)
+      {
+        client_info->crypt_level = 3;
+      }
+    }
+    else if (g_strcasecmp(item, "channel_code") == 0)
+    {
+      if (g_strcasecmp(value, "1") == 0)
+      {
+        client_info->channel_code = 1;
       }
     }
-    list_delete(items);
-    list_delete(values);
-    g_file_close(fd);
   }
+  list_delete(items);
+  list_delete(values);
   return 0;
 }
 
@@ -396,6 +392,11 @@ int APP_CC
 xrdp_rdp_send_demand_active(struct xrdp_rdp* self)
 {
   struct stream* s;
+  int caps_count;
+  int caps_size;
+  char* caps_count_ptr;
+  char* caps_size_ptr;
+  char* caps_ptr;
 
   make_stream(s);
   init_stream(s, 8192);
@@ -405,20 +406,27 @@ xrdp_rdp_send_demand_active(struct xrdp_rdp* self)
     return 1;
   }
 
+  caps_count = 0;
   out_uint32_le(s, self->share_id);
-
   out_uint16_le(s, 4); /* 4 chars for RDP\0 */
-  out_uint16_le(s, 0x0106); /* size after num caps */
+  /* 2 bytes size after num caps, set later */
+  caps_size_ptr = s->p;
+  out_uint8s(s, 2);
   out_uint8a(s, "RDP", 4);
-  out_uint32_le(s, 8); /* num caps 8 */
+  /* 4 byte num caps, set later */
+  caps_count_ptr = s->p;
+  out_uint8s(s, 4);
+  caps_ptr = s->p;
 
   /* Output share capability set */
+  caps_count++;
   out_uint16_le(s, RDP_CAPSET_SHARE);
   out_uint16_le(s, RDP_CAPLEN_SHARE);
   out_uint16_le(s, self->mcs_channel);
   out_uint16_be(s, 0xb5e2); /* 0x73e1 */
 
   /* Output general capability set */
+  caps_count++;
   out_uint16_le(s, RDP_CAPSET_GENERAL); /* 1 */
   out_uint16_le(s, RDP_CAPLEN_GENERAL); /* 24(0x18) */
   out_uint16_le(s, 1); /* OS major type */
@@ -433,6 +441,7 @@ xrdp_rdp_send_demand_active(struct xrdp_rdp* self)
   out_uint16_le(s, 0); /* Pad */
 
   /* Output bitmap capability set */
+  caps_count++;
   out_uint16_le(s, RDP_CAPSET_BITMAP); /* 2 */
   out_uint16_le(s, RDP_CAPLEN_BITMAP); /* 28(0x1c) */
   out_uint16_le(s, self->client_info.bpp); /* Preferred BPP */
@@ -448,11 +457,13 @@ xrdp_rdp_send_demand_active(struct xrdp_rdp* self)
   out_uint16_le(s, 0); /* unknown */
   out_uint16_le(s, 0); /* pad */
 
-  /* Output ? */
-  out_uint16_le(s, 14);
-  out_uint16_le(s, 4);
+  /* Output font capability set */
+  caps_count++;
+  out_uint16_le(s, RDP_CAPSET_FONT); /* 14 */
+  out_uint16_le(s, RDP_CAPLEN_FONT); /* 4 */
 
   /* Output order capability set */
+  caps_count++;
   out_uint16_le(s, RDP_CAPSET_ORDER); /* 3 */
   out_uint16_le(s, RDP_CAPLEN_ORDER); /* 88(0x58) */
   out_uint8s(s, 16);
@@ -467,35 +478,35 @@ xrdp_rdp_send_demand_active(struct xrdp_rdp* self)
   out_uint8(s, 1); /* dest blt */
   out_uint8(s, 1); /* pat blt */
   out_uint8(s, 1); /* screen blt */
-  out_uint8(s, 1); /* memblt */
-  out_uint8(s, 1);
-  out_uint8(s, 1);
-  out_uint8(s, 1);
-  out_uint8(s, 1);
-  out_uint8(s, 1);
-  out_uint8(s, 1);
-  out_uint8(s, 1);
-  out_uint8(s, 1);
-  out_uint8(s, 1);
-  out_uint8(s, 0);
-  out_uint8(s, 0);
-  out_uint8(s, 1);
-  out_uint8(s, 1);
-  out_uint8(s, 1);
-  out_uint8(s, 1);
-  out_uint8(s, 1);
-  out_uint8(s, 1);
-  out_uint8(s, 1);
-  out_uint8(s, 1);
-  out_uint8(s, 1);
-  out_uint8(s, 1);
-  out_uint8(s, 1);
-  out_uint8(s, 1);
-  out_uint8(s, 1);
-  out_uint8(s, 1);
-  out_uint8(s, 0);
-  out_uint8(s, 0);
-  out_uint8(s, 0);
+  out_uint8(s, 1); /* mem blt */
+  out_uint8(s, 0); /* tri blt */
+  out_uint8(s, 0); /* unused */
+  out_uint8(s, 0); /* unused */
+  out_uint8(s, 0); /* nine grid */
+  out_uint8(s, 1); /* line to */
+  out_uint8(s, 0); /* multi nine grid */
+  out_uint8(s, 1); /* rect */
+  out_uint8(s, 0); /* desk save */
+  out_uint8(s, 0); /* unused */
+  out_uint8(s, 0); /* unused */
+  out_uint8(s, 0); /* unused */
+  out_uint8(s, 0); /* multi dest blt */
+  out_uint8(s, 0); /* multi pat blt */
+  out_uint8(s, 0); /* multi screen blt */
+  out_uint8(s, 0); /* multi rect */
+  out_uint8(s, 0); /* fast index */
+  out_uint8(s, 0); /* polygon */
+  out_uint8(s, 0); /* polygon */
+  out_uint8(s, 0); /* polyline */
+  out_uint8(s, 0); /* unused */
+  out_uint8(s, 0); /* fast glyph */
+  out_uint8(s, 0); /* ellipse */
+  out_uint8(s, 0); /* ellipse */
+  out_uint8(s, 0); /* ? */
+  out_uint8(s, 0); /* unused */
+  out_uint8(s, 0); /* unused */
+  out_uint8(s, 0); /* unused */
+  out_uint8(s, 0); /* unused */
   out_uint16_le(s, 0x6a1);
   out_uint8s(s, 2); /* ? */
   out_uint32_le(s, 0x0f4240); /* desk save */
@@ -504,26 +515,40 @@ xrdp_rdp_send_demand_active(struct xrdp_rdp* self)
   out_uint32_le(s, 0); /* ? */
 
   /* Output color cache capability set */
+  caps_count++;
   out_uint16_le(s, RDP_CAPSET_COLCACHE);
   out_uint16_le(s, RDP_CAPLEN_COLCACHE);
   out_uint16_le(s, 6); /* cache size */
   out_uint16_le(s, 0); /* pad */
 
   /* Output pointer capability set */
+  caps_count++;
   out_uint16_le(s, RDP_CAPSET_POINTER);
   out_uint16_le(s, RDP_CAPLEN_POINTER);
   out_uint16_le(s, 1); /* Colour pointer */
   out_uint16_le(s, 0x19); /* Cache size */
   out_uint16_le(s, 0x19); /* Cache size */
 
-  /* Output ? */
-  out_uint16_le(s, 0xd);
-  out_uint16_le(s, 0x58); /* 88 */
+  /* Output input capability set */
+  caps_count++;
+  out_uint16_le(s, RDP_CAPSET_INPUT); /* 13(0xd) */
+  out_uint16_le(s, RDP_CAPLEN_INPUT); /* 88(0x58) */
   out_uint8(s, 1);
   out_uint8s(s, 83);
 
+  out_uint8s(s, 4); /* pad */
+
   s_mark_end(s);
 
+  caps_size = (int)(s->end - caps_ptr);
+  caps_size_ptr[0] = caps_size;
+  caps_size_ptr[1] = caps_size >> 8;
+
+  caps_count_ptr[0] = caps_count;
+  caps_count_ptr[1] = caps_count >> 8;
+  caps_count_ptr[2] = caps_count >> 16;
+  caps_count_ptr[3] = caps_count >> 24;
+
   if (xrdp_rdp_send(self, s, RDP_PDU_DEMAND_ACTIVE) != 0)
   {
     free_stream(s);
@@ -671,6 +696,19 @@ xrdp_process_capset_pointercache(struct xrdp_rdp* self, struct stream* s,
 }
 
 /*****************************************************************************/
+/* get the type of client brush cache */
+static int APP_CC
+xrdp_process_capset_brushcache(struct xrdp_rdp* self, struct stream* s,
+                               int len)
+{
+  int code;
+
+  in_uint32_le(s, code);
+  self->client_info.brush_cache_code = code;
+  return 0;
+}
+
+/*****************************************************************************/
 int APP_CC
 xrdp_rdp_process_confirm_active(struct xrdp_rdp* self, struct stream* s)
 {
@@ -737,8 +775,8 @@ xrdp_rdp_process_confirm_active(struct xrdp_rdp* self, struct stream* s)
       case 14: /* 14 */
         DEBUG(("--14"));
         break;
-      case 15: /* 15 */
-        DEBUG(("--15"));
+      case RDP_CAPSET_BRUSHCACHE: /* 15 */
+        xrdp_process_capset_brushcache(self, s, len);
         break;
       case 16: /* 16 */
         DEBUG(("--16"));
@@ -756,6 +794,12 @@ xrdp_rdp_process_confirm_active(struct xrdp_rdp* self, struct stream* s)
       case 21: /* 21 */
         DEBUG(("--21"));
         break;
+      case 22: /* 22 */
+        DEBUG(("--22"));
+        break;
+      case 26: /* 26 */
+        DEBUG(("--26"));
+        break;
       default:
         g_writeln("unknown in xrdp_rdp_process_confirm_active %d", type);
         break;
diff --git a/libxrdp/xrdp_sec.c b/libxrdp/xrdp_sec.c
index 454473b..19fc4ab 100644
--- a/libxrdp/xrdp_sec.c
+++ b/libxrdp/xrdp_sec.c
@@ -14,7 +14,7 @@
    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
 
    xrdp: A Remote Desktop Protocol server.
-   Copyright (C) Jay Sorg 2004-2007
+   Copyright (C) Jay Sorg 2004-2008
 
    secure layer
 
@@ -22,17 +22,20 @@
 
 #include "libxrdp.h"
 
-static char g_pad_54[40] =
+/* some compilers need unsigned char to avoid warnings */
+static tui8 g_pad_54[40] =
 { 54, 54, 54, 54, 54, 54, 54, 54, 54, 54, 54, 54, 54, 54, 54, 54,
   54, 54, 54, 54, 54, 54, 54, 54, 54, 54, 54, 54, 54, 54, 54, 54,
   54, 54, 54, 54, 54, 54, 54, 54 };
 
-static char g_pad_92[48] =
+/* some compilers need unsigned char to avoid warnings */
+static tui8 g_pad_92[48] =
 { 92, 92, 92, 92, 92, 92, 92, 92, 92, 92, 92, 92, 92, 92, 92, 92,
   92, 92, 92, 92, 92, 92, 92, 92, 92, 92, 92, 92, 92, 92, 92, 92,
   92, 92, 92, 92, 92, 92, 92, 92, 92, 92, 92, 92, 92, 92, 92, 92 };
 
-static char g_lic1[322] =
+/* some compilers need unsigned char to avoid warnings */
+static tui8 g_lic1[322] =
 { 0x80, 0x00, 0x3e, 0x01, 0x01, 0x02, 0x3e, 0x01,
   0x7b, 0x3c, 0x31, 0xa6, 0xae, 0xe8, 0x74, 0xf6,
   0xb4, 0xa5, 0x03, 0x90, 0xe7, 0xc2, 0xc7, 0x39,
@@ -75,82 +78,27 @@ static char g_lic1[322] =
   0x6f, 0x73, 0x6f, 0x66, 0x74, 0x2e, 0x63, 0x6f,
   0x6d, 0x00 };
 
-static char g_lic2[20] =
+/* some compilers need unsigned char to avoid warnings */
+static tui8 g_lic2[20] =
 { 0x80, 0x00, 0x10, 0x00, 0xff, 0x02, 0x10, 0x00,
   0x07, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00,
   0x28, 0x14, 0x00, 0x00 };
 
 /* mce */
-static char g_lic3[20] =
+/* some compilers need unsigned char to avoid warnings */
+static tui8 g_lic3[20] =
 { 0x80, 0x02, 0x10, 0x00, 0xff, 0x03, 0x10, 0x00,
   0x07, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00,
   0xf3, 0x99, 0x00, 0x00 };
 
 /*****************************************************************************/
 static void APP_CC
-hex_to_bin(char* in, char* out)
-{
-  int val;
-
-  val = 0;
-  switch (in[0])
-  {
-    case '1': val = 16; break;
-    case '2': val = 16 * 2; break;
-    case '3': val = 16 * 3; break;
-    case '4': val = 16 * 4; break;
-    case '5': val = 16 * 5; break;
-    case '6': val = 16 * 6; break;
-    case '7': val = 16 * 7; break;
-    case '8': val = 16 * 8; break;
-    case '9': val = 16 * 9; break;
-    case 'a': val = 16 * 10; break;
-    case 'A': val = 16 * 10; break;
-    case 'b': val = 16 * 11; break;
-    case 'B': val = 16 * 11; break;
-    case 'c': val = 16 * 12; break;
-    case 'C': val = 16 * 12; break;
-    case 'd': val = 16 * 13; break;
-    case 'D': val = 16 * 13; break;
-    case 'e': val = 16 * 14; break;
-    case 'E': val = 16 * 14; break;
-    case 'f': val = 16 * 15; break;
-    case 'F': val = 16 * 15; break;
-  }
-  switch (in[1])
-  {
-    case '1': val += 1; break;
-    case '2': val += 2; break;
-    case '3': val += 3; break;
-    case '4': val += 4; break;
-    case '5': val += 5; break;
-    case '6': val += 6; break;
-    case '7': val += 7; break;
-    case '8': val += 8; break;
-    case '9': val += 9; break;
-    case 'a': val += 10; break;
-    case 'A': val += 10; break;
-    case 'b': val += 11; break;
-    case 'B': val += 11; break;
-    case 'c': val += 12; break;
-    case 'C': val += 12; break;
-    case 'd': val += 13; break;
-    case 'D': val += 13; break;
-    case 'e': val += 14; break;
-    case 'E': val += 14; break;
-    case 'f': val += 15; break;
-    case 'F': val += 15; break;
-  }
-  *out = val;
-}
-
-/*****************************************************************************/
-static void APP_CC
 hex_str_to_bin(char* in, char* out, int out_len)
 {
   int in_index;
   int in_len;
   int out_index;
+  int val;
   char hex[16];
 
   in_len = g_strlen(in);
@@ -158,14 +106,15 @@ hex_str_to_bin(char* in, char* out, int out_len)
   in_index = 0;
   while (in_index <= (in_len - 4))
   {
-    if (in[in_index] == '0' && in[in_index + 1] == 'x')
+    if ((in[in_index] == '0') && (in[in_index + 1] == 'x'))
     {
       hex[0] = in[in_index + 2];
       hex[1] = in[in_index + 3];
       hex[2] = 0;
       if (out_index < out_len)
       {
-        hex_to_bin(hex, out + out_index);
+        val = g_htoi(hex);
+        out[out_index] = val;
       }
       out_index++;
     }
@@ -179,12 +128,6 @@ xrdp_sec_create(struct xrdp_rdp* owner, int sck, int crypt_level,
                 int channel_code)
 {
   struct xrdp_sec* self;
-  struct list* items;
-  struct list* values;
-  int fd;
-  int index;
-  char* item;
-  char* value;
 
   DEBUG((" in xrdp_sec_create"));
   self = (struct xrdp_sec*)g_malloc(sizeof(struct xrdp_sec), 1);
@@ -209,42 +152,8 @@ xrdp_sec_create(struct xrdp_rdp* owner, int sck, int crypt_level,
   self->channel_code = channel_code;
   self->decrypt_rc4_info = ssl_rc4_info_create();
   self->encrypt_rc4_info = ssl_rc4_info_create();
-  g_random(self->server_random, 32);
   self->mcs_layer = xrdp_mcs_create(self, sck, &self->client_mcs_data,
                                     &self->server_mcs_data);
-  fd = g_file_open(XRDP_KEY_FILE); /* rsakeys.ini */
-  if (fd > 0)
-  {
-    items = list_create();
-    items->auto_free = 1;
-    values = list_create();
-    values->auto_free = 1;
-    file_read_section(fd, "keys", items, values);
-    for (index = 0; index < items->count; index++)
-    {
-      item = (char*)list_get_item(items, index);
-      value = (char*)list_get_item(values, index);
-      if (g_strncasecmp(item, "pub_exp", 255) == 0)
-      {
-        hex_str_to_bin(value, self->pub_exp, 4);
-      }
-      else if (g_strncasecmp(item, "pub_mod", 255) == 0)
-      {
-        hex_str_to_bin(value, self->pub_mod, 64);
-      }
-      else if (g_strncasecmp(item, "pub_sig", 255) == 0)
-      {
-        hex_str_to_bin(value, self->pub_sig, 64);
-      }
-      else if (g_strncasecmp(item, "pri_exp", 255) == 0)
-      {
-        hex_str_to_bin(value, self->pri_exp, 64);
-      }
-    }
-    list_delete(items);
-    list_delete(values);
-    g_file_close(fd);
-  }
   self->chan_layer = xrdp_channel_create(self, self->mcs_layer);
   DEBUG((" out xrdp_sec_create"));
   return self;
@@ -313,12 +222,12 @@ xrdp_sec_update(char* key, char* update_key, int key_len)
   rc4_info = ssl_rc4_info_create();
   ssl_sha1_clear(sha1_info);
   ssl_sha1_transform(sha1_info, update_key, key_len);
-  ssl_sha1_transform(sha1_info, g_pad_54, 40);
+  ssl_sha1_transform(sha1_info, (char*)g_pad_54, 40);
   ssl_sha1_transform(sha1_info, key, key_len);
   ssl_sha1_complete(sha1_info, shasig);
   ssl_md5_clear(md5_info);
   ssl_md5_transform(md5_info, update_key, key_len);
-  ssl_md5_transform(md5_info, g_pad_92, 48);
+  ssl_md5_transform(md5_info, (char*)g_pad_92, 48);
   ssl_md5_transform(md5_info, shasig, 20);
   ssl_md5_complete(md5_info, key);
   ssl_rc4_set_key(rc4_info, key, key_len);
@@ -400,14 +309,18 @@ xrdp_sec_process_logon_info(struct xrdp_sec* self, struct stream* s)
   int len_password;
   int len_program;
   int len_directory;
+  int len_ip;
+  int len_dll;
+  int tzone;
+  char tmpdata[256];
 
-  //g_hexdump(s->p, 100);
   in_uint8s(s, 4);
   in_uint32_le(s, flags);
   DEBUG(("in xrdp_sec_process_logon_info flags $%x", flags));
   /* this is the first test that the decrypt is working */
   if ((flags & RDP_LOGON_NORMAL) != RDP_LOGON_NORMAL) /* 0x33 */
   {                                                   /* must be or error */
+    DEBUG(("xrdp_sec_process_logon_info: flags wrong, major error"));
     return 1;
   }
   if (flags & RDP_LOGON_LEAVE_AUDIO)
@@ -450,6 +363,20 @@ xrdp_sec_process_logon_info(struct xrdp_sec* self, struct stream* s)
   DEBUG(("program %s", self->rdp_layer->client_info.program));
   unicode_in(s, len_directory, self->rdp_layer->client_info.directory, 255);
   DEBUG(("directory %s", self->rdp_layer->client_info.directory));
+  if (flags & RDP_LOGON_BLOB)
+  {
+    in_uint8s(s, 2);                                    /* unknown */
+    in_uint16_le(s, len_ip);
+    unicode_in(s, len_ip - 2, tmpdata, 255);
+    in_uint16_le(s, len_dll);
+    unicode_in(s, len_dll - 2, tmpdata, 255);
+    in_uint32_le(s, tzone);                             /* len of timetone */
+    in_uint8s(s, 62);                                   /* skip */
+    in_uint8s(s, 22);                                   /* skip misc. */
+    in_uint8s(s, 62);                                   /* skip */
+    in_uint8s(s, 26);                                   /* skip stuff */
+    in_uint32_le(s, self->rdp_layer->client_info.rdp5_performanceflags);
+  }
   DEBUG(("out xrdp_sec_process_logon_info"));
   return 0;
 }
@@ -638,7 +565,7 @@ xrdp_sec_recv(struct xrdp_sec* self, struct stream* s, int* chan)
   if (flags & SEC_ENCRYPT) /* 0x08 */
   {
     in_uint8s(s, 8); /* signature */
-    xrdp_sec_decrypt(self, s->p, s->end - s->p);
+    xrdp_sec_decrypt(self, s->p, (int)(s->end - s->p));
   }
   if (flags & SEC_CLIENT_RANDOM) /* 0x01 */
   {
@@ -719,13 +646,13 @@ xrdp_sec_sign(struct xrdp_sec* self, char* out, int out_len,
   md5_info = ssl_md5_info_create();
   ssl_sha1_clear(sha1_info);
   ssl_sha1_transform(sha1_info, self->sign_key, self->rc4_key_len);
-  ssl_sha1_transform(sha1_info, g_pad_54, 40);
+  ssl_sha1_transform(sha1_info, (char*)g_pad_54, 40);
   ssl_sha1_transform(sha1_info, lenhdr, 4);
   ssl_sha1_transform(sha1_info, data, data_len);
   ssl_sha1_complete(sha1_info, shasig);
   ssl_md5_clear(md5_info);
   ssl_md5_transform(md5_info, self->sign_key, self->rc4_key_len);
-  ssl_md5_transform(md5_info, g_pad_92, 48);
+  ssl_md5_transform(md5_info, (char*)g_pad_92, 48);
   ssl_md5_transform(md5_info, shasig, 20);
   ssl_md5_complete(md5_info, md5sig);
   g_memcpy(out, md5sig, out_len);
@@ -745,7 +672,7 @@ xrdp_sec_send(struct xrdp_sec* self, struct stream* s, int chan)
   if (self->crypt_level > 1)
   {
     out_uint32_le(s, SEC_ENCRYPT);
-    datalen = (s->end - s->p) - 8;
+    datalen = (int)((s->end - s->p) - 8);
     xrdp_sec_sign(self, s->p, 8, s->p + 8, datalen);
     xrdp_sec_encrypt(self, s->p + 8, datalen);
   }
@@ -852,7 +779,7 @@ xrdp_sec_out_mcs_data(struct xrdp_sec* self)
   int num_channels;
   int index;
   int channel;
-  
+
   num_channels = self->mcs_layer->channel_list->count;
   num_channels_even = num_channels + (num_channels & 1);
   s = &self->server_mcs_data;
@@ -969,7 +896,49 @@ xrdp_sec_in_mcs_data(struct xrdp_sec* self)
 int APP_CC
 xrdp_sec_incoming(struct xrdp_sec* self)
 {
+  struct list* items;
+  struct list* values;
+  int index;
+  char* item;
+  char* value;
+
   DEBUG((" in xrdp_sec_incoming"));
+  g_random(self->server_random, 32);
+  items = list_create();
+  items->auto_free = 1;
+  values = list_create();
+  values->auto_free = 1;
+  if (file_by_name_read_section(XRDP_KEY_FILE, "keys", items, values) != 0)
+  {
+    /* this is a show stopper */
+    g_writeln("xrdp_sec_incoming: error reading %s file", XRDP_KEY_FILE);
+    list_delete(items);
+    list_delete(values);
+    return 1;
+  }
+  for (index = 0; index < items->count; index++)
+  {
+    item = (char*)list_get_item(items, index);
+    value = (char*)list_get_item(values, index);
+    if (g_strcasecmp(item, "pub_exp") == 0)
+    {
+      hex_str_to_bin(value, self->pub_exp, 4);
+    }
+    else if (g_strcasecmp(item, "pub_mod") == 0)
+    {
+      hex_str_to_bin(value, self->pub_mod, 64);
+    }
+    else if (g_strcasecmp(item, "pub_sig") == 0)
+    {
+      hex_str_to_bin(value, self->pub_sig, 64);
+    }
+    else if (g_strcasecmp(item, "pri_exp") == 0)
+    {
+      hex_str_to_bin(value, self->pri_exp, 64);
+    }
+  }
+  list_delete(items);
+  list_delete(values);
   if (xrdp_mcs_incoming(self->mcs_layer) != 0)
   {
     return 1;
@@ -977,10 +946,10 @@ xrdp_sec_incoming(struct xrdp_sec* self)
 #ifdef XRDP_DEBUG
   g_writeln("client mcs data received");
   g_hexdump(self->client_mcs_data.data,
-            self->client_mcs_data.end - self->client_mcs_data.data);
+            (int)(self->client_mcs_data.end - self->client_mcs_data.data));
   g_writeln("server mcs data sent");
   g_hexdump(self->server_mcs_data.data,
-            self->server_mcs_data.end - self->server_mcs_data.data);
+            (int)(self->server_mcs_data.end - self->server_mcs_data.data));
 #endif
   DEBUG((" out xrdp_sec_incoming"));
   xrdp_sec_in_mcs_data(self);
diff --git a/libxrdp/xrdp_tcp.c b/libxrdp/xrdp_tcp.c
index aae9662..a566231 100644
--- a/libxrdp/xrdp_tcp.c
+++ b/libxrdp/xrdp_tcp.c
@@ -14,7 +14,7 @@
    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
 
    xrdp: A Remote Desktop Protocol server.
-   Copyright (C) Jay Sorg 2004-2007
+   Copyright (C) Jay Sorg 2004-2008
 
    tcp layer
 
diff --git a/mc/Makefile b/mc/Makefile
new file mode 100644
index 0000000..e6764d3
--- /dev/null
+++ b/mc/Makefile
@@ -0,0 +1,470 @@
+# Makefile.in generated by automake 1.10.1 from Makefile.am.
+# mc/Makefile.  Generated from Makefile.in by configure.
+
+# Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
+# 2003, 2004, 2005, 2006, 2007, 2008  Free Software Foundation, Inc.
+# This Makefile.in is free software; the Free Software Foundation
+# gives unlimited permission to copy and/or distribute it,
+# with or without modifications, as long as this notice is preserved.
+
+# This program is distributed in the hope that it will be useful,
+# but WITHOUT ANY WARRANTY, to the extent permitted by law; without
+# even the implied warranty of MERCHANTABILITY or FITNESS FOR A
+# PARTICULAR PURPOSE.
+
+
+
+
+pkgdatadir = $(datadir)/xrdp
+pkglibdir = $(libdir)/xrdp
+pkgincludedir = $(includedir)/xrdp
+am__cd = CDPATH="$${ZSH_VERSION+.}$(PATH_SEPARATOR)" && cd
+install_sh_DATA = $(install_sh) -c -m 644
+install_sh_PROGRAM = $(install_sh) -c
+install_sh_SCRIPT = $(install_sh) -c
+INSTALL_HEADER = $(INSTALL_DATA)
+transform = $(program_transform_name)
+NORMAL_INSTALL = :
+PRE_INSTALL = :
+POST_INSTALL = :
+NORMAL_UNINSTALL = :
+PRE_UNINSTALL = :
+POST_UNINSTALL = :
+build_triplet = i686-suse-linux-gnu
+host_triplet = i686-suse-linux-gnu
+subdir = mc
+DIST_COMMON = $(srcdir)/Makefile.am $(srcdir)/Makefile.in
+ACLOCAL_M4 = $(top_srcdir)/aclocal.m4
+am__aclocal_m4_deps = $(top_srcdir)/configure.ac
+am__configure_deps = $(am__aclocal_m4_deps) $(CONFIGURE_DEPENDENCIES) \
+	$(ACLOCAL_M4)
+mkinstalldirs = $(install_sh) -d
+CONFIG_HEADER = $(top_builddir)/config_ac.h
+CONFIG_CLEAN_FILES =
+am__vpath_adj_setup = srcdirstrip=`echo "$(srcdir)" | sed 's|.|.|g'`;
+am__vpath_adj = case $$p in \
+    $(srcdir)/*) f=`echo "$$p" | sed "s|^$$srcdirstrip/||"`;; \
+    *) f=$$p;; \
+  esac;
+am__strip_dir = `echo $$p | sed -e 's|^.*/||'`;
+am__installdirs = "$(DESTDIR)$(libdir)"
+libLTLIBRARIES_INSTALL = $(INSTALL)
+LTLIBRARIES = $(lib_LTLIBRARIES)
+libmc_la_DEPENDENCIES = $(top_srcdir)/common/libcommon.la
+am_libmc_la_OBJECTS = mc.lo
+libmc_la_OBJECTS = $(am_libmc_la_OBJECTS)
+DEFAULT_INCLUDES = -I. -I$(top_builddir)
+depcomp = $(SHELL) $(top_srcdir)/depcomp
+am__depfiles_maybe = depfiles
+COMPILE = $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) \
+	$(CPPFLAGS) $(AM_CFLAGS) $(CFLAGS)
+LTCOMPILE = $(LIBTOOL) --tag=CC $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) \
+	--mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) \
+	$(AM_CPPFLAGS) $(CPPFLAGS) $(AM_CFLAGS) $(CFLAGS)
+CCLD = $(CC)
+LINK = $(LIBTOOL) --tag=CC $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) \
+	--mode=link $(CCLD) $(AM_CFLAGS) $(CFLAGS) $(AM_LDFLAGS) \
+	$(LDFLAGS) -o $@
+SOURCES = $(libmc_la_SOURCES)
+DIST_SOURCES = $(libmc_la_SOURCES)
+ETAGS = etags
+CTAGS = ctags
+DISTFILES = $(DIST_COMMON) $(DIST_SOURCES) $(TEXINFOS) $(EXTRA_DIST)
+ACLOCAL = ${SHELL} /home/david/git/xrdp/missing --run aclocal-1.10
+AMTAR = ${SHELL} /home/david/git/xrdp/missing --run tar
+AR = ar
+AUTOCONF = ${SHELL} /home/david/git/xrdp/missing --run autoconf
+AUTOHEADER = ${SHELL} /home/david/git/xrdp/missing --run autoheader
+AUTOMAKE = ${SHELL} /home/david/git/xrdp/missing --run automake-1.10
+AWK = gawk
+CC = gcc
+CCDEPMODE = depmode=gcc3
+CFLAGS = -g -O2
+CPP = gcc -E
+CPPFLAGS = 
+CXX = g++
+CXXCPP = g++ -E
+CXXDEPMODE = depmode=gcc3
+CXXFLAGS = -g -O2
+CYGPATH_W = echo
+DEFS = -DHAVE_CONFIG_H
+DEPDIR = .deps
+DSYMUTIL = 
+ECHO = echo
+ECHO_C = 
+ECHO_N = -n
+ECHO_T = 
+EGREP = /usr/bin/grep -E
+EXEEXT = 
+F77 = 
+FFLAGS = 
+GREP = /usr/bin/grep
+INSTALL = /usr/bin/install -c
+INSTALL_DATA = ${INSTALL} -m 644
+INSTALL_PROGRAM = ${INSTALL}
+INSTALL_SCRIPT = ${INSTALL}
+INSTALL_STRIP_PROGRAM = $(install_sh) -c -s
+LDFLAGS = 
+LIBOBJS = 
+LIBS = 
+LIBTOOL = $(SHELL) $(top_builddir)/libtool
+LN_S = ln -s
+LTLIBOBJS = 
+MAKEINFO = ${SHELL} /home/david/git/xrdp/missing --run makeinfo
+MKDIR_P = /bin/mkdir -p
+NMEDIT = 
+OBJEXT = o
+PACKAGE = xrdp
+PACKAGE_BUGREPORT = xrdp-devel@lists.sourceforge.net
+PACKAGE_NAME = xrdp
+PACKAGE_STRING = xrdp 0.5.0
+PACKAGE_TARNAME = xrdp
+PACKAGE_VERSION = 0.5.0
+PATH_SEPARATOR = :
+RANLIB = ranlib
+SED = /usr/bin/sed
+SET_MAKE = 
+SHELL = /bin/sh
+STRIP = strip
+VERSION = 0.5.0
+abs_builddir = /home/david/git/xrdp/mc
+abs_srcdir = /home/david/git/xrdp/mc
+abs_top_builddir = /home/david/git/xrdp
+abs_top_srcdir = /home/david/git/xrdp
+ac_ct_CC = gcc
+ac_ct_CXX = g++
+ac_ct_F77 = 
+am__include = include
+am__leading_dot = .
+am__quote = 
+am__tar = ${AMTAR} chof - "$$tardir"
+am__untar = ${AMTAR} xf -
+bindir = ${exec_prefix}/bin
+build = i686-suse-linux-gnu
+build_alias = 
+build_cpu = i686
+build_os = linux-gnu
+build_vendor = suse
+builddir = .
+datadir = ${datarootdir}
+datarootdir = ${prefix}/share
+docdir = ${datarootdir}/doc/${PACKAGE_TARNAME}
+dvidir = ${docdir}
+exec_prefix = ${prefix}
+host = i686-suse-linux-gnu
+host_alias = 
+host_cpu = i686
+host_os = linux-gnu
+host_vendor = suse
+htmldir = ${docdir}
+includedir = ${prefix}/include
+infodir = ${datarootdir}/info
+install_sh = $(SHELL) /home/david/git/xrdp/install-sh
+libdir = ${exec_prefix}/lib/xrdp/
+libexecdir = ${exec_prefix}/libexec
+localedir = ${datarootdir}/locale
+localstatedir = ${prefix}/var
+mandir = ${datarootdir}/man
+mkdir_p = /bin/mkdir -p
+oldincludedir = /usr/include
+pdfdir = ${docdir}
+prefix = /usr
+program_transform_name = s,x,x,
+psdir = ${docdir}
+sbindir = ${exec_prefix}/sbin
+sharedstatedir = ${prefix}/com
+srcdir = .
+sysconfdir = ${prefix}/etc
+target_alias = 
+top_builddir = ..
+top_srcdir = ..
+INCLUDES = \
+  -I$(top_srcdir)/common
+
+lib_LTLIBRARIES = \
+  libmc.la
+
+libmc_la_SOURCES = mc.c
+libmc_la_LIBADD = \
+  $(top_srcdir)/common/libcommon.la
+
+all: all-am
+
+.SUFFIXES:
+.SUFFIXES: .c .lo .o .obj
+$(srcdir)/Makefile.in:  $(srcdir)/Makefile.am  $(am__configure_deps)
+	@for dep in $?; do \
+	  case '$(am__configure_deps)' in \
+	    *$$dep*) \
+	      cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh \
+		&& exit 0; \
+	      exit 1;; \
+	  esac; \
+	done; \
+	echo ' cd $(top_srcdir) && $(AUTOMAKE) --foreign  mc/Makefile'; \
+	cd $(top_srcdir) && \
+	  $(AUTOMAKE) --foreign  mc/Makefile
+.PRECIOUS: Makefile
+Makefile: $(srcdir)/Makefile.in $(top_builddir)/config.status
+	@case '$?' in \
+	  *config.status*) \
+	    cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh;; \
+	  *) \
+	    echo ' cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe)'; \
+	    cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe);; \
+	esac;
+
+$(top_builddir)/config.status: $(top_srcdir)/configure $(CONFIG_STATUS_DEPENDENCIES)
+	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
+
+$(top_srcdir)/configure:  $(am__configure_deps)
+	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
+$(ACLOCAL_M4):  $(am__aclocal_m4_deps)
+	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
+install-libLTLIBRARIES: $(lib_LTLIBRARIES)
+	@$(NORMAL_INSTALL)
+	test -z "$(libdir)" || $(MKDIR_P) "$(DESTDIR)$(libdir)"
+	@list='$(lib_LTLIBRARIES)'; for p in $$list; do \
+	  if test -f $$p; then \
+	    f=$(am__strip_dir) \
+	    echo " $(LIBTOOL) $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=install $(libLTLIBRARIES_INSTALL) $(INSTALL_STRIP_FLAG) '$$p' '$(DESTDIR)$(libdir)/$$f'"; \
+	    $(LIBTOOL) $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=install $(libLTLIBRARIES_INSTALL) $(INSTALL_STRIP_FLAG) "$$p" "$(DESTDIR)$(libdir)/$$f"; \
+	  else :; fi; \
+	done
+
+uninstall-libLTLIBRARIES:
+	@$(NORMAL_UNINSTALL)
+	@list='$(lib_LTLIBRARIES)'; for p in $$list; do \
+	  p=$(am__strip_dir) \
+	  echo " $(LIBTOOL) $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=uninstall rm -f '$(DESTDIR)$(libdir)/$$p'"; \
+	  $(LIBTOOL) $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=uninstall rm -f "$(DESTDIR)$(libdir)/$$p"; \
+	done
+
+clean-libLTLIBRARIES:
+	-test -z "$(lib_LTLIBRARIES)" || rm -f $(lib_LTLIBRARIES)
+	@list='$(lib_LTLIBRARIES)'; for p in $$list; do \
+	  dir="`echo $$p | sed -e 's|/[^/]*$$||'`"; \
+	  test "$$dir" != "$$p" || dir=.; \
+	  echo "rm -f \"$${dir}/so_locations\""; \
+	  rm -f "$${dir}/so_locations"; \
+	done
+libmc.la: $(libmc_la_OBJECTS) $(libmc_la_DEPENDENCIES) 
+	$(LINK) -rpath $(libdir) $(libmc_la_OBJECTS) $(libmc_la_LIBADD) $(LIBS)
+
+mostlyclean-compile:
+	-rm -f *.$(OBJEXT)
+
+distclean-compile:
+	-rm -f *.tab.c
+
+include ./$(DEPDIR)/mc.Plo
+
+.c.o:
+	$(COMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ $<
+	mv -f $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Po
+#	source='$<' object='$@' libtool=no \
+#	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) \
+#	$(COMPILE) -c $<
+
+.c.obj:
+	$(COMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ `$(CYGPATH_W) '$<'`
+	mv -f $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Po
+#	source='$<' object='$@' libtool=no \
+#	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) \
+#	$(COMPILE) -c `$(CYGPATH_W) '$<'`
+
+.c.lo:
+	$(LTCOMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ $<
+	mv -f $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Plo
+#	source='$<' object='$@' libtool=yes \
+#	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) \
+#	$(LTCOMPILE) -c -o $@ $<
+
+mostlyclean-libtool:
+	-rm -f *.lo
+
+clean-libtool:
+	-rm -rf .libs _libs
+
+ID: $(HEADERS) $(SOURCES) $(LISP) $(TAGS_FILES)
+	list='$(SOURCES) $(HEADERS) $(LISP) $(TAGS_FILES)'; \
+	unique=`for i in $$list; do \
+	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
+	  done | \
+	  $(AWK) '{ files[$$0] = 1; nonemtpy = 1; } \
+	      END { if (nonempty) { for (i in files) print i; }; }'`; \
+	mkid -fID $$unique
+tags: TAGS
+
+TAGS:  $(HEADERS) $(SOURCES)  $(TAGS_DEPENDENCIES) \
+		$(TAGS_FILES) $(LISP)
+	tags=; \
+	here=`pwd`; \
+	list='$(SOURCES) $(HEADERS)  $(LISP) $(TAGS_FILES)'; \
+	unique=`for i in $$list; do \
+	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
+	  done | \
+	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
+	      END { if (nonempty) { for (i in files) print i; }; }'`; \
+	if test -z "$(ETAGS_ARGS)$$tags$$unique"; then :; else \
+	  test -n "$$unique" || unique=$$empty_fix; \
+	  $(ETAGS) $(ETAGSFLAGS) $(AM_ETAGSFLAGS) $(ETAGS_ARGS) \
+	    $$tags $$unique; \
+	fi
+ctags: CTAGS
+CTAGS:  $(HEADERS) $(SOURCES)  $(TAGS_DEPENDENCIES) \
+		$(TAGS_FILES) $(LISP)
+	tags=; \
+	list='$(SOURCES) $(HEADERS)  $(LISP) $(TAGS_FILES)'; \
+	unique=`for i in $$list; do \
+	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
+	  done | \
+	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
+	      END { if (nonempty) { for (i in files) print i; }; }'`; \
+	test -z "$(CTAGS_ARGS)$$tags$$unique" \
+	  || $(CTAGS) $(CTAGSFLAGS) $(AM_CTAGSFLAGS) $(CTAGS_ARGS) \
+	     $$tags $$unique
+
+GTAGS:
+	here=`$(am__cd) $(top_builddir) && pwd` \
+	  && cd $(top_srcdir) \
+	  && gtags -i $(GTAGS_ARGS) $$here
+
+distclean-tags:
+	-rm -f TAGS ID GTAGS GRTAGS GSYMS GPATH tags
+
+distdir: $(DISTFILES)
+	@srcdirstrip=`echo "$(srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
+	topsrcdirstrip=`echo "$(top_srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
+	list='$(DISTFILES)'; \
+	  dist_files=`for file in $$list; do echo $$file; done | \
+	  sed -e "s|^$$srcdirstrip/||;t" \
+	      -e "s|^$$topsrcdirstrip/|$(top_builddir)/|;t"`; \
+	case $$dist_files in \
+	  */*) $(MKDIR_P) `echo "$$dist_files" | \
+			   sed '/\//!d;s|^|$(distdir)/|;s,/[^/]*$$,,' | \
+			   sort -u` ;; \
+	esac; \
+	for file in $$dist_files; do \
+	  if test -f $$file || test -d $$file; then d=.; else d=$(srcdir); fi; \
+	  if test -d $$d/$$file; then \
+	    dir=`echo "/$$file" | sed -e 's,/[^/]*$$,,'`; \
+	    if test -d $(srcdir)/$$file && test $$d != $(srcdir); then \
+	      cp -pR $(srcdir)/$$file $(distdir)$$dir || exit 1; \
+	    fi; \
+	    cp -pR $$d/$$file $(distdir)$$dir || exit 1; \
+	  else \
+	    test -f $(distdir)/$$file \
+	    || cp -p $$d/$$file $(distdir)/$$file \
+	    || exit 1; \
+	  fi; \
+	done
+check-am: all-am
+check: check-am
+all-am: Makefile $(LTLIBRARIES)
+installdirs:
+	for dir in "$(DESTDIR)$(libdir)"; do \
+	  test -z "$$dir" || $(MKDIR_P) "$$dir"; \
+	done
+install: install-am
+install-exec: install-exec-am
+install-data: install-data-am
+uninstall: uninstall-am
+
+install-am: all-am
+	@$(MAKE) $(AM_MAKEFLAGS) install-exec-am install-data-am
+
+installcheck: installcheck-am
+install-strip:
+	$(MAKE) $(AM_MAKEFLAGS) INSTALL_PROGRAM="$(INSTALL_STRIP_PROGRAM)" \
+	  install_sh_PROGRAM="$(INSTALL_STRIP_PROGRAM)" INSTALL_STRIP_FLAG=-s \
+	  `test -z '$(STRIP)' || \
+	    echo "INSTALL_PROGRAM_ENV=STRIPPROG='$(STRIP)'"` install
+mostlyclean-generic:
+
+clean-generic:
+
+distclean-generic:
+	-test -z "$(CONFIG_CLEAN_FILES)" || rm -f $(CONFIG_CLEAN_FILES)
+
+maintainer-clean-generic:
+	@echo "This command is intended for maintainers to use"
+	@echo "it deletes files that may require special tools to rebuild."
+clean: clean-am
+
+clean-am: clean-generic clean-libLTLIBRARIES clean-libtool \
+	mostlyclean-am
+
+distclean: distclean-am
+	-rm -rf ./$(DEPDIR)
+	-rm -f Makefile
+distclean-am: clean-am distclean-compile distclean-generic \
+	distclean-tags
+
+dvi: dvi-am
+
+dvi-am:
+
+html: html-am
+
+info: info-am
+
+info-am:
+
+install-data-am:
+
+install-dvi: install-dvi-am
+
+install-exec-am: install-libLTLIBRARIES
+
+install-html: install-html-am
+
+install-info: install-info-am
+
+install-man:
+
+install-pdf: install-pdf-am
+
+install-ps: install-ps-am
+
+installcheck-am:
+
+maintainer-clean: maintainer-clean-am
+	-rm -rf ./$(DEPDIR)
+	-rm -f Makefile
+maintainer-clean-am: distclean-am maintainer-clean-generic
+
+mostlyclean: mostlyclean-am
+
+mostlyclean-am: mostlyclean-compile mostlyclean-generic \
+	mostlyclean-libtool
+
+pdf: pdf-am
+
+pdf-am:
+
+ps: ps-am
+
+ps-am:
+
+uninstall-am: uninstall-libLTLIBRARIES
+
+.MAKE: install-am install-strip
+
+.PHONY: CTAGS GTAGS all all-am check check-am clean clean-generic \
+	clean-libLTLIBRARIES clean-libtool ctags distclean \
+	distclean-compile distclean-generic distclean-libtool \
+	distclean-tags distdir dvi dvi-am html html-am info info-am \
+	install install-am install-data install-data-am install-dvi \
+	install-dvi-am install-exec install-exec-am install-html \
+	install-html-am install-info install-info-am \
+	install-libLTLIBRARIES install-man install-pdf install-pdf-am \
+	install-ps install-ps-am install-strip installcheck \
+	installcheck-am installdirs maintainer-clean \
+	maintainer-clean-generic mostlyclean mostlyclean-compile \
+	mostlyclean-generic mostlyclean-libtool pdf pdf-am ps ps-am \
+	tags uninstall uninstall-am uninstall-libLTLIBRARIES
+
+# Tell versions [3.59,3.63) of GNU make to not export all variables.
+# Otherwise a system limit (for SysV at least) may be exceeded.
+.NOEXPORT:
diff --git a/mc/Makefile.am b/mc/Makefile.am
new file mode 100644
index 0000000..6160518
--- /dev/null
+++ b/mc/Makefile.am
@@ -0,0 +1,10 @@
+INCLUDES = \
+  -I$(top_srcdir)/common
+
+lib_LTLIBRARIES = \
+  libmc.la
+
+libmc_la_SOURCES = mc.c
+
+libmc_la_LIBADD = \
+  $(top_srcdir)/common/libcommon.la
diff --git a/mc/mc.c b/mc/mc.c
new file mode 100644
index 0000000..da8f9e4
--- /dev/null
+++ b/mc/mc.c
@@ -0,0 +1,113 @@
+/*
+   This program is free software; you can redistribute it and/or modify
+   it under the terms of the GNU General Public License as published by
+   the Free Software Foundation; either version 2 of the License, or
+   (at your option) any later version.
+
+   This program is distributed in the hope that it will be useful,
+   but WITHOUT ANY WARRANTY; without even the implied warranty of
+   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+   GNU General Public License for more details.
+
+   You should have received a copy of the GNU General Public License
+   along with this program; if not, write to the Free Software
+   Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
+
+   xrdp: A Remote Desktop Protocol server.
+   Copyright (C) Jay Sorg 2007-2008
+
+   media center
+
+*/
+
+#include "mc.h"
+
+/*****************************************************************************/
+/* return error */
+int DEFAULT_CC
+lib_mod_start(struct mod* mod, int w, int h, int bpp)
+{
+  LIB_DEBUG(mod, "in lib_mod_start");
+  mod->width = w;
+  mod->height = h;
+  mod->bpp = bpp;
+  LIB_DEBUG(mod, "out lib_mod_start");
+  return 0;
+}
+
+/******************************************************************************/
+/* return error */
+int DEFAULT_CC
+lib_mod_connect(struct mod* mod)
+{
+  LIB_DEBUG(mod, "in lib_mod_connect");
+  LIB_DEBUG(mod, "out lib_mod_connect");
+  return 0;
+}
+
+/******************************************************************************/
+/* return error */
+int DEFAULT_CC
+lib_mod_event(struct mod* mod, int msg, long param1, long param2,
+              long param3, long param4)
+{
+  LIB_DEBUG(mod, "in lib_mod_event");
+  LIB_DEBUG(mod, "out lib_mod_event");
+  return 0;
+}
+
+/******************************************************************************/
+/* return error */
+int DEFAULT_CC
+lib_mod_signal(struct mod* mod)
+{
+  LIB_DEBUG(mod, "in lib_mod_signal");
+  LIB_DEBUG(mod, "out lib_mod_signal");
+  return 0;
+}
+
+/******************************************************************************/
+/* return error */
+int DEFAULT_CC
+lib_mod_end(struct mod* mod)
+{
+  return 0;
+}
+
+/******************************************************************************/
+/* return error */
+int DEFAULT_CC
+lib_mod_set_param(struct mod* mod, char* name, char* value)
+{
+  return 0;
+}
+
+/******************************************************************************/
+struct mod* EXPORT_CC
+mod_init(void)
+{
+  struct mod* mod;
+
+  mod = (struct mod*)g_malloc(sizeof(struct mod), 1);
+  mod->size = sizeof(struct mod);
+  mod->handle = (long)mod;
+  mod->mod_connect = lib_mod_connect;
+  mod->mod_start = lib_mod_start;
+  mod->mod_event = lib_mod_event;
+  mod->mod_signal = lib_mod_signal;
+  mod->mod_end = lib_mod_end;
+  mod->mod_set_param = lib_mod_set_param;
+  return mod;
+}
+
+/******************************************************************************/
+int EXPORT_CC
+mod_exit(struct mod* mod)
+{
+  if (mod == 0)
+  {
+    return 0;
+  }
+  g_free(mod);
+  return 0;
+}
diff --git a/mc/mc.h b/mc/mc.h
new file mode 100644
index 0000000..27fc264
--- /dev/null
+++ b/mc/mc.h
@@ -0,0 +1,93 @@
+/*
+   This program is free software; you can redistribute it and/or modify
+   it under the terms of the GNU General Public License as published by
+   the Free Software Foundation; either version 2 of the License, or
+   (at your option) any later version.
+
+   This program is distributed in the hope that it will be useful,
+   but WITHOUT ANY WARRANTY; without even the implied warranty of
+   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+   GNU General Public License for more details.
+
+   You should have received a copy of the GNU General Public License
+   along with this program; if not, write to the Free Software
+   Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
+
+   xrdp: A Remote Desktop Protocol server.
+   Copyright (C) Jay Sorg 2007-2008
+
+   media center
+
+*/
+
+/* include other h files */
+#include "arch.h"
+#include "parse.h"
+#include "os_calls.h"
+#include "defines.h"
+
+struct mod
+{
+  int size; /* size of this struct */
+  int version; /* internal version */
+  /* client functions */
+  int (*mod_start)(struct mod* v, int w, int h, int bpp);
+  int (*mod_connect)(struct mod* v);
+  int (*mod_event)(struct mod* v, int msg, long param1, long param2,
+                   long param3, long param4);
+  int (*mod_signal)(struct mod* v);
+  int (*mod_end)(struct mod* v);
+  int (*mod_set_param)(struct mod* v, char* name, char* value);
+  long mod_dumby[100 - 6]; /* align, 100 minus the number of mod
+                              functions above */
+  /* server functions */
+  int (*server_begin_update)(struct mod* v);
+  int (*server_end_update)(struct mod* v);
+  int (*server_fill_rect)(struct mod* v, int x, int y, int cx, int cy);
+  int (*server_screen_blt)(struct mod* v, int x, int y, int cx, int cy,
+                           int srcx, int srcy);
+  int (*server_paint_rect)(struct mod* v, int x, int y, int cx, int cy,
+                           char* data, int width, int height, int srcx, int srcy);
+  int (*server_set_cursor)(struct mod* v, int x, int y, char* data, char* mask);
+  int (*server_palette)(struct mod* v, int* palette);
+  int (*server_msg)(struct mod* v, char* msg, int code);
+  int (*server_is_term)(struct mod* v);
+  int (*server_set_clip)(struct mod* v, int x, int y, int cx, int cy);
+  int (*server_reset_clip)(struct mod* v);
+  int (*server_set_fgcolor)(struct mod* v, int fgcolor);
+  int (*server_set_bgcolor)(struct mod* v, int bgcolor);
+  int (*server_set_opcode)(struct mod* v, int opcode);
+  int (*server_set_mixmode)(struct mod* v, int mixmode);
+  int (*server_set_brush)(struct mod* v, int x_orgin, int y_orgin,
+                          int style, char* pattern);
+  int (*server_set_pen)(struct mod* v, int style,
+                        int width);
+  int (*server_draw_line)(struct mod* v, int x1, int y1, int x2, int y2);
+  int (*server_add_char)(struct mod* v, int font, int charactor,
+                         int offset, int baseline,
+                         int width, int height, char* data);
+  int (*server_draw_text)(struct mod* v, int font,
+                          int flags, int mixmode, int clip_left, int clip_top,
+                          int clip_right, int clip_bottom,
+                          int box_left, int box_top,
+                          int box_right, int box_bottom,
+                          int x, int y, char* data, int data_len);
+  int (*server_reset)(struct mod* v, int width, int height, int bpp);
+  int (*server_query_channel)(struct mod* v, int index,
+                              char* channel_name,
+                              int* channel_flags);
+  int (*server_get_channel_id)(struct mod* v, char* name);
+  int (*server_send_to_channel)(struct mod* v, int channel_id,
+                                char* data, int data_len);
+  long server_dumby[100 - 24]; /* align, 100 minus the number of server
+                                  functions above */
+  /* common */
+  long handle; /* pointer to self as long */
+  long wm;
+  long painter;
+  int sck;
+  /* mod data */
+  int width;
+  int height;
+  int bpp;
+};
diff --git a/rdp/Makefile b/rdp/Makefile
index 2899357..53e8418 100644
--- a/rdp/Makefile
+++ b/rdp/Makefile
@@ -1,39 +1,489 @@
-# librdp makefile
-RDPOBJ = ssl_calls.o os_calls.o rdp.o rdp_tcp.o rdp_iso.o rdp_mcs.o rdp_sec.o \
-         rdp_orders.o rdp_bitmap.o rdp_rdp.o rdp_lic.o
-
-DESTDIR = /usr/local/xrdp
-CFGDIR = /etc/xrdp
-PIDDIR = /var/run
-MANDIR = /usr/local/man
-DOCDIR = /usr/doc/xrdp
-
-DEFINES =
-
-CFLAGS = -Wall -O2 -I../common -fPIC $(DEFINES)
-#CFLAGS += -DXRDP_DEBUG
-C_OS_FLAGS = $(CFLAGS) -c
-LDFLAGS = -shared
-LIBS = -ldl
-LIBS += -lcrypto
+# Makefile.in generated by automake 1.10.1 from Makefile.am.
+# rdp/Makefile.  Generated from Makefile.in by configure.
+
+# Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
+# 2003, 2004, 2005, 2006, 2007, 2008  Free Software Foundation, Inc.
+# This Makefile.in is free software; the Free Software Foundation
+# gives unlimited permission to copy and/or distribute it,
+# with or without modifications, as long as this notice is preserved.
+
+# This program is distributed in the hope that it will be useful,
+# but WITHOUT ANY WARRANTY, to the extent permitted by law; without
+# even the implied warranty of MERCHANTABILITY or FITNESS FOR A
+# PARTICULAR PURPOSE.
+
+
+
+
+pkgdatadir = $(datadir)/xrdp
+pkglibdir = $(libdir)/xrdp
+pkgincludedir = $(includedir)/xrdp
+am__cd = CDPATH="$${ZSH_VERSION+.}$(PATH_SEPARATOR)" && cd
+install_sh_DATA = $(install_sh) -c -m 644
+install_sh_PROGRAM = $(install_sh) -c
+install_sh_SCRIPT = $(install_sh) -c
+INSTALL_HEADER = $(INSTALL_DATA)
+transform = $(program_transform_name)
+NORMAL_INSTALL = :
+PRE_INSTALL = :
+POST_INSTALL = :
+NORMAL_UNINSTALL = :
+PRE_UNINSTALL = :
+POST_UNINSTALL = :
+build_triplet = i686-suse-linux-gnu
+host_triplet = i686-suse-linux-gnu
+subdir = rdp
+DIST_COMMON = $(srcdir)/Makefile.am $(srcdir)/Makefile.in
+ACLOCAL_M4 = $(top_srcdir)/aclocal.m4
+am__aclocal_m4_deps = $(top_srcdir)/configure.ac
+am__configure_deps = $(am__aclocal_m4_deps) $(CONFIGURE_DEPENDENCIES) \
+	$(ACLOCAL_M4)
+mkinstalldirs = $(install_sh) -d
+CONFIG_HEADER = $(top_builddir)/config_ac.h
+CONFIG_CLEAN_FILES =
+am__vpath_adj_setup = srcdirstrip=`echo "$(srcdir)" | sed 's|.|.|g'`;
+am__vpath_adj = case $$p in \
+    $(srcdir)/*) f=`echo "$$p" | sed "s|^$$srcdirstrip/||"`;; \
+    *) f=$$p;; \
+  esac;
+am__strip_dir = `echo $$p | sed -e 's|^.*/||'`;
+am__installdirs = "$(DESTDIR)$(libdir)"
+libLTLIBRARIES_INSTALL = $(INSTALL)
+LTLIBRARIES = $(lib_LTLIBRARIES)
+librdp_la_DEPENDENCIES = $(top_srcdir)/common/libcommon.la
+am_librdp_la_OBJECTS = rdp.lo rdp_bitmap.lo rdp_iso.lo rdp_lic.lo \
+	rdp_mcs.lo rdp_orders.lo rdp_rdp.lo rdp_sec.lo rdp_tcp.lo
+librdp_la_OBJECTS = $(am_librdp_la_OBJECTS)
+DEFAULT_INCLUDES = -I. -I$(top_builddir)
+depcomp = $(SHELL) $(top_srcdir)/depcomp
+am__depfiles_maybe = depfiles
+COMPILE = $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) \
+	$(CPPFLAGS) $(AM_CFLAGS) $(CFLAGS)
+LTCOMPILE = $(LIBTOOL) --tag=CC $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) \
+	--mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) \
+	$(AM_CPPFLAGS) $(CPPFLAGS) $(AM_CFLAGS) $(CFLAGS)
+CCLD = $(CC)
+LINK = $(LIBTOOL) --tag=CC $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) \
+	--mode=link $(CCLD) $(AM_CFLAGS) $(CFLAGS) $(AM_LDFLAGS) \
+	$(LDFLAGS) -o $@
+SOURCES = $(librdp_la_SOURCES)
+DIST_SOURCES = $(librdp_la_SOURCES)
+ETAGS = etags
+CTAGS = ctags
+DISTFILES = $(DIST_COMMON) $(DIST_SOURCES) $(TEXINFOS) $(EXTRA_DIST)
+ACLOCAL = ${SHELL} /home/david/git/xrdp/missing --run aclocal-1.10
+AMTAR = ${SHELL} /home/david/git/xrdp/missing --run tar
+AR = ar
+AUTOCONF = ${SHELL} /home/david/git/xrdp/missing --run autoconf
+AUTOHEADER = ${SHELL} /home/david/git/xrdp/missing --run autoheader
+AUTOMAKE = ${SHELL} /home/david/git/xrdp/missing --run automake-1.10
+AWK = gawk
 CC = gcc
+CCDEPMODE = depmode=gcc3
+CFLAGS = -g -O2
+CPP = gcc -E
+CPPFLAGS = 
+CXX = g++
+CXXCPP = g++ -E
+CXXDEPMODE = depmode=gcc3
+CXXFLAGS = -g -O2
+CYGPATH_W = echo
+DEFS = -DHAVE_CONFIG_H
+DEPDIR = .deps
+DSYMUTIL = 
+ECHO = echo
+ECHO_C = 
+ECHO_N = -n
+ECHO_T = 
+EGREP = /usr/bin/grep -E
+EXEEXT = 
+F77 = 
+FFLAGS = 
+GREP = /usr/bin/grep
+INSTALL = /usr/bin/install -c
+INSTALL_DATA = ${INSTALL} -m 644
+INSTALL_PROGRAM = ${INSTALL}
+INSTALL_SCRIPT = ${INSTALL}
+INSTALL_STRIP_PROGRAM = $(install_sh) -c -s
+LDFLAGS = 
+LIBOBJS = 
+LIBS = 
+LIBTOOL = $(SHELL) $(top_builddir)/libtool
+LN_S = ln -s
+LTLIBOBJS = 
+MAKEINFO = ${SHELL} /home/david/git/xrdp/missing --run makeinfo
+MKDIR_P = /bin/mkdir -p
+NMEDIT = 
+OBJEXT = o
+PACKAGE = xrdp
+PACKAGE_BUGREPORT = xrdp-devel@lists.sourceforge.net
+PACKAGE_NAME = xrdp
+PACKAGE_STRING = xrdp 0.5.0
+PACKAGE_TARNAME = xrdp
+PACKAGE_VERSION = 0.5.0
+PATH_SEPARATOR = :
+RANLIB = ranlib
+SED = /usr/bin/sed
+SET_MAKE = 
+SHELL = /bin/sh
+STRIP = strip
+VERSION = 0.5.0
+abs_builddir = /home/david/git/xrdp/rdp
+abs_srcdir = /home/david/git/xrdp/rdp
+abs_top_builddir = /home/david/git/xrdp
+abs_top_srcdir = /home/david/git/xrdp
+ac_ct_CC = gcc
+ac_ct_CXX = g++
+ac_ct_F77 = 
+am__include = include
+am__leading_dot = .
+am__quote = 
+am__tar = ${AMTAR} chof - "$$tardir"
+am__untar = ${AMTAR} xf -
+bindir = ${exec_prefix}/bin
+build = i686-suse-linux-gnu
+build_alias = 
+build_cpu = i686
+build_os = linux-gnu
+build_vendor = suse
+builddir = .
+datadir = ${datarootdir}
+datarootdir = ${prefix}/share
+docdir = ${datarootdir}/doc/${PACKAGE_TARNAME}
+dvidir = ${docdir}
+exec_prefix = ${prefix}
+host = i686-suse-linux-gnu
+host_alias = 
+host_cpu = i686
+host_os = linux-gnu
+host_vendor = suse
+htmldir = ${docdir}
+includedir = ${prefix}/include
+infodir = ${datarootdir}/info
+install_sh = $(SHELL) /home/david/git/xrdp/install-sh
+libdir = ${exec_prefix}/lib/xrdp/
+libexecdir = ${exec_prefix}/libexec
+localedir = ${datarootdir}/locale
+localstatedir = ${prefix}/var
+mandir = ${datarootdir}/man
+mkdir_p = /bin/mkdir -p
+oldincludedir = /usr/include
+pdfdir = ${docdir}
+prefix = /usr
+program_transform_name = s,x,x,
+psdir = ${docdir}
+sbindir = ${exec_prefix}/sbin
+sharedstatedir = ${prefix}/com
+srcdir = .
+sysconfdir = ${prefix}/etc
+target_alias = 
+top_builddir = ..
+top_srcdir = ..
+INCLUDES = \
+  -I$(top_srcdir)/common
+
+lib_LTLIBRARIES = \
+  librdp.la
+
+librdp_la_SOURCES = \
+  rdp.c \
+  rdp_bitmap.c \
+  rdp_iso.c \
+  rdp_lic.c \
+  rdp_mcs.c \
+  rdp_orders.c \
+  rdp_rdp.c \
+  rdp_sec.c \
+  rdp_tcp.c
+
+librdp_la_LIBADD = \
+  $(top_srcdir)/common/libcommon.la
+
+all: all-am
+
+.SUFFIXES:
+.SUFFIXES: .c .lo .o .obj
+$(srcdir)/Makefile.in:  $(srcdir)/Makefile.am  $(am__configure_deps)
+	@for dep in $?; do \
+	  case '$(am__configure_deps)' in \
+	    *$$dep*) \
+	      cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh \
+		&& exit 0; \
+	      exit 1;; \
+	  esac; \
+	done; \
+	echo ' cd $(top_srcdir) && $(AUTOMAKE) --foreign  rdp/Makefile'; \
+	cd $(top_srcdir) && \
+	  $(AUTOMAKE) --foreign  rdp/Makefile
+.PRECIOUS: Makefile
+Makefile: $(srcdir)/Makefile.in $(top_builddir)/config.status
+	@case '$?' in \
+	  *config.status*) \
+	    cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh;; \
+	  *) \
+	    echo ' cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe)'; \
+	    cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe);; \
+	esac;
+
+$(top_builddir)/config.status: $(top_srcdir)/configure $(CONFIG_STATUS_DEPENDENCIES)
+	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
+
+$(top_srcdir)/configure:  $(am__configure_deps)
+	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
+$(ACLOCAL_M4):  $(am__aclocal_m4_deps)
+	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
+install-libLTLIBRARIES: $(lib_LTLIBRARIES)
+	@$(NORMAL_INSTALL)
+	test -z "$(libdir)" || $(MKDIR_P) "$(DESTDIR)$(libdir)"
+	@list='$(lib_LTLIBRARIES)'; for p in $$list; do \
+	  if test -f $$p; then \
+	    f=$(am__strip_dir) \
+	    echo " $(LIBTOOL) $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=install $(libLTLIBRARIES_INSTALL) $(INSTALL_STRIP_FLAG) '$$p' '$(DESTDIR)$(libdir)/$$f'"; \
+	    $(LIBTOOL) $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=install $(libLTLIBRARIES_INSTALL) $(INSTALL_STRIP_FLAG) "$$p" "$(DESTDIR)$(libdir)/$$f"; \
+	  else :; fi; \
+	done
+
+uninstall-libLTLIBRARIES:
+	@$(NORMAL_UNINSTALL)
+	@list='$(lib_LTLIBRARIES)'; for p in $$list; do \
+	  p=$(am__strip_dir) \
+	  echo " $(LIBTOOL) $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=uninstall rm -f '$(DESTDIR)$(libdir)/$$p'"; \
+	  $(LIBTOOL) $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=uninstall rm -f "$(DESTDIR)$(libdir)/$$p"; \
+	done
+
+clean-libLTLIBRARIES:
+	-test -z "$(lib_LTLIBRARIES)" || rm -f $(lib_LTLIBRARIES)
+	@list='$(lib_LTLIBRARIES)'; for p in $$list; do \
+	  dir="`echo $$p | sed -e 's|/[^/]*$$||'`"; \
+	  test "$$dir" != "$$p" || dir=.; \
+	  echo "rm -f \"$${dir}/so_locations\""; \
+	  rm -f "$${dir}/so_locations"; \
+	done
+librdp.la: $(librdp_la_OBJECTS) $(librdp_la_DEPENDENCIES) 
+	$(LINK) -rpath $(libdir) $(librdp_la_OBJECTS) $(librdp_la_LIBADD) $(LIBS)
+
+mostlyclean-compile:
+	-rm -f *.$(OBJEXT)
+
+distclean-compile:
+	-rm -f *.tab.c
+
+include ./$(DEPDIR)/rdp.Plo
+include ./$(DEPDIR)/rdp_bitmap.Plo
+include ./$(DEPDIR)/rdp_iso.Plo
+include ./$(DEPDIR)/rdp_lic.Plo
+include ./$(DEPDIR)/rdp_mcs.Plo
+include ./$(DEPDIR)/rdp_orders.Plo
+include ./$(DEPDIR)/rdp_rdp.Plo
+include ./$(DEPDIR)/rdp_sec.Plo
+include ./$(DEPDIR)/rdp_tcp.Plo
+
+.c.o:
+	$(COMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ $<
+	mv -f $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Po
+#	source='$<' object='$@' libtool=no \
+#	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) \
+#	$(COMPILE) -c $<
+
+.c.obj:
+	$(COMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ `$(CYGPATH_W) '$<'`
+	mv -f $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Po
+#	source='$<' object='$@' libtool=no \
+#	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) \
+#	$(COMPILE) -c `$(CYGPATH_W) '$<'`
+
+.c.lo:
+	$(LTCOMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ $<
+	mv -f $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Plo
+#	source='$<' object='$@' libtool=yes \
+#	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) \
+#	$(LTCOMPILE) -c -o $@ $<
+
+mostlyclean-libtool:
+	-rm -f *.lo
+
+clean-libtool:
+	-rm -rf .libs _libs
+
+ID: $(HEADERS) $(SOURCES) $(LISP) $(TAGS_FILES)
+	list='$(SOURCES) $(HEADERS) $(LISP) $(TAGS_FILES)'; \
+	unique=`for i in $$list; do \
+	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
+	  done | \
+	  $(AWK) '{ files[$$0] = 1; nonemtpy = 1; } \
+	      END { if (nonempty) { for (i in files) print i; }; }'`; \
+	mkid -fID $$unique
+tags: TAGS
+
+TAGS:  $(HEADERS) $(SOURCES)  $(TAGS_DEPENDENCIES) \
+		$(TAGS_FILES) $(LISP)
+	tags=; \
+	here=`pwd`; \
+	list='$(SOURCES) $(HEADERS)  $(LISP) $(TAGS_FILES)'; \
+	unique=`for i in $$list; do \
+	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
+	  done | \
+	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
+	      END { if (nonempty) { for (i in files) print i; }; }'`; \
+	if test -z "$(ETAGS_ARGS)$$tags$$unique"; then :; else \
+	  test -n "$$unique" || unique=$$empty_fix; \
+	  $(ETAGS) $(ETAGSFLAGS) $(AM_ETAGSFLAGS) $(ETAGS_ARGS) \
+	    $$tags $$unique; \
+	fi
+ctags: CTAGS
+CTAGS:  $(HEADERS) $(SOURCES)  $(TAGS_DEPENDENCIES) \
+		$(TAGS_FILES) $(LISP)
+	tags=; \
+	list='$(SOURCES) $(HEADERS)  $(LISP) $(TAGS_FILES)'; \
+	unique=`for i in $$list; do \
+	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
+	  done | \
+	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
+	      END { if (nonempty) { for (i in files) print i; }; }'`; \
+	test -z "$(CTAGS_ARGS)$$tags$$unique" \
+	  || $(CTAGS) $(CTAGSFLAGS) $(AM_CTAGSFLAGS) $(CTAGS_ARGS) \
+	     $$tags $$unique
+
+GTAGS:
+	here=`$(am__cd) $(top_builddir) && pwd` \
+	  && cd $(top_srcdir) \
+	  && gtags -i $(GTAGS_ARGS) $$here
+
+distclean-tags:
+	-rm -f TAGS ID GTAGS GRTAGS GSYMS GPATH tags
+
+distdir: $(DISTFILES)
+	@srcdirstrip=`echo "$(srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
+	topsrcdirstrip=`echo "$(top_srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
+	list='$(DISTFILES)'; \
+	  dist_files=`for file in $$list; do echo $$file; done | \
+	  sed -e "s|^$$srcdirstrip/||;t" \
+	      -e "s|^$$topsrcdirstrip/|$(top_builddir)/|;t"`; \
+	case $$dist_files in \
+	  */*) $(MKDIR_P) `echo "$$dist_files" | \
+			   sed '/\//!d;s|^|$(distdir)/|;s,/[^/]*$$,,' | \
+			   sort -u` ;; \
+	esac; \
+	for file in $$dist_files; do \
+	  if test -f $$file || test -d $$file; then d=.; else d=$(srcdir); fi; \
+	  if test -d $$d/$$file; then \
+	    dir=`echo "/$$file" | sed -e 's,/[^/]*$$,,'`; \
+	    if test -d $(srcdir)/$$file && test $$d != $(srcdir); then \
+	      cp -pR $(srcdir)/$$file $(distdir)$$dir || exit 1; \
+	    fi; \
+	    cp -pR $$d/$$file $(distdir)$$dir || exit 1; \
+	  else \
+	    test -f $(distdir)/$$file \
+	    || cp -p $$d/$$file $(distdir)/$$file \
+	    || exit 1; \
+	  fi; \
+	done
+check-am: all-am
+check: check-am
+all-am: Makefile $(LTLIBRARIES)
+installdirs:
+	for dir in "$(DESTDIR)$(libdir)"; do \
+	  test -z "$$dir" || $(MKDIR_P) "$$dir"; \
+	done
+install: install-am
+install-exec: install-exec-am
+install-data: install-data-am
+uninstall: uninstall-am
+
+install-am: all-am
+	@$(MAKE) $(AM_MAKEFLAGS) install-exec-am install-data-am
+
+installcheck: installcheck-am
+install-strip:
+	$(MAKE) $(AM_MAKEFLAGS) INSTALL_PROGRAM="$(INSTALL_STRIP_PROGRAM)" \
+	  install_sh_PROGRAM="$(INSTALL_STRIP_PROGRAM)" INSTALL_STRIP_FLAG=-s \
+	  `test -z '$(STRIP)' || \
+	    echo "INSTALL_PROGRAM_ENV=STRIPPROG='$(STRIP)'"` install
+mostlyclean-generic:
+
+clean-generic:
+
+distclean-generic:
+	-test -z "$(CONFIG_CLEAN_FILES)" || rm -f $(CONFIG_CLEAN_FILES)
+
+maintainer-clean-generic:
+	@echo "This command is intended for maintainers to use"
+	@echo "it deletes files that may require special tools to rebuild."
+clean: clean-am
+
+clean-am: clean-generic clean-libLTLIBRARIES clean-libtool \
+	mostlyclean-am
+
+distclean: distclean-am
+	-rm -rf ./$(DEPDIR)
+	-rm -f Makefile
+distclean-am: clean-am distclean-compile distclean-generic \
+	distclean-tags
+
+dvi: dvi-am
+
+dvi-am:
+
+html: html-am
+
+info: info-am
+
+info-am:
+
+install-data-am:
+
+install-dvi: install-dvi-am
+
+install-exec-am: install-libLTLIBRARIES
+
+install-html: install-html-am
+
+install-info: install-info-am
+
+install-man:
+
+install-pdf: install-pdf-am
+
+install-ps: install-ps-am
+
+installcheck-am:
+
+maintainer-clean: maintainer-clean-am
+	-rm -rf ./$(DEPDIR)
+	-rm -f Makefile
+maintainer-clean-am: distclean-am maintainer-clean-generic
+
+mostlyclean: mostlyclean-am
+
+mostlyclean-am: mostlyclean-compile mostlyclean-generic \
+	mostlyclean-libtool
+
+pdf: pdf-am
 
-all: rdp
+pdf-am:
 
-rdp: $(RDPOBJ)
-	$(CC) $(LDFLAGS) -o librdp.so $(RDPOBJ) $(LIBS)
+ps: ps-am
 
-clean:
-	rm -f $(RDPOBJ) librdp.so
+ps-am:
 
-os_calls.o: ../common/os_calls.c
-	$(CC) $(C_OS_FLAGS) ../common/os_calls.c
+uninstall-am: uninstall-libLTLIBRARIES
 
-ssl_calls.o: ../common/ssl_calls.c
-	$(CC) $(C_OS_FLAGS) ../common/ssl_calls.c
+.MAKE: install-am install-strip
 
-install:
-	install librdp.so $(DESTDIR)/librdp.so
+.PHONY: CTAGS GTAGS all all-am check check-am clean clean-generic \
+	clean-libLTLIBRARIES clean-libtool ctags distclean \
+	distclean-compile distclean-generic distclean-libtool \
+	distclean-tags distdir dvi dvi-am html html-am info info-am \
+	install install-am install-data install-data-am install-dvi \
+	install-dvi-am install-exec install-exec-am install-html \
+	install-html-am install-info install-info-am \
+	install-libLTLIBRARIES install-man install-pdf install-pdf-am \
+	install-ps install-ps-am install-strip installcheck \
+	installcheck-am installdirs maintainer-clean \
+	maintainer-clean-generic mostlyclean mostlyclean-compile \
+	mostlyclean-generic mostlyclean-libtool pdf pdf-am ps ps-am \
+	tags uninstall uninstall-am uninstall-libLTLIBRARIES
 
-installdeb:
-	install librdp.so $(DESTDIRDEB)/usr/lib/xrdp/librdp.so
+# Tell versions [3.59,3.63) of GNU make to not export all variables.
+# Otherwise a system limit (for SysV at least) may be exceeded.
+.NOEXPORT:
diff --git a/rdp/Makefile.am b/rdp/Makefile.am
new file mode 100644
index 0000000..0ec7357
--- /dev/null
+++ b/rdp/Makefile.am
@@ -0,0 +1,19 @@
+INCLUDES = \
+  -I$(top_srcdir)/common
+
+lib_LTLIBRARIES = \
+  librdp.la
+
+librdp_la_SOURCES = \
+  rdp.c \
+  rdp_bitmap.c \
+  rdp_iso.c \
+  rdp_lic.c \
+  rdp_mcs.c \
+  rdp_orders.c \
+  rdp_rdp.c \
+  rdp_sec.c \
+  rdp_tcp.c
+
+librdp_la_LIBADD = \
+  $(top_srcdir)/common/libcommon.la
diff --git a/rdp/Makefile.osx b/rdp/Makefile.osx
new file mode 100644
index 0000000..1d7bc92
--- /dev/null
+++ b/rdp/Makefile.osx
@@ -0,0 +1,39 @@
+# librdp makefile
+RDPOBJ = ssl_calls.o os_calls.o rdp.o rdp_tcp.o rdp_iso.o rdp_mcs.o rdp_sec.o \
+         rdp_orders.o rdp_bitmap.o rdp_rdp.o rdp_lic.o
+
+DESTDIR = /usr/local/xrdp
+CFGDIR = /etc/xrdp
+PIDDIR = /var/run
+MANDIR = /usr/local/man
+DOCDIR = /usr/doc/xrdp
+
+DEFINES =
+
+LIBRDP = librdb.dylib
+
+CFLAGS = -Wall -O2 -I../common -fPIC $(DEFINES)
+#CFLAGS += -DXRDP_DEBUG
+C_OS_FLAGS = $(CFLAGS) -c
+LDFLAGS = -dynamiclib -Wl,-flat_namespace -Wl,-undefined -Wl,suppress
+LIBS = -ldl
+LIBS += -lcrypto
+CC = gcc
+
+all: $(LIBRDP)
+
+$(LIBRDP): $(RDPOBJ)
+	$(CC) $(LDFLAGS) -o $(LIBRDP) $(RDPOBJ) $(LIBS)
+
+clean:
+	rm -f $(RDPOBJ) $(LIBRDP)
+
+os_calls.o: ../common/os_calls.c
+	$(CC) $(C_OS_FLAGS) ../common/os_calls.c
+
+ssl_calls.o: ../common/ssl_calls.c
+	$(CC) $(C_OS_FLAGS) ../common/ssl_calls.c
+
+install:
+	install $(LIBRDP) $(DESTDIR)/$(LIBRDP)
+
diff --git a/rdp/rdp.c b/rdp/rdp.c
index 48c0615..b3caa51 100644
--- a/rdp/rdp.c
+++ b/rdp/rdp.c
@@ -14,7 +14,7 @@
    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
 
    xrdp: A Remote Desktop Protocol server.
-   Copyright (C) Jay Sorg 2005-2007
+   Copyright (C) Jay Sorg 2005-2008
 
    librdp main file
 
@@ -53,6 +53,9 @@ lib_mod_connect(struct mod* mod)
   if (rdp_rdp_connect(mod->rdp_layer, mod->ip, mod->port) == 0)
   {
     mod->sck = mod->rdp_layer->sec_layer->mcs_layer->iso_layer->tcp_layer->sck;
+    g_tcp_set_non_blocking(mod->sck);
+    g_tcp_set_no_delay(mod->sck);
+    mod->sck_obj = g_create_wait_obj_from_socket(mod->sck, 0);
     DEBUG(("out lib_mod_connect"));
     return 0;
   }
@@ -209,6 +212,11 @@ lib_mod_end(struct mod* mod)
   mod->rdp_layer = 0;
   free_stream(mod->in_s);
   mod->in_s = 0;
+  if (mod->sck_obj != 0)
+  {
+    g_delete_wait_obj_from_socket(mod->sck_obj);
+    mod->sck_obj = 0;
+  }
   if (mod->sck != 0)
   {
     g_tcp_close(mod->sck);
@@ -250,6 +258,47 @@ lib_mod_set_param(struct mod* mod, char* name, char* value)
 }
 
 /******************************************************************************/
+/* return error */
+int DEFAULT_CC
+lib_mod_get_wait_objs(struct mod* mod, tbus* read_objs, int* rcount,
+                      tbus* write_objs, int* wcount, int* timeout)
+{
+  int i;
+
+  i = *rcount;
+  if (mod != 0)
+  {
+    if (mod->sck_obj != 0)
+    {
+      read_objs[i++] = mod->sck_obj;
+    }
+  }
+  *rcount = i;
+  return 0;
+}
+
+/******************************************************************************/
+/* return error */
+int DEFAULT_CC
+lib_mod_check_wait_objs(struct mod* mod)
+{
+  int rv;
+
+  rv = 0;
+  if (mod != 0)
+  {
+    if (mod->sck_obj != 0)
+    {
+      if (g_is_wait_obj_set(mod->sck_obj))
+      {
+        rv = lib_mod_signal(mod);
+      }
+    }
+  }
+  return rv;
+}
+
+/******************************************************************************/
 struct mod* EXPORT_CC
 mod_init(void)
 {
@@ -265,6 +314,8 @@ mod_init(void)
   mod->mod_signal = lib_mod_signal;
   mod->mod_end = lib_mod_end;
   mod->mod_set_param = lib_mod_set_param;
+  mod->mod_get_wait_objs = lib_mod_get_wait_objs;
+  mod->mod_check_wait_objs = lib_mod_check_wait_objs;
   mod->rdp_layer = rdp_rdp_create(mod);
   DEBUG(("out mod_init"));
   return mod;
diff --git a/rdp/rdp.h b/rdp/rdp.h
index 2344e59..4e471dc 100644
--- a/rdp/rdp.h
+++ b/rdp/rdp.h
@@ -263,7 +263,11 @@ struct mod
   int (*mod_signal)(struct mod* v);
   int (*mod_end)(struct mod* v);
   int (*mod_set_param)(struct mod* v, char* name, char* value);
-  long mod_dumby[100 - 6]; /* align, 100 minus the number of mod 
+  int (*mod_session_change)(struct mod* v, int, int);
+  int (*mod_get_wait_objs)(struct mod* v, tbus* read_objs, int* rcount,
+                           tbus* write_objs, int* wcount, int* timeout);
+  int (*mod_check_wait_objs)(struct mod* v);
+  long mod_dumby[100 - 9]; /* align, 100 minus the number of mod 
                               functions above */
   /* server functions */
   int (*server_begin_update)(struct mod* v);
@@ -328,6 +332,7 @@ struct mod
   int keylayout;
   int up_and_running;
   struct stream* in_s;
+  tbus sck_obj;
 };
 
 /* rdp_tcp.c */
diff --git a/rdp/rdp_bitmap.c b/rdp/rdp_bitmap.c
index 47a59f5..f13a8e7 100644
--- a/rdp/rdp_bitmap.c
+++ b/rdp/rdp_bitmap.c
@@ -14,7 +14,7 @@
    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
 
    xrdp: A Remote Desktop Protocol server.
-   Copyright (C) Jay Sorg 2005-2007
+   Copyright (C) Jay Sorg 2005-2008
 
    librdp bitmap routines
 
diff --git a/rdp/rdp_iso.c b/rdp/rdp_iso.c
index aaafd11..ac7dd34 100644
--- a/rdp/rdp_iso.c
+++ b/rdp/rdp_iso.c
@@ -14,7 +14,7 @@
    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
 
    xrdp: A Remote Desktop Protocol server.
-   Copyright (C) Jay Sorg 2005-2007
+   Copyright (C) Jay Sorg 2005-2008
 
    librdp iso layer
 
diff --git a/rdp/rdp_lic.c b/rdp/rdp_lic.c
index 4ceab2b..0de448c 100644
--- a/rdp/rdp_lic.c
+++ b/rdp/rdp_lic.c
@@ -14,7 +14,7 @@
    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
 
    xrdp: A Remote Desktop Protocol server.
-   Copyright (C) Jay Sorg 2005-2007
+   Copyright (C) Jay Sorg 2005-2008
 
    licence
 
diff --git a/rdp/rdp_mcs.c b/rdp/rdp_mcs.c
index 5cd9ae1..a5adcdd 100644
--- a/rdp/rdp_mcs.c
+++ b/rdp/rdp_mcs.c
@@ -14,7 +14,7 @@
    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
 
    xrdp: A Remote Desktop Protocol server.
-   Copyright (C) Jay Sorg 2005-2007
+   Copyright (C) Jay Sorg 2005-2008
 
    librdp mcs layer
 
diff --git a/rdp/rdp_orders.c b/rdp/rdp_orders.c
index 372e9cc..4bc4d05 100644
--- a/rdp/rdp_orders.c
+++ b/rdp/rdp_orders.c
@@ -14,7 +14,7 @@
    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
 
    xrdp: A Remote Desktop Protocol server.
-   Copyright (C) Jay Sorg 2005-2007
+   Copyright (C) Jay Sorg 2005-2008
 
    librdp orders
 
@@ -243,7 +243,16 @@ rdp_orders_process_raw_bmpcache(struct rdp_orders* self, struct stream* s,
     {
       for (x = 0; x < width; x++)
       {
-        in_uint16_le(s, ((unsigned short*)dst)[x]);
+        in_uint16_le(s, ((tui16*)dst)[x]);
+      }
+    }
+    else if (Bpp == 3)
+    {
+      for (x = 0; x < width; x++)
+      {
+        in_uint8(s, dst[x * 3 + 0]);
+        in_uint8(s, dst[x * 3 + 1]);
+        in_uint8(s, dst[x * 3 + 2]);
       }
     }
   }
@@ -1309,11 +1318,7 @@ rdp_orders_convert_bitmap(int in_bpp, int out_bpp, char* bmpdata,
   int blue;
   int pixel;
 
-  if (in_bpp == out_bpp && in_bpp == 16)
-  {
-    return bmpdata;
-  }
-  if (in_bpp == 8 && out_bpp == 8)
+  if ((in_bpp == 8) && (out_bpp == 8))
   {
     out = (char*)g_malloc(width * height, 0);
     src = bmpdata;
@@ -1322,7 +1327,7 @@ rdp_orders_convert_bitmap(int in_bpp, int out_bpp, char* bmpdata,
     {
       for (j = 0; j < width; j++)
       {
-        pixel = *((unsigned char*)src);
+        pixel = *((tui8*)src);
         pixel = palette[pixel];
         SPLITCOLOR32(red, green, blue, pixel);
         pixel = COLOR8(red, green, blue);
@@ -1333,7 +1338,7 @@ rdp_orders_convert_bitmap(int in_bpp, int out_bpp, char* bmpdata,
     }
     return out;
   }
-  if (in_bpp == 8 && out_bpp == 16)
+  if ((in_bpp == 8) && (out_bpp == 16))
   {
     out = (char*)g_malloc(width * height * 2, 0);
     src = bmpdata;
@@ -1342,17 +1347,120 @@ rdp_orders_convert_bitmap(int in_bpp, int out_bpp, char* bmpdata,
     {
       for (j = 0; j < width; j++)
       {
-        pixel = *((unsigned char*)src);
+        pixel = *((tui8*)src);
         pixel = palette[pixel];
         SPLITCOLOR32(red, green, blue, pixel);
         pixel = COLOR16(red, green, blue);
-        *((unsigned short*)dst) = pixel;
+        *((tui16*)dst) = pixel;
         src++;
         dst += 2;
       }
     }
     return out;
   }
+  if ((in_bpp == 8) && (out_bpp == 24))
+  {
+    out = (char*)g_malloc(width * height * 4, 0);
+    src = bmpdata;
+    dst = out;
+    for (i = 0; i < height; i++)
+    {
+      for (j = 0; j < width; j++)
+      {
+        pixel = *((tui8*)src);
+        pixel = palette[pixel];
+        SPLITCOLOR32(red, green, blue, pixel);
+        pixel = COLOR24RGB(red, green, blue);
+        *((tui32*)dst) = pixel;
+        src++;;
+        dst += 4;
+      }
+    }
+    return out;
+  }
+  if ((in_bpp == 15) && (out_bpp == 16))
+  {
+    out = (char*)g_malloc(width * height * 2, 0);
+    src = bmpdata;
+    dst = out;
+    for (i = 0; i < height; i++)
+    {
+      for (j = 0; j < width; j++)
+      {
+        pixel = *((tui16*)src);
+        SPLITCOLOR15(red, green, blue, pixel);
+        pixel = COLOR16(red, green, blue);
+        *((tui16*)dst) = pixel;
+        src += 2;
+        dst += 2;
+      }
+    }
+    return out;
+  }
+  if ((in_bpp == 15) && (out_bpp == 24))
+  {
+    out = (char*)g_malloc(width * height * 4, 0);
+    src = bmpdata;
+    dst = out;
+    for (i = 0; i < height; i++)
+    {
+      for (j = 0; j < width; j++)
+      {
+        pixel = *((tui16*)src);
+        SPLITCOLOR15(red, green, blue, pixel);
+        pixel = COLOR24RGB(red, green, blue);
+        *((tui32*)dst) = pixel;
+        src += 2;
+        dst += 4;
+      }
+    }
+    return out;
+  }
+  if ((in_bpp == 16) && (out_bpp == 16))
+  {
+    return bmpdata;
+  }
+  if ((in_bpp == 16) && (out_bpp == 24))
+  {
+    out = (char*)g_malloc(width * height * 4, 0);
+    src = bmpdata;
+    dst = out;
+    for (i = 0; i < height; i++)
+    {
+      for (j = 0; j < width; j++)
+      {
+        pixel = *((tui16*)src);
+        SPLITCOLOR16(red, green, blue, pixel);
+        pixel = COLOR24RGB(red, green, blue);
+        *((tui32*)dst) = pixel;
+        src += 2;
+        dst += 4;
+      }
+    }
+    return out;
+  }
+  if ((in_bpp == 24) && (out_bpp == 24))
+  {
+    out = (char*)g_malloc(width * height * 4, 0);
+    src = bmpdata;
+    dst = out;
+    for (i = 0; i < height; i++)
+    {
+      for (j = 0; j < width; j++)
+      {
+        blue = *((tui8*)src);
+        src++;
+        green = *((tui8*)src);
+        src++;
+        red = *((tui8*)src);
+        src++;
+        pixel = COLOR24RGB(red, green, blue);
+        *((tui32*)dst) = pixel;
+        dst += 4;
+      }
+    }
+    return out;
+  }
   return 0;
 }
 
@@ -1366,23 +1474,55 @@ rdp_orders_convert_color(int in_bpp, int out_bpp, int in_color, int* palette)
   int green;
   int blue;
 
-  if (in_bpp == out_bpp && in_bpp == 16)
+  if ((in_bpp == 8) && (out_bpp == 8))
   {
-    return in_color;
+    pixel = palette[in_color];
+    SPLITCOLOR32(red, green, blue, pixel);
+    pixel = COLOR8(red, green, blue);
+    return pixel;
   }
-  if (in_bpp == 8 && out_bpp == 8)
+  if ((in_bpp == 8) && (out_bpp == 16))
   {
     pixel = palette[in_color];
     SPLITCOLOR32(red, green, blue, pixel);
-    pixel = COLOR8(red, green, blue);
+    pixel = COLOR16(red, green, blue);
     return pixel;
   }
-  if (in_bpp == 8 && out_bpp == 16)
+  if ((in_bpp == 8) && (out_bpp == 24))
   {
     pixel = palette[in_color];
     SPLITCOLOR32(red, green, blue, pixel);
+    pixel = COLOR24BGR(red, green, blue);
+    return pixel;
+  }
+  if ((in_bpp == 15) && (out_bpp == 16))
+  {
+    pixel = in_color;
+    SPLITCOLOR15(red, green, blue, pixel);
     pixel = COLOR16(red, green, blue);
     return pixel;
   }
+  if ((in_bpp == 15) && (out_bpp == 24))
+  {
+    pixel = in_color;
+    SPLITCOLOR15(red, green, blue, pixel);
+    pixel = COLOR24BGR(red, green, blue);
+    return pixel;
+  }
+  if ((in_bpp == 16) && (out_bpp == 16))
+  {
+    return in_color;
+  }
+  if ((in_bpp == 16) && (out_bpp == 24))
+  {
+    pixel = in_color;
+    SPLITCOLOR16(red, green, blue, pixel);
+    pixel = COLOR24BGR(red, green, blue);
+    return pixel;
+  }
+  if ((in_bpp == 24) && (out_bpp == 24))
+  {
+    return in_color;
+  }
   return 0;
 }
diff --git a/rdp/rdp_rdp.c b/rdp/rdp_rdp.c
index b870a73..db8bb30 100644
--- a/rdp/rdp_rdp.c
+++ b/rdp/rdp_rdp.c
@@ -14,7 +14,7 @@
    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
 
    xrdp: A Remote Desktop Protocol server.
-   Copyright (C) Jay Sorg 2005-2007
+   Copyright (C) Jay Sorg 2005-2008
 
    librdp rdp layer
 
@@ -563,7 +563,16 @@ rdp_rdp_process_bitmap_updates(struct rdp_rdp* self, struct stream* s)
         {
           for (x = 0; x < width; x++)
           {
-            in_uint16_le(s, ((unsigned short*)data)[x]);
+            in_uint16_le(s, ((tui16*)data)[x]);
+          }
+        }
+        else if (Bpp == 3)
+        {
+          for (x = 0; x < width; x++)
+          {
+            in_uint8(s, data[x * 3 + 0]);
+            in_uint8(s, data[x * 3 + 1]);
+            in_uint8(s, data[x * 3 + 2]);
           }
         }
       }
diff --git a/rdp/rdp_sec.c b/rdp/rdp_sec.c
index 8671fdc..b1b85bf 100644
--- a/rdp/rdp_sec.c
+++ b/rdp/rdp_sec.c
@@ -14,7 +14,7 @@
    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
 
    xrdp: A Remote Desktop Protocol server.
-   Copyright (C) Jay Sorg 2005-2007
+   Copyright (C) Jay Sorg 2005-2008
 
    librdp secure layer
 
diff --git a/rdp/rdp_tcp.c b/rdp/rdp_tcp.c
index 4f81e94..0bc8e9b 100644
--- a/rdp/rdp_tcp.c
+++ b/rdp/rdp_tcp.c
@@ -14,7 +14,7 @@
    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
 
    xrdp: A Remote Desktop Protocol server.
-   Copyright (C) Jay Sorg 2005-2007
+   Copyright (C) Jay Sorg 2005-2008
 
    librdp tcp layer
 
diff --git a/readme.txt b/readme.txt
index 7f77981..8750f24 100644
--- a/readme.txt
+++ b/readme.txt
@@ -1,5 +1,5 @@
 
-xrdp 0.4.1
+xrdp 0.5.0
 
 Credits
   This project is very much dependent on rdesktop and the work of Matt Chapman
diff --git a/sesman/Makefile b/sesman/Makefile
index 9e3cb4a..71fee0f 100644
--- a/sesman/Makefile
+++ b/sesman/Makefile
@@ -1,82 +1,685 @@
-# sesman makefile
+# Makefile.in generated by automake 1.10.1 from Makefile.am.
+# sesman/Makefile.  Generated from Makefile.in by configure.
 
-SESMANOBJ = sesman.o config.o sig.o session.o env.o \
-            os_calls.o d3des.o list.o file.o log.o access.o \
-            scp.o scp_v0.o scp_v1.o thread.o lock.o
+# Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
+# 2003, 2004, 2005, 2006, 2007, 2008  Free Software Foundation, Inc.
+# This Makefile.in is free software; the Free Software Foundation
+# gives unlimited permission to copy and/or distribute it,
+# with or without modifications, as long as this notice is preserved.
 
-SESSVCOBJ = sessvc.o os_calls.o
+# This program is distributed in the hope that it will be useful,
+# but WITHOUT ANY WARRANTY, to the extent permitted by law; without
+# even the implied warranty of MERCHANTABILITY or FITNESS FOR A
+# PARTICULAR PURPOSE.
 
-DESTDIR = /usr/local/xrdp
-CFGDIR = /etc/xrdp
-PIDDIR = /var/run
-MANDIR = /usr/local/man
-DOCDIR = /usr/doc/xrdp
 
-DEFINES = -DSESMAN_CFG_FILE=\"$(CFGDIR)/sesman.ini\" \
-	  -DSESMAN_PID_FILE=\"$(PIDDIR)/sesman.pid\" \
-	  -DSESMAN_SESSVC_FILE=\"sessvc\"
 
-CFLAGS = -Wall -O2 -I../common -I/usr/include/nptl -I./libscp $(DEFINES)
-LDFLAGS = -L/usr/gnu/lib -L/usr/lib/nptl -L./libscp -Wl,-rpath,. -lpthread -ldl -lscp
-C_OS_FLAGS = $(CFLAGS) -c
+
+
+pkgdatadir = $(datadir)/xrdp
+pkglibdir = $(libdir)/xrdp
+pkgincludedir = $(includedir)/xrdp
+am__cd = CDPATH="$${ZSH_VERSION+.}$(PATH_SEPARATOR)" && cd
+install_sh_DATA = $(install_sh) -c -m 644
+install_sh_PROGRAM = $(install_sh) -c
+install_sh_SCRIPT = $(install_sh) -c
+INSTALL_HEADER = $(INSTALL_DATA)
+transform = $(program_transform_name)
+NORMAL_INSTALL = :
+PRE_INSTALL = :
+POST_INSTALL = :
+NORMAL_UNINSTALL = :
+PRE_UNINSTALL = :
+POST_UNINSTALL = :
+build_triplet = i686-suse-linux-gnu
+host_triplet = i686-suse-linux-gnu
+sbin_PROGRAMS = xrdp-sesman$(EXEEXT) xrdp-sessvc$(EXEEXT)
+subdir = sesman
+DIST_COMMON = $(srcdir)/Makefile.am $(srcdir)/Makefile.in
+ACLOCAL_M4 = $(top_srcdir)/aclocal.m4
+am__aclocal_m4_deps = $(top_srcdir)/configure.ac
+am__configure_deps = $(am__aclocal_m4_deps) $(CONFIGURE_DEPENDENCIES) \
+	$(ACLOCAL_M4)
+mkinstalldirs = $(install_sh) -d
+CONFIG_HEADER = $(top_builddir)/config_ac.h
+CONFIG_CLEAN_FILES =
+am__installdirs = "$(DESTDIR)$(sbindir)" \
+	"$(DESTDIR)$(sesmansysconfdir)"
+sbinPROGRAMS_INSTALL = $(INSTALL_PROGRAM)
+PROGRAMS = $(sbin_PROGRAMS)
+am__xrdp_sesman_SOURCES_DIST = scp.c scp_v0.c scp_v1.c sesman.c \
+	session.c sig.c thread.c lock.c access.c config.c env.c \
+	verify_user_pam.c verify_user_kerberos.c \
+	verify_user_pam_userpass.c verify_user.c
+am__objects_1 = verify_user_pam.$(OBJEXT)
+#am__objects_1 = verify_user_kerberos.$(OBJEXT)
+#am__objects_1 = verify_user_pam_userpass.$(OBJEXT)
+#am__objects_1 = verify_user.$(OBJEXT)
+am_xrdp_sesman_OBJECTS = scp.$(OBJEXT) scp_v0.$(OBJEXT) \
+	scp_v1.$(OBJEXT) sesman.$(OBJEXT) session.$(OBJEXT) \
+	sig.$(OBJEXT) thread.$(OBJEXT) lock.$(OBJEXT) access.$(OBJEXT) \
+	config.$(OBJEXT) env.$(OBJEXT) $(am__objects_1)
+xrdp_sesman_OBJECTS = $(am_xrdp_sesman_OBJECTS)
+am__DEPENDENCIES_1 =
+xrdp_sesman_DEPENDENCIES = $(top_srcdir)/common/libcommon.la \
+	$(top_srcdir)/sesman/libscp/libscp.la $(am__DEPENDENCIES_1)
+am_xrdp_sessvc_OBJECTS = sessvc.$(OBJEXT)
+xrdp_sessvc_OBJECTS = $(am_xrdp_sessvc_OBJECTS)
+xrdp_sessvc_DEPENDENCIES = $(top_srcdir)/common/libcommon.la
+DEFAULT_INCLUDES = -I. -I$(top_builddir)
+depcomp = $(SHELL) $(top_srcdir)/depcomp
+am__depfiles_maybe = depfiles
+COMPILE = $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) \
+	$(CPPFLAGS) $(AM_CFLAGS) $(CFLAGS)
+LTCOMPILE = $(LIBTOOL) --tag=CC $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) \
+	--mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) \
+	$(AM_CPPFLAGS) $(CPPFLAGS) $(AM_CFLAGS) $(CFLAGS)
+CCLD = $(CC)
+LINK = $(LIBTOOL) --tag=CC $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) \
+	--mode=link $(CCLD) $(AM_CFLAGS) $(CFLAGS) $(AM_LDFLAGS) \
+	$(LDFLAGS) -o $@
+SOURCES = $(xrdp_sesman_SOURCES) $(xrdp_sessvc_SOURCES)
+DIST_SOURCES = $(am__xrdp_sesman_SOURCES_DIST) $(xrdp_sessvc_SOURCES)
+RECURSIVE_TARGETS = all-recursive check-recursive dvi-recursive \
+	html-recursive info-recursive install-data-recursive \
+	install-dvi-recursive install-exec-recursive \
+	install-html-recursive install-info-recursive \
+	install-pdf-recursive install-ps-recursive install-recursive \
+	installcheck-recursive installdirs-recursive pdf-recursive \
+	ps-recursive uninstall-recursive
+am__vpath_adj_setup = srcdirstrip=`echo "$(srcdir)" | sed 's|.|.|g'`;
+am__vpath_adj = case $$p in \
+    $(srcdir)/*) f=`echo "$$p" | sed "s|^$$srcdirstrip/||"`;; \
+    *) f=$$p;; \
+  esac;
+am__strip_dir = `echo $$p | sed -e 's|^.*/||'`;
+sesmansysconfDATA_INSTALL = $(INSTALL_DATA)
+DATA = $(sesmansysconf_DATA)
+RECURSIVE_CLEAN_TARGETS = mostlyclean-recursive clean-recursive	\
+  distclean-recursive maintainer-clean-recursive
+ETAGS = etags
+CTAGS = ctags
+DIST_SUBDIRS = $(SUBDIRS)
+DISTFILES = $(DIST_COMMON) $(DIST_SOURCES) $(TEXINFOS) $(EXTRA_DIST)
+ACLOCAL = ${SHELL} /home/david/git/xrdp/missing --run aclocal-1.10
+AMTAR = ${SHELL} /home/david/git/xrdp/missing --run tar
+AR = ar
+AUTOCONF = ${SHELL} /home/david/git/xrdp/missing --run autoconf
+AUTOHEADER = ${SHELL} /home/david/git/xrdp/missing --run autoheader
+AUTOMAKE = ${SHELL} /home/david/git/xrdp/missing --run automake-1.10
+AWK = gawk
 CC = gcc
+CCDEPMODE = depmode=gcc3
+CFLAGS = -g -O2
+CPP = gcc -E
+CPPFLAGS = 
+CXX = g++
+CXXCPP = g++ -E
+CXXDEPMODE = depmode=gcc3
+CXXFLAGS = -g -O2
+CYGPATH_W = echo
+DEFS = -DHAVE_CONFIG_H
+DEPDIR = .deps
+DSYMUTIL = 
+ECHO = echo
+ECHO_C = 
+ECHO_N = -n
+ECHO_T = 
+EGREP = /usr/bin/grep -E
+EXEEXT = 
+F77 = 
+FFLAGS = 
+GREP = /usr/bin/grep
+INSTALL = /usr/bin/install -c
+INSTALL_DATA = ${INSTALL} -m 644
+INSTALL_PROGRAM = ${INSTALL}
+INSTALL_SCRIPT = ${INSTALL}
+INSTALL_STRIP_PROGRAM = $(install_sh) -c -s
+LDFLAGS = 
+LIBOBJS = 
+LIBS = 
+LIBTOOL = $(SHELL) $(top_builddir)/libtool
+LN_S = ln -s
+LTLIBOBJS = 
+MAKEINFO = ${SHELL} /home/david/git/xrdp/missing --run makeinfo
+MKDIR_P = /bin/mkdir -p
+NMEDIT = 
+OBJEXT = o
+PACKAGE = xrdp
+PACKAGE_BUGREPORT = xrdp-devel@lists.sourceforge.net
+PACKAGE_NAME = xrdp
+PACKAGE_STRING = xrdp 0.5.0
+PACKAGE_TARNAME = xrdp
+PACKAGE_VERSION = 0.5.0
+PATH_SEPARATOR = :
+RANLIB = ranlib
+SED = /usr/bin/sed
+SET_MAKE = 
+SHELL = /bin/sh
+STRIP = strip
+VERSION = 0.5.0
+abs_builddir = /home/david/git/xrdp/sesman
+abs_srcdir = /home/david/git/xrdp/sesman
+abs_top_builddir = /home/david/git/xrdp
+abs_top_srcdir = /home/david/git/xrdp
+ac_ct_CC = gcc
+ac_ct_CXX = g++
+ac_ct_F77 = 
+am__include = include
+am__leading_dot = .
+am__quote = 
+am__tar = ${AMTAR} chof - "$$tardir"
+am__untar = ${AMTAR} xf -
+bindir = ${exec_prefix}/bin
+build = i686-suse-linux-gnu
+build_alias = 
+build_cpu = i686
+build_os = linux-gnu
+build_vendor = suse
+builddir = .
+datadir = ${datarootdir}
+datarootdir = ${prefix}/share
+docdir = ${datarootdir}/doc/${PACKAGE_TARNAME}
+dvidir = ${docdir}
+exec_prefix = ${prefix}
+host = i686-suse-linux-gnu
+host_alias = 
+host_cpu = i686
+host_os = linux-gnu
+host_vendor = suse
+htmldir = ${docdir}
+includedir = ${prefix}/include
+infodir = ${datarootdir}/info
+install_sh = $(SHELL) /home/david/git/xrdp/install-sh
+libdir = ${exec_prefix}/lib/xrdp/
+libexecdir = ${exec_prefix}/libexec
+localedir = ${datarootdir}/locale
+localstatedir = ${prefix}/var
+mandir = ${datarootdir}/man
+mkdir_p = /bin/mkdir -p
+oldincludedir = /usr/include
+pdfdir = ${docdir}
+prefix = /usr
+program_transform_name = s,x,x,
+psdir = ${docdir}
+sbindir = ${exec_prefix}/sbin
+sharedstatedir = ${prefix}/com
+srcdir = .
+sysconfdir = ${prefix}/etc
+target_alias = 
+top_builddir = ..
+top_srcdir = ..
+INCLUDES = \
+  -I$(top_srcdir)/common \
+  -I$(top_srcdir)/sesman/libscp
+
+AUTH_C = verify_user_pam.c
+#AUTH_C = verify_user_kerberos.c
+#AUTH_C = verify_user_pam_userpass.c
+#AUTH_C = verify_user.c
+AUTH_LIB = -lpam
+#AUTH_LIB = -lkrb5
+#AUTH_LIB = -lpam -lpam_userpass
+#AUTH_LIB = -lcrypt
+xrdp_sesman_SOURCES = \
+  scp.c \
+  scp_v0.c \
+  scp_v1.c \
+  sesman.c \
+  session.c \
+  sig.c \
+  thread.c \
+  lock.c \
+  access.c \
+  config.c \
+  env.c \
+  $(AUTH_C)
+
+xrdp_sessvc_SOURCES = \
+  sessvc.c
+
+xrdp_sesman_LDADD = \
+  $(top_srcdir)/common/libcommon.la \
+  $(top_srcdir)/sesman/libscp/libscp.la \
+  $(AUTH_LIB)
+
+xrdp_sessvc_LDADD = \
+  $(top_srcdir)/common/libcommon.la
+
+sesmansysconfdir = $(sysconfdir)/xrdp
+sesmansysconf_DATA = \
+  sesman.ini \
+  startwm.sh
+
+SUBDIRS = \
+  libscp \
+  tools
+
+all: all-recursive
+
+.SUFFIXES:
+.SUFFIXES: .c .lo .o .obj
+$(srcdir)/Makefile.in:  $(srcdir)/Makefile.am  $(am__configure_deps)
+	@for dep in $?; do \
+	  case '$(am__configure_deps)' in \
+	    *$$dep*) \
+	      cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh \
+		&& exit 0; \
+	      exit 1;; \
+	  esac; \
+	done; \
+	echo ' cd $(top_srcdir) && $(AUTOMAKE) --foreign  sesman/Makefile'; \
+	cd $(top_srcdir) && \
+	  $(AUTOMAKE) --foreign  sesman/Makefile
+.PRECIOUS: Makefile
+Makefile: $(srcdir)/Makefile.in $(top_builddir)/config.status
+	@case '$?' in \
+	  *config.status*) \
+	    cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh;; \
+	  *) \
+	    echo ' cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe)'; \
+	    cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe);; \
+	esac;
+
+$(top_builddir)/config.status: $(top_srcdir)/configure $(CONFIG_STATUS_DEPENDENCIES)
+	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
+
+$(top_srcdir)/configure:  $(am__configure_deps)
+	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
+$(ACLOCAL_M4):  $(am__aclocal_m4_deps)
+	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
+install-sbinPROGRAMS: $(sbin_PROGRAMS)
+	@$(NORMAL_INSTALL)
+	test -z "$(sbindir)" || $(MKDIR_P) "$(DESTDIR)$(sbindir)"
+	@list='$(sbin_PROGRAMS)'; for p in $$list; do \
+	  p1=`echo $$p|sed 's/$(EXEEXT)$$//'`; \
+	  if test -f $$p \
+	     || test -f $$p1 \
+	  ; then \
+	    f=`echo "$$p1" | sed 's,^.*/,,;$(transform);s/$$/$(EXEEXT)/'`; \
+	   echo " $(INSTALL_PROGRAM_ENV) $(LIBTOOL) $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=install $(sbinPROGRAMS_INSTALL) '$$p' '$(DESTDIR)$(sbindir)/$$f'"; \
+	   $(INSTALL_PROGRAM_ENV) $(LIBTOOL) $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=install $(sbinPROGRAMS_INSTALL) "$$p" "$(DESTDIR)$(sbindir)/$$f" || exit 1; \
+	  else :; fi; \
+	done
+
+uninstall-sbinPROGRAMS:
+	@$(NORMAL_UNINSTALL)
+	@list='$(sbin_PROGRAMS)'; for p in $$list; do \
+	  f=`echo "$$p" | sed 's,^.*/,,;s/$(EXEEXT)$$//;$(transform);s/$$/$(EXEEXT)/'`; \
+	  echo " rm -f '$(DESTDIR)$(sbindir)/$$f'"; \
+	  rm -f "$(DESTDIR)$(sbindir)/$$f"; \
+	done
+
+clean-sbinPROGRAMS:
+	@list='$(sbin_PROGRAMS)'; for p in $$list; do \
+	  f=`echo $$p|sed 's/$(EXEEXT)$$//'`; \
+	  echo " rm -f $$p $$f"; \
+	  rm -f $$p $$f ; \
+	done
+xrdp-sesman$(EXEEXT): $(xrdp_sesman_OBJECTS) $(xrdp_sesman_DEPENDENCIES) 
+	@rm -f xrdp-sesman$(EXEEXT)
+	$(LINK) $(xrdp_sesman_OBJECTS) $(xrdp_sesman_LDADD) $(LIBS)
+xrdp-sessvc$(EXEEXT): $(xrdp_sessvc_OBJECTS) $(xrdp_sessvc_DEPENDENCIES) 
+	@rm -f xrdp-sessvc$(EXEEXT)
+	$(LINK) $(xrdp_sessvc_OBJECTS) $(xrdp_sessvc_LDADD) $(LIBS)
+
+mostlyclean-compile:
+	-rm -f *.$(OBJEXT)
+
+distclean-compile:
+	-rm -f *.tab.c
+
+include ./$(DEPDIR)/access.Po
+include ./$(DEPDIR)/config.Po
+include ./$(DEPDIR)/env.Po
+include ./$(DEPDIR)/lock.Po
+include ./$(DEPDIR)/scp.Po
+include ./$(DEPDIR)/scp_v0.Po
+include ./$(DEPDIR)/scp_v1.Po
+include ./$(DEPDIR)/sesman.Po
+include ./$(DEPDIR)/session.Po
+include ./$(DEPDIR)/sessvc.Po
+include ./$(DEPDIR)/sig.Po
+include ./$(DEPDIR)/thread.Po
+include ./$(DEPDIR)/verify_user.Po
+include ./$(DEPDIR)/verify_user_kerberos.Po
+include ./$(DEPDIR)/verify_user_pam.Po
+include ./$(DEPDIR)/verify_user_pam_userpass.Po
+
+.c.o:
+	$(COMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ $<
+	mv -f $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Po
+#	source='$<' object='$@' libtool=no \
+#	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) \
+#	$(COMPILE) -c $<
+
+.c.obj:
+	$(COMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ `$(CYGPATH_W) '$<'`
+	mv -f $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Po
+#	source='$<' object='$@' libtool=no \
+#	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) \
+#	$(COMPILE) -c `$(CYGPATH_W) '$<'`
+
+.c.lo:
+	$(LTCOMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ $<
+	mv -f $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Plo
+#	source='$<' object='$@' libtool=yes \
+#	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) \
+#	$(LTCOMPILE) -c -o $@ $<
+
+mostlyclean-libtool:
+	-rm -f *.lo
+
+clean-libtool:
+	-rm -rf .libs _libs
+install-sesmansysconfDATA: $(sesmansysconf_DATA)
+	@$(NORMAL_INSTALL)
+	test -z "$(sesmansysconfdir)" || $(MKDIR_P) "$(DESTDIR)$(sesmansysconfdir)"
+	@list='$(sesmansysconf_DATA)'; for p in $$list; do \
+	  if test -f "$$p"; then d=; else d="$(srcdir)/"; fi; \
+	  f=$(am__strip_dir) \
+	  echo " $(sesmansysconfDATA_INSTALL) '$$d$$p' '$(DESTDIR)$(sesmansysconfdir)/$$f'"; \
+	  $(sesmansysconfDATA_INSTALL) "$$d$$p" "$(DESTDIR)$(sesmansysconfdir)/$$f"; \
+	done
+
+uninstall-sesmansysconfDATA:
+	@$(NORMAL_UNINSTALL)
+	@list='$(sesmansysconf_DATA)'; for p in $$list; do \
+	  f=$(am__strip_dir) \
+	  echo " rm -f '$(DESTDIR)$(sesmansysconfdir)/$$f'"; \
+	  rm -f "$(DESTDIR)$(sesmansysconfdir)/$$f"; \
+	done
+
+# This directory's subdirectories are mostly independent; you can cd
+# into them and run `make' without going through this Makefile.
+# To change the values of `make' variables: instead of editing Makefiles,
+# (1) if the variable is set in `config.status', edit `config.status'
+#     (which will cause the Makefiles to be regenerated when you run `make');
+# (2) otherwise, pass the desired values on the `make' command line.
+$(RECURSIVE_TARGETS):
+	@failcom='exit 1'; \
+	for f in x $$MAKEFLAGS; do \
+	  case $$f in \
+	    *=* | --[!k]*);; \
+	    *k*) failcom='fail=yes';; \
+	  esac; \
+	done; \
+	dot_seen=no; \
+	target=`echo $@ | sed s/-recursive//`; \
+	list='$(SUBDIRS)'; for subdir in $$list; do \
+	  echo "Making $$target in $$subdir"; \
+	  if test "$$subdir" = "."; then \
+	    dot_seen=yes; \
+	    local_target="$$target-am"; \
+	  else \
+	    local_target="$$target"; \
+	  fi; \
+	  (cd $$subdir && $(MAKE) $(AM_MAKEFLAGS) $$local_target) \
+	  || eval $$failcom; \
+	done; \
+	if test "$$dot_seen" = "no"; then \
+	  $(MAKE) $(AM_MAKEFLAGS) "$$target-am" || exit 1; \
+	fi; test -z "$$fail"
+
+$(RECURSIVE_CLEAN_TARGETS):
+	@failcom='exit 1'; \
+	for f in x $$MAKEFLAGS; do \
+	  case $$f in \
+	    *=* | --[!k]*);; \
+	    *k*) failcom='fail=yes';; \
+	  esac; \
+	done; \
+	dot_seen=no; \
+	case "$@" in \
+	  distclean-* | maintainer-clean-*) list='$(DIST_SUBDIRS)' ;; \
+	  *) list='$(SUBDIRS)' ;; \
+	esac; \
+	rev=''; for subdir in $$list; do \
+	  if test "$$subdir" = "."; then :; else \
+	    rev="$$subdir $$rev"; \
+	  fi; \
+	done; \
+	rev="$$rev ."; \
+	target=`echo $@ | sed s/-recursive//`; \
+	for subdir in $$rev; do \
+	  echo "Making $$target in $$subdir"; \
+	  if test "$$subdir" = "."; then \
+	    local_target="$$target-am"; \
+	  else \
+	    local_target="$$target"; \
+	  fi; \
+	  (cd $$subdir && $(MAKE) $(AM_MAKEFLAGS) $$local_target) \
+	  || eval $$failcom; \
+	done && test -z "$$fail"
+tags-recursive:
+	list='$(SUBDIRS)'; for subdir in $$list; do \
+	  test "$$subdir" = . || (cd $$subdir && $(MAKE) $(AM_MAKEFLAGS) tags); \
+	done
+ctags-recursive:
+	list='$(SUBDIRS)'; for subdir in $$list; do \
+	  test "$$subdir" = . || (cd $$subdir && $(MAKE) $(AM_MAKEFLAGS) ctags); \
+	done
+
+ID: $(HEADERS) $(SOURCES) $(LISP) $(TAGS_FILES)
+	list='$(SOURCES) $(HEADERS) $(LISP) $(TAGS_FILES)'; \
+	unique=`for i in $$list; do \
+	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
+	  done | \
+	  $(AWK) '{ files[$$0] = 1; nonemtpy = 1; } \
+	      END { if (nonempty) { for (i in files) print i; }; }'`; \
+	mkid -fID $$unique
+tags: TAGS
+
+TAGS: tags-recursive $(HEADERS) $(SOURCES)  $(TAGS_DEPENDENCIES) \
+		$(TAGS_FILES) $(LISP)
+	tags=; \
+	here=`pwd`; \
+	if ($(ETAGS) --etags-include --version) >/dev/null 2>&1; then \
+	  include_option=--etags-include; \
+	  empty_fix=.; \
+	else \
+	  include_option=--include; \
+	  empty_fix=; \
+	fi; \
+	list='$(SUBDIRS)'; for subdir in $$list; do \
+	  if test "$$subdir" = .; then :; else \
+	    test ! -f $$subdir/TAGS || \
+	      tags="$$tags $$include_option=$$here/$$subdir/TAGS"; \
+	  fi; \
+	done; \
+	list='$(SOURCES) $(HEADERS)  $(LISP) $(TAGS_FILES)'; \
+	unique=`for i in $$list; do \
+	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
+	  done | \
+	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
+	      END { if (nonempty) { for (i in files) print i; }; }'`; \
+	if test -z "$(ETAGS_ARGS)$$tags$$unique"; then :; else \
+	  test -n "$$unique" || unique=$$empty_fix; \
+	  $(ETAGS) $(ETAGSFLAGS) $(AM_ETAGSFLAGS) $(ETAGS_ARGS) \
+	    $$tags $$unique; \
+	fi
+ctags: CTAGS
+CTAGS: ctags-recursive $(HEADERS) $(SOURCES)  $(TAGS_DEPENDENCIES) \
+		$(TAGS_FILES) $(LISP)
+	tags=; \
+	list='$(SOURCES) $(HEADERS)  $(LISP) $(TAGS_FILES)'; \
+	unique=`for i in $$list; do \
+	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
+	  done | \
+	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
+	      END { if (nonempty) { for (i in files) print i; }; }'`; \
+	test -z "$(CTAGS_ARGS)$$tags$$unique" \
+	  || $(CTAGS) $(CTAGSFLAGS) $(AM_CTAGSFLAGS) $(CTAGS_ARGS) \
+	     $$tags $$unique
+
+GTAGS:
+	here=`$(am__cd) $(top_builddir) && pwd` \
+	  && cd $(top_srcdir) \
+	  && gtags -i $(GTAGS_ARGS) $$here
+
+distclean-tags:
+	-rm -f TAGS ID GTAGS GRTAGS GSYMS GPATH tags
+
+distdir: $(DISTFILES)
+	@srcdirstrip=`echo "$(srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
+	topsrcdirstrip=`echo "$(top_srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
+	list='$(DISTFILES)'; \
+	  dist_files=`for file in $$list; do echo $$file; done | \
+	  sed -e "s|^$$srcdirstrip/||;t" \
+	      -e "s|^$$topsrcdirstrip/|$(top_builddir)/|;t"`; \
+	case $$dist_files in \
+	  */*) $(MKDIR_P) `echo "$$dist_files" | \
+			   sed '/\//!d;s|^|$(distdir)/|;s,/[^/]*$$,,' | \
+			   sort -u` ;; \
+	esac; \
+	for file in $$dist_files; do \
+	  if test -f $$file || test -d $$file; then d=.; else d=$(srcdir); fi; \
+	  if test -d $$d/$$file; then \
+	    dir=`echo "/$$file" | sed -e 's,/[^/]*$$,,'`; \
+	    if test -d $(srcdir)/$$file && test $$d != $(srcdir); then \
+	      cp -pR $(srcdir)/$$file $(distdir)$$dir || exit 1; \
+	    fi; \
+	    cp -pR $$d/$$file $(distdir)$$dir || exit 1; \
+	  else \
+	    test -f $(distdir)/$$file \
+	    || cp -p $$d/$$file $(distdir)/$$file \
+	    || exit 1; \
+	  fi; \
+	done
+	list='$(DIST_SUBDIRS)'; for subdir in $$list; do \
+	  if test "$$subdir" = .; then :; else \
+	    test -d "$(distdir)/$$subdir" \
+	    || $(MKDIR_P) "$(distdir)/$$subdir" \
+	    || exit 1; \
+	    distdir=`$(am__cd) $(distdir) && pwd`; \
+	    top_distdir=`$(am__cd) $(top_distdir) && pwd`; \
+	    (cd $$subdir && \
+	      $(MAKE) $(AM_MAKEFLAGS) \
+	        top_distdir="$$top_distdir" \
+	        distdir="$$distdir/$$subdir" \
+		am__remove_distdir=: \
+		am__skip_length_check=: \
+	        distdir) \
+	      || exit 1; \
+	  fi; \
+	done
+check-am: all-am
+check: check-recursive
+all-am: Makefile $(PROGRAMS) $(DATA)
+installdirs: installdirs-recursive
+installdirs-am:
+	for dir in "$(DESTDIR)$(sbindir)" "$(DESTDIR)$(sesmansysconfdir)"; do \
+	  test -z "$$dir" || $(MKDIR_P) "$$dir"; \
+	done
+install: install-recursive
+install-exec: install-exec-recursive
+install-data: install-data-recursive
+uninstall: uninstall-recursive
+
+install-am: all-am
+	@$(MAKE) $(AM_MAKEFLAGS) install-exec-am install-data-am
+
+installcheck: installcheck-recursive
+install-strip:
+	$(MAKE) $(AM_MAKEFLAGS) INSTALL_PROGRAM="$(INSTALL_STRIP_PROGRAM)" \
+	  install_sh_PROGRAM="$(INSTALL_STRIP_PROGRAM)" INSTALL_STRIP_FLAG=-s \
+	  `test -z '$(STRIP)' || \
+	    echo "INSTALL_PROGRAM_ENV=STRIPPROG='$(STRIP)'"` install
+mostlyclean-generic:
+
+clean-generic:
+
+distclean-generic:
+	-test -z "$(CONFIG_CLEAN_FILES)" || rm -f $(CONFIG_CLEAN_FILES)
+
+maintainer-clean-generic:
+	@echo "This command is intended for maintainers to use"
+	@echo "it deletes files that may require special tools to rebuild."
+clean: clean-recursive
+
+clean-am: clean-generic clean-libtool clean-sbinPROGRAMS \
+	mostlyclean-am
+
+distclean: distclean-recursive
+	-rm -rf ./$(DEPDIR)
+	-rm -f Makefile
+distclean-am: clean-am distclean-compile distclean-generic \
+	distclean-tags
+
+dvi: dvi-recursive
+
+dvi-am:
+
+html: html-recursive
+
+info: info-recursive
+
+info-am:
+
+install-data-am: install-sesmansysconfDATA
+	@$(NORMAL_INSTALL)
+	$(MAKE) $(AM_MAKEFLAGS) install-data-hook
+
+install-dvi: install-dvi-recursive
+
+install-exec-am: install-sbinPROGRAMS
 
-all: libscp_ pam tools
+install-html: install-html-recursive
 
-nopam: libscp_ no-pam tools
+install-info: install-info-recursive
 
-kerberos: libscp_ kerberos-base tools
+install-man:
 
-no-pam: $(SESMANOBJ) verify_user.o
-	$(CC) $(LDFLAGS) -o sesman $(SESMANOBJ) verify_user.o -lcrypt
+install-pdf: install-pdf-recursive
 
-pam: $(SESMANOBJ) verify_user_pam.o
-	$(CC) $(LDFLAGS) -o sesman $(SESMANOBJ) verify_user_pam.o -lpam
+install-ps: install-ps-recursive
 
-pam_userpass: $(SESMANOBJ) verify_user_pam_userpass.o
-	$(CC) $(LDFLAGS) -o sesman $(SESMANOBJ) verify_user_pam_userpass.o -lpam -lpam_userpass
+installcheck-am:
 
-kerberos-base: $(SESMANOBJ) verify_user_kerberos.o
-	$(CC) $(LDFLAGS) -o sesman $(SESMANOBJ) verify_user_kerberos.o -lkrb5
+maintainer-clean: maintainer-clean-recursive
+	-rm -rf ./$(DEPDIR)
+	-rm -f Makefile
+maintainer-clean-am: distclean-am maintainer-clean-generic
 
-sessvc: $(SESSVCOBJ)
-	$(CC) $(LDFLAGS) -o sessvc $(SESSVCOBJ) 
+mostlyclean: mostlyclean-recursive
 
-tools: sessvc
-	make -C tools
+mostlyclean-am: mostlyclean-compile mostlyclean-generic \
+	mostlyclean-libtool
 
-libscp_:
-	make -C libscp
+pdf: pdf-recursive
 
-clean:
-	rm -f $(SESMANOBJ) verify_user.o verify_user_pam.o verify_user_pam_userpass.o sesman sesrun.o sesrun sessvc.o sessvc
-	make -C tools clean
-	make -C libscp clean
+pdf-am:
 
-install:
-	install sesman $(DESTDIR)/sesman
-	install startwm.sh $(DESTDIR)/startwm.sh
-	install sesman.ini $(CFGDIR)/sesman.ini
-	install sessvc $(DESTDIR)/sessvc
-	make -C tools install
-	make -C libscp install
+ps: ps-recursive
 
-installdeb:
-	install sesman $(DESTDIRDEB)/usr/lib/xrdp/sesman
-	install startwm.sh $(DESTDIRDEB)/usr/lib/xrdp/startwm.sh
-	install sesman.ini $(DESTDIRDEB)/etc/xrdp/sesman.ini
+ps-am:
 
-os_calls.o: ../common/os_calls.c
-	$(CC) $(C_OS_FLAGS) ../common/os_calls.c
+uninstall-am: uninstall-sbinPROGRAMS uninstall-sesmansysconfDATA
 
-d3des.o: ../common/d3des.c
-	$(CC) $(C_OS_FLAGS) ../common/d3des.c
+.MAKE: $(RECURSIVE_CLEAN_TARGETS) $(RECURSIVE_TARGETS) install-am \
+	install-data-am install-strip
 
-list.o: ../common/list.c
-	$(CC) $(C_OS_FLAGS) ../common/list.c
+.PHONY: $(RECURSIVE_CLEAN_TARGETS) $(RECURSIVE_TARGETS) CTAGS GTAGS \
+	all all-am check check-am clean clean-generic clean-libtool \
+	clean-sbinPROGRAMS ctags ctags-recursive distclean \
+	distclean-compile distclean-generic distclean-libtool \
+	distclean-tags distdir dvi dvi-am html html-am info info-am \
+	install install-am install-data install-data-am \
+	install-data-hook install-dvi install-dvi-am install-exec \
+	install-exec-am install-html install-html-am install-info \
+	install-info-am install-man install-pdf install-pdf-am \
+	install-ps install-ps-am install-sbinPROGRAMS \
+	install-sesmansysconfDATA install-strip installcheck \
+	installcheck-am installdirs installdirs-am maintainer-clean \
+	maintainer-clean-generic mostlyclean mostlyclean-compile \
+	mostlyclean-generic mostlyclean-libtool pdf pdf-am ps ps-am \
+	tags tags-recursive uninstall uninstall-am \
+	uninstall-sbinPROGRAMS uninstall-sesmansysconfDATA
 
-file.o: ../common/file.c
-	$(CC) $(C_OS_FLAGS) ../common/file.c
 
-log.o: ../common/log.c
-	$(CC) $(C_OS_FLAGS) -DLOG_ENABLE_THREAD ../common/log.c
+# must be tab below
+install-data-hook:
+	chmod 755 $(DESTDIR)$(sysconfdir)/xrdp/startwm.sh
+# Tell versions [3.59,3.63) of GNU make to not export all variables.
+# Otherwise a system limit (for SysV at least) may be exceeded.
+.NOEXPORT:
diff --git a/sesman/Makefile.am b/sesman/Makefile.am
new file mode 100644
index 0000000..22736e6
--- /dev/null
+++ b/sesman/Makefile.am
@@ -0,0 +1,64 @@
+INCLUDES = \
+  -I$(top_srcdir)/common \
+  -I$(top_srcdir)/sesman/libscp
+
+if SESMAN_NOPAM
+AUTH_C = verify_user.c
+AUTH_LIB = -lcrypt
+else
+if SESMAN_PAMUSERPASS
+AUTH_C = verify_user_pam_userpass.c
+AUTH_LIB = -lpam -lpam_userpass
+else
+if SESMAN_KERBEROS
+AUTH_C = verify_user_kerberos.c
+AUTH_LIB = -lkrb5
+else
+AUTH_C = verify_user_pam.c
+AUTH_LIB = -lpam
+endif
+endif
+endif
+
+sbin_PROGRAMS = \
+  xrdp-sesman \
+  xrdp-sessvc
+
+xrdp_sesman_SOURCES = \
+  scp.c \
+  scp_v0.c \
+  scp_v1.c \
+  sesman.c \
+  session.c \
+  sig.c \
+  thread.c \
+  lock.c \
+  access.c \
+  config.c \
+  env.c \
+  $(AUTH_C)
+
+xrdp_sessvc_SOURCES = \
+  sessvc.c
+
+xrdp_sesman_LDADD = \
+  $(top_srcdir)/common/libcommon.la \
+  $(top_srcdir)/sesman/libscp/libscp.la \
+  $(AUTH_LIB)
+
+xrdp_sessvc_LDADD = \
+  $(top_srcdir)/common/libcommon.la
+
+sesmansysconfdir=$(sysconfdir)/xrdp
+
+sesmansysconf_DATA = \
+  sesman.ini \
+  startwm.sh
+
+SUBDIRS = \
+  libscp \
+  tools
+
+# must be tab below
+install-data-hook:
+	chmod 755 $(DESTDIR)$(sysconfdir)/xrdp/startwm.sh
diff --git a/sesman/Makefile.osx b/sesman/Makefile.osx
new file mode 100644
index 0000000..5e0b725
--- /dev/null
+++ b/sesman/Makefile.osx
@@ -0,0 +1,77 @@
+# sesman $(MAKE)file
+
+SESMANOBJ = sesman.o config.o sig.o session.o env.o \
+            os_calls.o d3des.o list.o file.o log.o access.o \
+            scp.o scp_v0.o scp_v1.o thread.o lock.o
+
+SESSVCOBJ = sessvc.o os_calls.o
+
+DESTDIR = /usr/local/xrdp
+CFGDIR = /etc/xrdp
+PIDDIR = /var/run
+MANDIR = /usr/local/man
+DOCDIR = /usr/doc/xrdp
+
+DEFINES = -DSESMAN_CFG_FILE=\"$(CFGDIR)/sesman.ini\" \
+         -DSESMAN_PID_FILE=\"$(PIDDIR)/sesman.pid\"
+
+CFLAGS = -Wall -O2 -I../common -I/usr/include/nptl -I./libscp $(DEFINES)
+LDFLAGS = -L./libscp -lpthread -ldl -lscp
+C_OS_FLAGS = $(CFLAGS) -c
+CC = gcc
+
+all: libscp_ pam tools
+
+nopam: libscp_ no-pam tools
+
+kerberos: libscp_ kerberos-base tools
+
+no-pam: $(SESMANOBJ) verify_user.o
+	$(MAKE) -C libscp
+	$(CC) $(LDFLAGS) -o sesman $(SESMANOBJ) verify_user.o -lcrypt
+
+pam: $(SESMANOBJ) verify_user_pam.o
+	$(CC) $(LDFLAGS) -o sesman $(SESMANOBJ) verify_user_pam.o -lpam
+
+pam_userpass: $(SESMANOBJ) verify_user_pam_userpass.o
+	$(CC) $(LDFLAGS) -o sesman $(SESMANOBJ) verify_user_pam_userpass.o -lpam -lpam_userpass
+
+kerberos-base: $(SESMANOBJ) verify_user_kerberos.o
+	$(CC) $(LDFLAGS) -o sesman $(SESMANOBJ) verify_user_kerberos.o -lkrb5
+
+sessvc: $(SESSVCOBJ)
+	$(CC) $(LDFLAGS) -o sessvc $(SESSVCOBJ)
+
+tools: sessvc
+	$(MAKE) -C tools -f Makefile.osx
+
+libscp_:
+	$(MAKE) -C libscp -f Makefile.osx
+
+clean:
+	rm -f $(SESMANOBJ) verify_user.o verify_user_pam.o verify_user_pam_userpass.o sesman sesrun.o sesrun sessvc.o sessvc
+	$(MAKE) -C tools -f Makefile.osx clean
+	$(MAKE) -C libscp -f Makefile.osx clean
+
+install:
+	install sesman $(DESTDIR)/sesman
+	install startwm.sh $(DESTDIR)/startwm.sh
+	install sesman.ini $(CFGDIR)/sesman.ini
+	install sessvc $(DESTDIR)/sessvc
+	$(MAKE) -C tools install
+	$(MAKE) -C libscp install
+
+os_calls.o: ../common/os_calls.c
+	$(CC) $(C_OS_FLAGS) ../common/os_calls.c
+
+d3des.o: ../common/d3des.c
+	$(CC) $(C_OS_FLAGS) ../common/d3des.c
+
+list.o: ../common/list.c
+	$(CC) $(C_OS_FLAGS) ../common/list.c
+
+file.o: ../common/file.c
+	$(CC) $(C_OS_FLAGS) ../common/file.c
+
+log.o: ../common/log.c
+	$(CC) $(C_OS_FLAGS) -DLOG_ENABLE_THREAD ../common/log.c
diff --git a/sesman/access.c b/sesman/access.c
index 9038a18..5e22b78 100644
--- a/sesman/access.c
+++ b/sesman/access.c
@@ -14,7 +14,7 @@
    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
 
    xrdp: A Remote Desktop Protocol server.
-   Copyright (C) Jay Sorg 2005-2007
+   Copyright (C) Jay Sorg 2005-2008
 */
 
 /**
@@ -22,12 +22,12 @@
  * @file access.c
  * @brief User access control code
  * @author Simone Fedele
- * 
+ *
  */
 
 #include "sesman.h"
 
-extern struct config_sesman g_cfg;
+extern struct config_sesman* g_cfg;
 
 /******************************************************************************/
 int DEFAULT_CC
@@ -36,35 +36,84 @@ access_login_allowed(char* user)
   int gid;
   int ok;
 
-  if ((0 == g_strncmp(user, "root", 5)) && (0 == g_cfg.sec.allow_root))
+  if ((0 == g_strncmp(user, "root", 5)) && (0 == g_cfg->sec.allow_root))
   {
-    log_message(LOG_LEVEL_WARNING,
+    log_message(&(g_cfg->log), LOG_LEVEL_WARNING,
                 "ROOT login attempted, but root login is disabled");
     return 0;
   }
 
-  if (0 == g_cfg.sec.ts_users_enable)
+  if (0 == g_cfg->sec.ts_users_enable)
+  {
+    LOG_DBG(&(g_cfg->log), "Terminal Server Users group is disabled, allowing authentication",
+            1);
+    return 1;
+  }
+
+  if (0 != g_getuser_info(user, &gid, 0, 0, 0, 0))
+  {
+    log_message(&(g_cfg->log), LOG_LEVEL_ERROR, "Cannot read user info! - login denied");
+    return 0;
+  }
+
+  if (g_cfg->sec.ts_users == gid)
+  {
+    LOG_DBG(&(g_cfg->log), "ts_users is user's primary group");
+    return 1;
+  }
+
+  if (0 != g_check_user_in_group(user, g_cfg->sec.ts_users, &ok))
+  {
+    log_message(&(g_cfg->log), LOG_LEVEL_ERROR, "Cannot read group info! - login denied");
+    return 0;
+  }
+
+  if (ok)
+  {
+    return 1;
+  }
+
+  log_message(&(g_cfg->log), LOG_LEVEL_INFO, "login denied for user %s", user);
+
+  return 0;
+}
+
+/******************************************************************************/
+int DEFAULT_CC
+access_login_mng_allowed(char* user)
+{
+  int gid;
+  int ok;
+
+  if ((0 == g_strncmp(user, "root", 5)) && (0 == g_cfg->sec.allow_root))
+  {
+    log_message(&(g_cfg->log), LOG_LEVEL_WARNING,
+                "[MNG] ROOT login attempted, but root login is disabled");
+    return 0;
+  }
+
+  if (0 == g_cfg->sec.ts_admins_enable)
   {
-    LOG_DBG("Terminal Server Users group is disabled, allowing authentication",
+    LOG_DBG(&(g_cfg->log), "[MNG] Terminal Server Admin group is disabled, allowing authentication",
             1);
     return 1;
   }
 
   if (0 != g_getuser_info(user, &gid, 0, 0, 0, 0))
   {
-    log_message(LOG_LEVEL_ERROR, "Cannot read user info! - login denied");
+    log_message(&(g_cfg->log), LOG_LEVEL_ERROR, "[MNG] Cannot read user info! - login denied");
     return 0;
   }
 
-  if (g_cfg.sec.ts_users == gid)
+  if (g_cfg->sec.ts_admins == gid)
   {
-    LOG_DBG("ts_users is user's primary group", 1);
+    LOG_DBG(&(g_cfg->log), "[MNG] ts_users is user's primary group");
     return 1;
   }
 
-  if (0 != g_check_user_in_group(user, g_cfg.sec.ts_users, &ok))
+  if (0 != g_check_user_in_group(user, g_cfg->sec.ts_admins, &ok))
   {
-    log_message(LOG_LEVEL_ERROR, "Cannot read group info! - login denied");
+    log_message(&(g_cfg->log), LOG_LEVEL_ERROR, "[MNG] Cannot read group info! - login denied");
     return 0;
   }
 
@@ -73,7 +122,7 @@ access_login_allowed(char* user)
     return 1;
   }
 
-  log_message(LOG_LEVEL_INFO, "login denied for user %s", user);
+  log_message(&(g_cfg->log), LOG_LEVEL_INFO, "[MNG] login denied for user %s", user);
 
   return 0;
 }
diff --git a/sesman/access.h b/sesman/access.h
index d338a3a..db56b70 100644
--- a/sesman/access.h
+++ b/sesman/access.h
@@ -14,7 +14,7 @@
    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
 
    xrdp: A Remote Desktop Protocol server.
-   Copyright (C) Jay Sorg 2005-2007
+   Copyright (C) Jay Sorg 2005-2008
 */
 
 /**
@@ -22,7 +22,7 @@
  * @file access.h
  * @brief User access control definitions
  * @author Simone Fedele
- * 
+ *
  */
 
 #ifndef ACCESS_H
@@ -38,4 +38,14 @@
 int DEFAULT_CC
 access_login_allowed(char* user);
 
+/**
+ *
+ * @brief Checks if the user is allowed to access the terminal server for management
+ * @param user the user to check
+ * @return 0 if access is denied, !=0 if allowed
+ *
+ */
+int DEFAULT_CC
+access_login_mng_allowed(char* user);
+
 #endif
diff --git a/sesman/auth.h b/sesman/auth.h
index bb23a81..ec95fee 100644
--- a/sesman/auth.h
+++ b/sesman/auth.h
@@ -14,7 +14,7 @@
    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
 
    xrdp: A Remote Desktop Protocol server.
-   Copyright (C) Jay Sorg 2005-2007
+   Copyright (C) Jay Sorg 2005-2008
 */
 
 /**
diff --git a/sesman/config.c b/sesman/config.c
index 5cb7c7e..4af7b69 100644
--- a/sesman/config.c
+++ b/sesman/config.c
@@ -14,7 +14,7 @@
    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
 
    xrdp: A Remote Desktop Protocol server.
-   Copyright (C) Jay Sorg 2005-2007
+   Copyright (C) Jay Sorg 2005-2008
 */
 
 /**
@@ -30,6 +30,8 @@
 #include "file.h"
 #include "sesman.h"
 
+extern struct config_sesman* g_cfg;
+
 /******************************************************************************/
 /**
  *
@@ -62,8 +64,16 @@ config_read(struct config_sesman* cfg)
   fd = g_file_open(SESMAN_CFG_FILE);
   if (-1 == fd)
   {
-    log_message(LOG_LEVEL_ALWAYS, "error opening %s in \
-config_read", SESMAN_CFG_FILE);
+    if (g_cfg->log.fd >= 0)
+    {
+      /* logging is already active */
+      log_message(&(g_cfg->log), LOG_LEVEL_ALWAYS, "error opening %s in \
+                  config_read", SESMAN_CFG_FILE);
+    }
+    else
+    {
+      g_printf("error opening %s in config_read", SESMAN_CFG_FILE);
+    }
     return 1;
   }
   g_memset(cfg, 0, sizeof(struct config_sesman));
diff --git a/sesman/config.h b/sesman/config.h
index 023c1f2..11b3e58 100644
--- a/sesman/config.h
+++ b/sesman/config.h
@@ -14,7 +14,7 @@
    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
 
    xrdp: A Remote Desktop Protocol server.
-   Copyright (C) Jay Sorg 2005-2007
+   Copyright (C) Jay Sorg 2005-2008
 */
 
 /**
@@ -180,12 +180,12 @@ struct config_sesman
    * @var vnc_params
    * @brief Xvnc additional parameter list
    */
-struct list* vnc_params;
+  struct list* vnc_params;
   /**
    * @var rdp_params
    * @brief X11rdp additional parameter list
    */
-struct list* rdp_params;
+  struct list* rdp_params;
   /**
    * @var log
    * @brief Log configuration struct
diff --git a/sesman/env.c b/sesman/env.c
index 53849e3..066277d 100644
--- a/sesman/env.c
+++ b/sesman/env.c
@@ -14,7 +14,7 @@
    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
 
    xrdp: A Remote Desktop Protocol server.
-   Copyright (C) Jay Sorg 2005-2007
+   Copyright (C) Jay Sorg 2005-2008
 */
 
 /**
@@ -31,7 +31,7 @@
 #include "grp.h"
 
 extern unsigned char g_fixedkey[8]; /* in sesman.c */
-extern struct config_sesman g_cfg; 
+extern struct config_sesman* g_cfg; 
 
 /******************************************************************************/
 int DEFAULT_CC
@@ -47,7 +47,8 @@ env_check_password_file(char* filename, char* password)
   fd = g_file_open(filename);
   if (fd == -1)
   {
-    log_message(LOG_LEVEL_WARNING, "can't read vnc password file - %s",
+    log_message(&(g_cfg->log), LOG_LEVEL_WARNING,
+                "can't read vnc password file - %s",
                 filename);
     return 1;
   }
@@ -98,24 +99,26 @@ env_set_user(char* username, char* passwd_file, int display)
       g_setenv("DISPLAY", text, 1);
       if (passwd_file != 0)
       {
-        if (0==g_cfg.auth_file_path)
+        if (0 == g_cfg->auth_file_path)
         {
-          /* if no auth_file_path is set, then we go for $HOME/.vnc/sesman_passwd */
+          /* if no auth_file_path is set, then we go for
+             $HOME/.vnc/sesman_username_passwd */
           g_mkdir(".vnc");
-          g_sprintf(passwd_file, "%s/.vnc/sesman_passwd", pw_dir);
+          g_sprintf(passwd_file, "%s/.vnc/sesman_%s_passwd", pw_dir, username);
         }
 	else
 	{
           /* we use auth_file_path as requested */
-          g_sprintf(passwd_file, g_cfg.auth_file_path, username);
+          g_sprintf(passwd_file, g_cfg->auth_file_path, username);
         }
-	LOG_DBG("pass file: %s", passwd_file);
+	LOG_DBG(&(g_cfg->log), "pass file: %s", passwd_file);
       }
     }
   }
   else
   {
-    log_message(LOG_LEVEL_ERROR, "error getting user info for user %s", username);
+    log_message(&(g_cfg->log), LOG_LEVEL_ERROR,
+                "error getting user info for user %s", username);
   }
   return error;
 }
diff --git a/sesman/env.h b/sesman/env.h
index f9b8be4..77deb08 100644
--- a/sesman/env.h
+++ b/sesman/env.h
@@ -14,7 +14,7 @@
    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
 
    xrdp: A Remote Desktop Protocol server.
-   Copyright (C) Jay Sorg 2005-2007
+   Copyright (C) Jay Sorg 2005-2008
 */
 
 /**
diff --git a/sesman/libscp/Makefile b/sesman/libscp/Makefile
index 9bd6367..14af659 100644
--- a/sesman/libscp/Makefile
+++ b/sesman/libscp/Makefile
@@ -1,39 +1,490 @@
-# libscp makefile
-LIBSCPOBJ = libscp_vX.o libscp_v0.o \
-	    libscp_v1s.o libscp_v1c.o \
-	    libscp_init.o libscp_lock.o libscp_tcp.o \
-	    os_calls.o
+# Makefile.in generated by automake 1.10.1 from Makefile.am.
+# sesman/libscp/Makefile.  Generated from Makefile.in by configure.
 
-DESTDIR = /usr/local/xrdp
-CFGDIR = /etc/xrdp
-PIDDIR = /var/run
-MANDIR = /usr/local/man
-DOCDIR = /usr/doc/xrdp
+# Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
+# 2003, 2004, 2005, 2006, 2007, 2008  Free Software Foundation, Inc.
+# This Makefile.in is free software; the Free Software Foundation
+# gives unlimited permission to copy and/or distribute it,
+# with or without modifications, as long as this notice is preserved.
 
-DESTDIRDEB = /tmp
+# This program is distributed in the hope that it will be useful,
+# but WITHOUT ANY WARRANTY, to the extent permitted by law; without
+# even the implied warranty of MERCHANTABILITY or FITNESS FOR A
+# PARTICULAR PURPOSE.
 
-LIBSCPLNAME = libscp.so
 
-DEFINES = -DSESMAN_CFG_FILE=\"$(CFGDIR)/sesman.ini\" \
-	  -DSESMAN_PID_FILE=\"$(PIDDIR)/sesman.pid\" \
-	  -DSESMAN_SESSVC_FILE=\"sessvc\"
 
-CFLAGS = -Wall -O2 -I../../common -I/usr/include/nptl -fPIC $(DEFINES)
-LDFLAGS = -shared -L/usr/gnu/lib -L/usr/lib/nptl -lpthread
-C_OS_FLAGS = $(CFLAGS) -c
+
+pkgdatadir = $(datadir)/xrdp
+pkglibdir = $(libdir)/xrdp
+pkgincludedir = $(includedir)/xrdp
+am__cd = CDPATH="$${ZSH_VERSION+.}$(PATH_SEPARATOR)" && cd
+install_sh_DATA = $(install_sh) -c -m 644
+install_sh_PROGRAM = $(install_sh) -c
+install_sh_SCRIPT = $(install_sh) -c
+INSTALL_HEADER = $(INSTALL_DATA)
+transform = $(program_transform_name)
+NORMAL_INSTALL = :
+PRE_INSTALL = :
+POST_INSTALL = :
+NORMAL_UNINSTALL = :
+PRE_UNINSTALL = :
+POST_UNINSTALL = :
+build_triplet = i686-suse-linux-gnu
+host_triplet = i686-suse-linux-gnu
+subdir = sesman/libscp
+DIST_COMMON = $(srcdir)/Makefile.am $(srcdir)/Makefile.in
+ACLOCAL_M4 = $(top_srcdir)/aclocal.m4
+am__aclocal_m4_deps = $(top_srcdir)/configure.ac
+am__configure_deps = $(am__aclocal_m4_deps) $(CONFIGURE_DEPENDENCIES) \
+	$(ACLOCAL_M4)
+mkinstalldirs = $(install_sh) -d
+CONFIG_HEADER = $(top_builddir)/config_ac.h
+CONFIG_CLEAN_FILES =
+am__vpath_adj_setup = srcdirstrip=`echo "$(srcdir)" | sed 's|.|.|g'`;
+am__vpath_adj = case $$p in \
+    $(srcdir)/*) f=`echo "$$p" | sed "s|^$$srcdirstrip/||"`;; \
+    *) f=$$p;; \
+  esac;
+am__strip_dir = `echo $$p | sed -e 's|^.*/||'`;
+am__installdirs = "$(DESTDIR)$(libdir)"
+libLTLIBRARIES_INSTALL = $(INSTALL)
+LTLIBRARIES = $(lib_LTLIBRARIES)
+libscp_la_DEPENDENCIES = $(top_srcdir)/common/libcommon.la
+am_libscp_la_OBJECTS = libscp_connection.lo libscp_init.lo \
+	libscp_lock.lo libscp_session.lo libscp_tcp.lo libscp_v0.lo \
+	libscp_v1c.lo libscp_v1s.lo libscp_vX.lo
+libscp_la_OBJECTS = $(am_libscp_la_OBJECTS)
+DEFAULT_INCLUDES = -I. -I$(top_builddir)
+depcomp = $(SHELL) $(top_srcdir)/depcomp
+am__depfiles_maybe = depfiles
+COMPILE = $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) \
+	$(CPPFLAGS) $(AM_CFLAGS) $(CFLAGS)
+LTCOMPILE = $(LIBTOOL) --tag=CC $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) \
+	--mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) \
+	$(AM_CPPFLAGS) $(CPPFLAGS) $(AM_CFLAGS) $(CFLAGS)
+CCLD = $(CC)
+LINK = $(LIBTOOL) --tag=CC $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) \
+	--mode=link $(CCLD) $(AM_CFLAGS) $(CFLAGS) $(AM_LDFLAGS) \
+	$(LDFLAGS) -o $@
+SOURCES = $(libscp_la_SOURCES)
+DIST_SOURCES = $(libscp_la_SOURCES)
+ETAGS = etags
+CTAGS = ctags
+DISTFILES = $(DIST_COMMON) $(DIST_SOURCES) $(TEXINFOS) $(EXTRA_DIST)
+ACLOCAL = ${SHELL} /home/david/git/xrdp/missing --run aclocal-1.10
+AMTAR = ${SHELL} /home/david/git/xrdp/missing --run tar
+AR = ar
+AUTOCONF = ${SHELL} /home/david/git/xrdp/missing --run autoconf
+AUTOHEADER = ${SHELL} /home/david/git/xrdp/missing --run autoheader
+AUTOMAKE = ${SHELL} /home/david/git/xrdp/missing --run automake-1.10
+AWK = gawk
 CC = gcc
+CCDEPMODE = depmode=gcc3
+CFLAGS = -g -O2
+CPP = gcc -E
+CPPFLAGS = 
+CXX = g++
+CXXCPP = g++ -E
+CXXDEPMODE = depmode=gcc3
+CXXFLAGS = -g -O2
+CYGPATH_W = echo
+DEFS = -DHAVE_CONFIG_H
+DEPDIR = .deps
+DSYMUTIL = 
+ECHO = echo
+ECHO_C = 
+ECHO_N = -n
+ECHO_T = 
+EGREP = /usr/bin/grep -E
+EXEEXT = 
+F77 = 
+FFLAGS = 
+GREP = /usr/bin/grep
+INSTALL = /usr/bin/install -c
+INSTALL_DATA = ${INSTALL} -m 644
+INSTALL_PROGRAM = ${INSTALL}
+INSTALL_SCRIPT = ${INSTALL}
+INSTALL_STRIP_PROGRAM = $(install_sh) -c -s
+LDFLAGS = 
+LIBOBJS = 
+LIBS = 
+LIBTOOL = $(SHELL) $(top_builddir)/libtool
+LN_S = ln -s
+LTLIBOBJS = 
+MAKEINFO = ${SHELL} /home/david/git/xrdp/missing --run makeinfo
+MKDIR_P = /bin/mkdir -p
+NMEDIT = 
+OBJEXT = o
+PACKAGE = xrdp
+PACKAGE_BUGREPORT = xrdp-devel@lists.sourceforge.net
+PACKAGE_NAME = xrdp
+PACKAGE_STRING = xrdp 0.5.0
+PACKAGE_TARNAME = xrdp
+PACKAGE_VERSION = 0.5.0
+PATH_SEPARATOR = :
+RANLIB = ranlib
+SED = /usr/bin/sed
+SET_MAKE = 
+SHELL = /bin/sh
+STRIP = strip
+VERSION = 0.5.0
+abs_builddir = /home/david/git/xrdp/sesman/libscp
+abs_srcdir = /home/david/git/xrdp/sesman/libscp
+abs_top_builddir = /home/david/git/xrdp
+abs_top_srcdir = /home/david/git/xrdp
+ac_ct_CC = gcc
+ac_ct_CXX = g++
+ac_ct_F77 = 
+am__include = include
+am__leading_dot = .
+am__quote = 
+am__tar = ${AMTAR} chof - "$$tardir"
+am__untar = ${AMTAR} xf -
+bindir = ${exec_prefix}/bin
+build = i686-suse-linux-gnu
+build_alias = 
+build_cpu = i686
+build_os = linux-gnu
+build_vendor = suse
+builddir = .
+datadir = ${datarootdir}
+datarootdir = ${prefix}/share
+docdir = ${datarootdir}/doc/${PACKAGE_TARNAME}
+dvidir = ${docdir}
+exec_prefix = ${prefix}
+host = i686-suse-linux-gnu
+host_alias = 
+host_cpu = i686
+host_os = linux-gnu
+host_vendor = suse
+htmldir = ${docdir}
+includedir = ${prefix}/include
+infodir = ${datarootdir}/info
+install_sh = $(SHELL) /home/david/git/xrdp/install-sh
+libdir = ${exec_prefix}/lib/xrdp/
+libexecdir = ${exec_prefix}/libexec
+localedir = ${datarootdir}/locale
+localstatedir = ${prefix}/var
+mandir = ${datarootdir}/man
+mkdir_p = /bin/mkdir -p
+oldincludedir = /usr/include
+pdfdir = ${docdir}
+prefix = /usr
+program_transform_name = s,x,x,
+psdir = ${docdir}
+sbindir = ${exec_prefix}/sbin
+sharedstatedir = ${prefix}/com
+srcdir = .
+sysconfdir = ${prefix}/etc
+target_alias = 
+top_builddir = ../..
+top_srcdir = ../..
+INCLUDES = \
+  -I$(top_srcdir)/common
+
+lib_LTLIBRARIES = \
+  libscp.la
+
+libscp_la_SOURCES = \
+  libscp_connection.c \
+  libscp_init.c \
+  libscp_lock.c \
+  libscp_session.c \
+  libscp_tcp.c \
+  libscp_v0.c \
+  libscp_v1c.c \
+  libscp_v1s.c \
+  libscp_vX.c
+
+libscp_la_LIBADD = \
+  $(top_srcdir)/common/libcommon.la
+
+all: all-am
+
+.SUFFIXES:
+.SUFFIXES: .c .lo .o .obj
+$(srcdir)/Makefile.in:  $(srcdir)/Makefile.am  $(am__configure_deps)
+	@for dep in $?; do \
+	  case '$(am__configure_deps)' in \
+	    *$$dep*) \
+	      cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh \
+		&& exit 0; \
+	      exit 1;; \
+	  esac; \
+	done; \
+	echo ' cd $(top_srcdir) && $(AUTOMAKE) --foreign  sesman/libscp/Makefile'; \
+	cd $(top_srcdir) && \
+	  $(AUTOMAKE) --foreign  sesman/libscp/Makefile
+.PRECIOUS: Makefile
+Makefile: $(srcdir)/Makefile.in $(top_builddir)/config.status
+	@case '$?' in \
+	  *config.status*) \
+	    cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh;; \
+	  *) \
+	    echo ' cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe)'; \
+	    cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe);; \
+	esac;
+
+$(top_builddir)/config.status: $(top_srcdir)/configure $(CONFIG_STATUS_DEPENDENCIES)
+	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
+
+$(top_srcdir)/configure:  $(am__configure_deps)
+	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
+$(ACLOCAL_M4):  $(am__aclocal_m4_deps)
+	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
+install-libLTLIBRARIES: $(lib_LTLIBRARIES)
+	@$(NORMAL_INSTALL)
+	test -z "$(libdir)" || $(MKDIR_P) "$(DESTDIR)$(libdir)"
+	@list='$(lib_LTLIBRARIES)'; for p in $$list; do \
+	  if test -f $$p; then \
+	    f=$(am__strip_dir) \
+	    echo " $(LIBTOOL) $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=install $(libLTLIBRARIES_INSTALL) $(INSTALL_STRIP_FLAG) '$$p' '$(DESTDIR)$(libdir)/$$f'"; \
+	    $(LIBTOOL) $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=install $(libLTLIBRARIES_INSTALL) $(INSTALL_STRIP_FLAG) "$$p" "$(DESTDIR)$(libdir)/$$f"; \
+	  else :; fi; \
+	done
+
+uninstall-libLTLIBRARIES:
+	@$(NORMAL_UNINSTALL)
+	@list='$(lib_LTLIBRARIES)'; for p in $$list; do \
+	  p=$(am__strip_dir) \
+	  echo " $(LIBTOOL) $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=uninstall rm -f '$(DESTDIR)$(libdir)/$$p'"; \
+	  $(LIBTOOL) $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=uninstall rm -f "$(DESTDIR)$(libdir)/$$p"; \
+	done
+
+clean-libLTLIBRARIES:
+	-test -z "$(lib_LTLIBRARIES)" || rm -f $(lib_LTLIBRARIES)
+	@list='$(lib_LTLIBRARIES)'; for p in $$list; do \
+	  dir="`echo $$p | sed -e 's|/[^/]*$$||'`"; \
+	  test "$$dir" != "$$p" || dir=.; \
+	  echo "rm -f \"$${dir}/so_locations\""; \
+	  rm -f "$${dir}/so_locations"; \
+	done
+libscp.la: $(libscp_la_OBJECTS) $(libscp_la_DEPENDENCIES) 
+	$(LINK) -rpath $(libdir) $(libscp_la_OBJECTS) $(libscp_la_LIBADD) $(LIBS)
+
+mostlyclean-compile:
+	-rm -f *.$(OBJEXT)
+
+distclean-compile:
+	-rm -f *.tab.c
+
+include ./$(DEPDIR)/libscp_connection.Plo
+include ./$(DEPDIR)/libscp_init.Plo
+include ./$(DEPDIR)/libscp_lock.Plo
+include ./$(DEPDIR)/libscp_session.Plo
+include ./$(DEPDIR)/libscp_tcp.Plo
+include ./$(DEPDIR)/libscp_v0.Plo
+include ./$(DEPDIR)/libscp_v1c.Plo
+include ./$(DEPDIR)/libscp_v1s.Plo
+include ./$(DEPDIR)/libscp_vX.Plo
+
+.c.o:
+	$(COMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ $<
+	mv -f $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Po
+#	source='$<' object='$@' libtool=no \
+#	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) \
+#	$(COMPILE) -c $<
+
+.c.obj:
+	$(COMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ `$(CYGPATH_W) '$<'`
+	mv -f $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Po
+#	source='$<' object='$@' libtool=no \
+#	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) \
+#	$(COMPILE) -c `$(CYGPATH_W) '$<'`
+
+.c.lo:
+	$(LTCOMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ $<
+	mv -f $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Plo
+#	source='$<' object='$@' libtool=yes \
+#	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) \
+#	$(LTCOMPILE) -c -o $@ $<
+
+mostlyclean-libtool:
+	-rm -f *.lo
+
+clean-libtool:
+	-rm -rf .libs _libs
+
+ID: $(HEADERS) $(SOURCES) $(LISP) $(TAGS_FILES)
+	list='$(SOURCES) $(HEADERS) $(LISP) $(TAGS_FILES)'; \
+	unique=`for i in $$list; do \
+	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
+	  done | \
+	  $(AWK) '{ files[$$0] = 1; nonemtpy = 1; } \
+	      END { if (nonempty) { for (i in files) print i; }; }'`; \
+	mkid -fID $$unique
+tags: TAGS
+
+TAGS:  $(HEADERS) $(SOURCES)  $(TAGS_DEPENDENCIES) \
+		$(TAGS_FILES) $(LISP)
+	tags=; \
+	here=`pwd`; \
+	list='$(SOURCES) $(HEADERS)  $(LISP) $(TAGS_FILES)'; \
+	unique=`for i in $$list; do \
+	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
+	  done | \
+	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
+	      END { if (nonempty) { for (i in files) print i; }; }'`; \
+	if test -z "$(ETAGS_ARGS)$$tags$$unique"; then :; else \
+	  test -n "$$unique" || unique=$$empty_fix; \
+	  $(ETAGS) $(ETAGSFLAGS) $(AM_ETAGSFLAGS) $(ETAGS_ARGS) \
+	    $$tags $$unique; \
+	fi
+ctags: CTAGS
+CTAGS:  $(HEADERS) $(SOURCES)  $(TAGS_DEPENDENCIES) \
+		$(TAGS_FILES) $(LISP)
+	tags=; \
+	list='$(SOURCES) $(HEADERS)  $(LISP) $(TAGS_FILES)'; \
+	unique=`for i in $$list; do \
+	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
+	  done | \
+	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
+	      END { if (nonempty) { for (i in files) print i; }; }'`; \
+	test -z "$(CTAGS_ARGS)$$tags$$unique" \
+	  || $(CTAGS) $(CTAGSFLAGS) $(AM_CTAGSFLAGS) $(CTAGS_ARGS) \
+	     $$tags $$unique
+
+GTAGS:
+	here=`$(am__cd) $(top_builddir) && pwd` \
+	  && cd $(top_srcdir) \
+	  && gtags -i $(GTAGS_ARGS) $$here
+
+distclean-tags:
+	-rm -f TAGS ID GTAGS GRTAGS GSYMS GPATH tags
+
+distdir: $(DISTFILES)
+	@srcdirstrip=`echo "$(srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
+	topsrcdirstrip=`echo "$(top_srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
+	list='$(DISTFILES)'; \
+	  dist_files=`for file in $$list; do echo $$file; done | \
+	  sed -e "s|^$$srcdirstrip/||;t" \
+	      -e "s|^$$topsrcdirstrip/|$(top_builddir)/|;t"`; \
+	case $$dist_files in \
+	  */*) $(MKDIR_P) `echo "$$dist_files" | \
+			   sed '/\//!d;s|^|$(distdir)/|;s,/[^/]*$$,,' | \
+			   sort -u` ;; \
+	esac; \
+	for file in $$dist_files; do \
+	  if test -f $$file || test -d $$file; then d=.; else d=$(srcdir); fi; \
+	  if test -d $$d/$$file; then \
+	    dir=`echo "/$$file" | sed -e 's,/[^/]*$$,,'`; \
+	    if test -d $(srcdir)/$$file && test $$d != $(srcdir); then \
+	      cp -pR $(srcdir)/$$file $(distdir)$$dir || exit 1; \
+	    fi; \
+	    cp -pR $$d/$$file $(distdir)$$dir || exit 1; \
+	  else \
+	    test -f $(distdir)/$$file \
+	    || cp -p $$d/$$file $(distdir)/$$file \
+	    || exit 1; \
+	  fi; \
+	done
+check-am: all-am
+check: check-am
+all-am: Makefile $(LTLIBRARIES)
+installdirs:
+	for dir in "$(DESTDIR)$(libdir)"; do \
+	  test -z "$$dir" || $(MKDIR_P) "$$dir"; \
+	done
+install: install-am
+install-exec: install-exec-am
+install-data: install-data-am
+uninstall: uninstall-am
+
+install-am: all-am
+	@$(MAKE) $(AM_MAKEFLAGS) install-exec-am install-data-am
+
+installcheck: installcheck-am
+install-strip:
+	$(MAKE) $(AM_MAKEFLAGS) INSTALL_PROGRAM="$(INSTALL_STRIP_PROGRAM)" \
+	  install_sh_PROGRAM="$(INSTALL_STRIP_PROGRAM)" INSTALL_STRIP_FLAG=-s \
+	  `test -z '$(STRIP)' || \
+	    echo "INSTALL_PROGRAM_ENV=STRIPPROG='$(STRIP)'"` install
+mostlyclean-generic:
+
+clean-generic:
+
+distclean-generic:
+	-test -z "$(CONFIG_CLEAN_FILES)" || rm -f $(CONFIG_CLEAN_FILES)
+
+maintainer-clean-generic:
+	@echo "This command is intended for maintainers to use"
+	@echo "it deletes files that may require special tools to rebuild."
+clean: clean-am
+
+clean-am: clean-generic clean-libLTLIBRARIES clean-libtool \
+	mostlyclean-am
+
+distclean: distclean-am
+	-rm -rf ./$(DEPDIR)
+	-rm -f Makefile
+distclean-am: clean-am distclean-compile distclean-generic \
+	distclean-tags
+
+dvi: dvi-am
+
+dvi-am:
+
+html: html-am
+
+info: info-am
+
+info-am:
+
+install-data-am:
+
+install-dvi: install-dvi-am
+
+install-exec-am: install-libLTLIBRARIES
+
+install-html: install-html-am
+
+install-info: install-info-am
+
+install-man:
+
+install-pdf: install-pdf-am
+
+install-ps: install-ps-am
+
+installcheck-am:
+
+maintainer-clean: maintainer-clean-am
+	-rm -rf ./$(DEPDIR)
+	-rm -f Makefile
+maintainer-clean-am: distclean-am maintainer-clean-generic
+
+mostlyclean: mostlyclean-am
+
+mostlyclean-am: mostlyclean-compile mostlyclean-generic \
+	mostlyclean-libtool
+
+pdf: pdf-am
+
+pdf-am:
+
+ps: ps-am
 
-all: $(LIBSCPOBJ)
-	$(CC) $(LDFLAGS) -o $(LIBSCPLNAME) $(LIBSCPOBJ)
+ps-am:
 
-clean:
-	rm -f $(LIBSCPOBJ) $(LIBSCPLNAME)
+uninstall-am: uninstall-libLTLIBRARIES
 
-install:
-	install $(LIBSCPLNAME) $(DESTDIR)/$(LIBSCPLNAME)
+.MAKE: install-am install-strip
 
-installdeb:
-	install $(LIBSCPLNAME) $(DESTDIRDEB)/usr/lib/xrdp/$(LIBSCPLNAME)
+.PHONY: CTAGS GTAGS all all-am check check-am clean clean-generic \
+	clean-libLTLIBRARIES clean-libtool ctags distclean \
+	distclean-compile distclean-generic distclean-libtool \
+	distclean-tags distdir dvi dvi-am html html-am info info-am \
+	install install-am install-data install-data-am install-dvi \
+	install-dvi-am install-exec install-exec-am install-html \
+	install-html-am install-info install-info-am \
+	install-libLTLIBRARIES install-man install-pdf install-pdf-am \
+	install-ps install-ps-am install-strip installcheck \
+	installcheck-am installdirs maintainer-clean \
+	maintainer-clean-generic mostlyclean mostlyclean-compile \
+	mostlyclean-generic mostlyclean-libtool pdf pdf-am ps ps-am \
+	tags uninstall uninstall-am uninstall-libLTLIBRARIES
 
-os_calls.o: ../../common/os_calls.c
-	$(CC) $(C_OS_FLAGS) ../../common/os_calls.c
+# Tell versions [3.59,3.63) of GNU make to not export all variables.
+# Otherwise a system limit (for SysV at least) may be exceeded.
+.NOEXPORT:
diff --git a/sesman/libscp/Makefile.am b/sesman/libscp/Makefile.am
new file mode 100644
index 0000000..5450f41
--- /dev/null
+++ b/sesman/libscp/Makefile.am
@@ -0,0 +1,19 @@
+INCLUDES = \
+  -I$(top_srcdir)/common
+
+lib_LTLIBRARIES = \
+  libscp.la
+
+libscp_la_SOURCES = \
+  libscp_connection.c \
+  libscp_init.c \
+  libscp_lock.c \
+  libscp_session.c \
+  libscp_tcp.c \
+  libscp_v0.c \
+  libscp_v1c.c \
+  libscp_v1s.c \
+  libscp_vX.c
+
+libscp_la_LIBADD = \
+  $(top_srcdir)/common/libcommon.la
diff --git a/sesman/libscp/Makefile.osx b/sesman/libscp/Makefile.osx
new file mode 100644
index 0000000..d875056
--- /dev/null
+++ b/sesman/libscp/Makefile.osx
@@ -0,0 +1,45 @@
+# libscp makefile
+LIBSCPOBJ = libscp_vX.o libscp_v0.o \
+           libscp_v1s.o libscp_v1c.o \
+           libscp_init.o libscp_lock.o libscp_tcp.o \
+           libscp_session.o libscp_connection.o \
+           os_calls.o
+
+DESTDIR = /usr/local/xrdp
+CFGDIR = /etc/xrdp
+PIDDIR = /var/run
+MANDIR = /usr/local/man
+DOCDIR = /usr/doc/xrdp
+
+DESTDIRDEB = /tmp
+
+LIBSCPLNAME = libscp.dylib
+LIBSCPSONAME = libscp.1.dylib
+LIBSCPFNAME = libscp.0.0.dylib
+
+DEFINES = -DSESMAN_CFG_FILE=\"$(CFGDIR)/sesman.ini\" \
+         -DSESMAN_PID_FILE=\"$(PIDDIR)/sesman.pid\" \
+         -DSESMAN_SESSVC_FILE=\"sessvc\"
+
+CFLAGS = -Wall -O2 -I../../common -I/usr/include/nptl -fPIC -fno-common $(DEFINES)
+LDFLAGS = -dynamiclib -Wl,-flat_namespace -Wl,-undefined -Wl,suppress -lpthread
+C_OS_FLAGS = $(CFLAGS) -c
+CC = gcc
+
+all: $(LIBSCPOBJ)
+	$(CC) $(LDFLAGS) -o $(LIBSCPFNAME) $(LIBSCPOBJ)
+	ln -f -s $(LIBSCPFNAME) $(LIBSCPLNAME)
+
+clean:
+	rm -f $(LIBSCPOBJ) $(LIBSCPFNAME) $(LIBSCPLNAME)
+
+install:
+	install $(LIBSCPFNAME) $(DESTDIR)/$(LIBSCPFNAME)
+	ln -f -s $(LIBSCPFNAME) $(DESTDIR)/$(LIBSCPLNAME)
+
+installdeb:
+	install $(LIBSCPFNAME) $(DESTDIRDEB)/usr/lib/xrdp/$(LIBSCPFNAME)
+	ln -f -s $(LIBSCPFNAME) $(DESTDIRDEB)/usr/lib/xrdp/$(LIBSCPLNAME)
+
+os_calls.o: ../../common/os_calls.c
+	$(CC) $(C_OS_FLAGS) ../../common/os_calls.c
diff --git a/sesman/libscp/libscp.h b/sesman/libscp/libscp.h
index 31aa367..b8f9dea 100644
--- a/sesman/libscp/libscp.h
+++ b/sesman/libscp/libscp.h
@@ -14,7 +14,7 @@
    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
 
    xrdp: A Remote Desktop Protocol server.
-   Copyright (C) Jay Sorg 2005-2007
+   Copyright (C) Jay Sorg 2005-2008
 */
 
 /**
@@ -28,8 +28,14 @@
 #ifndef LIBSCP_H
 #define LIBSCP_H
 
+#if defined(HAVE_CONFIG_H)
+#include "config_ac.h"
+#endif
+
 #include "libscp_types.h"
 
+#include "libscp_connection.h"
+#include "libscp_session.h"
 #include "libscp_init.h"
 #include "libscp_tcp.h"
 #include "libscp_lock.h"
@@ -38,5 +44,6 @@
 #include "libscp_v0.h"
 #include "libscp_v1s.h"
 #include "libscp_v1c.h"
+#include "file_loc.h"
 
 #endif
diff --git a/sesman/libscp/libscp_connection.c b/sesman/libscp/libscp_connection.c
new file mode 100644
index 0000000..7f6569d
--- /dev/null
+++ b/sesman/libscp/libscp_connection.c
@@ -0,0 +1,60 @@
+/*
+   This program is free software; you can redistribute it and/or modify
+   it under the terms of the GNU General Public License as published by
+   the Free Software Foundation; either version 2 of the License, or
+   (at your option) any later version.
+
+   This program is distributed in the hope that it will be useful,
+   but WITHOUT ANY WARRANTY; without even the implied warranty of
+   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+   GNU General Public License for more details.
+
+   You should have received a copy of the GNU General Public License
+   along with this program; if not, write to the Free Software
+   Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
+
+   xrdp: A Remote Desktop Protocol server.
+   Copyright (C) Jay Sorg 2005-2008
+*/
+
+/**
+ *
+ * @file libscp_connection.c
+ * @brief SCP_CONNECTION handling code
+ * @author Simone Fedele
+ *
+ */
+
+#include "libscp_connection.h"
+
+extern struct log_config* s_log;
+
+struct SCP_CONNECTION*
+scp_connection_create(int sck)
+{
+  struct SCP_CONNECTION* conn;
+
+  conn = g_malloc(sizeof(struct SCP_CONNECTION), 0);
+
+  if (0 == conn)
+  {
+    log_message(s_log, LOG_LEVEL_WARNING, "[connection:%d] connection create: malloc error", __LINE__);
+    return 0;
+  }
+
+  conn->in_sck=sck;
+  make_stream(conn->in_s);
+  init_stream(conn->in_s, 8196);
+  make_stream(conn->out_s);
+  init_stream(conn->out_s, 8196);
+
+  return conn;
+}
+
+void
+scp_connection_destroy(struct SCP_CONNECTION* c)
+{
+  free_stream(c->in_s);
+  free_stream(c->out_s);
+  g_free(c);
+}
diff --git a/sesman/libscp/libscp_connection.h b/sesman/libscp/libscp_connection.h
new file mode 100644
index 0000000..5b8dad4
--- /dev/null
+++ b/sesman/libscp/libscp_connection.h
@@ -0,0 +1,54 @@
+/*
+   This program is free software; you can redistribute it and/or modify
+   it under the terms of the GNU General Public License as published by
+   the Free Software Foundation; either version 2 of the License, or
+   (at your option) any later version.
+
+   This program is distributed in the hope that it will be useful,
+   but WITHOUT ANY WARRANTY; without even the implied warranty of
+   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+   GNU General Public License for more details.
+
+   You should have received a copy of the GNU General Public License
+   along with this program; if not, write to the Free Software
+   Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
+
+   xrdp: A Remote Desktop Protocol server.
+   Copyright (C) Jay Sorg 2005-2008
+*/
+
+/**
+ *
+ * @file libscp_connection.h
+ * @brief SCP_CONNECTION handling code
+ * @author Simone Fedele
+ * 
+ */
+
+#ifndef LIBSCP_CONNECTION_H
+#define LIBSCP_CONNECTION_H
+
+#include "libscp.h"
+
+/**
+ *
+ * @brief creates a new connection
+ * @param sck the connection socket
+ *
+ * @return a struct SCP_CONNECTION* object on success, NULL otherwise
+ *
+ */	
+struct SCP_CONNECTION*
+scp_connection_create(int sck);
+
+/**
+ *
+ * @brief destroys a struct SCP_CONNECTION* object
+ * @param c the object to be destroyed
+ * 
+ */
+void
+scp_connection_destroy(struct SCP_CONNECTION* c);
+
+#endif
+
diff --git a/sesman/libscp/libscp_init.c b/sesman/libscp/libscp_init.c
index 48c6b2c..899fd6c 100644
--- a/sesman/libscp/libscp_init.c
+++ b/sesman/libscp/libscp_init.c
@@ -14,7 +14,7 @@
    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
 
    xrdp: A Remote Desktop Protocol server.
-   Copyright (C) Jay Sorg 2005-2007
+   Copyright (C) Jay Sorg 2005-2008
 */
 
 /**
@@ -27,33 +27,23 @@
 
 #include "libscp_init.h"
 
+struct log_config* s_log;
+
 /* server API */
-int DEFAULT_CC 
-scp_init(void)
+int DEFAULT_CC
+scp_init(struct log_config* log)
 {
-  scp_lock_init();
+  if (0 == log)
+  {
+    return 1;
+  }
 
-  return 0;
-}
+  s_log = log;
 
-struct SCP_CONNECTION*
-scp_make_connection(int sck)
-{
-  struct SCP_CONNECTION* conn;
-  
-  conn = g_malloc(sizeof(struct SCP_CONNECTION), 0);
+  scp_lock_init();
 
-  if (0 == conn)
-  {
-    return 0;
-  }
-  
-  conn->in_sck=sck;
-  make_stream(conn->in_s);
-  init_stream(conn->in_s, 8196);
-  make_stream(conn->out_s);
-  init_stream(conn->out_s, 8196);
-
-  return conn;
+  log_message(s_log, LOG_LEVEL_WARNING, "[init:%d] libscp initialized", __LINE__);
+
+  return 0;
 }
 
diff --git a/sesman/libscp/libscp_init.h b/sesman/libscp/libscp_init.h
index 0ff3a44..5acdbc2 100644
--- a/sesman/libscp/libscp_init.h
+++ b/sesman/libscp/libscp_init.h
@@ -14,7 +14,7 @@
    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
 
    xrdp: A Remote Desktop Protocol server.
-   Copyright (C) Jay Sorg 2005-2007
+   Copyright (C) Jay Sorg 2005-2008
 */
 
 /**
@@ -28,6 +28,8 @@
 #ifndef LIBSCP_INIT_H
 #define LIBSCP_INIT_H
 
+#include "log.h"
+
 #include "libscp.h"
 
 /**
@@ -40,16 +42,7 @@
  *
  */
 int DEFAULT_CC 
-scp_init(void);
-
-/**
- *
- * @brief mmm
- * @param sck
- *
- */	
-struct SCP_CONNECTION*
-scp_make_connection(int sck);
+scp_init(struct log_config* log);
 
 #endif
 
diff --git a/sesman/libscp/libscp_lock.c b/sesman/libscp/libscp_lock.c
index abc110d..ef36472 100644
--- a/sesman/libscp/libscp_lock.c
+++ b/sesman/libscp/libscp_lock.c
@@ -14,7 +14,7 @@
    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
 
    xrdp: A Remote Desktop Protocol server.
-   Copyright (C) Jay Sorg 2005-2007
+   Copyright (C) Jay Sorg 2005-2008
 
    session manager
    linux only
diff --git a/sesman/libscp/libscp_lock.h b/sesman/libscp/libscp_lock.h
index 5e29c30..235c6fe 100644
--- a/sesman/libscp/libscp_lock.h
+++ b/sesman/libscp/libscp_lock.h
@@ -14,7 +14,7 @@
    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
 
    xrdp: A Remote Desktop Protocol server.
-   Copyright (C) Jay Sorg 2005-2007
+   Copyright (C) Jay Sorg 2005-2008
 */
 
 #ifndef LIBSCP_LOCK_H
diff --git a/sesman/libscp/libscp_session.c b/sesman/libscp/libscp_session.c
new file mode 100644
index 0000000..6f86e20
--- /dev/null
+++ b/sesman/libscp/libscp_session.c
@@ -0,0 +1,336 @@
+/*
+   This program is free software; you can redistribute it and/or modify
+   it under the terms of the GNU General Public License as published by
+   the Free Software Foundation; either version 2 of the License, or
+   (at your option) any later version.
+
+   This program is distributed in the hope that it will be useful,
+   but WITHOUT ANY WARRANTY; without even the implied warranty of
+   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+   GNU General Public License for more details.
+
+   You should have received a copy of the GNU General Public License
+   along with this program; if not, write to the Free Software
+   Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
+
+   xrdp: A Remote Desktop Protocol server.
+   Copyright (C) Jay Sorg 2005-2008
+*/
+
+/**
+ *
+ * @file libscp_session.c
+ * @brief SCP_SESSION handling code
+ * @author Simone Fedele
+ *
+ */
+
+#include "libscp_session.h"
+
+#include <sys/types.h>
+#include <sys/socket.h>
+#include <arpa/inet.h>
+
+extern struct log_config* s_log;
+
+struct SCP_SESSION*
+scp_session_create()
+{
+  struct SCP_SESSION* s;
+
+  s = g_malloc(sizeof(struct SCP_SESSION), 0);
+
+  if (0 == s)
+  {
+    log_message(s_log, LOG_LEVEL_WARNING, "[session:%d] session create: malloc error", __LINE__);
+    return 0;
+  }
+
+  s->username = 0;
+  s->password = 0;
+  s->hostname = 0;
+  s->errstr = 0;
+  s->locale[0]='\0';
+
+  return s;
+}
+
+/*******************************************************************/
+int
+scp_session_set_type(struct SCP_SESSION* s, tui8 type)
+{
+  switch (type)
+  {
+    case SCP_SESSION_TYPE_XVNC:
+      s->type = SCP_SESSION_TYPE_XVNC;
+      break;
+    case SCP_SESSION_TYPE_XRDP:
+      s->type = SCP_SESSION_TYPE_XRDP;
+      break;
+    case SCP_SESSION_TYPE_MANAGE:
+      s->type = SCP_SESSION_TYPE_MANAGE;
+      break;
+    default:
+      log_message(s_log, LOG_LEVEL_WARNING, "[session:%d] set_type: unknown type", __LINE__);
+      return 1;
+  }
+  return 0;
+}
+
+/*******************************************************************/
+int
+scp_session_set_version(struct SCP_SESSION* s, tui32 version)
+{
+  switch (version)
+  {
+    case 0:
+      s->version = 0;
+      break;
+    case 1:
+      s->version = 1;
+      break;
+    default:
+      log_message(s_log, LOG_LEVEL_WARNING, "[session:%d] set_version: unknown version", __LINE__);
+      return 1;
+  }
+  return 0;
+}
+
+/*******************************************************************/
+int
+scp_session_set_height(struct SCP_SESSION* s, tui16 h)
+{
+  s->height = h;
+  return 0;
+}
+
+/*******************************************************************/
+int
+scp_session_set_width(struct SCP_SESSION* s, tui16 w)
+{
+  s->width = w;
+  return 0;
+}
+
+/*******************************************************************/
+int
+scp_session_set_bpp(struct SCP_SESSION* s, tui8 bpp)
+{
+  switch (bpp)
+  {
+    case 8:
+    case 16:
+    case 24:
+      s->bpp = bpp;
+    default:
+      return 1;
+  }
+  return 0;
+}
+
+/*******************************************************************/
+int
+scp_session_set_rsr(struct SCP_SESSION* s, tui8 rsr)
+{
+  if (s->rsr)
+  {
+    s->rsr = 1;
+  }
+  else
+  {
+    s->rsr = 0;
+  }
+  return 0;
+}
+
+/*******************************************************************/
+int
+scp_session_set_locale(struct SCP_SESSION* s, char* str)
+{
+  if (0 == str)
+  {
+    log_message(s_log, LOG_LEVEL_WARNING, "[session:%d] set_locale: null locale", __LINE__);
+    s->locale[0]='\0';
+    return 1;
+  }
+  g_strncpy(s->locale, str, 17);
+  s->locale[17]='\0';
+  return 0;
+}
+
+/*******************************************************************/
+int
+scp_session_set_username(struct SCP_SESSION* s, char* str)
+{
+  if (0 == str)
+  {
+    log_message(s_log, LOG_LEVEL_WARNING, "[session:%d] set_username: null username", __LINE__);
+    return 1;
+  }
+  if (0 != s->username)
+  {
+    g_free(s->username);
+  }
+  s->username = g_strdup(str);
+  if (0 == s->username)
+  {
+    log_message(s_log, LOG_LEVEL_WARNING, "[session:%d] set_username: strdup error", __LINE__);
+    return 1;
+  }
+  return 0;
+}
+
+/*******************************************************************/
+int
+scp_session_set_password(struct SCP_SESSION* s, char* str)
+{
+  if (0 == str)
+  {
+    log_message(s_log, LOG_LEVEL_WARNING, "[session:%d] set_password: null password", __LINE__);
+    return 1;
+  }
+  if (0 != s->password)
+  {
+    g_free(s->password);
+  }
+  s->password = g_strdup(str);
+  if (0 == s->password)
+  {
+    log_message(s_log, LOG_LEVEL_WARNING, "[session:%d] set_password: strdup error", __LINE__);
+    return 1;
+  }
+  return 0;
+}
+
+/*******************************************************************/
+int
+scp_session_set_hostname(struct SCP_SESSION* s, char* str)
+{
+  if (0 == str)
+  {
+    log_message(s_log, LOG_LEVEL_WARNING, "[session:%d] set_hostname: null hostname", __LINE__);
+    return 1;
+  }
+  if (0 != s->hostname)
+  {
+    g_free(s->hostname);
+  }
+  s->hostname = g_strdup(str);
+  if (0 == s->hostname)
+  {
+    log_message(s_log, LOG_LEVEL_WARNING, "[session:%d] set_hostname: strdup error", __LINE__);
+    return 1;
+  }
+  return 0;
+}
+
+/*******************************************************************/
+int
+scp_session_set_errstr(struct SCP_SESSION* s, char* str)
+{
+  if (0 == str)
+  {
+    log_message(s_log, LOG_LEVEL_WARNING, "[session:%d] set_errstr: null string", __LINE__);
+    return 1;
+  }
+  if (0 != s->errstr)
+  {
+    g_free(s->errstr);
+  }
+  s->errstr = g_strdup(str);
+  if (0 == s->errstr)
+  {
+    log_message(s_log, LOG_LEVEL_WARNING, "[session:%d] set_errstr: strdup error", __LINE__);
+    return 1;
+  }
+  return 0;
+}
+
+/*******************************************************************/
+int
+scp_session_set_display(struct SCP_SESSION* s, SCP_DISPLAY display)
+{
+  s->display = display;
+  return 0;
+}
+
+/*******************************************************************/
+int
+scp_session_set_addr(struct SCP_SESSION* s, int type, void* addr)
+{
+  struct in_addr ip4;
+#ifdef IN6ADDR_ANY_INIT
+  struct in6_addr ip6;
+#endif
+  int ret;
+
+  switch (type)
+  {
+    case SCP_ADDRESS_TYPE_IPV4:
+      /* convert from char to 32bit*/
+      ret = inet_pton(AF_INET, addr, &ip4);
+      if (0 == ret)
+      {
+        log_message(s_log, LOG_LEVEL_WARNING, "[session:%d] set_addr: invalid address", __LINE__);
+        inet_pton(AF_INET, "127.0.0.1", &ip4);
+        g_memcpy(&(s->ipv4addr), &(ip4.s_addr), 4);
+        return 1;
+      }
+      g_memcpy(&(s->ipv4addr), &(ip4.s_addr), 4);
+      break;
+    case SCP_ADDRESS_TYPE_IPV4_BIN:
+      g_memcpy(&(s->ipv4addr), addr, 4);
+      break;
+#ifdef IN6ADDR_ANY_INIT
+    case SCP_ADDRESS_TYPE_IPV6:
+      /* convert from char to 128bit*/
+      ret = inet_pton(AF_INET6, addr, &ip6);
+      if (0 == ret)
+      {
+        log_message(s_log, LOG_LEVEL_WARNING, "[session:%d] set_addr: invalid address", __LINE__);
+        inet_pton(AF_INET, "::1", &ip6);
+        g_memcpy(s->ipv6addr, &(ip6.s6_addr), 16);
+        return 1;
+      }
+      g_memcpy(s->ipv6addr, &(ip6.s6_addr), 16);
+      break;
+    case SCP_ADDRESS_TYPE_IPV6_BIN:
+      g_memcpy(s->ipv6addr, addr, 16);
+      break;
+#endif
+    default:
+      return 1;
+  }
+  return 0;
+}
+
+/*******************************************************************/
+void
+scp_session_destroy(struct SCP_SESSION* s)
+{
+  if (s->username)
+  {
+    g_free(s->username);
+    s->username=0;
+  }
+
+  if (s->password)
+  {
+    g_free(s->password);
+    s->password=0;
+  }
+
+  if (s->hostname)
+  {
+    g_free(s->hostname);
+    s->hostname=0;
+  }
+
+  if (s->errstr)
+  {
+    g_free(s->errstr);
+    s->errstr=0;
+  }
+
+  g_free(s);
+}
diff --git a/sesman/libscp/libscp_session.h b/sesman/libscp/libscp_session.h
new file mode 100644
index 0000000..aefeb20
--- /dev/null
+++ b/sesman/libscp/libscp_session.h
@@ -0,0 +1,92 @@
+/*
+   This program is free software; you can redistribute it and/or modify
+   it under the terms of the GNU General Public License as published by
+   the Free Software Foundation; either version 2 of the License, or
+   (at your option) any later version.
+
+   This program is distributed in the hope that it will be useful,
+   but WITHOUT ANY WARRANTY; without even the implied warranty of
+   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+   GNU General Public License for more details.
+
+   You should have received a copy of the GNU General Public License
+   along with this program; if not, write to the Free Software
+   Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
+
+   xrdp: A Remote Desktop Protocol server.
+   Copyright (C) Jay Sorg 2005-2008
+*/
+
+/**
+ *
+ * @file libscp_session.h
+ * @brief SCP_SESSION handling code
+ * @author Simone Fedele
+ *
+ */
+
+#ifndef LIBSCP_SESSION_H
+#define LIBSCP_SESSION_H
+
+#include "libscp.h"
+
+/**
+ *
+ * @brief creates a new connection
+ * @param sck the connection socket
+ *
+ * @return a struct SCP_SESSION* object on success, NULL otherwise
+ *
+ */
+struct SCP_SESSION*
+scp_session_create();
+
+int
+scp_session_set_type(struct SCP_SESSION* s, tui8 type);
+
+int
+scp_session_set_version(struct SCP_SESSION* s, tui32 version);
+
+int
+scp_session_set_height(struct SCP_SESSION* s, tui16 h);
+
+int
+scp_session_set_width(struct SCP_SESSION* s, tui16 w);
+
+int
+scp_session_set_bpp(struct SCP_SESSION* s, tui8 bpp);
+
+int
+scp_session_set_rsr(struct SCP_SESSION* s, tui8 rsr);
+
+int
+scp_session_set_locale(struct SCP_SESSION* s, char* str);
+
+int
+scp_session_set_username(struct SCP_SESSION* s, char* str);
+
+int
+scp_session_set_password(struct SCP_SESSION* s, char* str);
+
+int
+scp_session_set_hostname(struct SCP_SESSION* s, char* str);
+
+int
+scp_session_set_addr(struct SCP_SESSION* s, int type, void* addr);
+
+int
+scp_session_set_display(struct SCP_SESSION* s, SCP_DISPLAY display);
+
+int
+scp_session_set_errstr(struct SCP_SESSION* s, char* str);
+
+/**
+ *
+ * @brief destroys a session object
+ * @param s the object to be destroyed
+ *
+ */
+void
+scp_session_destroy(struct SCP_SESSION* s);
+
+#endif
diff --git a/sesman/libscp/libscp_tcp.c b/sesman/libscp/libscp_tcp.c
index 2569309..0181f50 100644
--- a/sesman/libscp/libscp_tcp.c
+++ b/sesman/libscp/libscp_tcp.c
@@ -14,7 +14,7 @@
    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
 
    xrdp: A Remote Desktop Protocol server.
-   Copyright (C) Jay Sorg 2005-2007
+   Copyright (C) Jay Sorg 2005-2008
 */
 
 /**
@@ -33,13 +33,16 @@
 #include <stdlib.h>
 #include <string.h>
 
+extern struct log_config* s_log;
+
 /*****************************************************************************/
 int DEFAULT_CC
 scp_tcp_force_recv(int sck, char* data, int len)
 {
   int rcvd;
   int block;
-  
+
+  LOG_DBG(s_log, "scp_tcp_force_recv()");
   block = scp_lock_fork_critical_section_start();
 
   while (len > 0)
@@ -80,7 +83,8 @@ scp_tcp_force_send(int sck, char* data, int len)
 {
   int sent;
   int block;
-  
+
+  LOG_DBG(s_log, "scp_tcp_force_send()");
   block = scp_lock_fork_critical_section_start();
 
   while (len > 0)
diff --git a/sesman/libscp/libscp_tcp.h b/sesman/libscp/libscp_tcp.h
index aa21c60..085db2b 100644
--- a/sesman/libscp/libscp_tcp.h
+++ b/sesman/libscp/libscp_tcp.h
@@ -14,7 +14,7 @@
    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
 
    xrdp: A Remote Desktop Protocol server.
-   Copyright (C) Jay Sorg 2005-2007
+   Copyright (C) Jay Sorg 2005-2008
 */
 
 /**
diff --git a/sesman/libscp/libscp_types.h b/sesman/libscp/libscp_types.h
index d4cea66..b8b5d6b 100644
--- a/sesman/libscp/libscp_types.h
+++ b/sesman/libscp/libscp_types.h
@@ -14,7 +14,7 @@
    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
 
    xrdp: A Remote Desktop Protocol server.
-   Copyright (C) Jay Sorg 2005-2007
+   Copyright (C) Jay Sorg 2005-2008
 */
 
 /**
@@ -31,7 +31,7 @@
 #include "os_calls.h"
 #include "parse.h"
 #include "arch.h"
-//#include "log.h"
+#include "log.h"
 
 #define SCP_SID      tui32
 #define SCP_DISPLAY  tui16
@@ -39,12 +39,17 @@
 #define SCP_RESOURCE_SHARING_REQUEST_YES 0x01
 #define SCP_RESOURCE_SHARING_REQUEST_NO  0x00
 
-#define SCP_SESSION_TYPE_XVNC 0x00
-#define SCP_SESSION_TYPE_XRDP 0x01
+#define SCP_SESSION_TYPE_XVNC    0x00
+#define SCP_SESSION_TYPE_XRDP    0x01
+#define SCP_SESSION_TYPE_MANAGE  0x02
 
 #define SCP_ADDRESS_TYPE_IPV4 0x00
 #define SCP_ADDRESS_TYPE_IPV6 0x01
 
+/* used in scp_session_set_addr() */
+#define SCP_ADDRESS_TYPE_IPV4_BIN 0x80
+#define SCP_ADDRESS_TYPE_IPV6_BIN 0x81
+
 #define SCP_COMMAND_SET_DEFAULT 0x0000
 #define SCP_COMMAND_SET_MANAGE  0x0001
 #define SCP_COMMAND_SET_RSR     0x0002
@@ -62,19 +67,19 @@ struct SCP_CONNECTION
 
 struct SCP_SESSION
 {
-  tui8 type;
+  tui8  type;
   tui32 version;
   tui16 height;
   tui16 width;
-  tui8 bpp;
-  tui8 rsr;
-  char locale[18];
+  tui8  bpp;
+  tui8  rsr;
+  char  locale[18];
   char* username;
   char* password;
   char* hostname;
-  tui8 addr_type;
-  tui32 ipv4addr; //htons
-  tui32 ipv6addr; //should be 128bit
+  tui8  addr_type;
+  tui32 ipv4addr;
+  tui8  ipv6addr[16];
   tui16 display;
   char* errstr;
 };
@@ -83,12 +88,21 @@ struct SCP_DISCONNECTED_SESSION
 {
   tui32 SID;
   tui8  type;
+  tui8  status;
   tui16 height;
   tui16 width;
   tui8  bpp;
   tui8  idle_days;
   tui8  idle_hours;
   tui8  idle_minutes;
+  tui16 conn_year;
+  tui8  conn_month;
+  tui8  conn_day;
+  tui8  conn_hour;
+  tui8  conn_minute;
+  tui8  addr_type;
+  tui32 ipv4addr;
+  tui8  ipv6addr[16];
 };
 
 enum SCP_CLIENT_STATES_E
diff --git a/sesman/libscp/libscp_v0.c b/sesman/libscp/libscp_v0.c
index e2cd206..bd94146 100644
--- a/sesman/libscp/libscp_v0.c
+++ b/sesman/libscp/libscp_v0.c
@@ -14,7 +14,7 @@
    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
 
    xrdp: A Remote Desktop Protocol server.
-   Copyright (C) Jay Sorg 2005-2007
+   Copyright (C) Jay Sorg 2005-2008
 */
 
 /**
@@ -28,6 +28,9 @@
 #include "libscp_v0.h"
 
 #include "os_calls.h"
+
+extern struct log_config* s_log;
+
 /* client API */
 /******************************************************************************/
 enum SCP_CLIENT_STATES_E scp_v0c_connect(struct SCP_CONNECTION* c, struct SCP_SESSION* s)
@@ -39,20 +42,23 @@ enum SCP_CLIENT_STATES_E scp_v0c_connect(struct SCP_CONNECTION* c, struct SCP_SE
   init_stream(c->in_s, c->in_s->size);
   init_stream(c->out_s, c->in_s->size);
 
+  LOG_DBG(s_log, "[v0:%d] starting connection", __LINE__);
   g_tcp_set_non_blocking(c->in_sck);
   g_tcp_set_no_delay(c->in_sck);
   s_push_layer(c->out_s, channel_hdr, 8);
 
-  if (s->type==SCP_SESSION_TYPE_XVNC)
+  /* code */
+  if (s->type == SCP_SESSION_TYPE_XVNC)
   {
-    out_uint16_be(c->out_s, 0); // code
+    out_uint16_be(c->out_s, 0);
   }
-  else if (s->type==SCP_SESSION_TYPE_XRDP)
+  else if (s->type == SCP_SESSION_TYPE_XRDP)
   {
-    out_uint16_be(c->out_s, 10); // code
+    out_uint16_be(c->out_s, 10);
   }
   else
   {
+    log_message(s_log, LOG_LEVEL_WARNING, "[v0:%d] connection aborted: network error", __LINE__);
     return SCP_CLIENT_STATE_INTERNAL_ERR;
   }
   sz = g_strlen(s->username);
@@ -69,52 +75,65 @@ enum SCP_CLIENT_STATES_E scp_v0c_connect(struct SCP_CONNECTION* c, struct SCP_SE
   s_mark_end(c->out_s);
   s_pop_layer(c->out_s, channel_hdr);
 
-  out_uint32_be(c->out_s, 0);                // version
-  out_uint32_be(c->out_s, c->out_s->end - c->out_s->data); // size
+  /* version */
+  out_uint32_be(c->out_s, 0);
+  /* size */
+  out_uint32_be(c->out_s, c->out_s->end - c->out_s->data);
 
   if (0!=scp_tcp_force_send(c->in_sck, c->out_s->data, c->out_s->end - c->out_s->data))
   {
+    log_message(s_log, LOG_LEVEL_WARNING, "[v0:%d] connection aborted: network error", __LINE__);
     return SCP_CLIENT_STATE_NETWORK_ERR;
   }
 
   if (0!=scp_tcp_force_recv(c->in_sck, c->in_s->data, 8))
   {
+    log_message(s_log, LOG_LEVEL_WARNING, "[v0:%d] connection aborted: network error", __LINE__);
     return SCP_CLIENT_STATE_NETWORK_ERR;
   }
 
   in_uint32_be(c->in_s, version);
   if (0 != version)
   {
+    log_message(s_log, LOG_LEVEL_WARNING, "[v0:%d] connection aborted: version error", __LINE__);
     return SCP_CLIENT_STATE_VERSION_ERR;
   }
 
   in_uint32_be(c->in_s, size);
   if (size < 14)
   {
+    log_message(s_log, LOG_LEVEL_WARNING, "[v0:%d] connection aborted: packet size error", __LINE__);
     return SCP_CLIENT_STATE_SIZE_ERR;
   }
 
+  /* getting payload */
   init_stream(c->in_s, c->in_s->size);
   if (0!=scp_tcp_force_recv(c->in_sck, c->in_s->data, size - 8))
   {
+    log_message(s_log, LOG_LEVEL_WARNING, "[v0:%d] connection aborted: network error", __LINE__);
     return SCP_CLIENT_STATE_NETWORK_ERR;
   }
 
+  /* check code */
   in_uint16_be(c->in_s, sz);
-  if (3!=sz)
+  if (3 != sz)
   {
+    log_message(s_log, LOG_LEVEL_WARNING, "[v0:%d] connection aborted: sequence error", __LINE__);
     return SCP_CLIENT_STATE_SEQUENCE_ERR;
   }
 
+  /* message payload */
   in_uint16_be(c->in_s, sz);
-  if (1!=sz)
+  if (1 != sz)
   {
+    log_message(s_log, LOG_LEVEL_WARNING, "[v0:%d] connection aborted: connection denied", __LINE__);
     return SCP_CLIENT_STATE_CONNECTION_DENIED;
   }
 
   in_uint16_be(c->in_s, sz);
-  s->display=sz;
+  s->display = sz;
 
+  LOG_DBG(s_log, "[v0:%d] connection terminated", __LINE__);
   return SCP_CLIENT_STATE_END;
 }
 
@@ -122,24 +141,28 @@ enum SCP_CLIENT_STATES_E scp_v0c_connect(struct SCP_CONNECTION* c, struct SCP_SE
 /******************************************************************************/
 enum SCP_SERVER_STATES_E scp_v0s_accept(struct SCP_CONNECTION* c, struct SCP_SESSION** s, int skipVchk)
 {
-  tui32 version=0;
+  tui32 version = 0;
   tui32 size;
-  struct SCP_SESSION* session=0;
+  struct SCP_SESSION* session = 0;
   tui16 sz;
-  tui32 code=0;
+  tui32 code = 0;
+  char buf[257];
 
   if (!skipVchk)
   {
+    LOG_DBG(s_log, "[v0:%d] starting connection", __LINE__);
     if (0==scp_tcp_force_recv(c->in_sck, c->in_s->data, 8))
     {
       in_uint32_be(c->in_s, version);
       if (version != 0)
       {
+        log_message(s_log, LOG_LEVEL_WARNING, "[v0:%d] connection aborted: version error", __LINE__);
         return SCP_SERVER_STATE_VERSION_ERR;
       }
     }
     else
     {
+      log_message(s_log, LOG_LEVEL_WARNING, "[v0:%d] connection aborted: network error", __LINE__);
       return SCP_SERVER_STATE_NETWORK_ERR;
     }
   }
@@ -149,6 +172,7 @@ enum SCP_SERVER_STATES_E scp_v0s_accept(struct SCP_CONNECTION* c, struct SCP_SES
   init_stream(c->in_s, 8196);
   if (0!=scp_tcp_force_recv(c->in_sck, c->in_s->data, size-8))
   {
+    log_message(s_log, LOG_LEVEL_WARNING, "[v0:%d] connection aborted: network error", __LINE__);
     return SCP_SERVER_STATE_NETWORK_ERR;
   }
 
@@ -156,53 +180,58 @@ enum SCP_SERVER_STATES_E scp_v0s_accept(struct SCP_CONNECTION* c, struct SCP_SES
 
   if (code == 0 || code == 10)
   {
-    session = g_malloc(sizeof(struct SCP_SESSION),1);
+	session = scp_session_create();
     if (0 == session)
     {
+      log_message(s_log, LOG_LEVEL_WARNING, "[v0:%d] connection aborted: network error", __LINE__);
       return SCP_SERVER_STATE_INTERNAL_ERR;
     }
 
-    session->version=version;
-
+    scp_session_set_version(session, version);
     if (code == 0)
     {
-      session->type=SCP_SESSION_TYPE_XVNC;
+      scp_session_set_type(session, SCP_SESSION_TYPE_XVNC);
     }
     else
     {
-      session->type=SCP_SESSION_TYPE_XRDP;
+      scp_session_set_type(session, SCP_SESSION_TYPE_XRDP);
     }
 
     /* reading username */
     in_uint16_be(c->in_s, sz);
-    session->username=g_malloc(sz+1,0);
-    if (0==session->username)
+    buf[sz]='\0';
+    in_uint8a(c->in_s, buf, sz);
+    if (0 != scp_session_set_username(session, buf))
     {
-      g_free(session);
+      scp_session_destroy(session);
+      log_message(s_log, LOG_LEVEL_WARNING, "[v0:%d] connection aborted: error setting username", __LINE__);
       return SCP_SERVER_STATE_INTERNAL_ERR;
     }
-    session->username[sz]='\0';
-    in_uint8a(c->in_s, session->username, sz);
 
     /* reading password */
     in_uint16_be(c->in_s, sz);
-    session->password=g_malloc(sz+1,0);
-    if (0==session->password)
+    buf[sz]='\0';
+    in_uint8a(c->in_s, buf, sz);
+    if (0 != scp_session_set_password(session, buf))
     {
-      g_free(session->username);
-      g_free(session);
+      scp_session_destroy(session);
+      log_message(s_log, LOG_LEVEL_WARNING, "[v0:%d] connection aborted: error setting password", __LINE__);
       return SCP_SERVER_STATE_INTERNAL_ERR;
     }
-    session->password[sz]='\0';
-    in_uint8a(c->in_s, session->password, sz);
 
-    in_uint16_be(c->in_s, session->width);
-    in_uint16_be(c->in_s, session->height);
+    /* width */
+    in_uint16_be(c->in_s, sz);
+    scp_session_set_width(session, sz);
+    /* height */
     in_uint16_be(c->in_s, sz);
-    session->bpp=(unsigned char)sz;
+    scp_session_set_height(session, sz);
+    /* bpp */
+    in_uint16_be(c->in_s, sz);
+    scp_session_set_bpp(session, (tui8)sz);
   }
   else
   {
+    log_message(s_log, LOG_LEVEL_WARNING, "[v0:%d] connection aborted: sequence error", __LINE__);
     return SCP_SERVER_STATE_SEQUENCE_ERR;
   }
 
@@ -220,11 +249,13 @@ enum SCP_SERVER_STATES_E scp_v0s_allow_connection(struct SCP_CONNECTION* c, SCP_
   out_uint16_be(c->out_s, d);  /* data */
   s_mark_end(c->out_s);
 
-  if (0!=scp_tcp_force_send(c->in_sck, c->out_s->data, c->out_s->end - c->out_s->data))
+  if (0 != scp_tcp_force_send(c->in_sck, c->out_s->data, c->out_s->end - c->out_s->data))
   {
+    log_message(s_log, LOG_LEVEL_WARNING, "[v0:%d] connection aborted: network error", __LINE__);
     return SCP_SERVER_STATE_NETWORK_ERR;
   }
 
+  LOG_DBG(s_log, "[v0:%d] connection terminated (allowed)", __LINE__);
   return SCP_SERVER_STATE_OK;
 }
 
@@ -238,10 +269,12 @@ enum SCP_SERVER_STATES_E scp_v0s_deny_connection(struct SCP_CONNECTION* c)
   out_uint16_be(c->out_s, 0);  /* data */
   s_mark_end(c->out_s);
 
-  if (0!=scp_tcp_force_send(c->in_sck, c->out_s->data, c->out_s->end - c->out_s->data))
+  if (0 != scp_tcp_force_send(c->in_sck, c->out_s->data, c->out_s->end - c->out_s->data))
   {
+    log_message(s_log, LOG_LEVEL_WARNING, "[v0:%d] connection aborted: network error", __LINE__);
     return SCP_SERVER_STATE_NETWORK_ERR;
   }
 
+  LOG_DBG(s_log, "[v0:%d] connection terminated (denied)", __LINE__);
   return SCP_SERVER_STATE_OK;
 }
diff --git a/sesman/libscp/libscp_v0.h b/sesman/libscp/libscp_v0.h
index 567b10f..fa21934 100644
--- a/sesman/libscp/libscp_v0.h
+++ b/sesman/libscp/libscp_v0.h
@@ -14,7 +14,7 @@
    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
 
    xrdp: A Remote Desktop Protocol server.
-   Copyright (C) Jay Sorg 2005-2007
+   Copyright (C) Jay Sorg 2005-2008
 */
 
 /**
diff --git a/sesman/libscp/libscp_v1c.c b/sesman/libscp/libscp_v1c.c
index a103649..c3f4ce9 100644
--- a/sesman/libscp/libscp_v1c.c
+++ b/sesman/libscp/libscp_v1c.c
@@ -14,7 +14,7 @@
    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
 
    xrdp: A Remote Desktop Protocol server.
-   Copyright (C) Jay Sorg 2005-2007
+   Copyright (C) Jay Sorg 2005-2008
 */
 
 /**
@@ -30,11 +30,13 @@
 #include <stdlib.h>
 #include <stdio.h>
 
-static enum SCP_CLIENT_STATES_E _scp_v1c_check_response(struct SCP_CONNECTION* c, struct SCP_SESSION* s);
+static enum SCP_CLIENT_STATES_E
+_scp_v1c_check_response(struct SCP_CONNECTION* c, struct SCP_SESSION* s);
 
 /* client API */
 /* 001 */
-enum SCP_CLIENT_STATES_E scp_v1c_connect(struct SCP_CONNECTION* c, struct SCP_SESSION* s)
+enum SCP_CLIENT_STATES_E
+scp_v1c_connect(struct SCP_CONNECTION* c, struct SCP_SESSION* s)
 {
   tui8 sz;
   tui32 size;
@@ -42,14 +44,15 @@ enum SCP_CLIENT_STATES_E scp_v1c_connect(struct SCP_CONNECTION* c, struct SCP_SE
   init_stream(c->out_s, c->out_s->size);
   init_stream(c->in_s, c->in_s->size);
 
-  size=19+17+4+ g_strlen(s->hostname) + g_strlen(s->username) + g_strlen(s->password);
-  if (s->addr_type==SCP_ADDRESS_TYPE_IPV4)
+  size = 19 + 17 + 4 + g_strlen(s->hostname) + g_strlen(s->username) +
+         g_strlen(s->password);
+  if (s->addr_type == SCP_ADDRESS_TYPE_IPV4)
   {
-    size=size+4;
+    size = size + 4;
   }
   else
   {
-    size=size+16;
+    size = size + 16;
   }
 
   /* sending request */
@@ -69,26 +72,26 @@ enum SCP_CLIENT_STATES_E scp_v1c_connect(struct SCP_CONNECTION* c, struct SCP_SE
   out_uint8p(c->out_s, s->locale, 17);
   out_uint8(c->out_s, s->addr_type);
 
-  if (s->addr_type==SCP_ADDRESS_TYPE_IPV4)
+  if (s->addr_type == SCP_ADDRESS_TYPE_IPV4)
   {
     out_uint32_be(c->out_s, s->ipv4addr);
   }
-  else
+  else if (s->addr_type == SCP_ADDRESS_TYPE_IPV6)
   {
-    #warning ipv6 address needed
+    out_uint8p(c->out_s, s->ipv6addr, 16);
   }
 
-  sz=g_strlen(s->hostname);
+  sz = g_strlen(s->hostname);
   out_uint8(c->out_s, sz);
   out_uint8p(c->out_s, s->hostname, sz);
-  sz=g_strlen(s->username);
+  sz = g_strlen(s->username);
   out_uint8(c->out_s, sz);
   out_uint8p(c->out_s, s->username, sz);
-  sz=g_strlen(s->password);
+  sz = g_strlen(s->password);
   out_uint8(c->out_s, sz);
   out_uint8p(c->out_s, s->password, sz);
 
-  if (0!=scp_tcp_force_send(c->in_sck, c->out_s->data, size))
+  if (0 != scp_tcp_force_send(c->in_sck, c->out_s->data, size))
   {
     return SCP_CLIENT_STATE_NETWORK_ERR;
   }
@@ -98,7 +101,8 @@ enum SCP_CLIENT_STATES_E scp_v1c_connect(struct SCP_CONNECTION* c, struct SCP_SE
 }
 
 /* 004 */
-enum SCP_CLIENT_STATES_E scp_v1c_resend_credentials(struct SCP_CONNECTION* c, struct SCP_SESSION* s)
+enum SCP_CLIENT_STATES_E
+scp_v1c_resend_credentials(struct SCP_CONNECTION* c, struct SCP_SESSION* s)
 {
   tui8 sz;
   tui32 size;
@@ -106,7 +110,7 @@ enum SCP_CLIENT_STATES_E scp_v1c_resend_credentials(struct SCP_CONNECTION* c, st
   init_stream(c->out_s, c->out_s->size);
   init_stream(c->in_s, c->in_s->size);
 
-  size=12+2+g_strlen(s->username)+g_strlen(s->password);
+  size = 12 + 2 + g_strlen(s->username) + g_strlen(s->password);
 
   /* sending request */
   /* header */
@@ -116,14 +120,14 @@ enum SCP_CLIENT_STATES_E scp_v1c_resend_credentials(struct SCP_CONNECTION* c, st
   out_uint16_be(c->out_s, 4);
 
   /* body */
-  sz=g_strlen(s->username);
+  sz = g_strlen(s->username);
   out_uint8(c->out_s, sz);
   out_uint8p(c->out_s, s->username, sz);
-  sz=g_strlen(s->password);
+  sz = g_strlen(s->password);
   out_uint8(c->out_s, sz);
   out_uint8p(c->out_s, s->password, sz);
 
-  if (0!=scp_tcp_force_send(c->in_sck, c->out_s->data, size))
+  if (0 != scp_tcp_force_send(c->in_sck, c->out_s->data, size))
   {
     return SCP_CLIENT_STATE_NETWORK_ERR;
   }
@@ -132,24 +136,29 @@ enum SCP_CLIENT_STATES_E scp_v1c_resend_credentials(struct SCP_CONNECTION* c, st
   return _scp_v1c_check_response(c, s);
 }
 
-/* 021 */ enum SCP_CLIENT_STATES_E scp_v1c_pwd_change(struct SCP_CONNECTION* c, char* newpass);
-/* 022 */ enum SCP_CLIENT_STATES_E scp_v1c_pwd_change_cancel(struct SCP_CONNECTION* c);
+/* 021 */
+enum SCP_CLIENT_STATES_E
+scp_v1c_pwd_change(struct SCP_CONNECTION* c, char* newpass);
+/* 022 */
+enum SCP_CLIENT_STATES_E
+scp_v1c_pwd_change_cancel(struct SCP_CONNECTION* c);
 
 /* 041 */
 enum SCP_CLIENT_STATES_E
-scp_v1c_get_session_list(struct SCP_CONNECTION* c, int* scount, struct SCP_DISCONNECTED_SESSION** s)
+scp_v1c_get_session_list(struct SCP_CONNECTION* c, int* scount,
+                         struct SCP_DISCONNECTED_SESSION** s)
 {
-  tui32 version=1;
-  tui32 size=12;
-  tui16 cmd=41;
-  tui32 sescnt=0;     /* total session number */
-  tui32 sestmp=0;     /* additional total session number */
-  tui8 pktcnt=0;     /* packet session count */
-  tui32 totalcnt=0;   /* session counter */
-  tui8 continued=0;  /* continue flag */
-  int firstpkt=1;        /* "first packet" flag */
+  tui32 version = 1;
+  tui32 size = 12;
+  tui16 cmd = 41;
+  tui32 sescnt = 0;    /* total session number */
+  tui32 sestmp = 0;    /* additional total session number */
+  tui8 pktcnt = 0;     /* packet session count */
+  tui32 totalcnt = 0;  /* session counter */
+  tui8 continued = 0;  /* continue flag */
+  int firstpkt = 1;    /* "first packet" flag */
   int idx;
-  struct SCP_DISCONNECTED_SESSION* ds=0;
+  struct SCP_DISCONNECTED_SESSION* ds = 0;
 
   init_stream(c->out_s, c->out_s->size);
 
@@ -159,7 +168,7 @@ scp_v1c_get_session_list(struct SCP_CONNECTION* c, int* scount, struct SCP_DISCO
   out_uint16_be(c->out_s, SCP_COMMAND_SET_DEFAULT); /* cmdset  */
   out_uint16_be(c->out_s, cmd);                     /* cmd     */
 
-  if (0!=scp_tcp_force_send(c->in_sck, c->out_s->data, size))
+  if (0 != scp_tcp_force_send(c->in_sck, c->out_s->data, size))
   {
     return SCP_CLIENT_STATE_NETWORK_ERR;
   }
@@ -168,37 +177,37 @@ scp_v1c_get_session_list(struct SCP_CONNECTION* c, int* scount, struct SCP_DISCO
   {
     /* then we wait for server response */
     init_stream(c->in_s, c->in_s->size);
-    if (0!=scp_tcp_force_recv(c->in_sck, c->in_s->data, 8))
+    if (0 != scp_tcp_force_recv(c->in_sck, c->in_s->data, 8))
     {
       return SCP_CLIENT_STATE_NETWORK_ERR;
     }
 
     in_uint32_be(c->in_s, version);
-    if (version!=1)
+    if (version != 1)
     {
       return SCP_CLIENT_STATE_VERSION_ERR;
     }
 
     in_uint32_be(c->in_s, size);
-    if (size<12)
+    if (size < 12)
     {
       return SCP_CLIENT_STATE_SIZE_ERR;
     }
 
     init_stream(c->in_s, c->in_s->size);
-    if (0!=scp_tcp_force_recv(c->in_sck, c->in_s->data, size-8))
+    if (0 != scp_tcp_force_recv(c->in_sck, c->in_s->data, size - 8))
     {
       return SCP_CLIENT_STATE_NETWORK_ERR;
     }
 
     in_uint16_be(c->in_s, cmd);
-    if (cmd!=SCP_COMMAND_SET_DEFAULT)
+    if (cmd != SCP_COMMAND_SET_DEFAULT)
     {
       return SCP_CLIENT_STATE_SEQUENCE_ERR;
     }
 
     in_uint16_be(c->in_s, cmd);
-    if (cmd!=42)
+    if (cmd != 42)
     {
       return SCP_CLIENT_STATE_SEQUENCE_ERR;
     }
@@ -209,7 +218,7 @@ scp_v1c_get_session_list(struct SCP_CONNECTION* c, int* scount, struct SCP_DISCO
       in_uint32_be(c->in_s, sescnt);
       sestmp = sescnt;
 
-      ds = g_malloc(sizeof(struct SCP_DISCONNECTED_SESSION)*sescnt, 0);
+      ds = g_malloc(sizeof(struct SCP_DISCONNECTED_SESSION) * sescnt, 0);
       if (ds == 0)
       {
         return SCP_CLIENT_STATE_INTERNAL_ERR;
@@ -222,7 +231,7 @@ scp_v1c_get_session_list(struct SCP_CONNECTION* c, int* scount, struct SCP_DISCO
     in_uint8(c->in_s, continued);
     in_uint8(c->in_s, pktcnt);
 
-    for (idx=0; idx<pktcnt; idx++)
+    for (idx = 0; idx < pktcnt; idx++)
     {
       in_uint32_be(c->in_s, (ds[totalcnt]).SID); /* session id */
       in_uint8(c->in_s, (ds[totalcnt]).type);
@@ -232,6 +241,21 @@ scp_v1c_get_session_list(struct SCP_CONNECTION* c, int* scount, struct SCP_DISCO
       in_uint8(c->in_s, (ds[totalcnt]).idle_days);
       in_uint8(c->in_s, (ds[totalcnt]).idle_hours);
       in_uint8(c->in_s, (ds[totalcnt]).idle_minutes);
+
+      in_uint16_be(c->in_s, (ds[totalcnt]).conn_year);
+      in_uint8(c->in_s, (ds[totalcnt]).conn_month);
+      in_uint8(c->in_s, (ds[totalcnt]).conn_day);
+      in_uint8(c->in_s, (ds[totalcnt]).conn_hour);
+      in_uint8(c->in_s, (ds[totalcnt]).conn_minute);
+      in_uint8(c->in_s, (ds[totalcnt]).addr_type);
+      if ((ds[totalcnt]).addr_type == SCP_ADDRESS_TYPE_IPV4)
+      {
+        in_uint32_be(c->in_s, (ds[totalcnt]).ipv4addr);
+      }
+      else if ((ds[totalcnt]).addr_type == SCP_ADDRESS_TYPE_IPV6)
+      {
+        in_uint8a(c->in_s, (ds[totalcnt]).ipv6addr, 16);
+      }
       totalcnt++;
     }
   }
@@ -247,7 +271,8 @@ scp_v1c_get_session_list(struct SCP_CONNECTION* c, int* scount, struct SCP_DISCO
 
 /* 043 */
 enum SCP_CLIENT_STATES_E
-scp_v1c_select_session(struct SCP_CONNECTION* c, struct SCP_SESSION* s, SCP_SID sid)
+scp_v1c_select_session(struct SCP_CONNECTION* c, struct SCP_SESSION* s,
+                       SCP_SID sid)
 {
   tui32 version = 1;
   tui32 size = 16;
@@ -263,33 +288,33 @@ scp_v1c_select_session(struct SCP_CONNECTION* c, struct SCP_SESSION* s, SCP_SID
 
   out_uint32_be(c->out_s, sid);
 
-  if (0!=scp_tcp_force_send(c->in_sck, c->out_s->data, size))
+  if (0 != scp_tcp_force_send(c->in_sck, c->out_s->data, size))
   {
     return SCP_CLIENT_STATE_NETWORK_ERR;
   }
 
   /* waiting for response.... */
   init_stream(c->in_s, c->in_s->size);
-  if (0!=scp_tcp_force_recv(c->in_sck, c->in_s->data, 8))
+  if (0 != scp_tcp_force_recv(c->in_sck, c->in_s->data, 8))
   {
     return SCP_CLIENT_STATE_NETWORK_ERR;
   }
 
   in_uint32_be(c->in_s, version);
-  if (version!=1)
+  if (version != 1)
   {
     return SCP_CLIENT_STATE_VERSION_ERR;
   }
 
   in_uint32_be(c->in_s, size);
-  if (size<12)
+  if (size < 12)
   {
     return SCP_CLIENT_STATE_SIZE_ERR;
   }
 
   init_stream(c->in_s, c->in_s->size);
   /* read the rest of the packet */
-  if (0!=scp_tcp_force_recv(c->in_sck, c->in_s->data, size-8))
+  if (0 != scp_tcp_force_recv(c->in_sck, c->in_s->data, size - 8))
   {
     return SCP_CLIENT_STATE_NETWORK_ERR;
   }
@@ -330,7 +355,7 @@ scp_v1c_select_session_cancel(struct SCP_CONNECTION* c)
   out_uint16_be(c->out_s, SCP_COMMAND_SET_DEFAULT); /* cmdset  */
   out_uint16_be(c->out_s, cmd);                     /* cmd     */
 
-  if (0!=scp_tcp_force_send(c->in_sck, c->out_s->data, size))
+  if (0 != scp_tcp_force_send(c->in_sck, c->out_s->data, size))
   {
     return SCP_CLIENT_STATE_NETWORK_ERR;
   }
@@ -338,7 +363,8 @@ scp_v1c_select_session_cancel(struct SCP_CONNECTION* c)
   return SCP_CLIENT_STATE_END;
 }
 
-static enum SCP_CLIENT_STATES_E _scp_v1c_check_response(struct SCP_CONNECTION* c, struct SCP_SESSION* s)
+static enum SCP_CLIENT_STATES_E
+_scp_v1c_check_response(struct SCP_CONNECTION* c, struct SCP_SESSION* s)
 {
   tui32 version;
   tui32 size;
@@ -346,13 +372,13 @@ static enum SCP_CLIENT_STATES_E _scp_v1c_check_response(struct SCP_CONNECTION* c
   tui16 dim;
 
   init_stream(c->in_s, c->in_s->size);
-  if (0!=scp_tcp_force_recv(c->in_sck, c->in_s->data, 8))
+  if (0 != scp_tcp_force_recv(c->in_sck, c->in_s->data, 8))
   {
     return SCP_CLIENT_STATE_NETWORK_ERR;
   }
 
   in_uint32_be(c->in_s, version);
-  if (version!=1)
+  if (version != 1)
   {
     return SCP_CLIENT_STATE_VERSION_ERR;
   }
@@ -361,88 +387,87 @@ static enum SCP_CLIENT_STATES_E _scp_v1c_check_response(struct SCP_CONNECTION* c
 
   init_stream(c->in_s, c->in_s->size);
   /* read the rest of the packet */
-  if (0!=scp_tcp_force_recv(c->in_sck, c->in_s->data, size-8))
+  if (0 != scp_tcp_force_recv(c->in_sck, c->in_s->data, size - 8))
   {
     return SCP_CLIENT_STATE_NETWORK_ERR;
   }
 
   in_uint16_be(c->in_s, cmd);
-  if (cmd!=SCP_COMMAND_SET_DEFAULT)
+  if (cmd != SCP_COMMAND_SET_DEFAULT)
   {
     return SCP_CLIENT_STATE_SEQUENCE_ERR;
   }
 
   in_uint16_be(c->in_s, cmd)
-  if (cmd==2) /* connection denied */
+  if (cmd == 2) /* connection denied */
   {
     in_uint16_be(c->in_s, dim);
-    if (s->errstr!=0)
+    if (s->errstr != 0)
     {
       g_free(s->errstr);
     }
-    s->errstr=g_malloc(dim+1,0);
-    if (s->errstr==0)
+    s->errstr = g_malloc(dim + 1, 0);
+    if (s->errstr == 0)
     {
       return SCP_CLIENT_STATE_INTERNAL_ERR;
     }
     in_uint8a(c->in_s, s->errstr, dim);
-    (s->errstr)[dim]='\0';
+    (s->errstr)[dim] = '\0';
 
     return SCP_CLIENT_STATE_CONNECTION_DENIED;
   }
-  else if (cmd==3) /* resend usr/pwd */
+  else if (cmd == 3) /* resend usr/pwd */
   {
     in_uint16_be(c->in_s, dim);
-    if (s->errstr!=0)
+    if (s->errstr != 0)
     {
       g_free(s->errstr);
     }
-    s->errstr=g_malloc(dim+1,0);
-    if (s->errstr==0)
+    s->errstr = g_malloc(dim + 1, 0);
+    if (s->errstr == 0)
     {
       return SCP_CLIENT_STATE_INTERNAL_ERR;
     }
     in_uint8a(c->in_s, s->errstr, dim);
-    (s->errstr)[dim]='\0';
+    (s->errstr)[dim] = '\0';
 
     return SCP_CLIENT_STATE_RESEND_CREDENTIALS;
   }
-  else if (cmd==20) /* password change */
+  else if (cmd == 20) /* password change */
   {
     in_uint16_be(c->in_s, dim);
-    if (s->errstr!=0)
+    if (s->errstr != 0)
     {
       g_free(s->errstr);
     }
-    s->errstr=g_malloc(dim+1,0);
-    if (s->errstr==0)
+    s->errstr = g_malloc(dim + 1, 0);
+    if (s->errstr == 0)
     {
       return SCP_CLIENT_STATE_INTERNAL_ERR;
     }
     in_uint8a(c->in_s, s->errstr, dim);
-    (s->errstr)[dim]='\0';
+    (s->errstr)[dim] = '\0';
 
     return SCP_CLIENT_STATE_PWD_CHANGE_REQ;
   }
-  else if (cmd==30) /* display */
+  else if (cmd == 30) /* display */
   {
     in_uint16_be(c->in_s, s->display);
 
     return SCP_CLIENT_STATE_OK;
   }
-  //else if (cmd==31) /* there's a disconnected session */
+  //else if (cmd == 31) /* there's a disconnected session */
   //{
   //  return SCP_CLIENT_STATE_RECONNECT_SINGLE;
   //}
-  //else if (cmd==33) /* display of a disconnected session */
+  //else if (cmd == 33) /* display of a disconnected session */
   //{
   //  return SCP_CLIENT_STATE_RECONNECT;
   //}
-  else if (cmd==40) /* session list */
+  else if (cmd == 40) /* session list */
   {
     return SCP_CLIENT_STATE_SESSION_LIST;
   }
 
   return SCP_CLIENT_STATE_SEQUENCE_ERR;
 }
-
diff --git a/sesman/libscp/libscp_v1c.h b/sesman/libscp/libscp_v1c.h
index 7b5b6fa..0dea073 100644
--- a/sesman/libscp/libscp_v1c.h
+++ b/sesman/libscp/libscp_v1c.h
@@ -14,7 +14,7 @@
    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
 
    xrdp: A Remote Desktop Protocol server.
-   Copyright (C) Jay Sorg 2005-2007
+   Copyright (C) Jay Sorg 2005-2008
 */
 
 /**
diff --git a/sesman/libscp/libscp_v1s.c b/sesman/libscp/libscp_v1s.c
index 95ca1f5..74ce187 100644
--- a/sesman/libscp/libscp_v1s.c
+++ b/sesman/libscp/libscp_v1s.c
@@ -14,7 +14,7 @@
    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
 
    xrdp: A Remote Desktop Protocol server.
-   Copyright (C) Jay Sorg 2005-2007
+   Copyright (C) Jay Sorg 2005-2008
 */
 
 /**
@@ -30,6 +30,8 @@
 
 #include "libscp_v1s.h"
 
+extern struct log_config* s_log;
+
 /* server API */
 enum SCP_SERVER_STATES_E scp_v1s_accept(struct SCP_CONNECTION* c, struct SCP_SESSION** s, int skipVchk)
 {
@@ -39,6 +41,7 @@ enum SCP_SERVER_STATES_E scp_v1s_accept(struct SCP_CONNECTION* c, struct SCP_SES
   tui16 cmdset;
   tui16 cmd;
   tui8 sz;
+  char buf[257];
 
   if (!skipVchk)
   {
@@ -48,28 +51,32 @@ enum SCP_SERVER_STATES_E scp_v1s_accept(struct SCP_CONNECTION* c, struct SCP_SES
       in_uint32_be(c->in_s, version);
       if (version != 1)
       {
+        log_message(s_log, LOG_LEVEL_WARNING, "[v1s:%d] connection aborted: version error", __LINE__);
         return SCP_SERVER_STATE_VERSION_ERR;
       }
     }
     else
     {
+      log_message(s_log, LOG_LEVEL_WARNING, "[v1s:%d] connection aborted: network error", __LINE__);
       return SCP_SERVER_STATE_NETWORK_ERR;
     }
   }
   else
   {
-    version=1;
+    version = 1;
   }
 
   in_uint32_be(c->in_s, size);
-  if (size<12)
+  if (size < 12)
   {
+    log_message(s_log, LOG_LEVEL_WARNING, "[v1s:%d] connection aborted: size error", __LINE__);
     return SCP_SERVER_STATE_SIZE_ERR;
   }
 
   init_stream(c->in_s, c->in_s->size);
-  if (0!=scp_tcp_force_recv(c->in_sck, c->in_s->data, (size-8)))
+  if (0 != scp_tcp_force_recv(c->in_sck, c->in_s->data, (size-8)))
   {
+    log_message(s_log, LOG_LEVEL_WARNING, "[v1s:%d] connection aborted: network error", __LINE__);
     return SCP_SERVER_STATE_NETWORK_ERR;
   }
 
@@ -77,14 +84,16 @@ enum SCP_SERVER_STATES_E scp_v1s_accept(struct SCP_CONNECTION* c, struct SCP_SES
   in_uint16_be(c->in_s, cmdset);
 
   /* if we are starting a management session */
-  if (cmdset==SCP_COMMAND_SET_MANAGE)
+  if (cmdset == SCP_COMMAND_SET_MANAGE)
   {
+    log_message(s_log, LOG_LEVEL_DEBUG, "[v1s:%d] requested management connection", __LINE__);
     return SCP_SERVER_STATE_START_MANAGE;
   }
 
   /* if we started with resource sharing... */
-  if (cmdset==SCP_COMMAND_SET_RSR)
+  if (cmdset == SCP_COMMAND_SET_RSR)
   {
+    log_message(s_log, LOG_LEVEL_WARNING, "[v1s:%d] connection aborted: sequence error", __LINE__);
     return SCP_SERVER_STATE_SEQUENCE_ERR;
   }
 
@@ -92,75 +101,84 @@ enum SCP_SERVER_STATES_E scp_v1s_accept(struct SCP_CONNECTION* c, struct SCP_SES
   in_uint16_be(c->in_s, cmd);
   if (cmd != 1)
   {
+    log_message(s_log, LOG_LEVEL_WARNING, "[v1s:%d] connection aborted: sequence error", __LINE__);
     return SCP_SERVER_STATE_SEQUENCE_ERR;
   }
 
-  session = g_malloc(sizeof(struct SCP_SESSION),1);
+  session = scp_session_create();
   if (0 == session)
   {
-     return SCP_SERVER_STATE_INTERNAL_ERR;
+    log_message(s_log, LOG_LEVEL_WARNING, "[v1s:%d] connection aborted: internal error (malloc returned NULL)", __LINE__);
+    return SCP_SERVER_STATE_INTERNAL_ERR;
   }
-  session->version=1;
+  scp_session_set_version(session, 1);
 
-  in_uint8(c->in_s, session->type);
-  if ((session->type != SCP_SESSION_TYPE_XVNC) && (session->type != SCP_SESSION_TYPE_XRDP))
+  in_uint8(c->in_s, sz);
+  if ((sz != SCP_SESSION_TYPE_XVNC) && (sz != SCP_SESSION_TYPE_XRDP))
   {
-    g_free(session);
+    scp_session_destroy(session);
+    log_message(s_log, LOG_LEVEL_WARNING, "[v1s:%d] connection aborted: unknown session type", __LINE__);
     return SCP_SERVER_STATE_SESSION_TYPE_ERR;
   }
+  scp_session_set_type(session, sz);
 
-  in_uint16_be(c->in_s,session->height);
-  in_uint16_be(c->in_s, session->width);
-  in_uint8(c->in_s, session->bpp);
-  in_uint8(c->in_s, session->rsr);
-  in_uint8a(c->in_s, session->locale, 17);
-    session->locale[17]='\0';
+  in_uint16_be(c->in_s, cmd);
+  scp_session_set_height(session, cmd);
+  in_uint16_be(c->in_s, cmd);
+  scp_session_set_height(session, cmd);
+  in_uint8(c->in_s, sz);
+  scp_session_set_bpp(session, sz);
+  in_uint8(c->in_s, sz);
+  scp_session_set_rsr(session, sz);
+  in_uint8a(c->in_s, buf, 17);
+    buf[17]='\0';
+  scp_session_set_locale(session, buf);
 
-  in_uint8(c->in_s, session->addr_type);
-  if (session->addr_type==SCP_ADDRESS_TYPE_IPV4)
+  in_uint8(c->in_s, sz);
+  if (sz == SCP_ADDRESS_TYPE_IPV4)
   {
-    in_uint32_be(c->in_s, session->ipv4addr);
+    in_uint32_be(c->in_s, size);
+    scp_session_set_addr(session, SCP_ADDRESS_TYPE_IPV4_BIN, &size);
   }
-  else if (session->addr_type==SCP_ADDRESS_TYPE_IPV6)
+  else if (sz == SCP_ADDRESS_TYPE_IPV6)
   {
-    #warning how to handle ipv6 addresses?
+    in_uint8a(c->in_s, buf, 16);
+    scp_session_set_addr(session, SCP_ADDRESS_TYPE_IPV6_BIN, buf);
   }
 
+  buf[256] = '\0';
   /* reading hostname */
   in_uint8(c->in_s, sz);
-  session->hostname=g_malloc(sz+1,1);
-  if (0==session->hostname)
+  buf[sz]='\0';
+  in_uint8a(c->in_s, buf, sz);
+  if (0 != scp_session_set_hostname(session, buf))
   {
-    g_free(session);
+    scp_session_destroy(session);
+    log_message(s_log, LOG_LEVEL_WARNING, "[v1s:%d] connection aborted: internal error", __LINE__);
     return SCP_SERVER_STATE_INTERNAL_ERR;
   }
-  session->hostname[sz]='\0';
-  in_uint8a(c->in_s, session->hostname, sz);
 
   /* reading username */
   in_uint8(c->in_s, sz);
-  session->username=g_malloc(sz+1,1);
-  if (0==session->username)
+  buf[sz]='\0';
+  in_uint8a(c->in_s, buf, sz);
+  if (0 != scp_session_set_username(session, buf))
   {
-    g_free(session->hostname);
-    g_free(session);
+    scp_session_destroy(session);
+    log_message(s_log, LOG_LEVEL_WARNING, "[v1s:%d] connection aborted: internal error", __LINE__);
     return SCP_SERVER_STATE_INTERNAL_ERR;
   }
-  session->username[sz]='\0';
-  in_uint8a(c->in_s, session->username, sz);
 
   /* reading password */
   in_uint8(c->in_s, sz);
-  session->password=g_malloc(sz+1,1);
-  if (0==session->password)
+  buf[sz]='\0';
+  in_uint8a(c->in_s, buf, sz);
+  if (0 != scp_session_set_password(session, buf))
   {
-    g_free(session->username);
-    g_free(session->hostname);
-    g_free(session);
+    scp_session_destroy(session);
+    log_message(s_log, LOG_LEVEL_WARNING, "[v1s:%d] connection aborted: internal error", __LINE__);
     return SCP_SERVER_STATE_INTERNAL_ERR;
   }
-  session->password[sz]='\0';
-  in_uint8a(c->in_s, session->password, sz);
 
   /* returning the struct */
   (*s)=session;
@@ -193,6 +211,7 @@ scp_v1s_deny_connection(struct SCP_CONNECTION* c, char* reason)
 
   if (0!=scp_tcp_force_send(c->in_sck, c->out_s->data, rlen+14))
   {
+    log_message(s_log, LOG_LEVEL_WARNING, "[v1s:%d] connection aborted: network error", __LINE__);
     return SCP_SERVER_STATE_NETWORK_ERR;
   }
 
@@ -203,13 +222,12 @@ enum SCP_SERVER_STATES_E
 scp_v1s_request_password(struct SCP_CONNECTION* c, struct SCP_SESSION* s, char* reason)
 {
   tui8 sz;
-  char *ubuf;
-  char *pbuf;
   tui32 version;
   tui32 size;
   tui16 cmdset;
   tui16 cmd;
   int rlen;
+  char buf[257];
 
   init_stream(c->in_s, c->in_s->size);
   init_stream(c->out_s, c->out_s->size);
@@ -237,71 +255,74 @@ scp_v1s_request_password(struct SCP_CONNECTION* c, struct SCP_SESSION* s, char*
 
   if (0!=scp_tcp_force_send(c->in_sck, c->out_s->data, 14+rlen))
   {
+    log_message(s_log, LOG_LEVEL_WARNING, "[v1s:%d] connection aborted: network error", __LINE__);
     return SCP_SERVER_STATE_NETWORK_ERR;
   }
 
   /* receive password & username */
   if (0!=scp_tcp_force_recv(c->in_sck, c->in_s->data, 8))
   {
+    log_message(s_log, LOG_LEVEL_WARNING, "[v1s:%d] connection aborted: network error", __LINE__);
     return SCP_SERVER_STATE_NETWORK_ERR;
   }
 
   in_uint32_be(c->in_s, version);
   if (version!=1)
   {
+    log_message(s_log, LOG_LEVEL_WARNING, "[v1s:%d] connection aborted: version error", __LINE__);
     return SCP_SERVER_STATE_VERSION_ERR;
   }
 
   in_uint32_be(c->in_s, size);
   if (size<12)
   {
+    log_message(s_log, LOG_LEVEL_WARNING, "[v1s:%d] connection aborted: size error", __LINE__);
     return SCP_SERVER_STATE_SIZE_ERR;
   }
 
   init_stream(c->in_s, c->in_s->size);
   if (0!=scp_tcp_force_recv(c->in_sck, c->in_s->data, (size-8)))
   {
+    log_message(s_log, LOG_LEVEL_WARNING, "[v1s:%d] connection aborted: network error", __LINE__);
     return SCP_SERVER_STATE_NETWORK_ERR;
   }
 
   in_uint16_be(c->in_s, cmdset);
   if (cmdset != SCP_COMMAND_SET_DEFAULT)
   {
+    log_message(s_log, LOG_LEVEL_WARNING, "[v1s:%d] connection aborted: sequence error", __LINE__);
     return SCP_SERVER_STATE_SEQUENCE_ERR;
   }
 
   in_uint16_be(c->in_s, cmd);
   if (cmd != 4)
   {
+    log_message(s_log, LOG_LEVEL_WARNING, "[v1s:%d] connection aborted: sequence error", __LINE__);
     return SCP_SERVER_STATE_SEQUENCE_ERR;
   }
 
+  buf[256] = '\0';
   /* reading username */
   in_uint8(c->in_s, sz);
-  ubuf=g_malloc(sz+1,1);
-  if (0==ubuf)
+  buf[sz] = '\0';
+  in_uint8a(c->in_s, buf, sz);
+  if (0 != scp_session_set_username(s, buf))
   {
+    scp_session_destroy(s);
+    log_message(s_log, LOG_LEVEL_WARNING, "[v1s:%d] connection aborted: internal error", __LINE__);
     return SCP_SERVER_STATE_INTERNAL_ERR;
   }
-  ubuf[sz]='\0';
-  in_uint8a(c->in_s, ubuf, sz);
 
   /* reading password */
   in_uint8(c->in_s, sz);
-  pbuf=g_malloc(sz+1,1);
-  if (0==pbuf)
+  buf[sz]='\0';
+  in_uint8a(c->in_s, buf, sz);
+  if (0 != scp_session_set_password(s, buf))
   {
-    g_free(ubuf);
+    scp_session_destroy(s);
+    log_message(s_log, LOG_LEVEL_WARNING, "[v1s:%d] connection aborted: internal error", __LINE__);
     return SCP_SERVER_STATE_INTERNAL_ERR;
   }
-  pbuf[sz]='\0';
-  in_uint8a(c->in_s, pbuf, sz);
-
-  /* replacing username and password */
-  g_free(s->username);
-  g_free(s->password);
-  s->username=ubuf;
-  s->password=pbuf;
 
   return SCP_SERVER_STATE_OK;
 }
@@ -340,6 +361,7 @@ scp_v1s_connect_new_session(struct SCP_CONNECTION* c, SCP_DISPLAY d)
 
   if (0!=scp_tcp_force_send(c->in_sck, c->out_s->data, 14))
   {
+    log_message(s_log, LOG_LEVEL_WARNING, "[v1s:%d] connection aborted: network error", __LINE__);
     return SCP_SERVER_STATE_NETWORK_ERR;
   }
 
@@ -377,6 +399,7 @@ scp_v1s_list_sessions(struct SCP_CONNECTION* c, int sescnt, struct SCP_DISCONNEC
 
   if (0!=scp_tcp_force_send(c->in_sck, c->out_s->data, size))
   {
+    log_message(s_log, LOG_LEVEL_WARNING, "[v1s:%d] connection aborted: network error", __LINE__);
     return SCP_SERVER_STATE_NETWORK_ERR;
   }
 
@@ -386,36 +409,42 @@ scp_v1s_list_sessions(struct SCP_CONNECTION* c, int sescnt, struct SCP_DISCONNEC
   init_stream(c->in_s, c->in_s->size);
   if (0!=scp_tcp_force_recv(c->in_sck, c->in_s->data, 8))
   {
+    log_message(s_log, LOG_LEVEL_WARNING, "[v1s:%d] connection aborted: network error", __LINE__);
     return SCP_SERVER_STATE_NETWORK_ERR;
   }
 
   in_uint32_be(c->in_s, version);
   if (version!=1)
   {
+    log_message(s_log, LOG_LEVEL_WARNING, "[v1s:%d] connection aborted: version error", __LINE__);
     return SCP_SERVER_STATE_VERSION_ERR;
   }
 
   in_uint32_be(c->in_s, size);
   if (size<12)
   {
+    log_message(s_log, LOG_LEVEL_WARNING, "[v1s:%d] connection aborted: size error", __LINE__);
     return SCP_SERVER_STATE_SIZE_ERR;
   }
 
   init_stream(c->in_s, c->in_s->size);
   if (0!=scp_tcp_force_recv(c->in_sck, c->in_s->data, (size-8)))
   {
+    log_message(s_log, LOG_LEVEL_WARNING, "[v1s:%d] connection aborted: network error", __LINE__);
     return SCP_SERVER_STATE_NETWORK_ERR;
   }
 
   in_uint16_be(c->in_s, cmd);
   if (cmd != SCP_COMMAND_SET_DEFAULT)
   {
+    log_message(s_log, LOG_LEVEL_WARNING, "[v1s:%d] connection aborted: sequence error", __LINE__);
     return SCP_SERVER_STATE_SEQUENCE_ERR;
   }
 
   in_uint16_be(c->in_s, cmd);
   if (cmd != 41)
   {
+    log_message(s_log, LOG_LEVEL_WARNING, "[v1s:%d] connection aborted: sequence error", __LINE__);
     return SCP_SERVER_STATE_SEQUENCE_ERR;
   }
 
@@ -474,16 +503,35 @@ scp_v1s_list_sessions(struct SCP_CONNECTION* c, int sescnt, struct SCP_DISCONNEC
       out_uint8(c->out_s, cds->idle_days);
       out_uint8(c->out_s, cds->idle_hours);
       out_uint8(c->out_s, cds->idle_minutes);
+      size += 13;
+
+      out_uint16_be(c->out_s, cds->conn_year);
+      out_uint8(c->out_s, cds->conn_month);
+      out_uint8(c->out_s, cds->conn_day);
+      out_uint8(c->out_s, cds->conn_hour);
+      out_uint8(c->out_s, cds->conn_minute);
+      out_uint8(c->out_s, cds->addr_type);
+      size += 7;
 
-      size = size + 13;
+      if (cds->addr_type == SCP_ADDRESS_TYPE_IPV4)
+      {
+        in_uint32_be(c->out_s, cds->ipv4addr);
+        size += 4;
+      }
+      else if (cds->addr_type == SCP_ADDRESS_TYPE_IPV6)
+      {
+        in_uint8a(c->out_s, cds->ipv6addr, 16);
+        size += 16;
+      }
     }
 
     s_pop_layer(c->out_s, channel_hdr);
     out_uint32_be(c->out_s, version);
     out_uint32_be(c->out_s, size);
 
-    if (0!=scp_tcp_force_send(c->in_sck, c->out_s->data, size))
+    if (0 != scp_tcp_force_send(c->in_sck, c->out_s->data, size))
     {
+      log_message(s_log, LOG_LEVEL_WARNING, "[v1s:%d] connection aborted: network error", __LINE__);
       return SCP_SERVER_STATE_NETWORK_ERR;
     }
   }
@@ -492,18 +540,21 @@ scp_v1s_list_sessions(struct SCP_CONNECTION* c, int sescnt, struct SCP_DISCONNEC
   init_stream(c->in_s, c->in_s->size);
   if (0!=scp_tcp_force_recv(c->in_sck, c->in_s->data, (8)))
   {
+    log_message(s_log, LOG_LEVEL_WARNING, "[v1s:%d] connection aborted: network error", __LINE__);
     return SCP_SERVER_STATE_NETWORK_ERR;
   }
 
   in_uint32_be(c->in_s, version);
-  if (version!=1)
+  if (version != 1)
   {
+    log_message(s_log, LOG_LEVEL_WARNING, "[v1s:%d] connection aborted: version error", __LINE__);
     return SCP_SERVER_STATE_VERSION_ERR;
   }
 
   in_uint32_be(c->in_s, size);
-  if (size<12)
+  if (size < 12)
   {
+    log_message(s_log, LOG_LEVEL_WARNING, "[v1s:%d] connection aborted: size error", __LINE__);
     return SCP_SERVER_STATE_SIZE_ERR;
   }
 
@@ -511,12 +562,14 @@ scp_v1s_list_sessions(struct SCP_CONNECTION* c, int sescnt, struct SCP_DISCONNEC
   init_stream(c->in_s, c->in_s->size);
   if (0!=scp_tcp_force_recv(c->in_sck, c->in_s->data, (size-8)))
   {
+    log_message(s_log, LOG_LEVEL_WARNING, "[v1s:%d] connection aborted: network error", __LINE__);
     return SCP_SERVER_STATE_NETWORK_ERR;
   }
 
   in_uint16_be(c->in_s, cmd);
   if (cmd != SCP_COMMAND_SET_DEFAULT)
   {
+    log_message(s_log, LOG_LEVEL_WARNING, "[v1s:%d] connection aborted: sequence error", __LINE__);
     return SCP_SERVER_STATE_SEQUENCE_ERR;
   }
 
@@ -539,6 +592,7 @@ scp_v1s_list_sessions(struct SCP_CONNECTION* c, int sescnt, struct SCP_DISCONNEC
 
     /* if we got here, the requested sid wasn't one from the list we sent */
     /* we should kill the connection                                      */
+    log_message(s_log, LOG_LEVEL_WARNING, "[v1s:%d] connection aborted: internal error (no such session in list)", __LINE__);
     return SCP_CLIENT_STATE_INTERNAL_ERR;
   }
   else if (cmd == 44)
@@ -554,6 +608,7 @@ scp_v1s_list_sessions(struct SCP_CONNECTION* c, int sescnt, struct SCP_DISCONNEC
   else
   {
     /* wrong response */
+    log_message(s_log, LOG_LEVEL_WARNING, "[v1s:%d] connection aborted: sequence error", __LINE__);
     return SCP_SERVER_STATE_SEQUENCE_ERR;
   }
 
@@ -590,6 +645,7 @@ scp_v1s_reconnect_session(struct SCP_CONNECTION* c, SCP_DISPLAY d)
 
   if (0!=scp_tcp_force_send(c->in_sck, c->out_s->data, size))
   {
+    log_message(s_log, LOG_LEVEL_WARNING, "[v1s:%d] connection aborted: network error", __LINE__);
     return SCP_SERVER_STATE_NETWORK_ERR;
   }
 
diff --git a/sesman/libscp/libscp_v1s.h b/sesman/libscp/libscp_v1s.h
index 6aeb409..1f31ea8 100644
--- a/sesman/libscp/libscp_v1s.h
+++ b/sesman/libscp/libscp_v1s.h
@@ -14,7 +14,7 @@
    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
 
    xrdp: A Remote Desktop Protocol server.
-   Copyright (C) Jay Sorg 2005-2007
+   Copyright (C) Jay Sorg 2005-2008
 */
 
 /**
diff --git a/sesman/libscp/libscp_vX.c b/sesman/libscp/libscp_vX.c
index 791f8ba..a3a133f 100644
--- a/sesman/libscp/libscp_vX.c
+++ b/sesman/libscp/libscp_vX.c
@@ -14,7 +14,7 @@
    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
 
    xrdp: A Remote Desktop Protocol server.
-   Copyright (C) Jay Sorg 2005-2007
+   Copyright (C) Jay Sorg 2005-2008
 */
 
 /**
diff --git a/sesman/libscp/libscp_vX.h b/sesman/libscp/libscp_vX.h
index af54cd8..10277e2 100644
--- a/sesman/libscp/libscp_vX.h
+++ b/sesman/libscp/libscp_vX.h
@@ -14,7 +14,7 @@
    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
 
    xrdp: A Remote Desktop Protocol server.
-   Copyright (C) Jay Sorg 2005-2007
+   Copyright (C) Jay Sorg 2005-2008
 */
 
 /**
diff --git a/sesman/lock.c b/sesman/lock.c
index d63f57e..912084a 100644
--- a/sesman/lock.c
+++ b/sesman/lock.c
@@ -14,7 +14,7 @@
    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
 
    xrdp: A Remote Desktop Protocol server.
-   Copyright (C) Jay Sorg 2005-2007
+   Copyright (C) Jay Sorg 2005-2008
 
    session manager
    linux only
@@ -26,6 +26,8 @@
 #include <semaphore.h>
 #include <pthread.h>
 
+extern struct config_sesman* g_cfg;
+
 pthread_mutex_t lock_chain;           /* session chain lock */
 pthread_mutexattr_t lock_chain_attr;  /* mutex attributes */
 
@@ -54,7 +56,7 @@ void DEFAULT_CC
 lock_chain_acquire(void)
 {
   /*lock the chain*/
-  LOG_DBG("lock_chain_acquire()",0);
+  LOG_DBG(&(g_cfg->log), "lock_chain_acquire()");
   pthread_mutex_lock(&lock_chain);
 }
 
@@ -63,7 +65,7 @@ void DEFAULT_CC
 lock_chain_release(void)
 {
   /*unlock the chain*/
-  LOG_DBG("lock_chain_release()",0);
+  LOG_DBG(&(g_cfg->log), "lock_chain_release()");
   pthread_mutex_unlock(&lock_chain);
 }
 
@@ -72,7 +74,7 @@ void DEFAULT_CC
 lock_socket_acquire(void)
 {
   /* lock socket variable */
-  LOG_DBG("lock_socket_acquire()",0);
+  LOG_DBG(&(g_cfg->log), "lock_socket_acquire()");
   sem_wait(&lock_socket);
 }
 
@@ -81,7 +83,7 @@ void DEFAULT_CC
 lock_socket_release(void)
 {
   /* unlock socket variable */
-  LOG_DBG("lock_socket_release()",0);
+  LOG_DBG(&(g_cfg->log), "lock_socket_release()");
   sem_post(&lock_socket);
 }
 
diff --git a/sesman/lock.h b/sesman/lock.h
index 045a8ff..4d2a865 100644
--- a/sesman/lock.h
+++ b/sesman/lock.h
@@ -14,7 +14,7 @@
    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
 
    xrdp: A Remote Desktop Protocol server.
-   Copyright (C) Jay Sorg 2005-2007
+   Copyright (C) Jay Sorg 2005-2008
 */
 
 #ifndef LOCK_H
diff --git a/sesman/scp.c b/sesman/scp.c
index d4dcd22..ea5a8ec 100644
--- a/sesman/scp.c
+++ b/sesman/scp.c
@@ -14,7 +14,7 @@
    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
 
    xrdp: A Remote Desktop Protocol server.
-   Copyright (C) Jay Sorg 2005-2007
+   Copyright (C) Jay Sorg 2005-2008
 */
 
 /**
@@ -25,12 +25,13 @@
  *        This code controls which version is being used and starts the
  *        appropriate process
  * @author Jay Sorg, Simone Fedele
- * 
+ *
  */
 
 #include "sesman.h"
 
 extern int thread_sck;
+extern struct config_sesman g_cfg;
 
 /******************************************************************************/
 void* DEFAULT_CC
@@ -42,7 +43,7 @@ scp_process_start(void* sck)
   /* making a local copy of the socket (it's on the stack) */
   /* probably this is just paranoia                        */
   scon.in_sck = thread_sck;
-  LOG_DBG("started scp thread on socket %d", scon.in_sck);
+  LOG_DBG(&(g_cfg.log), "started scp thread on socket %d", scon.in_sck);
 
   /* unlocking thread_sck */
   lock_socket_release();
@@ -59,34 +60,40 @@ scp_process_start(void* sck)
       if (sdata->version == 0)
       {
         /* starts processing an scp v0 connection */
-        LOG_DBG("accept ok, go on with scp v0\n",0);
+        LOG_DBG(&(g_cfg.log), "accept ok, go on with scp v0\n",0);
         scp_v0_process(&scon, sdata);
       }
       else
       {
-        LOG_DBG("accept ok, go on with scp v1\n",0);
-        LOG_DBG("user: %s\npass: %s",sdata->username, sdata->password);
+        LOG_DBG(&(g_cfg.log), "accept ok, go on with scp v1\n",0);
+        /*LOG_DBG(&(g_cfg.log), "user: %s\npass: %s",sdata->username, sdata->password);*/
         scp_v1_process(&scon, sdata);
       }
       break;
+    case SCP_SERVER_STATE_START_MANAGE:
+      /* starting a management session */
+      log_message(&(g_cfg.log), LOG_LEVEL_WARNING,
+        "starting a sesman management session...");
+//      scp_v1s_mng_process(&scon, sdata);
+      break;
     case SCP_SERVER_STATE_VERSION_ERR:
       /* an unknown scp version was requested, so we shut down the */
       /* connection (and log the fact)                             */
-      log_message(LOG_LEVEL_WARNING,
+      log_message(&(g_cfg.log), LOG_LEVEL_WARNING,
         "unknown protocol version specified. connection refused.");
       break;
     case SCP_SERVER_STATE_NETWORK_ERR:
-      log_message(LOG_LEVEL_WARNING, "libscp network error.");
+      log_message(&(g_cfg.log), LOG_LEVEL_WARNING, "libscp network error.");
       break;
     case SCP_SERVER_STATE_SEQUENCE_ERR:
-      log_message(LOG_LEVEL_WARNING, "libscp sequence error.");
+      log_message(&(g_cfg.log), LOG_LEVEL_WARNING, "libscp sequence error.");
       break;
     case SCP_SERVER_STATE_INTERNAL_ERR:
       /* internal error occurred (eg. malloc() error, ecc.) */
-      log_message(LOG_LEVEL_ERROR, "libscp internal error occurred.");
+      log_message(&(g_cfg.log), LOG_LEVEL_ERROR, "libscp internal error occurred.");
       break;
     default:
-      log_message(LOG_LEVEL_ALWAYS, "unknown return from scp_vXs_accept()");
+      log_message(&(g_cfg.log), LOG_LEVEL_ALWAYS, "unknown return from scp_vXs_accept()");
   }
   g_tcp_close(scon.in_sck);
   free_stream(scon.in_s);
diff --git a/sesman/scp.h b/sesman/scp.h
index aab32e4..236620c 100644
--- a/sesman/scp.h
+++ b/sesman/scp.h
@@ -14,7 +14,7 @@
    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
 
    xrdp: A Remote Desktop Protocol server.
-   Copyright (C) Jay Sorg 2005-2007
+   Copyright (C) Jay Sorg 2005-2008
 */
 
 /**
diff --git a/sesman/scp_v0.c b/sesman/scp_v0.c
index 83a3509..e006ad3 100644
--- a/sesman/scp_v0.c
+++ b/sesman/scp_v0.c
@@ -14,7 +14,7 @@
    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
 
    xrdp: A Remote Desktop Protocol server.
-   Copyright (C) Jay Sorg 2005-2007
+   Copyright (C) Jay Sorg 2005-2008
 */
 
 /**
@@ -22,13 +22,15 @@
  * @file scp_v0.c
  * @brief scp version 0 implementation
  * @author Jay Sorg, Simone Fedele
- * 
+ *
  */
 
 #include "sesman.h"
 
+extern struct config_sesman* g_cfg;
+
 /******************************************************************************/
-void DEFAULT_CC 
+void DEFAULT_CC
 scp_v0_process(struct SCP_CONNECTION* c, struct SCP_SESSION* s)
 {
   int display = 0;
@@ -48,19 +50,19 @@ scp_v0_process(struct SCP_CONNECTION* c, struct SCP_SESSION* s)
     }
     else
     {
-      g_printf("pre auth");
+      LOG_DBG(&(g_cfg->log), "pre auth");
       if (1 == access_login_allowed(s->username))
       {
-        log_message(LOG_LEVEL_INFO, "granted TS access to user %s", s->username);
+        log_message(&(g_cfg->log), LOG_LEVEL_INFO, "granted TS access to user %s", s->username);
         if (SCP_SESSION_TYPE_XVNC == s->type)
         {
-          log_message(LOG_LEVEL_INFO, "starting Xvnc session...");
+          log_message(&(g_cfg->log), LOG_LEVEL_INFO, "starting Xvnc session...");
           display = session_start(s->width, s->height, s->bpp, s->username, s->password,
                                   data, SESMAN_SESSION_TYPE_XVNC);
         }
         else
         {
-          log_message(LOG_LEVEL_INFO, "starting Xrdp session...");
+          log_message(&(g_cfg->log), LOG_LEVEL_INFO, "starting X11rdp session...");
           display = session_start(s->width, s->height, s->bpp, s->username, s->password,
                                   data, SESMAN_SESSION_TYPE_XRDP);
         }
diff --git a/sesman/scp_v0.h b/sesman/scp_v0.h
index e3c3362..64d2475 100644
--- a/sesman/scp_v0.h
+++ b/sesman/scp_v0.h
@@ -14,7 +14,7 @@
    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
 
    xrdp: A Remote Desktop Protocol server.
-   Copyright (C) Jay Sorg 2005-2007
+   Copyright (C) Jay Sorg 2005-2008
 */
 
 /**
diff --git a/sesman/scp_v1.c b/sesman/scp_v1.c
index ed6dcde..c5ff2d4 100644
--- a/sesman/scp_v1.c
+++ b/sesman/scp_v1.c
@@ -14,7 +14,7 @@
    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
 
    xrdp: A Remote Desktop Protocol server.
-   Copyright (C) Jay Sorg 2005-2007
+   Copyright (C) Jay Sorg 2005-2008
 */
 
 /**
@@ -30,7 +30,7 @@
 //#include "libscp_types.h"
 #include "libscp.h"
 
-extern struct config_sesman g_cfg;
+extern struct config_sesman* g_cfg;
 
 static void parseCommonStates(enum SCP_SERVER_STATES_E e, char* f);
 
@@ -48,7 +48,7 @@ scp_v1_process(struct SCP_CONNECTION* c, struct SCP_SESSION* s)
   int scount;
   SCP_SID sid;
 
-  retries = g_cfg.sec.login_retry;
+  retries = g_cfg->sec.login_retry;
   current_try = retries;
 
   data = auth_userpass(s->username, s->password);
@@ -56,7 +56,7 @@ scp_v1_process(struct SCP_CONNECTION* c, struct SCP_SESSION* s)
 
   while ((!data) && ((retries == 0) || (current_try > 0)))
   {
-    LOG_DBG("data %d - retry %d - currenttry %d - expr %d", data, retries, current_try, ((!data) && ((retries==0) || (current_try>0))));
+    LOG_DBG(&(g_cfg->log), "data %d - retry %d - currenttry %d - expr %d", data, retries, current_try, ((!data) && ((retries==0) || (current_try>0))));
 
     e=scp_v1s_request_password(c,s,"Wrong username and/or password");
 
@@ -83,7 +83,7 @@ scp_v1_process(struct SCP_CONNECTION* c, struct SCP_SESSION* s)
   if (!data)
   {
     scp_v1s_deny_connection(c, "Login failed");
-    log_message(LOG_LEVEL_INFO,
+    log_message(&(g_cfg->log), LOG_LEVEL_INFO,
       "Login failed for user %s. Connection terminated", s->username);
     free_session(s);
     return;
@@ -93,7 +93,7 @@ scp_v1_process(struct SCP_CONNECTION* c, struct SCP_SESSION* s)
   if (0 == access_login_allowed(s->username))
   {
     scp_v1s_deny_connection(c, "Access to Terminal Server not allowed.");
-    log_message(LOG_LEVEL_INFO,
+    log_message(&(g_cfg->log), LOG_LEVEL_INFO,
       "User %s not allowed on TS. Connection terminated", s->username);
     free_session(s);
     return;
@@ -107,16 +107,16 @@ scp_v1_process(struct SCP_CONNECTION* c, struct SCP_SESSION* s)
   if (scount == 0)
   {
     /* no disconnected sessions - start a new one */
-    log_message(LOG_LEVEL_INFO, "granted TS access to user %s", s->username);
+    log_message(&(g_cfg->log), LOG_LEVEL_INFO, "granted TS access to user %s", s->username);
     if (SCP_SESSION_TYPE_XVNC == s->type)
     {
-      log_message(LOG_LEVEL_INFO, "starting Xvnc session...");
+      log_message(&(g_cfg->log), LOG_LEVEL_INFO, "starting Xvnc session...");
       display = session_start(s->width, s->height, s->bpp, s->username,
                               s->password, data, SESMAN_SESSION_TYPE_XVNC);
     }
     else
     {
-      log_message(LOG_LEVEL_INFO, "starting Xrdp session...");
+      log_message(&(g_cfg->log), LOG_LEVEL_INFO, "starting X11rdp session...");
       display = session_start(s->width, s->height, s->bpp, s->username,
                               s->password, data, SESMAN_SESSION_TYPE_XRDP);
     }
@@ -145,7 +145,7 @@ scp_v1_process(struct SCP_CONNECTION* c, struct SCP_SESSION* s)
       /*case SCP_SERVER_STATE_FORCE_NEW:*/
       /* we should check for MaxSessions */
       case SCP_SERVER_STATE_SELECTION_CANCEL:
-        log_message(LOG_LEVEL_INFO, "Connection cancelled after session listing");
+        log_message(&(g_cfg->log), LOG_LEVEL_INFO, "Connection cancelled after session listing");
         break;
       case SCP_SERVER_STATE_OK:
         /* ok, reconnecting... */
@@ -153,14 +153,14 @@ scp_v1_process(struct SCP_CONNECTION* c, struct SCP_SESSION* s)
         if (0==sitem)
         {
           e=scp_v1s_connection_error(c, "Internal error");
-          log_message(LOG_LEVEL_INFO, "Cannot find session item on the chain");
+          log_message(&(g_cfg->log), LOG_LEVEL_INFO, "Cannot find session item on the chain");
         }
         else
         {
           display=sitem->display;
           /*e=scp_v1s_reconnect_session(c, sitem, display);*/
           e=scp_v1s_reconnect_session(c, display);
-          log_message(LOG_LEVEL_INFO, "User %s reconnected to session %d on port %d", \
+          log_message(&(g_cfg->log), LOG_LEVEL_INFO, "User %s reconnected to session %d on port %d", \
                       s->username, sitem->pid, display);
         }
         break;
@@ -188,27 +188,27 @@ static void parseCommonStates(enum SCP_SERVER_STATES_E e, char* f)
   switch (e)
   {
     case SCP_SERVER_STATE_VERSION_ERR:
-      LOG_DBG("version error", 0)
+      LOG_DBG(&(g_cfg->log), "version error")
     case SCP_SERVER_STATE_SIZE_ERR:
       /* an unknown scp version was requested, so we shut down the */
       /* connection (and log the fact)                             */
-      log_message(LOG_LEVEL_WARNING,
+      log_message(&(g_cfg->log), LOG_LEVEL_WARNING,
         "protocol violation. connection closed.");
       break;
     case SCP_SERVER_STATE_NETWORK_ERR:
-      log_message(LOG_LEVEL_WARNING, "libscp network error.");
+      log_message(&(g_cfg->log), LOG_LEVEL_WARNING, "libscp network error.");
       break;
     case SCP_SERVER_STATE_SEQUENCE_ERR:
-      log_message(LOG_LEVEL_WARNING, "libscp sequence error.");
+      log_message(&(g_cfg->log), LOG_LEVEL_WARNING, "libscp sequence error.");
       break;
     case SCP_SERVER_STATE_INTERNAL_ERR:
       /* internal error occurred (eg. malloc() error, ecc.) */
-      log_message(LOG_LEVEL_ERROR, "libscp internal error occurred.");
+      log_message(&(g_cfg->log), LOG_LEVEL_ERROR, "libscp internal error occurred.");
       break;
     default:
       /* dummy: scp_v1s_request_password won't generate any other */
       /* error other than the ones before                         */
-      log_message(LOG_LEVEL_ALWAYS, "unknown return from %s", f);
+      log_message(&(g_cfg->log), LOG_LEVEL_ALWAYS, "unknown return from %s", f);
       break;
   }
 }
diff --git a/sesman/scp_v1.h b/sesman/scp_v1.h
index 48baf3f..648855f 100644
--- a/sesman/scp_v1.h
+++ b/sesman/scp_v1.h
@@ -14,7 +14,7 @@
    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
 
    xrdp: A Remote Desktop Protocol server.
-   Copyright (C) Jay Sorg 2005-2007
+   Copyright (C) Jay Sorg 2005-2008
 */
 
 /**
diff --git a/sesman/sesman.c b/sesman/sesman.c
index e3d7565..c7522c7 100644
--- a/sesman/sesman.c
+++ b/sesman/sesman.c
@@ -14,7 +14,7 @@
    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
 
    xrdp: A Remote Desktop Protocol server.
-   Copyright (C) Jay Sorg 2005-2007
+   Copyright (C) Jay Sorg 2005-2008
 */
 
 /**
@@ -22,7 +22,7 @@
  * @file sesman.c
  * @brief Main program file
  * @author Jay Sorg
- * 
+ *
  */
 
 #include "sesman.h"
@@ -30,7 +30,7 @@
 int g_sck;
 int g_pid;
 unsigned char g_fixedkey[8] = { 23, 82, 107, 6, 35, 78, 88, 7 };
-struct config_sesman g_cfg; /* config.h */
+struct config_sesman* g_cfg; /* config.h */
 
 extern int thread_sck;
 
@@ -40,17 +40,17 @@ extern int thread_sck;
  * @brief Starts sesman main loop
  *
  */
-static void DEFAULT_CC 
+static void DEFAULT_CC
 sesman_main_loop(void)
 {
   int in_sck;
   int error;
 
   /*main program loop*/
-  log_message(LOG_LEVEL_INFO, "listening...");
+  log_message(&(g_cfg->log), LOG_LEVEL_INFO, "listening...");
   g_sck = g_tcp_socket();
   g_tcp_set_non_blocking(g_sck);
-  error = scp_tcp_bind(g_sck, g_cfg.listen_address, g_cfg.listen_port);
+  error = scp_tcp_bind(g_sck, g_cfg->listen_address, g_cfg->listen_port);
   if (error == 0)
   {
     error = g_tcp_listen(g_sck);
@@ -65,8 +65,8 @@ sesman_main_loop(void)
       while (in_sck > 0)
       {
         /* we've got a connection, so we pass it to scp code */
-	LOG_DBG("new connection",0);
-	thread_sck=in_sck;
+        LOG_DBG(&(g_cfg->log), "new connection");
+        thread_sck=in_sck;
         //scp_process_start((void*)in_sck);
         thread_scp_start(in_sck);
 
@@ -81,12 +81,12 @@ sesman_main_loop(void)
     }
     else
     {
-      log_message(LOG_LEVEL_ERROR, "listen error");
+      log_message(&(g_cfg->log), LOG_LEVEL_ERROR, "listen error");
     }
   }
   else
   {
-    log_message(LOG_LEVEL_ERROR, "bind error");
+    log_message(&(g_cfg->log), LOG_LEVEL_ERROR, "bind error");
   }
   g_tcp_close(g_sck);
 }
@@ -188,16 +188,21 @@ main(int argc, char** argv)
   }
 
   /* reading config */
-  if (0 != config_read(&g_cfg))
+  g_cfg = g_malloc(sizeof(struct config_sesman), 1);
+  if (0 == g_cfg)
+  {
+    g_printf("error creating config: quitting.\n");
+    g_exit(1);
+  }
+  g_cfg->log.fd = -1; /* don't use logging before reading its config */
+  if (0 != config_read(g_cfg))
   {
     g_printf("error reading config: %s\nquitting.\n", g_get_strerror());
     g_exit(1);
   }
 
   /* starting logging subsystem */
-  error = log_start(g_cfg.log.program_name, g_cfg.log.log_file,
-                    g_cfg.log.log_level, g_cfg.log.enable_syslog,
-                    g_cfg.log.syslog_level);
+  error = log_start(&(g_cfg->log));
 
   if (error != LOG_STARTUP_OK)
   {
@@ -214,7 +219,7 @@ main(int argc, char** argv)
   }
 
   /* libscp initialization */
-  scp_init();
+  scp_init(&(g_cfg->log));
 
   if (daemon)
   {
@@ -256,9 +261,9 @@ main(int argc, char** argv)
   fd = g_file_open(SESMAN_PID_FILE);
   if (-1 == fd)
   {
-    log_message(LOG_LEVEL_ERROR, "error opening pid file: %s",
+    log_message(&(g_cfg->log), LOG_LEVEL_ERROR, "error opening pid file: %s",
                 g_get_strerror());
-    log_end();
+    log_end(&(g_cfg->log));
     g_exit(1);
   }
   g_sprintf(pid_s, "%d", g_pid);
@@ -266,7 +271,7 @@ main(int argc, char** argv)
   g_file_close(fd);
 
   /* start program main loop */
-  log_message(LOG_LEVEL_ALWAYS, "starting sesman with pid %d", g_pid);
+  log_message(&(g_cfg->log), LOG_LEVEL_ALWAYS, "starting sesman with pid %d", g_pid);
 
   /* make sure the /tmp/.X11-unix directory exist */
   if (!g_directory_exist("/tmp/.X11-unix"))
@@ -279,7 +284,7 @@ main(int argc, char** argv)
 
   if (!daemon)
   {
-    log_end();
+    log_end(&(g_cfg->log));
   }
 
   return 0;
diff --git a/sesman/sesman.h b/sesman/sesman.h
index 0326f04..33c0ad2 100644
--- a/sesman/sesman.h
+++ b/sesman/sesman.h
@@ -14,7 +14,7 @@
    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
 
    xrdp: A Remote Desktop Protocol server.
-   Copyright (C) Jay Sorg 2005-2007
+   Copyright (C) Jay Sorg 2005-2008
 */
 
 /**
@@ -22,17 +22,21 @@
  * @file sesman.h
  * @brief Main include file
  * @author Jay Sorg
- * 
+ *
  */
 
 #ifndef SESMAN_H
 #define SESMAN_H
 
+#if defined(HAVE_CONFIG_H)
+#include "config_ac.h"
+#endif
 #include "d3des.h"
 #include "arch.h"
 #include "parse.h"
 #include "os_calls.h"
 #include "log.h"
+#include "file_loc.h"
 #include "env.h"
 #include "auth.h"
 #include "config.h"
@@ -50,8 +54,4 @@
   #define SESMAN_PID_FILE "./sesman.pid"
 #endif
 
-#ifndef SESMAN_SESSVC_FILE
-  #define SESMAN_SESSVC_FILE "sessvc"
-#endif
-
 #endif
diff --git a/sesman/sesman.ini b/sesman/sesman.ini
index 2cecd57..fd240e7 100644
--- a/sesman/sesman.ini
+++ b/sesman/sesman.ini
@@ -18,7 +18,7 @@ IdleTimeLimit=0
 DisconnectedTimeLimit=0
 
 [Logging]
-LogFile=./sesman.log
+LogFile=/var/log/xrdp-sesman.log
 LogLevel=DEBUG
 EnableSyslog=0
 SyslogLevel=DEBUG
diff --git a/sesman/session.c b/sesman/session.c
index 39da8b9..54e02ad 100644
--- a/sesman/session.c
+++ b/sesman/session.c
@@ -14,7 +14,7 @@
    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
 
    xrdp: A Remote Desktop Protocol server.
-   Copyright (C) Jay Sorg 2005-2007
+   Copyright (C) Jay Sorg 2005-2008
 */
 
 /**
@@ -28,10 +28,11 @@
 #include "sesman.h"
 #include "libscp_types.h"
 
-#include "errno.h"
+#include <errno.h>
+//#include <time.h>
 
 extern unsigned char g_fixedkey[8];
-extern struct config_sesman g_cfg; /* config.h */
+extern struct config_sesman* g_cfg; /* config.h */
 struct session_chain* g_sessions;
 int g_session_count;
 
@@ -111,45 +112,52 @@ x_server_running(int display)
   return x_running;
 }
 
+/******************************************************************************/
 static void DEFAULT_CC
 session_start_sessvc(int xpid, int wmpid, long data)
 {
   struct list* sessvc_params;
   char wmpid_str[25];
   char xpid_str[25];
-  char exe_path[256];
-  char cur_dir[256];
+  char exe_path[262];
   int i;
 
   /* new style waiting for clients */
   g_sprintf(wmpid_str, "%d", wmpid);
   g_sprintf(xpid_str, "%d",  xpid);
-  log_message(LOG_LEVEL_INFO, "starting sessvc - xpid=%s - wmpid=%s",xpid_str, wmpid_str);
+  log_message(&(g_cfg->log), LOG_LEVEL_INFO,
+              "starting xrdp-sessvc - xpid=%s - wmpid=%s",
+              xpid_str, wmpid_str);
 
   sessvc_params = list_create();
   sessvc_params->auto_free = 1;
 
   /* building parameters */
-  g_get_current_dir(cur_dir, 255);
-  g_snprintf(exe_path, 255, "%s/%s", cur_dir, SESMAN_SESSVC_FILE);
+  g_snprintf(exe_path, 261, "%s/xrdp-sessvc", XRDP_SBIN_PATH);
+
   list_add_item(sessvc_params, (long)g_strdup(exe_path));
   list_add_item(sessvc_params, (long)g_strdup(xpid_str));
   list_add_item(sessvc_params, (long)g_strdup(wmpid_str));
   list_add_item(sessvc_params, 0); /* mandatory */
 
+  /* executing sessvc */
   g_execvp(exe_path, ((char**)sessvc_params->items));
 
   /* should not get here */
-  log_message(LOG_LEVEL_ALWAYS, "error starting sessvc - pid %d - xpid=%s - wmpid=%s",
+  log_message(&(g_cfg->log), LOG_LEVEL_ALWAYS,
+              "error starting xrdp-sessvc - pid %d - xpid=%s - wmpid=%s",
               g_getpid(), xpid_str, wmpid_str);
 
   /* logging parameters */
-  /* no problem calling strerror for thread safety: other threads are blocked */
-  log_message(LOG_LEVEL_DEBUG, "errno: %d, description: %s", errno, g_get_strerror());
-  log_message(LOG_LEVEL_DEBUG,"execve parameter list:");
-  for (i=0; i < (sessvc_params->count); i++)
+  /* no problem calling strerror for thread safety: other threads
+     are blocked */
+  log_message(&(g_cfg->log), LOG_LEVEL_DEBUG, "errno: %d, description: %s",
+              errno, g_get_strerror());
+  log_message(&(g_cfg->log), LOG_LEVEL_DEBUG, "execve parameter list:");
+  for (i = 0; i < (sessvc_params->count); i++)
   {
-    log_message(LOG_LEVEL_DEBUG, "        argv[%d] = %s", i, (char*)list_get_item(sessvc_params, i));
+    log_message(&(g_cfg->log), LOG_LEVEL_DEBUG, "        argv[%d] = %s", i,
+                (char*)list_get_item(sessvc_params, i));
   }
   list_delete(sessvc_params);
 
@@ -175,21 +183,22 @@ session_start(int width, int height, int bpp, char* username, char* password,
   char geometry[32];
   char depth[32];
   char screen[32];
-  char cur_dir[256];
   char text[256];
   char passwd_file[256];
   char** pp1;
   struct session_chain* temp;
   struct list* xserver_params=0;
+  time_t ltime;
+  struct tm stime;
 
   /*THREAD-FIX lock to control g_session_count*/
   lock_chain_acquire();
   /* check to limit concurrent sessions */
-  if (g_session_count >= g_cfg.sess.max_sessions)
+  if (g_session_count >= g_cfg->sess.max_sessions)
   {
     /*THREAD-FIX unlock chain*/
     lock_chain_release();
-    log_message(LOG_LEVEL_INFO, "max concurrent session limit exceeded. login \
+    log_message(&(g_cfg->log), LOG_LEVEL_INFO, "max concurrent session limit exceeded. login \
 for user %s denied", username);
     return 0;
   }
@@ -200,7 +209,7 @@ for user %s denied", username);
   temp = (struct session_chain*)g_malloc(sizeof(struct session_chain), 0);
   if (temp == 0)
   {
-    log_message(LOG_LEVEL_ERROR, "cannot create new chain element - user %s",
+    log_message(&(g_cfg->log), LOG_LEVEL_ERROR, "cannot create new chain element - user %s",
                 username);
     return 0;
   }
@@ -208,12 +217,11 @@ for user %s denied", username);
   if (temp->item == 0)
   {
     g_free(temp);
-    log_message(LOG_LEVEL_ERROR, "cannot create new session item - user %s",
+    log_message(&(g_cfg->log), LOG_LEVEL_ERROR, "cannot create new session item - user %s",
                 username);
     return 0;
   }
 
-  g_get_current_dir(cur_dir, 255);
   display = 10;
 
   /*while (x_server_running(display) && display < 50)*/
@@ -225,7 +233,7 @@ for user %s denied", username);
   while (x_server_running(display))
   {
     display++;
-    if (((display - 10) > g_cfg.sess.max_sessions) || (display >= 50))
+    if (((display - 10) > g_cfg->sess.max_sessions) || (display >= 50))
     {
       return 0;
     }
@@ -255,53 +263,53 @@ for user %s denied", username);
       {
         auth_set_env(data);
         /* try to execute user window manager if enabled */
-        if (g_cfg.enable_user_wm)
+        if (g_cfg->enable_user_wm)
         {
-          g_sprintf(text,"%s/%s", g_getenv("HOME"), g_cfg.user_wm);
+          g_sprintf(text,"%s/%s", g_getenv("HOME"), g_cfg->user_wm);
           if (g_file_exist(text))
           {
-            g_execlp3(text, g_cfg.user_wm, 0);
-            log_message(LOG_LEVEL_ALWAYS,"error starting user wm for user %s - pid %d",
+            g_execlp3(text, g_cfg->user_wm, 0);
+            log_message(&(g_cfg->log), LOG_LEVEL_ALWAYS,"error starting user wm for user %s - pid %d",
                         username, g_getpid());
             /* logging parameters */
             /* no problem calling strerror for thread safety: other threads are blocked */
-            log_message(LOG_LEVEL_DEBUG, "errno: %d, description: %s", errno,
+            log_message(&(g_cfg->log), LOG_LEVEL_DEBUG, "errno: %d, description: %s", errno,
                         g_get_strerror());
-            log_message(LOG_LEVEL_DEBUG,"execlp3 parameter list:");
-            log_message(LOG_LEVEL_DEBUG, "        argv[0] = %s", text);
-            log_message(LOG_LEVEL_DEBUG, "        argv[1] = %s", g_cfg.user_wm);
+            log_message(&(g_cfg->log), LOG_LEVEL_DEBUG,"execlp3 parameter list:");
+            log_message(&(g_cfg->log), LOG_LEVEL_DEBUG, "        argv[0] = %s", text);
+            log_message(&(g_cfg->log), LOG_LEVEL_DEBUG, "        argv[1] = %s", g_cfg->user_wm);
           }
         }
         /* if we're here something happened to g_execlp3
            so we try running the default window manager */
-        g_sprintf(text, "%s/%s", cur_dir, g_cfg.default_wm);
-        g_execlp3(text, g_cfg.default_wm, 0);
+        g_sprintf(text, "%s/%s", XRDP_CFG_PATH, g_cfg->default_wm);
+        g_execlp3(text, g_cfg->default_wm, 0);
 
-        log_message(LOG_LEVEL_ALWAYS,"error starting default wm for user %s - pid %d",
+        log_message(&(g_cfg->log), LOG_LEVEL_ALWAYS,"error starting default wm for user %s - pid %d",
                     username, g_getpid());
         /* logging parameters */
         /* no problem calling strerror for thread safety: other threads are blocked */
-        log_message(LOG_LEVEL_DEBUG, "errno: %d, description: %s", errno,
+        log_message(&(g_cfg->log), LOG_LEVEL_DEBUG, "errno: %d, description: %s", errno,
                     g_get_strerror());
-        log_message(LOG_LEVEL_DEBUG,"execlp3 parameter list:");
-        log_message(LOG_LEVEL_DEBUG, "        argv[0] = %s", text);
-        log_message(LOG_LEVEL_DEBUG, "        argv[1] = %s", g_cfg.default_wm);
+        log_message(&(g_cfg->log), LOG_LEVEL_DEBUG,"execlp3 parameter list:");
+        log_message(&(g_cfg->log), LOG_LEVEL_DEBUG, "        argv[0] = %s", text);
+        log_message(&(g_cfg->log), LOG_LEVEL_DEBUG, "        argv[1] = %s", g_cfg->default_wm);
 
         /* still a problem starting window manager just start xterm */
         g_execlp3("xterm", "xterm", 0);
-	
+
         /* should not get here */
-        log_message(LOG_LEVEL_ALWAYS,"error starting xterm for user %s - pid %d",
+        log_message(&(g_cfg->log), LOG_LEVEL_ALWAYS,"error starting xterm for user %s - pid %d",
                     username, g_getpid());
         /* logging parameters */
         /* no problem calling strerror for thread safety: other threads are blocked */
-        log_message(LOG_LEVEL_DEBUG, "errno: %d, description: %s", errno, g_get_strerror());
+        log_message(&(g_cfg->log), LOG_LEVEL_DEBUG, "errno: %d, description: %s", errno, g_get_strerror());
       }
       else
       {
-        log_message(LOG_LEVEL_ERROR, "another Xserver is already active on display %d", display);
+        log_message(&(g_cfg->log), LOG_LEVEL_ERROR, "another Xserver is already active on display %d", display);
       }
-      log_message(LOG_LEVEL_DEBUG,"aborting connection...");
+      log_message(&(g_cfg->log), LOG_LEVEL_DEBUG,"aborting connection...");
       g_exit(0);
     }
     else /* parent (child sesman) */
@@ -331,7 +339,7 @@ for user %s denied", username);
           /* additional parameters from sesman.ini file */
           //config_read_xserver_params(SESMAN_SESSION_TYPE_XVNC,
           //                           xserver_params);
-          list_append_list_strdup(g_cfg.vnc_params, xserver_params, 0);
+          list_append_list_strdup(g_cfg->vnc_params, xserver_params, 0);
 
           /* make sure it ends with a zero */
           list_add_item(xserver_params, 0);
@@ -353,7 +361,7 @@ for user %s denied", username);
           /* additional parameters from sesman.ini file */
           //config_read_xserver_params(SESMAN_SESSION_TYPE_XRDP,
           //                           xserver_params);
-	  list_append_list_strdup(g_cfg.rdp_params, xserver_params, 0);
+	  list_append_list_strdup(g_cfg->rdp_params, xserver_params, 0);
 
           /* make sure it ends with a zero */
           list_add_item(xserver_params, 0);
@@ -362,23 +370,23 @@ for user %s denied", username);
         }
         else
         {
-          log_message(LOG_LEVEL_ALWAYS, "bad session type - user %s - pid %d",
+          log_message(&(g_cfg->log), LOG_LEVEL_ALWAYS, "bad session type - user %s - pid %d",
                       username, g_getpid());
           g_exit(1);
         }
 
         /* should not get here */
-        log_message(LOG_LEVEL_ALWAYS, "error starting X server - user %s - pid %d",
+        log_message(&(g_cfg->log), LOG_LEVEL_ALWAYS, "error starting X server - user %s - pid %d",
                     username, g_getpid());
 
         /* logging parameters */
         /* no problem calling strerror for thread safety: other threads are blocked */
-        log_message(LOG_LEVEL_DEBUG, "errno: %d, description: %s", errno, g_get_strerror());
-        log_message(LOG_LEVEL_DEBUG, "execve parameter list: %d", (xserver_params)->count);
+        log_message(&(g_cfg->log), LOG_LEVEL_DEBUG, "errno: %d, description: %s", errno, g_get_strerror());
+        log_message(&(g_cfg->log), LOG_LEVEL_DEBUG, "execve parameter list: %d", (xserver_params)->count);
 
         for (i=0; i<(xserver_params->count); i++)
         {
-          log_message(LOG_LEVEL_DEBUG, "        argv[%d] = %s", i, (char*)list_get_item(xserver_params, i));
+          log_message(&(g_cfg->log), LOG_LEVEL_DEBUG, "        argv[%d] = %s", i, (char*)list_get_item(xserver_params, i));
         }
         list_delete(xserver_params);
         g_exit(1);
@@ -403,9 +411,15 @@ for user %s denied", username);
     temp->item->data = data;
     g_strncpy(temp->item->name, username, 255);
 
-    temp->item->connect_time = g_time1();
-    temp->item->disconnect_time = 0;
-    temp->item->idle_time = 0;
+    ltime = g_time1();
+    gmtime_r(&ltime, &stime);
+    temp->item->connect_time.year = (tui16)stime.tm_year;
+    temp->item->connect_time.month = (tui8)stime.tm_mon;
+    temp->item->connect_time.day = (tui8)stime.tm_mday;
+    temp->item->connect_time.hour = (tui8)stime.tm_hour;
+    temp->item->connect_time.minute = (tui8)stime.tm_min;
+    zero_time(&(temp->item->disconnect_time));
+    zero_time(&(temp->item->idle_time));
 
     temp->item->type=type;
     temp->item->status=SESMAN_SESSION_STATUS_ACTIVE;
@@ -477,7 +491,7 @@ session_kill(int pid)
   {
     if (tmp->item == 0)
     {
-      log_message(LOG_LEVEL_ERROR, "session descriptor for pid %d is null!",
+      log_message(&(g_cfg->log), LOG_LEVEL_ERROR, "session descriptor for pid %d is null!",
                   pid);
       if (prev == 0)
       {
@@ -497,7 +511,7 @@ session_kill(int pid)
     if (tmp->item->pid == pid)
     {
       /* deleting the session */
-      log_message(LOG_LEVEL_INFO, "session %d - user %s - terminated",
+      log_message(&(g_cfg->log), LOG_LEVEL_INFO, "session %d - user %s - terminated",
                   tmp->item->pid, tmp->item->name);
       g_free(tmp->item);
       if (prev == 0)
@@ -542,7 +556,7 @@ session_sigkill_all()
   {
     if (tmp->item == 0)
     {
-      log_message(LOG_LEVEL_ERROR, "found null session descriptor!");
+      log_message(&(g_cfg->log), LOG_LEVEL_ERROR, "found null session descriptor!");
     }
     else
     {
@@ -571,7 +585,7 @@ session_get_bypid(int pid)
   {
     if (tmp->item == 0)
     {
-      log_message(LOG_LEVEL_ERROR, "session descriptor for pid %d is null!",
+      log_message(&(g_cfg->log), LOG_LEVEL_ERROR, "session descriptor for pid %d is null!",
                   pid);
       /*THREAD-FIX release chain lock */
       lock_chain_release();
@@ -643,19 +657,44 @@ session_get_byuser(char* user, int* cnt)
   index = 0;
   while (tmp != 0)
   {
-    (sess[index]).SID=tmp->item->pid;
-    (sess[index]).type=tmp->item->type;
-    (sess[index]).height=tmp->item->height;
-    (sess[index]).width=tmp->item->width;
-    (sess[index]).bpp=tmp->item->bpp;
+#warning FIXME: we should get only disconnected sessions!
+    if (!g_strncasecmp(user, tmp->item->name, 256))
+    {
+      (sess[index]).SID=tmp->item->pid;
+      (sess[index]).type=tmp->item->type;
+      (sess[index]).height=tmp->item->height;
+      (sess[index]).width=tmp->item->width;
+      (sess[index]).bpp=tmp->item->bpp;
 #warning FIXME: setting idle times and such
-    (sess[index]).idle_days=0;
-    (sess[index]).idle_hours=0;
-    (sess[index]).idle_minutes=0;
+      /*(sess[index]).connect_time.year = tmp->item->connect_time.year;
+      (sess[index]).connect_time.month = tmp->item->connect_time.month;
+      (sess[index]).connect_time.day = tmp->item->connect_time.day;
+      (sess[index]).connect_time.hour = tmp->item->connect_time.hour;
+      (sess[index]).connect_time.minute = tmp->item->connect_time.minute;
+      (sess[index]).disconnect_time.year = tmp->item->disconnect_time.year;
+      (sess[index]).disconnect_time.month = tmp->item->disconnect_time.month;
+      (sess[index]).disconnect_time.day = tmp->item->disconnect_time.day;
+      (sess[index]).disconnect_time.hour = tmp->item->disconnect_time.hour;
+      (sess[index]).disconnect_time.minute = tmp->item->disconnect_time.minute;
+      (sess[index]).idle_time.year = tmp->item->idle_time.year;
+      (sess[index]).idle_time.month = tmp->item->idle_time.month;
+      (sess[index]).idle_time.day = tmp->item->idle_time.day;
+      (sess[index]).idle_time.hour = tmp->item->idle_time.hour;
+      (sess[index]).idle_time.minute = tmp->item->idle_time.minute;*/
+      (sess[index]).conn_year = tmp->item->connect_time.year;
+      (sess[index]).conn_month = tmp->item->connect_time.month;
+      (sess[index]).conn_day = tmp->item->connect_time.day;
+      (sess[index]).conn_hour = tmp->item->connect_time.hour;
+      (sess[index]).conn_minute = tmp->item->connect_time.minute;
+      (sess[index]).idle_days = tmp->item->idle_time.day;
+      (sess[index]).idle_hours = tmp->item->idle_time.hour;
+      (sess[index]).idle_minutes = tmp->item->idle_time.minute;
+
+      index++;
+    }
 
     /* go on */
     tmp=tmp->next;
-    index++;
   }
 
   /*THREAD-FIX release chain lock */
diff --git a/sesman/session.h b/sesman/session.h
index dd3e531..e6c6563 100644
--- a/sesman/session.h
+++ b/sesman/session.h
@@ -14,7 +14,7 @@
    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
 
    xrdp: A Remote Desktop Protocol server.
-   Copyright (C) Jay Sorg 2005-2007
+   Copyright (C) Jay Sorg 2005-2008
 */
 
 /**
@@ -45,6 +45,17 @@
 #define SESMAN_SESSION_KILL_NULLITEM  1
 #define SESMAN_SESSION_KILL_NOTFOUND  2
 
+struct session_date
+{
+  tui16 year;
+  tui8  month;
+  tui8  day;
+  tui8  hour;
+  tui8  minute;
+};
+
+#define zero_time(s) { (s)->year=0; (s)->month=0; (s)->day=0; (s)->hour=0; (s)->minute=0; }
+
 struct session_item
 {
   char name[256];
@@ -60,9 +71,9 @@ struct session_item
   unsigned char type;
 
   /* time data  */
-  int connect_time;
-  int disconnect_time;
-  int idle_time;
+  struct session_date connect_time;
+  struct session_date disconnect_time;
+  struct session_date idle_time;
 };
 
 struct session_chain
diff --git a/sesman/sessvc.c b/sesman/sessvc.c
index 2792ac7..927ddca 100644
--- a/sesman/sessvc.c
+++ b/sesman/sessvc.c
@@ -14,7 +14,7 @@
    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
 
    xrdp: A Remote Desktop Protocol server.
-   Copyright (C) Jay Sorg 2005-2007
+   Copyright (C) Jay Sorg 2005-2008
 */
 
 /**
diff --git a/sesman/sig.c b/sesman/sig.c
index f66827c..cc4a2eb 100644
--- a/sesman/sig.c
+++ b/sesman/sig.c
@@ -14,7 +14,7 @@
    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
 
    xrdp: A Remote Desktop Protocol server.
-   Copyright (C) Jay Sorg 2005-2007
+   Copyright (C) Jay Sorg 2005-2008
 */
 
 /**
@@ -31,21 +31,21 @@
 
 extern int g_sck;
 extern int g_pid;
-extern struct config_sesman g_cfg;
+extern struct config_sesman* g_cfg;
 
 /******************************************************************************/
 void DEFAULT_CC
 sig_sesman_shutdown(int sig)
 {
-  log_message(LOG_LEVEL_INFO, "shutting down sesman %d", 1);
+  log_message(&(g_cfg->log), LOG_LEVEL_INFO, "shutting down sesman %d", 1);
 
   if (g_getpid() != g_pid)
   {
-    LOG_DBG("g_getpid() [%d] differs from g_pid [%d]", (g_getpid()), g_pid);
+    LOG_DBG(&(g_cfg->log), "g_getpid() [%d] differs from g_pid [%d]", (g_getpid()), g_pid);
     return;
   }
 
-  LOG_DBG(" - getting signal %d pid %d", sig, g_getpid());
+  LOG_DBG(&(g_cfg->log), " - getting signal %d pid %d", sig, g_getpid());
 
   g_tcp_close(g_sck);
 
@@ -58,24 +58,32 @@ sig_sesman_shutdown(int sig)
 void DEFAULT_CC
 sig_sesman_reload_cfg(int sig)
 {
-  struct config_sesman cfg;
+  struct config_sesman *cfg;
 
-  log_message(LOG_LEVEL_WARNING, "receiving SIGHUP %d", 1);
+  log_message(&(g_cfg->log), LOG_LEVEL_WARNING, "receiving SIGHUP %d", 1);
 
   if (g_getpid() != g_pid)
   {
-    LOG_DBG("g_getpid() [%d] differs from g_pid [%d]", g_getpid(), g_pid);
+    LOG_DBG(&(g_cfg->log), "g_getpid() [%d] differs from g_pid [%d]", g_getpid(), g_pid);
     return;
   }
 
-  if (config_read(&cfg) != 0)
+  cfg = g_malloc(sizeof(struct config_sesman), 1);
+  if (0 == cfg)
   {
-    log_message(LOG_LEVEL_ERROR, "error reading config - keeping old cfg");
+    log_message(&(g_cfg->log), LOG_LEVEL_ERROR, "error creating new config:  - keeping old cfg");
     return;
   }
+
+  if (config_read(cfg) != 0)
+  {
+    log_message(&(g_cfg->log), LOG_LEVEL_ERROR, "error reading config - keeping old cfg");
+    return;
+  }
+#warning FIXME reload configuration must NOT damage logging!
   g_cfg = cfg;
 
-  log_message(LOG_LEVEL_INFO, "configuration reloaded");
+  log_message(&(g_cfg->log), LOG_LEVEL_INFO, "configuration reloaded");
 }
 
 /******************************************************************************/
@@ -121,19 +129,20 @@ sig_handler_thread(void* arg)
 
   do
   {
-    LOG_DBG("calling sigwait()",0);
+    LOG_DBG(&(g_cfg->log), "calling sigwait()",0);
     sigwait(&waitmask, &recv_signal);
 
     switch (recv_signal)
     {
       case SIGHUP:
         //reload cfg
-        LOG_DBG("sesman received SIGHUP",0);
+	//we must stop & restart logging, or copy logging cfg!!!!
+        LOG_DBG(&(g_cfg->log), "sesman received SIGHUP",0);
         //return 0;
         break;
       case SIGCHLD:
         /* a session died */
-        LOG_DBG("sesman received SIGCHLD",0);
+        LOG_DBG(&(g_cfg->log), "sesman received SIGCHLD",0);
         sig_sesman_session_end(SIGCHLD);
         break;
       /*case SIGKILL;
@@ -143,7 +152,7 @@ sig_handler_thread(void* arg)
         break;*/
       case SIGTERM:
         /* we die */
-        LOG_DBG("sesman received SIGTERM",0);
+        LOG_DBG(&(g_cfg->log), "sesman received SIGTERM",0);
         sig_sesman_shutdown(recv_signal);
         break;
     }
diff --git a/sesman/sig.h b/sesman/sig.h
index 3cadfde..4dbcaa9 100644
--- a/sesman/sig.h
+++ b/sesman/sig.h
@@ -14,7 +14,7 @@
    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
 
    xrdp: A Remote Desktop Protocol server.
-   Copyright (C) Jay Sorg 2005-2007
+   Copyright (C) Jay Sorg 2005-2008
 */
 
 /**
diff --git a/sesman/thread.c b/sesman/thread.c
index b97df60..632c546 100644
--- a/sesman/thread.c
+++ b/sesman/thread.c
@@ -14,7 +14,7 @@
    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
 
    xrdp: A Remote Desktop Protocol server.
-   Copyright (C) Jay Sorg 2005-2007
+   Copyright (C) Jay Sorg 2005-2008
 */
 
 /**
@@ -31,6 +31,8 @@
 #include <signal.h>
 #include <pthread.h>
 
+extern struct config_sesman g_cfg;
+
 static pthread_t thread_sighandler;
 //static pthread_t thread_updater;
 
@@ -60,14 +62,14 @@ thread_sighandler_start(void)
   sigaddset(&waitmask, SIGFPE);
   pthread_sigmask(SIG_UNBLOCK, &waitmask, NULL);
 
-  log_message(LOG_LEVEL_INFO,"starting signal handling thread...");
+  log_message(&(g_cfg.log), LOG_LEVEL_INFO,"starting signal handling thread...");
 
   ret = pthread_create(&thread_sighandler, NULL, sig_handler_thread, "");
   pthread_detach(thread_sighandler);
 
   if (ret == 0)
   {
-    log_message(LOG_LEVEL_INFO, "signal handler thread started successfully");
+    log_message(&(g_cfg.log), LOG_LEVEL_INFO, "signal handler thread started successfully");
     return 0;
   }
 
@@ -75,16 +77,16 @@ thread_sighandler_start(void)
   switch (ret)
   {
     case EINVAL:
-      log_message(LOG_LEVEL_ERROR, "invalid attributes for signal handling thread (creation returned  EINVAL)");
+      log_message(&(g_cfg.log), LOG_LEVEL_ERROR, "invalid attributes for signal handling thread (creation returned  EINVAL)");
       break;
     case EAGAIN:
-      log_message(LOG_LEVEL_ERROR, "not enough resources to start signal handling thread (creation returned EAGAIN)");
+      log_message(&(g_cfg.log), LOG_LEVEL_ERROR, "not enough resources to start signal handling thread (creation returned EAGAIN)");
       break;
     case EPERM:
-      log_message(LOG_LEVEL_ERROR, "invalid permissions for signal handling thread (creation returned EPERM)");
+      log_message(&(g_cfg.log), LOG_LEVEL_ERROR, "invalid permissions for signal handling thread (creation returned EPERM)");
       break;
     default:
-      log_message(LOG_LEVEL_ERROR, "unknown error starting signal handling thread");
+      log_message(&(g_cfg.log), LOG_LEVEL_ERROR, "unknown error starting signal handling thread");
   }
 
   return 1;
@@ -106,7 +108,7 @@ thread_session_update_start(void)
 
   if (ret==0) 
   {
-    log_message(LOG_LEVEL_INFO, "session update thread started successfully");
+    log_message(&(g_cfg.log), LOG_LEVEL_INFO, "session update thread started successfully");
     return 0;
   }
 
@@ -114,16 +116,16 @@ thread_session_update_start(void)
   switch (ret)
   {
     case EINVAL:
-      log_message(LOG_LEVEL_ERROR, "invalid attributes for session update thread (creation returned  EINVAL)");
+      log_message(&(g_cfg.log), LOG_LEVEL_ERROR, "invalid attributes for session update thread (creation returned  EINVAL)");
       break;
     case EAGAIN:
-      log_message(LOG_LEVEL_ERROR, "not enough resources to start session update thread (creation returned EAGAIN)");
+      log_message(&(g_cfg.log), LOG_LEVEL_ERROR, "not enough resources to start session update thread (creation returned EAGAIN)");
       break;
     case EPERM:
-      log_message(LOG_LEVEL_ERROR, "invalid permissions for session update thread (creation returned EPERM)");
+      log_message(&(g_cfg.log), LOG_LEVEL_ERROR, "invalid permissions for session update thread (creation returned EPERM)");
       break;
     default:
-      log_message(LOG_LEVEL_ERROR, "unknown error starting session update thread");
+      log_message(&(g_cfg.log), LOG_LEVEL_ERROR, "unknown error starting session update thread");
   }
 
   return 1;
@@ -148,7 +150,7 @@ thread_scp_start(int skt)
 
   if (ret == 0) 
   {
-    log_message(LOG_LEVEL_INFO, "scp thread on sck %d started successfully", skt);
+    log_message(&(g_cfg.log), LOG_LEVEL_INFO, "scp thread on sck %d started successfully", skt);
     return 0;
   }
 
@@ -156,16 +158,16 @@ thread_scp_start(int skt)
   switch (ret)
   {
     case EINVAL:
-      log_message(LOG_LEVEL_ERROR, "invalid attributes for scp thread on sck %d (creation returned  EINVAL)", skt);
+      log_message(&(g_cfg.log), LOG_LEVEL_ERROR, "invalid attributes for scp thread on sck %d (creation returned  EINVAL)", skt);
       break;
     case EAGAIN:
-      log_message(LOG_LEVEL_ERROR, "not enough resources to start scp thread on sck %d (creation returned EAGAIN)", skt);
+      log_message(&(g_cfg.log), LOG_LEVEL_ERROR, "not enough resources to start scp thread on sck %d (creation returned EAGAIN)", skt);
       break;
     case EPERM:
-      log_message(LOG_LEVEL_ERROR, "invalid permissions for scp thread on sck %d (creation returned EPERM)", skt);
+      log_message(&(g_cfg.log), LOG_LEVEL_ERROR, "invalid permissions for scp thread on sck %d (creation returned EPERM)", skt);
       break;
     default:
-      log_message(LOG_LEVEL_ERROR, "unknown error starting scp thread on sck %d");
+      log_message(&(g_cfg.log), LOG_LEVEL_ERROR, "unknown error starting scp thread on sck %d");
   }
 
   return 1;
diff --git a/sesman/thread.h b/sesman/thread.h
index aaab579..7a41da7 100644
--- a/sesman/thread.h
+++ b/sesman/thread.h
@@ -14,7 +14,7 @@
    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
 
    xrdp: A Remote Desktop Protocol server.
-   Copyright (C) Jay Sorg 2005-2007
+   Copyright (C) Jay Sorg 2005-2008
 */
 
 /**
diff --git a/sesman/tools/Makefile b/sesman/tools/Makefile
index bf81187..104ca7d 100644
--- a/sesman/tools/Makefile
+++ b/sesman/tools/Makefile
@@ -1,56 +1,501 @@
-# sesman tools makefile
-SESTESTOBJ = sestest.o \
-	     os_calls.o
+# Makefile.in generated by automake 1.10.1 from Makefile.am.
+# sesman/tools/Makefile.  Generated from Makefile.in by configure.
 
-SESRUNOBJ = sesrun.o config.o tcp.o \
-	    os_calls.o d3des.o list.o file.o log.o
+# Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
+# 2003, 2004, 2005, 2006, 2007, 2008  Free Software Foundation, Inc.
+# This Makefile.in is free software; the Free Software Foundation
+# gives unlimited permission to copy and/or distribute it,
+# with or without modifications, as long as this notice is preserved.
 
-DESTDIR = /usr/local/xrdp
-CFGDIR = /etc/xrdp
-PIDDIR = /var/run
-MANDIR = /usr/local/man
-DOCDIR = /usr/doc/xrdp
+# This program is distributed in the hope that it will be useful,
+# but WITHOUT ANY WARRANTY, to the extent permitted by law; without
+# even the implied warranty of MERCHANTABILITY or FITNESS FOR A
+# PARTICULAR PURPOSE.
 
-DEFINES = -DLIBSCP_CLIENT
 
-CFLAGS = -Wall -O2 -I../../common -I../ -I/usr/include/nptl -I../libscp $(DEFINES)
-LDFLAGS = -L/usr/gnu/lib -L/usr/lib/nptl -L../libscp -Wl,-rpath,. -lpthread -ldl -lscp
-C_OS_FLAGS = $(CFLAGS) -c
+
+
+pkgdatadir = $(datadir)/xrdp
+pkglibdir = $(libdir)/xrdp
+pkgincludedir = $(includedir)/xrdp
+am__cd = CDPATH="$${ZSH_VERSION+.}$(PATH_SEPARATOR)" && cd
+install_sh_DATA = $(install_sh) -c -m 644
+install_sh_PROGRAM = $(install_sh) -c
+install_sh_SCRIPT = $(install_sh) -c
+INSTALL_HEADER = $(INSTALL_DATA)
+transform = $(program_transform_name)
+NORMAL_INSTALL = :
+PRE_INSTALL = :
+POST_INSTALL = :
+NORMAL_UNINSTALL = :
+PRE_UNINSTALL = :
+POST_UNINSTALL = :
+build_triplet = i686-suse-linux-gnu
+host_triplet = i686-suse-linux-gnu
+bin_PROGRAMS = xrdp-sesrun$(EXEEXT) xrdp-sestest$(EXEEXT)
+subdir = sesman/tools
+DIST_COMMON = $(srcdir)/Makefile.am $(srcdir)/Makefile.in
+ACLOCAL_M4 = $(top_srcdir)/aclocal.m4
+am__aclocal_m4_deps = $(top_srcdir)/configure.ac
+am__configure_deps = $(am__aclocal_m4_deps) $(CONFIGURE_DEPENDENCIES) \
+	$(ACLOCAL_M4)
+mkinstalldirs = $(install_sh) -d
+CONFIG_HEADER = $(top_builddir)/config_ac.h
+CONFIG_CLEAN_FILES =
+am__installdirs = "$(DESTDIR)$(bindir)"
+binPROGRAMS_INSTALL = $(INSTALL_PROGRAM)
+PROGRAMS = $(bin_PROGRAMS)
+am_xrdp_sesrun_OBJECTS = sesrun.$(OBJEXT) tcp.$(OBJEXT) \
+	config.$(OBJEXT)
+xrdp_sesrun_OBJECTS = $(am_xrdp_sesrun_OBJECTS)
+xrdp_sesrun_DEPENDENCIES = $(top_srcdir)/common/libcommon.la
+am_xrdp_sestest_OBJECTS = sestest.$(OBJEXT)
+xrdp_sestest_OBJECTS = $(am_xrdp_sestest_OBJECTS)
+xrdp_sestest_DEPENDENCIES = $(top_srcdir)/common/libcommon.la \
+	$(top_srcdir)/sesman/libscp/libscp.la
+DEFAULT_INCLUDES = -I. -I$(top_builddir)
+depcomp = $(SHELL) $(top_srcdir)/depcomp
+am__depfiles_maybe = depfiles
+COMPILE = $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) \
+	$(CPPFLAGS) $(AM_CFLAGS) $(CFLAGS)
+LTCOMPILE = $(LIBTOOL) --tag=CC $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) \
+	--mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) \
+	$(AM_CPPFLAGS) $(CPPFLAGS) $(AM_CFLAGS) $(CFLAGS)
+CCLD = $(CC)
+LINK = $(LIBTOOL) --tag=CC $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) \
+	--mode=link $(CCLD) $(AM_CFLAGS) $(CFLAGS) $(AM_LDFLAGS) \
+	$(LDFLAGS) -o $@
+SOURCES = $(xrdp_sesrun_SOURCES) $(xrdp_sestest_SOURCES)
+DIST_SOURCES = $(xrdp_sesrun_SOURCES) $(xrdp_sestest_SOURCES)
+ETAGS = etags
+CTAGS = ctags
+DISTFILES = $(DIST_COMMON) $(DIST_SOURCES) $(TEXINFOS) $(EXTRA_DIST)
+ACLOCAL = ${SHELL} /home/david/git/xrdp/missing --run aclocal-1.10
+AMTAR = ${SHELL} /home/david/git/xrdp/missing --run tar
+AR = ar
+AUTOCONF = ${SHELL} /home/david/git/xrdp/missing --run autoconf
+AUTOHEADER = ${SHELL} /home/david/git/xrdp/missing --run autoheader
+AUTOMAKE = ${SHELL} /home/david/git/xrdp/missing --run automake-1.10
+AWK = gawk
 CC = gcc
+CCDEPMODE = depmode=gcc3
+CFLAGS = -g -O2
+CPP = gcc -E
+CPPFLAGS = 
+CXX = g++
+CXXCPP = g++ -E
+CXXDEPMODE = depmode=gcc3
+CXXFLAGS = -g -O2
+CYGPATH_W = echo
+DEFS = -DHAVE_CONFIG_H
+DEPDIR = .deps
+DSYMUTIL = 
+ECHO = echo
+ECHO_C = 
+ECHO_N = -n
+ECHO_T = 
+EGREP = /usr/bin/grep -E
+EXEEXT = 
+F77 = 
+FFLAGS = 
+GREP = /usr/bin/grep
+INSTALL = /usr/bin/install -c
+INSTALL_DATA = ${INSTALL} -m 644
+INSTALL_PROGRAM = ${INSTALL}
+INSTALL_SCRIPT = ${INSTALL}
+INSTALL_STRIP_PROGRAM = $(install_sh) -c -s
+LDFLAGS = 
+LIBOBJS = 
+LIBS = 
+LIBTOOL = $(SHELL) $(top_builddir)/libtool
+LN_S = ln -s
+LTLIBOBJS = 
+MAKEINFO = ${SHELL} /home/david/git/xrdp/missing --run makeinfo
+MKDIR_P = /bin/mkdir -p
+NMEDIT = 
+OBJEXT = o
+PACKAGE = xrdp
+PACKAGE_BUGREPORT = xrdp-devel@lists.sourceforge.net
+PACKAGE_NAME = xrdp
+PACKAGE_STRING = xrdp 0.5.0
+PACKAGE_TARNAME = xrdp
+PACKAGE_VERSION = 0.5.0
+PATH_SEPARATOR = :
+RANLIB = ranlib
+SED = /usr/bin/sed
+SET_MAKE = 
+SHELL = /bin/sh
+STRIP = strip
+VERSION = 0.5.0
+abs_builddir = /home/david/git/xrdp/sesman/tools
+abs_srcdir = /home/david/git/xrdp/sesman/tools
+abs_top_builddir = /home/david/git/xrdp
+abs_top_srcdir = /home/david/git/xrdp
+ac_ct_CC = gcc
+ac_ct_CXX = g++
+ac_ct_F77 = 
+am__include = include
+am__leading_dot = .
+am__quote = 
+am__tar = ${AMTAR} chof - "$$tardir"
+am__untar = ${AMTAR} xf -
+bindir = ${exec_prefix}/bin
+build = i686-suse-linux-gnu
+build_alias = 
+build_cpu = i686
+build_os = linux-gnu
+build_vendor = suse
+builddir = .
+datadir = ${datarootdir}
+datarootdir = ${prefix}/share
+docdir = ${datarootdir}/doc/${PACKAGE_TARNAME}
+dvidir = ${docdir}
+exec_prefix = ${prefix}
+host = i686-suse-linux-gnu
+host_alias = 
+host_cpu = i686
+host_os = linux-gnu
+host_vendor = suse
+htmldir = ${docdir}
+includedir = ${prefix}/include
+infodir = ${datarootdir}/info
+install_sh = $(SHELL) /home/david/git/xrdp/install-sh
+libdir = ${exec_prefix}/lib/xrdp/
+libexecdir = ${exec_prefix}/libexec
+localedir = ${datarootdir}/locale
+localstatedir = ${prefix}/var
+mandir = ${datarootdir}/man
+mkdir_p = /bin/mkdir -p
+oldincludedir = /usr/include
+pdfdir = ${docdir}
+prefix = /usr
+program_transform_name = s,x,x,
+psdir = ${docdir}
+sbindir = ${exec_prefix}/sbin
+sharedstatedir = ${prefix}/com
+srcdir = .
+sysconfdir = ${prefix}/etc
+target_alias = 
+top_builddir = ../..
+top_srcdir = ../..
+INCLUDES = \
+  -I$(top_srcdir)/common \
+  -I$(top_srcdir)/sesman/libscp \
+  -I$(top_srcdir)/sesman
+
+xrdp_sesrun_SOURCES = \
+  sesrun.c \
+  tcp.c \
+  ../config.c
+
+xrdp_sestest_SOURCES = \
+  sestest.c
+
+xrdp_sesrun_LDADD = \
+  $(top_srcdir)/common/libcommon.la
+
+xrdp_sestest_LDADD = \
+  $(top_srcdir)/common/libcommon.la \
+  $(top_srcdir)/sesman/libscp/libscp.la
 
-all: stest srun
+all: all-am
 
-stest: $(SESTESTOBJ)
-	$(CC) $(LDFLAGS) -o sestest $(SESTESTOBJ)
+.SUFFIXES:
+.SUFFIXES: .c .lo .o .obj
+$(srcdir)/Makefile.in:  $(srcdir)/Makefile.am  $(am__configure_deps)
+	@for dep in $?; do \
+	  case '$(am__configure_deps)' in \
+	    *$$dep*) \
+	      cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh \
+		&& exit 0; \
+	      exit 1;; \
+	  esac; \
+	done; \
+	echo ' cd $(top_srcdir) && $(AUTOMAKE) --foreign  sesman/tools/Makefile'; \
+	cd $(top_srcdir) && \
+	  $(AUTOMAKE) --foreign  sesman/tools/Makefile
+.PRECIOUS: Makefile
+Makefile: $(srcdir)/Makefile.in $(top_builddir)/config.status
+	@case '$?' in \
+	  *config.status*) \
+	    cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh;; \
+	  *) \
+	    echo ' cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe)'; \
+	    cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe);; \
+	esac;
 
-srun: $(SESRUNOBJ)
-	$(CC) $(LDFLAGS) -o sesrun $(SESRUNOBJ)
+$(top_builddir)/config.status: $(top_srcdir)/configure $(CONFIG_STATUS_DEPENDENCIES)
+	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
 
-os_calls.o: ../../common/os_calls.c
-	$(CC) $(C_OS_FLAGS) ../../common/os_calls.c
+$(top_srcdir)/configure:  $(am__configure_deps)
+	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
+$(ACLOCAL_M4):  $(am__aclocal_m4_deps)
+	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
+install-binPROGRAMS: $(bin_PROGRAMS)
+	@$(NORMAL_INSTALL)
+	test -z "$(bindir)" || $(MKDIR_P) "$(DESTDIR)$(bindir)"
+	@list='$(bin_PROGRAMS)'; for p in $$list; do \
+	  p1=`echo $$p|sed 's/$(EXEEXT)$$//'`; \
+	  if test -f $$p \
+	     || test -f $$p1 \
+	  ; then \
+	    f=`echo "$$p1" | sed 's,^.*/,,;$(transform);s/$$/$(EXEEXT)/'`; \
+	   echo " $(INSTALL_PROGRAM_ENV) $(LIBTOOL) $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=install $(binPROGRAMS_INSTALL) '$$p' '$(DESTDIR)$(bindir)/$$f'"; \
+	   $(INSTALL_PROGRAM_ENV) $(LIBTOOL) $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=install $(binPROGRAMS_INSTALL) "$$p" "$(DESTDIR)$(bindir)/$$f" || exit 1; \
+	  else :; fi; \
+	done
 
-list.o: ../../common/list.c
-	$(CC) $(C_OS_FLAGS) ../../common/list.c
+uninstall-binPROGRAMS:
+	@$(NORMAL_UNINSTALL)
+	@list='$(bin_PROGRAMS)'; for p in $$list; do \
+	  f=`echo "$$p" | sed 's,^.*/,,;s/$(EXEEXT)$$//;$(transform);s/$$/$(EXEEXT)/'`; \
+	  echo " rm -f '$(DESTDIR)$(bindir)/$$f'"; \
+	  rm -f "$(DESTDIR)$(bindir)/$$f"; \
+	done
 
-file.o: ../../common/file.c
-	$(CC) $(C_OS_FLAGS) ../../common/file.c
+clean-binPROGRAMS:
+	@list='$(bin_PROGRAMS)'; for p in $$list; do \
+	  f=`echo $$p|sed 's/$(EXEEXT)$$//'`; \
+	  echo " rm -f $$p $$f"; \
+	  rm -f $$p $$f ; \
+	done
+xrdp-sesrun$(EXEEXT): $(xrdp_sesrun_OBJECTS) $(xrdp_sesrun_DEPENDENCIES) 
+	@rm -f xrdp-sesrun$(EXEEXT)
+	$(LINK) $(xrdp_sesrun_OBJECTS) $(xrdp_sesrun_LDADD) $(LIBS)
+xrdp-sestest$(EXEEXT): $(xrdp_sestest_OBJECTS) $(xrdp_sestest_DEPENDENCIES) 
+	@rm -f xrdp-sestest$(EXEEXT)
+	$(LINK) $(xrdp_sestest_OBJECTS) $(xrdp_sestest_LDADD) $(LIBS)
 
-log.o: ../../common/log.c
-	$(CC) $(C_OS_FLAGS) ../../common/log.c
+mostlyclean-compile:
+	-rm -f *.$(OBJEXT)
 
-d3des.o: ../../common/d3des.c
-	$(CC) $(C_OS_FLAGS) ../../common/d3des.c
+distclean-compile:
+	-rm -f *.tab.c
+
+include ./$(DEPDIR)/config.Po
+include ./$(DEPDIR)/sesrun.Po
+include ./$(DEPDIR)/sestest.Po
+include ./$(DEPDIR)/tcp.Po
+
+.c.o:
+	$(COMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ $<
+	mv -f $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Po
+#	source='$<' object='$@' libtool=no \
+#	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) \
+#	$(COMPILE) -c $<
+
+.c.obj:
+	$(COMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ `$(CYGPATH_W) '$<'`
+	mv -f $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Po
+#	source='$<' object='$@' libtool=no \
+#	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) \
+#	$(COMPILE) -c `$(CYGPATH_W) '$<'`
+
+.c.lo:
+	$(LTCOMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ $<
+	mv -f $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Plo
+#	source='$<' object='$@' libtool=yes \
+#	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) \
+#	$(LTCOMPILE) -c -o $@ $<
 
 config.o: ../config.c
-	$(CC) $(C_OS_FLAGS) ../config.c
+	$(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(AM_CFLAGS) $(CFLAGS) -MT config.o -MD -MP -MF $(DEPDIR)/config.Tpo -c -o config.o `test -f '../config.c' || echo '$(srcdir)/'`../config.c
+	mv -f $(DEPDIR)/config.Tpo $(DEPDIR)/config.Po
+#	source='../config.c' object='config.o' libtool=no \
+#	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) \
+#	$(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(AM_CFLAGS) $(CFLAGS) -c -o config.o `test -f '../config.c' || echo '$(srcdir)/'`../config.c
+
+config.obj: ../config.c
+	$(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(AM_CFLAGS) $(CFLAGS) -MT config.obj -MD -MP -MF $(DEPDIR)/config.Tpo -c -o config.obj `if test -f '../config.c'; then $(CYGPATH_W) '../config.c'; else $(CYGPATH_W) '$(srcdir)/../config.c'; fi`
+	mv -f $(DEPDIR)/config.Tpo $(DEPDIR)/config.Po
+#	source='../config.c' object='config.obj' libtool=no \
+#	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) \
+#	$(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(AM_CFLAGS) $(CFLAGS) -c -o config.obj `if test -f '../config.c'; then $(CYGPATH_W) '../config.c'; else $(CYGPATH_W) '$(srcdir)/../config.c'; fi`
+
+mostlyclean-libtool:
+	-rm -f *.lo
+
+clean-libtool:
+	-rm -rf .libs _libs
+
+ID: $(HEADERS) $(SOURCES) $(LISP) $(TAGS_FILES)
+	list='$(SOURCES) $(HEADERS) $(LISP) $(TAGS_FILES)'; \
+	unique=`for i in $$list; do \
+	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
+	  done | \
+	  $(AWK) '{ files[$$0] = 1; nonemtpy = 1; } \
+	      END { if (nonempty) { for (i in files) print i; }; }'`; \
+	mkid -fID $$unique
+tags: TAGS
+
+TAGS:  $(HEADERS) $(SOURCES)  $(TAGS_DEPENDENCIES) \
+		$(TAGS_FILES) $(LISP)
+	tags=; \
+	here=`pwd`; \
+	list='$(SOURCES) $(HEADERS)  $(LISP) $(TAGS_FILES)'; \
+	unique=`for i in $$list; do \
+	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
+	  done | \
+	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
+	      END { if (nonempty) { for (i in files) print i; }; }'`; \
+	if test -z "$(ETAGS_ARGS)$$tags$$unique"; then :; else \
+	  test -n "$$unique" || unique=$$empty_fix; \
+	  $(ETAGS) $(ETAGSFLAGS) $(AM_ETAGSFLAGS) $(ETAGS_ARGS) \
+	    $$tags $$unique; \
+	fi
+ctags: CTAGS
+CTAGS:  $(HEADERS) $(SOURCES)  $(TAGS_DEPENDENCIES) \
+		$(TAGS_FILES) $(LISP)
+	tags=; \
+	list='$(SOURCES) $(HEADERS)  $(LISP) $(TAGS_FILES)'; \
+	unique=`for i in $$list; do \
+	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
+	  done | \
+	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
+	      END { if (nonempty) { for (i in files) print i; }; }'`; \
+	test -z "$(CTAGS_ARGS)$$tags$$unique" \
+	  || $(CTAGS) $(CTAGSFLAGS) $(AM_CTAGSFLAGS) $(CTAGS_ARGS) \
+	     $$tags $$unique
+
+GTAGS:
+	here=`$(am__cd) $(top_builddir) && pwd` \
+	  && cd $(top_srcdir) \
+	  && gtags -i $(GTAGS_ARGS) $$here
+
+distclean-tags:
+	-rm -f TAGS ID GTAGS GRTAGS GSYMS GPATH tags
+
+distdir: $(DISTFILES)
+	@srcdirstrip=`echo "$(srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
+	topsrcdirstrip=`echo "$(top_srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
+	list='$(DISTFILES)'; \
+	  dist_files=`for file in $$list; do echo $$file; done | \
+	  sed -e "s|^$$srcdirstrip/||;t" \
+	      -e "s|^$$topsrcdirstrip/|$(top_builddir)/|;t"`; \
+	case $$dist_files in \
+	  */*) $(MKDIR_P) `echo "$$dist_files" | \
+			   sed '/\//!d;s|^|$(distdir)/|;s,/[^/]*$$,,' | \
+			   sort -u` ;; \
+	esac; \
+	for file in $$dist_files; do \
+	  if test -f $$file || test -d $$file; then d=.; else d=$(srcdir); fi; \
+	  if test -d $$d/$$file; then \
+	    dir=`echo "/$$file" | sed -e 's,/[^/]*$$,,'`; \
+	    if test -d $(srcdir)/$$file && test $$d != $(srcdir); then \
+	      cp -pR $(srcdir)/$$file $(distdir)$$dir || exit 1; \
+	    fi; \
+	    cp -pR $$d/$$file $(distdir)$$dir || exit 1; \
+	  else \
+	    test -f $(distdir)/$$file \
+	    || cp -p $$d/$$file $(distdir)/$$file \
+	    || exit 1; \
+	  fi; \
+	done
+check-am: all-am
+check: check-am
+all-am: Makefile $(PROGRAMS)
+installdirs:
+	for dir in "$(DESTDIR)$(bindir)"; do \
+	  test -z "$$dir" || $(MKDIR_P) "$$dir"; \
+	done
+install: install-am
+install-exec: install-exec-am
+install-data: install-data-am
+uninstall: uninstall-am
+
+install-am: all-am
+	@$(MAKE) $(AM_MAKEFLAGS) install-exec-am install-data-am
+
+installcheck: installcheck-am
+install-strip:
+	$(MAKE) $(AM_MAKEFLAGS) INSTALL_PROGRAM="$(INSTALL_STRIP_PROGRAM)" \
+	  install_sh_PROGRAM="$(INSTALL_STRIP_PROGRAM)" INSTALL_STRIP_FLAG=-s \
+	  `test -z '$(STRIP)' || \
+	    echo "INSTALL_PROGRAM_ENV=STRIPPROG='$(STRIP)'"` install
+mostlyclean-generic:
+
+clean-generic:
+
+distclean-generic:
+	-test -z "$(CONFIG_CLEAN_FILES)" || rm -f $(CONFIG_CLEAN_FILES)
+
+maintainer-clean-generic:
+	@echo "This command is intended for maintainers to use"
+	@echo "it deletes files that may require special tools to rebuild."
+clean: clean-am
+
+clean-am: clean-binPROGRAMS clean-generic clean-libtool mostlyclean-am
+
+distclean: distclean-am
+	-rm -rf ./$(DEPDIR)
+	-rm -f Makefile
+distclean-am: clean-am distclean-compile distclean-generic \
+	distclean-tags
+
+dvi: dvi-am
+
+dvi-am:
+
+html: html-am
+
+info: info-am
+
+info-am:
+
+install-data-am:
+
+install-dvi: install-dvi-am
+
+install-exec-am: install-binPROGRAMS
+
+install-html: install-html-am
+
+install-info: install-info-am
+
+install-man:
+
+install-pdf: install-pdf-am
+
+install-ps: install-ps-am
+
+installcheck-am:
+
+maintainer-clean: maintainer-clean-am
+	-rm -rf ./$(DEPDIR)
+	-rm -f Makefile
+maintainer-clean-am: distclean-am maintainer-clean-generic
+
+mostlyclean: mostlyclean-am
+
+mostlyclean-am: mostlyclean-compile mostlyclean-generic \
+	mostlyclean-libtool
+
+pdf: pdf-am
+
+pdf-am:
+
+ps: ps-am
+
+ps-am:
+
+uninstall-am: uninstall-binPROGRAMS
 
-clean:
-	rm -f *.o sestest sesrun
+.MAKE: install-am install-strip
 
-install:
-	install sesrun $(DESTDIR)/sesrun
-	install sestest $(DESTDIR)/sestest
+.PHONY: CTAGS GTAGS all all-am check check-am clean clean-binPROGRAMS \
+	clean-generic clean-libtool ctags distclean distclean-compile \
+	distclean-generic distclean-libtool distclean-tags distdir dvi \
+	dvi-am html html-am info info-am install install-am \
+	install-binPROGRAMS install-data install-data-am install-dvi \
+	install-dvi-am install-exec install-exec-am install-html \
+	install-html-am install-info install-info-am install-man \
+	install-pdf install-pdf-am install-ps install-ps-am \
+	install-strip installcheck installcheck-am installdirs \
+	maintainer-clean maintainer-clean-generic mostlyclean \
+	mostlyclean-compile mostlyclean-generic mostlyclean-libtool \
+	pdf pdf-am ps ps-am tags uninstall uninstall-am \
+	uninstall-binPROGRAMS
 
-installdeb:
-	install sesrun $(DESTDIRDEB)/usr/lib/xrdp/sesrun
-	install sestest $(DESTDIRDEB)/usr/lib/xrdp/sestest
+# Tell versions [3.59,3.63) of GNU make to not export all variables.
+# Otherwise a system limit (for SysV at least) may be exceeded.
+.NOEXPORT:
diff --git a/sesman/tools/Makefile.am b/sesman/tools/Makefile.am
new file mode 100644
index 0000000..2d46cbe
--- /dev/null
+++ b/sesman/tools/Makefile.am
@@ -0,0 +1,23 @@
+INCLUDES = \
+  -I$(top_srcdir)/common \
+  -I$(top_srcdir)/sesman/libscp \
+  -I$(top_srcdir)/sesman
+
+bin_PROGRAMS = \
+  xrdp-sesrun \
+  xrdp-sestest
+
+xrdp_sesrun_SOURCES = \
+  sesrun.c \
+  tcp.c \
+  ../config.c
+
+xrdp_sestest_SOURCES = \
+  sestest.c
+
+xrdp_sesrun_LDADD = \
+  $(top_srcdir)/common/libcommon.la
+
+xrdp_sestest_LDADD = \
+  $(top_srcdir)/common/libcommon.la \
+  $(top_srcdir)/sesman/libscp/libscp.la
diff --git a/sesman/tools/Makefile.osx b/sesman/tools/Makefile.osx
new file mode 100644
index 0000000..61de0e6
--- /dev/null
+++ b/sesman/tools/Makefile.osx
@@ -0,0 +1,65 @@
+# sesman tools makefile
+SESTESTOBJ = sestest.o \
+            os_calls.o
+#          d3des.o list.o file.o \
+#            libscp_v1c.o tcp.o
+
+SESRUNOBJ = sesrun.o config.o tcp.o \
+            os_calls.o d3des.o list.o file.o log.o
+
+DESTDIR = /usr/local/xrdp
+CFGDIR = /etc/xrdp
+PIDDIR = /var/run
+MANDIR = /usr/local/man
+DOCDIR = /usr/doc/xrdp
+
+DEFINES = -DLIBSCP_CLIENT
+
+CFLAGS = -Wall -O2 -I../../common -I../ -I../libscp $(DEFINES)
+LDFLAGS = -L../libscp -lpthread -ldl -lscp $(DEFINES)
+#LDFLAGS = -L /usr/gnu/lib -ldl $(DEFINES)
+C_OS_FLAGS = $(CFLAGS) -c -g
+CC = gcc
+
+all: stest srun
+
+stest: $(SESTESTOBJ)
+	$(CC) $(LDFLAGS) -o sestest $(SESTESTOBJ)
+
+srun: $(SESRUNOBJ)
+	$(CC) $(LDFLAGS) -o sesrun $(SESRUNOBJ)
+
+os_calls.o: ../../common/os_calls.c
+	$(CC) $(C_OS_FLAGS) ../../common/os_calls.c
+
+#d3des.o: ../../common/d3des.c
+#	$(CC) $(C_OS_FLAGS) ../../common/d3des.c
+
+#list.o: ../../common/list.c
+#	$(CC) $(C_OS_FLAGS) ../../common/list.c
+
+#file.o: ../../common/file.c
+#       $(CC) $(C_OS_FLAGS) ../../common/file.c
+
+log.o: ../../common/log.c
+	$(CC) $(C_OS_FLAGS) ../../common/log.c
+
+#tcp.o: tcp.c
+#      $(CC) $(C_OS_FLAGS) ../tcp.c
+
+config.o: ../config.c
+	$(CC) $(C_OS_FLAGS) ../config.c
+
+#libscp_v1c.o: ../libscp_v1c.c
+#      $(CC) $(C_OS_FLAGS) ../libscp_v1c.c
+
+clean:
+	rm -f *.o sestest sesrun
+
+install:
+	install sesrun $(DESTDIR)/sesrun
+	install sestest $(DESTDIR)/sestest
+
+installdeb:
+	install sesrun $(DESTDIRDEB)/usr/lib/xrdp/sesrun
+	install sestest $(DESTDIRDEB)/usr/lib/xrdp/sestest
diff --git a/sesman/tools/sesrun.c b/sesman/tools/sesrun.c
index 7db3b67..ef280c4 100644
--- a/sesman/tools/sesrun.c
+++ b/sesman/tools/sesrun.c
@@ -14,7 +14,7 @@
    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
 
    xrdp: A Remote Desktop Protocol server.
-   Copyright (C) Jay Sorg 2005-2007
+   Copyright (C) Jay Sorg 2005-2008
 */
 
 /**
diff --git a/sesman/tools/sestest.c b/sesman/tools/sestest.c
index ae23f61..03cd1a1 100644
--- a/sesman/tools/sestest.c
+++ b/sesman/tools/sestest.c
@@ -1,9 +1,14 @@
-
+/*
+ * sestest.c - an scp_v1 testing tool
+ * (c) 2008 Simone Fedele
+ *
+ */
 
 #include "arch.h"
 #include "tcp.h"
 #include "libscp.h"
 #include "parse.h"
+#include "log.h"
 
 #include <stdio.h>
 
@@ -12,23 +17,31 @@ unsigned int menuSelect(unsigned int choices);
 
 int main(int argc, char** argv)
 {
-  struct SCP_SESSION s;
-  struct SCP_CONNECTION c;
+  char buf[256];
+  struct SCP_SESSION* s;
+  struct SCP_CONNECTION* c;
   /*struct SCP_DISCONNECTED_SESSION ds;*/
   struct SCP_DISCONNECTED_SESSION* dsl;
   enum SCP_CLIENT_STATES_E e;
+  struct log_config log;
   int end;
   int scnt;
   int idx;
   int sel;
+  int sock;
+
+  log.enable_syslog=0;
+  log.log_level=99;
+  log.program_name=g_strdup("sestest");
+  log.log_file=g_strdup("sestest.log");
+  log_start(&log);
+  scp_init(&log);
 
-  make_stream(c.in_s);
-  init_stream(c.in_s, 8192);
-  make_stream(c.out_s);
-  init_stream(c.out_s, 8192);
-  c.in_sck = g_tcp_socket();
+  sock=g_tcp_socket();
+  s = scp_session_create();
+  c = scp_connection_create(sock);
 
-  if (0!=g_tcp_connect(c.in_sck, "localhost", "3350"))
+  if (0!=g_tcp_connect(sock, "localhost", "3350"))
   {
     g_printf("error connecting");
     return 1;
@@ -36,71 +49,78 @@ int main(int argc, char** argv)
 
   g_printf("001 - send connect request\n");
 
-/*struct SCP_SESSION
-{
-  uint16_t display;
-  char* errstr;
-};*/
-
-  s.type=SCP_SESSION_TYPE_XVNC;
+  scp_session_set_type(s, SCP_SESSION_TYPE_XVNC);
+  scp_session_set_version(s, 1);
+  scp_session_set_height(s, 600);
+  scp_session_set_width(s, 800);
+  scp_session_set_bpp(s, 16);
+  scp_session_set_rsr(s, 0);
+  scp_session_set_locale(s, "it_IT");
+  scp_session_set_username(s, "prog");
+  scp_session_set_password(s, "prog");
+  scp_session_set_hostname(s, "odin");
+//   scp_session_set_addr(s, SCP_ADDRESS_TYPE_IPV4, "127.0.0.1");
+//   scp_session_set_display(struct SCP_SESSION* s, SCP_DISPLAY display);
+//   scp_session_set_errstr(struct SCP_SESSION* s, char* str);
+
+  /*s.type=SCP_SESSION_TYPE_XVNC;
   s.version=1;
   s.height=600;
   s.width=800;
   s.bpp=8;
   s.rsr=0;
   g_strncpy(s.locale,"it_IT  0123456789",18);
-
   s.username=g_malloc(256, 1);
   g_strncpy(s.username,"prog",255);
-
   s.password=g_malloc(256,1);
   g_strncpy(s.password, "prog", 255);
   g_printf("%s - %s\n", s.username, s.password);
-
-
   s.hostname=g_malloc(256,1);
   g_strncpy(s.hostname, "odin", 255);
-
   s.addr_type=SCP_ADDRESS_TYPE_IPV4;
   s.ipv4addr=0;
-  s.errstr=0;
+  s.errstr=0;*/
 
   end=0;
-  e=scp_v1c_connect(&c,&s);
+  e=scp_v1c_connect(c,s);
 
   while (!end)
   {
     switch (e)
     {
       case SCP_CLIENT_STATE_OK:
-        g_printf("OK : display is %d\n", (short int)s.display);
+        g_printf("OK : display is %d\n", (short int)s->display);
         end=1;
         break;
       case SCP_CLIENT_STATE_SESSION_LIST:
         g_printf("OK : session list needed\n");
-        e=scp_v1c_get_session_list(&c, &scnt, &dsl);
-        printf("Sessions: %d\n", scnt);
-        for (idx=0; idx <scnt; idx++)
-        {
-          printf("Session \t%d - %d - %dx%dx%d - %d %d %d\n", (dsl[idx]).SID, (dsl[idx]).type, (dsl[idx]).height, (dsl[idx]).width, (dsl[idx]).bpp, (dsl[idx]).idle_days, (dsl[idx]).idle_hours, (dsl[idx]).idle_minutes);
-        }
+        e=scp_v1c_get_session_list(c, &scnt, &dsl);
         break;
       case SCP_CLIENT_STATE_LIST_OK:
         g_printf("OK : selecting a session:\n");
+        for (idx=0; idx <scnt; idx++)
+        {
+          printf("Session \t%d - %d - %dx%dx%d - %d %d %d - %4d/%2d/%2d@%2d:%2d\n", \
+            (dsl[idx]).SID, (dsl[idx]).type, (dsl[idx]).width, (dsl[idx]).height, (dsl[idx]).bpp, \
+            (dsl[idx]).idle_days, (dsl[idx]).idle_hours, (dsl[idx]).idle_minutes, \
+            (dsl[idx]).conn_year, (dsl[idx]).conn_month, (dsl[idx]).conn_day, (dsl[idx]).conn_hour, (dsl[idx]).conn_minute);
+        }
         sel = menuSelect(scnt);
-        e=scp_v1c_select_session(&c, &s, dsl[sel-1].SID);
+        e=scp_v1c_select_session(c, s, dsl[sel-1].SID);
         g_printf("\n return: %d \n", e);
         break;
       case SCP_CLIENT_STATE_RESEND_CREDENTIALS:
-        g_printf("ERR: resend credentials - %s\n", s.errstr);
+        g_printf("ERR: resend credentials - %s\n", s->errstr);
         g_printf("     username:");
-        scanf("%255s", s.username);
+        scanf("%255s", buf);
+        scp_session_set_username(s, buf);
         g_printf("     password:");
-        scanf("%255s", s.password);
-        e=scp_v1c_resend_credentials(&c,&s);
+        scanf("%255s", buf);
+        scp_session_set_password(s, buf);
+        e=scp_v1c_resend_credentials(c,s);
         break;
       case SCP_CLIENT_STATE_CONNECTION_DENIED:
-        g_printf("ERR: connection denied: %s\n", s.errstr);
+        g_printf("ERR: connection denied: %s\n", s->errstr);
         end=1;
         break;
       case SCP_CLIENT_STATE_PWD_CHANGE_REQ:
@@ -118,9 +138,11 @@ int main(int argc, char** argv)
     }
   }
 
-  g_tcp_close(c.in_sck);
-  free_stream(c.in_s);
-  free_stream(c.out_s);
+  g_tcp_close(sock);
+  scp_session_destroy(s);
+  scp_connection_destroy(c);
+  /*free_stream(c.in_s);
+  free_stream(c.out_s);*/
 
   return 0;
 }
diff --git a/sesman/tools/tcp.c b/sesman/tools/tcp.c
index 55cde03..c3385b2 100644
--- a/sesman/tools/tcp.c
+++ b/sesman/tools/tcp.c
@@ -14,7 +14,7 @@
    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
 
    xrdp: A Remote Desktop Protocol server.
-   Copyright (C) Jay Sorg 2005-2007
+   Copyright (C) Jay Sorg 2005-2008
 */
 
 /**
diff --git a/sesman/tools/tcp.h b/sesman/tools/tcp.h
index e8fee60..4457dc9 100644
--- a/sesman/tools/tcp.h
+++ b/sesman/tools/tcp.h
@@ -14,7 +14,7 @@
    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
 
    xrdp: A Remote Desktop Protocol server.
-   Copyright (C) Jay Sorg 2005-2007
+   Copyright (C) Jay Sorg 2005-2008
 */
 
 /**
diff --git a/sesman/verify_user.c b/sesman/verify_user.c
index d2152e7..edfd457 100644
--- a/sesman/verify_user.c
+++ b/sesman/verify_user.c
@@ -14,7 +14,7 @@
    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
 
    xrdp: A Remote Desktop Protocol server.
-   Copyright (C) Jay Sorg 2005-2007
+   Copyright (C) Jay Sorg 2005-2008
 */
 
 /**
@@ -73,7 +73,7 @@ auth_userpass(char* user, char* pass)
     }
     if (1==auth_account_disabled(stp))
     {
-      log_message(LOG_LEVEL_INFO, "account %s is disabled", user);
+      log_message(&(g_cfg.log), LOG_LEVEL_INFO, "account %s is disabled", user);
       return 0;
     }
     g_strncpy(hash, stp->sp_pwdp, 34);
@@ -306,13 +306,13 @@ auth_account_disabled(struct spwd* stp)
 
   today=g_time1()/SECS_PER_DAY;
 
-  LOG_DBG("last   %d",stp->sp_lstchg);
-  LOG_DBG("min    %d",stp->sp_min);
-  LOG_DBG("max    %d",stp->sp_max);
-  LOG_DBG("inact  %d",stp->sp_inact);
-  LOG_DBG("warn   %d",stp->sp_warn);
-  LOG_DBG("expire %d",stp->sp_expire);
-  LOG_DBG("today  %d",today);
+  LOG_DBG(&(g_cfg.log), "last   %d",stp->sp_lstchg);
+  LOG_DBG(&(g_cfg.log), "min    %d",stp->sp_min);
+  LOG_DBG(&(g_cfg.log), "max    %d",stp->sp_max);
+  LOG_DBG(&(g_cfg.log), "inact  %d",stp->sp_inact);
+  LOG_DBG(&(g_cfg.log), "warn   %d",stp->sp_warn);
+  LOG_DBG(&(g_cfg.log), "expire %d",stp->sp_expire);
+  LOG_DBG(&(g_cfg.log), "today  %d",today);
 
   if ((stp->sp_expire != -1) && (today >= stp->sp_expire))
   {
@@ -326,4 +326,3 @@ auth_account_disabled(struct spwd* stp)
 
   return 0;
 }
-
diff --git a/sesman/verify_user_kerberos.c b/sesman/verify_user_kerberos.c
index cadb63a..68b232a 100644
--- a/sesman/verify_user_kerberos.c
+++ b/sesman/verify_user_kerberos.c
@@ -14,7 +14,7 @@
    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
 
    xrdp: A Remote Desktop Protocol server.
-   Copyright (C) Jay Sorg 2005-2007
+   Copyright (C) Jay Sorg 2005-2008
 */
 
 /**
diff --git a/sesman/verify_user_pam.c b/sesman/verify_user_pam.c
index 2cc0aac..1e186ff 100644
--- a/sesman/verify_user_pam.c
+++ b/sesman/verify_user_pam.c
@@ -14,7 +14,7 @@
    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
 
    xrdp: A Remote Desktop Protocol server.
-   Copyright (C) Jay Sorg 2005-2007
+   Copyright (C) Jay Sorg 2005-2008
 */
 
 /**
diff --git a/sesman/verify_user_pam_userpass.c b/sesman/verify_user_pam_userpass.c
index d68e312..0075afe 100644
--- a/sesman/verify_user_pam_userpass.c
+++ b/sesman/verify_user_pam_userpass.c
@@ -14,7 +14,7 @@
    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
 
    xrdp: A Remote Desktop Protocol server.
-   Copyright (C) Jay Sorg 2005-2007
+   Copyright (C) Jay Sorg 2005-2008
 */
 
 /**
diff --git a/vnc/Makefile b/vnc/Makefile
index d3145bc..34ba8a3 100644
--- a/vnc/Makefile
+++ b/vnc/Makefile
@@ -1,37 +1,470 @@
-# libvnc makefile
+# Makefile.in generated by automake 1.10.1 from Makefile.am.
+# vnc/Makefile.  Generated from Makefile.in by configure.
 
-VNCOBJ = vnc.o os_calls.o d3des.o
+# Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
+# 2003, 2004, 2005, 2006, 2007, 2008  Free Software Foundation, Inc.
+# This Makefile.in is free software; the Free Software Foundation
+# gives unlimited permission to copy and/or distribute it,
+# with or without modifications, as long as this notice is preserved.
 
-DESTDIR = /usr/local/xrdp
-CFGDIR = /etc/xrdp
-PIDDIR = /var/run
-MANDIR = /usr/local/man
-DOCDIR = /usr/doc/xrdp
+# This program is distributed in the hope that it will be useful,
+# but WITHOUT ANY WARRANTY, to the extent permitted by law; without
+# even the implied warranty of MERCHANTABILITY or FITNESS FOR A
+# PARTICULAR PURPOSE.
 
-DEFINES =
 
-CFLAGS = -Wall -O2 -I../common -fPIC $(DEFINES)
-C_OS_FLAGS = $(CFLAGS) -c -g
-LDFLAGS = -shared
-LIBS = -ldl
+
+
+pkgdatadir = $(datadir)/xrdp
+pkglibdir = $(libdir)/xrdp
+pkgincludedir = $(includedir)/xrdp
+am__cd = CDPATH="$${ZSH_VERSION+.}$(PATH_SEPARATOR)" && cd
+install_sh_DATA = $(install_sh) -c -m 644
+install_sh_PROGRAM = $(install_sh) -c
+install_sh_SCRIPT = $(install_sh) -c
+INSTALL_HEADER = $(INSTALL_DATA)
+transform = $(program_transform_name)
+NORMAL_INSTALL = :
+PRE_INSTALL = :
+POST_INSTALL = :
+NORMAL_UNINSTALL = :
+PRE_UNINSTALL = :
+POST_UNINSTALL = :
+build_triplet = i686-suse-linux-gnu
+host_triplet = i686-suse-linux-gnu
+subdir = vnc
+DIST_COMMON = $(srcdir)/Makefile.am $(srcdir)/Makefile.in
+ACLOCAL_M4 = $(top_srcdir)/aclocal.m4
+am__aclocal_m4_deps = $(top_srcdir)/configure.ac
+am__configure_deps = $(am__aclocal_m4_deps) $(CONFIGURE_DEPENDENCIES) \
+	$(ACLOCAL_M4)
+mkinstalldirs = $(install_sh) -d
+CONFIG_HEADER = $(top_builddir)/config_ac.h
+CONFIG_CLEAN_FILES =
+am__vpath_adj_setup = srcdirstrip=`echo "$(srcdir)" | sed 's|.|.|g'`;
+am__vpath_adj = case $$p in \
+    $(srcdir)/*) f=`echo "$$p" | sed "s|^$$srcdirstrip/||"`;; \
+    *) f=$$p;; \
+  esac;
+am__strip_dir = `echo $$p | sed -e 's|^.*/||'`;
+am__installdirs = "$(DESTDIR)$(libdir)"
+libLTLIBRARIES_INSTALL = $(INSTALL)
+LTLIBRARIES = $(lib_LTLIBRARIES)
+libvnc_la_DEPENDENCIES = $(top_srcdir)/common/libcommon.la
+am_libvnc_la_OBJECTS = vnc.lo
+libvnc_la_OBJECTS = $(am_libvnc_la_OBJECTS)
+DEFAULT_INCLUDES = -I. -I$(top_builddir)
+depcomp = $(SHELL) $(top_srcdir)/depcomp
+am__depfiles_maybe = depfiles
+COMPILE = $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) \
+	$(CPPFLAGS) $(AM_CFLAGS) $(CFLAGS)
+LTCOMPILE = $(LIBTOOL) --tag=CC $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) \
+	--mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) \
+	$(AM_CPPFLAGS) $(CPPFLAGS) $(AM_CFLAGS) $(CFLAGS)
+CCLD = $(CC)
+LINK = $(LIBTOOL) --tag=CC $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) \
+	--mode=link $(CCLD) $(AM_CFLAGS) $(CFLAGS) $(AM_LDFLAGS) \
+	$(LDFLAGS) -o $@
+SOURCES = $(libvnc_la_SOURCES)
+DIST_SOURCES = $(libvnc_la_SOURCES)
+ETAGS = etags
+CTAGS = ctags
+DISTFILES = $(DIST_COMMON) $(DIST_SOURCES) $(TEXINFOS) $(EXTRA_DIST)
+ACLOCAL = ${SHELL} /home/david/git/xrdp/missing --run aclocal-1.10
+AMTAR = ${SHELL} /home/david/git/xrdp/missing --run tar
+AR = ar
+AUTOCONF = ${SHELL} /home/david/git/xrdp/missing --run autoconf
+AUTOHEADER = ${SHELL} /home/david/git/xrdp/missing --run autoheader
+AUTOMAKE = ${SHELL} /home/david/git/xrdp/missing --run automake-1.10
+AWK = gawk
 CC = gcc
+CCDEPMODE = depmode=gcc3
+CFLAGS = -g -O2
+CPP = gcc -E
+CPPFLAGS = 
+CXX = g++
+CXXCPP = g++ -E
+CXXDEPMODE = depmode=gcc3
+CXXFLAGS = -g -O2
+CYGPATH_W = echo
+DEFS = -DHAVE_CONFIG_H
+DEPDIR = .deps
+DSYMUTIL = 
+ECHO = echo
+ECHO_C = 
+ECHO_N = -n
+ECHO_T = 
+EGREP = /usr/bin/grep -E
+EXEEXT = 
+F77 = 
+FFLAGS = 
+GREP = /usr/bin/grep
+INSTALL = /usr/bin/install -c
+INSTALL_DATA = ${INSTALL} -m 644
+INSTALL_PROGRAM = ${INSTALL}
+INSTALL_SCRIPT = ${INSTALL}
+INSTALL_STRIP_PROGRAM = $(install_sh) -c -s
+LDFLAGS = 
+LIBOBJS = 
+LIBS = 
+LIBTOOL = $(SHELL) $(top_builddir)/libtool
+LN_S = ln -s
+LTLIBOBJS = 
+MAKEINFO = ${SHELL} /home/david/git/xrdp/missing --run makeinfo
+MKDIR_P = /bin/mkdir -p
+NMEDIT = 
+OBJEXT = o
+PACKAGE = xrdp
+PACKAGE_BUGREPORT = xrdp-devel@lists.sourceforge.net
+PACKAGE_NAME = xrdp
+PACKAGE_STRING = xrdp 0.5.0
+PACKAGE_TARNAME = xrdp
+PACKAGE_VERSION = 0.5.0
+PATH_SEPARATOR = :
+RANLIB = ranlib
+SED = /usr/bin/sed
+SET_MAKE = 
+SHELL = /bin/sh
+STRIP = strip
+VERSION = 0.5.0
+abs_builddir = /home/david/git/xrdp/vnc
+abs_srcdir = /home/david/git/xrdp/vnc
+abs_top_builddir = /home/david/git/xrdp
+abs_top_srcdir = /home/david/git/xrdp
+ac_ct_CC = gcc
+ac_ct_CXX = g++
+ac_ct_F77 = 
+am__include = include
+am__leading_dot = .
+am__quote = 
+am__tar = ${AMTAR} chof - "$$tardir"
+am__untar = ${AMTAR} xf -
+bindir = ${exec_prefix}/bin
+build = i686-suse-linux-gnu
+build_alias = 
+build_cpu = i686
+build_os = linux-gnu
+build_vendor = suse
+builddir = .
+datadir = ${datarootdir}
+datarootdir = ${prefix}/share
+docdir = ${datarootdir}/doc/${PACKAGE_TARNAME}
+dvidir = ${docdir}
+exec_prefix = ${prefix}
+host = i686-suse-linux-gnu
+host_alias = 
+host_cpu = i686
+host_os = linux-gnu
+host_vendor = suse
+htmldir = ${docdir}
+includedir = ${prefix}/include
+infodir = ${datarootdir}/info
+install_sh = $(SHELL) /home/david/git/xrdp/install-sh
+libdir = ${exec_prefix}/lib/xrdp/
+libexecdir = ${exec_prefix}/libexec
+localedir = ${datarootdir}/locale
+localstatedir = ${prefix}/var
+mandir = ${datarootdir}/man
+mkdir_p = /bin/mkdir -p
+oldincludedir = /usr/include
+pdfdir = ${docdir}
+prefix = /usr
+program_transform_name = s,x,x,
+psdir = ${docdir}
+sbindir = ${exec_prefix}/sbin
+sharedstatedir = ${prefix}/com
+srcdir = .
+sysconfdir = ${prefix}/etc
+target_alias = 
+top_builddir = ..
+top_srcdir = ..
+INCLUDES = \
+  -I$(top_srcdir)/common
+
+lib_LTLIBRARIES = \
+  libvnc.la
+
+libvnc_la_SOURCES = vnc.c
+libvnc_la_LIBADD = \
+  $(top_srcdir)/common/libcommon.la
+
+all: all-am
+
+.SUFFIXES:
+.SUFFIXES: .c .lo .o .obj
+$(srcdir)/Makefile.in:  $(srcdir)/Makefile.am  $(am__configure_deps)
+	@for dep in $?; do \
+	  case '$(am__configure_deps)' in \
+	    *$$dep*) \
+	      cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh \
+		&& exit 0; \
+	      exit 1;; \
+	  esac; \
+	done; \
+	echo ' cd $(top_srcdir) && $(AUTOMAKE) --foreign  vnc/Makefile'; \
+	cd $(top_srcdir) && \
+	  $(AUTOMAKE) --foreign  vnc/Makefile
+.PRECIOUS: Makefile
+Makefile: $(srcdir)/Makefile.in $(top_builddir)/config.status
+	@case '$?' in \
+	  *config.status*) \
+	    cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh;; \
+	  *) \
+	    echo ' cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe)'; \
+	    cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe);; \
+	esac;
+
+$(top_builddir)/config.status: $(top_srcdir)/configure $(CONFIG_STATUS_DEPENDENCIES)
+	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
+
+$(top_srcdir)/configure:  $(am__configure_deps)
+	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
+$(ACLOCAL_M4):  $(am__aclocal_m4_deps)
+	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
+install-libLTLIBRARIES: $(lib_LTLIBRARIES)
+	@$(NORMAL_INSTALL)
+	test -z "$(libdir)" || $(MKDIR_P) "$(DESTDIR)$(libdir)"
+	@list='$(lib_LTLIBRARIES)'; for p in $$list; do \
+	  if test -f $$p; then \
+	    f=$(am__strip_dir) \
+	    echo " $(LIBTOOL) $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=install $(libLTLIBRARIES_INSTALL) $(INSTALL_STRIP_FLAG) '$$p' '$(DESTDIR)$(libdir)/$$f'"; \
+	    $(LIBTOOL) $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=install $(libLTLIBRARIES_INSTALL) $(INSTALL_STRIP_FLAG) "$$p" "$(DESTDIR)$(libdir)/$$f"; \
+	  else :; fi; \
+	done
+
+uninstall-libLTLIBRARIES:
+	@$(NORMAL_UNINSTALL)
+	@list='$(lib_LTLIBRARIES)'; for p in $$list; do \
+	  p=$(am__strip_dir) \
+	  echo " $(LIBTOOL) $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=uninstall rm -f '$(DESTDIR)$(libdir)/$$p'"; \
+	  $(LIBTOOL) $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=uninstall rm -f "$(DESTDIR)$(libdir)/$$p"; \
+	done
+
+clean-libLTLIBRARIES:
+	-test -z "$(lib_LTLIBRARIES)" || rm -f $(lib_LTLIBRARIES)
+	@list='$(lib_LTLIBRARIES)'; for p in $$list; do \
+	  dir="`echo $$p | sed -e 's|/[^/]*$$||'`"; \
+	  test "$$dir" != "$$p" || dir=.; \
+	  echo "rm -f \"$${dir}/so_locations\""; \
+	  rm -f "$${dir}/so_locations"; \
+	done
+libvnc.la: $(libvnc_la_OBJECTS) $(libvnc_la_DEPENDENCIES) 
+	$(LINK) -rpath $(libdir) $(libvnc_la_OBJECTS) $(libvnc_la_LIBADD) $(LIBS)
+
+mostlyclean-compile:
+	-rm -f *.$(OBJEXT)
+
+distclean-compile:
+	-rm -f *.tab.c
+
+include ./$(DEPDIR)/vnc.Plo
+
+.c.o:
+	$(COMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ $<
+	mv -f $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Po
+#	source='$<' object='$@' libtool=no \
+#	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) \
+#	$(COMPILE) -c $<
+
+.c.obj:
+	$(COMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ `$(CYGPATH_W) '$<'`
+	mv -f $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Po
+#	source='$<' object='$@' libtool=no \
+#	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) \
+#	$(COMPILE) -c `$(CYGPATH_W) '$<'`
+
+.c.lo:
+	$(LTCOMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ $<
+	mv -f $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Plo
+#	source='$<' object='$@' libtool=yes \
+#	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) \
+#	$(LTCOMPILE) -c -o $@ $<
+
+mostlyclean-libtool:
+	-rm -f *.lo
+
+clean-libtool:
+	-rm -rf .libs _libs
+
+ID: $(HEADERS) $(SOURCES) $(LISP) $(TAGS_FILES)
+	list='$(SOURCES) $(HEADERS) $(LISP) $(TAGS_FILES)'; \
+	unique=`for i in $$list; do \
+	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
+	  done | \
+	  $(AWK) '{ files[$$0] = 1; nonemtpy = 1; } \
+	      END { if (nonempty) { for (i in files) print i; }; }'`; \
+	mkid -fID $$unique
+tags: TAGS
+
+TAGS:  $(HEADERS) $(SOURCES)  $(TAGS_DEPENDENCIES) \
+		$(TAGS_FILES) $(LISP)
+	tags=; \
+	here=`pwd`; \
+	list='$(SOURCES) $(HEADERS)  $(LISP) $(TAGS_FILES)'; \
+	unique=`for i in $$list; do \
+	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
+	  done | \
+	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
+	      END { if (nonempty) { for (i in files) print i; }; }'`; \
+	if test -z "$(ETAGS_ARGS)$$tags$$unique"; then :; else \
+	  test -n "$$unique" || unique=$$empty_fix; \
+	  $(ETAGS) $(ETAGSFLAGS) $(AM_ETAGSFLAGS) $(ETAGS_ARGS) \
+	    $$tags $$unique; \
+	fi
+ctags: CTAGS
+CTAGS:  $(HEADERS) $(SOURCES)  $(TAGS_DEPENDENCIES) \
+		$(TAGS_FILES) $(LISP)
+	tags=; \
+	list='$(SOURCES) $(HEADERS)  $(LISP) $(TAGS_FILES)'; \
+	unique=`for i in $$list; do \
+	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
+	  done | \
+	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
+	      END { if (nonempty) { for (i in files) print i; }; }'`; \
+	test -z "$(CTAGS_ARGS)$$tags$$unique" \
+	  || $(CTAGS) $(CTAGSFLAGS) $(AM_CTAGSFLAGS) $(CTAGS_ARGS) \
+	     $$tags $$unique
+
+GTAGS:
+	here=`$(am__cd) $(top_builddir) && pwd` \
+	  && cd $(top_srcdir) \
+	  && gtags -i $(GTAGS_ARGS) $$here
+
+distclean-tags:
+	-rm -f TAGS ID GTAGS GRTAGS GSYMS GPATH tags
+
+distdir: $(DISTFILES)
+	@srcdirstrip=`echo "$(srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
+	topsrcdirstrip=`echo "$(top_srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
+	list='$(DISTFILES)'; \
+	  dist_files=`for file in $$list; do echo $$file; done | \
+	  sed -e "s|^$$srcdirstrip/||;t" \
+	      -e "s|^$$topsrcdirstrip/|$(top_builddir)/|;t"`; \
+	case $$dist_files in \
+	  */*) $(MKDIR_P) `echo "$$dist_files" | \
+			   sed '/\//!d;s|^|$(distdir)/|;s,/[^/]*$$,,' | \
+			   sort -u` ;; \
+	esac; \
+	for file in $$dist_files; do \
+	  if test -f $$file || test -d $$file; then d=.; else d=$(srcdir); fi; \
+	  if test -d $$d/$$file; then \
+	    dir=`echo "/$$file" | sed -e 's,/[^/]*$$,,'`; \
+	    if test -d $(srcdir)/$$file && test $$d != $(srcdir); then \
+	      cp -pR $(srcdir)/$$file $(distdir)$$dir || exit 1; \
+	    fi; \
+	    cp -pR $$d/$$file $(distdir)$$dir || exit 1; \
+	  else \
+	    test -f $(distdir)/$$file \
+	    || cp -p $$d/$$file $(distdir)/$$file \
+	    || exit 1; \
+	  fi; \
+	done
+check-am: all-am
+check: check-am
+all-am: Makefile $(LTLIBRARIES)
+installdirs:
+	for dir in "$(DESTDIR)$(libdir)"; do \
+	  test -z "$$dir" || $(MKDIR_P) "$$dir"; \
+	done
+install: install-am
+install-exec: install-exec-am
+install-data: install-data-am
+uninstall: uninstall-am
+
+install-am: all-am
+	@$(MAKE) $(AM_MAKEFLAGS) install-exec-am install-data-am
+
+installcheck: installcheck-am
+install-strip:
+	$(MAKE) $(AM_MAKEFLAGS) INSTALL_PROGRAM="$(INSTALL_STRIP_PROGRAM)" \
+	  install_sh_PROGRAM="$(INSTALL_STRIP_PROGRAM)" INSTALL_STRIP_FLAG=-s \
+	  `test -z '$(STRIP)' || \
+	    echo "INSTALL_PROGRAM_ENV=STRIPPROG='$(STRIP)'"` install
+mostlyclean-generic:
+
+clean-generic:
+
+distclean-generic:
+	-test -z "$(CONFIG_CLEAN_FILES)" || rm -f $(CONFIG_CLEAN_FILES)
+
+maintainer-clean-generic:
+	@echo "This command is intended for maintainers to use"
+	@echo "it deletes files that may require special tools to rebuild."
+clean: clean-am
+
+clean-am: clean-generic clean-libLTLIBRARIES clean-libtool \
+	mostlyclean-am
+
+distclean: distclean-am
+	-rm -rf ./$(DEPDIR)
+	-rm -f Makefile
+distclean-am: clean-am distclean-compile distclean-generic \
+	distclean-tags
+
+dvi: dvi-am
+
+dvi-am:
+
+html: html-am
+
+info: info-am
+
+info-am:
+
+install-data-am:
+
+install-dvi: install-dvi-am
+
+install-exec-am: install-libLTLIBRARIES
+
+install-html: install-html-am
+
+install-info: install-info-am
+
+install-man:
+
+install-pdf: install-pdf-am
+
+install-ps: install-ps-am
+
+installcheck-am:
+
+maintainer-clean: maintainer-clean-am
+	-rm -rf ./$(DEPDIR)
+	-rm -f Makefile
+maintainer-clean-am: distclean-am maintainer-clean-generic
+
+mostlyclean: mostlyclean-am
+
+mostlyclean-am: mostlyclean-compile mostlyclean-generic \
+	mostlyclean-libtool
+
+pdf: pdf-am
 
-all: vnc
+pdf-am:
 
-vnc: $(VNCOBJ)
-	$(CC) $(LDFLAGS) -o libvnc.so $(VNCOBJ) $(LIBS)
+ps: ps-am
 
-clean:
-	rm -f $(VNCOBJ) libvnc.so
+ps-am:
 
-os_calls.o: ../common/os_calls.c
-	$(CC) $(C_OS_FLAGS) ../common/os_calls.c
+uninstall-am: uninstall-libLTLIBRARIES
 
-d3des.o: ../common/d3des.c
-	$(CC) $(C_OS_FLAGS) ../common/d3des.c
+.MAKE: install-am install-strip
 
-install:
-	install libvnc.so $(DESTDIR)/libvnc.so
+.PHONY: CTAGS GTAGS all all-am check check-am clean clean-generic \
+	clean-libLTLIBRARIES clean-libtool ctags distclean \
+	distclean-compile distclean-generic distclean-libtool \
+	distclean-tags distdir dvi dvi-am html html-am info info-am \
+	install install-am install-data install-data-am install-dvi \
+	install-dvi-am install-exec install-exec-am install-html \
+	install-html-am install-info install-info-am \
+	install-libLTLIBRARIES install-man install-pdf install-pdf-am \
+	install-ps install-ps-am install-strip installcheck \
+	installcheck-am installdirs maintainer-clean \
+	maintainer-clean-generic mostlyclean mostlyclean-compile \
+	mostlyclean-generic mostlyclean-libtool pdf pdf-am ps ps-am \
+	tags uninstall uninstall-am uninstall-libLTLIBRARIES
 
-installdeb:
-	install libvnc.so $(DESTDIRDEB)/usr/lib/xrdp/libvnc.so
+# Tell versions [3.59,3.63) of GNU make to not export all variables.
+# Otherwise a system limit (for SysV at least) may be exceeded.
+.NOEXPORT:
diff --git a/vnc/Makefile.am b/vnc/Makefile.am
new file mode 100644
index 0000000..6f6bc9d
--- /dev/null
+++ b/vnc/Makefile.am
@@ -0,0 +1,10 @@
+INCLUDES = \
+  -I$(top_srcdir)/common
+
+lib_LTLIBRARIES = \
+  libvnc.la
+
+libvnc_la_SOURCES = vnc.c
+
+libvnc_la_LIBADD = \
+  $(top_srcdir)/common/libcommon.la
diff --git a/vnc/Makefile.osx b/vnc/Makefile.osx
new file mode 100644
index 0000000..158daa0
--- /dev/null
+++ b/vnc/Makefile.osx
@@ -0,0 +1,37 @@
+# libvnc makefile
+
+VNCOBJ = vnc.o os_calls.o d3des.o
+
+DESTDIR = /usr/local/xrdp
+CFGDIR = /etc/xrdp
+PIDDIR = /var/run
+MANDIR = /usr/local/man
+DOCDIR = /usr/doc/xrdp
+
+DEFINES =
+
+VNCLIB = libvnc.dylib
+
+CFLAGS = -Wall -O2 -I../common -fPIC $(DEFINES)
+C_OS_FLAGS = $(CFLAGS) -c -g
+LDFLAGS = -dynamiclib -Wl,-flat_namespace -Wl,-undefined -Wl,suppress
+LIBS =
+CC = gcc
+
+all: $(VNCLIB)
+
+$(VNCLIB): $(VNCOBJ)
+	$(CC) $(LDFLAGS) -o $(VNCLIB) $(VNCOBJ) $(LIBS)
+
+clean:
+	rm -f $(VNCOBJ) $(VNCLIB)
+
+os_calls.o: ../common/os_calls.c
+	$(CC) $(C_OS_FLAGS) ../common/os_calls.c
+
+d3des.o: ../common/d3des.c
+	$(CC) $(C_OS_FLAGS) ../common/d3des.c
+
+install:
+	install $(VNCLIB) $(DESTDIR)/$(VNCLIB)
+
diff --git a/vnc/vnc.c b/vnc/vnc.c
index 90de0ce..5f9c9ba 100644
--- a/vnc/vnc.c
+++ b/vnc/vnc.c
@@ -14,7 +14,7 @@
    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
 
    xrdp: A Remote Desktop Protocol server.
-   Copyright (C) Jay Sorg 2004-2007
+   Copyright (C) Jay Sorg 2004-2008
 
    libvnc
 
@@ -203,6 +203,222 @@ lib_process_channel_data(struct vnc* v, int chanid, int size, struct stream* s)
 }
 
 /******************************************************************************/
+static int APP_CC
+unicode_to_keysym(int unicode)
+{
+  int keysym;
+
+  switch (unicode)
+  {
+    case 0x017e:
+      keysym = 0x01be; /* XK_zcaron */
+      break;
+    case 0x0401:
+      keysym = 0x06b3; /* XK_Cyrillic_IO */
+      break;
+    case 0x0410:
+      keysym = 0x06e1; /* XK_Cyrillic_A */
+      break;
+    case 0x0411:
+      keysym = 0x06e2; /* XK_Cyrillic_BE */
+      break;
+    case 0x0412:
+      keysym = 0x06f7; /* XK_Cyrillic_VE */
+      break;
+    case 0x0413:
+      keysym = 0x06e7; /* XK_Cyrillic_GHE */
+      break;
+    case 0x0414:
+      keysym = 0x06e4; /* XK_Cyrillic_DE */
+      break;
+    case 0x0415:
+      keysym = 0x06e5; /* XK_Cyrillic_IE */
+      break;
+    case 0x0416:
+      keysym = 0x06f6; /* XK_Cyrillic_ZHE */
+      break;
+    case 0x0417:
+      keysym = 0x06fa; /* XK_Cyrillic_ZE */
+      break;
+    case 0x0418:
+      keysym = 0x06e9; /* XK_Cyrillic_I */
+      break;
+    case 0x0419:
+      keysym = 0x06ea; /* XK_Cyrillic_SHORTI */
+      break;
+    case 0x041a:
+      keysym = 0x06eb; /* XK_Cyrillic_KA */
+      break;
+    case 0x041b:
+      keysym = 0x06ec; /* XK_Cyrillic_EL */
+      break;
+    case 0x041c:
+      keysym = 0x06ed; /* XK_Cyrillic_EM */
+      break;
+    case 0x041d:
+      keysym = 0x06ee; /* XK_Cyrillic_EN */
+      break;
+    case 0x041e:
+      keysym = 0x06ef; /* XK_Cyrillic_O */
+      break;
+    case 0x041f:
+      keysym = 0x06f0; /* XK_Cyrillic_PE */
+      break;
+    case 0x0420:
+      keysym = 0x06f2; /* XK_Cyrillic_ER */
+      break;
+    case 0x0423:
+      keysym = 0x06f5; /* XK_Cyrillic_U */
+      break;
+    case 0x0424:
+      keysym = 0x06e6; /* XK_Cyrillic_EF */
+      break;
+    case 0x0425:
+      keysym = 0x06e8; /* XK_Cyrillic_HA */
+      break;
+    case 0x0426:
+      keysym = 0x06e3; /* XK_Cyrillic_TSE */
+      break;
+    case 0x0428:
+      keysym = 0x06fb; /* XK_Cyrillic_SHA */
+      break;
+    case 0x0429:
+      keysym = 0x06fd; /* XK_Cyrillic_SHCHA */
+      break;
+    case 0x042a:
+      keysym = 0x06ff; /* XK_Cyrillic_HARDSIGN */
+      break;
+    case 0x042b:
+      keysym = 0x06f9; /* XK_Cyrillic_YERU */
+      break;
+    case 0x042d:
+      keysym = 0x06fc; /* XK_Cyrillic_E */
+      break;
+    case 0x042f:
+      keysym = 0x06f1; /* XK_Cyrillic_YA */
+      break;
+    case 0x0427:
+      keysym = 0x06fe; /* XK_Cyrillic_CHE */
+      break;
+    case 0x0421:
+      keysym = 0x06f3; /* XK_Cyrillic_ES */
+      break;
+    case 0x0422:
+      keysym = 0x06f4; /* XK_Cyrillic_TE */
+      break;
+    case 0x042c:
+      keysym = 0x06f8; /* XK_Cyrillic_SOFTSIGN */
+      break;
+    case 0x042e:
+      keysym = 0x06e0; /* XK_Cyrillic_YU */
+      break;
+    case 0x0430:
+      keysym = 0x06c1; /* XK_Cyrillic_a */
+      break;
+    case 0x0431:
+      keysym = 0x06c2; /* XK_Cyrillic_be */
+      break;
+    case 0x0432:
+      keysym = 0x06d7; /* XK_Cyrillic_ve */
+      break;
+    case 0x0433:
+      keysym = 0x06c7; /* XK_Cyrillic_ghe */
+      break;
+    case 0x0434:
+      keysym = 0x06c4; /* XK_Cyrillic_de */
+      break;
+    case 0x0435:
+      keysym = 0x06c5; /* XK_Cyrillic_ie */
+      break;
+    case 0x0436:
+      keysym = 0x06d6; /* XK_Cyrillic_zhe */
+      break;
+    case 0x0437:
+      keysym = 0x06da; /* XK_Cyrillic_ze */
+      break;
+    case 0x0438:
+      keysym = 0x06c9; /* XK_Cyrillic_i */
+      break;
+    case 0x0439:
+      keysym = 0x06ca; /* XK_Cyrillic_shorti */
+      break;
+    case 0x043a:
+      keysym = 0x06cb; /* XK_Cyrillic_ka */
+      break;
+    case 0x043b:
+      keysym = 0x06cc; /* XK_Cyrillic_el */
+      break;
+    case 0x043c:
+      keysym = 0x06cd; /* XK_Cyrillic_em */
+      break;
+    case 0x043d:
+      keysym = 0x06ce; /* XK_Cyrillic_en */
+      break;
+    case 0x043e:
+      keysym = 0x06cf; /* XK_Cyrillic_o */
+      break;
+    case 0x043f:
+      keysym = 0x06d0; /* XK_Cyrillic_pe */
+      break;
+    case 0x0440:
+      keysym = 0x06d2; /* XK_Cyrillic_er */
+      break;
+    case 0x0441:
+      keysym = 0x06d3; /* XK_Cyrillic_es */
+      break;
+    case 0x0442:
+      keysym = 0x06d4; /* XK_Cyrillic_te */
+      break;
+    case 0x0443:
+      keysym = 0x06d5; /* XK_Cyrillic_u */
+      break;
+    case 0x0444:
+      keysym = 0x06c6; /* XK_Cyrillic_ef */
+      break;
+    case 0x0445:
+      keysym = 0x06c8; /* XK_Cyrillic_ha */
+      break;
+    case 0x0446:
+      keysym = 0x06c3; /* XK_Cyrillic_tse */
+      break;
+    case 0x0447:
+      keysym = 0x06de; /* XK_Cyrillic_che */
+      break;
+    case 0x0448:
+      keysym = 0x06db; /* XK_Cyrillic_sha */
+      break;
+    case 0x0449:
+      keysym = 0x06dd; /* XK_Cyrillic_shcha */
+      break;
+    case 0x044a:
+      keysym = 0x06df; /* XK_Cyrillic_hardsign */
+      break;
+    case 0x044b:
+      keysym = 0x06d9; /* XK_Cyrillic_yeru */
+      break;
+    case 0x044c:
+      keysym = 0x06d8; /* XK_Cyrillic_softsign */
+      break;
+    case 0x044d:
+      keysym = 0x06dc; /* XK_Cyrillic_e */
+      break;
+    case 0x044e:
+      keysym = 0x06c0; /* XK_Cyrillic_yu */
+      break;
+    case 0x044f:
+      keysym = 0x06d1; /* XK_Cyrillic_ya */
+      break;
+    case 0x0451:
+      keysym = 0x06a3; /* XK_Cyrillic_io */
+      break;
+    default:
+      keysym = unicode;
+      break;
+  }
+  return keysym;
+}
+
+/******************************************************************************/
 int DEFAULT_CC
 lib_mod_event(struct vnc* v, int msg, long param1, long param2,
               long param3, long param4)
@@ -239,32 +455,22 @@ lib_mod_event(struct vnc* v, int msg, long param1, long param2,
       error = 1;
     }
   }
-  else if (msg >= 15 && msg <= 16) /* key events */
+  else if ((msg >= 15) && (msg <= 16)) /* key events */
   {
     key = 0;
     if (param2 == 0xffff) /* ascii char */
     {
-      /*g_writeln("msg %d param1 %x param2 %x param3 %x param4 %x",
-                msg, param1, param2, param3, param4);*/
-      switch (param1)
-      {
-        case 0x80: /* EuroSign */
-          key = 0x20ac;
-          break;
-        default:
-          key = param1;
-          break;
-      }
+      key = unicode_to_keysym(param1);
     }
     else /* non ascii key event */
     {
       switch (param1)
       {
         case 0x0001: /* ecs */
-          key = 0xff1b;
+          key = 0xff1b; /* XK_Escape */
           break;
         case 0x000e: /* backspace */
-          key = 0xff08;
+          key = 0xff08; /* XK_BackSpace */
           break;
         case 0x000f: /* tab(0xff09) or left tab(0xfe20) */
           /* some documentation says don't send left tab */
@@ -273,112 +479,113 @@ lib_mod_event(struct vnc* v, int msg, long param1, long param2,
           /* for now, sending left tab, I don't know which is best */
           /* nope, sending tab always */
           /* key = (v->shift_state) ? 0xfe20 : 0xff09; */
-          key = 0xff09;
+          key = 0xff09; /* XK_Tab */
           break;
         case 0x001c: /* enter */
-          key = 0xff0d;
+          key = 0xff0d; /* XK_Return */
           break;
         case 0x001d: /* left-right control */
-          key = (param2 & 0x0100) ? 0xffe4 : 0xffe3;
+          key = (param2 & 0x0100) ? 0xffe4 : 0xffe3; /* XK_Control_R */
+                                                     /* XK_Control_L */
           break;
         case 0x002a: /* left shift */
-          key = 0xffe1;
+          key = 0xffe1; /* XK_Shift_L */
           v->shift_state = (msg == 15);
           break;
         case 0x0036: /* right shift */
-          key = 0xffe2;
+          key = 0xffe2; /* XK_Shift_R */
           v->shift_state = (msg == 15);
           break;
         case 0x0038: /* left-right alt */
           if (param2 & 0x0100) /* right alt */
           {
             /* only en-us keymap can send right alt(alt-gr) */
-            if (v->keylayout == 0x409)
+            if (v->keylayout == 0x409) /* todo */
             {
-              key = 0xffea;
+              key = 0xffea; /* XK_Alt_R */
             }
           }
           else /* left alt */
           {
-            key = 0xffe9;
+            key = 0xffe9; /* XK_Alt_L */
           }
           break;
         case 0x003b: /* F1 */
-          key = 0xffbe;
+          key = 0xffbe; /* XK_F1 */
           break;
         case 0x003c: /* F2 */
-          key = 0xffbf;
+          key = 0xffbf; /* XK_F2 */
           break;
         case 0x003d: /* F3 */
-          key = 0xffc0;
+          key = 0xffc0; /* XK_F3 */
           break;
         case 0x003e: /* F4 */
-          key = 0xffc1;
+          key = 0xffc1; /* XK_F4 */
           break;
         case 0x003f: /* F5 */
-          key = 0xffc2;
+          key = 0xffc2; /* XK_F5 */
           break;
         case 0x0040: /* F6 */
-          key = 0xffc3;
+          key = 0xffc3; /* XK_F6 */
           break;
         case 0x0041: /* F7 */
-          key = 0xffc4;
+          key = 0xffc4; /* XK_F7 */
           break;
         case 0x0042: /* F8 */
-          key = 0xffc5;
+          key = 0xffc5; /* XK_F8 */
           break;
         case 0x0043: /* F9 */
-          key = 0xffc6;
+          key = 0xffc6; /* XK_F9 */
           break;
         case 0x0044: /* F10 */
-          key = 0xffc7;
+          key = 0xffc7; /* XK_F10 */
           break;
         case 0x0047: /* home */
-          key = 0xff50;
+          key = 0xff50; /* XK_Home */
           break;
         case 0x0048: /* up arrow */
-          key = 0xff52;
+          key = 0xff52; /* XK_Up */
           break;
         case 0x0049: /* page up */
-          key = 0xff55;
+          key = 0xff55; /* XK_Prior */
           break;
         case 0x004b: /* left arrow */
-          key = 0xff51;
+          key = 0xff51; /* XK_Left */
           break;
         case 0x004d: /* right arrow */
-          key = 0xff53;
+          key = 0xff53; /* XK_Right */
           break;
         case 0x004f: /* end */
-          key = 0xff57;
+          key = 0xff57; /* XK_End */
           break;
         case 0x0050: /* down arrow */
-          key = 0xff54;
+          key = 0xff54; /* XK_Down */
           break;
         case 0x0051: /* page down */
-          key = 0xff56;
+          key = 0xff56; /* XK_Next */
           break;
         case 0x0052: /* insert */
-          key = 0xff63;
+          key = 0xff63; /* XK_Insert */
           break;
         case 0x0053: /* delete */
-          key = 0xffff;
+          key = 0xffff; /* XK_Delete */
           break;
         case 0x0057: /* F11 */
-          key = 0xffc8;
+          key = 0xffc8; /* XK_F11 */
           break;
         case 0x0058: /* F12 */
-          key = 0xffc9;
+          key = 0xffc9; /* XK_F12 */
           break;
         /* not sure about the next three, I don't think rdesktop */
         /* sends them right */
         case 0x0037: /* Print Screen */
-          key = 0xff61;
+          key = 0xff61; /* XK_Print */
           break;
         case 0x0046: /* Scroll Lock */
-          key = 0xff14;
+          key = 0xff14; /* XK_Scroll_Lock */
           break;
         case 0x0045: /* Pause */
-          key = 0xff13;
+          key = 0xff13; /* XK_Pause */
           break;
         default:
           g_sprintf(text, "unkown key lib_mod_event msg %d \
@@ -954,6 +1161,7 @@ connections", 0);
   g_sprintf(con_port, "%s", v->port);
   make_stream(pixel_format);
   v->sck = g_tcp_socket();
+  v->sck_obj = g_create_wait_obj_from_socket(v->sck, 0);
   v->sck_closed = 0;
   g_sprintf(text, "connecting to %s %s", v->ip, con_port);
   v->server_msg(v, text, 0);
@@ -1233,6 +1441,47 @@ lib_mod_set_param(struct vnc* v, char* name, char* value)
 }
 
 /******************************************************************************/
+/* return error */
+int DEFAULT_CC
+lib_mod_get_wait_objs(struct vnc* v, tbus* read_objs, int* rcount,
+                      tbus* write_objs, int* wcount, int* timeout)
+{
+  int i;
+
+  i = *rcount;
+  if (v != 0)
+  {
+    if (v->sck_obj != 0)
+    {
+      read_objs[i++] = v->sck_obj;
+    }
+  }
+  *rcount = i;
+  return 0;
+}
+
+/******************************************************************************/
+/* return error */
+int DEFAULT_CC
+lib_mod_check_wait_objs(struct vnc* v)
+{
+  int rv;
+
+  rv = 0;
+  if (v != 0)
+  {
+    if (v->sck_obj != 0)
+    {
+      if (g_is_wait_obj_set(v->sck_obj))
+      {
+        rv = lib_mod_signal(v);
+      }
+    }
+  }
+  return rv;
+}
+
+/******************************************************************************/
 struct vnc* EXPORT_CC
 mod_init(void)
 {
@@ -1248,6 +1497,8 @@ mod_init(void)
   v->mod_signal = lib_mod_signal;
   v->mod_end = lib_mod_end;
   v->mod_set_param = lib_mod_set_param;
+  v->mod_get_wait_objs = lib_mod_get_wait_objs;
+  v->mod_check_wait_objs = lib_mod_check_wait_objs;
   return v;
 }
 
@@ -1259,6 +1510,7 @@ mod_exit(struct vnc* v)
   {
     return 0;
   }
+  g_delete_wait_obj_from_socket(v->sck_obj);
   g_tcp_close(v->sck);
   g_free(v);
   return 0;
diff --git a/vnc/vnc.h b/vnc/vnc.h
index 8125d0e..1d664eb 100644
--- a/vnc/vnc.h
+++ b/vnc/vnc.h
@@ -14,7 +14,7 @@
    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
 
    xrdp: A Remote Desktop Protocol server.
-   Copyright (C) Jay Sorg 2004-2007
+   Copyright (C) Jay Sorg 2004-2008
 
    libvnc
 
@@ -38,7 +38,11 @@ struct vnc
   int (*mod_signal)(struct vnc* v);
   int (*mod_end)(struct vnc* v);
   int (*mod_set_param)(struct vnc* v, char* name, char* value);
-  long mod_dumby[100 - 6]; /* align, 100 minus the number of mod
+  int (*mod_session_change)(struct vnc* v, int, int);
+  int (*mod_get_wait_objs)(struct vnc* v, tbus* read_objs, int* rcount,
+                           tbus* write_objs, int* wcount, int* timeout);
+  int (*mod_check_wait_objs)(struct vnc* v);
+  long mod_dumby[100 - 9]; /* align, 100 minus the number of mod
                               functions above */
   /* server functions */
   int (*server_begin_update)(struct vnc* v);
@@ -107,4 +111,5 @@ struct vnc
   int clip_chanid;
   char* clip_data;
   int clip_data_size;
+  tbus sck_obj;
 };
diff --git a/xrdp/Makefile b/xrdp/Makefile
index e60a2b3..db5021a 100644
--- a/xrdp/Makefile
+++ b/xrdp/Makefile
@@ -1,64 +1,563 @@
-# xrdp makefile
-XRDPOBJ = xrdp.o xrdp_process.o xrdp_listen.o \
-          xrdp_bitmap.o xrdp_wm.o xrdp_painter.o \
-          xrdp_region.o xrdp_cache.o xrdp_font.o funcs.o \
-          xrdp_login_wnd.o lang.o \
-          list.o file.o os_calls.o thread_calls.o \
-          xrdp_mm.o
-
-DESTDIR = /usr/local/xrdp
-CFGDIR = /etc/xrdp
-PIDDIR = /var/run
-MANDIR = /usr/local/man
-DOCDIR = /usr/doc/xrdp
-
-DEFINES = -DXRDP_CFG_FILE=\"$(CFGDIR)/xrdp.ini\" \
-          -DXRDP_PID_FILE=\"$(PIDDIR)/xrdp.pid\"
-
-CFLAGS = -Wall -O2 -I../common -I../libxrdp $(DEFINES)
-#CFLAGS += -DXRDP_DEBUG
-C_OS_FLAGS = $(CFLAGS) -c
-LDFLAGS = -L/usr/gnu/lib -L../libxrdp -Wl,-rpath,.
-LIBS = -ldl -lpthread -lxrdp
+# Makefile.in generated by automake 1.10.1 from Makefile.am.
+# xrdp/Makefile.  Generated from Makefile.in by configure.
+
+# Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
+# 2003, 2004, 2005, 2006, 2007, 2008  Free Software Foundation, Inc.
+# This Makefile.in is free software; the Free Software Foundation
+# gives unlimited permission to copy and/or distribute it,
+# with or without modifications, as long as this notice is preserved.
+
+# This program is distributed in the hope that it will be useful,
+# but WITHOUT ANY WARRANTY, to the extent permitted by law; without
+# even the implied warranty of MERCHANTABILITY or FITNESS FOR A
+# PARTICULAR PURPOSE.
+
+
+
+
+
+pkgdatadir = $(datadir)/xrdp
+pkglibdir = $(libdir)/xrdp
+pkgincludedir = $(includedir)/xrdp
+am__cd = CDPATH="$${ZSH_VERSION+.}$(PATH_SEPARATOR)" && cd
+install_sh_DATA = $(install_sh) -c -m 644
+install_sh_PROGRAM = $(install_sh) -c
+install_sh_SCRIPT = $(install_sh) -c
+INSTALL_HEADER = $(INSTALL_DATA)
+transform = $(program_transform_name)
+NORMAL_INSTALL = :
+PRE_INSTALL = :
+POST_INSTALL = :
+NORMAL_UNINSTALL = :
+PRE_UNINSTALL = :
+POST_UNINSTALL = :
+build_triplet = i686-suse-linux-gnu
+host_triplet = i686-suse-linux-gnu
+sbin_PROGRAMS = xrdp$(EXEEXT)
+subdir = xrdp
+DIST_COMMON = $(srcdir)/Makefile.am $(srcdir)/Makefile.in
+ACLOCAL_M4 = $(top_srcdir)/aclocal.m4
+am__aclocal_m4_deps = $(top_srcdir)/configure.ac
+am__configure_deps = $(am__aclocal_m4_deps) $(CONFIGURE_DEPENDENCIES) \
+	$(ACLOCAL_M4)
+mkinstalldirs = $(install_sh) -d
+CONFIG_HEADER = $(top_builddir)/config_ac.h
+CONFIG_CLEAN_FILES =
+am__installdirs = "$(DESTDIR)$(sbindir)" "$(DESTDIR)$(pkgdatadir)" \
+	"$(DESTDIR)$(xrdpsysconfdir)"
+sbinPROGRAMS_INSTALL = $(INSTALL_PROGRAM)
+PROGRAMS = $(sbin_PROGRAMS)
+am_xrdp_OBJECTS = funcs.$(OBJEXT) lang.$(OBJEXT) xrdp_bitmap.$(OBJEXT) \
+	xrdp.$(OBJEXT) xrdp_cache.$(OBJEXT) xrdp_font.$(OBJEXT) \
+	xrdp_listen.$(OBJEXT) xrdp_login_wnd.$(OBJEXT) \
+	xrdp_mm.$(OBJEXT) xrdp_painter.$(OBJEXT) \
+	xrdp_process.$(OBJEXT) xrdp_region.$(OBJEXT) xrdp_wm.$(OBJEXT)
+xrdp_OBJECTS = $(am_xrdp_OBJECTS)
+xrdp_DEPENDENCIES = $(top_srcdir)/common/libcommon.la \
+	$(top_srcdir)/libxrdp/libxrdp.la
+DEFAULT_INCLUDES = -I. -I$(top_builddir)
+depcomp = $(SHELL) $(top_srcdir)/depcomp
+am__depfiles_maybe = depfiles
+COMPILE = $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) \
+	$(CPPFLAGS) $(AM_CFLAGS) $(CFLAGS)
+LTCOMPILE = $(LIBTOOL) --tag=CC $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) \
+	--mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) \
+	$(AM_CPPFLAGS) $(CPPFLAGS) $(AM_CFLAGS) $(CFLAGS)
+CCLD = $(CC)
+LINK = $(LIBTOOL) --tag=CC $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) \
+	--mode=link $(CCLD) $(AM_CFLAGS) $(CFLAGS) $(AM_LDFLAGS) \
+	$(LDFLAGS) -o $@
+SOURCES = $(xrdp_SOURCES)
+DIST_SOURCES = $(xrdp_SOURCES)
+am__vpath_adj_setup = srcdirstrip=`echo "$(srcdir)" | sed 's|.|.|g'`;
+am__vpath_adj = case $$p in \
+    $(srcdir)/*) f=`echo "$$p" | sed "s|^$$srcdirstrip/||"`;; \
+    *) f=$$p;; \
+  esac;
+am__strip_dir = `echo $$p | sed -e 's|^.*/||'`;
+pkgdataDATA_INSTALL = $(INSTALL_DATA)
+xrdpsysconfDATA_INSTALL = $(INSTALL_DATA)
+DATA = $(pkgdata_DATA) $(xrdpsysconf_DATA)
+ETAGS = etags
+CTAGS = ctags
+DISTFILES = $(DIST_COMMON) $(DIST_SOURCES) $(TEXINFOS) $(EXTRA_DIST)
+ACLOCAL = ${SHELL} /home/david/git/xrdp/missing --run aclocal-1.10
+AMTAR = ${SHELL} /home/david/git/xrdp/missing --run tar
+AR = ar
+AUTOCONF = ${SHELL} /home/david/git/xrdp/missing --run autoconf
+AUTOHEADER = ${SHELL} /home/david/git/xrdp/missing --run autoheader
+AUTOMAKE = ${SHELL} /home/david/git/xrdp/missing --run automake-1.10
+AWK = gawk
 CC = gcc
+CCDEPMODE = depmode=gcc3
+CFLAGS = -g -O2
+CPP = gcc -E
+CPPFLAGS = 
+CXX = g++
+CXXCPP = g++ -E
+CXXDEPMODE = depmode=gcc3
+CXXFLAGS = -g -O2
+CYGPATH_W = echo
+DEFS = -DHAVE_CONFIG_H
+DEPDIR = .deps
+DSYMUTIL = 
+ECHO = echo
+ECHO_C = 
+ECHO_N = -n
+ECHO_T = 
+EGREP = /usr/bin/grep -E
+EXEEXT = 
+F77 = 
+FFLAGS = 
+GREP = /usr/bin/grep
+INSTALL = /usr/bin/install -c
+INSTALL_DATA = ${INSTALL} -m 644
+INSTALL_PROGRAM = ${INSTALL}
+INSTALL_SCRIPT = ${INSTALL}
+INSTALL_STRIP_PROGRAM = $(install_sh) -c -s
+LDFLAGS = 
+LIBOBJS = 
+LIBS = 
+LIBTOOL = $(SHELL) $(top_builddir)/libtool
+LN_S = ln -s
+LTLIBOBJS = 
+MAKEINFO = ${SHELL} /home/david/git/xrdp/missing --run makeinfo
+MKDIR_P = /bin/mkdir -p
+NMEDIT = 
+OBJEXT = o
+PACKAGE = xrdp
+PACKAGE_BUGREPORT = xrdp-devel@lists.sourceforge.net
+PACKAGE_NAME = xrdp
+PACKAGE_STRING = xrdp 0.5.0
+PACKAGE_TARNAME = xrdp
+PACKAGE_VERSION = 0.5.0
+PATH_SEPARATOR = :
+RANLIB = ranlib
+SED = /usr/bin/sed
+SET_MAKE = 
+SHELL = /bin/sh
+STRIP = strip
+VERSION = 0.5.0
+abs_builddir = /home/david/git/xrdp/xrdp
+abs_srcdir = /home/david/git/xrdp/xrdp
+abs_top_builddir = /home/david/git/xrdp
+abs_top_srcdir = /home/david/git/xrdp
+ac_ct_CC = gcc
+ac_ct_CXX = g++
+ac_ct_F77 = 
+am__include = include
+am__leading_dot = .
+am__quote = 
+am__tar = ${AMTAR} chof - "$$tardir"
+am__untar = ${AMTAR} xf -
+bindir = ${exec_prefix}/bin
+build = i686-suse-linux-gnu
+build_alias = 
+build_cpu = i686
+build_os = linux-gnu
+build_vendor = suse
+builddir = .
+datadir = ${datarootdir}
+datarootdir = ${prefix}/share
+docdir = ${datarootdir}/doc/${PACKAGE_TARNAME}
+dvidir = ${docdir}
+exec_prefix = ${prefix}
+host = i686-suse-linux-gnu
+host_alias = 
+host_cpu = i686
+host_os = linux-gnu
+host_vendor = suse
+htmldir = ${docdir}
+includedir = ${prefix}/include
+infodir = ${datarootdir}/info
+install_sh = $(SHELL) /home/david/git/xrdp/install-sh
+libdir = ${exec_prefix}/lib/xrdp/
+libexecdir = ${exec_prefix}/libexec
+localedir = ${datarootdir}/locale
+localstatedir = ${prefix}/var
+mandir = ${datarootdir}/man
+mkdir_p = /bin/mkdir -p
+oldincludedir = /usr/include
+pdfdir = ${docdir}
+prefix = /usr
+program_transform_name = s,x,x,
+psdir = ${docdir}
+sbindir = ${exec_prefix}/sbin
+sharedstatedir = ${prefix}/com
+srcdir = .
+sysconfdir = ${prefix}/etc
+target_alias = 
+top_builddir = ..
+top_srcdir = ..
+INCLUDES = \
+  -I$(top_srcdir)/common \
+  -I$(top_srcdir)/libxrdp
+
+xrdp_SOURCES = \
+  funcs.c \
+  lang.c \
+  xrdp_bitmap.c \
+  xrdp.c \
+  xrdp_cache.c \
+  xrdp_font.c \
+  xrdp_listen.c \
+  xrdp_login_wnd.c \
+  xrdp_mm.c \
+  xrdp_painter.c \
+  xrdp_process.c \
+  xrdp_region.c \
+  xrdp_wm.c
+
+xrdp_LDADD = \
+  $(top_srcdir)/common/libcommon.la \
+  $(top_srcdir)/libxrdp/libxrdp.la
+
+xrdpsysconfdir = $(sysconfdir)/xrdp
+xrdpsysconf_DATA = \
+  xrdp.ini \
+  rsakeys.ini
+
+pkgdata_DATA = \
+  ad256.bmp \
+  xrdp256.bmp \
+  sans-10.fv1 \
+  cursor0.cur \
+  cursor1.cur
+
+all: all-am
+
+.SUFFIXES:
+.SUFFIXES: .c .lo .o .obj
+$(srcdir)/Makefile.in:  $(srcdir)/Makefile.am  $(am__configure_deps)
+	@for dep in $?; do \
+	  case '$(am__configure_deps)' in \
+	    *$$dep*) \
+	      cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh \
+		&& exit 0; \
+	      exit 1;; \
+	  esac; \
+	done; \
+	echo ' cd $(top_srcdir) && $(AUTOMAKE) --foreign  xrdp/Makefile'; \
+	cd $(top_srcdir) && \
+	  $(AUTOMAKE) --foreign  xrdp/Makefile
+.PRECIOUS: Makefile
+Makefile: $(srcdir)/Makefile.in $(top_builddir)/config.status
+	@case '$?' in \
+	  *config.status*) \
+	    cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh;; \
+	  *) \
+	    echo ' cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe)'; \
+	    cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe);; \
+	esac;
+
+$(top_builddir)/config.status: $(top_srcdir)/configure $(CONFIG_STATUS_DEPENDENCIES)
+	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
+
+$(top_srcdir)/configure:  $(am__configure_deps)
+	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
+$(ACLOCAL_M4):  $(am__aclocal_m4_deps)
+	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
+install-sbinPROGRAMS: $(sbin_PROGRAMS)
+	@$(NORMAL_INSTALL)
+	test -z "$(sbindir)" || $(MKDIR_P) "$(DESTDIR)$(sbindir)"
+	@list='$(sbin_PROGRAMS)'; for p in $$list; do \
+	  p1=`echo $$p|sed 's/$(EXEEXT)$$//'`; \
+	  if test -f $$p \
+	     || test -f $$p1 \
+	  ; then \
+	    f=`echo "$$p1" | sed 's,^.*/,,;$(transform);s/$$/$(EXEEXT)/'`; \
+	   echo " $(INSTALL_PROGRAM_ENV) $(LIBTOOL) $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=install $(sbinPROGRAMS_INSTALL) '$$p' '$(DESTDIR)$(sbindir)/$$f'"; \
+	   $(INSTALL_PROGRAM_ENV) $(LIBTOOL) $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=install $(sbinPROGRAMS_INSTALL) "$$p" "$(DESTDIR)$(sbindir)/$$f" || exit 1; \
+	  else :; fi; \
+	done
+
+uninstall-sbinPROGRAMS:
+	@$(NORMAL_UNINSTALL)
+	@list='$(sbin_PROGRAMS)'; for p in $$list; do \
+	  f=`echo "$$p" | sed 's,^.*/,,;s/$(EXEEXT)$$//;$(transform);s/$$/$(EXEEXT)/'`; \
+	  echo " rm -f '$(DESTDIR)$(sbindir)/$$f'"; \
+	  rm -f "$(DESTDIR)$(sbindir)/$$f"; \
+	done
+
+clean-sbinPROGRAMS:
+	@list='$(sbin_PROGRAMS)'; for p in $$list; do \
+	  f=`echo $$p|sed 's/$(EXEEXT)$$//'`; \
+	  echo " rm -f $$p $$f"; \
+	  rm -f $$p $$f ; \
+	done
+xrdp$(EXEEXT): $(xrdp_OBJECTS) $(xrdp_DEPENDENCIES) 
+	@rm -f xrdp$(EXEEXT)
+	$(LINK) $(xrdp_OBJECTS) $(xrdp_LDADD) $(LIBS)
+
+mostlyclean-compile:
+	-rm -f *.$(OBJEXT)
+
+distclean-compile:
+	-rm -f *.tab.c
+
+include ./$(DEPDIR)/funcs.Po
+include ./$(DEPDIR)/lang.Po
+include ./$(DEPDIR)/xrdp.Po
+include ./$(DEPDIR)/xrdp_bitmap.Po
+include ./$(DEPDIR)/xrdp_cache.Po
+include ./$(DEPDIR)/xrdp_font.Po
+include ./$(DEPDIR)/xrdp_listen.Po
+include ./$(DEPDIR)/xrdp_login_wnd.Po
+include ./$(DEPDIR)/xrdp_mm.Po
+include ./$(DEPDIR)/xrdp_painter.Po
+include ./$(DEPDIR)/xrdp_process.Po
+include ./$(DEPDIR)/xrdp_region.Po
+include ./$(DEPDIR)/xrdp_wm.Po
+
+.c.o:
+	$(COMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ $<
+	mv -f $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Po
+#	source='$<' object='$@' libtool=no \
+#	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) \
+#	$(COMPILE) -c $<
+
+.c.obj:
+	$(COMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ `$(CYGPATH_W) '$<'`
+	mv -f $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Po
+#	source='$<' object='$@' libtool=no \
+#	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) \
+#	$(COMPILE) -c `$(CYGPATH_W) '$<'`
+
+.c.lo:
+	$(LTCOMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ $<
+	mv -f $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Plo
+#	source='$<' object='$@' libtool=yes \
+#	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) \
+#	$(LTCOMPILE) -c -o $@ $<
+
+mostlyclean-libtool:
+	-rm -f *.lo
+
+clean-libtool:
+	-rm -rf .libs _libs
+install-pkgdataDATA: $(pkgdata_DATA)
+	@$(NORMAL_INSTALL)
+	test -z "$(pkgdatadir)" || $(MKDIR_P) "$(DESTDIR)$(pkgdatadir)"
+	@list='$(pkgdata_DATA)'; for p in $$list; do \
+	  if test -f "$$p"; then d=; else d="$(srcdir)/"; fi; \
+	  f=$(am__strip_dir) \
+	  echo " $(pkgdataDATA_INSTALL) '$$d$$p' '$(DESTDIR)$(pkgdatadir)/$$f'"; \
+	  $(pkgdataDATA_INSTALL) "$$d$$p" "$(DESTDIR)$(pkgdatadir)/$$f"; \
+	done
+
+uninstall-pkgdataDATA:
+	@$(NORMAL_UNINSTALL)
+	@list='$(pkgdata_DATA)'; for p in $$list; do \
+	  f=$(am__strip_dir) \
+	  echo " rm -f '$(DESTDIR)$(pkgdatadir)/$$f'"; \
+	  rm -f "$(DESTDIR)$(pkgdatadir)/$$f"; \
+	done
+install-xrdpsysconfDATA: $(xrdpsysconf_DATA)
+	@$(NORMAL_INSTALL)
+	test -z "$(xrdpsysconfdir)" || $(MKDIR_P) "$(DESTDIR)$(xrdpsysconfdir)"
+	@list='$(xrdpsysconf_DATA)'; for p in $$list; do \
+	  if test -f "$$p"; then d=; else d="$(srcdir)/"; fi; \
+	  f=$(am__strip_dir) \
+	  echo " $(xrdpsysconfDATA_INSTALL) '$$d$$p' '$(DESTDIR)$(xrdpsysconfdir)/$$f'"; \
+	  $(xrdpsysconfDATA_INSTALL) "$$d$$p" "$(DESTDIR)$(xrdpsysconfdir)/$$f"; \
+	done
+
+uninstall-xrdpsysconfDATA:
+	@$(NORMAL_UNINSTALL)
+	@list='$(xrdpsysconf_DATA)'; for p in $$list; do \
+	  f=$(am__strip_dir) \
+	  echo " rm -f '$(DESTDIR)$(xrdpsysconfdir)/$$f'"; \
+	  rm -f "$(DESTDIR)$(xrdpsysconfdir)/$$f"; \
+	done
+
+ID: $(HEADERS) $(SOURCES) $(LISP) $(TAGS_FILES)
+	list='$(SOURCES) $(HEADERS) $(LISP) $(TAGS_FILES)'; \
+	unique=`for i in $$list; do \
+	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
+	  done | \
+	  $(AWK) '{ files[$$0] = 1; nonemtpy = 1; } \
+	      END { if (nonempty) { for (i in files) print i; }; }'`; \
+	mkid -fID $$unique
+tags: TAGS
+
+TAGS:  $(HEADERS) $(SOURCES)  $(TAGS_DEPENDENCIES) \
+		$(TAGS_FILES) $(LISP)
+	tags=; \
+	here=`pwd`; \
+	list='$(SOURCES) $(HEADERS)  $(LISP) $(TAGS_FILES)'; \
+	unique=`for i in $$list; do \
+	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
+	  done | \
+	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
+	      END { if (nonempty) { for (i in files) print i; }; }'`; \
+	if test -z "$(ETAGS_ARGS)$$tags$$unique"; then :; else \
+	  test -n "$$unique" || unique=$$empty_fix; \
+	  $(ETAGS) $(ETAGSFLAGS) $(AM_ETAGSFLAGS) $(ETAGS_ARGS) \
+	    $$tags $$unique; \
+	fi
+ctags: CTAGS
+CTAGS:  $(HEADERS) $(SOURCES)  $(TAGS_DEPENDENCIES) \
+		$(TAGS_FILES) $(LISP)
+	tags=; \
+	list='$(SOURCES) $(HEADERS)  $(LISP) $(TAGS_FILES)'; \
+	unique=`for i in $$list; do \
+	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
+	  done | \
+	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
+	      END { if (nonempty) { for (i in files) print i; }; }'`; \
+	test -z "$(CTAGS_ARGS)$$tags$$unique" \
+	  || $(CTAGS) $(CTAGSFLAGS) $(AM_CTAGSFLAGS) $(CTAGS_ARGS) \
+	     $$tags $$unique
+
+GTAGS:
+	here=`$(am__cd) $(top_builddir) && pwd` \
+	  && cd $(top_srcdir) \
+	  && gtags -i $(GTAGS_ARGS) $$here
+
+distclean-tags:
+	-rm -f TAGS ID GTAGS GRTAGS GSYMS GPATH tags
+
+distdir: $(DISTFILES)
+	@srcdirstrip=`echo "$(srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
+	topsrcdirstrip=`echo "$(top_srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
+	list='$(DISTFILES)'; \
+	  dist_files=`for file in $$list; do echo $$file; done | \
+	  sed -e "s|^$$srcdirstrip/||;t" \
+	      -e "s|^$$topsrcdirstrip/|$(top_builddir)/|;t"`; \
+	case $$dist_files in \
+	  */*) $(MKDIR_P) `echo "$$dist_files" | \
+			   sed '/\//!d;s|^|$(distdir)/|;s,/[^/]*$$,,' | \
+			   sort -u` ;; \
+	esac; \
+	for file in $$dist_files; do \
+	  if test -f $$file || test -d $$file; then d=.; else d=$(srcdir); fi; \
+	  if test -d $$d/$$file; then \
+	    dir=`echo "/$$file" | sed -e 's,/[^/]*$$,,'`; \
+	    if test -d $(srcdir)/$$file && test $$d != $(srcdir); then \
+	      cp -pR $(srcdir)/$$file $(distdir)$$dir || exit 1; \
+	    fi; \
+	    cp -pR $$d/$$file $(distdir)$$dir || exit 1; \
+	  else \
+	    test -f $(distdir)/$$file \
+	    || cp -p $$d/$$file $(distdir)/$$file \
+	    || exit 1; \
+	  fi; \
+	done
+check-am: all-am
+check: check-am
+all-am: Makefile $(PROGRAMS) $(DATA)
+installdirs:
+	for dir in "$(DESTDIR)$(sbindir)" "$(DESTDIR)$(pkgdatadir)" "$(DESTDIR)$(xrdpsysconfdir)"; do \
+	  test -z "$$dir" || $(MKDIR_P) "$$dir"; \
+	done
+install: install-am
+install-exec: install-exec-am
+install-data: install-data-am
+uninstall: uninstall-am
+
+install-am: all-am
+	@$(MAKE) $(AM_MAKEFLAGS) install-exec-am install-data-am
+
+installcheck: installcheck-am
+install-strip:
+	$(MAKE) $(AM_MAKEFLAGS) INSTALL_PROGRAM="$(INSTALL_STRIP_PROGRAM)" \
+	  install_sh_PROGRAM="$(INSTALL_STRIP_PROGRAM)" INSTALL_STRIP_FLAG=-s \
+	  `test -z '$(STRIP)' || \
+	    echo "INSTALL_PROGRAM_ENV=STRIPPROG='$(STRIP)'"` install
+mostlyclean-generic:
+
+clean-generic:
+
+distclean-generic:
+	-test -z "$(CONFIG_CLEAN_FILES)" || rm -f $(CONFIG_CLEAN_FILES)
+
+maintainer-clean-generic:
+	@echo "This command is intended for maintainers to use"
+	@echo "it deletes files that may require special tools to rebuild."
+clean: clean-am
+
+clean-am: clean-generic clean-libtool clean-sbinPROGRAMS \
+	mostlyclean-am
+
+distclean: distclean-am
+	-rm -rf ./$(DEPDIR)
+	-rm -f Makefile
+distclean-am: clean-am distclean-compile distclean-generic \
+	distclean-tags
+
+dvi: dvi-am
+
+dvi-am:
+
+html: html-am
+
+info: info-am
+
+info-am:
+
+install-data-am: install-pkgdataDATA install-xrdpsysconfDATA
+	@$(NORMAL_INSTALL)
+	$(MAKE) $(AM_MAKEFLAGS) install-data-hook
+
+install-dvi: install-dvi-am
+
+install-exec-am: install-sbinPROGRAMS
+
+install-html: install-html-am
+
+install-info: install-info-am
+
+install-man:
+
+install-pdf: install-pdf-am
+
+install-ps: install-ps-am
+
+installcheck-am:
+
+maintainer-clean: maintainer-clean-am
+	-rm -rf ./$(DEPDIR)
+	-rm -f Makefile
+maintainer-clean-am: distclean-am maintainer-clean-generic
+
+mostlyclean: mostlyclean-am
 
-all: xrdp
+mostlyclean-am: mostlyclean-compile mostlyclean-generic \
+	mostlyclean-libtool
 
-xrdp: $(XRDPOBJ)
-	$(CC) $(LDFLAGS) -o xrdp $(XRDPOBJ) $(LIBS)
+pdf: pdf-am
 
-clean:
-	rm -f $(XRDPOBJ) xrdp
+pdf-am:
 
-install:
-	install ad256.bmp $(DESTDIR)/ad256.bmp
-	install xrdp256.bmp $(DESTDIR)/xrdp256.bmp
-	install cursor0.cur $(DESTDIR)/cursor0.cur
-	install cursor1.cur $(DESTDIR)/cursor1.cur
-	install Tahoma-10.fv1 $(DESTDIR)/Tahoma-10.fv1
-	install xrdp.ini $(CFGDIR)/xrdp.ini
-	install rsakeys.ini $(CFGDIR)/rsakeys.ini
-	install xrdp $(DESTDIR)/xrdp
+ps: ps-am
 
-installdeb:
-	install ad256.bmp $(DESTDIRDEB)/usr/lib/xrdp/ad256.bmp
-	install xrdp256.bmp $(DESTDIRDEB)/usr/lib/xrdp/xrdp256.bmp
-	install cursor0.cur $(DESTDIRDEB)/usr/lib/xrdp/cursor0.cur
-	install cursor1.cur $(DESTDIRDEB)/usr/lib/xrdp/cursor1.cur
-	install Tahoma-10.fv1 $(DESTDIRDEB)/usr/lib/xrdp/Tahoma-10.fv1
-	install xrdp.ini $(DESTDIRDEB)/etc/xrdp/xrdp.ini
-	install rsakeys.ini $(DESTDIRDEB)/etc/xrdp/rsakeys.ini
-	install xrdp $(DESTDIRDEB)/usr/lib/xrdp/xrdp
+ps-am:
 
-list.o: ../common/list.c
-	$(CC) $(C_OS_FLAGS) ../common/list.c
+uninstall-am: uninstall-pkgdataDATA uninstall-sbinPROGRAMS \
+	uninstall-xrdpsysconfDATA
 
-file.o: ../common/file.c
-	$(CC) $(C_OS_FLAGS) ../common/file.c
+.MAKE: install-am install-data-am install-strip
 
-os_calls.o: ../common/os_calls.c
-	$(CC) $(C_OS_FLAGS) ../common/os_calls.c
+.PHONY: CTAGS GTAGS all all-am check check-am clean clean-generic \
+	clean-libtool clean-sbinPROGRAMS ctags distclean \
+	distclean-compile distclean-generic distclean-libtool \
+	distclean-tags distdir dvi dvi-am html html-am info info-am \
+	install install-am install-data install-data-am \
+	install-data-hook install-dvi install-dvi-am install-exec \
+	install-exec-am install-html install-html-am install-info \
+	install-info-am install-man install-pdf install-pdf-am \
+	install-pkgdataDATA install-ps install-ps-am \
+	install-sbinPROGRAMS install-strip install-xrdpsysconfDATA \
+	installcheck installcheck-am installdirs maintainer-clean \
+	maintainer-clean-generic mostlyclean mostlyclean-compile \
+	mostlyclean-generic mostlyclean-libtool pdf pdf-am ps ps-am \
+	tags uninstall uninstall-am uninstall-pkgdataDATA \
+	uninstall-sbinPROGRAMS uninstall-xrdpsysconfDATA
 
-thread_calls.o: ../common/thread_calls.c
-	$(CC) $(C_OS_FLAGS) ../common/thread_calls.c
 
+# must be tab below
+install-data-hook:
+	chmod 600 $(DESTDIR)$(sysconfdir)/xrdp/rsakeys.ini
+# Tell versions [3.59,3.63) of GNU make to not export all variables.
+# Otherwise a system limit (for SysV at least) may be exceeded.
+.NOEXPORT:
diff --git a/xrdp/Makefile.am b/xrdp/Makefile.am
new file mode 100644
index 0000000..32dd412
--- /dev/null
+++ b/xrdp/Makefile.am
@@ -0,0 +1,42 @@
+INCLUDES = \
+  -I$(top_srcdir)/common \
+  -I$(top_srcdir)/libxrdp
+
+sbin_PROGRAMS = \
+  xrdp
+
+xrdp_SOURCES = \
+  funcs.c \
+  lang.c \
+  xrdp_bitmap.c \
+  xrdp.c \
+  xrdp_cache.c \
+  xrdp_font.c \
+  xrdp_listen.c \
+  xrdp_login_wnd.c \
+  xrdp_mm.c \
+  xrdp_painter.c \
+  xrdp_process.c \
+  xrdp_region.c \
+  xrdp_wm.c
+
+xrdp_LDADD = \
+  $(top_srcdir)/common/libcommon.la \
+  $(top_srcdir)/libxrdp/libxrdp.la
+
+xrdpsysconfdir=$(sysconfdir)/xrdp
+
+xrdpsysconf_DATA = \
+  xrdp.ini \
+  rsakeys.ini
+
+pkgdata_DATA = \
+  ad256.bmp \
+  xrdp256.bmp \
+  sans-10.fv1 \
+  cursor0.cur \
+  cursor1.cur
+
+# must be tab below
+install-data-hook:
+	chmod 600 $(DESTDIR)$(sysconfdir)/xrdp/rsakeys.ini
diff --git a/xrdp/Makefile.osx b/xrdp/Makefile.osx
new file mode 100644
index 0000000..fcedc80
--- /dev/null
+++ b/xrdp/Makefile.osx
@@ -0,0 +1,53 @@
+# xrdp makefile
+XRDPOBJ = xrdp.o xrdp_process.o xrdp_listen.o \
+          xrdp_bitmap.o xrdp_wm.o xrdp_painter.o \
+          xrdp_region.o xrdp_cache.o xrdp_font.o funcs.o \
+          xrdp_login_wnd.o lang.o \
+          list.o file.o os_calls.o thread_calls.o \
+          xrdp_mm.o
+
+DESTDIR = /usr/local/xrdp
+CFGDIR = /etc/xrdp
+PIDDIR = /var/run
+MANDIR = /usr/local/man
+DOCDIR = /usr/doc/xrdp
+
+DEFINES = -DXRDP_CFG_FILE=\"$(CFGDIR)/xrdp.ini\" \
+          -DXRDP_PID_FILE=\"$(PIDDIR)/xrdp.pid\"
+
+CFLAGS = -Wall -O2 -I../common -I../libxrdp $(DEFINES)
+#CFLAGS += -DXRDP_DEBUG
+C_OS_FLAGS = $(CFLAGS) -c
+LDFLAGS = -L../libxrdp
+LIBS = -ldl -lpthread -lxrdp -lcrypto
+CC = gcc
+
+all: xrdp
+
+xrdp: $(XRDPOBJ)
+	$(CC) $(LDFLAGS) -o xrdp $(XRDPOBJ) $(LIBS)
+
+clean:
+	rm -f $(XRDPOBJ) xrdp
+
+install:
+	install ad256.bmp $(DESTDIR)/ad256.bmp
+	install xrdp256.bmp $(DESTDIR)/xrdp256.bmp
+	install cursor0.cur $(DESTDIR)/cursor0.cur
+	install cursor1.cur $(DESTDIR)/cursor1.cur
+	install sans-10.fv1 $(DESTDIR)/sans-10.fv1
+	install xrdp.ini $(CFGDIR)/xrdp.ini
+	install rsakeys.ini $(CFGDIR)/rsakeys.ini
+	install xrdp $(DESTDIR)/xrdp
+
+list.o: ../common/list.c
+	$(CC) $(C_OS_FLAGS) ../common/list.c
+
+file.o: ../common/file.c
+	$(CC) $(C_OS_FLAGS) ../common/file.c
+
+os_calls.o: ../common/os_calls.c
+	$(CC) $(C_OS_FLAGS) ../common/os_calls.c
+
+thread_calls.o: ../common/thread_calls.c
+	$(CC) $(C_OS_FLAGS) ../common/thread_calls.c
diff --git a/xrdp/Tahoma-10.fv1 b/xrdp/Tahoma-10.fv1
deleted file mode 100755
index 537bab6..0000000
--- a/xrdp/Tahoma-10.fv1
+++ /dev/null
@@ -1,22 +0,0 @@
-FNT1Tahoma                          
-                                                                                                                           	                        @ @  @                             
- 
-  @@                             L  R                 	                    @ @     ` `                                                                                                                        @@                                                                                                                                                                                                                    @@@@@@@                                                      @ @ @                           @ @ @ @ @@                                                     @ @ @@                         @@@@                        @                              @@@@@@                       @@@@ @                                                                                  	                         `      `                 	                                                     	                             0                                                                           	 	 	 	                              @@                          @@@                                                     @     @                                                                                                                                                                                                              @	 
-  
- 	 @                                       
-                     
-( 
-( 	H 	H                                
- 
- 	 ``        	                                                        @@@            	                                 p                     @@@	 @                                                                                             @                          @@                             B B                                   @ @                         @@                             @                                                                                                     	                                                                                                                                                     @ @@@                        @@@@@                                                      @ @ @@@@@@                           @@ @                                                         @@@@@ @ @                  @@@@@@                                                                                       	 
-  
- 	                                                                  d D D D D D                               @@@@@@                           @@@@@                           @@@@@                        @@@@@ @ @ @                                                                                                                       @@@@@@                                        
-                           P P P                                                                                                                                                                                                 	                              `                                                                                                                                                                                                                           	                                             D D                                                                                                                                               L`  R     `                        @                                                                               ?                                                                     @                                                                                                                                                                               	 	 	                                  	                                                                                                                                                                   @                                           D l T D                                                                                                                     B B ~ @ B                                                                                          @   @@                                                                                                                                                                   @@                          @                                                          @  @@ @@                   @                                              	 	 	 	 	                                                           @	 	 @          	                                                                                                                  	 	 	 	" 	                                                                                                                                                                                                                                              @@@@@@                    @@@@@@@@@@                                                                                                                                                                     	 @@	                                 " & J                                        & I A                                            *  R  _                                                             @@                         @@                   @    @@                   @    @@                     @    @@                      @@                                    >      >                                   @ @                                                                                                                                                                                   	                               
-                    	                                                  @    
- 
- 	 ``        	                                       	                                       	           @                          	                                     	             @                          	                         @   @                  	                      P  	 	 
-                                   @                            @                 @         @                   @         @                      @@                              @@@                         @@                           @ @@@                          @ @@@                         @ @@@                     @   @ @@@                          @ @@@                      @ @@@                                 0        8                                                          @@ @                         @@ @                        @@ @                         @@ @                                                                                      
-                                 
-                                   @@@@                     @  @@@@@@                         @@@@@                         @@@@@                        @@@@@                     @  @@@@@                         @@@@@        	                                                                     @	@
-@
-@                         @@@@@@                         @@@@@@                        @@@@@@                         @@@@@@                                                   @@@@@                              
\ No newline at end of file
diff --git a/xrdp/czech.txt b/xrdp/czech.txt
new file mode 100644
index 0000000..bb02e15
--- /dev/null
+++ b/xrdp/czech.txt
@@ -0,0 +1,29 @@
+no shift
+003b 002b 011b 0161 010d 0159 017e 00fd 00e1 00ed 0039 003d 00b4
+;    +                                        =    
+       0071 0071 0065 0072 0074 007a 0075 0069 006f 0070 00fa 0029 00a8
+       q    w    e    r    t    z    u    i    o    p        )    
+         0061 0073 0064 0066 0067 0068 006a 006b 006c 016f 00a7
+         a    s    d    f    g    h    j    k    l        
+           0079 0078 0063 0076 0062 006e 006d 002c 002e 002d
+           y    x    c    v    b    n    m    ,    .    -
+
+shift
+00b0 0031 0032 0033 0034 0035 0036 0037 0038 0039 0030 0025 02c7
+    1    2    3    4    5    6    7    8    9    0    %    
+       0051 0057 0045 0052 0054 005a 0055 0049 004f 0050 002f 0028 0027
+       Q    W    E    R    T    Z    U    I    O    P    /    (    '
+         0041 0053 0044 0046 0047 0048 004a 004b 004c 0022 0021
+         A    S    D    F    G    H    J    K    L    "    !
+           0059 0058 0043 0056 0042 004e 004d 003f 003a 005f
+           Y    X    C    V    B    N    M    ?    :    _
+
+altgr
+     007e 02c7 005e 02d8 00b0 02db 0060 00b7 00b4 02dd 00a8 00b8
+     ~        ^                `                    
+       005c 007c 20ac                                    00f7 00d7 00a4
+       \    |                                                   
+         0111 0110 005b 005d           0142 0141 0024 00df
+                 [    ]                      $    
+           0023 0026 0040 007b 007d      003c 003e 002a
+           #    &    @    {    }         <    >    *
diff --git a/xrdp/funcs.c b/xrdp/funcs.c
index 191ee3b..e2ebdb6 100644
--- a/xrdp/funcs.c
+++ b/xrdp/funcs.c
@@ -14,7 +14,7 @@
    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
 
    xrdp: A Remote Desktop Protocol server.
-   Copyright (C) Jay Sorg 2004-2007
+   Copyright (C) Jay Sorg 2004-2008
 
    simple functions
 
@@ -147,24 +147,31 @@ check_bounds(struct xrdp_bitmap* b, int* x, int* y, int* cx, int* cy)
 /* add a ch at index position in text, index starts at 0 */
 /* if index = -1 add it to the end */
 int APP_CC
-add_char_at(char* text, char ch, int index)
+add_char_at(char* text, int text_size, twchar ch, int index)
 {
   int len;
   int i;
+  twchar* wstr;
 
-  len = g_strlen(text);
-  if (index >= len || index < 0)
+  len = g_mbstowcs(0, text, 0);
+  wstr = (twchar*)g_malloc((len + 16) * sizeof(twchar), 0);
+  g_mbstowcs(wstr, text, len + 1);
+  if ((index >= len) || (index < 0))
   {
-    text[len] = ch;
-    text[len + 1] = 0;
+    wstr[len] = ch;
+    wstr[len + 1] = 0;
+    g_wcstombs(text, wstr, text_size);
+    g_free(wstr);
     return 0;
   }
-  for (i = len - 1; i >= index; i--)
+  for (i = (len - 1); i >= index; i--)
   {
-    text[i + 1] = text[i];
+    wstr[i + 1] = wstr[i];
   }
-  text[i + 1] = ch;
-  text[len + 1] = 0;
+  wstr[i + 1] = ch;
+  wstr[len + 1] = 0;
+  g_wcstombs(text, wstr, text_size);
+  g_free(wstr);
   return 0;
 }
 
@@ -172,26 +179,33 @@ add_char_at(char* text, char ch, int index)
 /* remove a ch at index position in text, index starts at 0 */
 /* if index = -1 remove it from the end */
 int APP_CC
-remove_char_at(char* text, int index)
+remove_char_at(char* text, int text_size, int index)
 {
   int len;
   int i;
+  twchar* wstr;
 
-  len = g_strlen(text);
+  len = g_mbstowcs(0, text, 0);
   if (len <= 0)
   {
     return 0;
   }
-  if (index >= len - 1 || index < 0)
+  wstr = (twchar*)g_malloc((len + 16) * sizeof(twchar), 0);
+  g_mbstowcs(wstr, text, len + 1);
+  if ((index >= (len - 1)) || (index < 0))
   {
-    text[len - 1] = 0;
+    wstr[len - 1] = 0;
+    g_wcstombs(text, wstr, text_size);
+    g_free(wstr);
     return 0;
   }
-  for (i = index; i < len - 1; i++)
+  for (i = index; i < (len - 1); i++)
   {
-    text[i] = text[i + 1];
+    wstr[i] = wstr[i + 1];
   }
-  text[len - 1] = 0;
+  wstr[len - 1] = 0;
+  g_wcstombs(text, wstr, text_size);
+  g_free(wstr);
   return 0;
 }
 
@@ -207,3 +221,20 @@ set_string(char** in_str, const char* in)
   *in_str = g_strdup(in);
   return 0;
 }
+
+/*****************************************************************************/
+int APP_CC
+wchar_repeat(twchar* dest, int dest_size_in_wchars, twchar ch, int repeat)
+{
+  int index;
+
+  for (index = 0; index < repeat; index++)
+  {
+    if (index >= dest_size_in_wchars)
+    {
+      break;
+    }
+    dest[index] = ch;
+  }
+  return 0;
+}
diff --git a/xrdp/lang.c b/xrdp/lang.c
index 6bd2e94..6da4a3a 100644
--- a/xrdp/lang.c
+++ b/xrdp/lang.c
@@ -14,533 +14,983 @@
    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
 
    xrdp: A Remote Desktop Protocol server.
-   Copyright (C) Jay Sorg 2006-2007
+   Copyright (C) Jay Sorg 2006-2008
 
    keylayout
+   maximum unicode 19996(0x4e00)
 
 */
 
 #include "xrdp.h"
 
 /*****************************************************************************/
-/* us english */
+/* us english 0x409 */
 
 /* non shift chars */
-char en_us_noshift[] =
-{
-  0,    0,   '1',  '2',  '3',  '4',  '5',  '6',
- '7',  '8',  '9',  '0',  '-',  '=',   0,    0,
- 'q',  'w',  'e',  'r',  't',  'y',  'u',  'i',
- 'o',  'p',  '[',  ']',   0,    0,   'a',  's',
- 'd',  'f',  'g',  'h',  'j',  'k',  'l',  ';',
- '\'', '`',   0,   '\\', 'z',  'x',  'c',  'v',
- 'b',  'n',  'm',  ',',  '.',  '/',   0,   '*',
-  0,   ' ',   0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,   '7',
- '8',  '9',  '-',  '4',  '5',  '6',  '+',  '1',
- '2',  '3',  '0',  '.',   0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0
+int en_us_noshift[] =
+{
+      0,      0,    '1',    '2',    '3',    '4',    '5',    '6',
+    '7',    '8',    '9',    '0',    '-',    '=',      0,      0,
+    'q',    'w',    'e',    'r',    't',    'y',    'u',    'i',
+    'o',    'p',    '[',    ']',      0,      0,    'a',    's',
+    'd',    'f',    'g',    'h',    'j',    'k',    'l',    ';',
+   '\'',    '`',      0,   '\\',    'z',    'x',    'c',    'v',
+    'b',    'n',    'm',    ',',    '.',    '/',      0,    '*',
+      0,    ' ',      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,    '7',
+    '8',    '9',    '-',    '4',    '5',    '6',    '+',    '1',
+    '2',    '3',    '0',    '.',      0,      0,   '\\',      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0
 };
 
 /* shift chars */
-char en_us_shift[] =
-{
-  0,    0,   '!',  '@',  '#',  '$',  '%',  '^',
- '&',  '*',  '(',  ')',  '_',  '+',   0,    0,
- 'Q',  'W',  'E',  'R',  'T',  'Y',  'U',  'I',
- 'O',  'P',  '{',  '}',   0,    0,   'A',  'S',
- 'D',  'F',  'G',  'H',  'J',  'K',  'L',  ':',
- '"',  '~',   0,   '|',  'Z',  'X',  'C',  'V',
- 'B',  'N',  'M',  '<',  '>',  '?',   0,   '*',
-  0,   ' ',   0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,   '7',
- '8',  '9',  '-',  '4',  '5',  '6',  '+',  '1',
- '2',  '3',  '0',  '.',   0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0
+int en_us_shift[] =
+{
+      0,      0,    '!',    '@',    '#',    '$',    '%',    '^',
+    '&',    '*',    '(',    ')',    '_',    '+',      0,      0,
+    'Q',    'W',    'E',    'R',    'T',    'Y',    'U',    'I',
+    'O',    'P',    '{',    '}',      0,      0,    'A',    'S',
+    'D',    'F',    'G',    'H',    'J',    'K',    'L',    ':',
+    '"',    '~',      0,    '|',    'Z',    'X',    'C',    'V',
+    'B',    'N',    'M',    '<',    '>',    '?',      0,    '*',
+      0,    ' ',      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,    '7',
+    '8',    '9',    '-',    '4',    '5',    '6',    '+',    '1',
+    '2',    '3',    '0',    '.',      0,      0,    '|',      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0
 };
 
 /* right alt chars */
-char en_us_altgr[] =
-{
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0
+int en_us_altgr[] =
+{
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0
+};
+
+/* caps lock chars */
+int en_us_capslock[] =
+{
+      0,      0,    '1',    '2',    '3',    '4',    '5',    '6',
+    '7',    '8',    '9',    '0',    '-',    '=',      0,      0,
+    'Q',    'W',    'E',    'R',    'T',    'Y',    'U',    'I',
+    'O',    'P',    '[',    ']',      0,      0,    'A',    'S',
+    'D',    'F',    'G',    'H',    'J',    'K',    'L',    ';',
+   '\'',    '`',      0,   '\\',    'Z',    'X',    'C',    'V',
+    'B',    'N',    'M',    ',',    '.',    '/',      0,    '*',
+      0,    ' ',      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,    '7',
+    '8',    '9',    '-',    '4',    '5',    '6',    '+',    '1',
+    '2',    '3',    '0',    '.',      0,      0,   '\\',      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0
+};
+
+/* shift caps lock chars */
+int en_us_shiftcapslock[] =
+{
+      0,      0,    '!',    '@',    '#',    '$',    '%',    '^',
+    '&',    '*',    '(',    ')',    '_',    '+',      0,      0,
+    'q',    'w',    'e',    'r',    't',    'y',    'u',    'i',
+    'o',    'p',    '{',    '}',      0,      0,    'a',    's',
+    'd',    'f',    'g',    'h',    'j',    'k',    'l',    ':',
+    '"',    '~',      0,    '|',    'z',    'x',    'c',    'v',
+    'b',    'n',    'm',    '<',    '>',    '?',      0,    '*',
+      0,    ' ',      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,    '7',
+    '8',    '9',    '-',    '4',    '5',    '6',    '+',    '1',
+    '2',    '3',    '0',    '.',      0,      0,    '|',      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0
 };
 
 /*****************************************************************************/
-/* italy */
-
-/* non shift chars ec*/
-char it_noshift[] =
-{
-  0,    0,   '1',  '2',  '3',  '4',  '5',  '6',
- '7',  '8',  '9',  '0',  '\'', 0xec,  0,    0,
- 'q',  'w',  'e',  'r',  't',  'y',  'u',  'i',
- 'o',  'p',  0xe8, '+',   0,    0,   'a',  's',
- 'd',  'f',  'g',  'h',  'j',  'k',  'l',  0xf2,
- 0xe0, '\\',  0,   0xf9, 'z',  'x',  'c',  'v',
- 'b',  'n',  'm',  ',',  '.',  '-',   0,   '*',
-  0,   ' ',   0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,   '7',
- '8',  '9',  '-',  '4',  '5',  '6',  '+',  '1',
- '2',  '3',  '0',  '.',   0,    0,    '<',  0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0
+/* italy 0x410 */
+
+/* non shift chars */
+int it_noshift[] =
+{
+      0,      0,    '1',    '2',    '3',    '4',    '5',    '6',
+    '7',    '8',    '9',    '0',   '\'',   0xec,      0,      0,
+    'q',    'w',    'e',    'r',    't',    'y',    'u',    'i',
+    'o',    'p',   0xe8,    '+',      0,      0,    'a',    's',
+    'd',    'f',    'g',    'h',    'j',    'k',    'l',   0xf2,
+   0xe0,   '\\',      0,   0xf9,    'z',    'x',    'c',    'v',
+    'b',    'n',    'm',    ',',    '.',    '-',      0,    '*',
+      0,    ' ',      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,    '7',
+    '8',    '9',    '-',    '4',    '5',    '6',    '+',    '1',
+    '2',    '3',    '0',    '.',      0,      0,    '<',      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0
 };
 
 /* shift chars */
-char it_shift[] =
-{
-  0,    0,   '!',  '"',  0xa3, '$',  '%',  '&',
- '/',  '(',  ')',  '=',  '?',  '^',   0,    0,
- 'Q',  'W',  'E',  'R',  'T',  'Y',  'U',  'I',
- 'O',  'P',  0xe9, '*',   0,    0,   'A',  'S',
- 'D',  'F',  'G',  'H',  'J',  'K',  'L',  0xe7,
- 0xb0, '|',   0,   0xa7, 'Z',  'X',  'C',  'V',
- 'B',  'N',  'M',  ';',  ':',  '_',   0,   '*',
-  0,   ' ',   0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,   '7',
- '8',  '9',  '-',  '4',  '5',  '6',  '+',  '1',
- '2',  '3',  '0',  '.',   0,    0,    '>',    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0
+int it_shift[] =
+{
+      0,      0,    '!',    '"',   0xa3,    '$',    '%',    '&',
+    '/',    '(',    ')',    '=',    '?',    '^',      0,      0,
+    'Q',    'W',    'E',    'R',    'T',    'Y',    'U',    'I',
+    'O',    'P',   0xe9,    '*',      0,      0,    'A',    'S',
+    'D',    'F',    'G',    'H',    'J',    'K',    'L',   0xe7,
+   0xb0,    '|',      0,   0xa7,    'Z',    'X',    'C',    'V',
+    'B',    'N',    'M',    ';',    ':',    '_',      0,    '*',
+      0,    ' ',      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,    '7',
+    '8',    '9',    '-',    '4',    '5',    '6',    '+',    '1',
+    '2',    '3',    '0',    '.',      0,      0,    '>',      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0
 };
 
 /* right alt chars */
-char it_altgr[] =
-{
-  0,    0,    0,    0,    0,    0,   0x80,  0,
-  '{',  0,    0,    '}',  0,    0,    0,    0,
-  0,    0,   0x80,  0,    0,    0,    0,    0,
-  0,    0,   '[',  ']',   0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,   '@',
- '#',   0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0
+int it_altgr[] =
+{
+      0,      0,      0,      0,      0,      0, 0x20ac,      0,
+    '{',      0,      0,    '}',   0x60,    '~',      0,      0,
+      0,      0, 0x20ac,      0,      0,      0,      0,      0,
+      0,      0,    '[',    ']',      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,    '@',
+     '#',     0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0
+};
+
+int it_capslock[] =
+{
+      0,      0,    '1',    '2',    '3',    '4',    '5',    '6',
+    '7',    '8',    '9',    '0',   '\'',   0xec,      0,      0,
+    'Q',    'W',    'E',    'R',    'T',    'Y',    'U',    'I',
+    'O',    'P',   0xe8,    '+',      0,      0,    'A',    'S',
+    'D',    'F',    'G',    'H',    'J',    'K',    'L',   0xf2,
+   0xe0,   '\\',      0,   0xf9,    'Z',    'X',    'C',    'V',
+    'B',    'N',    'M',    ',',    '.',    '-',      0,    '*',
+      0,    ' ',      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,    '7',
+    '8',    '9',    '-',    '4',    '5',    '6',    '+',    '1',
+    '2',    '3',    '0',    '.',      0,      0,    '<',      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0
+};
+
+int it_shiftcapslock[] =
+{
+      0,      0,    '!',    '"',   0xa3,    '$',    '%',    '&',
+    '/',    '(',    ')',    '=',    '?',    '^',      0,      0,
+    'q',    'w',    'e',    'r',    't',    'y',    'u',    'i',
+    'o',    'p',   0xe9,    '*',      0,      0,    'a',    's',
+    'd',    'f',    'g',    'h',    'j',    'k',    'l',   0xe7,
+   0xb0,    '|',      0,   0xa7,    'z',    'x',    'c',    'v',
+    'b',    'n',    'm',    ';',    ':',    '_',      0,    '*',
+      0,    ' ',      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,    '7',
+    '8',    '9',    '-',    '4',    '5',    '6',    '+',    '1',
+    '2',    '3',    '0',    '.',      0,      0,    '>',      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0
 };
 
 /*****************************************************************************/
-/* Portuguese (Brazil) */
+/* Portuguese (Brazil) 0x416 */
 
 /* non shift chars */
-char pt_br_noshift[] =
-{
-  0,    0,   '1',  '2',  '3',  '4',  '5',  '6',
- '7',  '8',  '9',  '0',  '-',  '=',   0,    0,
- 'q',  'w',  'e',  'r',  't',  'y',  'u',  'i',
- 'o',  'p',  0xb4, '[',   0,    0,   'a',  's',
- 'd',  'f',  'g',  'h',  'j',  'k',  'l',  0xe7,
- '~',  '`',   0,   ']',  'z',  'x',  'c',  'v',
- 'b',  'n',  'm',  ',',  '.',  ';',   0,   '*',
-  0,   ' ',   0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,   '7',
- '8',  '9',  '-',  '4',  '5',  '6',  '+',  '1',
- '2',  '3',  '0',  '.',   0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0
+int pt_br_noshift[] =
+{
+      0,      0,    '1',    '2',    '3',    '4',    '5',    '6',
+    '7',    '8',    '9',    '0',    '-',    '=',      0,      0,
+    'q',    'w',    'e',    'r',    't',    'y',    'u',    'i',
+    'o',    'p',   0xb4,    '[',      0,      0,    'a',    's',
+    'd',    'f',    'g',    'h',    'j',    'k',    'l',   0xe7,
+    '~',    '`',      0,    ']',    'z',    'x',    'c',    'v',
+    'b',    'n',    'm',    ',',    '.',    ';',      0,    '*',
+      0,    ' ',      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,    '7',
+    '8',    '9',    '-',    '4',    '5',    '6',    '+',    '1',
+    '2',    '3',    '0',    '.',      0,      0,   '\\',      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0
 };
 
 /* shift chars */
-char pt_br_shift[] =
-{
-  0,    0,   '!',  '@',  '#',  '$',  '%',  0xa8,
- '&',  '*',  '(',  ')',  '_',  '+',   0,    0,
- 'Q',  'W',  'E',  'R',  'T',  'Y',  'U',  'I',
- 'O',  'P',  '`',  '{',   0,    0,   'A',  'S',
- 'D',  'F',  'G',  'H',  'J',  'K',  'L',  0xc7,
- '^',  '"',   0,   '}',  'Z',  'X',  'C',  'V',
- 'B',  'N',  'M',  '<',  '>',  ':',   0,   '*',
-  0,   ' ',   0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,   '7',
- '8',  '9',  '-',  '4',  '5',  '6',  '+',  '1',
- '2',  '3',  '0',  '.',   0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0
+int pt_br_shift[] =
+{
+      0,      0,    '!',    '@',    '#',    '$',    '%',   0xa8,
+    '&',    '*',    '(',    ')',    '_',    '+',      0,      0,
+    'Q',    'W',    'E',    'R',    'T',    'Y',    'U',    'I',
+    'O',    'P',    '`',    '{',      0,      0,    'A',    'S',
+    'D',    'F',    'G',    'H',    'J',    'K',    'L',   0xc7,
+    '^',    '"',      0,    '}',    'Z',    'X',    'C',    'V',
+    'B',    'N',    'M',    '<',    '>',    ':',      0,    '*',
+      0,    ' ',      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,    '7',
+    '8',    '9',    '-',    '4',    '5',    '6',    '+',    '1',
+    '2',    '3',    '0',    '.',      0,      0,    '|',      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0
 };
 
 /* right alt chars */
-char pt_br_altgr[] =
-{
-  0,    0,   0xb9, 0xb2, 0xb3, 0xa3, 0xa2, 0xac,
-  0,    0,    0,    0,    0,   0xa7,  0,    0,
- '/',  '?',  0xb0,  0,    0,    0,    0,    0,
-  0,    0,    0,   0xaa,  0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,   0xba,  0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0
+int pt_br_altgr[] =
+{
+      0,      0,   0xb9,   0xb2,   0xb3, 0xa3, 0xa2, 0xac,
+      0,      0,      0,      0,      0,   0xa7,      0,      0,
+    '/',    '?',   0xb0,      0,      0,      0,      0,      0,
+      0,      0,      0,   0xaa,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,   0xba,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0
+};
+
+int pt_br_capslock[] =
+{
+      0,      0,    '1',    '2',    '3',    '4',    '5',    '6',
+    '7',    '8',    '9',    '0',    '-',    '=',      0,      0,
+    'Q',    'W',    'E',    'R',    'T',    'Y',    'U',    'I',
+    'O',    'P',    0xb4,    '[',      0,      0,    'A',    'S',
+    'D',    'F',    'G',    'H',    'J',    'K',    'L',   0xc7,
+    '~',    '`',      0,    ']',    'Z',    'X',    'C',    'V',
+    'B',    'N',    'M',    ',',    '.',    ';',      0,    '*',
+      0,    ' ',      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,    '7',
+    '8',    '9',    '-',    '4',    '5',    '6',    '+',    '1',
+    '2',    '3',    '0',    '.',      0,      0,   '\\',      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0
+};
+
+int pt_br_shiftcapslock[] =
+{
+      0,      0,    '!',    '@',    '#',    '$',    '%',   0xa8,
+    '&',    '*',    '(',    ')',    '_',    '+',      0,      0,
+    'q',    'w',    'e',    'r',    't',    'y',    'u',    'i',
+    'o',    'p',    '`',    '{',      0,      0,    'a',    's',
+    'd',    'f',    'g',    'h',    'j',    'k',    'l',   0xe7,
+    '^',    '"',      0,    '}',    'z',    'x',    'c',    'v',
+    'b',    'n',    'm',    '<',    '>',    ':',      0,    '*',
+      0,    ' ',      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,    '7',
+    '8',    '9',    '-',    '4',    '5',    '6',    '+',    '1',
+    '2',    '3',    '0',    '.',      0,      0,    '|',      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0
 };
 
 /*****************************************************************************/
-/* uk english */
+/* uk english 0x809 */
 
 /* non shift chars */
-char en_uk_noshift[] =
-{
-  0,    0,   '1',  '2',  '3',  '4',  '5',  '6',
- '7',  '8',  '9',  '0',  '-',  '=',   0,    0,
- 'q',  'w',  'e',  'r',  't',  'y',  'u',  'i',
- 'o',  'p',  '[',  ']',   0,    0,   'a',  's',
- 'd',  'f',  'g',  'h',  'j',  'k',  'l',  ';',
- '\'', '`',   0,   '#',  'z',  'x',  'c',  'v',
- 'b',  'n',  'm',  ',',  '.',  '/',   0,   '*',
-  0,   ' ',   0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,   '7',
- '8',  '9',  '-',  '4',  '5',  '6',  '+',  '1',
- '2',  '3',  '0',  '.',   0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0
+int en_uk_noshift[] =
+{
+      0,      0,    '1',    '2',    '3',    '4',    '5',    '6',
+    '7',    '8',    '9',    '0',    '-',    '=',      0,      0,
+    'q',    'w',    'e',    'r',    't',    'y',    'u',    'i',
+    'o',    'p',    '[',    ']',      0,      0,    'a',    's',
+    'd',    'f',    'g',    'h',    'j',    'k',    'l',    ';',
+   '\'',    '`',      0,    '#',    'z',    'x',    'c',    'v',
+    'b',    'n',    'm',    ',',    '.',    '/',      0,    '*',
+      0,    ' ',      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,    '7',
+    '8',    '9',    '-',    '4',    '5',    '6',    '+',    '1',
+    '2',    '3',    '0',    '.',      0,      0,   '\\',      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0
 };
 
 /* shift chars */
-char en_uk_shift[] =
-{
-  0,    0,   '!',  '"',  0xa3, '$',  '%',  '^',
- '&',  '*',  '(',  ')',  '_',  '+',   0,    0,
- 'Q',  'W',  'E',  'R',  'T',  'Y',  'U',  'I',
- 'O',  'P',  '{',  '}',   0,    0,   'A',  'S',
- 'D',  'F',  'G',  'H',  'J',  'K',  'L',  ':',
- '@',  0xac,  0,   '~',  'Z',  'X',  'C',  'V',
- 'B',  'N',  'M',  '<',  '>',  '?',   0,   '*',
-  0,   ' ',   0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,   '7',
- '8',  '9',  '-',  '4',  '5',  '6',  '+',  '1',
- '2',  '3',  '0',  '.',   0,    0,   0xa6,  0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0
+int en_uk_shift[] =
+{
+      0,      0,    '!',    '"',   0xa3,    '$',    '%',    '^',
+    '&',    '*',    '(',    ')',    '_',    '+',      0,      0,
+    'Q',    'W',    'E',    'R',    'T',    'Y',    'U',    'I',
+    'O',    'P',    '{',    '}',      0,      0,    'A',    'S',
+    'D',    'F',    'G',    'H',    'J',    'K',    'L',    ':',
+    '@',   0xac,      0,    '~',    'Z',    'X',    'C',    'V',
+    'B',    'N',    'M',    '<',    '>',    '?',      0,    '*',
+      0,    ' ',      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,    '7',
+    '8',    '9',    '-',    '4',    '5',    '6',    '+',    '1',
+    '2',    '3',    '0',    '.',      0,      0,    '|',      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0
 };
 
 /* right alt chars */
-char en_uk_altgr[] =
-{
-  0,    0,    0,    0,    0,   0x80,  0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,   0xe9,  0,    0,    0,   0xfa, 0xed,
- 0xf3,  0,    0,    0,    0,    0,   0xe1,  0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,   0xa6,  0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,   0xa6,  0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0
+int en_uk_altgr[] =
+{
+      0,      0,      0,      0,      0, 0x20ac,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,   0xe9,      0,      0,      0,   0xfa,   0xed,
+   0xf3,      0,      0,      0,      0,      0,   0xe1,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,   0xa6,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,   0xa6,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0
+};
+
+int en_uk_capslock[] =
+{
+      0,      0,    '1',    '2',    '3',    '4',    '5',    '6',
+    '7',    '8',    '9',    '0',    '-',    '=',      0,      0,
+    'Q',    'W',    'E',    'R',    'T',    'Y',    'U',    'I',
+    'O',    'P',    '[',    ']',      0,      0,    'A',    'S',
+    'D',    'F',    'G',    'H',    'J',    'K',    'L',    ';',
+   '\'',   0xac,      0,    '#',    'Z',    'X',    'C',    'V',
+    'B',    'N',    'M',    ',',    '.',    '/',      0,    '*',
+      0,    ' ',      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,    '7',
+    '8',    '9',    '-',    '4',    '5',    '6',    '+',    '1',
+    '2',    '3',    '0',    '.',      0,      0,   '\\',      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0
+};
+
+int en_uk_shiftcapslock[] =
+{
+      0,      0,    '!',    '"',   0xa3,    '$',    '%',    '^',
+    '&',    '*',    '(',    ')',    '_',    '+',      0,      0,
+    'q',    'w',    'e',    'r',    't',    'y',    'u',    'i',
+    'o',    'p',    '{',    '}',      0,      0,    'a',    's',
+    'd',    'f',    'g',    'h',    'j',    'k',    'l',    ':',
+    '@',    '`',      0,    '~',    'z',    'x',    'c',    'v',
+    'b',    'n',    'm',    '<',    '>',    '?',      0,    '*',
+      0,    ' ',      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,    '7',
+    '8',    '9',    '-',    '4',    '5',    '6',    '+',    '1',
+    '2',    '3',    '0',    '.',      0,      0,    '|',      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0
 };
 
 /*****************************************************************************/
-/* german */
+/* german 0x407 */
 
 /* non shift chars */
-char de_noshift[] =
-{
-  0,    0,   '1',  '2',  '3',  '4',  '5',  '6',
- '7',  '8',  '9',  '0',  0xdf, 0xb4,  0,    0,
- 'q',  'w',  'e',  'r',  't',  'z',  'u',  'i',
- 'o',  'p',  0xfc, '+',   0,    0,   'a',  's',
- 'd',  'f',  'g',  'h',  'j',  'k',  'l',  0xf6,
- 0xe4, '^',   0,   '#',  'y',  'x',  'c',  'v',
- 'b',  'n',  'm',  ',',  '.',  '-',   0,   '*',
-  0,   ' ',   0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,   '7',
- '8',  '9',  '-',  '4',  '5',  '6',  '+',  '1',
- '2',  '3',  '0',  '.',   0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0
+int de_noshift[] =
+{
+      0,      0,    '1',    '2',    '3',    '4',    '5',    '6',
+    '7',    '8',    '9',    '0',   0xdf,   0xb4,      0,      0,
+    'q',    'w',    'e',    'r',    't',    'z',    'u',    'i',
+    'o',    'p',   0xfc,    '+',      0,      0,    'a',    's',
+    'd',    'f',    'g',    'h',    'j',    'k',    'l',   0xf6,
+   0xe4,    '^',      0,    '#',    'y',    'x',    'c',    'v',
+    'b',    'n',    'm',    ',',    '.',    '-',      0,    '*',
+      0,    ' ',      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,    '7',
+    '8',    '9',    '-',    '4',    '5',    '6',    '+',    '1',
+    '2',    '3',    '0',    '.',      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0
 };
 
 /* shift chars */
-char de_shift[] =
-{
-  0,    0,   '!',  '"',  0xa7, '$',  '%',  '&',
- '/',  '(',  ')',  '=',  '?',  '`',   0,    0,
- 'Q',  'W',  'E',  'R',  'T',  'Z',  'U',  'I',
- 'O',  'P',  0xdc, '*',   0,    0,   'A',  'S',
- 'D',  'F',  'G',  'H',  'J',  'K',  'L',  0xd6,
- 0xc4, 0xb0,  0,   '\'', 'Y',  'X',  'C',  'V',
- 'B',  'N',  'M',  ';',  ':',  '_',   0,   '*',
-  0,   ' ',   0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,   '7',
- '8',  '9',  '-',  '4',  '5',  '6',  '+',  '1',
- '2',  '3',  '0',  '.',   0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0
+int de_shift[] =
+{
+      0,      0,    '!',    '"',   0xa7,    '$',    '%',    '&',
+    '/',    '(',    ')',    '=',    '?',    '`',      0,      0,
+    'Q',    'W',    'E',    'R',    'T',    'Z',    'U',    'I',
+    'O',    'P',   0xdc,    '*',      0,      0,    'A',    'S',
+    'D',    'F',    'G',    'H',    'J',    'K',    'L',   0xd6,
+   0xc4,   0xb0,      0,   '\'',    'Y',    'X',    'C',    'V',
+    'B',    'N',    'M',    ';',    ':',    '_',      0,    '*',
+      0,    ' ',      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,    '7',
+    '8',    '9',    '-',    '4',    '5',    '6',    '+',    '1',
+    '2',    '3',    '0',    '.',      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0
 };
 
 /* right alt chars */
-char de_altgr[] =
-{
-  0,    0,    0,   0xb2, 0xb3,  0,    0,    0,
- '{',  '[',  ']',  '}',  '\\',  0,    0,    0,
- '@',   0,   0x80,  0,    0,    0,    0,    0,
-  0,    0,    0,   '~',   0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,   0xb5,  0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0
+int de_altgr[] =
+{
+      0,      0,      0,   0xb2,   0xb3,      0,      0,      0,
+    '{',    '[',    ']',    '}',   '\\',      0,      0,      0,
+    '@',      0, 0x20ac,      0,      0,      0,      0,      0,
+      0,      0,      0,    '~',      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,   0xb5,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0
+};
+
+int de_capslock[] =
+{
+      0,      0,    '!',    '"',   0xa7,    '$',    '%',    '&',
+    '/',    '(',    ')',    '=',    '?',    '`',     0,      0,
+    'Q',    'W',    'E',    'R',    'T',    'Z',    'U',    'I',
+    'O',    'P',   0xdc,    '*',      0,      0,    'A',    'S',
+    'D',    'F',    'G',    'H',    'J',    'K',    'L',   0xd6,
+   0xc4,   0xb0,      0,   '\'',    'Y',    'X',    'C',    'V',
+    'B',    'N',    'M',    ';',    ':',    '_',      0,    '*',
+      0,    ' ',      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,    '7',
+    '8',    '9',    '-',    '4',    '5',    '6',    '+',    '1',
+    '2',    '3',    '0',    '.',      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0
+};
+
+int de_shiftcapslock[] =
+{
+      0,      0,    '1',    '2',    '3',    '4',    '5',    '6',
+    '7',    '8',    '9',    '0',   0xdf,   0xb4,      0,      0,
+    'q',    'w',    'e',    'r',    't',    'z',    'u',    'i',
+    'o',    'p',   0xfc,    '+',      0,      0,    'a',    's',
+    'd',    'f',    'g',    'h',    'j',    'k',    'l',   0xf6,
+   0xe4,    '^',      0,    '#',    'y',    'x',    'c',    'v',
+    'b',    'n',    'm',    ',',    '.',    '-',      0,    '*',
+      0,    ' ',      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,    '7',
+    '8',    '9',    '-',    '4',    '5',    '6',    '+',    '1',
+    '2',    '3',    '0',    '.',      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0
 };
 
 /*****************************************************************************/
-/* french */
+/* french 0x40c */
 
 /* non shift chars */
-char fr_noshift[] =
-{
-  0,    0,   '&',  0xe9, '"',  '\'', '(',  '-',
- 0xe8, '_',  0xe7, 0xe0, ')',  '=',   0,    0,
- 'a',  'z',  'e',  'r',  't',  'y',  'u',  'i',
- 'o',  'p',  '^',  '$',   0,    0,   'q',  's',
- 'd',  'f',  'g',  'h',  'j',  'k',  'l',  'm',
- 0xf9, 0xb2,  0,   '*',  'w',  'x',  'c',  'v',
- 'b',  'n',  ',',  ';',  ':',  '!',   0,   '*',
-  0,   ' ',   0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,   '7',
- '8',  '9',  '-',  '4',  '5',  '6',  '+',  '1',
- '2',  '3',  '0',  '.',   0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0
+int fr_noshift[] =
+{
+      0,      0,    '&',   0xe9,    '"',   '\'',    '(',    '-',
+   0xe8,    '_',   0xe7,   0xe0,    ')',    '=',      0,      0,
+    'a',    'z',    'e',    'r',    't',    'y',    'u',    'i',
+    'o',    'p',    '^',    '$',      0,      0,    'q',    's',
+    'd',    'f',    'g',    'h',    'j',    'k',    'l',    'm',
+   0xf9,   0xb2,      0,    '*',    'w',    'x',    'c',    'v',
+    'b',    'n',    ',',    ';',    ':',    '!',      0,    '*',
+      0,    ' ',      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,    '7',
+    '8',    '9',    '-',    '4',    '5',    '6',    '+',    '1',
+    '2',    '3',    '0',    '.',      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0
 };
 
 /* shift chars */
-char fr_shift[] =
-{
-  0,    0,   '1',  '2',  '3',  '4',  '5',  '6',
- '7',  '8',  '9',  '0',  0xb0, '+',   0,    0,
- 'A',  'Z',  'E',  'R',  'T',  'Y',  'U',  'I',
- 'O',  'P',  0xa8, 0xa3,  0,    0,   'Q',  'S',
- 'D',  'F',  'G',  'H',  'J',  'K',  'L',  'M',
- '%',  '~',   0,   0xb5, 'W',  'X',  'C',  'V',
- 'B',  'N',  '?',  '.',  '/',  0xa7,  0,   '*',
-  0,   ' ',   0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,   '7',
- '8',  '9',  '-',  '4',  '5',  '6',  '+',  '1',
- '2',  '3',  '0',  '.',   0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0
+int fr_shift[] =
+{
+      0,      0,    '1',    '2',    '3',    '4',    '5',    '6',
+    '7',    '8',    '9',    '0',   0xb0,    '+',      0,      0,
+    'A',    'Z',    'E',    'R',    'T',    'Y',    'U',    'I',
+    'O',    'P',   0xa8,   0xa3,      0,      0,    'Q',    'S',
+    'D',    'F',    'G',    'H',    'J',    'K',    'L',    'M',
+    '%',    '~',      0,   0xb5,    'W',    'X',    'C',    'V',
+    'B',    'N',    '?',    '.',    '/',   0xa7,      0,    '*',
+      0,    ' ',      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,    '7',
+    '8',    '9',    '-',    '4',    '5',    '6',    '+',    '1',
+    '2',    '3',    '0',    '.',      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0
 };
 
 /* right alt chars */
-char fr_altgr[] =
-{
-  0,    0,    0,   '~',  '#',  '{',  '[',  '|',
- '`',  '\\', '^',  '@',  ']',  '}',   0,    0,
-  0,    0,   0x80,  0,    0,    0,    0,    0,
-  0,    0,    0,   0xa4,  0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0
+int fr_altgr[] =
+{
+      0,      0,      0,    '~',    '#',    '{',    '[',    '|',
+    '`',   '\\',    '^',    '@',    ']',    '}',      0,      0,
+      0,      0, 0x20ac,      0,      0,      0,      0,      0,
+      0,      0,      0,   0xa4,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0
+};
+
+int fr_capslock[] =
+{
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0
+};
+
+int fr_shiftcapslock[] =
+{
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0
 };
 
 /*****************************************************************************/
-/* swedish */
+/* swedish 0x41d */
 
 /* non shift chars */
-char se_noshift[] =
-{
-  0,    0,   '1',  '2',  '3',  '4',  '5',  '6',
- '7',  '8',  '9',  '0',  '+',  0xb4,  0,    0,
- 'q',  'w',  'e',  'r',  't',  'y',  'u',  'i',
- 'o',  'p',  0xe5, 0x22,  0,    0,   'a',  's',
- 'd',  'f',  'g',  'h',  'j',  'k',  'l',  0xf6,
- 0xe4, 0xa7,  0,  '\'',  'z',  'x',  'c',  'v',
- 'b',  'n',  'm',  ',',  '.',  '-',   0,   '*',
-  0,   ' ',   0,    0,    0,    0,    0,    0,
-  0 ,   0,    0,    0,    0,    0,    0,   '7',
- '8',  '9',  '-',  '4',  '5',  '6',  '+',  '1',
- '2',  '3',  '0',  '.',   0,    0,   '<',   0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0
+int se_noshift[] =
+{
+      0,      0,    '1',    '2',    '3',    '4',    '5',    '6',
+    '7',    '8',    '9',    '0',    '+',   0xb4,      0,      0,
+    'q',    'w',    'e',    'r',    't',    'y',    'u',    'i',
+    'o',    'p',   0xe5,   0x22,      0,      0,    'a',    's',
+    'd',    'f',    'g',    'h',    'j',    'k',    'l',   0xf6,
+   0xe4,   0xa7,      0,   '\'',    'z',    'x',    'c',    'v',
+    'b',    'n',    'm',    ',',    '.',    '-',      0,    '*',
+      0,    ' ',      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,    '7',
+    '8',    '9',    '-',    '4',    '5',    '6',    '+',    '1',
+    '2',    '3',    '0',    '.',      0,      0,    '<',      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0
 };
 
 /* shift chars */
-char se_shift[] =
-{
-  0,    0,   '!',  '"',  '#',  0xa4, '%',  '&',
- '/',  '(',  ')',  '=',  '?',  '`',   0,    0,
- 'Q',  'W',  'E',  'R',  'T',  'Y',  'U',  'I',
- 'O',  'P',  0xc5, 0x5e,  0,    0,   'A',  'S',
- 'D',  'F',  'G',  'H',  'J',  'K',  'L',  0xd6,
- 0xc4, 0xbd,  0,   '*',  'Z',  'X',  'C',  'V',
- 'B',  'N',  'M',  ';',  ':',  '_',   0,   '*',
-  0,   ' ',   0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,   '7',
- '8',  '9',  '-',  '4',  '5',  '6',  '+',  '1',
- '2',  '3',  '0',  '.',   0,    0,   '>',   0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0
+int se_shift[] =
+{
+      0,      0,    '!',    '"',    '#',   0xa4,    '%',    '&',
+    '/',    '(',    ')',    '=',    '?',    '`',      0,      0,
+    'Q',    'W',    'E',    'R',    'T',    'Y',    'U',    'I',
+    'O',    'P',   0xc5,   0x5e,      0,      0,    'A',    'S',
+    'D',    'F',    'G',    'H',    'J',    'K',    'L',   0xd6,
+   0xc4,   0xbd,      0,    '*',    'Z',    'X',    'C',    'V',
+    'B',    'N',    'M',    ';',    ':',    '_',      0,    '*',
+      0,    ' ',      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,    '7',
+    '8',    '9',    '-',    '4',    '5',    '6',    '+',    '1',
+    '2',    '3',    '0',    '.',      0,      0,    '>',      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0
 };
 
 /* right alt chars */
-char se_altgr[] =
-{
-  0,    0,    0,   '@',  0xa3, '$',   0,    0,
- '{',  '[',  ']',  '}',  '\\',  0,    0,    0,
- '@',   0,   0x80,  0,    0,    0,    0,    0,
-  0,    0,    0,   '~',   0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,   0xb5,  0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,   '$',   0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,   '|',   0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0,
-  0,    0,    0,    0,    0,    0,    0,    0
+int se_altgr[] =
+{
+      0,      0,      0,    '@',   0xa3,    '$',      0,      0,
+    '{',    '[',    ']',    '}',   '\\',      0,      0,      0,
+    '@',      0, 0x20ac,      0,      0,      0,      0,      0,
+      0,      0,      0,    '~',      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,   0xb5,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,    '$',      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,    '|',      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0
+};
+
+int se_capslock[] =
+{
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0
+};
+
+int se_shiftcapslock[] =
+{
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0
 };
 
 /*****************************************************************************/
-char APP_CC
+/* czech 0x405 */
+
+/* non shift chars */
+int cs_noshift[] =
+{
+      0,      0,    '+',  0x11b,  0x161,  0x10d,  0x159,  0x17e,
+   0xfd,   0xe1,   0xed,   0xe9,    '=',   0xb4,      0,      0,
+    'q',    'w',    'e',    'r',    't',    'z',    'u',    'i',
+    'o',    'p',   0xfa,    ')',      0,      0,    'a',    's',
+    'd',    'f',    'g',    'h',    'j',    'k',    'l',  0x16f,
+   0xa7,    ';',      0,   0xa8,    'y',    'x',    'c',    'v',
+    'b',    'n',    'm',    ',',    '.',    '-',      0,    '*',
+      0,    ' ',      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,    '7',
+    '8',    '9',    '-',    '4',    '5',    '6',    '+',    '1',
+    '2',    '3',    '0',    '.',      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0
+};
+
+/* shift chars */
+int cs_shift[] =
+{
+      0,      0,    '1',    '2',    '3',    '4',    '5',    '6',
+    '7',    '8',    '9',    '0',    '%',  0x2c7,      0,      0,
+    'Q',    'W',    'E',    'R',    'T',    'Z',    'U',    'I',
+    'O',    'P',    '/',    '(',      0,      0,    'A',    'S',
+    'D',    'F',    'G',    'H',    'J',    'K',    'L',    '"',
+    '!',   0xb0,      0,  0x2c7,    'Y',    'X',    'C',    'V',
+    'B',    'N',    'M',    '?',    ':',    '_',      0,    '*',
+      0,    ' ',      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,    '7',
+    '8',    '9',    '-',    '4',    '5',    '6',    '+',    '1',
+    '2',    '3',    '0',    '.',      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0
+};
+
+/* right alt chars */
+int cs_altgr[] =
+{
+      0,      0,    '~',  0x2c7,    '^',  0x2d8,   0xb0,  0x2db,
+    '`',   0xb7,   0xb4,  0x2dd,   0xa8,   0xb8,      0,      0,
+   '\\',    '|', 0x20ac,      0,      0,      0,      0,      0,
+      0,      0,   0xf7,   0xd7,      0,      0,      0,  0x111,
+  0x110,    '[',    ']',      0,      0,  0x142,  0x141,    '$',
+   0xdf,      0,      0,      0,      0,    '#',    '&',    '@',
+     '{',   '}',      0,    '<',    '>',    '*',     0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0
+};
+
+int cs_capslock[] =
+{
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0
+};
+
+int cs_shiftcapslock[] =
+{
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0
+};
+
+/*****************************************************************************/
+/* russian 0x419 */
+
+/* non shift chars */
+int ru_noshift[] =
+{
+      0,      0,    '1',    '2',    '3',    '4',    '5',    '6',
+    '7',    '8',    '9',    '0',    '-',    '=',      0,      0,
+  0x439,  0x446,  0x443,  0x43a,  0x435,  0x43d,  0x433,  0x448,
+  0x449,  0x437,  0x445,  0x44a,      0,      0,  0x444,  0x44b,
+  0x432,  0x430,  0x43f,  0x440,  0x43e,  0x43b,  0x434,  0x436,
+  0x44d,  0x451,      0,   '\\',  0x44f,  0x447,  0x441,  0x43c,
+  0x438,  0x442,  0x44c,  0x431,  0x44e,    '.',      0,    '*',
+      0,    ' ',      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,    '7',
+    '8',    '9',    '-',    '4',    '5',    '6',    '+',    '1',
+    '2',    '3',    '0',    '.',      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0
+};
+
+/* shift chars */
+int ru_shift[] =
+{
+      0,      0,    '!',    '"', 0x2116,    ';',    '%',    ':',
+    '?',    '*',    '(',    ')',    '_',    '+',      0,      0,
+  0x419,  0x426,  0x423,  0x41a,  0x415,  0x41d,  0x413,  0x428,
+  0x429,  0x417,  0x425,  0x42a,      0,      0,  0x424,  0x42b,
+  0x412,  0x410,  0x41f,  0x420,  0x41e,  0x41b,  0x414,  0x416,
+  0x42d,  0x401,      0,    '/',  0x42f,  0x427,  0x421,  0x41c,
+  0x418,  0x422,  0x42c,  0x411,  0x42e,    ',',      0,    '*',
+      0,    ' ',      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,    '7',
+    '8',    '9',    '-',    '4',    '5',    '6',    '+',    '1',
+    '2',    '3',    '0',    '.',      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0
+};
+
+/* right alt chars */
+int ru_altgr[] =
+{
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0
+};
+
+int ru_capslock[] =
+{
+      0,      0,    '1',    '2',    '3',    '4',    '5',    '6',
+    '7',    '8',    '9',    '0',    '-',    '=',      0,      0,
+  0x419,  0x426,  0x423,  0x41a,  0x415,  0x41d,  0x413,  0x428,
+  0x429,  0x417,  0x425,  0x42a,      0,      0,  0x424,  0x42b,
+  0x412,  0x410,  0x41f,  0x420,  0x41e,  0x41b,  0x414,  0x416,
+  0x42d,  0x401,      0,   '\\',  0x42f,  0x427,  0x421,  0x41c,
+  0x418,  0x422,  0x42c,  0x411,  0x42e,    '.',      0,    '*',
+      0,    ' ',      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,    '7',
+    '8',    '9',    '-',    '4',    '5',    '6',    '+',    '1',
+    '2',    '3',    '0',    '.',      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0
+};
+
+int ru_shiftcapslock[] =
+{
+      0,      0,    '!',    '"', 0x2116,    ';',    '%',    ':',
+    '?',    '*',    '(',    ')',    '_',    '+',      0,      0,
+  0x439,  0x446,  0x443,  0x43a,  0x435,  0x43d,  0x433,  0x448,
+  0x449,  0x437,  0x445,  0x44a,      0,      0,  0x444,  0x44b,
+  0x432,  0x430,  0x43f,  0x440,  0x43e,  0x43b,  0x434,  0x436,
+  0x44d,  0x451,      0,    '/',  0x44f,  0x447,  0x441,  0x43c,
+  0x438,  0x442,  0x44c,  0x431,  0x44e,    ',',      0,    '*',
+      0,    ' ',      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,    '7',
+    '8',    '9',    '-',    '4',    '5',    '6',    '+',    '1',
+    '2',    '3',    '0',    '.',      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0,
+      0,      0,      0,      0,      0,      0,      0,      0
+};
+
+/*****************************************************************************/
+twchar APP_CC
 get_char_from_scan_code(int device_flags, int scan_code, int* keys,
                         int caps_lock, int num_lock, int scroll_lock,
-                        int keylayout)
+                        struct xrdp_keymap* keymap)
 {
-  char rv;
-  char* keys_noshift;
-  char* keys_shift;
-  char* keys_altgr;
+  int rv;
   int shift;
   int altgr;
   int ext;
 
-  if (keylayout == 0x40c) /* france */
-  {
-    keys_noshift = fr_noshift;
-    keys_shift = fr_shift;
-    keys_altgr = fr_altgr;
-  }
-  else if (keylayout == 0x809) /* en-uk or en-gb */
-  {
-    keys_noshift = en_uk_noshift;
-    keys_shift = en_uk_shift;
-    keys_altgr = en_uk_altgr;
-  }
-  else if (keylayout == 0x407) /* german */
-  {
-    keys_noshift = de_noshift;
-    keys_shift = de_shift;
-    keys_altgr = de_altgr;
-  }
-  else if (keylayout == 0x416) /* Portuguese (Brazil) */
-  {
-    keys_noshift = pt_br_noshift;
-    keys_shift = pt_br_shift;
-    keys_altgr = pt_br_altgr;
-  }
-  else if (keylayout == 0x410) /* italy */
-  {
-    keys_noshift = it_noshift;
-    keys_shift = it_shift;
-    keys_altgr = it_altgr;
-  }
-  else if (keylayout == 0x41d) /* swedish */
-  {
-    keys_noshift = se_noshift;
-    keys_shift = se_shift;
-    keys_altgr = se_altgr;
-  }
-  else /* english us 0x409 */
-  {
-    keys_noshift = en_us_noshift;
-    keys_shift = en_us_shift;
-    keys_altgr = en_us_altgr;
-  }
-  /*g_writeln("%d %d %x", scan_code, device_flags, keylayout);*/
+  /*g_writeln("%d %d", scan_code, device_flags);*/
   shift = keys[42] || keys[54];
   altgr = keys[56]; /* right alt */
   ext = device_flags & 0x0100;
@@ -565,7 +1015,7 @@ get_char_from_scan_code(int device_flags, int scan_code, int* keys,
       case 81: /* 3 */
       case 82: /* 0 */
       case 83: /* . */
-        return rv;
+        return (twchar)rv;
     }
   }
   if (ext)
@@ -577,29 +1027,183 @@ get_char_from_scan_code(int device_flags, int scan_code, int* keys,
   }
   else
   {
-    if (shift)
+    if (shift && caps_lock)
     {
-      rv = keys_shift[scan_code];
+      rv = keymap->keys_shiftcapslock[scan_code];
+    }
+    else if (shift)
+    {
+      rv = keymap->keys_shift[scan_code];
+    }
+    else if (caps_lock)
+    {
+      rv = keymap->keys_capslock[scan_code];
+    }
+    else if (altgr)
+    {
+      rv = keymap->keys_altgr[scan_code];
     }
     else
     {
-      if (altgr)
-      {
-        rv = keys_altgr[scan_code];
-      }
-      else
-      {
-        rv = keys_noshift[scan_code];
-      }
+      rv = keymap->keys_noshift[scan_code];
     }
-    if (rv >= 'a' && rv <= 'z' && caps_lock)
+  }
+  return (twchar)rv;
+}
+
+/*****************************************************************************/
+static int APP_CC
+km_read_section(int fd, const char* section_name, int* keymap)
+{
+  struct list* names;
+  struct list* values;
+  int index;
+  int code;
+  char* name;
+  char* value;
+
+  names = list_create();
+  names->auto_free = 1;
+  values = list_create();
+  values->auto_free = 1;
+  if (file_read_section(fd, section_name, names, values) == 0)
+  {
+    for (index = names->count - 1; index >= 0; index--)
     {
-      rv = rv - ('a' - 'A');
+      name = (char*)list_get_item(names, index);
+      value = (char*)list_get_item(values, index);
+      if ((name != 0) && (value != 0))
+      {
+        if (g_strncasecmp(name, "key", 3) == 0)
+        {
+          code = g_atoi(name + 3);
+        }
+        else
+        {
+          code = g_atoi(name);
+        }
+        if ((code >= 0) && (code < 128))
+        {
+          if (g_strncasecmp(value, "0x", 2) == 0)
+          {
+            keymap[code] = g_htoi(value + 2);
+          }
+          else
+          {
+            keymap[code] = g_atoi(value);
+          }
+        }
+      }
     }
-    else if (rv >= 'A' && rv <= 'Z' && caps_lock)
+  }
+  list_delete(names);
+  list_delete(values);
+  return 0;
+}
+
+/*****************************************************************************/
+int APP_CC
+get_keymaps(int keylayout, struct xrdp_keymap* keymap)
+{
+  int ks;
+  int fd;
+  char filename[256];
+  struct xrdp_keymap lkeymap;
+
+  ks = sizeof(int) * 128;
+  switch (keylayout)
+  {
+    case 0x40c: /* france */
+      g_memcpy(keymap->keys_noshift, fr_noshift, ks);
+      g_memcpy(keymap->keys_shift, fr_shift, ks);
+      g_memcpy(keymap->keys_altgr, fr_altgr, ks);
+      g_memcpy(keymap->keys_capslock, fr_capslock, ks);
+      g_memcpy(keymap->keys_shiftcapslock, fr_shiftcapslock, ks);
+      break;
+    case 0x809: /* en-uk or en-gb */
+      g_memcpy(keymap->keys_noshift, en_uk_noshift, ks);
+      g_memcpy(keymap->keys_shift, en_uk_shift, ks);
+      g_memcpy(keymap->keys_altgr, en_uk_altgr, ks);
+      g_memcpy(keymap->keys_capslock, en_uk_capslock, ks);
+      g_memcpy(keymap->keys_shiftcapslock, en_uk_shiftcapslock, ks);
+      break;
+    case 0x407: /* german */
+      g_memcpy(keymap->keys_noshift, de_noshift, ks);
+      g_memcpy(keymap->keys_shift, de_shift, ks);
+      g_memcpy(keymap->keys_altgr, de_altgr, ks);
+      g_memcpy(keymap->keys_capslock, de_capslock, ks);
+      g_memcpy(keymap->keys_shiftcapslock, de_shiftcapslock, ks);
+      break;
+    case 0x416: /* Portuguese (Brazil) */
+      g_memcpy(keymap->keys_noshift, pt_br_noshift, ks);
+      g_memcpy(keymap->keys_shift, pt_br_shift, ks);
+      g_memcpy(keymap->keys_altgr, pt_br_altgr, ks);
+      g_memcpy(keymap->keys_capslock, pt_br_capslock, ks);
+      g_memcpy(keymap->keys_shiftcapslock, pt_br_shiftcapslock, ks);
+      break;
+    case 0x410: /* italy */
+      g_memcpy(keymap->keys_noshift, it_noshift, ks);
+      g_memcpy(keymap->keys_shift, it_shift, ks);
+      g_memcpy(keymap->keys_altgr, it_altgr, ks);
+      g_memcpy(keymap->keys_capslock, it_capslock, ks);
+      g_memcpy(keymap->keys_shiftcapslock, it_shiftcapslock, ks);
+      break;
+    case 0x41d: /* swedish */
+      g_memcpy(keymap->keys_noshift, se_noshift, ks);
+      g_memcpy(keymap->keys_shift, se_shift, ks);
+      g_memcpy(keymap->keys_altgr, se_altgr, ks);
+      g_memcpy(keymap->keys_capslock, se_capslock, ks);
+      g_memcpy(keymap->keys_shiftcapslock, se_shiftcapslock, ks);
+      break;
+    case 0x405: /* czech */
+      g_memcpy(keymap->keys_noshift, cs_noshift, ks);
+      g_memcpy(keymap->keys_shift, cs_shift, ks);
+      g_memcpy(keymap->keys_altgr, cs_altgr, ks);
+      g_memcpy(keymap->keys_capslock, cs_capslock, ks);
+      g_memcpy(keymap->keys_shiftcapslock, cs_shiftcapslock, ks);
+      break;
+    case 0x419: /* russian */
+      g_memcpy(keymap->keys_noshift, ru_noshift, ks);
+      g_memcpy(keymap->keys_shift, ru_shift, ks);
+      g_memcpy(keymap->keys_altgr, ru_altgr, ks);
+      g_memcpy(keymap->keys_capslock, ru_capslock, ks);
+      g_memcpy(keymap->keys_shiftcapslock, ru_shiftcapslock, ks);
+      break;
+    default: /* default 0x409 us en */
+      g_memcpy(keymap->keys_noshift, en_us_noshift, ks);
+      g_memcpy(keymap->keys_shift, en_us_shift, ks);
+      g_memcpy(keymap->keys_altgr, en_us_altgr, ks);
+      g_memcpy(keymap->keys_capslock, en_us_capslock, ks);
+      g_memcpy(keymap->keys_shiftcapslock, en_us_shiftcapslock, ks);
+      break;
+  }
+  /* check if there is a keymap file */
+  g_snprintf(filename, 255, XRDP_KEYMAP_FILE, keylayout);
+  if (g_file_exist(filename))
+  {
+    fd = g_file_open(filename);
+    if (fd > 0)
     {
-      rv = rv + ('a' - 'A');
+      lkeymap = *keymap; /* make a copy of the build in kaymap */
+      /* clear the keymaps */
+      g_memset(keymap->keys_noshift, 0, ks);
+      g_memset(keymap->keys_shift, 0, ks);
+      g_memset(keymap->keys_altgr, 0, ks);
+      g_memset(keymap->keys_capslock, 0, ks);
+      g_memset(keymap->keys_shiftcapslock, 0, ks);
+      /* read the keymaps */
+      km_read_section(fd, "noshift", keymap->keys_noshift);
+      km_read_section(fd, "shift", keymap->keys_shift);
+      km_read_section(fd, "altgr", keymap->keys_altgr);
+      km_read_section(fd, "capslock", keymap->keys_capslock);
+      km_read_section(fd, "shiftcapslock", keymap->keys_shiftcapslock);
+      if (g_memcmp(&lkeymap, keymap, sizeof(struct xrdp_keymap)) != 0)
+      {
+        g_writeln("local keymap file for 0x%4.4x found and dosen't match built \
+in keymap, using local keymap file", keylayout);
+      }
+      g_file_close(fd);
     }
   }
-  return rv;
+  return 0;
 }
diff --git a/xrdp/sans-10.fv1 b/xrdp/sans-10.fv1
new file mode 100755
index 0000000..047870f
--- /dev/null
+++ b/xrdp/sans-10.fv1
@@ -0,0 +1,1131 @@
+FNT1DejaVu Sans                     
+                                                                             	              	    $  $ $ h                      |p|                   `   d	 	           	                8 D @   P  |                                         `@@@@               @@      @@                 |8       	                                                    @@                                                                     `@@@               xHHx                                         x @                 x8x                 ((HH                 x                 8DLx                   @                 xxx                 xtp                                         @@   @@                 pp                                           pp                  p                           @@   @@       	    	                " "  A A            	                 	          <BB<       
+                                                   
+          >AA>       
+                                                                                         	                           
+                 
+          <BB<                        
+          <BB<                      	          |||                         
+          <    	    	             A A " "                               D@J@J@**                        B$$B                  DD((       
+           @                                @@@`                                          <f                                               @                            x|t                                  pp               ||                   x8                0@@@@@@@@@                   ||L8                                               @  @@@@@@@@@                                                                                                   xx                                   ||                                   ppp                  @@@@@@@p                   t                    DD((    	    	                 I U U " "                         D((D                    DD((                   @                8                                                                q                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                xx                "  x                      |DDD|                  D(                                 xh                            	                > c c >                      px                      $ll$                                                    	                > c c >                                               ``         	                                                `                     `                    @                                         |t                                                 @               @@@                     pp                      ll                     A B B `	 0                         A B B  @1                         b  `	 0                           @p    	    	              " "  A A         	    	              " "  A A         	    	              " "  A A         	    	              " "  A A         	    	               " "  A A         	    	              " > A A                          
+   #> B B            	          <BB<                                          0H                (                @ @@@@@@@@@              @              p                           @@@@@@@@@    	    
+             ~ C @@@@C ~            
+       4,        
+         <BB<       
+        <BB<       
+       $ <BB<       
+       4, <BB<       
+         <BB<                  D((D        
+          =BB       
+         <       
+        <       
+       $ <       
+         <                DD((                                p                  x|t                  x|t                0H x|t                hX x|t                 0 x|t              0HH0 x|t                        {`   q                       pp8               x8                  x8                0H x8                 H x8                 @  @@@@@@@                @                p                           @@@@@@@                Hpxx                hX                   xx                  xx                0H xx                hX xx                 0 xx                                        |                  t                  t                0H t                 0 t                  DD((                              DD((   	    	       >        " "  A A                     x  x|t    	    	              " "  A A                     H0 x|t    	    	                " "  A A                    x|t    	        <BB<                  pp       	       $ <BB<                0H pp       	         <BB<                   pp       	       $ <BB<                H0 pp       
+                        ||    	    
+             ~ C @@@@C ~                    ||              x                  x  x8              H0                 H0 x8                                   x8                                 x8           H0                 H0 x8       
+        >AA>                0H ||L8    
+       $ >AA>                H0 ||L8    
+         >AA>                   ||L8    
+          >AA>                ||L8    
+       $              p   .1!!!!!    
+                @@@@@@@           	        @@@\bBBBBB                                                                                                           p                         p                                                                                         0                         p                        p          `                                                           @                                                @@@@@@@@@@@                                                                                @@@p@@@~                @@@@`@@@@@       
+                                 
+                                  
+       $                 H0                  @@1!!!!!       
+                          8    
+       <  <BB<                x  xx       
+       $ <BB<                H0 xx       
+       ( <BB<                ( xx                    ?b     b ?                            {`   {                                     @                                               H0                 `        	         |||                 @ ppp       	       ( |||                 P ppp       	          |||8                ppp p    	       ( |||                P  ppp                                 @@@@@@@p8            (                  H@@@@@@p                  |                  @@@@@@p       
+       4, <                hX t       
+       <  <                x  t       
+       $ <                H0 t       
+       $ <              0HH0 t       
+       ( <                ( t       
+          <                t                  D@J@J@**          	    	            
+   I U U " "                    ( DD((                 $ DD((               ( DD((       
+          @                 @  @       
+          @                 @  @       
+       $  @                P   @                0@@@@@@@@@                @@@|fBBBf|    
+  
+             @@@@@@           	                                 	          @@@~AAA~                @@|fBBBf|       	          xx    
+   	         > B      B <                    xp    	    
+             ~ C @@@@C ~                                        	          >~~               |||                   xhx                     
+          <BB<                 |p|                >   >                    x         
+   
+          ? A      A >                       BB$$$$                 `   `                     `                  @@@@@@@@       
+                         `                @@@@@@@@@@                 48X<$$FB                    ````````w        
+  
+             0@0@(@$@&@"@!@                            
+          <BB<    	               =B      B <                       ~x    
+               g@@@@@@B@>@           
+            ~y 	                                       p    	                         8fx@@~                   ppp                 `0 @               p|               @@@@@@@80               ~                0@@@@@@@@p                   
+               @       <                       t       
+          BBB<       	          |    
+    
+             D@(@(              	    	                  DH ( 0  0   `       
+          ~0 @                   x`       	          0<       	          @                    @ 0p8                 px             p0`       	                                           @@`0                                                                                                                                           ( | @|                     P  | @|                         
+                       ` 
+                @@@@@@@@@ @ @  
+               @  @@@@@@@ @ @      
+            	    	              " "  A A                     H0 x|t             P                          P                
+       $ <BB<                H0 xx       
+       $ <                H0 t       
+         <              x  0 t       
+         <                t       
+         <              $  t       
+         <              @   t                   xx    	    	         
+      " "  A A                   x  0 x|t    	    	               " "  A A                       x|t                   
+   #> B B                            {`   q        	   
+             > A     A >                        ||D8    
+        >AA>                ` ||L8           $              p   "$(0($"       
+          <BB<                xx  0    
+       <  <BB<             x  xx  0    	       $ 0<                ` 8x            P           `                                                          | @|                        | @|           
+        >AA>                 @ ||L8                              	             
+                              	    	              " > A A                   2LH0 x|t                   
+   #> B B                           {`   q           
+        =BB                 @ |    	    	       (       " "  A A                     P( x|t    	    	              " "  A A                     p x|t              P(                 ( x8              $                 8 x8             P                          P                ` @@@@@@@@@                  @@@@@@@       
+       ( <BB<                ( xx       
+       $ <BB<                p xx              P                 P(               0H                 p        
+       P( <                ( t       
+       $ <                8 t       	          |||                   ppp                                  @@@@@@@p              0l`                 xx0    
+       $              p   .1!!!!!       
+          	                 |    w          	         &|||                  xxx       	          0 @                 @p 	    	               " "  A A                        x|t                 8                x88    
+        
+ <BB<              x  0 xx       
+        <BB<              x 4, xx       
+         <BB<                   xx       
+         <BB<              x    xx               <  DD((                 <  DD((                  	                                             @@@@@Xhx@                   @@@@@@@@@                       u                                 u     	    	               & * ~  A         	    	           ; b F D H P ` `                         >dHP``|                  @@@@@@@~    	                    , L                        p                  @`0              <                       p@@        	          ~AAA~AA~    
+    
+             @@@@@@a?         	    	                " " c A A                    @                 x|@                   p                    @  @@@@@@@@ 
+   
+             = C      C =                    ||               |BBBDBBA                    X`@@@@                  B$                    BFd(0`                x                   ||                                  p                                      px@              ||    	        ||                   xx                   xx    	   
+                 x   5  x                        xpx                   ppp    	   
+                 p   q  p            	            <BB<                    @@@@@@@@    	        ||L8                ||L8                8D|                   HH0000HHx                H00xHx                   t            p               p8              @  @@@@@@                   `                   @@@@@                                                                  
+        C<                          `s                                 `s                                                        \bBBBBB@@                                                   xx    	                    ?H               	            |n       	        ||                 0                0                    0                                p                8@@@@@                    0000x                                                         ppp             0@@@@@@@@@@@@             0@@@@@@@@@@                             |`                                        @@@@@@@@@@0                 BBBBF:                   xx                   p                    ((DDD    	    	                 " " U U I                     0((LDD       	            D(                    @                 L      	            8x                0 pt            p0                   p`                       0p                xp 	   
+            f       C >                               	            xrx    	   	            < D     |            	                                 	            D$4D                    	   	            |      |                 p0 p                 p` p                        @ w                          @0t 0                    @w       
+                 @ @ D D C@@@@?                     DDDDDDD< 	    
+             @ @ L H H I N?       
+               8   ` l@l@l@l@l@l@ @ @                     	                            tlHth                                     @`bbbbb"> 	    	            @ ` b b b b b " >                                                          @ @@@@@                                                                                                                      tlH                       P` @                                                                  @                       @@                     @@                                                                        @@@                    `@@@                    `                       `                       `P                       P`                        `                        `                                                                       `@                        @                                                                                   @                          @                @   @                   @                                                                       @@                       @@                                                                     `                                               ``                                                                       P                              0                                             @`                                                                ``                    `@@@                                                                                                                                                  `P                                                                                                                                    `                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               @                                                                                                                       pp                   HH                   @@   @@                                                                                          @                      @             	    	           @    " "  A A                                 	  
+           @               
+               @ @ @ @ @? @ @ @ @                     @                           	               @  ! @@@@@!                                      @  @@            
+             @   @ @ @ @9                  @  `    	    	                " "  A A            	                               	    	                " " c A A                             
+           @       
+                 
+          <BB<                                      	    	                " " c A A         	                           
+                              x          
+          <BB<       	                                                           `0 @                                    DD((    	                 > I I >                        B$$B    	                k >              
+          <BBB                 @@@@@@@@@                ( DD((       	           rv                  xpx                               @ `               @ P p       	            rv                p                 DD,(8             x@`Xx                   xpx               0`@@8                            0HH0                   `                                   `((dDD                                    DDH80               p@x                xx                    DDDDDF                   x                pp                ~x                                       p       	            \|                 d,((hL    	            | 	                    A w                       `                 P p                  xx                 @ p    	                  A w                                    0HDx                8LDDx       	         *8                 H                  	        *8       	        || 
+                     `@@D@D@d;           	            ,(8H 	   
+            f       C >                     xx000              ~@@x                |p                             0     	          `BLt       	           @@|    	              8  ! #&$                    0(T  
+                @@@@@@s    	                     w         
+         cG{    	            d| 	   
+                                          >FN2        	         >c``?                x0`D8    
+         $<<$B                    4<&       	         ||                px                                     	            ,(8H                   |D`<                pp                 @  @@@@@@@@@ 	   
+            f       C >                        xx                                                       	          <BB<    	                                                       |D    	          xx       	          <BB<       	          xBBx                                    	    
+                                        
+          >AA>       	          |||                                  @@@@@@@@@                                            ? ! ! ! !!!A                                    	    
+                            	               
+                        $ DD,(8`       	            	    	                " "  A A            	                 	                               	                ? ! ! ! ! ! ! A                                       b02`' " B           	          |x       
+                 
+       $        	                 
+          ?!!!!!!A    	                           
+                 
+          <BB<       	                                  	          <BB<                                    DD,(8`    	                 > I I >                        B$$B       
+               	          ~                                                                  	                       ?    ?         	                           	                 
+          ||                                 	          ~~"bB                   x|t               8@x                                             
+            >""""B                 x8                         D@$ ?$D@`                       ppp                                   H0                                        >""""B       	                                                  xx                                                      pp       	                                DD((   	                                       D((D       	                             |    	                            
+                     @ @    	    
+                                 
+                                                  pxp    	                                             ||dD                  x8                 ( x8                 ````|bbbb                                  pp                   ppp                                     @@@@@@@                 @  @@@@@@@@@                      > " " #" B         
+                       @@                    @@@@@\bBBB                                                     $ DD((      	              
+                @@@@@@s        	                    A w         	    
+                              	              >!!>                  `                 
+                                  
+   ??d@D`         
+    
+                    1 / DD                        @`                              @          	   
+              b & 4 < z                           Hx0                    @@  0        	                                          HPp8t             P`p@                  `LLm- -                              D`Dd%% 5       	   
+            f       C >                        xx    
+    
+            A c " " 6                	            CFd$,8    
+    
+          A c " " 6                	         
+ CFd$,8                  0 X    @p     
+                    t@ s                     @@```@d            
+            ~~                @px                          @     q        
+          ?     @@@@@@s        	              > *   A w            	         v`>                xx                  8t0x                                                                                                    8 $	       `@         < $	                 1    `      `   	   
+       $                    	         H8      	          ``|gaac~                  @@@@|BB|                                                                         	          ?                           >                                      0                  c30`0#cC                           d@4 &d@D            	          |x p                ppp p    	                                	                                 	    	             c  l x t f b a a                     @@DHPxlDB                        `        	                                   	   
+                            	                                              
+                                                     0  0                           ``` ` @  	   
+            v       K >                      xx      	          <BB<                pp8                                                 DD((                    BFd$(               Bf$<                    BFd$(<< 	    	             c 2     & c A                    F$8dB                   ````````      
+    
+                  @ @       	          ~                 |     	          ~                   |,       	                                             `             	    	                   0                          `          	    	                   0                                      b02`' " B                       	    D@$ ?$D@`           	                          8 
+    
+             11!         	            >22"""    
+              	             	   
+                             	                	          ~                 |  
+                 @    	   
+                                           	    	              " "  A A                     H0 x|t    	    	               " "  A A                      0 x|t                     
+   #> B B                             {`   q                  H0                 H0 x8       
+          <BB<                   xx       
+         <BB<                 ( xx                   b02`' " B                            D@$ ?$D@`           	        ( |x                 P ppp       	          0<       	            8x    
+       <                  x         
+                          (        
+         <BB<                 0 xx    	   
+            f       C >                        xx    	   
+           f       C >                      ( xx       
+        ( ||                 P pxp               <  DD,(8`                 <  DD((                DD,(8`                   DD((              ( DD,(8`                 
+ DD((      	         ~                 ( |                                    ``  	            
+              
+                   	          ?      <8                 >    <0     	          c2&cA                 F$8dB 	    	             c 2     & c A                         F$~8dB       	          >~                                          >    `{        	                              
+              p   @8@@@@@        	                      p            	         p8                p                  11!                             > 2 2 " " "                                   
+                      @@@@           
+         sC>       	            |x    	    
+               	             	                             |p|                   xpx       
+          ?#####cC                 >222""                                                                                                                                                                                                                                                                                                                                                                                                                                                    
+                      B@<@           
+          >                    >     ?                           >                   
+          B|                0LL4     	               
+          >  
+              8 f  @@            
+                 @@  F <            
+                             	                                          @ ?P0` ` ` `0@           
+          f:       	          0`              0LL4L                    <                   
+          @AAAAc?    
+                @     B |            
+         8~                      p     `           
+        8`B|       
+          <       
+         8fpx      
+         ~                0LD$                  >                   
+          <    
+                     f :   @ @       	          |||       
+          >       
+         8<~    	   
+                             	                 > I I >          	   
+            3 !1    !               
+          <BB<                `<$&$                                                                      @@                                                                    @                       p                      @                                                    `s                           
+            |    
+                         t       	            ||                                  	                	        ~x                                	                        	        ~Hx               t                           @@px|       	                         Lt               t                    @@@@@@@@@     	        @a!!!!#                   p `@                                    p@`0 @                          `s                       pP``@    
+                               t       	        t                          t                                        ||L8                                         t                      |fBBBf|@@                xx       	        px|    
+        w                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        Dd                                       0h                                                                                                                        x                                                                                                   	            bBB                                          	            FBBBf<                    BB"""$8                  d                d                   HH0                      D$8       	                                                      	            BBBBB                                                                                                                                                           @                        ,H                                                                                                                                                                                                                                                                                                                                                                                     @@                                                                                                                                                                                                                                      @@                                                                p`                                        pp                 @@@@@@@@@@                                 $4                  
+            ``8                  
+                          @@                       P `    
+                         @@         
+                        @@                         0 @@>                 0 @@>                0 @@>                                     @                                                                     ddl  x                        @ ddl  x                            0 l  x                           0 l  x   
+                        !&,@8         
+                      $ !&,@8                        0``~              @ 0``~                                                                                                                         @   `          
+           
+ 		p             		       	         x                   <$    
+             |                   `                     $4    
+              8     
+              8(                                                                                                                                                                                                                                                                                                                                                                                                  @@@@@@                  p@@@@@                   V^|                       0@@`x                  pPp                                     DD(((8                   8((hDD                                      @H                                        @                           pP      
+                          @@            
+             		p                                                                                                                                                 
+                       @@         
+                        @@         
+                          @@        
+                         @@       
+                         @@         
+                          @@        
+                        @@         
+                          @@                     00@0 @@>               0 @@>                 0 @@>                 0 @@>              ( 0 @@>                 0 @@>                 0 @@>                                                                                                                                                                      
+                                 	                                                                              
+                                                                                                                                                  `                                                    @      `                                           `                                                                                                                                                           	                                                                                           	        x                                                                 
+              |                                                                             0 @@>                                                                                                          $4                                                                               
+              8                    
+            P`8                                                                                                             `                                                                                                                                                                                                                                                                                                                                                                                                                                                 @@@@@@                  p@@@@@                   V^|                       x@@@@@                  pP                  p@@x0`@                   DD(((8                   8((hDD                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     	            "       	            |~                      	            |                                                                 ,4                      	            ~8                                  	            b|                                                                                                 	            |                  @        	            !9)9    	            R                      	            """                   |               |       
+                  
+               	            B       	         B                      	            !!!!!       	         b|       	            |                                   ~Cs[kn                                  xx                                  	    	               gc  s [ k n         	                    Dx                                      x|       	           ||    	   
+               0 X  Y #                          | |                                    p                                                                                                                                                                                           	          rN                                                      	                           P(    8(              xX0    8(8               @@p0   0(8                      	            |                                                                                                                                                                   xx                   d                0`x   	    	            # # # #                        0`>                `>   	   	          =                    	            """                   	                                                                  D{                            D{                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     	    	             A A c " "            	    	              " " c A A         	    	                " " c A A         	    	               " " c A A            
+                 
+                 
+        (                       
+                 
+          aa       
+         aa    
+                  1  
+ 
+                           A A c "`"            
+                 
+ 
+   1                              " "`c A A         
+                
+ 
+   1                             " "`c A A                                                            `                                                              `               
+                                                                    a `a                                                                a `a               
+         aa                                                         0PP                     0 @                      @`                       `                      @                                              @`                       (HPP                                                                                            @@@@                      @@@                          AAc" "                             	 "@" c A A                          @                             @ 0a a            	    	             A A " "            	    	              " " c A A         	    	                " " c A A         	    	               " " c A A            	          ``       	          ``       	        ( ``                      	          `a`       	          ``       	         ``    
+                @@@@    
+ 
+              	             A A "`"            
+                 
+ 
+   1  @@                            " "`c A A         
+                
+ 
+   1  @@                           " "`c A A                                                           `   `  `                                                           `   `  `                                                               ` ``                                                                ` ``               	         ``                 pp                                               
+          <       
+        <       
+          <       
+         <       	                 	                	                               	          a       	          ?@@?       	         ?@@?    
+                 @ @ @ @@ @ @0         
+                       <         
+                 0 @ @@ @ @ @ @        
+                <                
+                0 @ @@ @ @ @ @        
+               <                                 @          @        
+                                                @          @        
+                                                              
+                ? @     @ ?                                       
+               ? @     @ ?         
+                                               pp        
+                @@@@@   <         
+                <@@@@@            
+                @@@@@            
+                ?@@@@@@  @ ?                      x|              $ x                 x                x                 |x                |x               
+ |x                 x                x    	                            	   
+             x    |                         3!!>       	                x                            3!!>       	               x                	                            	   
+                |    x         	                           	   
+               |    x                         >!!3    	                       x                         >!!3    	                      x                      @|fB<                                      0p           
+          y|    	   
+             x               
+          }x    	   
+                x                      x              $ x                 x                x                 x                x               
+ x                 x                x    	                              	   
+             x                             3!         	                x                            3!         	               x                	                              	   
+                    x         	                             	   
+                   x                           !3    	                       x                           !3    	                      x                      @@@@<                                                                        $                                                                                  
+                                         
+          ?    	   
+                                
+          ?           	   
+                                
+         ?           	   
+                               
+          ?    	   
+                                
+         ?    	   
+                               
+                 ?    	   
+                                
+                 ?    	   
+                               
+          @@@@~                                      xx                                                               
+                      @@@        
+               $ $      x         
+                          x         
+                          x         
+                      @@        
+                     @@        
+                    @@        
+                      x             
+                      x                                                                  p@@                                       
+                      x                                          
+                      x            
+                  (   x                         `|                      p                    $$          
+                       @ @ @         
+               $ $      `         
+                          `         
+                         `         
+                        @ @         
+                       @ @         
+                      @ @         
+                      `             
+                     `                                       0                               p @ @                                                                  0   `                                                                0   `                                0                                   @ @                            @   0                                  @ @                                                                  ` 0                                                                  ` 0                       @|                            	          ><                 @`              	                                                   `@                `@               
+ `@                                     	                                   
+          @c       
+          8       	   
+                                
+         8       	   
+                            	                                   
+          c@    	                                  
+         c@       
+             8    	   
+                                
+             8    	   
+                               
+          @p                 0                    `p                    `                                                                                                                                	    	           0 X      	         	    	                 H x         	    	                H x                                xL`  B`!                              xL`  B`!                               !B`F  L`x                              !B`F  L`x                        2      `                       0 X    ` 	                       `     2                             `  H x                      `     2                            `  H x                               011p                               xLl  B`!                             011p                              xLl  B`!                              p10                               !BlF  L`x                             p10                              !BlF  L`x                    L                        @              H0 @                  @                @ @                  @                 @                 @                   @                 @    	                                	   
+                 @                          ?       	                @                             ?       	            @   @                 	                                	   
+                 @             	                               	   
+                @                             ?    	                        @                         ?    	                       @                      @~                  0 @                                    @@@@                     P `P        
+                          x         
+                      @@@@        
+                      @@@@        
+               $ $  x             
+                      x             
+                     x                                                                             ||                 ||                 ||    	                                 
+          ||                 pp                          	          x|       	          FDD((       	       $ ((DDF       	          ((DDF       	         ((DDF       	          `       	         `       	          wp       	         wp                                                    w  `p                         p           
+         `B|       
+         B|       
+         8fr       
+         8f       
+        8fr       
+        8f       	                 	                	          `?       	         `?                                
+                     ` ?                     0x                                                                                                                                               
+               8 l F  F ~           	                P p 0         	               P p 0         
+                  :@f   F |         
+                 :@f   F |         	                0 P            	               0 P                        @(D8           
+                          P `P                      s` t `                           s` t `                          s` t `                           p   s`  `                     @  p   s`  `                        t   w`  `                       t   w`  `        	                t  t                                                                             	                x               	                    P 0 0         	                      x         	                0 0 P                        $ ` xz
+                          ` xz
+                         ` xz
+                          `   z 
+     `                     @`   z 
+     `                      ` z
+    x                     ` z
+    x           	         `z
+                      b  P                                                                                                                                                         
+                       `         
+                       `         
+                        @ @  0    
+                       @ @  0    
+                      `          
+                      `                      @|                       @                  ```                 ```                 @`                 @`                   ``                @ ``                 @@8                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
+                                               
+          ?aa?                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             @                    P @                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    ``                    s` t `                            ` <fzB
+                            b  `  T  $                                    b  `  T  $                                   b  Q !  ! 3                      b  Q !  ! 3                         b      T  $      `                            b      T  $      `                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    8,$|BB    	    	                 8 ( / x H                                 {                        |FD|F|                   pp                                       |FBBF|                                      p                                                                            @@p@@|       
+                                                  xx                          	            88       	             |     	    	                  g Q I E                                000 {                                      x                          x                                       >ff>&FF                    FF&>ff>                                      x       
+                 
+                      @ @@                                          DD((    	                     I U U " "                         @                    0                                                                     ((DDD                                                                               >""""B                  0PH                     0P\                                                                                                 `                      8DD8                                                             @@@@@@                                                                                                                        0LD8                     hHxx                                                                                      `                     Zjf$                       p`                       p                       p`                       
+~                     `                      p`                       pp                                                                   ` `                       pp                                                     	                                 p                     ``                                              p                           p                                            @@@@`                                             p                                               P`                                                          P`                      0@pp                       xp                       P` `P                                                                                            P`                                           P`                      0@pp                       xp                       P` `P                                                                                                                                                                                                      |                                                                  @@@@                                                                                                                                                       `@                                                                                                                                                                                                                                                                                                                                                                  pp                       pp                     PPp                      `                      `@@@@@                       @@@                      pp                                           @ @@@@                                             @@@                       @@@                                                                                                                                                       pHHH                                                                 pp                     p pp                       @0                    `@@@@@                     @@@@`                      p                       Pp                                                                     PP                       p @                       p @                      p p                       p p                    pPPp                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    	    	                " "  A A                     x|txHx    	                               	                               	           x              x     	        <BB<              @ pp8    
+                        ||       
+                        ||       
+           x             || x     
+          8            || p    
+           0H            || 0H           x                @ x  x8              x                x  x8                  0H                x8 0H               x@                x8 x@           $ 8             H0 x8 p                              0@@@@@@@@@       
+       <  >AA>                  ||L8    
+                               
+                               
+                         @@@\bBBBBB    	    
+             @@@@@@@@@                  @@@@\bBBBBB@     
+           H0             `               @@@@@@@@@               @  @@@@@@@                            @                               @                                                 <              x                                              @@@@@@@@~              @@@@@@@@@@@  @               x              @@@@@@@@@@@                 0H             @@@@@@@@@@@ ` 	                                                      	                                                        	                                                           
+                                   
+                                   
+           <                  x     
+           $                 0H    
+        <BB<              4, xx       
+        <BB<               (hX xx       
+       <  <BB<              @ x  xx       
+       <  <BB<              x  xx                                @                                                                 @        	                                   	       x                                     x                  X`@@@@@      	         |||                 @ ppp                 |||                   ppp       	       H |||                  ppp       	       $ |||              @ P  ppp                 |||                 @ ppp                                 @ @@@@@@@p                                   @@@@@@@p                   <                @@@@@@@p x                 $               @@@@@@@p 0H    
+          <  (                t  P    
+          < <                 t x@    
+          < 0H                t `    
+       4, <               hX t       
+       x  <               x  t    	    	           A A " "                         4, DD((    	    	             A A " "                           DD((                    D@J@J@**          	    	               I U U " "                          D@J@J@**          	    	               I U U " "                           D@J@J@**          	    	             
+   I U U " "                           D@J@J@**          	    	                I U U " "                            D@J@J@**         	    	                 I U U " "                     B$$B                   D((D                 B$$B                   D((D                 DD((                   DD((      
+       $  @                `  @       
+           @                   @       
+           @ x                  @               x              P @@@@@@@p    	    	        	 	    I U U " "                     DD((               ||t                0@@@@@@@@@                                                                	    	                " "  A A                       x|t    	    	              " "  A A                    p  x|t    	    	              " "  A A                   0H x|t    	    	              " "  A A                   0H x|t    	    	              " "  A A                   8H x|t    	    	              " "  A A                   hX0H x|t    	    	              " "  A A                    0H x|t    	    	              " "  A A                    H0 x|t    	    	              " "  A A                   @H0 x|t    	    	              " "  A A                   ph0 x|t    	    	              " "  A A                   hXH0 x|t    	    	              " "  A A                    H0 x|t                                   x8                              p  x8              4,                 hX x8              $               $ x8              $               $ x8              $               $ x8              $               4,$ x8              0H                0H x8                @ @@@@@@@@@                 @ @@@@@@@                                        
+          <BB<                  xx       
+        <BB<               p  xx       
+        <BB<              $ xx       
+        <BB<              $ xx       
+        <BB<              $ xx       
+        <BB<              4,$ xx       
+       $ <BB<               0H xx    	             =B      B <                      ~x    	              =B      B <                      ~x    	             =B      B <                    p ~x    	          4 ,  =B      B <                     hX
+~x    	               =B      B <                      ~x       
+          <                  t       
+        <               p  t    
+             @       <                      t    
+              @       <                      t    
+             @       <                    p t    
+          4 ,  @       <                     hXt    
+               @       <                      t                 DD((                   DD((                 DD((                   DD((               DD((                8 DD((              4, DD((                 4, DD((                                                                                                	        0  rv       	        `@  rv       	        H rv       	        D rv       	        `0` rv       	        P rv       	       4<  rv       	       hx@  rv    	    	         `   H   " "  A A         	    	           H   " "  A A                     H @@                       D@@          
+    
+          `  
+ 
+   ?  @@          
+           Q @@          	    	       h x   H   " "  A A         	   
+          H   " "  A A                    ` @ xpx               `@  xpx                H <@@8@@<                D <@@8@@<               `0` xpx               P xpx                                      	        @   ?   ?        	           ?   ?                H                            G              
+              `                            S                                                       0              0              H             D             `0`             P            4<             4<   
+              @ @ @ @ @? @ @ @ @        
+               `@ @ @ @? @ @ @ @                    H                      F                      `                      R        
+            @ @ @ @ @? @ @ @ @                     P                           @ `                @ @@@@@@0              H                     D                       ` @@@@@@0              P                     @ `               @ @@@@@@0                @                        `                      H              F                `              R              @              P               0  xx               0  xx               H xx               D xx               `0` xx               P xx                                  	    
+          @  ! @@@@@!          
+               O  @ @ @ @ @                     H                       D                       ` @     @                     S                                                   ` @ p               `@  p                H DBBBBD8                D DBBBBD8               `0` p               P p              hx @ p              hx@  p                   	    
+           `  
+ 
+                                         F   @ @ @ @                                    R   @ @ @ @                       
+             P@              	                 A w         	                 A w         	            ` $ B   A w         	            ` D "   A w         	                 A w         	            0 "    A w         	                A w         	                A w         
+    
+          @   @ @ @ @9        
+               O  @ @ @ @9                    H                      D                      ` @    @@                     Q8        
+            @   @ @ @ @9        
+             O  @ @ @ @9           	           rv       	           rv                  xpx                  xpx                      	                       @                        @ `                  xx                  xx                @  p                 @ p    	                  A w         	                  A w                                          	        0  rv       	        `@  rv       	        H rv       	        D rv       	        `0` rv       	        P rv       	       4<  rv       	       hx@  rv    	    	         `   H   " "  A A       	    	           H   " "  A A                   H @@                     D@@        
+    
+          `  
+ 
+   ?  @@        
+           Q @@        	    	       h x   H   " "  A A       	   
+          H   " "  A A                  0  DD            0  DD            H DD            D DD            `0` DD            P DD           4<  DD           4<  DD 
+              @ @ @ @ @? @ @ @ @      
+               `@ @ @ @? @ @ @ @                  H                      F                      `                    R   @ @  
+            @ @ @ @ @? @ @ @ @                   P              	                 A w       	                 A w       	            ` $ B   A w       	            ` D "   A w       	                 A w       	            0 "    A w       	                A w       	                A w       
+    
+          @   @ @ @ @9      
+               O  @ @ @ @9                  H                      D                      ` @    @@                   Q8      
+            @   @ @ @ @9      
+             O  @ @ @ @9         	         H0 rv       	         x  rv       	           rv       	            rv       	           rv                      	         hX rv       	         hX rv    	    	              " "  A A         	    	       <        " "  A A         	    	           @ (   " "  A A         	    	           @    " "  A A         	    	                " "  A A                  @                                               @                                                                         DD                DD    	           DD                            hX              hX DD 	    
+           @ ?              	  
+           @                              @ 0                
+               @ @ @ @ @? @ @ @ @           
+                        H                       `                      @                         ` @@@@@@0                                      @  P @@@@@@0              @  `                                                @@@@@@0                `               ` @@@@@@@@@                 @@@@@@@@@                 @0                 @                                       D                        P                      @                        ` p                  p              @  P p               @ P p               0  x            0  x              p              hX P p               $ DD((               <  DD((    
+               @ 0@                           @  @@                	        ~#!!#>                 @  P                      @                         @                                           	                  A w       	                    A w       	                  A w                      	              4 ,   A w         	              4 ,   A w                      @ '@     @        	               @  ! @@@@@!                         @ '@    @@        
+             @   @ @ @ @9           
+          <BBB              @                       @                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 @                       @@                              @@                @@                       P                       PP                              PP                PH                                                                          ``                                                        	                     	                                                                                                                                                                                                                             `   d	)	))                         `         ep
+IH11H!p                          @                         p                         |                         @@                         pP                         |T                                   `                 ``                     ``                 D(D                                  `(80   ``                                
+                               ``    
+       ``                                              P                 @  $|8p                                              @                                   `                      q  @                 
+          r
+"" ""       
+                                                                  PP                                               |8                     @    
+       ``                  ``              |8|8                PP   `@HH                   q         
+                                 ``                \8xT                           	    	                                                                                                          	   
+                                	                 k    k                                                                                                                                                                                                                                                                                                                                                              `                                                                        0P                                        ``                      @@@                    `                    @                                                                                                                                                                 `                     @@@                      `                     `                     0P                                        ``                      @@@                    `                    @                                                                                                                                                         p`                       pp                       ``                      ``                                                                                                                                                                                                
+                    |                      vR|P               f|                 ~``|`````                $`````                       @`````          
+          ffV^NNF                                                                            Fe - ((8        	   
+                                || x               "@@@"                  FLXp|XLFC                  <8                   ? (po<     `               n                  ~B~|@@@@               8t|                 4&BC       
+         fx@@>                |PP<                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                `x@x8{Hx                        `x@xx{H`8x           	         b`>                    a d                           xx?                    @xA`z                        @xA zHHHHx                     |p|       	            ||  
+                g  d                                           h`H@H@@p`        	    
+                " -0      	                                        >"bBBBF                  ~ ~bBBFD                 h       	         08    	    	                      @                      (0PP``@@    
+               H H OHH@H@H@HO           
+                               qq y i0mHeHg0c x        	                > A A >            	             FJqBb    	              	   
+            f       e 6       
+    
+            iHH	  
+ 	  p        	              c                 	   
+                             
+                     @           	                        w                                '(@(@.@(@'                     OII         	    	            I s 2 " 6 4 \ H           
+          
+(HP                 x0@x    
+          <BBB       
+          BBB<                  ~8                               	              	    	              " > A A         	   
+                 ! !             	          r@|    	                   @  @ ?                        8D                8D@@0@|    	   
+                                         |                   0(`   " 8                         p       
+         cuc    	    	                                            xx                                  p ppppp                       ~                              D((        	    	                  5 5 5 5 3        	    	                     
+ 
+ 
+ 
+ 
+       	              	                        
+                 H $  	 	  $ H       
+         8|                                                      <$B    	                 R              	         }                   |                  0P````                (000PPP`                	    
+            y0xLG                                                                                                                                          A B B   1                         " b   1                        A B C 	  1                         " c 	  1                         b  	  1                        1Q   	  1                        A B B 
+	  0                          
+	  0                        A B B 	@	 1                         b  	@	 1                          	@	 1                       !! B BE 	@	 1        	                A B B     0                                              	                                @@           	    	             A A " "            
+                 A@A@"@"@@@@                         AHAH"H"HHHH                         AJAJ"J"JJJJ        
+                                 	          B$$B    
+                 @B@$@@@@$@B@@                         HBH$HHHH$HBHH                            	          <BB<       
+              	                                                                              	                                                DD((    	                    DD((                            DD((                            DD((        	                                                D((D    	                    D((D                            D((D                                      pp               ||                                                      c?           
+                              $$$c?           	          xx                                                                                                                                                                                            
+                    0 ` ` 0                          p          
+                                                        p    
+                    ? aa?                          pp                                     0`                  `0                      	                     B  H            	                    
+  1#                                                                            y            	                     H  H                          pp       	                     	                              p p     	                     A  A           	                      a            	                     @@                        p         	                                                    p                  p  p     	                    @ @             	                                   	                    D D             	                      13             	                     A C             	                     M S 0                        @L(*                  @d$                                  $D`                                    n<                  C@      
+                  @@X 0                                 6 A E@              	                 x ` p X             	                         	                F E   A b <           	                 0 Q Q AA c >           	                      @                 	                         @                                          `          	                                      	                                                                        `     
+                   1 ` ` 0         	                r   " " " " *'        
+                0 ` ` 1            	                  @ @ @  `         	              " w " " " " " "         	                              	                " " " " " " w "         	                    @              	                       @           	                       {            	                      w            	                    
+  1o             	                                                  pPPPPPP    	                                                 PPPPPPP     	                                                pPPPP                   $	                  	$H                    H$	                  	$    	                                    	                                    	                      @  @             	                      _                          p                         p     	                      @  @                          p          	                                                      p     	                                   	                              
+                      ?@@@@?                       (D((((((8    
+                      @@                        8(((((l(                (D(((8 88                (D(((((|                (T((((|                8T88888|                (T(D((((8                (T(D(((|    
+                                  	                                 	                 `0                     (D((((l(    	                     y I;             	               ' /*" " " "  r         	                        	                     D  D            	                                  	                    
+ I K            	                    
+ J  J 
+           	                    * ) )+ (           	                     u W 4           
+                         `               
+                       ~                                     a@@             	    	              A  " " 6                        0Hx                  pXh`                                 $$D@   	                ? C A          	    	                6 " c A A         	    	              A C b " 4            	                ?` @   @ ` ?        	              ?b D   H x ?          	            ~@@>     	                                	                             	                                        
+              
+               	          @ 00`                          	                                	                                              @                @@@`                    8|                     ``                                         H(00               <<H(00               &>H(00       	             tT                      ff                       	                     0   `         	                      $ b        	                  t B t                                         0                                PPPPPXpPPPPP    
+           00pPH       
+           HXP00       
+                   
+           x                (             
+         -$$$$$$$$$                -P$@$@$@$@$@$@$@$@$@@              (  pp   	   
+            + " & ~    ~ $ $                    +P"&@PPP$@$@              (  `(                (  pp               (  pp                                                                                                                     	                                                        	                      y             	                        y               	                         p              	                      q G             	                    p H I 	 	                          @@@@@@@    	                      y             	                        p             	                      }               	                    }              	                                   	                                 	                  &                              qq      	                    } x  0         	                  0   y             	                  0   } p           	                   }               	                                  	                   6     6          	                   6                                                                                                   
+                                    
+                      @ @  @ @          	                      $              	               $                   	                                    	                "                 	            "                     	                $                 	                >                 	               ~  n                 	              6 * * *                 	                                                `@                           	                                                                                       xx     	                  <  <           	                                	                  <  <   0     	                        0                       `9  9p                            9p`9                       ```p```  	                                	                   x           	                      <            	                  |           	                    <           	                   x           	                     <            	                  |          	                    <  0         	                       <        	                 x  y  x          	                      <      	                |  y  x        	                    x            	                   ` 8  0 `          	                  x           	                  0  8  `        	                  x    x       	                  0  8   x       	                  x           	                   d 8  0 `  @ @     	                    @   @ ?          	                                    	                  D   H ?        	                   	   0         	                  ?@   @           	                                   	                 ?D   H          	                   	            	                  ?@   @         	                                   
+           x       
+           x       
+           x                                                                                     	                  	               	                  > I   I >         	                  > A   A >         	                  > A   A >         	                  > A   A >         	                  > A   A >         	                  > A   A >         	                  > I   I >         	                  > A   A >         	                  > A   A >         	                          	                          	                          	                          	                                	                                	                                	                                                                  	                               	                                	                                	                               	                                	                               	                               	                                                            	                           	                                 	                 a9        	                                                     @@                                  @@            	                                   	                                             @@@@@@@@       
+         BFd$,8        
+          8($dDF       
+          BFd$,(                                      
+"B                      
+    1 ! @@@@`                   @@@@` 1    
+     	                > A   	               A >                  00HHHP00                                          @`                                        `   `                          `   `                          ``   1``                           `    1``                           `    1``        	                       0                                                                                                                                      	                     q            	                     CG <                                  c 9 0 0 9 s                                    8 9 sc 9 0                	              x      x  8    	             <        p     	                    x           	                   x  <          	                     <        	                  `  g<  `        	                 |   #  @     	                  4  8  `  @     	                             	                		         	                              	                          	                   x         	                     <        	                  x   x      	                  0  8   x      	                       	                       @ @     	               e9                    @                                                                                  0           	                ?` @@` ?           	            ~B@>     	              ?` @   @ ` ?        	              ?` @   @ ` ?           	          ~ ~@@>     	                ?` @   @ ` ?      	                ?` @  @ ` ?                                       	                               	                 	                                 	                	                                              fFRb|                     l                      0H                 p                             p                       p                     p                @@@@                                                                                                    x                                      x                            	                                                                                                                                                     	                        	                                                                                                                                                                        `                                                                  x@                                  x                              l      d                            hh                           vn                                                            	 H@00`H0            	                ec                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 `                   x 	                    A w                                                                        	            rv                                  
+    
+                             ! ! ?                                                                                                                                                           0      x                                                                                                                                                                                                             ? @@@  @@@@                                                                                                                 `@@@                          @@@`               @@                             0  @@                                                                                  
+         8@    
+         0    
+         @x    
+             
+             
+         @x@    
+                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
+                 @@?@@@@@?           
+                     ?                                                                                                                                                                                                                                                                                                        	                ic                       
+    
+                   ? @A                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                	               8  / 1 ! !! 1 .                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
+               3 @@@A >         
+               3 @@@A >         
+               3 @@@A >         
+               3 @@@A >         
+               3 @@@A >         
+               3 @@@I >         
+               3 ^@@@@@?         
+               3 @@@I >         
+               3 @@@A >         
+               3 @A >                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
+    
+                           
+    
+                                     
+    
+                                 
+    
+                             
+    
+                           
+    
+                       
+    
+                   
+    
+                 
+    
+             	    
+                 
+              
+              
+              
+              
+              
+             
+          	    
+             00     00    0  
+    
+           K@K@K@K@K@K@  
+    
+           {{@@{@@{{@  
+    
+                                       	 
+              
+                    
+                     
+                 
+    
+                     
+    
+                     
+    
+                     
+    
+                  
+                 
+    
+                     
+    
+               
+                      
+                  @@@@@@@@    
+                  @@@@@@@@    
+                  @    
+                  @@@@    
+                  @@@@@@@@    
+                  @@@@    
+                  @@@@@    
+                  @@@@@    
+                  @@       	                   	                
+                                
+                      @@@                                          
+    
+                   ??            
+    
+                   ? @A            
+    
+                     ? ?     
+    
+                    " ! A @                     08x|                     0HH    
+    
+                             
+    
+                                                                       
+    
+                                
+    
+                                
+    
+               ? ?           
+    
+               @@! !                           |x80                     HH0     
+    
+                ??       
+    
+                @@0@@ @@@                       <<                      4$     
+    
+                    @        
+    
+                   @@@@         
+    
+                 ? ?         
+    
+                 ! @@@!         
+    
+                 - ^@^-         
+                  > M@@@\#                   00HHHP00  
+                  > A@@@@#      
+                   A   @@@  @      
+                  > U@@@U7      
+                  > A@@@@#      
+                        
+                  > y@@x;      
+                  > GG'      
+                  > @@#      
+                  > A@?      
+                  > G@@#      
+                  > G?                    8xx8                     
+             
+              @@  
+              @              
+                            @                 0@                      `                                                  @   
+                  > A@ @              
+                            @@#      
+    
+                @ ?    
+    
+                           
+    
+                             
+    
+               ?  @                     `       
+                  @@@@@@@@    
+                      
+                  @@@@@@@@    
+                      
+                  @@@@@@@@    
+    
+                    " - A @    
+    
+                     9 9 xx    
+    
+                    & ' G G                  0@@ @ `  
+                  @@@@@@@@    
+                  @@@@@@@@    
+                  @@@@@@@    
+                  @@@@@@@    
+                  > I@@@#      
+                  > A@@H+      
+                  > A@H+      
+                  > I@@#      
+    
+                             
+    
+                @@@@@@  @      
+    
+                           	                        	                           
+                   
+                
+    
+                @ @@@@@ @@@    
+                  ) .   # @                                    ??        
+                 ?              
+               
+  R  !          
+                       `            
+                    ?   2 !         
+                    A " " > !                       @@     
+                            
+                ? @@@A >         
+                 @@        
+                @a>            	          <|x                      "    p                         ?d;?0;x>?                        $k\7LLG        
+                @@@@@@@        
+                @@@@@@@        
+                @@@@@@@                     P` P     
+          @@@ @ ;@            
+                     ?        
+                 a         
+                 ?         
+                   i{k          
+                     }            
+                              
+                        x           
+                     0                       4    
+                        |                        t    
+                 A A 7 _         
+                ?     0   '<         
+                ? c@_ >         
+                " ! ! ? .@  s           	          |xTxX00       
+          8(                (0       
+       V<88|V                  p          
+                   @@           
+                > `   ` p          
+                 k @@              	          z8    
+                 #|@ @         
+                ? I@@ii          
+                 @@          
+                                    
+                                    
+                                    
+                                    
+                                    
+                                    
+                                    
+                                    
+                 { { T^k {         
+                ? A@@ba          
+                ? A@@La          
+                ? a          
+                 ) .   + @                        p(((0`                 8`P8                xHx x       
+         ||<     
+         <|l  
+                ?@F    F <                      z
+                  HD                RR~RR8(                8WRV<8                    
+              @ @@              
+               @! 6  ! ! ! #          	                " " " " " " >         	                ? X  w~                      ""bH    
+                 J JK@K@J@J@JJ      
+                   " ! "                              [ m I I I I I I H `      
+               @>@@
+@ " @          	                X X h ( '          
+                                             D$$$$D    	                6 MH? A ?         	                o k_ k m 3 ? ?                      |DDD|                 p0XpPP                 pHbB~                 8$D(V    	                6 o{? _ ?         	                / j[ [ = # ? ?                      B|||||                 00Xpppx                 P0|~~>                 <<8~                 8<~T    	                @A "                        8(DBD(    	                    w{                       (DT    
+                w?                         8<~~<    	                > " "  {          	                  8 V 4 , @?                                              ,$                     &"""""b   	                                                                               `        
+          ~       
+              
+                > M 7 @~M 2         
+                  "  E@         
+                  "  E@         
+                  "  M@         
+                  "  U@         
+                  "  ]@         
+                  "  ]@         
+                  "  E@         
+                  "  A@         
+                 7 6 a{?           
+                ? i@H          
+                 @E >         
+                 @A >                      `@@0x    	                        	                        	                        	                        	                        	                        
+                ? @@@A >         
+                ? @@@A >         
+                ?           
+                ?           
+                                        
+                                        
+                                      
+                                      
+                                      
+                                                                   p~~~~     
+                s a@   q          	                   ?   ?                      BD(8nv                  8``8`0    
+                  sb@@        
+                 O    @@                     <$$v8     
+                 a H@A s                       (                  8(zj8                 |(                                                 
+                   * ) A @           	          0``    	              6 I  $ $ > $                          
+? LL@@L?                        ? LL@L |                  
+8LDxx             8px    	            w {  t > " B " 6   >                 8X|8DD8                       0 M@x                
+           xx         
+           xx         
+            ``                      ||       	                    H                                  q                	                    ~ ~                             pPPP         
+         ||                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
+                   p 0                	                   f                
+                     B H  p                                ` ~ a@                           	               c  Q >         	               c  A >         	                                	                                                                          
+                   > IXt                        pj6                           @                           +Vp     	                    |                	                                                   @                   \xp`                   l88l     	                " w  > >  c                        f,88h                |x8|    	                < , o ,          	                              	                               	                                                            xHHH8                 xXXX8    	                >   >         	                  c B c           	                              	                             	                             	                < K k            	                   >               	                   " C 4                                             
+  @!! ${        	               w  ] >                            s!   !                          
+  ^// ${                           w.  + 1                            {%   !                            '  + 1                             !# - ; 0        	                 Y  >           	                  6 $ w           	                 I *   * I          
+                  %    5           	                k ^ n v V y          	                  I >  >            	                 J >   > * I          	                { >  > ~ I          	               * >  >  *          	                , ]   > ] *         	                             	                             	                  \           	                   ]          	                  C c  v         	                 $  ] I v         	                    ^         	               w   ~         	                   T          	                 > k   k           	                 > k   * .          	                 I I _          	                             	                 I * <  * I          	                 ] 2 , * ]          	                K *  $ { I          	                k * < k I                         
+              < C @@@@                        
+                @@@@@@@      
+              @@@@@@@@        
+                @@@@@@@      
+              @@@@@@@@                                                     
+                  ? o                                                                               @                      @                      H                      H                                                  ~|ddLx               p   ppp                L|0888    	                   >                          p|>p                 y>~~<2    	                    L l N                          ``                00               00``````00              ``0000000p``              00````00             ``0000``             8p`p88             p0888p             88pppp88             pp8888pp              @@              @@@@@@@@@@@             800000000              p0000<000p  
+               ? w >         
+               ? c >         
+               ? a >         
+               ? { >         
+               ? a >         
+               ? cK >         
+               ? a >         
+               ? s >         
+               ? y|t?         
+               ? o@@@ >                         $\@    @_@                        ,S@    @_@                        .S@    @^@                        "F@    @B@                        >P@    @^@                        &X@    @N@                        ?A@    @H@                        .Q@    @^@                        ,[@    @^@                        3T[@                        ;k{`?                       3lwh?                       1l~a?                       =}}}?                       !o~a?                       9gnq?                        ~{w?                       1nna?                       3d~a?                       .m@o@D@?       	                                                                                             `0     	                                                   0`    	                                      	                                  	                                  	                                  	                      //            	                     .  .            	                                  	                    @ 8   0            	                    @ 8  " \            	                  @ p < ? ? < p @         	                                  	                                                        	                                      	                                   	                                   
+                    ~@@@          
+                     @@@@?@                                               	                                                 	                       ~                         ||    	                                                    0x8     	                       y                              8x0                    x8     	                                                     8x     	                                   	                      b                 	                       y             	                      }             	                    
+  x z 
+                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       0(HDHH00                                                                                                       PPPPPPPPPP                @@@@@@                @@@  @@@              ((PPPPPP((              PPP((PPP                                                              	                6 w U U U U         	                U U U U U 6                             @\@8 @ @                            6 E G@CA b >                              %DDD%                                     @  @                                                                                                   0 ` ` 0                                                                                                                                                                                               @  @                                                                                                                                                                                     WW                       
+                          
+                        
+                        
+                      
+                        
+                      
+                      
+                    
+                        
+                        
+                      
+                      
+                      
+                      
+                    
+                    
+                        
+                      
+                        
+                      
+                      
+                    
+                      
+                    
+                      
+                      
+                      
+                      
+                    
+                    
+                    
+                    
+                        
+                      
+                      
+                    
+                        
+                      
+                      
+                    
+                      
+                      
+                    
+                    
+                      
+                      
+                    
+                    
+                      
+                    
+                      
+                    
+                      
+                    
+                      
+                    
+                    
+                    
+                    
+                    
+                    
+                    
+                    
+                    
+                        
+                      
+                      
+                    
+                      
+                    
+                    
+                  
+                      
+                      
+                    
+                    
+                    
+                    
+                  
+                  
+                      
+                    
+                      
+                    
+                    
+                  
+                    
+                  
+                    
+                    
+                    
+                    
+                  
+                  
+                  
+                  
+                      
+                    
+                    
+                  
+                      
+                    
+                    
+                  
+                    
+                    
+                  
+                  
+                    
+                    
+                  
+                  
+                    
+                  
+                    
+                  
+                    
+                  
+                    
+                  
+                  
+                  
+                  
+                  
+                  
+                  
+                  
+                  
+                        
+                      
+                      
+                    
+                      
+                    
+                    
+                  
+                      
+                      
+                    
+                    
+                    
+                    
+                  
+                  
+                      
+                    
+                      
+                    
+                    
+                  
+                    
+                  
+                    
+                    
+                    
+                    
+                  
+                  
+                  
+                  
+                      
+                    
+                    
+                  
+                      
+                    
+                    
+                  
+                    
+                    
+                  
+                  
+                    
+                    
+                  
+                  
+                    
+                  
+                    
+                  
+                    
+                  
+                    
+                  
+                  
+                  
+                  
+                  
+                  
+                  
+                  
+                  
+                        
+                      
+                      
+                    
+                      
+                    
+                    
+                  
+                      
+                      
+                    
+                    
+                    
+                    
+                  
+                  
+                      
+                    
+                      
+                    
+                    
+                  
+                    
+                  
+                    
+                    
+                    
+                    
+                  
+                  
+                  
+                  
+                      
+                    
+                    
+                  
+                      
+                    
+                    
+                  
+                    
+                    
+                  
+                  
+                    
+                    
+                  
+                  
+                    
+                  
+                    
+                  
+                    
+                  
+                    
+                  
+                  
+                  
+                  
+                  
+                  
+                  
+                  
+                                                                                                         	                                	                                                                            8|TTTTT                 TTTTTT8                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    	        >MEAAc>         	        >YQAAc>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
+         <PPPPPPPPP<     
+         PPPPHLPPPP                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         	                   q9                                                                               `   `                          ``                          ``                          `   `                          ``1``                                                                                                                                                                                                                                                                                                                                                08x||x80                                                                                                                                                                                                                                                                                                                                @@@`00`                   " BBBb02`                     PPHHpp0`                                                                                                                                                        $-Z$H$H$H$H$H$H$H$H$Hh              (                     (                    (   8`                (  pp               (   (`               (  8(8               (  0(0               (  88               (  pp               (                  PRP`             (  p`                (  p               (  `              (                      (                                                                                                                                                                                                                                                                                                      D((D                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        	                     p        	                      <        	                     q        	                      <        	                   #  p        	                      <        	                   p        	                    <        	                 x         	                   <        	                   x           	                     <          	                 x       	                   <      	              |         | >   	                x        >   	                 x           	                   <          	                <   }  |     	               | >    }   <   	                  x         	                   |       	                | < > > <    	                  >  >    	                   q p  8         	                   <  8  p        	                   q p  9         	                   <  8  p        	                    <  <         	                                	                < < <  <         	                              	                   0            	                   0 <  x          	                 0          	                 0 x  x                                                                                                                                                                                                           	                   6               	                  x            	                  0  8           	                  x         	                  0  8         	                   |         	                   p  `        	                   |    0     	                   p  `   0     	                       0 0     	                 ` < 8   0 0     	                      4 8    	                 ` < 8   4 8                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      	                   x    <     	                     < < <                                                                                               	$H`                  $	                  `H$	                  	$    
+                      ?@@@@?           
+                      ?0                        8|8888888                 888888|8                  <x`                  <                  `x<                  <    
+                      ?1                       8|8888|8    	                          
+          	                    
+                 
+                           x 0         
+                   0 x T                 
+                  @@@@    
+                  @@@@    
+                  @    
+                  @@@@@@@    
+    
+                 9 x@x9         
+    
+                 ' GG'         
+    
+                 ? @!         
+    
+                 ! @@?         
+                  @    @  @@  @@                                                                                                0@@  @@@@@@?        	                ac        	                ?                         ????                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          ````p``~                 @@@@@`@@@                  ``````~                  ~bb~````                 p                 ~
+vRfz                PP```@@   	   
+                                          	                          	   	                 0   @                      @                                                                                                                          tXp0       	                                    	            \|                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
\ No newline at end of file
diff --git a/xrdp/xrdp.c b/xrdp/xrdp.c
index f3ecb38..344a80b 100644
--- a/xrdp/xrdp.c
+++ b/xrdp/xrdp.c
@@ -14,7 +14,7 @@
    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
 
    xrdp: A Remote Desktop Protocol server.
-   Copyright (C) Jay Sorg 2004-2007
+   Copyright (C) Jay Sorg 2004-2008
 
    main program
 
@@ -32,10 +32,10 @@ static long g_threadid = 0; /* main threadid */
 static SERVICE_STATUS_HANDLE g_ssh = 0;
 static SERVICE_STATUS g_service_status;
 #endif
-static long g_term_mutex = 0;
 static long g_sync_mutex = 0;
 static long g_sync1_mutex = 0;
-static int g_term = 0;
+static tbus g_term_event = 0;
+static tbus g_sync_event = 0;
 /* syncronize stuff */
 static int g_sync_command = 0;
 static long g_sync_result = 0;
@@ -51,23 +51,32 @@ g_xrdp_sync(long (*sync_func)(long param1, long param2), long sync_param1,
   long sync_result;
   int sync_command;
 
-  tc_mutex_lock(g_sync1_mutex);
-  tc_mutex_lock(g_sync_mutex);
-  g_sync_param1 = sync_param1;
-  g_sync_param2 = sync_param2;
-  g_sync_func = sync_func;
-  g_sync_command = 100;
-  tc_mutex_unlock(g_sync_mutex);
-  do
+  if (tc_threadid_equal(tc_get_threadid(), g_threadid))
   {
-    g_sleep(100);
+    /* this is the main thread, call the function directly */
+    sync_result = sync_func(sync_param1, sync_param2);
+  }
+  else
+  {
+    tc_mutex_lock(g_sync1_mutex);
     tc_mutex_lock(g_sync_mutex);
-    sync_command = g_sync_command;
-    sync_result = g_sync_result;
+    g_sync_param1 = sync_param1;
+    g_sync_param2 = sync_param2;
+    g_sync_func = sync_func;
+    g_sync_command = 100;
     tc_mutex_unlock(g_sync_mutex);
+    g_set_wait_obj(g_sync_event);
+    do
+    {
+      g_sleep(100);
+      tc_mutex_lock(g_sync_mutex);
+      sync_command = g_sync_command;
+      sync_result = g_sync_result;
+      tc_mutex_unlock(g_sync_mutex);
+    }
+    while (sync_command != 0);
+    tc_mutex_unlock(g_sync1_mutex);
   }
-  while (sync_command != 0);
-  tc_mutex_unlock(g_sync1_mutex);
   return sync_result;
 }
 
@@ -75,45 +84,50 @@ g_xrdp_sync(long (*sync_func)(long param1, long param2), long sync_param1,
 void DEFAULT_CC
 xrdp_shutdown(int sig)
 {
-  struct xrdp_listen* listen;
+  tbus threadid;
 
-  if (tc_get_threadid() != g_threadid)
-  {
-    return;
-  }
+  threadid = tc_get_threadid();
   g_writeln("shutting down");
-  g_writeln("signal %d threadid $%8.8x", sig, tc_get_threadid());
-  listen = g_listen;
-  g_listen = 0;
-  if (listen != 0)
+  g_writeln("signal %d threadid %p", sig, threadid);
+  if (!g_is_wait_obj_set(g_term_event))
   {
-    g_set_term(1);
-    g_sleep(1000);
-    xrdp_listen_delete(listen);
+    g_set_wait_obj(g_term_event);
   }
-  /* delete the xrdp.pid file */
-  g_file_delete(XRDP_PID_FILE);
 }
 
 /*****************************************************************************/
 int APP_CC
 g_is_term(void)
 {
-  int rv;
-
-  tc_mutex_lock(g_term_mutex);
-  rv = g_term;
-  tc_mutex_unlock(g_term_mutex);
-  return rv;
+  return g_is_wait_obj_set(g_term_event);
 }
 
 /*****************************************************************************/
 void APP_CC
 g_set_term(int in_val)
 {
-  tc_mutex_lock(g_term_mutex);
-  g_term = in_val;
-  tc_mutex_unlock(g_term_mutex);
+  if (in_val)
+  {
+    g_set_wait_obj(g_term_event);
+  }
+  else
+  {
+    g_reset_wait_obj(g_term_event);
+  }
+}
+
+/*****************************************************************************/
+tbus APP_CC
+g_get_term_event(void)
+{
+  return g_term_event;
+}
+
+/*****************************************************************************/
+tbus APP_CC
+g_get_sync_event(void)
+{
+  return g_sync_event;
 }
 
 /*****************************************************************************/
@@ -202,9 +216,10 @@ MyServiceMain(DWORD dwArgc, LPTSTR* lpszArgv)
   g_set_current_dir("c:\\temp\\xrdp");
   g_listen = 0;
   WSAStartup(2, &w);
-  g_term_mutex = tc_mutex_create();
   g_sync_mutex = tc_mutex_create();
   g_sync1_mutex = tc_mutex_create();
+  g_term_event = g_create_wait_obj("xrdp_main_term");
+  g_sync_event = g_create_wait_obj("xrdp_main_sync");
   g_memset(&g_service_status, 0, sizeof(SERVICE_STATUS));
   g_service_status.dwServiceType = SERVICE_WIN32_OWN_PROCESS;
   g_service_status.dwCurrentState = SERVICE_RUNNING;
@@ -234,11 +249,12 @@ MyServiceMain(DWORD dwArgc, LPTSTR* lpszArgv)
     //g_sprintf(text, "RegisterServiceCtrlHandler failed\r\n");
     //g_file_write(fd, text, g_strlen(text));
   }
-  WSACleanup();
-  tc_mutex_delete(g_term_mutex);
+  xrdp_listen_delete(g_listen);
   tc_mutex_delete(g_sync_mutex);
   tc_mutex_delete(g_sync1_mutex);
-  xrdp_listen_delete(g_listen);
+  g_destroy_wait_obj(g_term_event);
+  g_destroy_wait_obj(g_sync_event);
+  WSACleanup();
   //CloseHandle(event_han);
 }
 
@@ -262,6 +278,7 @@ main(int argc, char** argv)
   char text[32];
 #endif
 
+  g_init();
   /* check compiled endian with actual endian */
   test = 1;
   host_be = !((int)(*(unsigned char*)(&test)));
@@ -301,7 +318,7 @@ main(int argc, char** argv)
     {
       g_writeln("");
       g_writeln("xrdp: A Remote Desktop Protocol server.");
-      g_writeln("Copyright (C) Jay Sorg 2004-2005");
+      g_writeln("Copyright (C) Jay Sorg 2004-2008");
       g_writeln("See http://xrdp.sourceforge.net for more information.");
       g_writeln("");
       g_writeln("Usage: xrdp [options]");
@@ -394,8 +411,9 @@ main(int argc, char** argv)
   no_daemon = 0;
   if (argc == 2)
   {
-    if (g_strncasecmp(argv[1], "-kill", 255) == 0 ||
-        g_strncasecmp(argv[1], "--kill", 255) == 0)
+    if ((g_strncasecmp(argv[1], "-kill", 255) == 0) ||
+        (g_strncasecmp(argv[1], "--kill", 255) == 0) ||
+        (g_strncasecmp(argv[1], "-k", 255) == 0))
     {
       g_writeln("stopping xrdp");
       /* read the xrdp.pid file */
@@ -425,10 +443,10 @@ main(int argc, char** argv)
     }
     else if (g_strncasecmp(argv[1], "-nodaemon", 255) == 0 ||
              g_strncasecmp(argv[1], "--nodaemon", 255) == 0 ||
-	     g_strncasecmp(argv[1], "-nd", 255) == 0 ||
-	     g_strncasecmp(argv[1], "--nd", 255) == 0 ||
-	     g_strncasecmp(argv[1], "-ns", 255) == 0 ||
-	     g_strncasecmp(argv[1], "--ns", 255) == 0)
+             g_strncasecmp(argv[1], "-nd", 255) == 0 ||
+             g_strncasecmp(argv[1], "--nd", 255) == 0 ||
+             g_strncasecmp(argv[1], "-ns", 255) == 0 ||
+             g_strncasecmp(argv[1], "--ns", 255) == 0)
     {
       no_daemon = 1;
     }
@@ -438,7 +456,7 @@ main(int argc, char** argv)
     {
       g_writeln("");
       g_writeln("xrdp: A Remote Desktop Protocol server.");
-      g_writeln("Copyright (C) Jay Sorg 2004-2005");
+      g_writeln("Copyright (C) Jay Sorg 2004-2008");
       g_writeln("See http://xrdp.sourceforge.net for more information.");
       g_writeln("");
       g_writeln("Usage: xrdp [options]");
@@ -448,6 +466,17 @@ main(int argc, char** argv)
       g_writeln("");
       g_exit(0);
     }
+    else if ((g_strncasecmp(argv[1], "-v", 255) == 0) ||
+             (g_strncasecmp(argv[1], "--version", 255) == 0))
+    {
+      g_writeln("");
+      g_writeln("xrdp: A Remote Desktop Protocol server.");
+      g_writeln("Copyright (C) Jay Sorg 2004-2008");
+      g_writeln("See http://xrdp.sourceforge.net for more information.");
+      g_writeln("Version 0.5.0");
+      g_writeln("");
+      g_exit(0);
+    }
     else
     {
       g_writeln("Unknown Parameter");
@@ -471,6 +500,23 @@ main(int argc, char** argv)
   }
   if (!no_daemon)
   {
+    /* make sure we can write to pid file */
+    fd = g_file_open(XRDP_PID_FILE); /* xrdp.pid */
+    if (fd == -1)
+    {
+      g_writeln("running in daemon mode with no access to pid files, quitting");
+      g_exit(0);
+    }
+    if (g_file_write(fd, "0", 1) == -1)
+    {
+      g_writeln("running in daemon mode with no access to pid files, quitting");
+      g_exit(0);
+    }
+    g_file_close(fd);
+    g_file_delete(XRDP_PID_FILE);
+  }
+  if (!no_daemon)
+  {
     /* start of daemonizing code */
     pid = g_fork();
     if (pid == -1)
@@ -493,21 +539,24 @@ main(int argc, char** argv)
     g_file_open("/dev/null");
     /* end of daemonizing code */
   }
-  /* write the pid to file */
-  pid = g_getpid();
-  fd = g_file_open(XRDP_PID_FILE); /* xrdp.pid */
-  if (fd == -1)
-  {
-    g_writeln("trying to write process id to xrdp.pid");
-    g_writeln("problem opening xrdp.pid");
-    g_writeln("maybe no rights");
-  }
-  else
+  if (!no_daemon)
   {
-    g_set_file_rights(XRDP_PID_FILE, 1, 1); /* xrdp.pid */
-    g_sprintf(text, "%d", pid);
-    g_file_write(fd, text, g_strlen(text));
-    g_file_close(fd);
+    /* write the pid to file */
+    pid = g_getpid();
+    fd = g_file_open(XRDP_PID_FILE); /* xrdp.pid */
+    if (fd == -1)
+    {
+      g_writeln("trying to write process id to xrdp.pid");
+      g_writeln("problem opening xrdp.pid");
+      g_writeln("maybe no rights");
+    }
+    else
+    {
+      g_set_file_rights(XRDP_PID_FILE, 1, 1); /* xrdp.pid */
+      g_sprintf(text, "%d", pid);
+      g_file_write(fd, text, g_strlen(text));
+      g_file_close(fd);
+    }
   }
 #endif
   g_threadid = tc_get_threadid();
@@ -516,17 +565,27 @@ main(int argc, char** argv)
   g_signal(9, xrdp_shutdown); /* SIGKILL */
   g_signal(13, pipe_sig); /* sig pipe */
   g_signal(15, xrdp_shutdown); /* SIGTERM */
-  g_term_mutex = tc_mutex_create();
   g_sync_mutex = tc_mutex_create();
   g_sync1_mutex = tc_mutex_create();
+  g_term_event = g_create_wait_obj("xrdp_main_term");
+  g_sync_event = g_create_wait_obj("xrdp_main_sync");
+  if (g_term_event == 0)
+  {
+    g_writeln("error creating g_term_event");
+  }
   xrdp_listen_main_loop(g_listen);
-  tc_mutex_delete(g_term_mutex);
+  xrdp_listen_delete(g_listen);
   tc_mutex_delete(g_sync_mutex);
   tc_mutex_delete(g_sync1_mutex);
+  g_delete_wait_obj(g_term_event);
+  g_delete_wait_obj(g_sync_event);
 #if defined(_WIN32)
   /* I don't think it ever gets here */
+  /* when running in win32 app mode, control c exits right away */
   WSACleanup();
-  xrdp_listen_delete(g_listen);
+#else
+  /* delete the xrdp.pid file */
+  g_file_delete(XRDP_PID_FILE);
 #endif
   return 0;
 }
diff --git a/xrdp/xrdp.h b/xrdp/xrdp.h
index c1a9990..94e6ed5 100644
--- a/xrdp/xrdp.h
+++ b/xrdp/xrdp.h
@@ -14,13 +14,16 @@
    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
 
    xrdp: A Remote Desktop Protocol server.
-   Copyright (C) Jay Sorg 2004-2007
+   Copyright (C) Jay Sorg 2004-2008
 
    main include file
 
 */
 
 /* include other h files */
+#if defined(HAVE_CONFIG_H)
+#include "config_ac.h"
+#endif
 #include "arch.h"
 #include "parse.h"
 #include "libxrdpinc.h"
@@ -32,6 +35,7 @@
 #include "thread_calls.h"
 #include "list.h"
 #include "file.h"
+#include "file_loc.h"
 
 /* xrdp.c */
 long APP_CC
@@ -41,6 +45,10 @@ int APP_CC
 g_is_term(void);
 void APP_CC
 g_set_term(int in_val);
+tbus APP_CC
+g_get_term_event(void);
+tbus APP_CC
+g_get_sync_event(void);
 void APP_CC
 g_loop(void);
 
@@ -67,6 +75,9 @@ int APP_CC
 xrdp_cache_add_pointer_static(struct xrdp_cache* self,
                               struct xrdp_pointer_item* pointer_item,
                               int index);
+int APP_CC
+xrdp_cache_add_brush(struct xrdp_cache* self,
+                     char* brush_item_data);
 
 /* xrdp_wm.c */
 struct xrdp_wm* APP_CC
@@ -113,15 +124,20 @@ callback(long id, int msg, long param1, long param2, long param3, long param4);
 int APP_CC
 xrdp_wm_delete_all_childs(struct xrdp_wm* self);
 int APP_CC
-xrdp_wm_idle(struct xrdp_wm* self);
-int APP_CC
 xrdp_wm_app_sck_signal(struct xrdp_wm* self, int app_sck);
 int APP_CC
 xrdp_wm_log_msg(struct xrdp_wm* self, char* msg);
+int APP_CC
+xrdp_wm_get_wait_objs(struct xrdp_wm* self, tbus* robjs, int* rc,
+                      tbus* wobjs, int* wc, int* timeout);
+int APP_CC
+xrdp_wm_check_wait_objs(struct xrdp_wm* self);
+int APP_CC
+xrdp_wm_set_login_mode(struct xrdp_wm* self, int login_mode);
 
 /* xrdp_process.c */
 struct xrdp_process* APP_CC
-xrdp_process_create(struct xrdp_listen* owner);
+xrdp_process_create(struct xrdp_listen* owner, tbus done_event);
 void APP_CC
 xrdp_process_delete(struct xrdp_process* self);
 int APP_CC
@@ -133,8 +149,6 @@ xrdp_listen_create(void);
 void APP_CC
 xrdp_listen_delete(struct xrdp_listen* self);
 int APP_CC
-xrdp_listen_delete_pro(struct xrdp_listen* self, struct xrdp_process* pro);
-int APP_CC
 xrdp_listen_main_loop(struct xrdp_listen* self);
 
 /* xrdp_region.c */
@@ -283,17 +297,21 @@ rect_contained_by(struct xrdp_rect* in1, int left, int top,
 int APP_CC
 check_bounds(struct xrdp_bitmap* b, int* x, int* y, int* cx, int* cy);
 int APP_CC
-add_char_at(char* text, char ch, int index);
+add_char_at(char* text, int text_size, twchar ch, int index);
 int APP_CC
-remove_char_at(char* text, int index);
+remove_char_at(char* text, int text_size, int index);
 int APP_CC
 set_string(char** in_str, const char* in);
+int APP_CC
+wchar_repeat(twchar* dest, int dest_size_in_wchars, twchar ch, int repeat);
 
 /* in lang.c */
-char APP_CC
+twchar APP_CC
 get_char_from_scan_code(int device_flags, int scan_code, int* keys,
                         int caps_lock, int num_lock, int scroll_lock,
-                        int keylayout);
+                        struct xrdp_keymap* keymap);
+int APP_CC
+get_keymaps(int keylayout, struct xrdp_keymap* keymap);
 
 /* xrdp_login_wnd.c */
 int APP_CC
diff --git a/xrdp/xrdp_bitmap.c b/xrdp/xrdp_bitmap.c
index 69dd7e6..b3d7162 100644
--- a/xrdp/xrdp_bitmap.c
+++ b/xrdp/xrdp_bitmap.c
@@ -14,7 +14,7 @@
    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
 
    xrdp: A Remote Desktop Protocol server.
-   Copyright (C) Jay Sorg 2004-2007
+   Copyright (C) Jay Sorg 2004-2008
 
    bitmap, drawable
    this is a object that can be drawn on with a painter
@@ -265,14 +265,14 @@ xrdp_bitmap_set_focus(struct xrdp_bitmap* self, int focused)
     /* active title bar */
     painter->fg_color = self->wm->blue;
     xrdp_painter_fill_rect(painter, self, 3, 3, self->width - 5, 18);
-    painter->font->color = self->wm->white;
+    painter->fg_color = self->wm->white;
   }
   else
   {
     /* inactive title bar */
     painter->fg_color = self->wm->dark_grey;
     xrdp_painter_fill_rect(painter, self, 3, 3, self->width - 5, 18);
-    painter->font->color = self->wm->black;
+    painter->fg_color = self->wm->black;
   }
   xrdp_painter_draw_text(painter, self, 4, 4, self->caption1);
   xrdp_painter_end_update(painter);
@@ -298,15 +298,20 @@ xrdp_bitmap_get_index(struct xrdp_bitmap* self, int* palette, int color)
 }
 
 /*****************************************************************************/
+/* returns error */
 int APP_CC
 xrdp_bitmap_resize(struct xrdp_bitmap* self, int width, int height)
 {
   int Bpp;
 
-  if (width == self->width && height == self->height)
+  if ((width == self->width) && (height == self->height))
   {
     return 0;
   }
+  if (self->do_not_free_data)
+  {
+    return 1;
+  }
   self->width = width;
   self->height = height;
   Bpp = 4;
@@ -316,11 +321,8 @@ xrdp_bitmap_resize(struct xrdp_bitmap* self, int width, int height)
     case 15: Bpp = 2; break;
     case 16: Bpp = 2; break;
   }
-  if (self->data != 0)
-  {
-    g_free(self->data);
-    self->data = (char*)g_malloc(width * height * Bpp, 1);
-  }
+  g_free(self->data);
+  self->data = (char*)g_malloc(width * height * Bpp, 0);
   self->line_size = width * Bpp;
   return 0;
 }
@@ -344,6 +346,12 @@ xrdp_bitmap_load(struct xrdp_bitmap* self, const char* filename, int* palette)
   struct xrdp_bmp_header header;
   struct stream* s;
 
+  if (!g_file_exist(filename))
+  {
+    g_writeln("xrdp_bitmap_load: error bitmap file [%s] does not exist",
+              filename);
+    return 1;
+  }
   s = 0;
   fd = g_file_open(filename);
   if (fd != -1)
@@ -888,6 +896,7 @@ xrdp_bitmap_invalidate(struct xrdp_bitmap* self, struct xrdp_rect* rect)
   struct xrdp_rect r1;
   struct xrdp_rect r2;
   struct xrdp_painter* painter;
+  twchar wtext[256];
   char text[256];
   char* p;
 
@@ -949,14 +958,14 @@ xrdp_bitmap_invalidate(struct xrdp_bitmap* self, struct xrdp_rect* rect)
       /* active title bar */
       painter->fg_color = self->wm->blue;
       xrdp_painter_fill_rect(painter, self, 3, 3, self->width - 5, 18);
-      painter->font->color = self->wm->white;
+      painter->fg_color = self->wm->white;
     }
     else
     {
       /* inactive title bar */
       painter->fg_color = self->wm->dark_grey;
       xrdp_painter_fill_rect(painter, self, 3, 3, self->width - 5, 18);
-      painter->font->color = self->wm->black;
+      painter->fg_color = self->wm->black;
     }
     xrdp_painter_draw_text(painter, self, 4, 4, self->caption1);
   }
@@ -1005,14 +1014,20 @@ xrdp_bitmap_invalidate(struct xrdp_bitmap* self, struct xrdp_rect* rect)
                               self->width, self->height, 0);
       w = xrdp_painter_text_width(painter, self->caption1);
       h = xrdp_painter_text_height(painter, self->caption1);
-      painter->font->color = self->wm->black;
+      painter->fg_color = self->wm->black;
       xrdp_painter_draw_text(painter, self, self->width / 2 - w / 2,
                              self->height / 2 - h / 2, self->caption1);
       if (self->parent != 0)
+      {
         if (self->wm->focused_window == self->parent)
+        {
           if (self->parent->focused_control == self)
+          {
             xrdp_bitmap_draw_focus_box(self, painter, 4, 4, self->width - 8,
                                        self->height - 8);
+          }
+        }
+      }
     }
     else if (self->state == BUTTON_STATE_DOWN) /* 1 */
     {
@@ -1020,7 +1035,7 @@ xrdp_bitmap_invalidate(struct xrdp_bitmap* self, struct xrdp_rect* rect)
                               self->width, self->height, 1);
       w = xrdp_painter_text_width(painter, self->caption1);
       h = xrdp_painter_text_height(painter, self->caption1);
-      painter->font->color = self->wm->black;
+      painter->fg_color = self->wm->black;
       xrdp_painter_draw_text(painter, self, (self->width / 2 - w / 2) + 1,
                              (self->height / 2 - h / 2) + 1, self->caption1);
       if (self->parent != 0)
@@ -1066,13 +1081,15 @@ xrdp_bitmap_invalidate(struct xrdp_bitmap* self, struct xrdp_rect* rect)
     painter->fg_color = self->wm->black;
     if (self->password_char != 0)
     {
-      i = g_strlen(self->caption1);
+      i = g_mbstowcs(0, self->caption1, 0);
       g_memset(text, self->password_char, i);
       text[i] = 0;
       xrdp_painter_draw_text(painter, self, 4, 2, text);
     }
     else
+    {
       xrdp_painter_draw_text(painter, self, 4, 2, self->caption1);
+    }
     /* draw xor box(cursor) */
     if (self->parent != 0)
     {
@@ -1080,11 +1097,16 @@ xrdp_bitmap_invalidate(struct xrdp_bitmap* self, struct xrdp_rect* rect)
       {
         if (self->password_char != 0)
         {
-          g_memset(text, self->password_char, self->edit_pos);
-          text[self->edit_pos] = 0;
+          wchar_repeat(wtext, 255, self->password_char, self->edit_pos);
+          wtext[self->edit_pos] = 0;
+          g_wcstombs(text, wtext, 255);
         }
         else
-          g_strncpy(text, self->caption1, self->edit_pos);
+        {
+          g_mbstowcs(wtext, self->caption1, 255);
+          wtext[self->edit_pos] = 0;
+          g_wcstombs(text, wtext, 255);
+        }
         w = xrdp_painter_text_width(painter, text);
         painter->fg_color = self->wm->white;
         painter->rop = 0x5a;
@@ -1096,7 +1118,7 @@ xrdp_bitmap_invalidate(struct xrdp_bitmap* self, struct xrdp_rect* rect)
   }
   else if (self->type == WND_TYPE_LABEL) /* 6 */
   {
-    painter->font->color = self->wm->black;
+    painter->fg_color = self->wm->black;
     xrdp_painter_draw_text(painter, self, 0, 0, self->caption1);
   }
   else if (self->type == WND_TYPE_COMBO) /* 7 combo box */
@@ -1134,9 +1156,13 @@ xrdp_bitmap_invalidate(struct xrdp_bitmap* self, struct xrdp_rect* rect)
     xrdp_painter_fill_rect(painter, self, 1, 1, self->width - 2, 1);
     /* draw text */
     if (self->parent->focused_control == self)
-      painter->font->color = self->wm->white;
+    {
+      painter->fg_color = self->wm->white;
+    }
     else
-      painter->font->color = self->wm->black;
+    {
+      painter->fg_color = self->wm->black;
+    }
     xrdp_painter_draw_text(painter, self, 4, 2,
             (char*)list_get_item(self->string_list, self->item_index));
     /* draw button on right */
@@ -1145,9 +1171,13 @@ xrdp_bitmap_invalidate(struct xrdp_bitmap* self, struct xrdp_rect* rect)
     w = (self->width - x) - 2;
     h = self->height - 4;
     if (self->state == BUTTON_STATE_UP) /* 0 */
+    {
       xrdp_bitmap_draw_button(self, painter, x, y, w, h, 0);
+    }
     else
+    {
       xrdp_bitmap_draw_button(self, painter, x, y, w, h, 1);
+    }
   }
   else if (self->type == WND_TYPE_SPECIAL) /* 8 special */
   {
@@ -1166,10 +1196,12 @@ xrdp_bitmap_invalidate(struct xrdp_bitmap* self, struct xrdp_rect* rect)
         {
           painter->fg_color = self->wm->blue;
           xrdp_painter_fill_rect(painter, self, 0, y, self->width, h);
-          painter->font->color = self->wm->white;
+          painter->fg_color = self->wm->white;
         }
         else
-          painter->font->color = self->wm->black;
+        {
+          painter->fg_color = self->wm->black;
+        }
         xrdp_painter_draw_text(painter, self, 2, y, p);
         y = y + h;
       }
@@ -1177,13 +1209,17 @@ xrdp_bitmap_invalidate(struct xrdp_bitmap* self, struct xrdp_rect* rect)
   }
   /* notify */
   if (self->notify != 0)
+  {
     self->notify(self, self, WM_PAINT, (long)painter, 0); /* 3 */
+  }
   /* draw any child windows in the area */
   for (i = 0; i < self->child_list->count; i++)
   {
     b = (struct xrdp_bitmap*)list_get_item(self->child_list, i);
     if (rect == 0)
+    {
       xrdp_bitmap_invalidate(b, 0);
+    }
     else
     {
       MAKERECT(r1, b->left, b->top, b->width, b->height);
@@ -1205,7 +1241,7 @@ int APP_CC
 xrdp_bitmap_def_proc(struct xrdp_bitmap* self, int msg,
                      int param1, int param2)
 {
-  char c;
+  twchar c;
   int n;
   int i;
   int shift;
@@ -1334,7 +1370,7 @@ xrdp_bitmap_def_proc(struct xrdp_bitmap* self, int msg,
       else if ((scan_code == 77 || scan_code == 80) &&
                (ext || self->wm->num_lock == 0))
       {
-        if (self->edit_pos < g_strlen(self->caption1))
+        if (self->edit_pos < g_mbstowcs(0, self->caption1, 0))
         {
           self->edit_pos++;
           xrdp_bitmap_invalidate(self, 0);
@@ -1343,13 +1379,13 @@ xrdp_bitmap_def_proc(struct xrdp_bitmap* self, int msg,
       /* backspace */
       else if (scan_code == 14)
       {
-        n = g_strlen(self->caption1);
+        n = g_mbstowcs(0, self->caption1, 0);
         if (n > 0)
         {
           if (self->edit_pos > 0)
           {
             self->edit_pos--;
-            remove_char_at(self->caption1, self->edit_pos);
+            remove_char_at(self->caption1, 255, self->edit_pos);
             xrdp_bitmap_invalidate(self, 0);
           }
         }
@@ -1358,12 +1394,12 @@ xrdp_bitmap_def_proc(struct xrdp_bitmap* self, int msg,
       else if (scan_code == 83  &&
               (ext || self->wm->num_lock == 0))
       {
-        n = g_strlen(self->caption1);
+        n = g_mbstowcs(0, self->caption1, 0);
         if (n > 0)
         {
           if (self->edit_pos < n)
           {
-            remove_char_at(self->caption1, self->edit_pos);
+            remove_char_at(self->caption1, 255, self->edit_pos);
             xrdp_bitmap_invalidate(self, 0);
           }
         }
@@ -1372,7 +1408,7 @@ xrdp_bitmap_def_proc(struct xrdp_bitmap* self, int msg,
       else if (scan_code == 79  &&
               (ext || self->wm->num_lock == 0))
       {
-        n = g_strlen(self->caption1);
+        n = g_mbstowcs(0, self->caption1, 0);
         if (self->edit_pos < n)
         {
           self->edit_pos = n;
@@ -1380,8 +1416,8 @@ xrdp_bitmap_def_proc(struct xrdp_bitmap* self, int msg,
         }
       }
       /* home */
-      else if (scan_code == 71  &&
-              (ext || self->wm->num_lock == 0))
+      else if ((scan_code == 71)  &&
+              (ext || (self->wm->num_lock == 0)))
       {
         if (self->edit_pos > 0)
         {
@@ -1391,14 +1427,13 @@ xrdp_bitmap_def_proc(struct xrdp_bitmap* self, int msg,
       }
       else
       {
-        c = get_char_from_scan_code(param2, scan_code, self->wm->keys,
-                                    self->wm->caps_lock,
-                                    self->wm->num_lock,
-                                    self->wm->scroll_lock,
-                                    self->wm->session->client_info->keylayout);
-        if ((unsigned char)c >= 32)
+        c = get_char_from_scan_code
+            (param2, scan_code, self->wm->keys, self->wm->caps_lock,
+             self->wm->num_lock, self->wm->scroll_lock,
+             &(self->wm->keymap));
+        if (c >= 32)
         {
-          add_char_at(self->caption1, c, self->edit_pos);
+          add_char_at(self->caption1, 255, c, self->edit_pos);
           self->edit_pos++;
           xrdp_bitmap_invalidate(self, 0);
         }
@@ -1412,8 +1447,8 @@ xrdp_bitmap_def_proc(struct xrdp_bitmap* self, int msg,
       scan_code = param1 % 128;
       ext = param2 & 0x0100;
       /* left or up arrow */
-      if ((scan_code == 75 || scan_code == 72) &&
-          (ext || self->wm->num_lock == 0))
+      if (((scan_code == 75) || (scan_code == 72)) &&
+          (ext || (self->wm->num_lock == 0)))
       {
         if (self->item_index > 0)
         {
diff --git a/xrdp/xrdp_cache.c b/xrdp/xrdp_cache.c
index 172093f..d92cdab 100644
--- a/xrdp/xrdp_cache.c
+++ b/xrdp/xrdp_cache.c
@@ -14,7 +14,7 @@
    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
 
    xrdp: A Remote Desktop Protocol server.
-   Copyright (C) Jay Sorg 2004-2007
+   Copyright (C) Jay Sorg 2004-2008
 
    cache
 
@@ -486,3 +486,49 @@ xrdp_cache_add_pointer_static(struct xrdp_cache* self,
   DEBUG(("adding pointer at %d", index));
   return index;
 }
+
+/*****************************************************************************/
+/* this does not take owership of brush_item_data, it makes a copy */
+int APP_CC
+xrdp_cache_add_brush(struct xrdp_cache* self,
+                     char* brush_item_data)
+{
+  int i;
+  int oldest;
+  int index;
+
+  if (self == 0)
+  {
+    return 0;
+  }
+  self->brush_stamp++;
+  /* look for match */
+  for (i = 0; i < 64; i++)
+  {
+    if (g_memcmp(self->brush_items[i].pattern,
+                 brush_item_data, 8) == 0)
+    {
+      self->brush_items[i].stamp = self->brush_stamp;
+      DEBUG(("found brush at %d", i));
+      return i;
+    }
+  }
+  /* look for oldest */
+  index = 0;
+  oldest = 0x7fffffff;
+  for (i = 0; i < 64; i++)
+  {
+    if (self->brush_items[i].stamp < oldest)
+    {
+      oldest = self->brush_items[i].stamp;
+      index = i;
+    }
+  }
+  g_memcpy(self->brush_items[index].pattern,
+           brush_item_data, 8);
+  self->brush_items[index].stamp = self->brush_stamp;
+  libxrdp_orders_send_brush(self->session, 8, 8, 1, 0x81, 8,
+                            self->brush_items[index].pattern, index);
+  DEBUG(("adding brush at %d", index));
+  return index;
+}
diff --git a/xrdp/xrdp_font.c b/xrdp/xrdp_font.c
index 305d629..68d62ab 100644
--- a/xrdp/xrdp_font.c
+++ b/xrdp/xrdp_font.c
@@ -15,7 +15,7 @@
    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
 
    xrdp: A Remote Desktop Protocol server.
-   Copyright (C) Jay Sorg 2004-2007
+   Copyright (C) Jay Sorg 2004-2008
 
    fonts
 
@@ -73,16 +73,31 @@ xrdp_font_create(struct xrdp_wm* wm)
   int i;
   int index;
   int datasize;
+  int file_size;
   struct xrdp_font_char* f;
+  char file_path[256];
 
+  DEBUG(("in xrdp_font_create"));
+  g_snprintf(file_path, 255, "%s/%s", XRDP_SHARE_PATH, DEFAULT_FONT_NAME);
+  if (!g_file_exist(file_path))
+  {
+    g_writeln("xrdp_font_create: error font file [%s] does not exist",
+              file_path);
+    return 0;
+  }
+  file_size = g_file_get_size(file_path);
+  if (file_size < 1)
+  {
+    return 0;
+  }
   self = (struct xrdp_font*)g_malloc(sizeof(struct xrdp_font), 1);
   self->wm = wm;
   make_stream(s);
-  init_stream(s, 8192 * 2);
-  fd = g_file_open("Tahoma-10.fv1");
+  init_stream(s, file_size + 1024);
+  fd = g_file_open(file_path);
   if (fd != -1)
   {
-    b = g_file_read(fd, s->data, 8192 * 2);
+    b = g_file_read(fd, s->data, file_size + 1024);
     g_file_close(fd);
     if (b > 0)
     {
@@ -112,7 +127,8 @@ xrdp_font_create(struct xrdp_wm* wm)
         {
           /* shouldn't happen */
           g_writeln("error in xrdp_font_create, datasize wrong");
-          g_writeln("%d %d %d", f->width, f->height, datasize);
+          g_writeln("width %d height %d datasize %d index %d",
+                    f->width, f->height, datasize, index);
           break;
         }
         if (s_check_rem(s, datasize))
@@ -137,6 +153,7 @@ xrdp_font_create(struct xrdp_wm* wm)
   self->font_items[0].data = g_malloc(3 * 16, 0);
   g_memcpy(self->font_items[0].data, w_char, 3 * 16);
 */
+  DEBUG(("out xrdp_font_create"));
   return self;
 }
 
@@ -151,7 +168,7 @@ xrdp_font_delete(struct xrdp_font* self)
   {
     return;
   }
-  for (i = 0; i < 256; i++)
+  for (i = 0; i < NUM_FONTS; i++)
   {
     g_free(self->font_items[i].data);
   }
diff --git a/xrdp/xrdp_listen.c b/xrdp/xrdp_listen.c
index 3399e42..4526d14 100644
--- a/xrdp/xrdp_listen.c
+++ b/xrdp/xrdp_listen.c
@@ -14,7 +14,7 @@
    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
 
    xrdp: A Remote Desktop Protocol server.
-   Copyright (C) Jay Sorg 2004-2007
+   Copyright (C) Jay Sorg 2004-2008
 
    listen for incoming connection
 
@@ -24,7 +24,7 @@
 
 /* 'g_process' is protected by the semaphore 'g_process_sem'.  One thread sets
    g_process and waits for the other to process it */
-static long g_process_sem = 0;
+static tbus g_process_sem = 0;
 static struct xrdp_process* g_process = 0;
 
 /*****************************************************************************/
@@ -34,7 +34,12 @@ xrdp_listen_create(void)
   struct xrdp_listen* self;
 
   self = (struct xrdp_listen*)g_malloc(sizeof(struct xrdp_listen), 1);
-  self->process_list_max = 100;
+  self->pro_done_event = g_create_wait_obj("xrdp_listen_pro_done_event");
+  self->process_list = list_create();
+  if (g_process_sem == 0)
+  {
+    g_process_sem = tc_sem_create(0);
+  }
   return self;
 }
 
@@ -42,87 +47,42 @@ xrdp_listen_create(void)
 void APP_CC
 xrdp_listen_delete(struct xrdp_listen* self)
 {
-  g_free(self);
-}
-
-/*****************************************************************************/
-static int APP_CC
-xrdp_listen_term_processes(struct xrdp_listen* self)
-{
-  int i;
-
-  /* tell all xrdp processes to end */
-  for (i = 0; i < self->process_list_count; i++)
+  if (g_process_sem != 0)
   {
-    if (self->process_list[i] != 0)
-    {
-      self->process_list[i]->term = 1;
-    }
-  }
-  /* make sure they are done */
-  for (i = 0; i < self->process_list_count; i++)
-  {
-    if (self->process_list[i] != 0)
-    {
-      while (self->process_list[i]->status > 0)
-      {
-        g_sleep(10);
-      }
-    }
-  }
-  /* free them all */
-  for (i = 0; i < self->process_list_count; i++)
-  {
-    if (self->process_list[i] != 0)
-    {
-      xrdp_process_delete(self->process_list[i]);
-    }
+    tc_sem_delete(g_process_sem);
+    g_process_sem = 0;
   }
-  return 0;
+  g_delete_wait_obj(self->pro_done_event);
+  list_delete(self->process_list);
+  g_free(self);
 }
 
 /*****************************************************************************/
 /* returns error */
 static int APP_CC
-xrdp_listen_add_pro(struct xrdp_listen* self)
+xrdp_listen_add_pro(struct xrdp_listen* self, struct xrdp_process* process)
 {
-  int i;
-
-  for (i = 0; i < self->process_list_max; i++)
-  {
-    /* add process in new slot */
-    if (self->process_list[i] == 0)
-    {
-      self->process_list[i] = g_process;
-      self->process_list_count++;
-      return 0;
-    }
-    /* add process in unused slot */
-    /* this shouldn't happen */
-    if (self->process_list[i]->status <= 0)
-    {
-      xrdp_process_delete(self->process_list[i]);
-      self->process_list[i] = g_process;
-      return 0;
-    }
-  }
-  return 1;
+  list_add_item(self->process_list, (tbus)process);
+  return 0;
 }
 
 /*****************************************************************************/
-int APP_CC
-xrdp_listen_delete_pro(struct xrdp_listen* self, struct xrdp_process* pro)
+static int APP_CC
+xrdp_listen_delete_done_pro(struct xrdp_listen* self)
 {
   int i;
+  struct xrdp_process* pro;
 
-  for (i = 0; i < self->process_list_max; i++)
+  for (i = self->process_list->count - 1; i >= 0; i--)
   {
-    if (self->process_list[i] == pro)
+    pro = (struct xrdp_process*)list_get_item(self->process_list, i);
+    if (pro != 0)
     {
-      DEBUG(("process deleted"));
-      xrdp_process_delete(pro);
-      self->process_list[i] = 0;
-      return 0;
+      if (pro->status < 0)
+      {
+        xrdp_process_delete(pro);
+        list_remove_item(self->process_list, i);
+      }
     }
   }
   return 0;
@@ -145,22 +105,18 @@ xrdp_process_run(void* in_val)
 }
 
 /*****************************************************************************/
-/* wait for incoming connections */
-int APP_CC
-xrdp_listen_main_loop(struct xrdp_listen* self)
+static int
+xrdp_listen_get_port(char* port, int port_bytes)
 {
-  int error;
   int fd;
+  int error;
   int index;
-  char port[8];
   char* val;
   struct list* names;
   struct list* values;
 
-  self->status = 1;
-  g_process_sem = tc_sem_create(0);
   /* default to port 3389 */
-  g_strncpy(port, "3389", 7);
+  g_strncpy(port, "3389", port_bytes - 1);
   /* see if port is in xrdp.ini file */
   fd = g_file_open(XRDP_CFG_FILE);
   if (fd > 0)
@@ -176,13 +132,13 @@ xrdp_listen_main_loop(struct xrdp_listen* self)
         val = (char*)list_get_item(names, index);
         if (val != 0)
         {
-          if (g_strncasecmp(val, "port", 5) == 0)
+          if (g_strcasecmp(val, "port") == 0)
           {
             val = (char*)list_get_item(values, index);
             error = g_atoi(val);
-            if (error > 0 && error < 65000)
+            if ((error > 0) && (error < 65000))
             {
-              g_strncpy(port, val, 7);
+              g_strncpy(port, val, port_bytes - 1);
             }
             break;
           }
@@ -193,6 +149,27 @@ xrdp_listen_main_loop(struct xrdp_listen* self)
     list_delete(values);
     g_file_close(fd);
   }
+  return 0;
+}
+
+/*****************************************************************************/
+/* wait for incoming connections */
+int APP_CC
+xrdp_listen_main_loop(struct xrdp_listen* self)
+{
+  int error;
+  int robjs_count;
+  int cont;
+  char port[8];
+  tbus robjs[8];
+  tbus term_obj;
+  tbus sync_obj;
+  tbus sck_obj;
+  tbus done_obj;
+  struct xrdp_process* process;
+
+  self->status = 1;
+  xrdp_listen_get_port(port, sizeof(port));
   self->sck = g_tcp_socket();
   g_tcp_set_non_blocking(self->sck);
   error = g_tcp_bind(self->sck, port);
@@ -206,43 +183,107 @@ xrdp_listen_main_loop(struct xrdp_listen* self)
   error = g_tcp_listen(self->sck);
   if (error == 0)
   {
-    while (!g_is_term() && !self->term)
+    term_obj = g_get_term_event();
+    sync_obj = g_get_sync_event();
+    sck_obj = g_create_wait_obj_from_socket(self->sck, 0);
+    done_obj = self->pro_done_event;
+    cont = 1;
+    while (cont)
     {
-      error = g_tcp_accept(self->sck);
-      if ((error == -1) && g_tcp_last_error_would_block(self->sck))
+      /* build the wait obj list */
+      robjs_count = 0;
+      robjs[robjs_count++] = term_obj;
+      robjs[robjs_count++] = sync_obj;
+      robjs[robjs_count++] = sck_obj;
+      robjs[robjs_count++] = done_obj;
+      /* wait */
+      if (g_obj_wait(robjs, robjs_count, 0, 0, -1) != 0)
       {
+        /* error, should not get here */
         g_sleep(100);
-        g_loop();
       }
-      else if (error == -1)
+      if (g_is_wait_obj_set(term_obj)) /* term */
       {
         break;
       }
-      else
+      if (g_is_wait_obj_set(sync_obj)) /* sync */
       {
-        g_process = xrdp_process_create(self);
-        if (xrdp_listen_add_pro(self) == 0)
+        g_reset_wait_obj(sync_obj);
+        g_loop();
+      }
+      if (g_is_wait_obj_set(sck_obj)) /* incomming connection */
+      {
+        error = g_tcp_accept(self->sck);
+        if ((error == -1) && g_tcp_last_error_would_block(self->sck))
+        {
+          /* should not get here */
+          g_sleep(100);
+        }
+        else if (error == -1)
         {
-          /* start thread */
-          g_process->sck = error;
-          tc_thread_create(xrdp_process_run, 0);
-          tc_sem_dec(g_process_sem); /* this will wait */
-          g_sleep(250); /* just for safety */
+          /* error, should not get here */
+          break;
         }
         else
         {
-          xrdp_process_delete(g_process);
+          process = xrdp_process_create(self, self->pro_done_event);
+          if (xrdp_listen_add_pro(self, process) == 0)
+          {
+            /* start thread */
+            process->sck = error;
+            g_process = process;
+            tc_thread_create(xrdp_process_run, 0);
+            tc_sem_dec(g_process_sem); /* this will wait */
+          }
+          else
+          {
+            xrdp_process_delete(process);
+          }
         }
       }
+      if (g_is_wait_obj_set(done_obj)) /* pro_done_event */
+      {
+        g_reset_wait_obj(done_obj);
+        xrdp_listen_delete_done_pro(self);
+      }
+    }
+    /* stop listening */
+    g_delete_wait_obj_from_socket(sck_obj);
+    g_tcp_close(self->sck);
+    /* second loop to wait for all process threads to close */
+    cont = 1;
+    while (cont)
+    {
+      if (self->process_list->count == 0)
+      {
+        break;
+      }
+      /* build the wait obj list */
+      robjs_count = 0;
+      robjs[robjs_count++] = sync_obj;
+      robjs[robjs_count++] = done_obj;
+      /* wait */
+      if (g_obj_wait(robjs, robjs_count, 0, 0, -1) != 0)
+      {
+        /* error, should not get here */
+        g_sleep(100);
+      }
+      if (g_is_wait_obj_set(sync_obj)) /* sync */
+      {
+        g_reset_wait_obj(sync_obj);
+        g_loop();
+      }
+      if (g_is_wait_obj_set(done_obj)) /* pro_done_event */
+      {
+        g_reset_wait_obj(done_obj);
+        xrdp_listen_delete_done_pro(self);
+      }
     }
   }
   else
   {
     DEBUG(("listen error in xrdp_listen_main_loop"));
   }
-  xrdp_listen_term_processes(self);
-  g_tcp_close(self->sck);
-  tc_sem_delete(g_process_sem);
   self->status = -1;
   return 0;
 }
diff --git a/xrdp/xrdp_login_wnd.c b/xrdp/xrdp_login_wnd.c
index 8a7523b..784c06f 100644
--- a/xrdp/xrdp_login_wnd.c
+++ b/xrdp/xrdp_login_wnd.c
@@ -14,7 +14,7 @@
    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
 
    xrdp: A Remote Desktop Protocol server.
-   Copyright (C) Jay Sorg 2004-2007
+   Copyright (C) Jay Sorg 2004-2008
 
    main login window and login help window
 
@@ -58,7 +58,7 @@ xrdp_wm_login_help_notify(struct xrdp_bitmap* wnd,
     p = (struct xrdp_painter*)param1;
     if (p != 0)
     {
-      p->font->color = wnd->wm->black;
+      p->fg_color = wnd->wm->black;
       xrdp_painter_draw_text(p, wnd, 10, 30, "You must be authenticated \
 before using this");
       xrdp_painter_draw_text(p, wnd, 10, 46, "session.");
@@ -132,7 +132,7 @@ xrdp_wm_help_clicked(struct xrdp_bitmap* wnd)
   struct xrdp_bitmap* but;
 
   /* create help screen */
-  help = xrdp_bitmap_create(300, 300, wnd->wm->screen->bpp,
+  help = xrdp_bitmap_create(340, 300, wnd->wm->screen->bpp,
                             WND_TYPE_WND, wnd->wm);
   list_insert_item(wnd->wm->screen->child_list, 0, (long)help);
   help->parent = wnd->wm->screen;
@@ -149,7 +149,7 @@ xrdp_wm_help_clicked(struct xrdp_bitmap* wnd)
   list_insert_item(help->child_list, 0, (long)but);
   but->parent = help;
   but->owner = help;
-  but->left = 120;
+  but->left = 140;
   but->top = 260;
   but->id = 1;
   but->tab_stop = 1;
@@ -173,7 +173,7 @@ xrdp_wm_cancel_clicked(struct xrdp_bitmap* wnd)
     {
       if (wnd->wm->pro_layer != 0)
       {
-        wnd->wm->pro_layer->term = 1;
+        g_set_wait_obj(wnd->wm->pro_layer->self_term_event);
       }
     }
   }
@@ -219,7 +219,7 @@ xrdp_wm_ok_clicked(struct xrdp_bitmap* wnd)
       /* gota copy these cause dialog gets freed */
       list_append_list_strdup(mod_data->names, wm->mm->login_names, 0);
       list_append_list_strdup(mod_data->values, wm->mm->login_values, 0);
-      wm->login_mode = 2;
+      xrdp_wm_set_login_mode(wm, 2);
     }
   }
   return 0;
@@ -261,7 +261,7 @@ xrdp_wm_show_edits(struct xrdp_wm* self, struct xrdp_bitmap* combo)
       if (g_strncmp("ask", value, 3) == 0)
       {
         /* label */
-        b = xrdp_bitmap_create(60, 20, self->screen->bpp,
+        b = xrdp_bitmap_create(70, 20, self->screen->bpp,
                                WND_TYPE_LABEL, self);
         list_insert_item(self->login_window->child_list, insert_index,
                               (long)b);
@@ -281,14 +281,14 @@ xrdp_wm_show_edits(struct xrdp_wm* self, struct xrdp_bitmap* combo)
         insert_index++;
         b->parent = self->login_window;
         b->owner = self->login_window;
-        b->left = 220;
+        b->left = 230;
         b->top = 60 + 25 * count;
         b->id = 100 + 2 * count + 1;
         b->pointer = 1;
         b->tab_stop = 1;
         b->caption1 = (char*)g_malloc(256, 1);
         g_strncpy(b->caption1, value + 3, 255);
-        b->edit_pos = g_strlen(b->caption1);
+        b->edit_pos = g_mbstowcs(0, b->caption1, 0);
         if (self->login_window->focused_control == 0)
         {
           self->login_window->focused_control = b;
@@ -296,8 +296,8 @@ xrdp_wm_show_edits(struct xrdp_wm* self, struct xrdp_bitmap* combo)
         if (g_strncmp(name, "username", 255) == 0)
         {
           g_strncpy(b->caption1, self->session->client_info->username, 255);
-          b->edit_pos = g_strlen(b->caption1);
-          if (g_strlen(b->caption1) > 0)
+          b->edit_pos = g_mbstowcs(0, b->caption1, 0);
+          if (b->edit_pos > 0)
           {
             username_set = 1;
           }
@@ -444,6 +444,7 @@ xrdp_login_wnd_create(struct xrdp_wm* self)
 {
   struct xrdp_bitmap* but;
   struct xrdp_bitmap* combo;
+  char file_path[256];
 
   /* draw login window */
   self->login_window = xrdp_bitmap_create(400, 200, self->screen->bpp,
@@ -461,7 +462,8 @@ xrdp_login_wnd_create(struct xrdp_wm* self)
 
   /* image */
   but = xrdp_bitmap_create(4, 4, self->screen->bpp, WND_TYPE_IMAGE, self);
-  xrdp_bitmap_load(but, "xrdp256.bmp", self->palette);
+  g_snprintf(file_path, 255, "%s/xrdp256.bmp", XRDP_SHARE_PATH);
+  xrdp_bitmap_load(but, file_path, self->palette);
   but->parent = self->screen;
   but->owner = self->screen;
   but->left = self->screen->width - but->width;
@@ -470,7 +472,8 @@ xrdp_login_wnd_create(struct xrdp_wm* self)
 
   /* image */
   but = xrdp_bitmap_create(4, 4, self->screen->bpp, WND_TYPE_IMAGE, self);
-  xrdp_bitmap_load(but, "ad256.bmp", self->palette);
+  g_snprintf(file_path, 255, "%s/ad256.bmp", XRDP_SHARE_PATH);
+  xrdp_bitmap_load(but, file_path, self->palette);
   but->parent = self->login_window;
   but->owner = self->login_window;
   but->left = 10;
@@ -491,7 +494,7 @@ xrdp_login_wnd_create(struct xrdp_wm* self)
   list_add_item(self->login_window->child_list, (long)combo);
   combo->parent = self->login_window;
   combo->owner = self->login_window;
-  combo->left = 220;
+  combo->left = 230;
   combo->top = 35;
   combo->id = 6;
   combo->tab_stop = 1;
diff --git a/xrdp/xrdp_mm.c b/xrdp/xrdp_mm.c
index 5bf9202..cec7177 100644
--- a/xrdp/xrdp_mm.c
+++ b/xrdp/xrdp_mm.c
@@ -14,7 +14,7 @@
    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
 
    xrdp: A Remote Desktop Protocol server.
-   Copyright (C) Jay Sorg 2004-2007
+   Copyright (C) Jay Sorg 2004-2008
 
    module manager
 
@@ -50,7 +50,12 @@ sync_unload(long param1, long param2)
 static long DEFAULT_CC
 sync_load(long param1, long param2)
 {
-  return g_load_library((char*)param1);
+  long rv;
+  char* libname;
+
+  libname = (char*)param1;
+  rv = g_load_library(libname);
+  return rv;
 }
 
 /*****************************************************************************/
@@ -82,8 +87,13 @@ xrdp_mm_delete(struct xrdp_mm* self)
   {
     return;
   }
-  /* free any modual stuff */
+  /* free any module stuff */
   xrdp_mm_module_cleanup(self);
+  if (self->sck_obj != 0)
+  {
+    g_delete_wait_obj_from_socket(self->sck_obj);
+    self->sck_obj = 0;
+  }
   if (self->sck != 0)
   {
     g_tcp_close(self->sck);
@@ -289,6 +299,7 @@ xrdp_mm_setup_mod1(struct xrdp_mm* self)
 {
   void* func;
   char lib[256];
+  char text[256];
 
   if (self == 0)
   {
@@ -297,12 +308,14 @@ xrdp_mm_setup_mod1(struct xrdp_mm* self)
   lib[0] = 0;
   if (xrdp_mm_get_lib(self, lib, 255) != 0)
   {
-    g_writeln("error finding lib");
+    g_snprintf(text, 255, "error finding lib");
+    xrdp_wm_log_msg(self->wm, text);
     return 1;
   }
   if (lib[0] == 0)
   {
-    g_writeln("error finding lib");
+    g_snprintf(text, 255, "error finding lib");
+    xrdp_wm_log_msg(self->wm, text);
     return 1;
   }
   if (self->mod_handle == 0)
@@ -317,7 +330,8 @@ xrdp_mm_setup_mod1(struct xrdp_mm* self)
       }
       if (func == 0)
       {
-        g_writeln("error finding proc mod_init in %s", lib);
+        g_snprintf(text, 255, "error finding proc mod_init in %s", lib);
+        xrdp_wm_log_msg(self->wm, text);
       }
       self->mod_init = (struct xrdp_mod* (*)(void))func;
       func = g_get_proc_address(self->mod_handle, "mod_exit");
@@ -327,7 +341,8 @@ xrdp_mm_setup_mod1(struct xrdp_mm* self)
       }
       if (func == 0)
       {
-        g_writeln("error finding proc mod_exit in %s", lib);
+        g_snprintf(text, 255, "error finding proc mod_exit in %s", lib);
+        xrdp_wm_log_msg(self->wm, text);
       }
       self->mod_exit = (int (*)(struct xrdp_mod*))func;
       if ((self->mod_init != 0) && (self->mod_exit != 0))
@@ -337,7 +352,8 @@ xrdp_mm_setup_mod1(struct xrdp_mm* self)
     }
     else
     {
-      g_writeln("error loading %s", lib);
+      g_snprintf(text, 255, "error loading %s", lib);
+      xrdp_wm_log_msg(self->wm, text);
     }
     if (self->mod != 0)
     {
@@ -386,19 +402,21 @@ xrdp_mm_setup_mod2(struct xrdp_mm* self)
   char* value;
   int i;
   int rv;
+  int key_flags;
+  int device_flags;
 
   rv = 1;
   text[0] = 0;
-  if (!(self->wm->pro_layer->term))
+  if (!g_is_wait_obj_set(self->wm->pro_layer->self_term_event))
   {
     if (self->mod->mod_start(self->mod, self->wm->screen->width,
                              self->wm->screen->height,
                              self->wm->screen->bpp) != 0)
     {
-      self->wm->pro_layer->term = 1; /* kill session */
+      g_set_wait_obj(self->wm->pro_layer->self_term_event); /* kill session */
     }
   }
-  if (!(self->wm->pro_layer->term))
+  if (!g_is_wait_obj_set(self->wm->pro_layer->self_term_event))
   {
     if (self->display > 0)
     {
@@ -412,11 +430,11 @@ xrdp_mm_setup_mod2(struct xrdp_mm* self)
       }
       else
       {
-        self->wm->pro_layer->term = 1; /* kill session */
+        g_set_wait_obj(self->wm->pro_layer->self_term_event); /* kill session */
       }
     }
   }
-  if (!(self->wm->pro_layer->term))
+  if (!g_is_wait_obj_set(self->wm->pro_layer->self_term_event))
   {
     /* this adds the port to the end of the list, it will already be in
        the list as -1
@@ -443,6 +461,32 @@ xrdp_mm_setup_mod2(struct xrdp_mm* self)
       rv = 0;
     }
   }
+  if (rv == 0)
+  {
+    /* sync modifiers */
+    key_flags = 0;
+    device_flags = 0;
+    if (self->wm->scroll_lock)
+    {
+      key_flags |= 1;
+    }
+    if (self->wm->num_lock)
+    {
+      key_flags |= 2;
+    }
+    if (self->wm->caps_lock)
+    {
+      key_flags |= 4;
+    }
+    if (self->mod != 0)
+    {
+      if (self->mod->mod_event != 0)
+      {
+        self->mod->mod_event(self->mod, 17, key_flags, device_flags,
+                             key_flags, device_flags);
+      }
+    }
+  }
   return rv;
 }
 
@@ -467,8 +511,8 @@ xrdp_mm_process_login_response(struct xrdp_mm* self, struct stream* s)
     {
       if (xrdp_mm_setup_mod2(self) == 0)
       {
-        self->wm->login_mode = 10;
-        self->wm->pro_layer->app_sck = self->mod->sck;
+        xrdp_wm_set_login_mode(self->wm, 10);
+        self->wm->dragging = 0;
       }
     }
   }
@@ -477,13 +521,14 @@ xrdp_mm_process_login_response(struct xrdp_mm* self, struct stream* s)
     xrdp_wm_log_msg(self->wm, "login failed");
   }
   /* close socket */
+  g_delete_wait_obj_from_socket(self->sck_obj);
+  self->sck_obj = 0;
   g_tcp_close(self->sck);
   self->sck = 0;
   self->connected_state = 0;
   if (self->wm->login_mode != 10)
   {
-    self->wm->pro_layer->app_sck = 0;
-    self->wm->login_mode = 11;
+    xrdp_wm_set_login_mode(self->wm, 11);
     xrdp_mm_module_cleanup(self);
   }
   return rv;
@@ -533,6 +578,7 @@ xrdp_mm_connect(struct xrdp_mm* self)
     ok = 0;
     errstr[0] = 0;
     self->sck = g_tcp_socket();
+    self->sck_obj = g_create_wait_obj_from_socket(self->sck, 0);
     g_tcp_set_non_blocking(self->sck);
     g_snprintf(text, 255, "connecting to sesman ip %s port 3350", ip);
     xrdp_wm_log_msg(self->wm, text);
@@ -570,12 +616,13 @@ xrdp_mm_connect(struct xrdp_mm* self)
       /* fully connect */
       xrdp_wm_log_msg(self->wm, "sesman connect ok");
       self->connected_state = 1;
-      self->wm->pro_layer->app_sck = self->sck;
       rv = xrdp_mm_send_login(self);
     }
     else
     {
       xrdp_wm_log_msg(self->wm, errstr);
+      g_delete_wait_obj_from_socket(self->sck_obj);
+      self->sck_obj = 0;
       g_tcp_close(self->sck);
       self->sck = 0;
       rv = 1;
@@ -587,14 +634,12 @@ xrdp_mm_connect(struct xrdp_mm* self)
     {
       if (xrdp_mm_setup_mod2(self) == 0)
       {
-        self->wm->login_mode = 10;
-        self->wm->pro_layer->app_sck = self->mod->sck;
+        xrdp_wm_set_login_mode(self->wm, 10);
       }
     }
     if (self->wm->login_mode != 10)
     {
-      self->wm->pro_layer->app_sck = 0;
-      self->wm->login_mode = 11;
+      xrdp_wm_set_login_mode(self->wm, 11);
       xrdp_mm_module_cleanup(self);
     }
   }
diff --git a/xrdp/xrdp_painter.c b/xrdp/xrdp_painter.c
index b266768..451f530 100644
--- a/xrdp/xrdp_painter.c
+++ b/xrdp/xrdp_painter.c
@@ -14,7 +14,7 @@
    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
 
    xrdp: A Remote Desktop Protocol server.
-   Copyright (C) Jay Sorg 2004-2007
+   Copyright (C) Jay Sorg 2004-2008
 
    painter, gc
 
@@ -44,7 +44,6 @@ xrdp_painter_delete(struct xrdp_painter* self)
   {
     return;
   }
-  xrdp_font_delete(self->font);
   g_free(self);
 }
 
@@ -70,7 +69,7 @@ xrdp_painter_font_needed(struct xrdp_painter* self)
 {
   if (self->font == 0)
   {
-    self->font = xrdp_font_create(self->wm);
+    self->font = self->wm->default_font;
   }
   return 0;
 }
@@ -182,19 +181,27 @@ xrdp_painter_text_width(struct xrdp_painter* self, char* text)
   int rv;
   int len;
   struct xrdp_font_char* font_item;
+  twchar* wstr;
 
   xrdp_painter_font_needed(self);
+  if (self->font == 0)
+  {
+    return 0;
+  }
   if (text == 0)
   {
     return 0;
   }
   rv = 0;
-  len = g_strlen(text);
+  len = g_mbstowcs(0, text, 0);
+  wstr = (twchar*)g_malloc((len + 2) * sizeof(twchar), 0);
+  g_mbstowcs(wstr, text, len + 1);
   for (index = 0; index < len; index++)
   {
-    font_item = self->font->font_items + (unsigned char)text[index];
+    font_item = self->font->font_items + wstr[index];
     rv = rv + font_item->incby;
   }
+  g_free(wstr);
   return rv;
 }
 
@@ -206,23 +213,53 @@ xrdp_painter_text_height(struct xrdp_painter* self, char* text)
   int rv;
   int len;
   struct xrdp_font_char* font_item;
+  twchar* wstr;
 
   xrdp_painter_font_needed(self);
+  if (self->font == 0)
+  {
+    return 0;
+  }
   if (text == 0)
   {
     return 0;
   }
   rv = 0;
-  len = g_strlen(text);
+  len = g_mbstowcs(0, text, 0);
+  wstr = (twchar*)g_malloc((len + 2) * sizeof(twchar), 0);
+  g_mbstowcs(wstr, text, len + 1);
   for (index = 0; index < len; index++)
   {
-    font_item = self->font->font_items + (unsigned char)text[index];
+    font_item = self->font->font_items + wstr[index];
     rv = MAX(rv, font_item->height);
   }
+  g_free(wstr);
   return rv;
 }
 
 /*****************************************************************************/
+static int APP_CC
+xrdp_painter_setup_brush(struct xrdp_painter* self,
+                         struct xrdp_brush* out_brush,
+                         struct xrdp_brush* in_brush)
+{
+  int cache_id;
+
+  g_memcpy(out_brush, in_brush, sizeof(struct xrdp_brush));
+  if (in_brush->style == 3)
+  {
+    if (self->session->client_info->brush_cache_code == 1)
+    {
+      cache_id = xrdp_cache_add_brush(self->wm->cache, in_brush->pattern);
+      g_memset(out_brush->pattern, 0, 8);
+      out_brush->pattern[0] = cache_id;
+      out_brush->style = 0x81;
+    }
+  }
+  return 0;
+}
+
+/*****************************************************************************/
 /* fill in an area of the screen with one color */
 int APP_CC
 xrdp_painter_fill_rect(struct xrdp_painter* self,
@@ -233,6 +270,7 @@ xrdp_painter_fill_rect(struct xrdp_painter* self,
   struct xrdp_rect draw_rect;
   struct xrdp_rect rect;
   struct xrdp_region* region;
+  struct xrdp_brush brush;
   int k;
   int dx;
   int dy;
@@ -307,13 +345,14 @@ xrdp_painter_fill_rect(struct xrdp_painter* self,
           break;
       }
     }
+    xrdp_painter_setup_brush(self, &brush, &self->brush);
     while (xrdp_region_get_rect(region, k, &rect) == 0)
     {
       if (rect_intersect(&rect, &clip_rect, &draw_rect))
       {
         libxrdp_orders_pat_blt(self->session, x, y, cx, cy,
                                rop, self->bg_color, self->fg_color,
-                               &self->brush, &draw_rect);
+                               &brush, &draw_rect);
       }
       k++;
     }
@@ -348,12 +387,13 @@ xrdp_painter_draw_text(struct xrdp_painter* self,
   struct xrdp_rect draw_rect;
   struct xrdp_font* font;
   struct xrdp_font_char* font_item;
+  twchar* wstr;
 
   if (self == 0)
   {
     return 0;
   }
-  len = g_strlen(text);
+  len = g_mbstowcs(0, text, 0);
   if (len < 1)
   {
     return 0;
@@ -366,6 +406,13 @@ xrdp_painter_draw_text(struct xrdp_painter* self,
     return 0;
   }
   xrdp_painter_font_needed(self);
+  if (self->font == 0)
+  {
+    return 0;
+  }
+  /* convert to wide char */
+  wstr = (twchar*)g_malloc((len + 2) * sizeof(twchar), 0);
+  g_mbstowcs(wstr, text, len + 1);
   font = self->font;
   f = 0;
   k = 0;
@@ -374,7 +421,7 @@ xrdp_painter_draw_text(struct xrdp_painter* self,
   data = (char*)g_malloc(len * 4, 1);
   for (index = 0; index < len; index++)
   {
-    font_item = font->font_items + (unsigned char)text[index];
+    font_item = font->font_items + wstr[index];
     i = xrdp_cache_add_char(self->wm->cache, font_item);
     f = HIWORD(i);
     c = LOWORD(i);
@@ -399,7 +446,7 @@ xrdp_painter_draw_text(struct xrdp_painter* self,
       y1 = y + total_height;
       flags = 0x03; /* 0x03 0x73; TEXT2_IMPLICIT_X and something else */
       libxrdp_orders_text(self->session, f, flags, 0,
-                          font->color, 0,
+                          self->fg_color, 0,
                           x - 1, y - 1, x + total_width, y + total_height,
                           0, 0, 0, 0,
                           x1, y1, data, len * 2, &draw_rect);
@@ -408,6 +455,7 @@ xrdp_painter_draw_text(struct xrdp_painter* self,
   }
   xrdp_region_delete(region);
   g_free(data);
+  g_free(wstr);
   return 0;
 }
 
@@ -637,7 +685,7 @@ xrdp_painter_line(struct xrdp_painter* self,
   {
     if (rect_intersect(&rect, &clip_rect, &draw_rect))
     {
-      libxrdp_orders_line(self->session, 0, x1, y1, x2, y2,
+      libxrdp_orders_line(self->session, 1, x1, y1, x2, y2,
                           rop, self->bg_color,
                           &self->pen, &draw_rect);
     }
diff --git a/xrdp/xrdp_process.c b/xrdp/xrdp_process.c
index eba8c9d..50c8cbb 100644
--- a/xrdp/xrdp_process.c
+++ b/xrdp/xrdp_process.c
@@ -14,7 +14,7 @@
    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
 
    xrdp: A Remote Desktop Protocol server.
-   Copyright (C) Jay Sorg 2004-2007
+   Copyright (C) Jay Sorg 2004-2008
 
    main rdp process
 
@@ -22,14 +22,24 @@
 
 #include "xrdp.h"
 
+static int g_session_id = 0;
+
 /*****************************************************************************/
+/* always called from xrdp_listen thread */
 struct xrdp_process* APP_CC
-xrdp_process_create(struct xrdp_listen* owner)
+xrdp_process_create(struct xrdp_listen* owner, tbus done_event)
 {
   struct xrdp_process* self;
+  char event_name[64];
 
   self = (struct xrdp_process*)g_malloc(sizeof(struct xrdp_process), 1);
   self->lis_layer = owner;
+  self->done_event = done_event;
+  g_session_id++;
+  self->session_id = g_session_id;
+  g_snprintf(event_name, 63, "xrdp_process_self_term_event_%8.8x",
+             self->session_id);
+  self->self_term_event = g_create_wait_obj(event_name);
   return self;
 }
 
@@ -41,6 +51,7 @@ xrdp_process_delete(struct xrdp_process* self)
   {
     return;
   }
+  g_delete_wait_obj(self->self_term_event);
   libxrdp_exit(self->session);
   xrdp_wm_delete(self->wm);
   g_free(self);
@@ -62,7 +73,8 @@ xrdp_process_loop(struct xrdp_process* self)
     DEBUG(("calling xrdp_wm_init and creating wm"));
     self->wm = xrdp_wm_create(self, self->session->client_info);
     /* at this point the wm(window manager) is create and wm::login_mode is
-       zero so xrdp_wm_init should be called by xrdp_wm_idle */
+       zero and login_mode_event is set so xrdp_wm_init should be called by
+       xrdp_wm_check_wait_objs */
   }
   return rv;
 }
@@ -77,10 +89,37 @@ xrdp_is_term(void)
 }
 
 /*****************************************************************************/
+static int APP_CC
+xrdp_process_mod_end(struct xrdp_process* self)
+{
+  if (self->wm != 0)
+  {
+    if (self->wm->mm != 0)
+    {
+      if (self->wm->mm->mod != 0)
+      {
+        if (self->wm->mm->mod->mod_end != 0)
+        {
+          return self->wm->mm->mod->mod_end(self->wm->mm->mod);
+        }
+      }
+    }
+  }
+  return 0;
+}
+
+/*****************************************************************************/
 int APP_CC
 xrdp_process_main_loop(struct xrdp_process* self)
 {
-  int sel_r;
+  int robjs_count;
+  int wobjs_count;
+  int cont;
+  int timeout;
+  tbus robjs[32];
+  tbus wobjs[32];
+  tbus term_obj;
+  tbus sck_obj;
 
   self->status = 1;
   self->session = libxrdp_init((long)self, self->sck);
@@ -92,52 +131,54 @@ xrdp_process_main_loop(struct xrdp_process* self)
   g_tcp_set_no_delay(self->sck);
   if (libxrdp_process_incomming(self->session) == 0)
   {
-    while (!g_is_term() && !self->term)
+    term_obj = g_get_term_event();
+    sck_obj = g_create_wait_obj_from_socket(self->sck, 0);
+    cont = 1;
+    while (cont)
     {
-      sel_r = g_tcp_select(self->sck, self->app_sck);
-      if (sel_r == 0) /* no data on any stream */
+      /* build the wait obj list */
+      timeout = -1;
+      robjs_count = 0;
+      wobjs_count = 0;
+      robjs[robjs_count++] = term_obj;
+      robjs[robjs_count++] = sck_obj;
+      robjs[robjs_count++] = self->self_term_event;
+      xrdp_wm_get_wait_objs(self->wm, robjs, &robjs_count,
+                            wobjs, &wobjs_count, &timeout);
+      /* wait */
+      if (g_obj_wait(robjs, robjs_count, wobjs, wobjs_count, timeout) != 0)
       {
-        xrdp_wm_idle(self->wm);
+        /* error, should not get here */
+        g_sleep(100);
       }
-      else if (sel_r < 0)
+      if (g_is_wait_obj_set(term_obj)) /* term */
       {
         break;
       }
-      if (sel_r & 1)
+      if (g_is_wait_obj_set(self->self_term_event))
       {
-        if (xrdp_process_loop(self) != 0)
-        {
-          break;
-        }
+        break;
       }
-      if (sel_r & 2) /* mod socket fired */
+      if (g_is_wait_obj_set(sck_obj)) /* incomming client data */
       {
-        if (xrdp_wm_app_sck_signal(self->wm, self->app_sck) != 0)
+        if (xrdp_process_loop(self) != 0)
         {
           break;
         }
       }
-    }
-    libxrdp_disconnect(self->session);
-    g_sleep(500);
-  }
-  if (self->wm != 0)
-  {
-    if (self->wm->mm != 0)
-    {
-      if (self->wm->mm->mod != 0)
+      if (xrdp_wm_check_wait_objs(self->wm) != 0)
       {
-        if (self->wm->mm->mod->mod_end != 0)
-        {
-          self->wm->mm->mod->mod_end(self->wm->mm->mod);
-        }
+        break;
       }
     }
+    g_delete_wait_obj_from_socket(sck_obj);
+    libxrdp_disconnect(self->session);
   }
+  xrdp_process_mod_end(self);
   libxrdp_exit(self->session);
   self->session = 0;
   g_tcp_close(self->sck);
   self->status = -1;
-  xrdp_listen_delete_pro(self->lis_layer, self);
+  g_set_wait_obj(self->done_event);
   return 0;
 }
diff --git a/xrdp/xrdp_region.c b/xrdp/xrdp_region.c
index 0c49e81..628885d 100644
--- a/xrdp/xrdp_region.c
+++ b/xrdp/xrdp_region.c
@@ -15,7 +15,7 @@
    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
 
    xrdp: A Remote Desktop Protocol server.
-   Copyright (C) Jay Sorg 2004-2007
+   Copyright (C) Jay Sorg 2004-2008
 
    region
 
diff --git a/xrdp/xrdp_types.h b/xrdp/xrdp_types.h
index 0acb5a3..7d2b2b7 100644
--- a/xrdp/xrdp_types.h
+++ b/xrdp/xrdp_types.h
@@ -14,7 +14,7 @@
    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
 
    xrdp: A Remote Desktop Protocol server.
-   Copyright (C) Jay Sorg 2004-2007
+   Copyright (C) Jay Sorg 2004-2008
 
    types
 
@@ -33,7 +33,11 @@ struct xrdp_mod
   int (*mod_signal)(struct xrdp_mod* v);
   int (*mod_end)(struct xrdp_mod* v);
   int (*mod_set_param)(struct xrdp_mod* v, char* name, char* value);
-  long mod_dumby[100 - 6]; /* align, 100 minus the number of mod 
+  int (*mod_session_change)(struct xrdp_mod* v, int, int);
+  int (*mod_get_wait_objs)(struct xrdp_mod* v, tbus* read_objs, int* rcount,
+                           tbus* write_objs, int* wcount, int* timeout);
+  int (*mod_check_wait_objs)(struct xrdp_mod* v);
+  long mod_dumby[100 - 9]; /* align, 100 minus the number of mod 
                               functions above */
   /* server functions */
   int (*server_begin_update)(struct xrdp_mod* v);
@@ -126,6 +130,14 @@ struct xrdp_pointer_item
   char mask[32 * 32 / 8];
 };
 
+struct xrdp_brush_item
+{
+  int stamp;
+  /* expand this to a structure to handle more complicated brushes
+     for now its 8x8 1bpp brushes only */
+  char pattern[8];
+};
+
 /* differnce caches */
 struct xrdp_cache
 {
@@ -153,6 +165,8 @@ struct xrdp_cache
   int pointer_stamp;
   struct xrdp_pointer_item pointer_items[32];
   int pointer_cache_entries;
+  int brush_stamp;
+  struct xrdp_brush_item brush_items[64];
 };
 
 struct xrdp_mm
@@ -160,6 +174,7 @@ struct xrdp_mm
   struct xrdp_wm* wm; /* owner */
   int connected_state;
   int sck;
+  tbus sck_obj;
   int sck_closed;
   struct list* login_names;
   struct list* login_values;
@@ -172,6 +187,15 @@ struct xrdp_mm
   int code;
 };
 
+struct xrdp_keymap
+{
+  int keys_noshift[128];
+  int keys_shift[128];
+  int keys_altgr[128];
+  int keys_capslock[128];
+  int keys_shiftcapslock[128];
+};
+
 /* the window manager */
 struct xrdp_wm
 {
@@ -218,14 +242,16 @@ struct xrdp_wm
   int caps_lock;
   int scroll_lock;
   int num_lock;
-  struct list* key_down_list;
   /* client info */
   struct xrdp_client_info* client_info;
   /* session log */
   struct list* log;
   struct xrdp_bitmap* log_wnd;
   int login_mode;
+  tbus login_mode_event;
   struct xrdp_mm* mm;
+  struct xrdp_font* default_font;
+  struct xrdp_keymap keymap;
 };
 
 /* rdp process */
@@ -233,12 +259,14 @@ struct xrdp_process
 {
   int status;
   int sck;
-  int term;
+  tbus self_term_event;
   struct xrdp_listen* lis_layer; /* owner */
   struct xrdp_session* session;
   /* create these when up and running */
   struct xrdp_wm* wm;
   int app_sck;
+  tbus done_event;
+  int session_id;
 };
 
 /* rdp listener */
@@ -246,10 +274,8 @@ struct xrdp_listen
 {
   int status;
   int sck;
-  int term;
-  struct xrdp_process* process_list[100]; /* 100 processes possible */
-  int process_list_count;
-  int process_list_max;
+  struct list* process_list;
+  tbus pro_done_event;
 };
 
 /* region */
@@ -314,7 +340,7 @@ struct xrdp_bitmap
   struct list* child_list;
   /* for edit */
   int edit_pos;
-  int password_char;
+  twchar password_char;
   /* for button or combo */
   int state; /* for button 0 = normal 1 = down */
   /* for combo */
@@ -329,12 +355,14 @@ struct xrdp_bitmap
   int crc;
 };
 
+#define NUM_FONTS 0x4e00
+#define DEFAULT_FONT_NAME "sans-10.fv1"
+
 /* font */
 struct xrdp_font
 {
   struct xrdp_wm* wm;
-  struct xrdp_font_char font_items[256];
-  int color;
+  struct xrdp_font_char font_items[NUM_FONTS];
   char name[32];
   int size;
   int style;
@@ -346,11 +374,3 @@ struct xrdp_mod_data
   struct list* names;
   struct list* values;
 };
-
-struct xrdp_key_down
-{
-  int scan_code;
-  int param1;
-  int param2;
-  int param4;
-};
diff --git a/xrdp/xrdp_wm.c b/xrdp/xrdp_wm.c
index 4fa9f40..1d09cf6 100644
--- a/xrdp/xrdp_wm.c
+++ b/xrdp/xrdp_wm.c
@@ -14,7 +14,7 @@
    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
 
    xrdp: A Remote Desktop Protocol server.
-   Copyright (C) Jay Sorg 2004-2007
+   Copyright (C) Jay Sorg 2004-2008
 
    simple window manager
 
@@ -28,6 +28,7 @@ xrdp_wm_create(struct xrdp_process* owner,
                struct xrdp_client_info* client_info)
 {
   struct xrdp_wm* self;
+  char event_name[64];
 
   self = (struct xrdp_wm*)g_malloc(sizeof(struct xrdp_wm), 1);
   self->client_info = client_info;
@@ -38,13 +39,18 @@ xrdp_wm_create(struct xrdp_process* owner,
   self->screen->wm = self;
   self->pro_layer = owner;
   self->session = owner->session;
+  g_snprintf(event_name, 63, "xrdp_wm_login_mode_event_%8.8x",
+             owner->session_id);
+  self->login_mode_event = g_create_wait_obj(event_name);
   self->painter = xrdp_painter_create(self, self->session);
   self->cache = xrdp_cache_create(self, self->session, self->client_info);
   self->log = list_create();
   self->log->auto_free = 1;
-  self->key_down_list = list_create();
-  self->key_down_list->auto_free = 1;
   self->mm = xrdp_mm_create(self);
+  self->default_font = xrdp_font_create(self);
+  /* this will use built in keymap or load from file */
+  get_keymaps(self->session->client_info->keylayout, &(self->keymap));
+  xrdp_wm_set_login_mode(self, 0);
   return self;
 }
 
@@ -62,8 +68,9 @@ xrdp_wm_delete(struct xrdp_wm* self)
   xrdp_bitmap_delete(self->screen);
   /* free the log */
   list_delete(self->log);
-  /* key down list */
-  list_delete(self->key_down_list);
+  /* free default font */
+  xrdp_font_delete(self->default_font);
+  g_delete_wait_obj(self->login_mode_event);
   /* free self */
   g_free(self);
 }
@@ -164,6 +171,7 @@ xrdp_wm_pointer(struct xrdp_wm* self, char* data, char* mask, int x, int y)
 }
 
 /*****************************************************************************/
+/* returns error */
 int APP_CC
 xrdp_wm_load_pointer(struct xrdp_wm* self, char* file_name, char* data,
                      char* mask, int* x, int* y)
@@ -178,6 +186,12 @@ xrdp_wm_load_pointer(struct xrdp_wm* self, char* file_name, char* data,
   int palette[16];
   struct stream* fs;
 
+  if (!g_file_exist(file_name))
+  {
+    g_writeln("xrdp_wm_load_pointer: error pointer file [%s] does not exist",
+              file_name);
+    return 1;
+  }
   make_stream(fs);
   init_stream(fs, 8192);
   fd = g_file_open(file_name);
@@ -322,17 +336,23 @@ xrdp_wm_load_static_colors(struct xrdp_wm* self)
 }
 
 /*****************************************************************************/
+/* returns error */
 int APP_CC
 xrdp_wm_load_static_pointers(struct xrdp_wm* self)
 {
   struct xrdp_pointer_item pointer_item;
+  char file_path[256];
 
   DEBUG(("sending cursor"));
-  xrdp_wm_load_pointer(self, "cursor1.cur", pointer_item.data,
+  g_snprintf(file_path, 255, "%s/cursor1.cur", XRDP_SHARE_PATH);
+  g_memset(&pointer_item, 0, sizeof(pointer_item));
+  xrdp_wm_load_pointer(self, file_path, pointer_item.data,
                        pointer_item.mask, &pointer_item.x, &pointer_item.y);
   xrdp_cache_add_pointer_static(self->cache, &pointer_item, 1);
   DEBUG(("sending cursor"));
-  xrdp_wm_load_pointer(self, "cursor0.cur", pointer_item.data,
+  g_snprintf(file_path, 255, "%s/cursor0.cur", XRDP_SHARE_PATH);
+  g_memset(&pointer_item, 0, sizeof(pointer_item));
+  xrdp_wm_load_pointer(self, file_path, pointer_item.data,
                        pointer_item.mask, &pointer_item.x, &pointer_item.y);
   xrdp_cache_add_pointer_static(self->cache, &pointer_item, 0);
   return 0;
@@ -403,7 +423,7 @@ xrdp_wm_init(struct xrdp_wm* self)
             list_add_item(self->mm->login_values, (long)g_strdup(r));
           }
         }
-        self->login_mode = 2;
+        xrdp_wm_set_login_mode(self, 2);
       }
       list_delete(names);
       list_delete(values);
@@ -416,7 +436,7 @@ xrdp_wm_init(struct xrdp_wm* self)
     /* clear screen */
     xrdp_bitmap_invalidate(self->screen, 0);
     xrdp_wm_set_focused(self, self->login_window);
-    self->login_mode = 1;
+    xrdp_wm_set_login_mode(self, 1);
   }
   return 0;
 }
@@ -660,12 +680,74 @@ xrdp_wm_move_window(struct xrdp_wm* self, struct xrdp_bitmap* wnd,
 }
 
 /*****************************************************************************/
+static int APP_CC
+xrdp_wm_undraw_dragging_box(struct xrdp_wm* self, int do_begin_end)
+{
+  int boxx;
+  int boxy;
+
+  if (self == 0)
+  {
+    return 0;
+  }
+  if (self->dragging)
+  {
+    if (self->draggingxorstate)
+    {
+      if (do_begin_end)
+      {
+        xrdp_painter_begin_update(self->painter);
+      }
+      boxx = self->draggingx - self->draggingdx;
+      boxy = self->draggingy - self->draggingdy;
+      xrdp_wm_xor_pat(self, boxx, boxy, self->draggingcx, self->draggingcy);
+      self->draggingxorstate = 0;
+      if (do_begin_end)
+      {
+        xrdp_painter_end_update(self->painter);
+      }
+    }
+  }
+  return 0;
+}
+
+/*****************************************************************************/
+static int APP_CC
+xrdp_wm_draw_dragging_box(struct xrdp_wm* self, int do_begin_end)
+{
+  int boxx;
+  int boxy;
+
+  if (self == 0)
+  {
+    return 0;
+  }
+  if (self->dragging)
+  {
+    if (!self->draggingxorstate)
+    {
+      if (do_begin_end)
+      {
+        xrdp_painter_begin_update(self->painter);
+      }
+      boxx = self->draggingx - self->draggingdx;
+      boxy = self->draggingy - self->draggingdy;
+      xrdp_wm_xor_pat(self, boxx, boxy, self->draggingcx, self->draggingcy);
+      self->draggingxorstate = 1;
+      if (do_begin_end)
+      {
+        xrdp_painter_end_update(self->painter);
+      }
+    }
+  }
+  return 0;
+}
+
+/*****************************************************************************/
 int APP_CC
 xrdp_wm_mouse_move(struct xrdp_wm* self, int x, int y)
 {
   struct xrdp_bitmap* b;
-  int boxx;
-  int boxy;
 
   if (self == 0)
   {
@@ -692,18 +774,10 @@ xrdp_wm_mouse_move(struct xrdp_wm* self, int x, int y)
   if (self->dragging)
   {
     xrdp_painter_begin_update(self->painter);
-    boxx = self->draggingx - self->draggingdx;
-    boxy = self->draggingy - self->draggingdy;
-    if (self->draggingxorstate)
-    {
-      xrdp_wm_xor_pat(self, boxx, boxy, self->draggingcx, self->draggingcy);
-    }
+    xrdp_wm_undraw_dragging_box(self, 0);
     self->draggingx = x;
     self->draggingy = y;
-    boxx = self->draggingx - self->draggingdx;
-    boxy = self->draggingy - self->draggingdy;
-    xrdp_wm_xor_pat(self, boxx, boxy, self->draggingcx, self->draggingcy);
-    self->draggingxorstate = 1;
+    xrdp_wm_draw_dragging_box(self, 0);
     xrdp_painter_end_update(self->painter);
     return 0;
   }
@@ -991,60 +1065,14 @@ xrdp_wm_mouse_click(struct xrdp_wm* self, int x, int y, int but, int down)
 }
 
 /*****************************************************************************/
-static struct xrdp_key_down* APP_CC
-xrdp_get_key_down(struct xrdp_wm* self, int scan_code, int* index)
-{
-  int i;
-  struct xrdp_key_down* key_down;
-
-  for (i = 0; i < self->key_down_list->count; i++)
-  {
-    key_down = (struct xrdp_key_down*)list_get_item(self->key_down_list, i);
-    if (key_down != 0)
-    {
-      if (key_down->scan_code == scan_code)
-      {
-        if (index != 0)
-        {
-          *index = i;
-        }
-        return key_down;
-      }
-    }
-  }
-  return 0;
-}
-
-/*****************************************************************************/
-static void APP_CC
-xrdp_add_key_down(struct xrdp_wm* self, int param1, int param2,
-                  int scan_code,  int param4)
-{
-  struct xrdp_key_down* key_down;
-  if (xrdp_get_key_down(self, scan_code, 0) != 0)
-  {
-    return;
-  }
-  key_down = (struct xrdp_key_down*)g_malloc(sizeof(struct xrdp_key_down), 0);
-  key_down->scan_code = scan_code;
-  key_down->param1 = param1;
-  key_down->param2 = param2;
-  key_down->param4 = param4;
-  list_add_item(self->key_down_list, (long)key_down);
-}
-
-/*****************************************************************************/
 int APP_CC
 xrdp_wm_key(struct xrdp_wm* self, int device_flags, int scan_code)
 {
   int msg;
-  int key_down_index;
-  char c;
-  struct xrdp_key_down* key_down;
+  int c;
 
   /*g_printf("count %d\n", self->key_down_list->count);*/
   scan_code = scan_code % 128;
-  key_down = 0;
   if (self->popup_wnd != 0)
   {
     xrdp_wm_clear_popup(self);
@@ -1054,12 +1082,6 @@ xrdp_wm_key(struct xrdp_wm* self, int device_flags, int scan_code)
   {
     self->keys[scan_code] = 0;
     msg = WM_KEYUP;
-    key_down = xrdp_get_key_down(self, scan_code, &key_down_index);
-    /* if there was no key down, don't allow a key up */
-    if (key_down == 0)
-    {
-      return 0;
-    }
   }
   else /* key down */
   {
@@ -1082,38 +1104,19 @@ xrdp_wm_key(struct xrdp_wm* self, int device_flags, int scan_code)
   {
     if (self->mm->mod->mod_event != 0)
     {
-      if (msg == WM_KEYDOWN)
+      c = get_char_from_scan_code
+          (device_flags, scan_code, self->keys, self->caps_lock,
+           self->num_lock, self->scroll_lock,
+           &(self->keymap));
+      if (c != 0)
       {
-        c = get_char_from_scan_code(device_flags, scan_code, self->keys,
-                                    self->caps_lock,
-                                    self->num_lock,
-                                    self->scroll_lock,
-                                    self->session->client_info->keylayout);
-        if (c != 0)
-        {
-          self->mm->mod->mod_event(self->mm->mod, msg, (unsigned char)c,
-                                   0xffff, scan_code, device_flags);
-          xrdp_add_key_down(self, (unsigned char)c, 0xffff, scan_code,
-                            device_flags);
-        }
-        else
-        {
-          self->mm->mod->mod_event(self->mm->mod, msg, scan_code,
-                                   device_flags, scan_code, device_flags);
-          xrdp_add_key_down(self, scan_code, device_flags, scan_code,
-                            device_flags);
-        }
+        self->mm->mod->mod_event(self->mm->mod, msg, c,
+                                 0xffff, scan_code, device_flags);
       }
-      else /* key up */
+      else
       {
-        if (key_down != 0)
-        {
-          self->mm->mod->mod_event(self->mm->mod, msg, key_down->param1,
-                                   key_down->param2 | KBD_FLAG_UP,
-                                   key_down->scan_code,
-                                   key_down->param4 | KBD_FLAG_UP);
-          list_remove_item(self->key_down_list, key_down_index);
-        }
+        self->mm->mod->mod_event(self->mm->mod, msg, scan_code,
+                                 device_flags, scan_code, device_flags);
       }
     }
   }
@@ -1306,10 +1309,9 @@ callback(long id, int msg, long param1, long param2, long param3, long param4)
 /******************************************************************************/
 /* returns error */
 /* this gets called when there is nothing on any socket */
-int APP_CC
-xrdp_wm_idle(struct xrdp_wm* self)
+static int APP_CC
+xrdp_wm_login_mode_changed(struct xrdp_wm* self)
 {
-  g_sleep(10);
   if (self == 0)
   {
     return 0;
@@ -1317,21 +1319,24 @@ xrdp_wm_idle(struct xrdp_wm* self)
   if (self->login_mode == 0)
   {
     /* this is the inital state of the login window */
-    self->login_mode = 1; /* put the wm in login mode */
+    xrdp_wm_set_login_mode(self, 1); /* put the wm in login mode */
     list_clear(self->log);
     xrdp_wm_delete_all_childs(self);
+    self->dragging = 0;
     xrdp_wm_init(self);
   }
   else if (self->login_mode == 2)
   {
-    self->login_mode = 3; /* put the wm in connected mode */
+    xrdp_wm_set_login_mode(self, 3); /* put the wm in connected mode */
     xrdp_wm_delete_all_childs(self);
+    self->dragging = 0;
     xrdp_mm_connect(self->mm);
   }
   else if (self->login_mode == 10)
   {
     xrdp_wm_delete_all_childs(self);
-    self->login_mode = 11;
+    self->dragging = 0;
+    xrdp_wm_set_login_mode(self, 11);
   }
   return 0;
 }
@@ -1405,7 +1410,7 @@ xrdp_wm_log_wnd_notify(struct xrdp_bitmap* wnd,
       {
         /* make sure autologin is off */
         wm->session->client_info->rdp_autologin = 0;
-        wm->login_mode = 0; /* reset session */
+        xrdp_wm_set_login_mode(wm, 0); /* reset session */
       }
     }
   }
@@ -1414,7 +1419,7 @@ xrdp_wm_log_wnd_notify(struct xrdp_bitmap* wnd,
     painter = (struct xrdp_painter*)param1;
     if (painter != 0)
     {
-      painter->font->color = wnd->wm->black;
+      painter->fg_color = wnd->wm->black;
       for (index = 0; index < wnd->wm->log->count; index++)
       {
         text = (char*)list_get_item(wnd->wm->log, index);
@@ -1463,3 +1468,107 @@ xrdp_wm_log_msg(struct xrdp_wm* self, char* msg)
   g_sleep(100);
   return 0;
 }
+
+/*****************************************************************************/
+static int APP_CC
+xrdp_wm_mod_get_wait_objs(struct xrdp_wm* self,
+                          tbus* read_objs, int* rcount,
+                          tbus* write_objs, int* wcount, int* timeout)
+{
+  if (self->mm != 0)
+  {
+    if (self->mm->mod != 0)
+    {
+      if (self->mm->mod->mod_get_wait_objs != 0)
+      {
+        return self->mm->mod->mod_get_wait_objs
+               (self->mm->mod, read_objs, rcount,
+                write_objs, wcount, timeout);
+      }
+    }
+  }
+  return 0;
+}
+
+/*****************************************************************************/
+static int APP_CC
+xrdp_wm_mod_check_wait_objs(struct xrdp_wm* self)
+{
+  if (self->mm != 0)
+  {
+    if (self->mm->mod != 0)
+    {
+      if (self->mm->mod->mod_check_wait_objs != 0)
+      {
+        return self->mm->mod->mod_check_wait_objs(self->mm->mod);
+      }
+    }
+  }
+  return 0;
+}
+
+/*****************************************************************************/
+int APP_CC
+xrdp_wm_get_wait_objs(struct xrdp_wm* self, tbus* robjs, int* rc,
+                      tbus* wobjs, int* wc, int* timeout)
+{
+  int i;
+
+  if (self == 0)
+  {
+    return 0;
+  }
+  i = *rc;
+  robjs[i++] = self->login_mode_event;
+  if (self->mm != 0)
+  {
+    if (self->mm->sck_obj != 0)
+    {
+      robjs[i++] = self->mm->sck_obj;
+    }
+  }
+  *rc = i;
+  return xrdp_wm_mod_get_wait_objs(self, robjs, rc, wobjs, wc, timeout);
+}
+
+/******************************************************************************/
+int APP_CC
+xrdp_wm_check_wait_objs(struct xrdp_wm* self)
+{
+  int rv;
+
+  if (self == 0)
+  {
+    return 0;
+  }
+  rv = 0;
+  if (g_is_wait_obj_set(self->login_mode_event))
+  {
+    g_reset_wait_obj(self->login_mode_event);
+    xrdp_wm_login_mode_changed(self);
+  }
+  if (self->mm != 0)
+  {
+    if (self->mm->sck_obj != 0)
+    {
+      if (g_is_wait_obj_set(self->mm->sck_obj))
+      {
+        rv = xrdp_mm_signal(self->mm); 
+      }
+    }
+  }
+  if (rv == 0)
+  {
+    rv = xrdp_wm_mod_check_wait_objs(self);
+  }
+  return rv;
+}
+
+/*****************************************************************************/
+int APP_CC
+xrdp_wm_set_login_mode(struct xrdp_wm* self, int login_mode)
+{
+  self->login_mode = login_mode;
+  g_set_wait_obj(self->login_mode_event);
+  return 0;
+}
diff --git a/xup/Makefile b/xup/Makefile
index 3bdf3bf..ab400de 100644
--- a/xup/Makefile
+++ b/xup/Makefile
@@ -1,35 +1,470 @@
-# libxup makefile
+# Makefile.in generated by automake 1.10.1 from Makefile.am.
+# xup/Makefile.  Generated from Makefile.in by configure.
 
-XUPOBJ = os_calls.o xup.o
+# Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
+# 2003, 2004, 2005, 2006, 2007, 2008  Free Software Foundation, Inc.
+# This Makefile.in is free software; the Free Software Foundation
+# gives unlimited permission to copy and/or distribute it,
+# with or without modifications, as long as this notice is preserved.
 
-DESTDIR = /usr/local/xrdp
-CFGDIR = /etc/xrdp
-PIDDIR = /var/run
-MANDIR = /usr/local/man
-DOCDIR = /usr/doc/xrdp
+# This program is distributed in the hope that it will be useful,
+# but WITHOUT ANY WARRANTY, to the extent permitted by law; without
+# even the implied warranty of MERCHANTABILITY or FITNESS FOR A
+# PARTICULAR PURPOSE.
 
-DEFINES =
 
-CFLAGS = -Wall -O2 -I../common -fPIC $(DEFINES)
-#CFLAGS += -DXRDP_DEBUG
-C_OS_FLAGS = $(CFLAGS) -c
-LDFLAGS = -shared
-LIBS = -ldl
+
+
+pkgdatadir = $(datadir)/xrdp
+pkglibdir = $(libdir)/xrdp
+pkgincludedir = $(includedir)/xrdp
+am__cd = CDPATH="$${ZSH_VERSION+.}$(PATH_SEPARATOR)" && cd
+install_sh_DATA = $(install_sh) -c -m 644
+install_sh_PROGRAM = $(install_sh) -c
+install_sh_SCRIPT = $(install_sh) -c
+INSTALL_HEADER = $(INSTALL_DATA)
+transform = $(program_transform_name)
+NORMAL_INSTALL = :
+PRE_INSTALL = :
+POST_INSTALL = :
+NORMAL_UNINSTALL = :
+PRE_UNINSTALL = :
+POST_UNINSTALL = :
+build_triplet = i686-suse-linux-gnu
+host_triplet = i686-suse-linux-gnu
+subdir = xup
+DIST_COMMON = $(srcdir)/Makefile.am $(srcdir)/Makefile.in
+ACLOCAL_M4 = $(top_srcdir)/aclocal.m4
+am__aclocal_m4_deps = $(top_srcdir)/configure.ac
+am__configure_deps = $(am__aclocal_m4_deps) $(CONFIGURE_DEPENDENCIES) \
+	$(ACLOCAL_M4)
+mkinstalldirs = $(install_sh) -d
+CONFIG_HEADER = $(top_builddir)/config_ac.h
+CONFIG_CLEAN_FILES =
+am__vpath_adj_setup = srcdirstrip=`echo "$(srcdir)" | sed 's|.|.|g'`;
+am__vpath_adj = case $$p in \
+    $(srcdir)/*) f=`echo "$$p" | sed "s|^$$srcdirstrip/||"`;; \
+    *) f=$$p;; \
+  esac;
+am__strip_dir = `echo $$p | sed -e 's|^.*/||'`;
+am__installdirs = "$(DESTDIR)$(libdir)"
+libLTLIBRARIES_INSTALL = $(INSTALL)
+LTLIBRARIES = $(lib_LTLIBRARIES)
+libxup_la_DEPENDENCIES = $(top_srcdir)/common/libcommon.la
+am_libxup_la_OBJECTS = xup.lo
+libxup_la_OBJECTS = $(am_libxup_la_OBJECTS)
+DEFAULT_INCLUDES = -I. -I$(top_builddir)
+depcomp = $(SHELL) $(top_srcdir)/depcomp
+am__depfiles_maybe = depfiles
+COMPILE = $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) \
+	$(CPPFLAGS) $(AM_CFLAGS) $(CFLAGS)
+LTCOMPILE = $(LIBTOOL) --tag=CC $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) \
+	--mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) \
+	$(AM_CPPFLAGS) $(CPPFLAGS) $(AM_CFLAGS) $(CFLAGS)
+CCLD = $(CC)
+LINK = $(LIBTOOL) --tag=CC $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) \
+	--mode=link $(CCLD) $(AM_CFLAGS) $(CFLAGS) $(AM_LDFLAGS) \
+	$(LDFLAGS) -o $@
+SOURCES = $(libxup_la_SOURCES)
+DIST_SOURCES = $(libxup_la_SOURCES)
+ETAGS = etags
+CTAGS = ctags
+DISTFILES = $(DIST_COMMON) $(DIST_SOURCES) $(TEXINFOS) $(EXTRA_DIST)
+ACLOCAL = ${SHELL} /home/david/git/xrdp/missing --run aclocal-1.10
+AMTAR = ${SHELL} /home/david/git/xrdp/missing --run tar
+AR = ar
+AUTOCONF = ${SHELL} /home/david/git/xrdp/missing --run autoconf
+AUTOHEADER = ${SHELL} /home/david/git/xrdp/missing --run autoheader
+AUTOMAKE = ${SHELL} /home/david/git/xrdp/missing --run automake-1.10
+AWK = gawk
 CC = gcc
+CCDEPMODE = depmode=gcc3
+CFLAGS = -g -O2
+CPP = gcc -E
+CPPFLAGS = 
+CXX = g++
+CXXCPP = g++ -E
+CXXDEPMODE = depmode=gcc3
+CXXFLAGS = -g -O2
+CYGPATH_W = echo
+DEFS = -DHAVE_CONFIG_H
+DEPDIR = .deps
+DSYMUTIL = 
+ECHO = echo
+ECHO_C = 
+ECHO_N = -n
+ECHO_T = 
+EGREP = /usr/bin/grep -E
+EXEEXT = 
+F77 = 
+FFLAGS = 
+GREP = /usr/bin/grep
+INSTALL = /usr/bin/install -c
+INSTALL_DATA = ${INSTALL} -m 644
+INSTALL_PROGRAM = ${INSTALL}
+INSTALL_SCRIPT = ${INSTALL}
+INSTALL_STRIP_PROGRAM = $(install_sh) -c -s
+LDFLAGS = 
+LIBOBJS = 
+LIBS = 
+LIBTOOL = $(SHELL) $(top_builddir)/libtool
+LN_S = ln -s
+LTLIBOBJS = 
+MAKEINFO = ${SHELL} /home/david/git/xrdp/missing --run makeinfo
+MKDIR_P = /bin/mkdir -p
+NMEDIT = 
+OBJEXT = o
+PACKAGE = xrdp
+PACKAGE_BUGREPORT = xrdp-devel@lists.sourceforge.net
+PACKAGE_NAME = xrdp
+PACKAGE_STRING = xrdp 0.5.0
+PACKAGE_TARNAME = xrdp
+PACKAGE_VERSION = 0.5.0
+PATH_SEPARATOR = :
+RANLIB = ranlib
+SED = /usr/bin/sed
+SET_MAKE = 
+SHELL = /bin/sh
+STRIP = strip
+VERSION = 0.5.0
+abs_builddir = /home/david/git/xrdp/xup
+abs_srcdir = /home/david/git/xrdp/xup
+abs_top_builddir = /home/david/git/xrdp
+abs_top_srcdir = /home/david/git/xrdp
+ac_ct_CC = gcc
+ac_ct_CXX = g++
+ac_ct_F77 = 
+am__include = include
+am__leading_dot = .
+am__quote = 
+am__tar = ${AMTAR} chof - "$$tardir"
+am__untar = ${AMTAR} xf -
+bindir = ${exec_prefix}/bin
+build = i686-suse-linux-gnu
+build_alias = 
+build_cpu = i686
+build_os = linux-gnu
+build_vendor = suse
+builddir = .
+datadir = ${datarootdir}
+datarootdir = ${prefix}/share
+docdir = ${datarootdir}/doc/${PACKAGE_TARNAME}
+dvidir = ${docdir}
+exec_prefix = ${prefix}
+host = i686-suse-linux-gnu
+host_alias = 
+host_cpu = i686
+host_os = linux-gnu
+host_vendor = suse
+htmldir = ${docdir}
+includedir = ${prefix}/include
+infodir = ${datarootdir}/info
+install_sh = $(SHELL) /home/david/git/xrdp/install-sh
+libdir = ${exec_prefix}/lib/xrdp/
+libexecdir = ${exec_prefix}/libexec
+localedir = ${datarootdir}/locale
+localstatedir = ${prefix}/var
+mandir = ${datarootdir}/man
+mkdir_p = /bin/mkdir -p
+oldincludedir = /usr/include
+pdfdir = ${docdir}
+prefix = /usr
+program_transform_name = s,x,x,
+psdir = ${docdir}
+sbindir = ${exec_prefix}/sbin
+sharedstatedir = ${prefix}/com
+srcdir = .
+sysconfdir = ${prefix}/etc
+target_alias = 
+top_builddir = ..
+top_srcdir = ..
+INCLUDES = \
+  -I$(top_srcdir)/common
+
+lib_LTLIBRARIES = \
+  libxup.la
+
+libxup_la_SOURCES = xup.c
+libxup_la_LIBADD = \
+  $(top_srcdir)/common/libcommon.la
+
+all: all-am
+
+.SUFFIXES:
+.SUFFIXES: .c .lo .o .obj
+$(srcdir)/Makefile.in:  $(srcdir)/Makefile.am  $(am__configure_deps)
+	@for dep in $?; do \
+	  case '$(am__configure_deps)' in \
+	    *$$dep*) \
+	      cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh \
+		&& exit 0; \
+	      exit 1;; \
+	  esac; \
+	done; \
+	echo ' cd $(top_srcdir) && $(AUTOMAKE) --foreign  xup/Makefile'; \
+	cd $(top_srcdir) && \
+	  $(AUTOMAKE) --foreign  xup/Makefile
+.PRECIOUS: Makefile
+Makefile: $(srcdir)/Makefile.in $(top_builddir)/config.status
+	@case '$?' in \
+	  *config.status*) \
+	    cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh;; \
+	  *) \
+	    echo ' cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe)'; \
+	    cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe);; \
+	esac;
+
+$(top_builddir)/config.status: $(top_srcdir)/configure $(CONFIG_STATUS_DEPENDENCIES)
+	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
+
+$(top_srcdir)/configure:  $(am__configure_deps)
+	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
+$(ACLOCAL_M4):  $(am__aclocal_m4_deps)
+	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
+install-libLTLIBRARIES: $(lib_LTLIBRARIES)
+	@$(NORMAL_INSTALL)
+	test -z "$(libdir)" || $(MKDIR_P) "$(DESTDIR)$(libdir)"
+	@list='$(lib_LTLIBRARIES)'; for p in $$list; do \
+	  if test -f $$p; then \
+	    f=$(am__strip_dir) \
+	    echo " $(LIBTOOL) $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=install $(libLTLIBRARIES_INSTALL) $(INSTALL_STRIP_FLAG) '$$p' '$(DESTDIR)$(libdir)/$$f'"; \
+	    $(LIBTOOL) $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=install $(libLTLIBRARIES_INSTALL) $(INSTALL_STRIP_FLAG) "$$p" "$(DESTDIR)$(libdir)/$$f"; \
+	  else :; fi; \
+	done
+
+uninstall-libLTLIBRARIES:
+	@$(NORMAL_UNINSTALL)
+	@list='$(lib_LTLIBRARIES)'; for p in $$list; do \
+	  p=$(am__strip_dir) \
+	  echo " $(LIBTOOL) $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=uninstall rm -f '$(DESTDIR)$(libdir)/$$p'"; \
+	  $(LIBTOOL) $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=uninstall rm -f "$(DESTDIR)$(libdir)/$$p"; \
+	done
+
+clean-libLTLIBRARIES:
+	-test -z "$(lib_LTLIBRARIES)" || rm -f $(lib_LTLIBRARIES)
+	@list='$(lib_LTLIBRARIES)'; for p in $$list; do \
+	  dir="`echo $$p | sed -e 's|/[^/]*$$||'`"; \
+	  test "$$dir" != "$$p" || dir=.; \
+	  echo "rm -f \"$${dir}/so_locations\""; \
+	  rm -f "$${dir}/so_locations"; \
+	done
+libxup.la: $(libxup_la_OBJECTS) $(libxup_la_DEPENDENCIES) 
+	$(LINK) -rpath $(libdir) $(libxup_la_OBJECTS) $(libxup_la_LIBADD) $(LIBS)
+
+mostlyclean-compile:
+	-rm -f *.$(OBJEXT)
+
+distclean-compile:
+	-rm -f *.tab.c
+
+include ./$(DEPDIR)/xup.Plo
+
+.c.o:
+	$(COMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ $<
+	mv -f $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Po
+#	source='$<' object='$@' libtool=no \
+#	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) \
+#	$(COMPILE) -c $<
+
+.c.obj:
+	$(COMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ `$(CYGPATH_W) '$<'`
+	mv -f $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Po
+#	source='$<' object='$@' libtool=no \
+#	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) \
+#	$(COMPILE) -c `$(CYGPATH_W) '$<'`
+
+.c.lo:
+	$(LTCOMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ $<
+	mv -f $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Plo
+#	source='$<' object='$@' libtool=yes \
+#	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) \
+#	$(LTCOMPILE) -c -o $@ $<
+
+mostlyclean-libtool:
+	-rm -f *.lo
+
+clean-libtool:
+	-rm -rf .libs _libs
+
+ID: $(HEADERS) $(SOURCES) $(LISP) $(TAGS_FILES)
+	list='$(SOURCES) $(HEADERS) $(LISP) $(TAGS_FILES)'; \
+	unique=`for i in $$list; do \
+	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
+	  done | \
+	  $(AWK) '{ files[$$0] = 1; nonemtpy = 1; } \
+	      END { if (nonempty) { for (i in files) print i; }; }'`; \
+	mkid -fID $$unique
+tags: TAGS
+
+TAGS:  $(HEADERS) $(SOURCES)  $(TAGS_DEPENDENCIES) \
+		$(TAGS_FILES) $(LISP)
+	tags=; \
+	here=`pwd`; \
+	list='$(SOURCES) $(HEADERS)  $(LISP) $(TAGS_FILES)'; \
+	unique=`for i in $$list; do \
+	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
+	  done | \
+	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
+	      END { if (nonempty) { for (i in files) print i; }; }'`; \
+	if test -z "$(ETAGS_ARGS)$$tags$$unique"; then :; else \
+	  test -n "$$unique" || unique=$$empty_fix; \
+	  $(ETAGS) $(ETAGSFLAGS) $(AM_ETAGSFLAGS) $(ETAGS_ARGS) \
+	    $$tags $$unique; \
+	fi
+ctags: CTAGS
+CTAGS:  $(HEADERS) $(SOURCES)  $(TAGS_DEPENDENCIES) \
+		$(TAGS_FILES) $(LISP)
+	tags=; \
+	list='$(SOURCES) $(HEADERS)  $(LISP) $(TAGS_FILES)'; \
+	unique=`for i in $$list; do \
+	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
+	  done | \
+	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
+	      END { if (nonempty) { for (i in files) print i; }; }'`; \
+	test -z "$(CTAGS_ARGS)$$tags$$unique" \
+	  || $(CTAGS) $(CTAGSFLAGS) $(AM_CTAGSFLAGS) $(CTAGS_ARGS) \
+	     $$tags $$unique
+
+GTAGS:
+	here=`$(am__cd) $(top_builddir) && pwd` \
+	  && cd $(top_srcdir) \
+	  && gtags -i $(GTAGS_ARGS) $$here
+
+distclean-tags:
+	-rm -f TAGS ID GTAGS GRTAGS GSYMS GPATH tags
+
+distdir: $(DISTFILES)
+	@srcdirstrip=`echo "$(srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
+	topsrcdirstrip=`echo "$(top_srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
+	list='$(DISTFILES)'; \
+	  dist_files=`for file in $$list; do echo $$file; done | \
+	  sed -e "s|^$$srcdirstrip/||;t" \
+	      -e "s|^$$topsrcdirstrip/|$(top_builddir)/|;t"`; \
+	case $$dist_files in \
+	  */*) $(MKDIR_P) `echo "$$dist_files" | \
+			   sed '/\//!d;s|^|$(distdir)/|;s,/[^/]*$$,,' | \
+			   sort -u` ;; \
+	esac; \
+	for file in $$dist_files; do \
+	  if test -f $$file || test -d $$file; then d=.; else d=$(srcdir); fi; \
+	  if test -d $$d/$$file; then \
+	    dir=`echo "/$$file" | sed -e 's,/[^/]*$$,,'`; \
+	    if test -d $(srcdir)/$$file && test $$d != $(srcdir); then \
+	      cp -pR $(srcdir)/$$file $(distdir)$$dir || exit 1; \
+	    fi; \
+	    cp -pR $$d/$$file $(distdir)$$dir || exit 1; \
+	  else \
+	    test -f $(distdir)/$$file \
+	    || cp -p $$d/$$file $(distdir)/$$file \
+	    || exit 1; \
+	  fi; \
+	done
+check-am: all-am
+check: check-am
+all-am: Makefile $(LTLIBRARIES)
+installdirs:
+	for dir in "$(DESTDIR)$(libdir)"; do \
+	  test -z "$$dir" || $(MKDIR_P) "$$dir"; \
+	done
+install: install-am
+install-exec: install-exec-am
+install-data: install-data-am
+uninstall: uninstall-am
+
+install-am: all-am
+	@$(MAKE) $(AM_MAKEFLAGS) install-exec-am install-data-am
+
+installcheck: installcheck-am
+install-strip:
+	$(MAKE) $(AM_MAKEFLAGS) INSTALL_PROGRAM="$(INSTALL_STRIP_PROGRAM)" \
+	  install_sh_PROGRAM="$(INSTALL_STRIP_PROGRAM)" INSTALL_STRIP_FLAG=-s \
+	  `test -z '$(STRIP)' || \
+	    echo "INSTALL_PROGRAM_ENV=STRIPPROG='$(STRIP)'"` install
+mostlyclean-generic:
+
+clean-generic:
+
+distclean-generic:
+	-test -z "$(CONFIG_CLEAN_FILES)" || rm -f $(CONFIG_CLEAN_FILES)
+
+maintainer-clean-generic:
+	@echo "This command is intended for maintainers to use"
+	@echo "it deletes files that may require special tools to rebuild."
+clean: clean-am
+
+clean-am: clean-generic clean-libLTLIBRARIES clean-libtool \
+	mostlyclean-am
+
+distclean: distclean-am
+	-rm -rf ./$(DEPDIR)
+	-rm -f Makefile
+distclean-am: clean-am distclean-compile distclean-generic \
+	distclean-tags
+
+dvi: dvi-am
+
+dvi-am:
+
+html: html-am
+
+info: info-am
+
+info-am:
+
+install-data-am:
+
+install-dvi: install-dvi-am
+
+install-exec-am: install-libLTLIBRARIES
+
+install-html: install-html-am
+
+install-info: install-info-am
+
+install-man:
+
+install-pdf: install-pdf-am
+
+install-ps: install-ps-am
+
+installcheck-am:
+
+maintainer-clean: maintainer-clean-am
+	-rm -rf ./$(DEPDIR)
+	-rm -f Makefile
+maintainer-clean-am: distclean-am maintainer-clean-generic
+
+mostlyclean: mostlyclean-am
+
+mostlyclean-am: mostlyclean-compile mostlyclean-generic \
+	mostlyclean-libtool
+
+pdf: pdf-am
+
+pdf-am:
 
-all: xup
+ps: ps-am
 
-xup: $(XUPOBJ)
-	$(CC) $(LDFLAGS) -o libxup.so $(XUPOBJ) $(LIBS)
+ps-am:
 
-clean:
-	rm -f $(XUPOBJ) libxup.so
+uninstall-am: uninstall-libLTLIBRARIES
 
-os_calls.o: ../common/os_calls.c
-	$(CC) $(C_OS_FLAGS) ../common/os_calls.c
+.MAKE: install-am install-strip
 
-install:
-	install libxup.so $(DESTDIR)/libxup.so
+.PHONY: CTAGS GTAGS all all-am check check-am clean clean-generic \
+	clean-libLTLIBRARIES clean-libtool ctags distclean \
+	distclean-compile distclean-generic distclean-libtool \
+	distclean-tags distdir dvi dvi-am html html-am info info-am \
+	install install-am install-data install-data-am install-dvi \
+	install-dvi-am install-exec install-exec-am install-html \
+	install-html-am install-info install-info-am \
+	install-libLTLIBRARIES install-man install-pdf install-pdf-am \
+	install-ps install-ps-am install-strip installcheck \
+	installcheck-am installdirs maintainer-clean \
+	maintainer-clean-generic mostlyclean mostlyclean-compile \
+	mostlyclean-generic mostlyclean-libtool pdf pdf-am ps ps-am \
+	tags uninstall uninstall-am uninstall-libLTLIBRARIES
 
-installdeb:
-	install libxup.so $(DESTDIRDEB)/usr/lib/xrdp/libxup.so
+# Tell versions [3.59,3.63) of GNU make to not export all variables.
+# Otherwise a system limit (for SysV at least) may be exceeded.
+.NOEXPORT:
diff --git a/xup/Makefile.am b/xup/Makefile.am
new file mode 100644
index 0000000..2552b7d
--- /dev/null
+++ b/xup/Makefile.am
@@ -0,0 +1,10 @@
+INCLUDES = \
+  -I$(top_srcdir)/common
+
+lib_LTLIBRARIES = \
+  libxup.la
+
+libxup_la_SOURCES = xup.c
+
+libxup_la_LIBADD = \
+  $(top_srcdir)/common/libcommon.la
diff --git a/xup/Makefile.osx b/xup/Makefile.osx
new file mode 100644
index 0000000..9f0f4f7
--- /dev/null
+++ b/xup/Makefile.osx
@@ -0,0 +1,35 @@
+# libxup makefile
+
+XUPOBJ = os_calls.o xup.o
+
+DESTDIR = /usr/local/xrdp
+CFGDIR = /etc/xrdp
+PIDDIR = /var/run
+MANDIR = /usr/local/man
+DOCDIR = /usr/doc/xrdp
+
+DEFINES =
+
+LIBXUP = libxup.dylib
+
+CFLAGS = -Wall -O2 -I../common -fPIC $(DEFINES)
+#CFLAGS += -DXRDP_DEBUG
+C_OS_FLAGS = $(CFLAGS) -c
+LDFLAGS = -dynamiclib -Wl,-flat_namespace -Wl,-undefined -Wl,suppress
+LIBS = -ldl
+CC = gcc
+
+all: $(LIBXUP)
+
+$(LIBXUP): $(XUPOBJ)
+	$(CC) $(LDFLAGS) -o $(LIBXUP) $(XUPOBJ) $(LIBS)
+
+clean:
+	rm -f $(XUPOBJ) $(LIBXUP)
+
+os_calls.o: ../common/os_calls.c
+	$(CC) $(C_OS_FLAGS) ../common/os_calls.c
+
+install:
+	install $(LIBXUP) $(DESTDIR)/$(LIBXUP)
+
diff --git a/xup/xup.c b/xup/xup.c
index 6f77879..1ffd950 100644
--- a/xup/xup.c
+++ b/xup/xup.c
@@ -14,7 +14,7 @@
    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
 
    xrdp: A Remote Desktop Protocol server.
-   Copyright (C) Jay Sorg 2005-2006
+   Copyright (C) Jay Sorg 2005-2008
 
    libxup main file
 
@@ -156,6 +156,7 @@ lib_mod_connect(struct mod* mod)
   make_stream(s);
   g_sprintf(con_port, "%s", mod->port);
   mod->sck = g_tcp_socket();
+  mod->sck_obj = g_create_wait_obj_from_socket(mod->sck, 0);
   mod->sck_closed = 0;
   error = g_tcp_connect(mod->sck, mod->ip, con_port);
   if (error == 0)
@@ -178,7 +179,7 @@ lib_mod_connect(struct mod* mod)
     out_uint32_le(s, 0);
     out_uint32_le(s, 0);
     s_mark_end(s);
-    len = s->end - s->data;
+    len = (int)(s->end - s->data);
     s_pop_layer(s, iso_hdr);
     out_uint32_le(s, len);
     lib_send(mod, s->data, len);
@@ -197,8 +198,8 @@ lib_mod_connect(struct mod* mod)
 /******************************************************************************/
 /* return error */
 int DEFAULT_CC
-lib_mod_event(struct mod* mod, int msg, long param1, long param2,
-              long param3, long param4)
+lib_mod_event(struct mod* mod, int msg, tbus param1, tbus param2,
+              tbus param3, tbus param4)
 {
   struct stream* s;
   int len;
@@ -215,7 +216,7 @@ lib_mod_event(struct mod* mod, int msg, long param1, long param2,
   out_uint32_le(s, param3);
   out_uint32_le(s, param4);
   s_mark_end(s);
-  len = s->end - s->data;
+  len = (int)(s->end - s->data);
   s_pop_layer(s, iso_hdr);
   out_uint32_le(s, len);
   rv = lib_send(mod, s->data, len);
@@ -399,6 +400,47 @@ lib_mod_set_param(struct mod* mod, char* name, char* value)
 }
 
 /******************************************************************************/
+/* return error */
+int DEFAULT_CC
+lib_mod_get_wait_objs(struct mod* mod, tbus* read_objs, int* rcount,
+                      tbus* write_objs, int* wcount, int* timeout)
+{
+  int i;
+
+  i = *rcount;
+  if (mod != 0)
+  {
+    if (mod->sck_obj != 0)
+    {
+      read_objs[i++] = mod->sck_obj;
+    }
+  }
+  *rcount = i;
+  return 0;
+}
+
+/******************************************************************************/
+/* return error */
+int DEFAULT_CC
+lib_mod_check_wait_objs(struct mod* mod)
+{
+  int rv;
+
+  rv = 0;
+  if (mod != 0)
+  {
+    if (mod->sck_obj != 0)
+    {
+      if (g_is_wait_obj_set(mod->sck_obj))
+      {
+        rv = lib_mod_signal(mod);
+      }
+    }
+  }
+  return rv;
+}
+
+/******************************************************************************/
 struct mod* EXPORT_CC
 mod_init(void)
 {
@@ -406,13 +448,15 @@ mod_init(void)
 
   mod = (struct mod*)g_malloc(sizeof(struct mod), 1);
   mod->size = sizeof(struct mod);
-  mod->handle = (long)mod;
+  mod->handle = (tbus)mod;
   mod->mod_connect = lib_mod_connect;
   mod->mod_start = lib_mod_start;
   mod->mod_event = lib_mod_event;
   mod->mod_signal = lib_mod_signal;
   mod->mod_end = lib_mod_end;
   mod->mod_set_param = lib_mod_set_param;
+  mod->mod_get_wait_objs = lib_mod_get_wait_objs;
+  mod->mod_check_wait_objs = lib_mod_check_wait_objs;
   return mod;
 }
 
@@ -424,6 +468,7 @@ mod_exit(struct mod* mod)
   {
     return 0;
   }
+  g_delete_wait_obj_from_socket(mod->sck_obj);
   g_tcp_close(mod->sck);
   g_free(mod);
   return 0;
diff --git a/xup/xup.h b/xup/xup.h
index 18792f2..6e90e45 100644
--- a/xup/xup.h
+++ b/xup/xup.h
@@ -14,7 +14,7 @@
    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
 
    xrdp: A Remote Desktop Protocol server.
-   Copyright (C) Jay Sorg 2005-2006
+   Copyright (C) Jay Sorg 2005-2008
 
    libxup main header file
 
@@ -33,12 +33,16 @@ struct mod
   /* client functions */
   int (*mod_start)(struct mod* v, int w, int h, int bpp);
   int (*mod_connect)(struct mod* v);
-  int (*mod_event)(struct mod* v, int msg, long param1, long param2,
-                   long param3, long param4);
+  int (*mod_event)(struct mod* v, int msg, tbus param1, tbus param2,
+                   tbus param3, tbus param4);
   int (*mod_signal)(struct mod* v);
   int (*mod_end)(struct mod* v);
   int (*mod_set_param)(struct mod* v, char* name, char* value);
-  long mod_dumby[100 - 6]; /* align, 100 minus the number of mod
+  int (*mod_session_change)(struct mod* v, int, int);
+  int (*mod_get_wait_objs)(struct mod* v, tbus* read_objs, int* rcount,
+                           tbus* write_objs, int* wcount, int* timeout);
+  int (*mod_check_wait_objs)(struct mod* v);
+  tbus mod_dumby[100 - 9]; /* align, 100 minus the number of mod
                               functions above */
   /* server functions */
   int (*server_begin_update)(struct mod* v);
@@ -79,12 +83,12 @@ struct mod
   int (*server_get_channel_id)(struct mod* v, char* name);
   int (*server_send_to_channel)(struct mod* v, int channel_id,
                                 char* data, int data_len);
-  long server_dumby[100 - 24]; /* align, 100 minus the number of server
+  tbus server_dumby[100 - 24]; /* align, 100 minus the number of server
                                   functions above */
   /* common */
-  long handle; /* pointer to self as long */
-  long wm;
-  long painter;
+  tbus handle; /* pointer to self as long */
+  tbus wm;
+  tbus painter;
   int sck;
   /* mod data */
   int width;
@@ -95,4 +99,5 @@ struct mod
   char password[256];
   char ip[256];
   char port[256];
+  tbus sck_obj;
 };
